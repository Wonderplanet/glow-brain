# BOXガシャ テーブル関係図

## 全体像

```
┌─────────────────────────────────────────────────────────────────┐
│                        MstEvent（イベント）                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ id: event_100kano_202602                                 │   │
│  │ 期間: 2026-02-01 〜 2026-02-28                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │ mst_event_id で紐づく
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                   MstBoxGacha（BOXガシャ設定）                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ id: box_gacha_100kano_001                                │   │
│  │ コスト: item_event_coin_100kano を 150個                │   │
│  │ ループ: Last（最後の箱を繰り返す）                       │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │ mst_box_gacha_id で紐づく
                         ↓
         ┌───────────────┴───────────────┐
         │                               │
┌────────┴──────────┐         ┌──────────┴─────────┐
│  MstBoxGachaGroup │         │  MstBoxGachaGroup  │  ...（BOX3、無限BOXも同様）
│      (BOX1)       │         │      (BOX2)        │
│  ┌──────────────┐ │         │  ┌───────────────┐ │
│  │ box_level: 1 │ │         │  │ box_level: 2  │ │
│  └──────────────┘ │         │  └───────────────┘ │
└───────┬───────────┘         └──────────┬─────────┘
        │                                │
        │ mst_box_gacha_group_id         │ mst_box_gacha_group_id
        │ で紐づく                       │ で紐づく
        ↓                                ↓
┌───────────────────────┐       ┌───────────────────────┐
│  MstBoxGachaPrize     │       │  MstBoxGachaPrize     │
│  （BOX1の中身）       │       │  （BOX2の中身）       │
│  ┌─────────────────┐  │       │  ┌─────────────────┐  │
│  │【目玉】キャラA  │  │       │  │【目玉】キャラB  │  │
│  │ stock: 1個      │  │       │  │ stock: 1個      │  │
│  ├─────────────────┤  │       │  ├─────────────────┤  │
│  │ 強化石          │  │       │  │ レア強化石      │  │
│  │ stock: 30個     │  │       │  │ stock: 40個     │  │
│  ├─────────────────┤  │       │  ├─────────────────┤  │
│  │ コイン          │  │       │  │ コイン          │  │
│  │ stock: 20個     │  │       │  │ stock: 30個     │  │
│  ├─────────────────┤  │       │  ├─────────────────┤  │
│  │ その他          │  │       │  │ その他          │  │
│  │ stock: 49個     │  │       │  │ stock: 29個     │  │
│  └─────────────────┘  │       │  └─────────────────┘  │
│  合計: 100個          │       │  合計: 100個          │
└───────────────────────┘       └───────────────────────┘
```

---

## データの流れ（プレイヤー視点）

```
1. プレイヤーがイベントクエストをクリア
   ↓
2. イベント通貨（100カノコイン）を獲得
   ↓
3. BOXガシャ画面を開く
   ↓
   ┌─────────────────────────────────────┐
   │ 現在の箱: BOX1                       │
   │ 残り: 100個                          │
   │ コスト: 100カノコイン 150個で1回   │
   │                                     │
   │ 【目玉】                            │
   │ ★★★ キャラA （残り1個）           │
   │                                     │
   │ 【その他】                          │
   │ 強化石 （残り30個）                │
   │ コイン1000枚 （残り20個）          │
   │ 育成本 （残り49個）                │
   └─────────────────────────────────────┘
   ↓
4. 「1回引く」または「10回引く」を選択
   ↓
5. 抽選実行（BOX1の残りアイテムからランダムに取得）
   ↓
   ┌─────────────────────────────────────┐
   │ 【結果】                            │
   │ ✓ 強化石 10個                       │
   └─────────────────────────────────────┘
   ↓
   BOX1の残りが更新される
   ┌─────────────────────────────────────┐
   │ 現在の箱: BOX1                       │
   │ 残り: 99個                           │
   │                                     │
   │ 【目玉】                            │
   │ ★★★ キャラA （残り1個）           │
   │                                     │
   │ 【その他】                          │
   │ 強化石 （残り29個）← 引いたので減った│
   │ コイン1000枚 （残り20個）          │
   │ 育成本 （残り49個）                │
   └─────────────────────────────────────┘
   ↓
6. 目玉を引くまで or 箱が空になるまで繰り返す
   ↓
7. 箱をリセットしてBOX2へ進む
```

---

## テーブル間のデータ参照の流れ

### パターン1: BOXガシャを引くとき

```
1. クライアントからのリクエスト
   「box_gacha_100kano_001 を 1回引く」
   ↓
2. MstBoxGachaを取得
   「このBOXガシャのコストは item_event_coin_100kano が 150個」
   ↓
3. プレイヤーのアイテム所持数をチェック
   「100カノコインを150個以上持っているか？」
   ↓
4. プレイヤーの現在のBOX番号を取得（UsrBoxGacha）
   「現在 box_level = 1（BOX1）を引いている」
   ↓
5. MstBoxGachaGroupを取得
   「box_level = 1 のグループIDは box_gacha_group_100kano_lv1」
   ↓
6. MstBoxGachaPrizeを取得
   「box_gacha_group_100kano_lv1 に含まれる景品一覧」
   ↓
7. プレイヤーの残りアイテムを取得（UsrBoxGachaStock）
   「BOX1の残りアイテム: キャラA 1個、強化石 29個、コイン 20個、育成本 49個」
   ↓
8. ランダム抽選
   「残りアイテムの中からランダムに1個選ぶ → コイン1000枚」
   ↓
9. アイテムを配布 & 残りアイテムから削除
   「プレイヤーにコイン1000枚を付与」
   「BOX1の残りコインを20個→19個に減らす」
   ↓
10. レスポンス
   「獲得アイテム: コイン1000枚、BOX1残り: 98個」
```

### パターン2: BOXをリセットするとき

```
1. クライアントからのリクエスト
   「box_gacha_100kano_001 をリセット」
   ↓
2. プレイヤーの現在のBOX番号を取得（UsrBoxGacha）
   「現在 box_level = 1（BOX1）」
   ↓
3. 次のBOX番号を計算
   「box_level = 1 → 次は box_level = 2（BOX2）」
   ↓
4. MstBoxGachaGroupを取得
   「box_level = 2 のグループIDは box_gacha_group_100kano_lv2」
   ↓
5. MstBoxGachaPrizeを取得
   「box_gacha_group_100kano_lv2 に含まれる景品一覧」
   ↓
6. プレイヤーの残りアイテムを初期化（UsrBoxGachaStock）
   「BOX2の中身をマスタからコピーして、残りアイテムとして設定」
   ↓
7. プレイヤーのBOX番号を更新（UsrBoxGacha）
   「box_level = 2 に更新」
   ↓
8. レスポンス
   「BOX2に進みました。残り: 100個」
```

---

## マスタデータとユーザーデータの関係

```
【マスタデータ（変更されない）】
┌────────────────────────┐
│ MstBoxGacha            │ ← BOXガシャのルール
├────────────────────────┤
│ MstBoxGachaGroup       │ ← 箱の段階定義
├────────────────────────┤
│ MstBoxGachaPrize       │ ← 箱の初期状態（中身）
└────────────────────────┘
         ↓ コピー
【ユーザーデータ（プレイごとに変化）】
┌────────────────────────┐
│ UsrBoxGacha            │ ← プレイヤーの進捗（現在のBOX番号、引いた回数等）
├────────────────────────┤
│ UsrBoxGachaStock       │ ← プレイヤーのBOX残りアイテム（引くたびに減る）
└────────────────────────┘
```

**ポイント:**
- マスタデータは「設計図」
- ユーザーデータは「プレイヤーごとの状態」
- BOX初回アクセス時、マスタの中身をコピーしてユーザーデータを作成
- プレイヤーがガシャを引くたびに、ユーザーデータの残りアイテムが減る

---

## 具体例: プレイヤーAさんの状態

### マスタデータ（全プレイヤー共通）
```
MstBoxGachaPrize（BOX1の初期状態）
┌──────────────────────────────────────┐
│ キャラA:  1個                        │
│ 強化石:  30個                        │
│ コイン:  20個                        │
│ 育成本:  49個                        │
│ ────────────────────────────────     │
│ 合計:   100個                        │
└──────────────────────────────────────┘
```

### プレイヤーAさんのデータ（Aさん専用）
```
UsrBoxGacha（Aさんの進捗）
┌──────────────────────────────────────┐
│ 現在のBOX: BOX1（box_level = 1）    │
│ 累計引き回数: 25回                  │
└──────────────────────────────────────┘

UsrBoxGachaStock（AさんのBOX1残りアイテム）
┌──────────────────────────────────────┐
│ キャラA:  1個 ← まだ引いてない     │
│ 強化石:  18個 ← 12個引いた（30→18）│
│ コイン:  13個 ← 7個引いた（20→13） │
│ 育成本:  43個 ← 6個引いた（49→43） │
│ ────────────────────────────────     │
│ 合計:   75個 ← 25個引いた（100→75）│
└──────────────────────────────────────┘
```

**Aさんの体験:**
- 25回引いて、まだキャラA（目玉）が出ていない
- 残り75個なので、「あと75回引けば必ずキャラAが手に入る」と分かる
- これが「天井の可視化」の仕組み

---

## ループタイプ別の動作

### loop_type = "Last"（最も一般的）

```
BOX1（100個）→ 引き切る or リセット
  ↓
BOX2（100個）→ 引き切る or リセット
  ↓
BOX3（100個）→ 引き切る or リセット
  ↓
無限BOX（100個）→ 引き切る or リセット
  ↓                      ↑
  └──────────────────────┘
     何度でもリセットして繰り返し
```

### loop_type = "All"（特殊ケース）

```
BOX1（100個）→ 引き切る or リセット
  ↓
BOX2（100個）→ 引き切る or リセット
  ↓
BOX3（100個）→ 引き切る or リセット
  ↓
無限BOX（100個）→ 引き切る or リセット
  ↓                      ↑
  └──────BOX1に戻る───────┘
     BOX1〜無限BOXを何周もループ
```

### loop_type = "First"（ほぼ使わない）

```
BOX1（100個）→ 引き切る or リセット
  ↓
BOX2（100個）→ 引き切る or リセット
  ↓
BOX3（100個）→ 引き切る or リセット
  ↓
BOX1（100個）→ 引き切る or リセット
  ↓                      ↑
  └──────────────────────┘
     BOX1だけを繰り返し
```

---

## まとめ

BOXガシャは以下の階層構造で管理されます：

```
イベント（MstEvent）
  └─ BOXガシャ全体（MstBoxGacha）
      ├─ BOX1（MstBoxGachaGroup）
      │   ├─ 景品1（MstBoxGachaPrize）
      │   ├─ 景品2（MstBoxGachaPrize）
      │   └─ ...（合計100個）
      ├─ BOX2（MstBoxGachaGroup）
      │   └─ 景品... （合計100個）
      ├─ BOX3（MstBoxGachaGroup）
      │   └─ 景品... （合計100個）
      └─ 無限BOX（MstBoxGachaGroup）
          └─ 景品... （合計100個）
```

各テーブルの役割：
- **MstBoxGacha**: ルールブック（コスト、ループ設定）
- **MstBoxGachaGroup**: 箱の段階表（BOX1、BOX2、BOX3、無限BOX）
- **MstBoxGachaPrize**: 箱の中身リスト（何が何個入っているか）

このシンプルな3テーブル構造で、プレイヤーに「天井が見える安心感」を提供できます！
