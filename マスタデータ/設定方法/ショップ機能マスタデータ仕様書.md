# GLOWショップ機能マスタデータ仕様書

## 概要

GLOWプロジェクトにおけるショップ機能に必要なマスタデータテーブルの完全ドキュメント。
glow-server（Laravel/PHP）とglow-client（Unity/C#）の実装コードを調査し、必要なマスタテーブルを網羅的にまとめた。

**注意**: 交換所（Exchange）機能は別機能のため、本ドキュメントの対象外。

---

## 目次

1. [ショップ機能の全体構成](#ショップ機能の全体構成)
2. [課金ストア関連テーブル](#1-課金ストア関連テーブル)
3. [非課金ショップ関連テーブル](#2-非課金ショップ関連テーブル)
4. [ショップパス関連テーブル](#3-ショップパス関連テーブル)
5. [多言語対応テーブル](#4-多言語対応テーブル)
6. [テーブル間の関連図](#テーブル間の関連図)
7. [実装上の注意点](#実装上の注意点)

---

## ショップ機能の全体構成

GLOWのショップ機能は以下の3つの主要コンポーネントで構成される：

| コンポーネント | 説明 | 主要テーブル |
|------------|------|------------|
| **課金ストア** | AppStore/GooglePlayと連携した有償商品の販売 | mst_store_products, opr_products, mst_packs |
| **非課金ショップ** | ゲーム内通貨や広告視聴で購入可能なアイテム販売 | mst_shop_items |
| **ショップパス** | サブスクリプション型の有償パス（特典付き） | mst_shop_passes, mst_shop_pass_effects |

---

## 1. 課金ストア関連テーブル

### 1-1. mst_store_products（ストア商品マスタ）

**役割**: プラットフォーム（AppStore/GooglePlay）に登録している商品IDを管理
**重要**: 一度定義したら変更不可（リストア処理のため）

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| release_key | bigint | NO | リリースキー |
| product_id_ios | varchar(255) | NO | AppStoreのプロダクトID |
| product_id_android | varchar(255) | NO | GooglePlayのプロダクトID |
| price | int unsigned | NO | 価格（円） |

**CSVファイル**: `MstStoreProduct.csv`

**サンプルデータ**:
```csv
ENABLE,id,release_key,product_id_ios,product_id_android,price
e,1,1,BNEI0434_0001,com.bandainamcoent.jumble_0001,160
e,2,1,BNEI0434_0002,com.bandainamcoent.jumble_0002,320
```

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstStoreProduct.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstStoreProduct.php`
- glow-server: `app/Domain/Shop/Services/UsrStoreProductService.php:projects/glow-server/api/app/Domain/Shop/Services/UsrStoreProductService.php`
- glow-client: ストア購入処理で参照

---

### 1-2. opr_products（運営商品マスタ）

**役割**: 実際にユーザーに販売する商品を管理
**関連**: 1つの`mst_store_product`に対して複数の`opr_product`が存在可能

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| mst_store_product_id | varchar(255) | NO | mst_store_products.id |
| product_type | enum('diamond','pack','pass') | YES | 商品タイプ |
| purchasable_count | int unsigned | YES | 購入可能回数（NULL=無制限） |
| paid_amount | bigint | NO | 配布する有償一次通貨 |
| display_priority | int unsigned | NO | 表示優先度 |
| start_date | timestamp | NO | 販売開始日時 |
| end_date | timestamp | NO | 販売終了日時 |
| release_key | int | NO | リリースキー |

**CSVファイル**: `OprProduct.csv`

**サンプルデータ**:
```csv
ENABLE,id,mst_store_product_id,product_type,purchasable_count,paid_amount,display_priority,start_date,end_date,release_key
e,1,1,Diamond,__NULL__,999919919,1,"2025-05-20 09:00:00","2030-01-01 00:00:00",1
e,7,3,Pack,1,0,7,"2024-01-01 09:00:00","2030-01-01 00:00:00",1
```

**product_typeの種類**:
- `diamond`: ダイヤモンド商品（通貨のみの販売）
- `pack`: パック商品（複数アイテムのセット販売）
- `pass`: パス商品（サブスクリプション型）

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/OprProduct.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/OprProduct.php`
- glow-server: `app/Domain/Shop/UseCases/ShopPurchaseUseCase.php:projects/glow-server/api/app/Domain/Shop/UseCases/ShopPurchaseUseCase.php`

---

### 1-3. mst_packs（パックマスタ）

**役割**: ショップで販売されるパック商品の設定
**特徴**: 複数のアイテムを1つの商品としてまとめて販売

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| product_sub_id | varchar(255) | NO | opr_products.id |
| discount_rate | smallint unsigned | NO | 割引率（%） |
| pack_type | enum('Daily','Normal') | NO | パック販売タイプ |
| sale_condition | enum('StageClear','UserLevel') | YES | 販売開始条件 |
| sale_condition_value | varchar(255) | YES | 販売開始条件値 |
| sale_hours | smallint unsigned | YES | 条件達成からの販売時間 |
| tradable_count | int unsigned | YES | 交換可能個数 |
| cost_type | enum('Cash','Diamond','PaidDiamond','Ad','Free') | NO | 販売コスト種別 |
| cost_amount | int unsigned | NO | コスト量 |
| is_recommend | tinyint unsigned | NO | おすすめフラグ |
| is_first_time_free | tinyint | NO | 初回無料フラグ |
| is_display_expiration | tinyint unsigned | NO | 表示期限表示フラグ |
| asset_key | varchar(255) | NO | バナー画像パス |
| pack_decoration | enum('Gold') | YES | パックの装飾 |
| release_key | int | NO | リリースキー |

**CSVファイル**: `MstPack.csv`

**サンプルデータ**:
```csv
ENABLE,id,product_sub_id,discount_rate,is_first_time_free,sale_condition,sale_condition_value,sale_hours,is_display_expiration,pack_type,tradable_count,cost_type,cost_amount,is_recommend,asset_key,pack_decoration,release_key
e,a2_release_pack_1,7,20,0,__NULL__,0,,1,Normal,0,Cash,0,1,weekly,__NULL__,1
e,level_pack_1,10,20,0,UserLevel,5,,0,Normal,0,Cash,0,0,ip,__NULL__,1
```

**pack_typeの種類**:
- `Daily`: デイリーパック（毎日購入可能）
- `Normal`: 通常パック（期間限定または購入回数制限あり）

**sale_conditionの種類**:
- `StageClear`: ステージクリア条件
- `UserLevel`: ユーザーレベル条件

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstPack.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstPack.php`
- glow-server: `app/Domain/Shop/UseCases/ShopTradePackUseCase.php:projects/glow-server/api/app/Domain/Shop/UseCases/ShopTradePackUseCase.php`
- glow-server: `app/Domain/Shop/Repositories/UsrTradePackRepository.php:projects/glow-server/api/app/Domain/Shop/Repositories/UsrTradePackRepository.php`

---

### 1-4. mst_pack_contents（パック内容物マスタ）

**役割**: パックに含まれるアイテムの詳細を管理
**関連**: `mst_packs.id`に紐づく

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| mst_pack_id | varchar(255) | NO | mst_packs.id |
| resource_type | enum('FreeDiamond','Coin','Item','Unit') | NO | 内包物のタイプ |
| resource_id | varchar(255) | YES | 内包物のID（Itemの場合のみ） |
| resource_amount | bigint unsigned | NO | 内包物の数量 |
| is_bonus | tinyint unsigned | NO | おまけフラグ |
| display_order | int unsigned | NO | 表示順序 |
| release_key | int | NO | リリースキー |

**CSVファイル**: `MstPackContent.csv`

**resource_typeの種類**:
- `FreeDiamond`: 無償ダイヤモンド
- `Coin`: ゲーム内コイン
- `Item`: アイテム（resource_idで指定）
- `Unit`: キャラクター

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstPackContent.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstPackContent.php`
- glow-server: `app/Domain/Resource/Entities/Rewards/ShopPackContentReward.php:projects/glow-server/api/app/Domain/Resource/Entities/Rewards/ShopPackContentReward.php`

---

## 2. 非課金ショップ関連テーブル

### 2-1. mst_shop_items（ショップアイテムマスタ）

**役割**: ゲーム内通貨や広告視聴で購入できるアイテムを管理
**特徴**: 課金不要のショップアイテム（デイリー/ウィークリーショップ等）

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| shop_type | enum('Coin','Daily','Weekly') | YES | 商品タイプ |
| cost_type | enum('Coin','Diamond','PaidDiamond','Ad','Free') | YES | 消費するコストのタイプ |
| cost_amount | int unsigned | YES | 消費するコストの数量 |
| is_first_time_free | tinyint(1) | NO | 初回無料か |
| tradable_count | int unsigned | YES | 交換可能回数 |
| resource_type | enum('FreeDiamond','Coin','IdleCoin','Item') | YES | 獲得物のタイプ |
| resource_id | varchar(255) | YES | 獲得物のID |
| resource_amount | bigint unsigned | NO | 獲得物の数量 |
| start_date | timestamp | NO | 販売開始日時 |
| end_date | timestamp | NO | 販売終了日時 |
| release_key | int | NO | リリースキー |

**CSVファイル**: `MstShopItem.csv`

**サンプルデータ**:
```csv
ENABLE,id,shop_type,cost_type,cost_amount,is_first_time_free,tradable_count,resource_type,resource_id,resource_amount,start_date,end_date,release_key
e,Daily_1,Daily,Ad,,1,2,FreeDiamond,0,50,"2024-01-01 9:00:00","2035-01-01 9:00:00",1
e,Daily_2,Daily,Coin,500,0,1,Item,box_glo_00001,20,"2024-01-01 9:00:00","2035-01-01 9:00:00",1
e,Daily_3,Daily,Coin,10000,0,1,Item,box_glo_00002,10,"2024-01-01 9:00:00","2035-01-01 9:00:00",1
```

**shop_typeの種類**:
- `Coin`: コインショップ
- `Daily`: デイリーショップ（日次リセット）
- `Weekly`: ウィークリーショップ（週次リセット）

**cost_typeの種類**:
- `Coin`: ゲーム内コイン
- `Diamond`: ダイヤモンド（有償/無償どちらでも可）
- `PaidDiamond`: 有償ダイヤモンドのみ
- `Ad`: 広告視聴
- `Free`: 無料

**resource_typeの種類**:
- `FreeDiamond`: 無償ダイヤモンド
- `Coin`: ゲーム内コイン
- `IdleCoin`: 放置コイン
- `Item`: アイテム

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstShopItem.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstShopItem.php`
- glow-server: `app/Domain/Shop/UseCases/ShopTradeShopItemUseCase.php:projects/glow-server/api/app/Domain/Shop/UseCases/ShopTradeShopItemUseCase.php`
- glow-server: `app/Domain/Shop/Repositories/UsrShopItemRepository.php:projects/glow-server/api/app/Domain/Shop/Repositories/UsrShopItemRepository.php`

---

## 3. ショップパス関連テーブル

### 3-1. mst_shop_passes（ショップパスマスタ）

**役割**: サブスクリプション型パスの基本設定
**特徴**: 有償で購入し、期間中は特典を受けられる

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| opr_product_id | varchar(255) | NO | opr_products.id |
| is_display_expiration | tinyint unsigned | NO | 販売の有効期限を表示するか |
| pass_duration_days | int unsigned | NO | パスの有効日数 |
| asset_key | varchar(255) | NO | アセットキー |
| shop_pass_cell_color | varchar(255) | NO | パス表示バナーの背景色 |
| release_key | bigint | NO | リリースキー |

**CSVファイル**: `MstShopPass.csv`

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstShopPass.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstShopPass.php`
- glow-server: `app/Domain/Shop/Services/ShopPassEffectService.php:projects/glow-server/api/app/Domain/Shop/Services/ShopPassEffectService.php`
- glow-server: `app/Domain/Shop/Repositories/UsrShopPassRepository.php:projects/glow-server/api/app/Domain/Shop/Repositories/UsrShopPassRepository.php`

---

### 3-2. mst_shop_pass_effects（ショップパス効果マスタ）

**役割**: パス購入者が受けられる効果を管理
**関連**: `mst_shop_passes.id`に紐づく

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| mst_shop_pass_id | varchar(255) | NO | mst_shop_passes.id |
| effect_type | enum('IdleIncentiveAddReward','IdleIncentiveMaxQuickReceiveByDiamond','IdleIncentiveMaxQuickReceiveByAd','StaminaAddRecoveryLimit','AdSkip','ChangeBattleSpeed') | NO | ゲーム内パス効果 |
| effect_value | bigint unsigned | NO | ゲーム内パス効果設定値 |
| release_key | bigint | NO | リリースキー |

**CSVファイル**: `MstShopPassEffect.csv`

**effect_typeの種類**:

| 効果タイプ | 説明 |
|----------|------|
| IdleIncentiveAddReward | 放置報酬追加 |
| IdleIncentiveMaxQuickReceiveByDiamond | ダイヤモンドでの即時受け取り回数上限 |
| IdleIncentiveMaxQuickReceiveByAd | 広告視聴での即時受け取り回数上限 |
| StaminaAddRecoveryLimit | スタミナ回復上限追加 |
| AdSkip | 広告スキップ |
| ChangeBattleSpeed | バトル速度変更 |

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstShopPassEffect.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstShopPassEffect.php`
- glow-server: `app/Domain/Shop/Enums/PassEffectType.php:projects/glow-server/api/app/Domain/Shop/Enums/PassEffectType.php`
- glow-server: `app/Domain/Shop/Delegators/ShopPassEffectDelegator.php:projects/glow-server/api/app/Domain/Shop/Delegators/ShopPassEffectDelegator.php`

---

### 3-3. mst_shop_pass_rewards（ショップパス報酬マスタ）

**役割**: パス購入者が受け取れる報酬を管理
**関連**: `mst_shop_passes.id`に紐づく

**テーブル構造**:

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | varchar(255) | NO | UUID（主キー） |
| mst_shop_pass_id | varchar(255) | NO | mst_shop_passes.id |
| pass_reward_type | enum('Daily','Immediately') | NO | 報酬の受け取りタイミング |
| resource_type | enum('Coin','FreeDiamond','Item') | NO | 報酬タイプ |
| resource_id | varchar(255) | YES | 報酬リソースID |
| resource_amount | bigint unsigned | NO | 報酬の個数 |
| release_key | bigint | NO | リリースキー |

**CSVファイル**: `MstShopPassReward.csv`

**pass_reward_typeの種類**:
- `Daily`: 毎日受け取り可能
- `Immediately`: 購入時即座に受け取り

**resource_typeの種類**:
- `Coin`: ゲーム内コイン
- `FreeDiamond`: 無償ダイヤモンド
- `Item`: アイテム

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/MstShopPassReward.php:projects/glow-server/api/app/Domain/Resource/Mst/Models/MstShopPassReward.php`
- glow-server: `app/Domain/Shop/Enums/PassRewardType.php:projects/glow-server/api/app/Domain/Shop/Enums/PassRewardType.php`
- glow-server: `app/Domain/Resource/Entities/Rewards/ShopPassReward.php:projects/glow-server/api/app/Domain/Resource/Entities/Rewards/ShopPassReward.php`

---

## 4. 多言語対応テーブル

ショップ機能の各テーブルには、多言語対応のi18nテーブルが存在する。

### 4-1. 多言語対応テーブル一覧

| テーブル名 | 対応する親テーブル | CSVファイル |
|-----------|----------------|------------|
| mst_packs_i18n | mst_packs | MstPackI18n.csv |
| mst_shop_passes_i18n | mst_shop_passes | MstShopPassI18n.csv |
| mst_store_products_i18n | mst_store_products | MstStoreProductI18n.csv |
| opr_products_i18n | opr_products | OprProductI18n.csv |

### 4-2. i18nテーブルの共通構造

すべてのi18nテーブルは以下の共通構造を持つ：

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | varchar(255) | UUID（主キー） |
| {parent}_id | varchar(255) | 親テーブルのID |
| language | varchar(10) | 言語コード（ja, en等） |
| name | text | 多言語化された名称 |
| release_key | bigint | リリースキー |

**サンプルデータ（MstPackI18n.csv）**:
```csv
ENABLE,release_key,id,mst_pack_id,language,name
e,1,a2_release_pack_1_ja,a2_release_pack_1,ja,α2リリース記念パック1
e,1,level_pack_1_ja,level_pack_1,ja,リーダーLv5達成パック
```

**関連コード**:
- glow-server: `app/Domain/Resource/Mst/Models/*I18n.php`
- glow-server: `app/Http/Resources/Api/Masteri18ndata/*I18nResource.php`

---

## テーブル間の関連図

```
【課金ストア】
mst_store_products (ストア商品)
    │
    ├─ mst_store_products_i18n (多言語)
    │
    └─── opr_products (運営商品)
            │
            ├─ opr_products_i18n (多言語)
            │
            ├─── mst_packs (パック設定)
            │       │
            │       ├─ mst_packs_i18n (多言語)
            │       │
            │       └─── mst_pack_contents (パック内容物)
            │
            └─── mst_shop_passes (ショップパス)
                    │
                    ├─ mst_shop_passes_i18n (多言語)
                    │
                    ├─── mst_shop_pass_effects (パス効果)
                    │
                    └─── mst_shop_pass_rewards (パス報酬)

【非課金ショップ】
mst_shop_items (ショップアイテム)
```

---

## 実装上の注意点

### 1. CSVファイルの命名規則

- **DBテーブル**: snake_case + 複数形（例: `mst_shop_items`）
- **CSVファイル**: PascalCase + 単数形（例: `MstShopItem.csv`）

### 2. NULL値の表現

CSVファイルでは`__NULL__`という文字列でNULL値を表現する。

```csv
e,normal_exchange,__NULL__,NormalExchangeTrade,"2025-11-01 12:00:00",__NULL__,normal_lineup,0,1
```

### 3. ENABLEフラグ

すべてのCSVファイルの最初のカラムは`ENABLE`フラグ：
- `e`: 有効
- `d`: 無効（データ投入時に無視される）

### 4. release_key

すべてのテーブルに`release_key`が存在し、リリースバージョン管理に使用される。

### 5. 主要なenum値

#### cost_type（コスト種別）
- `Cash`: 現金（課金）
- `Diamond`: ダイヤモンド（有償/無償どちらでも可）
- `PaidDiamond`: 有償ダイヤモンドのみ
- `Coin`: ゲーム内コイン
- `Ad`: 広告視聴
- `Free`: 無料

#### resource_type（報酬タイプ）
- `FreeDiamond`: 無償ダイヤモンド
- `Coin`: ゲーム内コイン
- `IdleCoin`: 放置コイン
- `Item`: アイテム
- `Unit`: キャラクター

#### shop_type（ショップタイプ）
- `Coin`: コインショップ
- `Daily`: デイリーショップ
- `Weekly`: ウィークリーショップ

#### product_type（商品タイプ）
- `diamond`: ダイヤモンド商品
- `pack`: パック商品
- `pass`: パス商品

### 6. 関連ファイルパス

#### glow-server
```
projects/glow-server/api/
├── app/Domain/Shop/              # ショップ機能のドメイン層
│   ├── Models/                   # ユーザーデータモデル
│   ├── Services/                 # ビジネスロジック
│   ├── UseCases/                 # ユースケース
│   ├── Repositories/             # リポジトリ
│   └── Enums/                    # 列挙型定義
├── app/Domain/Resource/Mst/Models/  # マスタデータモデル
└── app/Http/Controllers/
    └── ShopController.php        # ショップコントローラー
```

#### glow-client
```
projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/
└── Home/Domain/Constants/
    └── ShopContentTypes.cs       # ショップコンテンツタイプ
```

#### glow-masterdata
```
projects/glow-masterdata/
├── MstShopItem.csv
├── MstPack.csv
├── MstPackContent.csv
├── MstPackI18n.csv
├── MstShopPass.csv
├── MstShopPassEffect.csv
├── MstShopPassReward.csv
├── MstShopPassI18n.csv
├── MstStoreProduct.csv
├── MstStoreProductI18n.csv
├── OprProduct.csv
└── OprProductI18n.csv
```

---

## まとめ

GLOWのショップ機能は**12のマスタデータテーブル**で構成される：

### 課金ストア（7テーブル）
1. mst_store_products
2. mst_store_products_i18n
3. opr_products
4. opr_products_i18n
5. mst_packs
6. mst_pack_contents
7. mst_packs_i18n

### 非課金ショップ（1テーブル）
8. mst_shop_items

### ショップパス（4テーブル）
9. mst_shop_passes
10. mst_shop_passes_i18n
11. mst_shop_pass_effects
12. mst_shop_pass_rewards

これらのテーブルは密接に関連しており、ショップ施策を作成する際は適切なテーブルを組み合わせてマスタデータを作成する必要がある。

---

**調査日**: 2025-12-27
**調査対象バージョン**: projects/glow-server, projects/glow-client, projects/glow-masterdata
**DBスキーマ参照**: `projects/glow-server/api/database/schema/exports/master_tables_schema.json`
