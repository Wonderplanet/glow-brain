# 降臨バトル マスタデータ設定方法

## 目次

1. [概要](#概要)
2. [降臨バトルで使用するテーブル](#降臨バトルで使用するテーブル)
3. [各テーブルの設定方法](#各テーブルの設定方法)
4. [設定例](#設定例)
5. [注意事項とチェックポイント](#注意事項とチェックポイント)

---

## 概要

降臨バトルは、期間限定の強敵バトルイベントです。プレイヤーはスコアを競い、ランキング報酬やハイスコア報酬を獲得します。

### 降臨バトルの2つのタイプ

| タイプ | 説明 | 報酬体系 |
|-------|------|---------|
| **ScoreChallenge（スコアチャレンジ）** | 個人スコアのみを競う | ハイスコア報酬、ランキング報酬、ランク報酬、ドロップ報酬 |
| **Raid（協力バトル）** | 個人スコア + 全プレイヤー合計スコアを競う | 上記 + 協力スコア報酬 |

### スコアとランクの仕組み

- **MaxScore（最高スコア）**: 1回のバトルで獲得した最高スコア
- **TotalScore（累積スコア）**: 全バトルの累積スコア
- **Rank（ランク）**: TotalScoreに応じて昇格する4段階のランク（Bronze → Silver → Gold → Master）
- **RankLevel（ランクレベル）**: 各ランク内での細分化されたレベル（Lv1, Lv2, Lv3...）

---

## 降臨バトルで使用するテーブル

降臨バトルの設定には以下の**5つのシート**を使用します。

| シート | 対応するDBテーブル | 用途 |
|-------|------------------|------|
| **MstAdventBattle** | `mst_advent_battles`<br>`mst_advent_battles_i18n` | 降臨バトルの基本設定 |
| **MstAdventBattleRank** | `mst_advent_battle_ranks` | スコアランク定義 |
| **MstAdventBattleRewardGroup** | `mst_advent_battle_reward_groups` | 報酬グループ定義 |
| **MstAdventBattleReward** | `mst_advent_battle_rewards` | 報酬内容詳細 |
| **MstAdventBattleClearReward** | `mst_advent_battle_clear_rewards` | バトルクリア時の報酬 |

---

## 各テーブルの設定方法

### 1. MstAdventBattle（降臨バトル基本設定）

降臨バトルの基本情報を定義するメインテーブルです。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | 降臨バトルID（一意キー） | `advent_battle_summer_2025` |
| **mst_event_id** | 文字列 |  | イベントID（外部参照） | `event_summer_2025` |
| **mst_in_game_id** | 文字列 |  | インゲームID（バトルステージ設定） | `advent_summer_stage` |
| **asset_key** | 文字列 |  | 背景アセットキー | `advent_summer_bg` |
| **advent_battle_type** | 列挙型 |  | バトルタイプ | `ScoreChallenge` または `Raid` |
| **time_limit_seconds** | 整数 |  | バトルの時間制限（秒） | `180` (3分) |
| **initial_battle_point** | 整数 |  | 初期バトルポイント | `3` |
| **score_addition_type** | 列挙型 |  | スコア加算タイプ | `AllEnemies` または `AllEnemiesAndOutPost` |
| **score_additional_coef** | 少数 |  | スコア加算係数 | `1.0` |
| **event_bonus_group_id** | 文字列 | ○ | イベントボーナスグループID | `advent_summer_bonus` |
| **challengeable_count** | 整数 |  | 1日の通常挑戦可能回数 | `5` |
| **ad_challengeable_count** | 整数 |  | 1日の広告挑戦可能回数 | `3` |
| **display_mst_unit_id1** | 文字列 |  | トップ画面に表示する敵キャラID（1体目） | `enemy_boss_dragon` |
| **display_mst_unit_id2** | 文字列 | ○ | トップ画面に表示する敵キャラID（2体目） | `enemy_boss_knight` |
| **display_mst_unit_id3** | 文字列 | ○ | トップ画面に表示する敵キャラID（3体目） | （空でも可） |
| **exp** | 整数 |  | バトルクリア時の獲得リーダーEXP | `100` |
| **coin** | 整数 |  | バトルクリア時の獲得コイン | `500` |
| **start_at** | 日時 |  | 開催開始日時（JST） | `2025-07-01 15:00:00` |
| **end_at** | 日時 |  | 開催終了日時（JST） | `2025-07-15 14:59:59` |
| **name.ja** | 文字列 |  | 降臨バトル名（日本語） | `夏の試練！灼熱の竜` |
| **boss_description.ja** | 文字列 |  | ボス説明文（日本語） | `灼熱の炎を纏う伝説の竜が降臨！` |

---

### 2. MstAdventBattleRank（スコアランク定義）

プレイヤーの累積スコアに応じて昇格するランク体系を定義します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | ランクID（一意キー） | `advent_summer_rank_bronze_1` |
| **mst_advent_battle_id** | 文字列 |  | 降臨バトルID（外部キー） | `advent_battle_summer_2025` |
| **rank_type** | 列挙型 |  | ランクタイプ | `Bronze`, `Silver`, `Gold`, `Master` |
| **rank_level** | 整数 |  | ランクレベル（1以上） | `1`, `2`, `3`, `4` |
| **required_lower_score** | 整数 |  | このランクに到達するための最低累積スコア | `5000` |
| **asset_key** | 文字列 | ○ | ランク表示用のアセットキー | `rank_bronze_1` |

#### ランク体系の設計ガイドライン

1. **4段階のランク**: Bronze → Silver → Gold → Master
2. **各ランクに複数レベル**: 通常は各ランク3〜5レベル程度
3. **スコアの昇順**: `required_lower_score` は昇順に設定
4. **最初のランク**: Bronze Lv1 の `required_lower_score` は `0` 以上の値

---

### 3. MstAdventBattleRewardGroup（報酬グループ定義）

報酬のグループ（条件）を定義します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | 報酬グループID（一意キー） | `advent_summer_maxscore_3000` |
| **mst_advent_battle_id** | 文字列 |  | 降臨バトルID（外部キー） | `advent_battle_summer_2025` |
| **reward_category** | 列挙型 |  | 報酬カテゴリー | `MaxScore`, `Ranking`, `Rank`, `RaidTotalScore`, `Drop` |
| **condition_value** | 整数 | ○ | 報酬条件値（カテゴリーにより意味が異なる） | `3000` |

#### 報酬カテゴリーの詳細

| カテゴリー | 説明 | condition_value の意味 | 受取タイミング |
|-----------|------|---------------------|-------------|
| **MaxScore** | ハイスコア報酬 | 必要スコア（例: `3000`） | スコア更新時に自動受取 |
| **Ranking** | ランキング報酬 | 未使用（空） | 開催期間終了後の集計完了時 |
| **Rank** | ランク到達報酬 | 未使用（空） | ランク到達時に自動受取 |
| **RaidTotalScore** | 協力スコア報酬 | 全ユーザー合計スコア（例: `50000`） | スコア到達時に自動受取 |
| **Drop** | ドロップ報酬 | 未使用（空） | バトル終了時に毎回 |

**注意**: Rank報酬の場合、報酬グループIDとMstAdventBattleRankのIDを紐付ける必要があります（命名規則で対応）。

---

### 4. MstAdventBattleReward（報酬内容詳細）

MstAdventBattleRewardGroup で定義した報酬グループに含まれる具体的な報酬を定義します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | 報酬ID（一意キー） | `advent_summer_maxscore_3000_reward_1` |
| **mst_advent_battle_reward_group_id** | 文字列 |  | 報酬グループID（外部キー） | `advent_summer_maxscore_3000` |
| **resource_type** | 列挙型 |  | 資源タイプ | `Coin`, `FreeDiamond`, `Item`, `Emblem`, `Unit` |
| **resource_id** | 文字列 | ○ | 資源ID（`resource_type`が`Item`, `Emblem`, `Unit`の場合は必須） | `item_summon_ticket` |
| **resource_amount** | 整数 |  | 資源の数量 | `10` |

#### 資源タイプの詳細

| resource_type | 説明 | resource_id の指定 |
|--------------|------|------------------|
| **Coin** | コイン | 不要（空） |
| **FreeDiamond** | 無料ダイヤ | 不要（空） |
| **Item** | アイテム | アイテムID（例: `item_summon_ticket`） |
| **Emblem** | エンブレム | エンブレムID（例: `emblem_advent_summer`） |
| **Unit** | ユニット（キャラ） | ユニットID（例: `unit_dragon`） |

---

### 5. MstAdventBattleClearReward（クリア報酬）

バトルクリア時に獲得できる報酬を定義します。ランダムドロップ報酬も設定可能です。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | クリア報酬ID（一意キー） | `advent_summer_clear_always_1` |
| **mst_advent_battle_id** | 文字列 |  | 降臨バトルID（外部キー） | `advent_battle_summer_2025` |
| **reward_category** | 列挙型 |  | 報酬カテゴリー | `Always`, `FirstClear`, `Random` |
| **resource_type** | 列挙型 |  | 資源タイプ | `Coin`, `FreeDiamond`, `Item`, `Emblem`, `Unit` |
| **resource_id** | 文字列 | ○ | 資源ID（`resource_type`が`Item`, `Emblem`, `Unit`の場合は必須） | `item_exp_potion_small` |
| **resource_amount** | 整数 |  | 資源の数量 | `1` |
| **percentage** | 整数 | ○ | ドロップ確率（%）（`Random`の場合のみ使用） | `30` |
| **sort_order** | 整数 |  | 表示順序 | `1`, `2`, `3` |

#### 報酬カテゴリーの詳細

| カテゴリー | 説明 | percentage の使用 |
|-----------|------|--------------------|
| **Always** | 毎回必ず獲得できる報酬 | 不要（空） |
| **FirstClear** | 初回クリア時のみ獲得できる報酬 | 不要（空） |
| **Random** | ランダムでドロップする報酬 | 必須（例: `30` = 30%の確率） |

---

## 設定例

ここでは、実際の降臨バトルを想定した完全な設定例を示します。

### 設定内容

- **降臨バトル名**: 夏の試練！灼熱の竜
- **ID**: `advent_battle_summer_2025`
- **バトルタイプ**: ScoreChallenge
- **開催期間**: 2025年7月1日 15:00 〜 7月15日 14:59
- **挑戦可能回数**: 通常5回/日、広告3回/日
- **バトル時間制限**: 180秒（3分）
- **ランク体系**: Bronze〜Master各4レベル（合計16ランク）
- **報酬体系**:
  - ハイスコア報酬: 8段階（3,000点〜500,000点）
  - ランク到達報酬: 全16ランク
  - ドロップ報酬: 毎回コイン500
  - クリア報酬: 初回クリアで無料ダイヤ50

---

### MstAdventBattle

| id | mst_event_id | mst_in_game_id | asset_key | advent_battle_type | time_limit_seconds | initial_battle_point | score_addition_type | score_additional_coef | event_bonus_group_id | challengeable_count | ad_challengeable_count | display_mst_unit_id1 | display_mst_unit_id2 | display_mst_unit_id3 | exp | coin | start_at | end_at | name.ja | boss_description.ja |
|-----|--------------|----------------|-----------|-------------------|-------------------|---------------------|--------------------|--------------------|---------------------|-------------------|----------------------|---------------------|---------------------|---------------------|-----|------|----------|--------|---------|-------------------|
| advent_battle_summer_2025 | event_summer_2025 | advent_summer_stage | advent_summer_bg | ScoreChallenge | 180 | 3 | AllEnemies | 1.0 | advent_summer_bonus | 5 | 3 | enemy_boss_dragon | enemy_boss_knight |  | 100 | 500 | 2025-07-01 15:00:00 | 2025-07-15 14:59:59 | 夏の試練！灼熱の竜 | 灼熱の炎を纏う伝説の竜が降臨！ |

---

### MstAdventBattleRank

| id | mst_advent_battle_id | rank_type | rank_level | required_lower_score | asset_key |
|----|---------------------|-----------|-----------|-------------------|-----------|
| advent_summer_rank_bronze_1 | advent_battle_summer_2025 | Bronze | 1 | 5000 | rank_bronze_1 |
| advent_summer_rank_bronze_2 | advent_battle_summer_2025 | Bronze | 2 | 10000 | rank_bronze_2 |
| advent_summer_rank_bronze_3 | advent_battle_summer_2025 | Bronze | 3 | 15000 | rank_bronze_3 |
| advent_summer_rank_bronze_4 | advent_battle_summer_2025 | Bronze | 4 | 20000 | rank_bronze_4 |
| advent_summer_rank_silver_1 | advent_battle_summer_2025 | Silver | 1 | 30000 | rank_silver_1 |
| advent_summer_rank_silver_2 | advent_battle_summer_2025 | Silver | 2 | 50000 | rank_silver_2 |
| advent_summer_rank_silver_3 | advent_battle_summer_2025 | Silver | 3 | 80000 | rank_silver_3 |
| advent_summer_rank_silver_4 | advent_battle_summer_2025 | Silver | 4 | 120000 | rank_silver_4 |
| advent_summer_rank_gold_1 | advent_battle_summer_2025 | Gold | 1 | 200000 | rank_gold_1 |
| advent_summer_rank_gold_2 | advent_battle_summer_2025 | Gold | 2 | 300000 | rank_gold_2 |
| advent_summer_rank_gold_3 | advent_battle_summer_2025 | Gold | 3 | 400000 | rank_gold_3 |
| advent_summer_rank_gold_4 | advent_battle_summer_2025 | Gold | 4 | 500000 | rank_gold_4 |
| advent_summer_rank_master_1 | advent_battle_summer_2025 | Master | 1 | 600000 | rank_master_1 |
| advent_summer_rank_master_2 | advent_battle_summer_2025 | Master | 2 | 700000 | rank_master_2 |
| advent_summer_rank_master_3 | advent_battle_summer_2025 | Master | 3 | 800000 | rank_master_3 |
| advent_summer_rank_master_4 | advent_battle_summer_2025 | Master | 4 | 1000000 | rank_master_4 |

---

### MstAdventBattleRewardGroup

| id | mst_advent_battle_id | reward_category | condition_value |
|----|---------------------|----------------|----------------|
| advent_summer_maxscore_3000 | advent_battle_summer_2025 | MaxScore | 3000 |
| advent_summer_maxscore_6000 | advent_battle_summer_2025 | MaxScore | 6000 |
| advent_summer_maxscore_12000 | advent_battle_summer_2025 | MaxScore | 12000 |
| advent_summer_maxscore_24000 | advent_battle_summer_2025 | MaxScore | 24000 |
| advent_summer_maxscore_48000 | advent_battle_summer_2025 | MaxScore | 48000 |
| advent_summer_maxscore_100000 | advent_battle_summer_2025 | MaxScore | 100000 |
| advent_summer_maxscore_200000 | advent_battle_summer_2025 | MaxScore | 200000 |
| advent_summer_maxscore_500000 | advent_battle_summer_2025 | MaxScore | 500000 |
| advent_summer_rank_bronze_1_reward | advent_battle_summer_2025 | Rank |  |
| advent_summer_rank_bronze_2_reward | advent_battle_summer_2025 | Rank |  |
| advent_summer_rank_bronze_3_reward | advent_battle_summer_2025 | Rank |  |
| advent_summer_rank_bronze_4_reward | advent_battle_summer_2025 | Rank |  |
| advent_summer_drop | advent_battle_summer_2025 | Drop |  |

---

### MstAdventBattleReward

| id | mst_advent_battle_reward_group_id | resource_type | resource_id | resource_amount |
|----|----------------------------------|---------------|------------|----------------|
| advent_summer_maxscore_3000_reward_1 | advent_summer_maxscore_3000 | Coin |  | 5000 |
| advent_summer_maxscore_3000_reward_2 | advent_summer_maxscore_3000 | Item | item_summon_ticket | 1 |
| advent_summer_maxscore_6000_reward_1 | advent_summer_maxscore_6000 | Coin |  | 10000 |
| advent_summer_maxscore_6000_reward_2 | advent_summer_maxscore_6000 | Item | item_summon_ticket | 2 |
| advent_summer_maxscore_12000_reward_1 | advent_summer_maxscore_12000 | FreeDiamond |  | 30 |
| advent_summer_maxscore_12000_reward_2 | advent_summer_maxscore_12000 | Item | item_summon_ticket | 3 |
| advent_summer_rank_bronze_1_reward_1 | advent_summer_rank_bronze_1_reward | Coin |  | 1000 |
| advent_summer_rank_bronze_1_reward_2 | advent_summer_rank_bronze_1_reward | Item | item_exp_potion_small | 3 |
| advent_summer_rank_bronze_2_reward_1 | advent_summer_rank_bronze_2_reward | Coin |  | 2000 |
| advent_summer_rank_bronze_2_reward_2 | advent_summer_rank_bronze_2_reward | Item | item_exp_potion_small | 5 |
| advent_summer_drop_reward_1 | advent_summer_drop | Coin |  | 500 |

---

### MstAdventBattleClearReward

| id | mst_advent_battle_id | reward_category | resource_type | resource_id | resource_amount | percentage | sort_order |
|----|---------------------|----------------|---------------|------------|----------------|-----------|-----------|
| advent_summer_clear_always_1 | advent_battle_summer_2025 | Always | Coin |  | 500 |  | 1 |
| advent_summer_clear_first_1 | advent_battle_summer_2025 | FirstClear | FreeDiamond |  | 50 |  | 1 |
| advent_summer_clear_first_2 | advent_battle_summer_2025 | FirstClear | Item | item_summon_ticket | 1 |  | 2 |
| advent_summer_clear_random_1 | advent_battle_summer_2025 | Random | Item | item_rare_material_1 | 1 | 30 | 1 |
| advent_summer_clear_random_2 | advent_battle_summer_2025 | Random | Item | item_rare_material_2 | 1 | 20 | 2 |

---

## 注意事項とチェックポイント

### 必須確認事項

#### 1. ID の一意性

- [ ] すべてのテーブルで `id` フィールドは一意であること
- [ ] 降臨バトルIDは他のイベントと重複しないこと

#### 2. 外部キーの整合性

- [ ] `mst_advent_battle_id` が MstAdventBattle の `id` と一致すること
- [ ] `mst_advent_battle_reward_group_id` が MstAdventBattleRewardGroup の `id` と一致すること
- [ ] `mst_event_id`, `mst_in_game_id` など外部参照するIDが存在すること

#### 3. 開催期間の設定

- [ ] `start_at` < `end_at` であること
- [ ] 日時フォーマットは `YYYY-MM-DD HH:MM:SS` （JSTタイムゾーン）
- [ ] 他のイベントと期間が重複していないか確認

#### 4. ランク設定の確認

- [ ] `required_lower_score` が昇順になっていること
- [ ] Bronze Lv1 から Master 最上位レベルまで連続していること
- [ ] 各ランクタイプ（Bronze, Silver, Gold, Master）が少なくとも1レベル以上あること

#### 5. 報酬設定の確認

- [ ] MaxScore報酬の `condition_value` が昇順になっていること
- [ ] RaidTotalScore報酬の `condition_value` が昇順になっていること
- [ ] Rank報酬グループIDとMstAdventBattleRankのIDが紐づいていること
- [ ] すべての報酬グループに少なくとも1つの報酬が設定されていること

#### 6. 資源IDの存在確認

- [ ] `resource_type` が `Item` の場合、`resource_id` がMstItemに存在すること
- [ ] `resource_type` が `Emblem` の場合、`resource_id` がMstEmblemに存在すること
- [ ] `resource_type` が `Unit` の場合、`resource_id` がMstUnitに存在すること

#### 7. ドロップ確率の確認

- [ ] Random報酬の `percentage` が 0 < percentage ≤ 100 であること
- [ ] percentage の合計が100%を超えても良い（複数同時ドロップ可能）

#### 8. バトル設定の妥当性

- [ ] `time_limit_seconds` が適切な値であること（推奨: 60〜300秒）
- [ ] `challengeable_count` が適切な値であること（推奨: 3〜10回）
- [ ] `ad_challengeable_count` が適切な値であること（推奨: 1〜5回）
