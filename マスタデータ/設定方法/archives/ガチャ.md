# ガチャ マスタデータ設定方法

## 目次

1. [概要](#概要)
2. [ガチャで使用するテーブル](#ガチャで使用するテーブル)
3. [各テーブルの設定方法](#各テーブルの設定方法)
4. [設定例](#設定例)
5. [注意事項とチェックポイント](#注意事項とチェックポイント)
6. [付録：主要なENUM一覧](#付録主要なenum一覧)

---

## 概要

ガチャ（ガシャ）は、プレイヤーがダイヤモンドやアイテムなどのリソースを消費して、ユニットやアイテムを抽選で獲得できる機能です。

### ガチャのタイプ

| タイプ | 説明 |
|-------|------|
| **Normal** | 通常ガチャ |
| **Premium** | プレミアムガチャ |
| **Pickup** | ピックアップガチャ |
| **Free** | 無料ガチャ |
| **Ticket** | チケットガチャ |
| **Festival** | フェスティバルガチャ |
| **PaidOnly** | 有償限定ガチャ |
| **Medal** | メダルガチャ |
| **Tutorial** | チュートリアルガチャ |

---

## ガチャで使用するテーブル

ガチャの設定には以下のシートを使用します。

| シート | 対応するDBテーブル | 用途 |
|-------|------------------|------|
| **OprGacha** | `opr_gachas`<br>`opr_gachas_i18n` | ガチャの基本設定と多言語対応 |
| **OprGachaPrize** | `opr_gacha_prizes` | ガチャの排出物設定 |
| **OprGachaUseResource** | `opr_gacha_use_resources` | ガチャを引くために必要なリソース設定 |
| **OprGachaUpper** | `opr_gacha_uppers` | ガチャの天井設定 |
| **OprGachaDisplayUnitI18n** | `opr_gacha_display_units_i18n` | 表示用ユニットの多言語設定 |

---

## 各テーブルの設定方法

### 1. OprGacha（ガチャ基本設定）

ガチャの基本的な設定を行います。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | ガチャID（一意） | `2` |
| **gacha_type** | 列挙型 | ○ | ガチャのタイプ（Normal, Premium, Pickup, Free, Ticket, Festival, PaidOnly, Medal, Tutorial） | `Premium` |
| **upper_group** | 文字列 |  | 天井設定区分（OprGachaUpper.upper_groupと対応） | `Premium` |
| **enable_ad_play** | 整数 |  | 広告で回せるか（0=無効、1=有効） | `1` |
| **enable_add_ad_play_upper** | 整数 |  | 広告で天井を動かすか（0=無効、1=有効） | `1` |
| **ad_play_interval_time** | 整数 | ○ | 広告で回すことができるインターバル時間（分単位） | `0` |
| **multi_draw_count** | 整数 |  | N連の指定 | `10` |
| **multi_fixed_prize_count** | 整数 | ○ | N連の確定枠数 | `0` |
| **daily_play_limit_count** | 整数 | ○ | 1日に回すことができる上限数 | `__NULL__` |
| **total_play_limit_count** | 整数 | ○ | 回すことができる上限数 | `__NULL__` |
| **daily_ad_limit_count** | 整数 | ○ | 1日に広告で回すことができる上限数 | `3` |
| **total_ad_limit_count** | 整数 | ○ | 広告で回すことができる上限数 | `__NULL__` |
| **prize_group_id** | 文字列 |  | 排出物グループID（OprGachaPrize.group_idと対応） | `1` |
| **fixed_prize_group_id** | 文字列 | ○ | 確定枠の排出物グループID（OprGachaPrize.group_idと対応） | `__NULL__` |
| **appearance_condition** | 列挙型 |  | 登場条件（Always, HasTicket） | `Always` |
| **unlock_condition_type** | 列挙型 |  | 開放条件タイプ（None, MainPartTutorialComplete） | `None` |
| **unlock_duration_hours** | 整数 | ○ | 条件達成からの開放時間（時間単位） | `__NULL__` |
| **start_at** | 日時 |  | 開始日時 | `2024-01-01 09:00:00` |
| **end_at** | 日時 |  | 終了日時 | `2038-01-01 00:00:00` |
| **display_information_id** | 文字列 |  | ガチャ詳細用お知らせID | （空欄） |
| **display_gacha_caution_id** | 文字列 | ○ | ガチャ注意事項のID（adm_gacha_cautions.id） | `4c341dda-20e1-42ff-8ade-b0fc02e07f8d` |
| **gacha_priority** | 整数 |  | バナー表示順（小さい順） | `5` |
| **display_mst_unit_id** | テキスト | ○ | 表示に使用するピックアップユニットIDを指定する | （空欄） |

#### 多言語対応（OprGachaI18n）

シートには`.ja`、`.en`、`.zh-Hant`のサフィックスで多言語対応を設定します。

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **name.ja** | テキスト | ○ | ガチャ名（日本語） | `プレミアムガチャ` |
| **description.ja** | テキスト | ○ | ガチャ説明（日本語） | `最高レアリティのキャラが出やすい！` |
| **max_rarity_upper_description.ja** | 文字列 | ○ | 最高レアリティ天井の文言 | `80連で最高レアリティ確定！` |
| **pickup_upper_description.ja** | 文字列 | ○ | ピックアップ天井の文言 | `60連でピックアップキャラ確定！` |
| **fixed_prize_description.ja** | 文字列 |  | 確定枠の表示文言 | `10連目は確定枠！` |
| **banner_url.ja** | テキスト | ○ | バナーURL | `https://example.com/banner.png` |
| **logo_asset_key.ja** | 文字列 | ○ | ロゴアセットキー | （空欄） |
| **logo_banner_url.ja** | テキスト | ○ | 詳細へ飛んだ後のロゴバナーURL | （空欄） |
| **gacha_background_color.ja** | 文字列 |  | ガチャ背景色（HEXコード） | `#FF5733` |
| **gacha_banner_size.ja** | 列挙型 |  | ガチャバナーサイズ（SizeM, SizeL） | `SizeM` |

#### `__NULL__`の使い方

NULL許容のフィールドで、明示的にNULLを設定したい場合は`__NULL__`を記載します。空欄のままでもNULLとして扱われますが、意図的にNULLであることを明示する場合に使用します。

---

### 2. OprGachaPrize（ガチャ排出物設定）

ガチャの排出物とその排出確率を設定します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | 排出物ID（一意） | `1` |
| **group_id** | 文字列 |  | 同じ抽選テーブルとしてまとめるグループID | `1` |
| **resource_type** | 列挙型 |  | 排出物のタイプ（Coin, Unit, Item） | `Unit` |
| **resource_id** | 文字列 | ○ | 排出物のID（ユニットIDまたはアイテムID） | `chara_sur_00001` |
| **resource_amount** | 整数 | ○ | 排出物の数量 | `1` |
| **weight** | 整数 |  | 出現比重（大きいほど出やすい） | `10` |
| **pickup** | 整数 |  | ピックアップ対象か（0=通常、1=ピックアップ） | `1` |

#### 補足

- **group_id**: OprGacha.prize_group_idまたはfixed_prize_group_idと対応します。同じgroup_idを持つ排出物が1つの抽選テーブルを構成します。
- **weight**: 出現比重は相対的な値です。例えば、weight=10の排出物が2つある場合、それぞれ50%の確率で排出されます。

---

### 3. OprGachaUseResource（ガチャコスト設定）

ガチャを引くために必要なリソースを設定します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | コスト設定ID（一意） | `2` |
| **opr_gacha_id** | 文字列 |  | ガチャID（OprGacha.idと対応） | `2` |
| **cost_type** | 列挙型 |  | ガチャで使用するコストのタイプ（Diamond, PaidDiamond, Free, Item, Ad） | `Diamond` |
| **cost_id** | 文字列 | ○ | 消費リソースID（ItemタイプのときアイテムID） | （空欄） |
| **cost_num** | 整数 |  | 一回で必要なアイテムの個数 | `300` |
| **draw_count** | 整数 |  | リソースを1回分消費して回せる回数 | `1` |
| **cost_priority** | 整数 |  | 使用するコストの優先度設定（小さい順） | `2` |

#### 補足

- **cost_type**: `Item`を指定した場合は、`cost_id`にアイテムIDを設定します。`Diamond`や`PaidDiamond`の場合は`cost_id`は空欄です。
- **draw_count**: 例えば、`draw_count=10`の場合、1回のコスト消費で10連ガチャが引けます。

---

### 4. OprGachaUpper（ガチャ天井設定）

ガチャの天井（一定回数引くと確定で高レアリティが出る仕組み）を設定します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | 天井設定ID（一意） | `1` |
| **upper_group** | 文字列 |  | 天井設定区分（OprGacha.upper_groupと対応） | `Premium` |
| **upper_type** | 列挙型 |  | 天井タイプ（MaxRarity, Pickup） | `MaxRarity` |
| **count** | 整数 |  | 天井を保証する回数 | `80` |

#### 補足

- **upper_type**:
  - `MaxRarity`: 最高レアリティのキャラクターが確定で排出される天井
  - `Pickup`: ピックアップキャラクターが確定で排出される天井
- 同じ`upper_group`に対して、`MaxRarity`と`Pickup`の両方の天井を設定できます。

---

### 5. OprGachaDisplayUnitI18n（表示用ユニット設定）

ガチャの詳細画面で表示するユニット（キャラクター）の情報を設定します。

#### 列の説明

| 列名 | 型 | NULL許容 | 説明 | 設定例 |
|------|-----|---------|------|--------|
| **id** | 文字列 |  | 表示ユニットID（一意） | `3-1` |
| **opr_gacha_id** | 文字列 |  | ガチャID（OprGacha.idと対応） | `3` |
| **mst_unit_id** | 文字列 |  | 表示するユニットID | `chara_gom_00001` |
| **language** | 列挙型 |  | 言語情報（ja, en, zh-Hant） | `ja` |
| **sort_order** | 整数 |  | 表示順 | `1` |
| **description** | テキスト | ○ | ユニットの説明文 | `必殺ワザで複数の敵に攻撃するキャラ！` |

---

## 設定例

### プレミアムガチャの設定例

#### OprGacha

| id | gacha_type | upper_group | enable_ad_play | multi_draw_count | prize_group_id | appearance_condition | start_at | end_at | gacha_priority |
|-----|------------|-------------|---------------|-----------------|---------------|---------------------|----------|---------|---------------|
| 2 | Premium | Premium | 1 | 10 | 1 | Always | 2024-01-01 09:00:00 | 2038-01-01 00:00:00 | 5 |

#### OprGachaPrize

| id | group_id | resource_type | resource_id | resource_amount | weight | pickup |
|----|----------|---------------|-------------|----------------|--------|--------|
| 1 | 1 | Unit | chara_sur_00001 | 1 | 10 | 1 |
| 2 | 1 | Unit | chara_jig_00001 | 1 | 10 | 0 |
| 3 | 1 | Unit | chara_jig_00101 | 1 | 10 | 0 |

#### OprGachaUseResource

| id | opr_gacha_id | cost_type | cost_id | cost_num | draw_count | cost_priority |
|----|-------------|-----------|---------|---------|-----------|--------------|
| 2 | 2 | Diamond | （空欄） | 300 | 1 | 2 |
| 3 | 2 | Item | item_icon_gasha_ticket_premium | 1 | 1 | 1 |
| 4 | 2 | Diamond | （空欄） | 2800 | 10 | 1 |

#### OprGachaUpper

| id | upper_group | upper_type | count |
|----|-------------|-----------|-------|
| 1 | Premium | MaxRarity | 80 |

---

## 注意事項とチェックポイント

### 必須確認事項

#### 1. IDの一意性

- [ ] 各テーブルの`id`列が一意であることを確認
- [ ] `group_id`が正しく参照されていることを確認

#### 2. 外部キーの整合性

- [ ] OprGacha.`prize_group_id`がOprGachaPrize.`group_id`に存在する
- [ ] OprGacha.`upper_group`がOprGachaUpper.`upper_group`に存在する
- [ ] OprGachaUseResource.`opr_gacha_id`がOprGacha.`id`に存在する

#### 3. 日時の設定

- [ ] `start_at`が`end_at`より前であることを確認
- [ ] 日時フォーマットが`YYYY-MM-DD HH:MM:SS`であることを確認

### よくあるミス

#### 1. ENUM値のキャメルケース/スネークケースの混同

**誤**: `gacha_type`に`premium`や`paid_only`を設定
**正**: `gacha_type`に`Premium`や`PaidOnly`を設定

すべてのENUM値はキャメルケースで記述します。

#### 2. `__NULL__`と空欄の混同

**誤**: NULL許容のフィールドを空欄のままにする（意図が不明確）
**正**: 明示的にNULLにしたい場合は`__NULL__`を記載

#### 3. weight（出現比重）の設定ミス

**誤**: すべての排出物に同じweightを設定してしまう（意図した確率にならない）
**正**: 排出確率を考慮してweightを設定する

例：ピックアップキャラを2倍出やすくしたい場合、ピックアップキャラのweight=20、その他のweight=10

### テスト時の確認項目

- [ ] ガチャがゲーム内で正しく表示される
- [ ] 設定したコスト（ダイヤモンド、アイテムなど）で正しくガチャが引ける
- [ ] 排出物が設定した確率で排出される
- [ ] 天井機能が正しく動作する（指定回数引くと確定で排出される）
- [ ] 多言語設定が正しく反映される

---

## 付録：主要なENUM一覧

### GachaType（ガチャタイプ）

- `Normal` - 通常ガチャ
- `Premium` - プレミアムガチャ
- `Pickup` - ピックアップガチャ
- `Free` - 無料ガチャ
- `Ticket` - チケットガチャ
- `Festival` - フェスティバルガチャ
- `PaidOnly` - 有償限定ガチャ
- `Medal` - メダルガチャ
- `Tutorial` - チュートリアルガチャ

### CostType（コストタイプ）

- `Diamond` - ダイヤモンド（無償＋有償）
- `PaidDiamond` - 有償ダイヤモンドのみ
- `Free` - 無料
- `Item` - アイテム
- `Ad` - 広告視聴

### UpperType（天井タイプ）

- `MaxRarity` - 最高レアリティ天井
- `Pickup` - ピックアップ天井

### AppearanceCondition（登場条件）

- `Always` - 常に表示
- `HasTicket` - チケット所持時のみ表示

### GachaUnlockConditionType（開放条件タイプ）

- `None` - 開放条件なし
- `MainPartTutorialComplete` - メインパートチュートリアル完了

### ResourceType（排出物タイプ）

- `Coin` - コイン
- `Unit` - ユニット（キャラクター）
- `Item` - アイテム

**Note**: すべてのENUM値はキャメルケースで記述する必要があります。スネークケース（例: `paid_only`）は使用できません。
