# 降臨バトルミッション マスタデータ設定手順書

## 概要

降臨バトルミッションのマスタデータ作成手順を記載します。
本手順書に従うことで、ゲーム内でエラーが発生しない正確なマスタデータを作成できます。

## 対象テーブル

降臨バトルミッションでは、以下の2シート構成でマスタデータを作成します。

**出力シート**:
- **MstMissionLimitedTerm** - 期間限定ミッションの基本情報（MstMissionLimitedTermI18nのカラムを含む）
- **MstMissionReward** - ミッション報酬

**重要**: MstMissionLimitedTermI18nは独立したシートではなく、MstMissionLimitedTermシート内に統合されています。

## 参照ドキュメント

- [destination_scene設定ルール](./destination_scene設定ルール.md)

## 作成フロー

### 1. 仕様書の確認

運営仕様書から以下の情報を抽出します。

**必要情報**:
- ミッションの達成条件（何を何回実行するか）
- ミッションの報酬内容
- ミッションの開催期間
- ミッションの表示順序
- ミッション説明文（日本語）

**参考**: `specs/正月特別号！【推しの子】 いいジャン祭＋メインクエスト_仕様書 - 03_降臨バトル.csv`

### 2. データ構造の確認

出力するデータ形式のヘッダーは、以下のスキーマファイルに定義されています。

- `sheet_schemas/MstMissionLimitedTerm.csv`
- `sheet_schemas/MstMissionReward.csv`

**重要**: 列の順序を必ず守ってください。順序が異なるとデータ取り込みエラーが発生します。

### 3. MstMissionLimitedTerm シートの作成（I18n含む）

#### 3.1 シートスキーマ

このシートには、TABLE行、ENABLE行、データ行が含まれます。

**TABLE行** - 各カラムがどのテーブルに属するかを示します。

```
TABLE,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTermI18n
```

**ENABLE行** - カラム名を示します。

```
ENABLE,id,release_key,progress_group_key,criterion_type,criterion_value,criterion_count,mission_category,mst_mission_reward_group_id,sort_order,destination_scene,start_at,end_at,description.ja
```

#### 3.2 各カラムの設定ルール

| カラム名 | 設定ルール |
|---------|-----------|
| **ENABLE** | 固定値: `e` (有効化) |
| **id** | ミッションの一意識別子。命名規則: `limited_term_{連番}` |
| **release_key** | リリースキー。例: `202512020` |
| **progress_group_key** | 進捗グループキー。同じグループのミッションは進捗を共有する。例: `group9` |
| **criterion_type** | 達成条件タイプ。下記の「criterion_type設定一覧」を参照 |
| **criterion_value** | 条件の指定値。降臨バトルミッションでは通常空欄（NULL） |
| **criterion_count** | 条件の回数。例: `5`（5回挑戦） |
| **mission_category** | ミッションカテゴリ。降臨バトルの場合: `AdventBattle` |
| **mst_mission_reward_group_id** | 報酬グループID。MstMissionRewardのgroup_idと対応。例: `osh_00001_limited_term_1` |
| **sort_order** | 表示順序。小さい数字ほど上位に表示。例: `1`, `2`, `3`... |
| **destination_scene** | タップ時の遷移先シーン。[destination_scene設定ルール](./destination_scene設定ルール.md)を参照 |
| **start_at** | 開始日時。フォーマット: `YYYY-MM-DD HH:MM:SS` |
| **end_at** | 終了日時。フォーマット: `YYYY-MM-DD HH:MM:SS` |
| **description.ja** | ミッション説明文（日本語）。ユーザーに表示される文言 |

#### criterion_type設定一覧

降臨バトルミッション（mission_category=`AdventBattle`）で使用可能なcriterion_typeは以下の3種類のみです。**大文字小文字を正確に一致**させてください。

| criterion_type | 説明 | criterion_value | criterion_count | 使用例 |
|---------------|------|----------------|----------------|--------|
| **AdventBattleChallengeCount** | 挑戦回数 | 空欄（NULL） | 必要な挑戦回数 | 5回挑戦、10回挑戦、20回挑戦 |
| **AdventBattleTotalScore** | 累計スコア | 空欄（NULL） | 必要な累計スコア | 累計スコア10000達成、累計スコア50000達成 |
| **AdventBattleScore** | ハイスコア | 空欄（NULL） | 必要なハイスコア | ハイスコア5000達成、ハイスコア10000達成 |

**重要事項**:
- 降臨バトルミッションでは上記3種類のみ使用可能です
- **criterion_value**は常に空欄（NULL）にしてください
- **criterion_count**には達成に必要な回数またはスコアを設定します
- 最も一般的なのは**AdventBattleChallengeCount**（挑戦回数）です

#### 3.3 降臨バトルミッション固有の設定

降臨バトルミッションでは、以下のように設定します。

- **mission_category**: `AdventBattle`（固定）
- **destination_scene**: `AdventBattle`（降臨バトル画面へ遷移）
- **criterion_type**: 上記の3種類から選択
- **criterion_value**: 空欄（NULL）
- **criterion_count**: 達成に必要な回数またはスコア

#### 3.4 作成例

```
TABLE,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTermI18n
ENABLE,id,release_key,progress_group_key,criterion_type,criterion_value,criterion_count,mission_category,mst_mission_reward_group_id,sort_order,destination_scene,start_at,end_at,description.ja
e,limited_term_33,202512020,group9,AdventBattleChallengeCount,,5,AdventBattle,osh_00001_limited_term_1,1,AdventBattle,2026-01-09 15:00:00,2026-01-13 14:59:59,降臨バトル「ファーストライブ」に5回挑戦しよう！
e,limited_term_34,202512020,group9,AdventBattleChallengeCount,,10,AdventBattle,osh_00001_limited_term_2,2,AdventBattle,2026-01-09 15:00:00,2026-01-13 14:59:59,降臨バトル「ファーストライブ」に10回挑戦しよう！
e,limited_term_35,202512020,group9,AdventBattleChallengeCount,,20,AdventBattle,osh_00001_limited_term_3,3,AdventBattle,2026-01-09 15:00:00,2026-01-13 14:59:59,降臨バトル「ファーストライブ」に20回挑戦しよう！
```

#### 3.5 説明文作成のポイント

- イベント名を明記する（例: 「ファーストライブ」）
- 達成条件を明確に記載する（例: 「5回挑戦」）
- ユーザーフレンドリーな表現にする
- 文末は「〜しよう！」形式が推奨

### 4. MstMissionReward シートの作成

#### 4.1 シートスキーマ

このシートには、TABLE行、ENABLE行、データ行が含まれます。

**TABLE行** - 各カラムがどのテーブルに属するかを示します。

```
TABLE,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward
```

**ENABLE行** - カラム名を示します。

```
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
```

#### 4.2 各カラムの設定ルール

| カラム名 | 設定ルール |
|---------|-----------|
| **ENABLE** | 固定値: `e` (有効化) |
| **id** | 報酬の一意識別子。命名規則: `mission_reward_{連番}` |
| **release_key** | リリースキー。MstMissionLimitedTermと同じ値 |
| **group_id** | 報酬グループID。MstMissionLimitedTermのmst_mission_reward_group_idと対応 |
| **resource_type** | 報酬のリソースタイプ。下記の「resource_type設定一覧」を参照 |
| **resource_id** | リソースID。resource_typeに応じて設定。不要な場合は空欄 |
| **resource_amount** | 報酬の数量 |
| **sort_order** | 表示順序。複数報酬がある場合の並び順 |
| **備考** | 任意のメモ。ミッション説明文などを記載すると管理しやすい |

#### resource_type設定一覧

ミッション報酬(MstMissionReward)で使用可能なresource_typeは以下の通りです。**大文字小文字を正確に一致**させてください。

| resource_type | 説明 | resource_id | 参照先テーブル | 主な用途 |
|--------------|------|------------|--------------|---------|
| **Coin** | コイン（ゲーム内通貨） | 不要（空欄） | - | ミッション報酬の定番 |
| **FreeDiamond** | 無償プリズム | 不要（空欄） | - | 重要なミッション報酬 |
| **Exp** | 経験値（プレイヤー経験値） | 不要（空欄） | - | クエストクリア報酬 |
| **Item** | アイテム（チケット、素材など） | **必要** | **MstItem** | ガシャチケット、育成素材 |
| **Emblem** | エンブレム（称号） | **必要** | **MstEmblem** | イベント達成報酬 |
| **Unit** | ユニット（キャラクター） | **必要** | **MstUnit** | ガシャ報酬、特別報酬 |

**重要事項**:
- 上記6種類のみが設定可能です（DBスキーマで定義されています）
- resource_idが「必要」のタイプでは、対応するマスターテーブルに存在するIDを設定してください
- resource_idが「不要」のタイプでは、空欄のままにしてください
- **降臨バトルミッションの典型的な報酬**: **Coin**、**FreeDiamond**
- **その他のミッション**: **Item**（ガシャチケット等）、**Emblem**も使用可能

#### 4.3 降臨バトルミッション報酬の典型的なパターン

降臨バトルミッションでは、以下のような報酬が一般的です。

- **Coin** - コイン報酬
- **FreeDiamond** - 無償プリズム報酬
- **Item** - アイテム報酬（ガシャチケットなど）

#### 4.4 作成例

```
TABLE,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_527,202512020,osh_00001_limited_term_1,Coin,,2000,1,降臨バトル「ファーストライブ」に5回挑戦しよう！
e,mission_reward_528,202512020,osh_00001_limited_term_2,FreeDiamond,,20,1,降臨バトル「ファーストライブ」に10回挑戦しよう！
e,mission_reward_529,202512020,osh_00001_limited_term_3,Coin,,3000,1,降臨バトル「ファーストライブ」に20回挑戦しよう！
e,mission_reward_530,202512020,osh_00001_limited_term_4,FreeDiamond,,30,1,降臨バトル「ファーストライブ」に25回挑戦しよう！
```

### 5. データ整合性のチェック

マスタデータ作成後、以下の項目を確認してください。

#### 5.1 必須チェック項目

- [ ] **ヘッダーの列順が正しいか**
  - スキーマファイルと完全一致している

- [ ] **IDの一意性**
  - すべてのidが一意である
  - 他のリリースのidと重複していない

- [ ] **ID採番ルール**
  - MstMissionLimitedTerm.id: `limited_term_{連番}`
  - MstMissionLimitedTerm.progress_group_key: `group{イベントごとの連番}`
  - MstMissionLimitedTerm.mst_mission_reward_group_id: `{作品ID}_00001_limited_term_{同一イベント内連番}`
  - MstMissionReward.id: `mission_reward_{連番}`
  - MstMissionReward.group_id: MstMissionLimitedTerm.mst_mission_reward_group_idと同じ値

- [ ] **リレーションの整合性**
  - `MstMissionLimitedTerm.mst_mission_reward_group_id` = `MstMissionReward.group_id`
  - すべてのミッションにdescription.ja（説明文）が設定されている

- [ ] **criterion_typeの正確性**
  - 「criterion_type設定一覧」に記載された3種類のいずれかを使用している
  - 大文字小文字が正確に一致している
  - criterion_valueが空欄（NULL）である

- [ ] **destination_sceneの正確性**
  - [destination_scene設定ルール](./destination_scene設定ルール.md)に従っている

- [ ] **resource_typeの正確性**
  - 「resource_type設定一覧」に記載された値を使用している
  - 大文字小文字が正確に一致している
  - resource_idの設定有無が正しい（必要なタイプには設定、不要なタイプは空欄）

- [ ] **日時フォーマット**
  - `YYYY-MM-DD HH:MM:SS`形式である
  - start_at < end_at である

- [ ] **数値の妥当性**
  - criterion_count, resource_amount, sort_orderが正の整数である

#### 5.2 推奨チェック項目

- [ ] **命名規則の統一**
  - idのプレフィックスが統一されている

- [ ] **報酬バランス**
  - 達成難易度に応じた報酬量である

- [ ] **説明文の品質**
  - 誤字脱字がない
  - ユーザーが理解しやすい表現である

### 6. 出力フォーマット

最終的な出力は以下の2シート構成で行います。

#### 6.1 MstMissionLimitedTerm シート（I18n含む）

**CSV形式**:

```csv
TABLE,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTerm,MstMissionLimitedTermI18n
ENABLE,id,release_key,progress_group_key,criterion_type,criterion_value,criterion_count,mission_category,mst_mission_reward_group_id,sort_order,destination_scene,start_at,end_at,description.ja
e,limited_term_33,202512020,group9,AdventBattleChallengeCount,,5,AdventBattle,osh_00001_limited_term_1,1,AdventBattle,2026-01-09 15:00:00,2026-01-13 14:59:59,降臨バトル「ファーストライブ」に5回挑戦しよう！
```

**Markdown表形式**:

```markdown
## MstMissionLimitedTerm

| ENABLE | id | release_key | ... | description.ja |
|--------|-----|-------------|-----|---------------|
| e | limited_term_33 | 202512020 | ... | 降臨バトル「ファーストライブ」に5回挑戦しよう！ |
```

#### 6.2 MstMissionReward シート

**CSV形式**:

```csv
TABLE,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_527,202512020,osh_00001_limited_term_1,Coin,,2000,1,降臨バトル「ファーストライブ」に5回挑戦しよう！
```

**Markdown表形式**:

```markdown
## MstMissionReward

| ENABLE | id | release_key | ... |
|--------|-----|-------------|-----|
| e | mission_reward_527 | 202512020 | ... |
```

#### 6.3 重要なポイント

- **TABLE行は必須**: 各シートの先頭にTABLE行を含める
- **2シート構成**: MstMissionLimitedTermとMstMissionRewardの2シートのみ
- **I18nはカラムとして統合**: description.jaカラムでI18n情報を管理

## トラブルシューティング

### よくあるエラー

#### エラー1: criterion_typeが不正

**症状**: データ投入時にエラーが発生する、またはミッションが正しく機能しない

**原因**: 「criterion_type設定一覧」に記載されていない値を設定している

**対処**:
1. 降臨バトルミッションでは、以下の3種類のみ使用可能です
   - `AdventBattleChallengeCount`
   - `AdventBattleTotalScore`
   - `AdventBattleScore`
2. 大文字小文字が正確に一致しているか確認してください

#### エラー2: resource_idの設定漏れ

**症状**: 報酬が正しく付与されない

**原因**: resource_type=Itemなのにresource_idが空欄

**対処**: 「resource_type設定一覧」を確認し、必要なresource_idを設定する

#### エラー3: リレーションの不整合

**症状**: ミッション達成時に報酬が付与されない

**原因**: `MstMissionLimitedTerm.mst_mission_reward_group_id`に対応する`MstMissionReward.group_id`が存在しない

**対処**: IDの対応関係を再確認し、修正する

## 参考データ

### 実際の作成例

`released/`ディレクトリに実際のマスタデータ例があります。

- `released/MstMissionLimitedTerm.csv` - 期間限定ミッション（description.ja含む）
- `released/MstMissionReward.csv` - ミッション報酬

新規作成時は、これらのファイルを参考にしてください。

## 補足情報

### release_keyについて

release_keyは、リリースごとにデータを管理するためのキーです。
形式: `YYYYMMDDN` (年月日 + 連番)

例:
- `202512020` - 2025年12月2日のリリース（連番0）

### progress_group_keyについて

同じprogress_group_keyを持つミッションは、進捗を共有します。
降臨バトルミッションでは、通常すべてのミッションに同じgroup_keyを設定します。

例: `group9`

### sort_orderについて

ゲーム内での表示順序を制御します。
小さい数字ほど上位に表示されます。

推奨: 1から始めて、1ずつ増やす（1, 2, 3, 4...）

## 更新履歴

- 2026-01-17: 初版作成
