# ミッションマスタデータ作成手順書

## 概要

このドキュメントは、運営仕様書（HTML）からミッション関連のマスタデータCSVを作成する手順をまとめたものです。

**対象設計書**: `04_ミッション.html`（イベント仕様書内）

**作成するマスタデータ**:
- MstMissionEvent.csv
- MstMissionEventI18n.csv
- MstMissionEventDependency.csv
- MstMissionEventDailyBonus.csv
- MstMissionEventDailyBonusSchedule.csv
- MstMissionReward.csv
- MstMissionLimitedTerm.csv
- MstMissionLimitedTermI18n.csv
- MstMissionAchievement.csv

---

## 前提知識

### テーブル間の関係

```
MstEvent
  └─ MstMissionEventDailyBonusSchedule (イベント期間とログボ期間の定義)
       └─ MstMissionEventDailyBonus (ログインボーナス各日の定義)
            └─ MstMissionReward (報酬内容)

MstEvent
  └─ MstMissionEvent (イベントミッション本体)
       ├─ MstMissionEventI18n (多言語テキスト)
       ├─ MstMissionEventDependency (連鎖アンロック設定)
       └─ MstMissionReward (報酬内容)

MstMissionLimitedTerm (期間限定ミッション本体)
  ├─ MstMissionLimitedTermI18n (多言語テキスト)
  └─ MstMissionReward (報酬内容)

MstMissionAchievement (アチーブメントミッション本体)
  └─ MstMissionReward (報酬内容)
```

### 主要な列の意味

| 列名 | 説明 | 例 |
|------|------|-----|
| `release_key` | リリースキー（リリース識別子） | `202512020` |
| `mst_event_id` | イベントID（MstEvent.id） | `event_osh_00001` |
| `criterion_type` | 達成条件タイプ | `StageClearCount`, `SpecificGachaDrawCount` |
| `criterion_value` | 達成条件値（対象を特定） | `gasho_001`, `chara_osh_00601` |
| `criterion_count` | 達成条件回数 | `5`, `10`, `100` |
| `mst_mission_reward_group_id` | 報酬グループID（MstMissionReward.group_id） | `osh_00001_event_reward_1` |
| `sort_order` | 表示順 | `1`, `2`, `3` |
| `destination_scene` | 遷移先シーン | `Event`, `Gacha`, `QuestSelect` |

---

## 手順1: イベントログインボーナス（イベントログボ）の作成

### 1-1. MstMissionEventDailyBonusSchedule.csv の作成

**役割**: イベントログインボーナスの期間設定

**必要な情報**:
- イベントID（mst_event_id）
- ログボ開始日時（start_at）
- ログボ終了日時（end_at）

**CSV形式**:
```csv
ENABLE,id,release_key,mst_event_id,start_at,end_at
e,event_osh_00001_daily_bonus,202512020,event_osh_00001,"2026-01-01 00:00:00","2026-01-16 03:59:59"
```

**作成時の注意点**:
- `id`は`{イベントID}_daily_bonus`の形式を推奨
- 日時は"YYYY-MM-DD HH:MM:SS"形式で、ダブルクォートで囲む
- イベント期間とログボ期間は異なる場合がある

---

### 1-2. MstMissionEventDailyBonus.csv の作成

**役割**: イベントログインボーナス各日の報酬設定

**必要な情報**:
- ログインボーナススケジュールID（mst_mission_event_daily_bonus_schedule_id）
- ログイン日数（login_day_count）
- 報酬グループID（mst_mission_reward_group_id）

**CSV形式**:
```csv
ENABLE,id,release_key,mst_mission_event_daily_bonus_schedule_id,login_day_count,mst_mission_reward_group_id,sort_order,備考
e,event_osh_00001_daily_bonus_01,202512020,event_osh_00001_daily_bonus,1,event_osh_00001_daily_bonus_01,1,【推しの子】SSR確定ガシャ
e,event_osh_00001_daily_bonus_02,202512020,event_osh_00001_daily_bonus,2,event_osh_00001_daily_bonus_02,1,プリズム
```

**作成時の注意点**:
- `id`は`{スケジュールID}_{日数ゼロ埋め2桁}`の形式を推奨
- `login_day_count`は1から開始
- `mst_mission_reward_group_id`は後で作成するMstMissionRewardのgroup_idと対応
- `備考`列は任意だが、報酬内容を記載すると管理しやすい

---

### 1-3. ログボ報酬の MstMissionReward.csv への追加

**役割**: ログインボーナスの報酬内容定義

**CSV形式**:
```csv
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_441,202512020,event_osh_00001_daily_bonus_01,Item,ticket_osh_10000,1,1,【推しの子】SSR確定ガシャ
e,mission_reward_442,202512020,event_osh_00001_daily_bonus_02,FreeDiamond,,150,1,プリズム
e,mission_reward_443,202512020,event_osh_00001_daily_bonus_03,Item,item_glo_00001,200,1,いいジャンメダル【赤】
```

**resource_typeの種類**:
- `Exp`: 経験値
- `Coin`: コイン
- `FreeDiamond`: 無償プリズム
- `Item`: アイテム（resource_idにアイテムIDを指定）
- `Emblem`: エンブレム（resource_idにエンブレムIDを指定）
- `Unit`: ユニット（resource_idにユニットIDを指定）

**作成時の注意点**:
- `group_id`は`MstMissionEventDailyBonus.mst_mission_reward_group_id`と一致させる
- `resource_id`は`resource_type`が`FreeDiamond`/`Coin`/`Exp`の場合は空（または`__NULL__`）
- `備考`列で報酬内容を日本語で記載すると管理しやすい

---

## 手順2: イベントミッションの作成

### 2-1. MstMissionEvent.csv の作成

**役割**: イベントミッション本体の設定

**必要な情報**:
- イベントID（mst_event_id）
- 達成条件タイプ（criterion_type）
- 達成条件値（criterion_value）
- 達成条件回数（criterion_count）
- 開放条件（unlock_criterion_type, unlock_criterion_value, unlock_criterion_count）
- 報酬グループID（mst_mission_reward_group_id）
- 遷移先シーン（destination_scene）

**CSV形式**:
```csv
ENABLE,id,release_key,mst_event_id,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene
e,event_osh_00001_1,202512020,event_osh_00001,StageClearCount,,5,__NULL__,,0,,osh_00001_event_reward_1,1,Event
e,event_osh_00001_28,202512020,event_osh_00001,SpecificGachaDrawCount,gasho_001,10,__NULL__,,0,,osh_00001_event_reward_28,28,Gacha
e,event_osh_00001_33,202512020,event_osh_00001,SpecificUnitStageClearCount,chara_osh_00601.event_osh1_1day_00001,1,__NULL__,,0,,osh_00001_event_reward_33,33,Event
```

**主要なcriterion_type**:
- `StageClearCount`: ステージクリア回数
- `SpecificStageClearCount`: 特定ステージクリア回数（criterion_valueにステージIDを指定）
- `SpecificGachaDrawCount`: 特定ガシャ引いた回数（criterion_valueにガシャIDを指定）
- `SpecificUnitStageClearCount`: 特定ユニット編成でステージクリア回数（criterion_valueに`ユニットID.ステージID`を指定）
- `SpecificUnitStageChallengeCount`: 特定ユニット編成でステージ挑戦回数
- `SpecificQuestClear`: 特定クエストクリア（criterion_valueにクエストIDを指定）
- `AdventBattleChallengeCount`: 降臨バトル挑戦回数

**destination_sceneの種類**:
- `Event`: イベント画面
- `Gacha`: ガシャ画面
- `QuestSelect`: クエスト選択画面
- `AdventBattle`: 降臨バトル画面

**作成時の注意点**:
- `criterion_value`が不要な場合は空欄（または明示的に空）
- `unlock_criterion_type`が不要な場合は`__NULL__`を指定し、`unlock_criterion_count`は`0`
- `group_key`は任意（集計やグルーピングに使用）
- `id`の命名規則: `{イベントID}_{連番}`

---

### 2-2. MstMissionEventI18n.csv の作成

**役割**: イベントミッションの説明文（多言語対応）

**CSV形式**:
```csv
ENABLE,release_key,id,mst_mission_event_id,language,description
e,202512020,event_osh_00001_1_ja,event_osh_00001_1,ja,ステージを5回クリアしよう
e,202512020,event_osh_00001_28_ja,event_osh_00001_28,ja,賀正ガシャ2026を10回引こう
e,202512020,event_osh_00001_33_ja,event_osh_00001_33,ja,【汗が輝いてるよ!】ぴえヨンを編成に入れて「ファンと推し合戦！」を1回クリア
```

**作成時の注意点**:
- `id`は`{mst_mission_event_id}_{言語コード}`の形式を推奨
- `mst_mission_event_id`は`MstMissionEvent.id`と完全一致させる
- `language`は現在`ja`のみ
- `description`はゲーム内に表示されるミッション説明文

---

### 2-3. MstMissionEventDependency.csv の作成（連鎖ミッションの場合）

**役割**: ミッション同士の連鎖アンロック設定

**CSV形式**:
```csv
ENABLE,id,release_key,group_id,mst_mission_event_id,unlock_order,備考
e,190,202512020,event_osh_00001_1,event_osh_00001_1,1,
e,191,202512020,event_osh_00001_1,event_osh_00001_2,2,
e,192,202512020,event_osh_00001_1,event_osh_00001_3,3,
```

**作成時の注意点**:
- `group_id`で連鎖するミッショングループを定義
- `unlock_order`は1から開始し、前の番号のミッションをクリアすると次が開放される
- 同じ`group_id`内で`unlock_order`が重複してはいけない
- 同じ`group_id`内で`mst_mission_event_id`が重複してはいけない

---

### 2-4. イベントミッション報酬の MstMissionReward.csv への追加

**CSV形式**:
```csv
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_531,202512020,osh_00001_event_reward_1,Item,ticket_glo_10001,2,1,推しの子ミッション(賀正チケット)
e,mission_reward_535,202512020,osh_00001_event_reward_5,FreeDiamond,,50,1,推しの子ミッション(賀正チケット)
e,mission_reward_564,202512020,osh_00001_event_reward_34,Coin,,1000,1,ぴえヨン連れて行こうミッション
e,mission_reward_571,202512020,osh_00001_event_reward_41,Emblem,emblem_event_osh_00008,1,1,ぴえヨン連れて行こうミッション
```

**作成時の注意点**:
- `group_id`は`MstMissionEvent.mst_mission_reward_group_id`と一致させる

---

## 手順3: 期間限定ミッションの作成

### 3-1. MstMissionLimitedTerm.csv の作成

**役割**: 期間限定ミッション本体の設定

**必要な情報**:
- 進捗グループキー（progress_group_key）
- 達成条件（criterion_type, criterion_value, criterion_count）
- ミッションカテゴリー（mission_category）
- 報酬グループID（mst_mission_reward_group_id）
- 開始・終了日時（start_at, end_at）

**CSV形式**:
```csv
ENABLE,id,release_key,progress_group_key,criterion_type,criterion_value,criterion_count,mission_category,mst_mission_reward_group_id,sort_order,destination_scene,start_at,end_at
e,limited_term_33,202512020,group9,AdventBattleChallengeCount,,5,AdventBattle,osh_00001_limited_term_1,1,AdventBattle,"2026-01-09 15:00:00","2026-01-13 14:59:59"
e,limited_term_34,202512020,group9,AdventBattleChallengeCount,,10,AdventBattle,osh_00001_limited_term_2,2,AdventBattle,"2026-01-09 15:00:00","2026-01-13 14:59:59"
```

**mission_categoryの種類**:
- `AdventBattle`: 降臨バトル
- （他のカテゴリは必要に応じて追加）

**作成時の注意点**:
- `progress_group_key`は進捗を共有するミッショングループを定義
- 日時は"YYYY-MM-DD HH:MM:SS"形式で、ダブルクォートで囲む
- 期間限定ミッションは`start_at`〜`end_at`の間のみプレイヤーに表示される

---

### 3-2. MstMissionLimitedTermI18n.csv の作成

**役割**: 期間限定ミッションの説明文（多言語対応）

**CSV形式**:
```csv
ENABLE,release_key,id,mst_mission_limited_term_id,language,description
e,202512020,limited_term_33_ja,limited_term_33,ja,降臨バトル「ファーストライブ」に5回挑戦しよう！
e,202512020,limited_term_34_ja,limited_term_34,ja,降臨バトル「ファーストライブ」に10回挑戦しよう！
```

**作成時の注意点**:
- `id`は`{mst_mission_limited_term_id}_{言語コード}`の形式を推奨
- `mst_mission_limited_term_id`は`MstMissionLimitedTerm.id`と完全一致させる

---

### 3-3. 期間限定ミッション報酬の MstMissionReward.csv への追加

**CSV形式**:
```csv
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_527,202512020,osh_00001_limited_term_1,Coin,,2000,1,降臨バトル「ファーストライブ」に5回挑戦しよう！
e,mission_reward_528,202512020,osh_00001_limited_term_2,FreeDiamond,,20,1,降臨バトル「ファーストライブ」に10回挑戦しよう！
```

---

## 手順4: アチーブメントミッションの作成

### 4-1. MstMissionAchievement.csv の作成

**役割**: アチーブメントミッション本体の設定

**CSV形式**:
```csv
ENABLE,id,release_key,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene
e,achievement_2_101,202512020,SpecificQuestClear,quest_main_osh_normal_17,1,__NULL__,,0,,achievement_2_101,101,QuestSelect
e,achievement_2_102,202512020,SpecificQuestClear,quest_main_osh_hard_17,1,__NULL__,,0,,achievement_2_102,102,QuestSelect
```

**作成時の注意点**:
- イベントミッションと同じ達成条件タイプ（criterion_type）を使用可能
- アチーブメントミッションは期限なし（永続的）

---

### 4-2. アチーブメント報酬の MstMissionReward.csv への追加

**CSV形式**:
```csv
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_460,202512020,achievement_2_101,FreeDiamond,,50,1,アチーブメントミッション
e,mission_reward_461,202512020,achievement_2_102,FreeDiamond,,50,1,アチーブメントミッション
```

---

## 手順5: 最終チェックリスト

### 5-1. IDの一意性チェック

各テーブルで`id`が重複していないか確認する:
- MstMissionEvent.id
- MstMissionEventI18n.id
- MstMissionEventDependency.id
- MstMissionEventDailyBonus.id
- MstMissionEventDailyBonusSchedule.id
- MstMissionReward.id
- MstMissionLimitedTerm.id
- MstMissionLimitedTermI18n.id
- MstMissionAchievement.id

### 5-2. 参照整合性チェック

以下の関連付けが正しいか確認する:

| 参照元 | 参照元カラム | 参照先 | 参照先カラム |
|--------|-------------|--------|------------|
| MstMissionEventI18n | mst_mission_event_id | MstMissionEvent | id |
| MstMissionEventDependency | mst_mission_event_id | MstMissionEvent | id |
| MstMissionEventDailyBonus | mst_mission_event_daily_bonus_schedule_id | MstMissionEventDailyBonusSchedule | id |
| MstMissionEventDailyBonusSchedule | mst_event_id | MstEvent | id |
| MstMissionEvent | mst_event_id | MstEvent | id |
| MstMissionEvent | mst_mission_reward_group_id | MstMissionReward | group_id |
| MstMissionEventDailyBonus | mst_mission_reward_group_id | MstMissionReward | group_id |
| MstMissionLimitedTerm | mst_mission_reward_group_id | MstMissionReward | group_id |
| MstMissionLimitedTermI18n | mst_mission_limited_term_id | MstMissionLimitedTerm | id |
| MstMissionAchievement | mst_mission_reward_group_id | MstMissionReward | group_id |

### 5-3. データ内容チェック

- [ ] release_keyが全て統一されているか
- [ ] 日時フォーマットが正しいか（"YYYY-MM-DD HH:MM:SS"）
- [ ] criterion_typeに対応するcriterion_valueが正しく設定されているか
- [ ] 報酬のresource_typeとresource_idの組み合わせが正しいか
- [ ] sort_orderが適切に設定されているか（表示順）
- [ ] destination_sceneが適切なシーンを指しているか

### 5-4. 連鎖ミッションの整合性チェック（MstMissionEventDependencyを使用している場合）

- [ ] 同じgroup_id内でunlock_orderが重複していないか
- [ ] 同じgroup_id内でmst_mission_event_idが重複していないか
- [ ] unlock_orderが1から連番で設定されているか

---

## 手順6: 検証スキルによるバリデーション

作成したCSVファイルは、以下のスキルで検証することを推奨します:

```bash
claude skill masterdata-csv-validator
```

このスキルは以下をチェックします:
- DBスキーマとの整合性
- 参照整合性
- データ型の妥当性
- 必須カラムの存在
- enum値の妥当性

---

## トラブルシューティング

### Q1: criterion_valueに何を入れるべきかわからない

A: criterion_typeによって異なります:
- `StageClearCount`: 不要（空）
- `SpecificStageClearCount`: ステージID（例: `event_osh1_1day_00001`）
- `SpecificGachaDrawCount`: ガシャID（例: `gasho_001`）
- `SpecificUnitStageClearCount`: `ユニットID.ステージID`（例: `chara_osh_00601.event_osh1_1day_00001`）
- `SpecificQuestClear`: クエストID（例: `quest_event_osh1_charaget01`）

### Q2: __NULL__ とは何か

A: データベースで明示的にNULLを設定するためのマーカーです。CSVでは空欄とNULLを区別するために使用します。

### Q3: 報酬グループIDの命名規則は？

A: 統一された命名規則はありませんが、以下の形式を推奨します:
- イベントミッション: `{イベント識別子}_event_reward_{連番}`
- ログインボーナス: `{イベント識別子}_daily_bonus_{ゼロ埋め2桁}`
- 期間限定ミッション: `{イベント識別子}_limited_term_{連番}`
- アチーブメント: `achievement_{分類番号}_{連番}`

### Q4: 複数の報酬を1つのミッションに設定したい

A: 同じ`group_id`を持つ複数の`MstMissionReward`レコードを作成します。`sort_order`で報酬の表示順を制御できます。

---

## 参考資料

- DBスキーマ: `projects/glow-server/api/database/schema/exports/master_tables_schema.json`
- 実データ例: `マスタデータ/リリース/202512020/tables/*.csv`
- マスタデータ検証スキル: `.claude/skills/masterdata-csv-validator/`

---

## 改訂履歴

| 日付 | 版 | 変更内容 |
|------|---|---------|
| 2026-01-16 | 1.0 | 初版作成（202512020リリースキーのデータを元に作成） |
