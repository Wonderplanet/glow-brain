# イベントミッション マスタデータ設定手順書

## 概要

イベントミッションのマスタデータ作成手順を記載します。
本手順書に従うことで、ゲーム内でエラーが発生しない正確なマスタデータを作成できます。

## 対象テーブル

イベントミッションでは、以下の3シート構成でマスタデータを作成します。

**出力シート**:
- **MstMissionEvent** - イベントミッションの基本情報(MstMissionEventI18nのカラムを含む)
- **MstMissionEventDependency** - ミッション間の解放順序
- **MstMissionReward** - ミッション報酬

**重要**: MstMissionEventI18nは独立したシートではなく、MstMissionEventシート内に統合されています。

## 参照ドキュメント

- [criterion_type設定ルール](./criterion_type設定ルール.md)
- [destination_scene設定ルール](./destination_scene設定ルール.md)
- [resource_type設定ルール](./resource_type設定ルール.md)

## 作成フロー

### 1. 仕様書の確認

運営仕様書から以下の情報を抽出します。

**必要情報**:
- 対象イベントID（mst_event_id）
- ミッションの達成条件（何を何回実行するか）
- ミッションの解放条件（前提ミッション）
- ミッションの報酬内容
- ミッションの表示順序
- ミッション説明文（日本語）

**参考**: `specs/正月特別号！【推しの子】 いいジャン祭＋メインクエスト_仕様書 - 04_ミッション.csv`

### 2. データ構造の確認

出力するデータ形式のヘッダーは、以下のスキーマファイルに定義されています。

- `sheet_schemas/MstMissionEvent.csv`
- `sheet_schemas/MstMissionEventDependency.csv`
- `sheet_schemas/MstMissionReward.csv`

**重要**: 列の順序を必ず守ってください。順序が異なるとデータ取り込みエラーが発生します。

### 3. MstMissionEvent シートの作成（I18n含む）

#### 3.1 シートスキーマ

このシートには、TABLE行、ENABLE行、データ行が含まれます。

**TABLE行** - 各カラムがどのテーブルに属するかを示します。

```
TABLE,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEventI18n
```

**ENABLE行** - カラム名を示します。

```
ENABLE,id,release_key,mst_event_id,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene,description.ja
```

#### 3.2 各カラムの設定ルール

| カラム名 | 設定ルール |
|---------|-----------|
| **ENABLE** | 固定値: `e` (有効化) |
| **id** | ミッションの一意識別子。命名規則: `event_{イベントコード}_{連番}` |
| **release_key** | リリースキー。例: `202512020` |
| **mst_event_id** | 対象イベントID。MstEventテーブルのidと対応。例: `event_osh_00001` |
| **criterion_type** | 達成条件タイプ。[criterion_type設定ルール](./criterion_type設定ルール.md)を参照 |
| **criterion_value** | 条件の指定値。ステージID、ガシャIDなど。不要な場合は空欄 |
| **criterion_count** | 条件の回数。例: `5`（5回クリア） |
| **unlock_criterion_type** | 解放条件タイプ。通常は`__NULL__`（解放条件なし） |
| **unlock_criterion_value** | 解放条件の指定値。通常は空欄 |
| **unlock_criterion_count** | 解放条件の回数。通常は`0` |
| **group_key** | ミッショングループキー。通常は空欄 |
| **mst_mission_reward_group_id** | 報酬グループID。MstMissionRewardのgroup_idと対応 |
| **sort_order** | 表示順序。小さい数字ほど上位に表示。例: `1`, `2`, `3`... |
| **destination_scene** | タップ時の遷移先シーン。[destination_scene設定ルール](./destination_scene設定ルール.md)を参照 |
| **description.ja** | ミッション説明文（日本語）。※この行はTABLE行でMstMissionEventI18nに対応 |

#### 3.3 イベントミッション固有の設定

イベントミッションでは、以下のように設定します。

- **mst_event_id**: 必須。対象イベントのIDを指定
- **criterion_type**: イベント内容に応じて適切な値を選択
  - `StageClearCount`: ステージクリア回数
  - `SpecificStageClearCount`: 特定ステージのクリア回数
  - `SpecificGachaDrawCount`: 特定ガシャの引き回数
  - `SpecificUnitStageClearCount`: 特定ユニット編成でのクリア
  - `SpecificQuestClear`: 特定クエストのクリア
- **unlock_criterion_type**: 解放条件がない場合は`__NULL__`
- **destination_scene**: イベントの場合は通常`Event`、ガシャミッションは`Gacha`

#### 3.4 作成例

```csv
TABLE,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEventI18n
ENABLE,id,release_key,mst_event_id,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene,description.ja
e,event_osh_00001_1,202512020,event_osh_00001,StageClearCount,,5,__NULL__,,0,,osh_00001_event_reward_1,1,Event,ステージを5回クリアしよう
e,event_osh_00001_2,202512020,event_osh_00001,StageClearCount,,10,__NULL__,,0,,osh_00001_event_reward_2,2,Event,ステージを10回クリアしよう
e,event_osh_00001_28,202512020,event_osh_00001,SpecificGachaDrawCount,gasho_001,10,__NULL__,,0,,osh_00001_event_reward_28,28,Gacha,賀正ガシャ2026を10回引こう
```

#### 3.5 説明文作成のポイント

- 達成条件を明確に記載する（例: 「5回クリア」「10回引こう」）
- ユーザーフレンドリーな表現にする
- 文末は「〜しよう」形式が推奨
- 特定のステージやガシャがある場合は名称を明記

### 4. MstMissionEventDependency シートの作成

#### 4.1 シートスキーマ

このシートは、ミッション間の解放順序を管理します。

**TABLE行**:

```
TABLE,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency
```

**ENABLE行**:

```
ENABLE,id,release_key,group_id,mst_mission_event_id,unlock_order,備考
```

#### 4.2 各カラムの設定ルール

| カラム名 | 設定ルール |
|---------|-----------|
| **ENABLE** | 固定値: `e` (有効化) |
| **id** | 依存関係レコードの一意識別子。連番で管理。例: `190`, `191`, `192`... |
| **release_key** | リリースキー。MstMissionEventと同じ値 |
| **group_id** | 依存グループID。同じgroup_idのミッションは順次解放される |
| **mst_mission_event_id** | 対象ミッションID。MstMissionEvent.idと対応 |
| **unlock_order** | 解放順序。1から始まる連番 |
| **備考** | 任意のメモ。空欄でも可 |

#### 4.3 依存関係の設計パターン

イベントミッションでは、以下のようなパターンで依存関係を設計します。

**パターン1: 順次解放型**
```csv
ENABLE,id,release_key,group_id,mst_mission_event_id,unlock_order,備考
e,190,202512020,event_osh_00001_1,event_osh_00001_1,1,
e,191,202512020,event_osh_00001_1,event_osh_00001_2,2,
e,192,202512020,event_osh_00001_1,event_osh_00001_3,3,
```

**説明**: ミッション1をクリアするとミッション2が解放、ミッション2をクリアするとミッション3が解放

**パターン2: 独立グループ**
```csv
ENABLE,id,release_key,group_id,mst_mission_event_id,unlock_order,備考
e,217,202512020,event_osh_00001_28,event_osh_00001_28,1,
e,218,202512020,event_osh_00001_28,event_osh_00001_29,2,
e,219,202512020,event_osh_00001_28,event_osh_00001_30,3,
```

**説明**: 別のミッショングループ（ガシャミッションなど）として独立して管理

#### 4.4 作成例

```csv
TABLE,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency
ENABLE,id,release_key,group_id,mst_mission_event_id,unlock_order,備考
e,190,202512020,event_osh_00001_1,event_osh_00001_1,1,
e,191,202512020,event_osh_00001_1,event_osh_00001_2,2,
e,192,202512020,event_osh_00001_1,event_osh_00001_3,3,
e,193,202512020,event_osh_00001_1,event_osh_00001_4,4,
```

### 5. MstMissionReward シートの作成

#### 5.1 シートスキーマ

このシートには、TABLE行、ENABLE行、データ行が含まれます。

**TABLE行**:

```
TABLE,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward
```

**ENABLE行**:

```
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
```

#### 5.2 各カラムの設定ルール

| カラム名 | 設定ルール |
|---------|-----------|
| **ENABLE** | 固定値: `e` (有効化) |
| **id** | 報酬の一意識別子。命名規則: `mission_reward_{連番}` |
| **release_key** | リリースキー。MstMissionEventと同じ値 |
| **group_id** | 報酬グループID。MstMissionEvent.mst_mission_reward_group_idと対応 |
| **resource_type** | 報酬のリソースタイプ。[resource_type設定ルール](./resource_type設定ルール.md)を参照 |
| **resource_id** | リソースID。resource_typeに応じて設定。不要な場合は空欄 |
| **resource_amount** | 報酬の数量 |
| **sort_order** | 表示順序。複数報酬がある場合の並び順 |
| **備考** | 任意のメモ。ミッション説明文などを記載すると管理しやすい |

#### 5.3 イベントミッション報酬の典型的なパターン

イベントミッションでは、以下のような報酬が一般的です。

- **Item** - ガシャチケット報酬（ticket_glo_10001など）
- **FreeDiamond** - 無償プリズム報酬
- **Coin** - コイン報酬
- **Emblem** - エンブレム報酬（イベント限定称号など）

#### 5.4 作成例

```csv
TABLE,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_531,202512020,osh_00001_event_reward_1,Item,ticket_glo_10001,2,1,ステージを5回クリアしよう
e,mission_reward_532,202512020,osh_00001_event_reward_2,Item,ticket_glo_10001,3,1,ステージを10回クリアしよう
e,mission_reward_535,202512020,osh_00001_event_reward_5,FreeDiamond,,50,1,ステージを30回クリアしよう
e,mission_reward_562,202512020,osh_00001_event_reward_32,FreeDiamond,,200,1,賀正ガシャ2026を50回引こう
e,mission_reward_571,202512020,osh_00001_event_reward_41,Emblem,emblem_event_osh_00008,1,1,特別な達成報酬
```

### 6. データ整合性のチェック

マスタデータ作成後、以下の項目を確認してください。

#### 6.1 必須チェック項目

- [ ] **ヘッダーの列順が正しいか**
  - スキーマファイルと完全一致している

- [ ] **IDの一意性**
  - すべてのidが一意である
  - 他のリリースのidと重複していない

- [ ] **リレーションの整合性**
  - `MstMissionEvent.mst_mission_reward_group_id` = `MstMissionReward.group_id`
  - `MstMissionEvent.id` = `MstMissionEventI18n.mst_mission_event_id`
  - `MstMissionEvent.id` = `MstMissionEventDependency.mst_mission_event_id`
  - すべてのミッションにI18nレコードが存在する

- [ ] **mst_event_idの正確性**
  - MstEventテーブルに存在するIDである
  - イベントの期間とミッションの期間が整合している

- [ ] **criterion_typeの正確性**
  - [criterion_type設定ルール](./criterion_type設定ルール.md)に従っている
  - イベントミッションで使用可能なタイプである

- [ ] **destination_sceneの正確性**
  - [destination_scene設定ルール](./destination_scene設定ルール.md)に従っている

- [ ] **resource_typeの正確性**
  - [resource_type設定ルール](./resource_type設定ルール.md)に従っている
  - resource_idの設定有無が正しい

- [ ] **unlock_criterion設定の整合性**
  - unlock_criterion_typeが`__NULL__`の場合、unlock_criterion_valueは空欄、unlock_criterion_countは`0`
  - 解放条件がある場合、正しく設定されている

- [ ] **依存関係の整合性**
  - unlock_orderが1から始まる連番である
  - 同じgroup_idのミッションが適切に順序付けられている

#### 6.2 推奨チェック項目

- [ ] **命名規則の統一**
  - idのプレフィックスが統一されている（`event_{イベントコード}_`）

- [ ] **報酬バランス**
  - 達成難易度に応じた報酬量である

- [ ] **説明文の品質**
  - 誤字脱字がない
  - ユーザーが理解しやすい表現である
  - イベント名や固有名詞が正しい

- [ ] **依存グループの設計**
  - ミッションの種類ごとに適切にグループ分けされている

### 7. 出力フォーマット

最終的な出力は以下の3シート構成で行います。

#### 7.1 MstMissionEvent シート

**CSV形式**:

```csv
TABLE,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEventI18n
ENABLE,id,release_key,mst_event_id,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene,description.ja
e,event_osh_00001_1,202512020,event_osh_00001,StageClearCount,,5,__NULL__,,0,,osh_00001_event_reward_1,1,Event,ステージを5回クリアしよう
```

**注意**: description.jaカラムはTABLE行でMstMissionEventI18nと表記されますが、データは統合されて出力されます。

#### 7.2 MstMissionEventDependency シート

**CSV形式**:

```csv
TABLE,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency,MstMissionEventDependency
ENABLE,id,release_key,group_id,mst_mission_event_id,unlock_order,備考
e,190,202512020,event_osh_00001_1,event_osh_00001_1,1,
```

#### 7.3 MstMissionReward シート

**CSV形式**:

```csv
TABLE,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward,MstMissionReward
ENABLE,id,release_key,group_id,resource_type,resource_id,resource_amount,sort_order,備考
e,mission_reward_531,202512020,osh_00001_event_reward_1,Item,ticket_glo_10001,2,1,ステージを5回クリアしよう
```

#### 7.4 重要なポイント

- **TABLE行は必須**: 各シートの先頭にTABLE行を含める
- **3シート構成**: MstMissionEvent, MstMissionEventDependency, MstMissionRewardの3シート
- **依存関係の管理**: MstMissionEventDependencyでミッション解放順序を制御

## トラブルシューティング

### よくあるエラー

#### エラー1: mst_event_idが不正

**症状**: データ投入時にエラーが発生する

**原因**: MstEventテーブルに存在しないイベントIDを設定している

**対処**: MstEventテーブルを確認し、正しいイベントIDに修正する

#### エラー2: 依存関係の循環参照

**症状**: ミッションが解放されない

**原因**: MstMissionEventDependencyで循環参照が発生している

**対処**: 依存関係グラフを確認し、unlock_orderを正しく設定する

#### エラー3: リレーションの不整合

**症状**: ミッション達成時に報酬が付与されない

**原因**: `MstMissionEvent.mst_mission_reward_group_id`に対応する`MstMissionReward.group_id`が存在しない

**対処**: IDの対応関係を再確認し、修正する

## 参考データ

### 実際の作成例

`released/`ディレクトリに実際のマスタデータ例があります。

- `released/MstMissionEvent.csv` - イベントミッション基本情報
- `released/MstMissionEventDependency.csv` - ミッション依存関係
- `released/MstMissionReward.csv` - ミッション報酬

新規作成時は、これらのファイルを参考にしてください。

## 補足情報

### mst_event_idについて

mst_event_idは、対象イベントを特定するためのキーです。

形式: `event_{作品コード}_{連番}`

例:
- `event_osh_00001` - 推しの子イベント第1弾
- `event_glo_00001` - GLOWオリジナルイベント第1弾

### group_keyについて

group_keyは、ミッショングループを識別するためのキーです。
通常は空欄で問題ありませんが、特定のグループ管理が必要な場合に使用します。

### unlock_criterion_typeについて

ミッション解放条件を設定するためのカラムです。

- **__NULL__**: 解放条件なし（デフォルト）
- **その他**: 特定の条件を満たした場合のみ解放

通常のイベントミッションでは`__NULL__`を設定し、MstMissionEventDependencyで解放順序を管理します。

### sort_orderについて

ゲーム内での表示順序を制御します。
小さい数字ほど上位に表示されます。

推奨: 1から始めて、1ずつ増やす（1, 2, 3, 4...）

## 更新履歴

- 2026-01-17: 初版作成
