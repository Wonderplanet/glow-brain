# 運営仕様マスタデータ作成ガイド

## 概要

このガイドは、運営仕様からマスタデータCSVを作成する際の手順と注意点を示します。

## 前提条件

- 運営仕様が `マスタデータ/運営仕様/<運営仕様名>/要件/` に配置されている
- マスタデータの出力先は運営仕様ディレクトリ直下（`マスタデータ/運営仕様/<運営仕様名>/`）
- **CSVテンプレート部分の変更は厳禁**
  - 必ず `projects/glow-masterdata/sheet_schema/` からテンプレートをコピーして使用
  - ヘッダーの列順・列名は一切変更しない
  - データ投入シートへの入力に使用するため、列のずれは許されない

## 作成手順

### 1. 仕様書の分析

運営仕様を読み、必要なマスタデータテーブルをリストアップします。

### 2. テーブル構造の確認

必要なテーブルのスキーマを確認します。

```bash
# DBテーブルスキーマの確認
jq '.databases.mst.tables.<テーブル名>' projects/glow-server/api/database/schema/exports/master_tables_schema.json
```

### 3. テンプレートCSVの取得

`projects/glow-masterdata/sheet_schema/` から対応するテンプレートCSVをコピーします。

**重要な注意点:**
- **テンプレートCSVが最優先**であり、必ずこの形式でマスタデータを作成する
- テンプレートとDBスキーマが一致しない場合でも、**テンプレートCSVに従う**
- DBスキーマは、入力データのバリデーション（入力不可データのチェック等）に使用する
- テンプレートが存在しない場合のみ、DBスキーマを参考にマスタデータ作成を試みる（基本的にこのケースはない）

### 4. 既存データの参照

`projects/glow-masterdata/` 直下にある過去の同種マスタデータCSVを参照し、データの作り方や値の傾向を把握します。

#### 4-2. 報酬設定時の既存リソース確認

**重要**: 報酬として設定するキャラクター、アイテム、通貨などのリソースは、以下の手順で存在を確認してください。

##### リソース検索の手順

**Step 1: 01_概要ファイルを確認**

まず、運営仕様の概要ファイルに新リソース情報が記載されているか確認します。

```bash
# 01_概要ファイルを確認
cat "マスタデータ/運営仕様/${運営仕様名}/要件/${運営仕様名}_仕様書_01_概要.csv"
```

**Step 2: 報酬一覧ファイルを確認（存在する場合）**

報酬一覧ファイルがある場合は、そこにリソース情報がまとまっている可能性があります。

```bash
# 報酬一覧ファイルを確認
cat "マスタデータ/運営仕様/${運営仕様名}/要件/${運営仕様名}_仕様書_05_報酬一覧.csv"
```

**Step 3: 他の要件CSVファイルを検索**

概要ファイルに記載がない場合、運営仕様ディレクトリ内の全要件CSVを検索します。

```bash
# 運営仕様ディレクトリ内の全要件CSVからキャラクターIDを検索
grep -r "chara_xxxxx" "マスタデータ/運営仕様/${運営仕様名}/要件/"

# 特定のキャラクターIDが他のシートに記載されているか確認
grep "chara_100kano_00001" "マスタデータ/運営仕様/${運営仕様名}/要件/"*.csv
```

**Step 4: 既存マスタデータを検索**

運営仕様開始前から存在する既存リソースの場合、既存マスタデータCSVに記載があります。

```bash
# キャラクターIDの存在確認
grep "^e,chara_glo_00001," projects/glow-masterdata/MstUnit.csv

# アイテムIDの存在確認
grep "^e,piece_glo_00001," projects/glow-masterdata/MstItem.csv

# 部分一致検索（gloシリーズのキャラ全件）
grep "^e,chara_glo_" projects/glow-masterdata/MstUnit.csv
```

##### 関連テーブルの検索

リソースが見つからない場合、関連するテーブルも検索してください。

| リソース種類 | 検索対象テーブル | コマンド例 |
|------------|--------------|----------|
| キャラクター | MstUnit.csv | `grep "^e,chara_" projects/glow-masterdata/MstUnit.csv` |
| かけら | MstItem.csv | `grep "^e,piece_" projects/glow-masterdata/MstItem.csv` |
| アイテム | MstItem.csv | `grep "^e,item_" projects/glow-masterdata/MstItem.csv` |
| 敵キャラ | MstEnemyCharacter.csv | `grep "^e,enemy_" projects/glow-masterdata/MstEnemyCharacter.csv` |

##### リソースが見つからない場合

リソースが見つからない場合の対応：

1. **検索範囲を拡大**: 類似の命名パターンで検索
   ```bash
   # 「100kano」を含むIDを全検索
   grep "100kano" projects/glow-masterdata/MstUnit.csv
   ```

2. **DBスキーマで型確認**: 報酬タイプのenum値を確認
   ```bash
   jq '.databases.mst.tables.opr_gacha_prizes.columns.reward_type' \
     projects/glow-server/api/database/schema/exports/master_tables_schema.json
   ```

3. **ユーザーに確認**: どうしても見つからない場合はユーザーに報告し、指示を仰ぐ
   - リソースIDが間違っている可能性
   - 新規リソースだが要件書に記載漏れの可能性

### 5. コード調査（必要に応じて）

以下のリポジトリから関連コードを調査します。

**検索対象:**
- `projects/glow-client/` - クライアント側の実装
- `projects/glow-server/` - サーバー側のAPI実装
- `projects/glow-masterdata/` - 既存マスタデータ

**検索除外:**
- `projects/glow-server/admin/` - 今回の対応には無関係

### 6. CSVデータの作成

#### CSV形式の厳密な遵守

**必須ルール:**

1. **改行の扱い**
   - セル内で改行が必要な場合は、`\n` エスケープシーケンスを使用
   - 実際の改行文字を入れると CSV が壊れるため**絶対に禁止**
   - 例: `"説明文です\n2行目です"` ← ダブルクォートで囲み、\nで改行

2. **エスケープシーケンス**
   - タブ: `\t`
   - 改行: `\n`
   - バックスラッシュ: `\\`
   - ダブルクォート: セル内の `"` は `""` でエスケープ

3. **ダブルクォートの使用**
   - カンマ、改行、ダブルクォートを含むセルは**必ずダブルクォートで囲む**
   - 例: `"テキスト,カンマ含む"`

4. **数値フィールド**
   - 数値は基本的にダブルクォート不要
   - ただし、先頭ゼロが必要な場合はダブルクォートで囲む
   - 例: `"001"`, `100`

5. **NULL/空値の扱い**
   - NULL許可カラム: 空文字列（何も書かない）
   - NULL不可カラム: 適切なデフォルト値を設定

#### データの整合性チェック

- 外部キー制約のあるカラムは、参照先テーブルの値と整合性を保つ
- enum型のカラムは、定義された値のみを使用
- 日付時刻は ISO 8601 形式（`YYYY-MM-DD HH:MM:SS`）

### 7. 検証

作成したCSVが以下を満たすことを確認:
- [ ] CSV形式として正しい（改行やエスケープが適切）
- [ ] CSVテンプレートと列が一致する（列順・列名）
- [ ] 必須カラムが全て埋まっている
- [ ] 外部キー制約が満たされている
- [ ] 既存データとの整合性がある

## トラブルシューティング

### 改行を含むテキストデータ

**誤り:**
```csv
id,description
1,"これは
改行を含む
テキストです"
```

**正しい:**
```csv
id,description
1,"これは\n改行を含む\nテキストです"
```

### 複雑なJSON構造を含むカラム

JSON文字列をセルに格納する場合:
1. JSON全体をダブルクォートで囲む
2. JSON内のダブルクォートを `""` でエスケープ
3. または、JSON内では改行せずにワンライナーにする

例:
```csv
id,json_data
1,"{""key"": ""value"", ""array"": [1, 2, 3]}"
```

## 参考情報

### 主要なファイルパス

| パス | 用途 |
|------|------|
| `projects/glow-masterdata/sheet_schema/` | 作成するマスタデータのCSVテンプレート。ヘッダー行の列順・列名を定義。このテンプレートをコピーしてマスタデータを作成する。 |
| `projects/glow-masterdata/*.csv` | 過去に作成済みの既存マスタデータ（参考用）。テーブルごとのデータの作り方や値の傾向を把握するために参照する。 |
| `projects/glow-server/api/database/schema/exports/master_tables_schema.json` | DBスキーマ定義。入力データのバリデーション（型、NULL許可、enum値等）に使用する。 |

### よく使うjqコマンド

```bash
# 全テーブル名を取得
jq '.databases.mst.tables | keys' projects/glow-server/api/database/schema/exports/master_tables_schema.json

# 特定テーブルのカラム情報（カラム名一覧）
jq '.databases.mst.tables.mst_stages.columns | keys' projects/glow-server/api/database/schema/exports/master_tables_schema.json

# 特定カラムの詳細
jq '.databases.mst.tables.opr_gachas_i18n.columns.opr_gacha_id' projects/glow-server/api/database/schema/exports/master_tables_schema.json
```

## チェックリスト

マスタデータ作成完了前に確認:

- [ ] 仕様書の要件を全て満たしている
- [ ] DBスキーマに準拠している
- [ ] CSV形式が正しい（改行エスケープ等）
- [ ] 外部キー制約が満たされている
- [ ] 既存データと整合性がある
- [ ] ファイル名が正しい（`<テーブル名>.csv`）
- [ ] 出力先ディレクトリが正しい
