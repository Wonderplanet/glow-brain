# 施策マスタデータ作成ガイド

## 概要

このガイドは、施策仕様書からマスタデータCSVを作成する際の手順と注意点を示します。

## 前提条件

- 施策仕様書が `マスタデータ/施策/<施策名>/要件/` に配置されている
- マスタデータの出力先は施策ディレクトリ直下（`マスタデータ/施策/<施策名>/`）

## 作成手順

### 1. 仕様書の分析

施策仕様書を読み、必要なマスタデータテーブルをリストアップします。

### 2. テーブル構造の確認

必要なテーブルのスキーマを確認します。

```bash
# DBテーブルスキーマの確認
jq '.databases.mst.tables.<テーブル名>' projects/glow-server/api/database/schema/exports/master_tables_schema.json
```

### 3. テンプレートCSVの取得

`projects/glow-masterdata/sheet_schema/` から対応するテンプレートCSVをコピーします。

**重要な注意点:**
- テンプレートが存在しないテーブルもあり得る
- テンプレートとDBスキーマが一致しない場合は、**DBスキーマを優先**する
- テンプレートはあくまで参考として扱う

### 4. 既存データの参照

`projects/glow-masterdata/` 直下にある過去の同種マスタデータCSVを参照し、データの作り方や値の傾向を把握します。

### 5. コード調査（必要に応じて）

以下のリポジトリから関連コードを調査します。

**検索対象:**
- `projects/glow-client/` - クライアント側の実装
- `projects/glow-server/` - サーバー側のAPI実装
- `projects/glow-masterdata/` - 既存マスタデータ

**検索除外:**
- `projects/glow-server/admin/` - 今回の対応には無関係

### 6. CSVデータの作成

#### CSV形式の厳密な遵守

**必須ルール:**

1. **改行の扱い**
   - セル内で改行が必要な場合は、`\n` エスケープシーケンスを使用
   - 実際の改行文字を入れると CSV が壊れるため**絶対に禁止**
   - 例: `"説明文です\n2行目です"` ← ダブルクォートで囲み、\nで改行

2. **エスケープシーケンス**
   - タブ: `\t`
   - 改行: `\n`
   - バックスラッシュ: `\\`
   - ダブルクォート: セル内の `"` は `""` でエスケープ

3. **ダブルクォートの使用**
   - カンマ、改行、ダブルクォートを含むセルは**必ずダブルクォートで囲む**
   - 例: `"テキスト,カンマ含む"`

4. **数値フィールド**
   - 数値は基本的にダブルクォート不要
   - ただし、先頭ゼロが必要な場合はダブルクォートで囲む
   - 例: `"001"`, `100`

5. **NULL/空値の扱い**
   - NULL許可カラム: 空文字列（何も書かない）
   - NULL不可カラム: 適切なデフォルト値を設定

#### データの整合性チェック

- 外部キー制約のあるカラムは、参照先テーブルの値と整合性を保つ
- enum型のカラムは、定義された値のみを使用
- 日付時刻は ISO 8601 形式（`YYYY-MM-DD HH:MM:SS`）

### 7. 検証

作成したCSVが以下を満たすことを確認:
- [ ] CSV形式として正しい（改行やエスケープが適切）
- [ ] DBスキーマと列が一致する
- [ ] 必須カラムが全て埋まっている
- [ ] 外部キー制約が満たされている
- [ ] 既存データとの整合性がある

## トラブルシューティング

### テンプレートとスキーマが一致しない

**対処法:** DBスキーマ（`master_tables_schema.json`）を正として、テンプレートを無視して作成する。

### 改行を含むテキストデータ

**誤り:**
```csv
id,description
1,"これは
改行を含む
テキストです"
```

**正しい:**
```csv
id,description
1,"これは\n改行を含む\nテキストです"
```

### 複雑なJSON構造を含むカラム

JSON文字列をセルに格納する場合:
1. JSON全体をダブルクォートで囲む
2. JSON内のダブルクォートを `""` でエスケープ
3. または、JSON内では改行せずにワンライナーにする

例:
```csv
id,json_data
1,"{""key"": ""value"", ""array"": [1, 2, 3]}"
```

## 参考情報

### 主要なファイルパス

| パス | 用途 |
|------|------|
| `projects/glow-masterdata/sheet_schema/` | CSVテンプレート |
| `projects/glow-masterdata/*.csv` | 既存マスタデータ（参考用） |
| `projects/glow-server/api/database/schema/exports/master_tables_schema.json` | DBスキーマ定義 |

### よく使うjqコマンド

```bash
# 全テーブル名を取得
jq '.databases.mst.tables | keys' projects/glow-server/api/database/schema/exports/master_tables_schema.json

# 特定テーブルのカラム情報
jq '.databases.mst.tables.mst_stages.columns' projects/glow-server/api/database/schema/exports/master_tables_schema.json

# 特定カラムの詳細
jq '.databases.mst.tables.opr_gachas_i18n.columns[] | select(.name == "opr_gacha_id")' projects/glow-server/api/database/schema/exports/master_tables_schema.json
```

## チェックリスト

マスタデータ作成完了前に確認:

- [ ] 仕様書の要件を全て満たしている
- [ ] DBスキーマに準拠している
- [ ] CSV形式が正しい（改行エスケープ等）
- [ ] 外部キー制約が満たされている
- [ ] 既存データと整合性がある
- [ ] ファイル名が正しい（`<テーブル名>.csv`）
- [ ] 出力先ディレクトリが正しい
