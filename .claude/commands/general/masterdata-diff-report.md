---
description: マスタデータ差分レポート生成
argument-hint: <生成データディレクトリ> <正解データディレクトリ>
---

# マスタデータ差分レポート生成

Claude作成マスタデータと正解データを比較し、差分レポートを生成します。

## 引数

- `<生成データディレクトリ>`: Claude作成マスタデータのディレクトリパス
- `<正解データディレクトリ>`: 正解データ（リリース済みマスタデータ）のディレクトリパス

## タスク

### 1. 対象ファイルの確認

両ディレクトリに存在するCSVファイルを確認してください：

```bash
# 生成データディレクトリのファイル一覧
ls <生成データディレクトリ>/*.csv

# 正解データディレクトリのファイル一覧
ls <正解データディレクトリ>/*.csv
```

生成データディレクトリに存在するファイル名と一致する正解データを比較対象とします。

### 2. CSVファイルの差分検出

各対象ファイルについて、以下を実施：

1. **CSV読み込み**
   - ReadツールでCSVファイルを読み込む
   - GLOWマスタデータ形式（3行目がヘッダー、4行目以降がデータ）に対応

2. **行ごとの差分検出**
   - 各データ行を比較
   - 差異があるセルを記録
   - 差異の内容を分類：
     - NULL表現の違い（`""` vs `__NULL__`）
     - ID採番の違い（記述的ID vs 連番）
     - 備考欄の違いは許容
     - その他の差異

### 3. 差異の評価

検出した差異について、以下の基準で修正要否を判断してください：

#### 修正不要と判断する差異

1. **NULL表現の違い** (`""` vs `__NULL__`)
   - 理由: DBスキーマ上、どちらもNULLとして解釈される
   - 例: `unlock_criterion_type`カラム

2. **ID採番の違い** (記述的ID vs 連番)
   - 理由: 新採番ルール適用の余地があり、どちらも有効
   - 例: `mission_event_dependency_event_jig_00001_1_1` vs `151`

3. **備考欄の違いは許容**
   - 理由: マスタデータ自体には関係なく、ただのメモのため
   - 例: `地獄楽いいジャン祭` vs `jigいいジャン祭_ミッション`

#### 修正要と判断する差異

- 日付の誤り
- 数値の誤り
- enum値の不正
- 重要フィールドの値の違い

### 4. レポート生成

以下の2つのファイルを出力先ディレクトリに作成してください：

#### 4-1. マスタデータ検証レポート.md

```markdown
# マスタデータ検証レポート

**作成日**: <本日の日付>
**対象**: <機能名やイベント名>

## 📊 検証サマリー

| 項目 | 結果 |
|------|------|
| **全体正解率** | <修正不要な差異を除外した正解率>% |
| **ファイル数** | <対象ファイル数> |
| **DB投入** | ✅ 可能 / ⚠️ 要修正 |

## ✅ ファイル別検証結果

### <ファイル名1>

| 項目 | 値 |
|------|-----|
| 行数 | <行数> |
| 一致行数 | <一致した行数> |
| 差異行数 | <差異のある行数> |
| 正解率 | <修正不要な差異を除外した正解率>% |

**差異内容**:
- <差異の種類>: <行数>行（修正不要/修正要）

（以下、各ファイルについて同様に記載）

## 📋 差異分析サマリー

| ファイル | 差異タイプ | 行数 | 修正要否 | 理由 |
|---------|-----------|------|---------|------|
| <ファイル名> | NULL表現 | <行数> | 修正不要 | <理由> |
| ... | ... | ... | ... | ... |

## 🎯 最終判定

- **実質正解率**: <修正不要な差異を除外した正解率>%
- **修正要否**: <修正不要/修正必要>
- **DB投入**: <可能/要修正>
- **推奨アクション**: <このままDB投入可能 / 修正後に再検証>

---

**レポート作成**: Claude Code
**検証日時**: <日時>
```

#### 4-2. 差分詳細レポート.csv

全差異を記録したCSVファイル：

```csv
ファイル名,行番号,カラム名,生成データ値,正解データ値,差異タイプ,修正要否,説明
MstEvent.csv,8,end_date,2025-02-28,2025-03-15,その他,修正要,日付の誤り
MstEvent.csv,12,description,"",__NULL__,NULL表現,修正不要,NULL表現の違い
...
```

### 5. 出力先の確認

レポートは以下のいずれかに出力してください：

- 生成データディレクトリ内の`result/`または`report/`サブディレクトリ
- ユーザーに出力先を確認して指定

## 注意事項

- **正解データに作成範囲外のデータが含まれる場合がある**: 必要なレコードのみをフィルタリングして比較
- **GLOWマスタデータ形式**: 3行目がヘッダー行、4行目以降がデータ行
- **TABLE行**: CSV形式によってはTABLE行が存在する場合があるため、適切に処理
- **大量データ**: ファイルが大きい場合は、offsetとlimitを活用して段階的に読み込み

## 期待される出力

1. ✅ 2つのレポートファイル
   - `マスタデータ検証レポート.md`
   - `差分詳細レポート.csv`

2. 📊 明確な判定
   - 修正不要な差異を除外した正解率
   - 修正要の差異のリスト（ある場合）
   - DB投入可否の判断

3. 🎯 実用的な情報
   - どの差異が重要か
   - 何を修正すべきか
   - そのまま投入して問題ないか
