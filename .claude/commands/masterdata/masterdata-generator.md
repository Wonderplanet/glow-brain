---
description: 施策仕様書からマスタデータCSVを自動生成
argument-hint: [施策名]
allowed-tools:
  - Bash(python:*)
  - Bash(ls:*)
  - Bash(find:*)
  - Bash(head:*)
  - Bash(jq:*)
  - Bash(mkdir:*)
---

# 施策マスタデータ自動生成

施策仕様書ファイルから複数のマスタデータCSVを自動生成し、テンプレート適合性を検証します。

## 引数

- `$1`: 施策名（例: `20260202_幼稚園WARS いいジャン祭`）

## 処理フロー

本コマンドは、以下の6つのPhaseで施策マスタデータを生成します：

1. **Phase 1**: ファイル特定と事前検証
2. **Phase 2**: ファイル変換（仕様書→CSV）
3. **Phase 3**: 生成対象の特定
4. **Phase 4**: マスタデータ生成（並列処理）
5. **Phase 5**: テンプレート適合性チェックとAI修正
6. **Phase 6**: 完了レポート

---

## Phase 1: ファイル特定と事前検証

### 1-1. 施策名の取得

引数 `$1` から施策名を取得します。

### 1-2. 仕様書ファイルの検索

以下の手順で仕様書ファイルを特定してください：

```bash
# 仕様書ファイルの検索
マスタデータ/施策/${施策名}/要件/${施策名}_仕様書.xlsx
```

**ファイルが見つからない場合**:
- エラーメッセージを表示: `「施策名 '${施策名}' の仕様書が見つかりません」`
- `マスタデータ/施策/${施策名}/要件/` 内の候補ファイル一覧を表示（Globツール使用）
- 処理を終了

**ファイルが見つかった場合**:
- ファイルパスを確認
- 拡張子から変換方法を判定（`.xlsx` → `scripts/xlsx_to_csv.py` を使用）

### 1-3. ディレクトリ構造の準備

以下のディレクトリが存在することを確認し、なければ作成してください：

- **施策ディレクトリ**: `マスタデータ/施策/${施策名}/`
- **要件CSV出力先**: `マスタデータ/施策/${施策名}/要件/`
- **マスタCSV出力先**: `マスタデータ/施策/${施策名}/`（施策ディレクトリ直下）

```bash
# ディレクトリ作成
mkdir -p "マスタデータ/施策/${施策名}/要件"
```

---

## Phase 2: ファイル変換（XLSX→CSV）

### 2-1. XLSX→CSV変換の実行

既存スクリプト `scripts/xlsx_to_csv.py` を使用して、XLSXファイルの全シートをCSVに変換します。

```bash
python scripts/xlsx_to_csv.py \
  "マスタデータ/施策/${施策名}/要件/${施策名}_仕様書.xlsx" \
  "マスタデータ/施策/${施策名}/要件/"
```

**エラーハンドリング**:
- pandas/openpyxl未インストールの場合:
  - エラーメッセージ: `「必要なライブラリがインストールされていません」`
  - インストールコマンド提示: `pip install pandas openpyxl`
  - 処理を終了

- 変換失敗の場合:
  - エラーログを表示（どのシートで失敗したか）
  - 部分的に変換されたCSVがあれば、続行するかユーザーに確認
  - ユーザー選択: 続行 / 中断

### 2-2. 変換結果の確認

Globツールで変換されたCSVファイル一覧を取得します：

```bash
マスタデータ/施策/${施策名}/要件/*.csv
```

CSVファイル数が0の場合は、変換失敗として処理を終了してください。

**変換後の状態**:
- XLSXの各シートが個別のCSVファイルに変換されます
- これらはまだ仕様書の内容であり、マスタデータではありません
- Phase 3でこれらを解析し、どのマスタデータを生成すべきか判定します

---

## Phase 3: 生成対象シートの特定

### 3-1. CSVファイルの解析

Phase 2で仕様書から変換されたCSVファイル群を解析し、どのマスタデータを生成すべきかを判定します。

**重要**: この段階のCSVは、仕様書のシートを変換したものであり、まだマスタデータではありません。

変換された各CSVファイルに対して、以下の判定を行います：

1. **ファイル名による除外**:
   以下のパターンに一致するCSVは、マスタデータ生成対象外とします：
   - `*仕様概要*`
   - `*更新履歴*`
   - `*依頼リスト*`
   - `*クリエイティブ*`
   - `*ロードマップ*`
   - `*テンプレート*`

2. **内容による判定**:
   - Readツールで先頭10行程度を確認
   - ファイル名やヘッダー行から、どのマスタデータテーブルに対応するか推測
   - 例: 「ガシャ」→ OprGacha、「ミッション」→ MstMissionEvent など

3. **対象シートの抽出**:
   - 要件CSV（仕様書のシート）と、生成すべきマスタデータテーブル名のペアを記録
   - 例: `${施策名}_仕様書_06_ガシャ.csv` → `OprGacha.csv` を生成

### 3-2. TODOリストの作成

TodoWriteツールを使用して、以下のTODOを作成します：

```
- 要件「{要件CSV名}」から{マスタデータテーブル名}.csvを生成 (pending)
- 要件「{要件CSV名}」から{マスタデータテーブル名}.csvを生成 (pending)
...
- 全CSVのテンプレート適合性チェック (pending)
```

例:
```
- 要件「20260202_幼稚園WARS いいジャン祭_仕様書_06_ガシャ.csv」からOprGacha.csvを生成 (pending)
- 要件「20260202_幼稚園WARS いいジャン祭_仕様書_04_ミッション.csv」からMstMissionEvent.csvを生成 (pending)
```

### 3-3. ユーザー確認

「{N}個のマスタデータを生成します。よろしいですか？」というメッセージを表示し、ユーザーの承認を待ちます。

承認されなかった場合は処理を中断してください。

---

## Phase 4: マスタデータ生成（並列処理）

### 4-1. 並列処理の準備

**基本方針**: 1つの要件CSVにつき、1つのgeneral-purpose subagentを起動します。

生成対象の要件CSVを最大3-5個のグループに分けて並列実行します。

**依存関係の考慮**:
- 外部キー依存関係のあるテーブル（例: MstQuest → MstStage）は直列化
- 依存関係のないテーブルは並列実行

### 4-2. general-purpose subagentの並列起動

Taskツールを使用して、各要件CSVに対してgeneral-purpose subagentを並列で起動します。

**subagentへの指示プロンプト**:

```
あなたはGLOW施策マスタデータ生成担当です。

## タスク

以下の要件CSVから、DBスキーマとテンプレートに従ってマスタデータCSVを生成してください。

- **要件CSV**: マスタデータ/施策/${施策名}/要件/${シート名}.csv
- **出力CSV**: マスタデータ/施策/${施策名}/${テーブル名}.csv

## 必須手順

1. **masterdata-explorerスキルを使用**してテーブル構造を確認
   - テーブル名: ${テーブル名}
   - カラム一覧、型情報、制約を把握

2. **施策マスタデータ作成ガイドを参照**
   - パス: `.ai-context/prompts/施策マスタデータ作成ガイド.md`
   - CSV形式ルール、エスケープ処理、データ整合性チェックを確認

3. **テンプレートCSVを参照**
   - パス: `projects/glow-masterdata/sheet_schema/${テーブル名}.csv`
   - ヘッダー3行形式を確認
   - カラム順序を完全一致させる

4. **DBスキーマでバリデーション**
   - パス: `projects/glow-server/api/database/schema/exports/master_tables_schema.json`
   - NULL許可、enum値、外部キー制約を確認

## 出力形式要件

**ヘッダー3行形式**:
- Row 1: `memo`
- Row 2: `TABLE,${テーブル名},${テーブル名},...`
- Row 3: `ENABLE,カラム名1,カラム名2,...`

**カラム順序**: テンプレートCSVと完全一致

**エンコーディング**: UTF-8-SIG

**エスケープ**:
- セル内改行: `\\n` で表現
- カンマ、改行、ダブルクォートを含むセル: ダブルクォートで囲む
- ダブルクォート: `""` でエスケープ

**数値型**: クォートなし
**文字列型**: ダブルクォートで囲む

## 注意事項

- 要件CSVのデータをテーブル構造に合わせて適切に変換してください
- NULL許可カラムは空文字列、NULL不可カラムは適切なデフォルト値を設定
- enum型のカラムは定義された値のみを使用
- 既存マスタデータ（projects/glow-masterdata/配下）を参考にしてデータの作り方や値の傾向を把握してください
```

**並列実行のパラメータ**:
- `subagent_type`: "general-purpose"
- `run_in_background`: true（並列実行を有効化）
- `description`: "マスタデータ生成: {テーブル名}"

### 4-3. 実行進捗の管理

TaskOutputツールを使用して、各subagentの結果を順次取得します：

- 完了したsubagentからTODOステータスを `completed` に更新
- 失敗したsubagentはエラーログを記録し、ユーザーに選択肢を提示:
  - リトライ（同じsubagentで再実行）
  - スキップ（次のCSVへ）
  - 中断（全体処理停止）

---

## Phase 5: テンプレート適合性チェックとAI修正

### 5-1. 生成CSVファイルの取得

Globツールで生成されたマスタデータCSVを取得します：

```bash
マスタデータ/施策/${施策名}/Mst*.csv
マスタデータ/施策/${施策名}/Opr*.csv
```

### 5-2. テンプレート照合（スクリプト実行）

各生成CSVに対して、`scripts/validate_masterdata_template.py` を実行します：

```bash
python scripts/validate_masterdata_template.py \
  --generated "マスタデータ/施策/${施策名}/${テーブル名}.csv" \
  --template "projects/glow-masterdata/sheet_schema/${テーブル名}.csv"
```

**スクリプト出力（JSON形式）**:

```json
{
  "file": "MstQuest.csv",
  "valid": false,
  "issues": [
    {
      "type": "column_order",
      "expected": ["id", "name", "description"],
      "actual": ["id", "description", "name"]
    },
    {
      "type": "missing_column",
      "column": "release_key"
    },
    {
      "type": "extra_column",
      "column": "temp_field"
    },
    {
      "type": "header_format",
      "row": 1,
      "expected": "memo",
      "actual": "メモ"
    }
  ]
}
```

### 5-3. AI修正の実施

検証スクリプトで不一致（`valid: false`）が検出された場合、以下の修正を **あなた（Claude）自身が** 実施してください：

**修正内容**:

a) **カラム順序の並び替え**:
   - Editツールを使用してカラムを正しい順序に並び替え
   - テンプレートの順序と完全一致させる

b) **不要カラムの削除**:
   - テンプレートに存在しないカラムを削除

c) **欠損カラムの補完**:
   - テンプレートにあってCSVにないカラムを追加
   - DBスキーマを参照してNULL許可か確認
   - NULL許可の場合は空値、NULL不可の場合は適切なデフォルト値

d) **ヘッダー行の正規化**:
   - Row 1: `memo` に統一
   - Row 2: `TABLE,${テーブル名},...` に統一
   - Row 3: `ENABLE,カラム名,...` に統一

**AIによる修正のメリット**:
- データの文脈を理解した修正が可能
- 複雑なケースにも柔軟に対応
- デフォルト値の推測や補完が適切

### 5-4. 修正後の再検証

修正したCSVを再度検証スクリプトで確認し、`valid: true` になるまで繰り返します。

### 5-5. 修正不可能な場合の対応

修正が困難な場合は、ユーザーに該当CSVとエラー内容を提示し、以下の選択肢を提供してください：

- subagentで再生成
- 手動修正
- スキップ

修正履歴はログ出力してください。

---

## Phase 6: 完了レポート

### 6-1. 生成結果サマリーの表示

以下の形式で結果を表示してください：

```
【生成結果サマリー】
- 総対象シート数: {N}
- 成功: {成功数} CSVファイル
- 失敗: {失敗数} CSVファイル
- 出力先: マスタデータ/施策/${施策名}/

【生成ファイル一覧】
✓ MstQuest.csv (検証: OK)
✓ MstStage.csv (検証: OK)
⚠ MstItem.csv (検証: WARNING - カラム順序不一致)
✗ OprGacha.csv (生成失敗)

【次のステップ】
1. WARNINGファイルの手動確認・修正
2. マスタデータのインポートテスト
3. 施策管理システムへの登録
```

### 6-2. 完了メッセージ

以下のメッセージでコマンドを終了します：

```
✅ 施策マスタデータの生成が完了しました。
   出力先: マスタデータ/施策/${施策名}/
```

---

## 重要な注意事項

1. **TodoWriteツールの活用**: 各Phaseの進捗を必ずTODOリストで管理してください
2. **masterdata-explorerスキルの使用**: Phase 4のsubagent内で必ず使用するよう指示してください
3. **並列処理の制御**: 外部キー依存のあるテーブルは直列化してください
4. **エラーハンドリング**: 各Phaseで適切なエラーメッセージとリカバリー手段を提供してください
5. **UTF-8-SIG形式の保証**: 生成CSVは必ずUTF-8-SIG形式で保存してください
6. **バックアップ**: Phase 5で修正を行う前に、元のCSVのバックアップを推奨します

---

## 将来の拡張

このコマンドは、Phase 1でファイル形式を判定し、Phase 2で適切な変換処理を選択する設計になっています。

将来的に以下のような拡張が可能です：

- **PDF→Markdown変換**: `scripts/pdf_to_markdown.py`
- **Markdown直接処理**: 変換不要で直接解析
- **その他のフォーマット**: 必要に応じて変換スクリプトを追加

現時点では過剰な抽象化を避け、シンプルな分岐で対応しています。
