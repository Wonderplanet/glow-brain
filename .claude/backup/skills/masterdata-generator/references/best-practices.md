# ベストプラクティス

このドキュメントでは、マスタデータ生成における実践的なアドバイスをまとめています。

## スキーマ検証の徹底 ⚠️

### 必須ステップ

CSV生成後、必ず `masterdata-validator` スキルで検証してください：

```
Skill(skill: "masterdata-validator", args: "<csv_file_path> <ModelName>")
```

### 検証の効果

- **自動修正**: 不正なカラムは自動削除、不足カラムは自動追加
- **データ型チェック**: ENUM、INT、DATETIME型の値を厳密に検証
- **制約チェック**: PRIMARY KEY重複、UNIQUE違反、NOT NULL違反を検出
- **修正ログ**: 全ての修正内容をREPORTに記録

### 検証結果の活用

validatorが検出した問題は、必ずREPORTの「スキーマ検証と修正」セクションに記録してください。

## 既存データの参照

### ID範囲の確認

新しいIDを割り当てる際は、必ず既存データのID範囲を確認してください：

```bash
# 既存データのIDを確認
cat マスタデータ/施策/既存施策/*.csv | grep -E "^e," | cut -d',' -f2 | sort -n | tail -5
```

### 命名パターンの踏襲

- asset_key: 既存データの命名パターンに従う（例: `event_202601_spring`, `gacha_pickup_a`）
- IDパターン: プレフィックスやサフィックスのルールを統一

### 既存ファイルの検索

関連する既存データを探す際は、Grepツールを活用してください：

```
Grep(pattern: "<関連キーワード>", path: "マスタデータ/施策/", output_mode: "files_with_matches")
```

## 進捗管理のコツ

### TodoWriteの活用

各マスタデータごとにタスクを作成し、進捗を可視化します：

```
TodoWrite([
  {"content": "要件分析", "status": "completed", ...},
  {"content": "OprGacha.csv 生成", "status": "in_progress", ...},
  {"content": "OprGachaI18n.csv 生成", "status": "pending", ...},
  ...
])
```

### マイルストーンの設定

大量のマスタデータを生成する場合、以下のマイルストーンで進捗を確認します：

1. 要件分析完了（全てのマスタデータをリストアップ）
2. スキーマ調査完了（全てのモデルのスキーマを確認）
3. CSV生成完了（全てのCSVファイルを作成）
4. 検証完了（全てのCSVを validator でチェック）
5. レポート完成（REPORTを作成）

## トラブルシューティング

### スキーマが見つからない場合

`masterdata-schema-inspector` がスキーマを見つけられない場合：

1. モデル名が正しいか確認（PascalCase）
2. テンプレートファイルが存在するか確認
3. 類似のモデル名を検索して正しい名前を特定

### テンプレートファイルが存在しない場合

稀にテンプレートファイルが存在しない新しいモデルの場合：

1. スキーマJSONから直接カラム定義を取得
2. 既存の類似モデルのテンプレートを参考にヘッダーを作成
3. 3行ヘッダー形式を厳守（memo, TABLE, ENABLE）

### ENUM値が不明な場合

ENUM型のカラムで許可される値が不明な場合：

1. `masterdata-schema-inspector` の出力でENUM選択肢を確認
2. 既存データで実際に使用されている値を参照
3. スキーマJSONの `enum` フィールドを確認

## データ品質のチェックポイント

作成したCSVファイルを目視で確認する際のチェックポイント：

- [ ] ヘッダーがテンプレートと完全一致しているか
- [ ] データ行が `e,` で始まっているか（ENABLEカラム）
- [ ] IDが重複していないか
- [ ] 日時が `YYYY-MM-DD HH:MM:SS` 形式か
- [ ] `__NULL__` が nullable 列にのみ使用されているか
- [ ] カンマの数が全行で一致しているか（カラム数の統一）
