# Claude Code ガイド相談レポート

**日付**: 2025年12月27日
**トピック**: スキルの動的読み込みと選択的ロードの仕組み

## 相談内容

- 40個のスキルがある場合、全て事前読み込みされるのか
- プロンプトに関連するスキルだけを動的に読み込むことは可能か
- settings.json で擬似的に制御できるか
- Plugin Marketplace の仕組みで実現できるか

## 重要な結論・学び

### ✅ **動的ロードは既に実装済み！**

**ユーザーの期待していた機能は、Claude Code に既に標準実装されています。**

> 出典: [Claude Code Skills ドキュメント](https://code.claude.com/docs/en/skills.md)

公式ドキュメントの引用：

> At startup, Claude loads only the name and description of each available Skill. This keeps startup fast while giving Claude enough context to know when each Skill might be relevant.

### 1. スキルの読み込みタイミング

**起動時**:
- スキルのメタデータ（`name`, `description`）のみロード
- 全40個のスキルの name/description が読み込まれる
- **約4,000トークン**のコスト（100トークン/スキル × 40スキル）

**プロンプト実行時**:
- プロンプトとスキルの description を比較
- **意味的類似性（semantic similarity）**でマッチング
- 関連するスキルだけフル `SKILL.md` をロード

> 出典: [Claude Code Skills ドキュメント](https://code.claude.com/docs/en/skills.md)

公式ドキュメントの引用：

> When your request matches a Skill's description, Claude asks to use the Skill. You'll see a confirmation prompt before the full `SKILL.md` is loaded into context. Claude matches requests against descriptions using semantic similarity, so write descriptions that include keywords users would naturally say.

**重要**: description フィールドに具体的なキーワードを含めることが必須。

### 2. 動的な選択的ロードの仕組み

**✅ 実装済み - 以下のフローで動作**:

```
1. 起動時
   ↓
   全40スキルの name/description をロード（約4,000トークン）

2. ユーザーがプロンプトを投げる
   ↓
   Claude が意味的類似性で関連スキルを判定

3. 関連スキルのみフル SKILL.md をロード
   ↓
   関連スキル（例：3個）だけコンテキストに含まれる

4. 実行
   ↓
   必要なスキルだけが使われる
```

**例**:

- 40個のマスタデータ関連スキル
- プロンプト: 「キャラクターマスタのID採番ルールを確認して」
- Claude の判定: `character-master-tools` スキルが関連
- ロード: `character-master-tools/SKILL.md` のみフルロード
- 他の39個: メタデータのみ（本体はロードされない）

### 3. settings.json での制御

> 出典: [Claude Code Settings ドキュメント](https://code.claude.com/docs/en/settings.md)

**⚠️ 部分的に可能 - プラグイン単位のみ**

```json
{
  "enabledPlugins": {
    "plugin-name@marketplace-name": true,
    "another-plugin@marketplace-name": false
  }
}
```

**制限**:
- `enabledPlugins` は**プラグイン全体**を有効/無効化
- **スキル単位**での細かい制御はサポートされていない
- 設定ファイルの動的な変更は公式に推奨されていない

### 4. Plugin Marketplace の仕組み

> 出典: [Plugin Marketplaces ドキュメント](https://code.claude.com/docs/en/plugin-marketplaces.md)

公式ドキュメントの引用：

> Plugin entries include repository references, version information, and metadata that Claude Code uses to download and install them.

**Marketplace の動作**:

- **インデックス**として40個のプラグインを列挙
- **ユーザーが明示的に選択してインストール**する仕組み
- 全て読み込まれるわけではない（ユーザー指定ベース）

**つまり**:
- Marketplace に40個のプラグインを配置
- ユーザーは必要なもの（例：10個）だけインストール
- インストールされたものだけ起動時にメタデータロード

### 5. 大量スキル管理の公式推奨 - Progressive Disclosure

> 出典: [Claude Code Skills ドキュメント](https://code.claude.com/docs/en/skills.md)

公式ドキュメントの引用：

> Keep `SKILL.md` under 500 lines for optimal performance. If your content exceeds this, split detailed reference material into separate files.

**推奨パターン**:

```
my-skill/
├── SKILL.md              # 本体（500行以下、概要のみ）
├── reference.md          # 詳細情報
├── examples.md           # 使用例
└── scripts/
    └── helper.py         # ユーティリティ
```

**利点**:
- `SKILL.md` は簡潔（200-500行）
- Claude は必要時だけ `reference.md` を読み込む
- コンテキストの無駄遣いを防ぐ

## 実装可能な最適化戦略

### 戦略1: Description の最適化（最も重要）

**現在の問題**: 自動認識されない

**原因**: description が曖昧

**解決策**: 具体的なキーワードを含める

**Before**:
```yaml
---
name: character-master-tools
description: キャラクターマスタデータを扱うスキル
---
```

**After**:
```yaml
---
name: character-master-tools
description: キャラクターマスタデータのID採番、検証、生成を行うスキル。Use when user mentions character IDs, character master data, or asks about character numbering rules. キャラ、キャラクター、ID採番、マスタデータ、キャラマス等のキーワードで使用。
---
```

**効果**: 意味的類似性のマッチング精度が向上 → 自動認識率アップ

### 戦略2: Progressive Disclosure の採用

**SKILL.md を簡潔に**:

```markdown
---
name: character-master-tools
description: キャラクターマスタデータのID採番、検証、生成スキル...
---

# キャラクターマスタツール

## 概要
このスキルはキャラクターマスタデータの管理を支援します。

## 主な機能
1. ID採番ルールの確認・提案
2. 既存IDの検証
3. 新規キャラクター用CSVマスタ生成

## 詳細情報
- ID採番ルール詳細: [references/id-numbering-rules.md](references/id-numbering-rules.md)
- 既存キャラクター一覧: [references/existing-characters.md](references/existing-characters.md)
- CSV生成仕様: [references/csv-format.md](references/csv-format.md)

## 使用方法
...
```

**利点**:
- SKILL.md は200-300行程度
- 詳細は別ファイル → 必要時だけロード
- 起動時のメタデータ読み込みコストを削減

### 戦略3: サブエージェント + スキル組み合わせ

> 出典: [Claude Code Sub-agents ドキュメント](https://code.claude.com/docs/en/sub-agents.md)

**40個のスキルを8-10個のサブエージェントにグループ化**:

```yaml
# .claude/agents/character-tools/AGENT.md
---
name: character-tools
description: キャラクター関連のマスタデータ管理エージェント
skills: character-id-numbering, character-master-explorer, character-csv-generator
---
```

**利点**:
- ユースケース別に明示的に選択可能
- `/character-tools` で呼び出し → 関連スキルだけロード

### 戦略4: Hooks による動的フィルタリング

> 出典: [Claude Code Hooks ドキュメント](https://code.claude.com/docs/en/hooks.md)

**キーワード検出に基づいて動的制御**:

```json
{
  "hooks": {
    "UserPromptSubmit": [{
      "matcher": "キャラ|character",
      "type": "command",
      "command": "~/.claude/scripts/enable-character-skills.sh"
    }]
  }
}
```

**スクリプト例**:

```bash
#!/bin/bash
# ~/.claude/scripts/enable-character-skills.sh

# キャラクター関連スキルのみ有効化
echo "Enabling character-related skills..."
# 実際には settings.json を動的に編集
```

**制限**: 公式に推奨されていないため、安定性に注意

### 戦略5: プロジェクトスコープでの分離

**複数プロジェクトで異なる設定**:

```
project-planning/
└── .claude/
    └── settings.json  # プランナー向けスキルのみ

project-engineering/
└── .claude/
    └── settings.json  # エンジニア向けスキルのみ
```

**利点**:
- プロジェクトごとに必要なスキルだけインストール
- 起動時のメタデータ読み込みコストを削減

## 40個のスキルを効率的に管理する最適な実装案

### 推奨構成

```
glow-skills-marketplace/
├── .claude-plugin/
│   └── marketplace.json
│
└── plugins/
    ├── character-tools/          # 8個のスキル
    │   ├── .claude-plugin/plugin.json
    │   └── skills/
    │       ├── character-id-numbering/
    │       │   ├── SKILL.md (200行)
    │       │   └── references/
    │       │       ├── id-rules.md
    │       │       └── examples.md
    │       ├── character-master-explorer/
    │       └── ...
    │
    ├── quest-tools/              # 8個のスキル
    ├── item-tools/               # 8個のスキル
    ├── bgm-tools/                # 8個のスキル
    └── event-tools/              # 8個のスキル
```

### 各スキルの最適化

**1. Description の充実**:

```yaml
---
name: character-id-numbering
description: GLOWキャラクターマスタのID採番ルール参照・次の空きID提案・ID検証スキル。Use when user asks about character IDs, character numbering, new character creation, or character master data validation. Keywords: キャラID, キャラクターID, ID採番, 次のID, キャラマス, character master, character_id
---
```

**2. SKILL.md の簡潔化**:

```markdown
# キャラクターID採番

## 概要
GLOWプロジェクトのキャラクターIDの採番ルールを管理します。

## 主な機能
1. ID採番ルールの参照
2. 次の空きIDの提案
3. 既存IDの検証

## ID採番ルール概要
- キャラクターID: `10001-19999`
- レアリティ別範囲あり

詳細: [references/id-numbering-rules.md](references/id-numbering-rules.md)

## 使用方法
...（100-200行程度）
```

**3. 詳細情報の分離**:

```
character-id-numbering/
├── SKILL.md (200行)
└── references/
    ├── id-numbering-rules.md (詳細ルール)
    ├── existing-ids.md (既存ID一覧)
    └── examples.md (使用例)
```

### Marketplace での配布

```json
{
  "name": "glow-skills",
  "owner": {"name": "GLOW Team"},
  "plugins": [
    {
      "name": "glow-character-tools",
      "source": "./plugins/character-tools",
      "description": "キャラクター関連スキル（8個）",
      "keywords": ["character", "キャラ", "master"]
    },
    {
      "name": "glow-quest-tools",
      "source": "./plugins/quest-tools",
      "description": "クエスト関連スキル（8個）",
      "keywords": ["quest", "クエスト", "mission"]
    }
    // ... 他のプラグイン
  ]
}
```

### ユーザーの使用フロー

**プランナー**:
```bash
# プランナーはキャラ・クエスト・アイテム関連のみインストール
claude plugin install glow-character-tools@glow-skills
claude plugin install glow-quest-tools@glow-skills
claude plugin install glow-item-tools@glow-skills

# 起動時: 24個のスキルのメタデータロード（約2,400トークン）
# プロンプト: 「新しいキャラクターのID採番して」
# → character-id-numbering スキルのみフルロード
# → 他の23個はメタデータのみ
```

**エンジニア**:
```bash
# エンジニアはBGM・イベント・開発ツール関連のみインストール
claude plugin install glow-bgm-tools@glow-skills
claude plugin install glow-event-tools@glow-skills
claude plugin install glow-dev-tools@glow-skills

# 起動時: 24個のスキルのメタデータロード（約2,400トークン）
```

## 重要な制限事項

公式ドキュメントに明示されていない点：

1. **メタデータ読み込みは避けられない**
   - 有効化された全スキルの name/description は起動時に必ずロード
   - 40個全て有効化すると、約4,000トークンのコスト

2. **単一プロジェクト内での動的有効/無効化は未サポート**
   - settings.json の編集 + 再起動が必要
   - プロンプトベースの自動切り替えは不可

3. **スキル単位での細かい制御は不可**
   - `enabledPlugins` はプラグイン単位のみ
   - 個別スキルの有効/無効化はサポートされていない

## パフォーマンス比較

### ケース1: 40個全てを1プラグインに配置

```
起動時コスト: 4,000トークン（全40スキルのメタデータ）
プロンプト時: 関連スキル（例：3個）のみフルロード
実行時コスト: 関連スキルの内容のみ
```

### ケース2: 8個ずつ5プラグインに分割

```
起動時コスト: 800トークン（インストールされた8スキルのメタデータ）
プロンプト時: 関連スキル（例：1個）のみフルロード
実行時コスト: 関連スキルの内容のみ
```

**削減率**: 約80%のメタデータコスト削減

### ケース3: Progressive Disclosure 採用

```
SKILL.md サイズ: 500行 → 200行（詳細は別ファイル）
フルロード時コスト: 約60%削減
```

## 参照ドキュメント

相談で参照した公式ドキュメントのURL一覧：

- [Claude Code Skills ドキュメント](https://code.claude.com/docs/en/skills.md)
- [Plugin Marketplaces ドキュメント](https://code.claude.com/docs/en/plugin-marketplaces.md)
- [Claude Code Sub-agents ドキュメント](https://code.claude.com/docs/en/sub-agents.md)
- [Claude Code Hooks ドキュメント](https://code.claude.com/docs/en/hooks.md)
- [Claude Code Settings ドキュメント](https://code.claude.com/docs/en/settings.md)

## まとめ

### ユーザーの質問への回答

**Q: 40個全て事前読み込みではなく、関連するものだけ動的に読み込むことは可能か？**
- **A: ✅ 既に実装済み！** メタデータ（name/description）は起動時、本体（SKILL.md）は関連するものだけプロンプト時にロード

**Q: settings.json で擬似的に可能か？**
- **A: ⚠️ プラグイン単位なら可能。** スキル単位の細かい制御は不可

**Q: plugin marketplace の仕組みでできるのか？**
- **A: ✅ 可能。** Marketplace で5プラグイン（各8スキル）に分割 → ユーザーは必要なものだけインストール

### 最適な実装方針

1. **Description を充実させる** - 具体的なキーワードを含める（最重要）
2. **8-10個ずつプラグインに分割** - Marketplace で配布
3. **Progressive Disclosure 採用** - SKILL.md は200-500行、詳細は別ファイル
4. **ユーザー/チーム別にインストール** - 必要なプラグインだけ有効化

**効果**:
- 起動時コスト: 約80%削減（4,000 → 800トークン）
- 自動認識精度: 向上（description 最適化）
- メンテナンス性: 向上（カテゴリー別整理）

---

*このレポートは `/guide-chat` コマンドにより自動生成されました*
