# Claude Code ガイド相談レポート

**日付**: 2025年12月27日
**トピック**: プラグインの動的選択とワークスペース管理

## 相談内容

- 8個ずつ5プラグインに分割した場合
- タスクに応じて使いたいプラグインが異なる
- プロンプトから必要なプラグインを自動認識してロードすることは可能か
- 複数リポジトリクローンが必要か、他の方法はあるか

## 重要な結論・学び

### ユーザーの理解

**Q: プロンプトから必要なプラグインを自動認識してロードすることはできないのか？**
- **A: ✗ できません。** プラグインは semantic similarity で自動選択されません。

**Q: 複数リポジトリクローンが必要か？**
- **A: ⚠️ 必須ではありません。** より良い方法があります。

### 重要な発見

| 項目 | 可能/不可能 | 実装方法 |
|------|----------|--------|
| **プラグイン自動選択** | ✗ 不可 | プラグインは semantic similarity で自動選択されない |
| **動的有効化/無効化** | ✓ 可能 | `settings.json` の `enabledPlugins` で設定 |
| **コマンドでの切り替え** | ✗ 不可 | `/plugin enable` コマンドは存在しない |
| **ワークスペース/プロジェクトスコープ** | ✓ 可能 | スコープシステムで複数の設定を管理可能 |
| **複数設定ファイルの切り替え** | ✓ 可能 | ローカル/プロジェクト/ユーザースコープで実装 |
| **設定プロファイル機能** | ✗ 不可 | プロファイル概念は公式には存在しない |

## 詳細解説

### 1. プラグインの自動選択：✗ 不可能

> 出典: [Claude Code plugins documentation](https://code.claude.com/docs/en/plugins.md)

**重要な違い**:

| 項目 | スキル | プラグイン |
|------|--------|-----------|
| **自動選択** | ✓ Semantic similarity で自動 | ✗ 手動で有効化が必要 |
| **読み込み** | プロンプトに基づいて動的 | settings.json で静的に設定 |
| **切り替え** | 自動 | 手動（設定変更 + 再起動） |

公式ドキュメントの説明：

> プラグインはスキルと異なり、ユーザーが明示的にインストールして有効化する必要があります。スキルはプロンプトから自動認識されますが、プラグインにはこの機能はありません。

**つまり**:
- **スキル**: プロンプト「キャラクターIDを採番して」→ 自動的に `character-id-numbering` スキルが選択される
- **プラグイン**: `enabledPlugins` で明示的に有効化が必要

### 2. プラグインの動的有効化/無効化：✓ 可能だが制限あり

> 出典: [Claude Code settings documentation](https://code.claude.com/docs/en/settings.md#plugin-configuration)

**方法**: `settings.json` の `enabledPlugins` フィールドで制御

```json
{
  "enabledPlugins": {
    "character-tools@my-plugins": true,
    "quest-tools@my-plugins": false,
    "item-tools@my-plugins": true
  }
}
```

**制限事項**:
- **実行中の切り替えは不可** - セッション再開が必要
- **コマンドは存在しない** - `/plugin enable` や `/plugin disable` はない
- **手順**: 設定ファイル編集 → セッション再開

### 3. コマンドやエイリアスでの制御：✗ 不可能

> 出典: [Claude Code slash-commands documentation](https://code.claude.com/docs/en/slash-commands.md)

**利用可能なコマンド**:

```bash
/plugin              # プラグインマネージャー UI を開く
/plugin install      # プラグインをインストール
/plugin uninstall    # プラグインをアンインストール
```

**利用不可能なコマンド**:
```bash
/plugin enable       # ✗ 存在しない
/plugin disable      # ✗ 存在しない
/plugin switch       # ✗ 存在しない
```

### 4. ワークスペース/プロジェクトスコープ：✓ 可能（推奨）

> 出典: [Claude Code settings documentation - Configuration scopes](https://code.claude.com/docs/en/settings.md#configuration-scopes)

**スコープシステム**の活用が公式推奨です。

#### スコープの優先順位（低 → 高）:

1. **User scope** (`~/.claude/settings.json`) - すべてのプロジェクト共通
2. **Project scope** (`.claude/settings.json`) - チーム共有
3. **Local scope** (`.claude/settings.local.json`) - 個人/マシン固有
4. **Enterprise scope** - 最高優先度（企業設定）

#### 実装例：同じリポジトリで異なる設定

```
glow-brain/
├── .claude/
│   ├── settings.json              # チーム共有設定（全プラグイン定義）
│   └── settings.local.json        # 個人用（gitignored）
```

**チーム共有設定** (`.claude/settings.json`):
```json
{
  "extraKnownMarketplaces": {
    "glow-skills": {
      "source": {
        "source": "github",
        "repo": "your-org/glow-skills-marketplace"
      }
    }
  },
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": true,
    "item-tools@glow-skills": true,
    "bgm-tools@glow-skills": true,
    "event-tools@glow-skills": true
  }
}
```

**個人ローカル設定** (`.claude/settings.local.json`):
```json
{
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": false,
    "item-tools@glow-skills": false,
    "bgm-tools@glow-skills": false,
    "event-tools@glow-skills": false
  }
}
```

**重要**: ローカル設定が優先されるため、個人は必要なプラグインだけ有効化できる。

### 5. Git worktree の活用：✓ 有効（複雑だが強力）

> 出典: [Claude Code common-workflows documentation](https://code.claude.com/docs/en/common-workflows.md#run-parallel-claude-code-sessions-with-git-worktrees)

**複数リポジトリクローンは不要。Git worktree を使う。**

```bash
# メインリポジトリ
cd glow-brain

# キャラクター作業用 worktree
git worktree add ../glow-brain-character character-branch
cd ../glow-brain-character

# character専用の設定
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": false,
    "item-tools@glow-skills": false
  }
}
EOF

# Claude Code 起動
claude

# 別ターミナルで quest 作業用 worktree
cd glow-brain
git worktree add ../glow-brain-quest quest-branch
cd ../glow-brain-quest

# quest専用の設定
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": false,
    "quest-tools@glow-skills": true,
    "item-tools@glow-skills": false
  }
}
EOF

# Claude Code 起動
claude
```

**利点**:
- 複数セッションを並行実行可能
- 各 worktree で完全に独立した設定
- ディスク容量の節約（`.git` は共有）

### 6. 複数設定ファイルの管理：✓ 可能

> 出典: [Claude Code settings documentation - Settings precedence](https://code.claude.com/docs/en/settings.md#settings-precedence)

**方法1: スコープを活用する（推奨）**

```bash
# ユーザースコープ（個人設定）
~/.claude/settings.json

# プロジェクトスコープ（チーム設定）
.claude/settings.json

# ローカルスコープ（個人＋マシン固有）
.claude/settings.local.json
```

これらは**自動的にマージされ**、優先度に従って適用されます。

**方法2: カスタムコマンドで設定ファイルを交換（非推奨だが可能）**

```bash
# .claude/commands/switch-to-character.md
---
description: Switch to character tools configuration
---

# Switch Configuration

使用するツールセットを character-tools に切り替えます。

## 実装

1. `.claude/settings.local.json` を更新
2. Claude Code セッションを再開
```

## ベストプラクティス（推奨戦略）

### ⭐ パターン1: スキルベース（最も推奨）

**プラグインではなく、スキルで機能分割する。**

> 出典: [Claude Code skills documentation](https://code.claude.com/docs/en/skills.md)

```
.github/skills/              # または .claude/skills/
├── character-id-numbering/
│   └── SKILL.md
├── character-master-explorer/
│   └── SKILL.md
├── quest-id-numbering/
│   └── SKILL.md
├── quest-master-explorer/
│   └── SKILL.md
├── item-id-numbering/
│   └── SKILL.md
└── item-master-explorer/
    └── SKILL.md
```

**各スキルの description を充実**:

```yaml
---
name: character-id-numbering
description: GLOWキャラクターマスタのID採番ルール参照・次の空きID提案・ID検証スキル。Use when user asks about character IDs, character numbering, new character creation, or character master data validation. Keywords: キャラID, キャラクターID, ID採番, 次のID, キャラマス, character master, character_id, キャラクター作成
---
```

**利点**:
- ✅ **プロンプトから自動認識** - タスクに応じて Claude が自動選択
- ✅ **設定変更不要** - description が充実していれば自動
- ✅ **シンプル** - プラグイン管理が不要
- ✅ **複数ツール対応** - GitHub Copilot でも使える

**実行例**:

```
ユーザー: キャラクターの新規ID採番して

Claude の自動選択:
  ↓ semantic similarity でマッチング
  ↓ character-id-numbering スキルを検出
  ↓ SKILL.md をロード
  ↓ ID採番実行
```

### パターン2: スコープベース（シンプル・推奨）

**プラグインを使う場合の推奨方法。**

```bash
# 1. チーム共有設定（全プラグイン定義）
.claude/settings.json

# 2. 個人ローカル設定（必要なものだけ有効化）
.claude/settings.local.json
```

**手順**:

```bash
# キャラクター作業時
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": false,
    "item-tools@glow-skills": false
  }
}
EOF

# セッション再開
claude

# クエスト作業時
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": false,
    "quest-tools@glow-skills": true,
    "item-tools@glow-skills": false
  }
}
EOF

# セッション再開
claude
```

**利点**:
- ✅ シンプルで理解しやすい
- ✅ git 管理が不要（`.gitignore` に `settings.local.json` を追加）
- ✅ 設定の競合がない

### パターン3: worktree ベース（複雑だが分離度が高い）

**複数タスクを並行実行する場合。**

```bash
# メインリポジトリ
glow-brain/

# キャラクター作業用 worktree
glow-brain-character/
└── .claude/settings.local.json  # character-tools のみ有効

# クエスト作業用 worktree
glow-brain-quest/
└── .claude/settings.local.json  # quest-tools のみ有効

# アイテム作業用 worktree
glow-brain-item/
└── .claude/settings.local.json  # item-tools のみ有効
```

**利点**:
- ✅ 複数セッションを並行実行可能
- ✅ 各 worktree で完全に独立した設定
- ✅ タスク切り替え時に設定変更不要

**欠点**:
- ⚠️ Git worktree の理解が必要
- ⚠️ ディレクトリ構造が複雑化

## 実装推奨順序

### 短期（今すぐ実装）

**1. スキルベースアプローチに移行**

```bash
# プラグイン内のスキルを .github/skills/ に移動
mkdir -p .github/skills
cp -r plugins/character-tools/skills/* .github/skills/
cp -r plugins/quest-tools/skills/* .github/skills/
# ... 他のプラグインも同様

# 各スキルの description を充実させる
# → プロンプトから自動認識されるように
```

### 中期（1〜2週間後）

**2. スコープシステムを活用**

```bash
# .claude/settings.local.json を作成
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": true
  }
}
EOF

# .gitignore に追加
echo ".claude/settings.local.json" >> .gitignore
```

### 長期（2週間以上）

**3. worktree での並行作業環境を構築**

```bash
# タスク別の worktree を作成
git worktree add ../glow-brain-character character-branch
git worktree add ../glow-brain-quest quest-branch

# 各 worktree で settings.local.json を設定
```

## 具体的な実装例

### 実装例1: スキルベースアプローチ（最も推奨）

**ディレクトリ構造**:

```
glow-brain/
└── .github/skills/
    ├── character-id-numbering/
    │   ├── SKILL.md
    │   └── references/
    │       └── id-rules.md
    ├── quest-id-numbering/
    │   ├── SKILL.md
    │   └── references/
    │       └── id-rules.md
    └── item-id-numbering/
        ├── SKILL.md
        └── references/
            └── id-rules.md
```

**SKILL.md の例**:

```yaml
---
name: character-id-numbering
description: GLOWキャラクターマスタのID採番ルール参照・次の空きID提案・ID検証スキル。Use when user asks about character IDs, character numbering, new character creation, or character master data validation. Keywords: キャラID, キャラクターID, ID採番, 次のID, キャラマス, character master, character_id, キャラクター作成, キャラクターマスター, キャラマスタ
---

# キャラクターID採番

## 概要
GLOWプロジェクトのキャラクターIDの採番ルールを管理します。

## 主な機能
1. ID採番ルールの参照
2. 次の空きIDの提案
3. 既存IDの検証

...
```

**使用方法**:

```
ユーザー: 新しいキャラクターのIDを採番して

Claude:
  → "character-id-numbering" スキルを自動検出
  → SKILL.md をロード
  → ID採番実行
  → 結果を返す

（設定変更なし、プラグイン切り替えなし）
```

### 実装例2: スコープベース（プラグインを使う場合）

**ディレクトリ構造**:

```
glow-brain/
└── .claude/
    ├── settings.json              # チーム共有（Git管理）
    └── settings.local.json        # 個人用（gitignored）
```

**チーム共有設定** (`.claude/settings.json`):

```json
{
  "extraKnownMarketplaces": {
    "glow-skills": {
      "source": {
        "source": "github",
        "repo": "your-org/glow-skills-marketplace"
      }
    }
  },
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": true,
    "item-tools@glow-skills": true
  }
}
```

**個人ローカル設定** (`.claude/settings.local.json`):

```json
{
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": false,
    "item-tools@glow-skills": false
  }
}
```

**.gitignore**:

```
.claude/settings.local.json
```

**使用方法**:

```bash
# キャラクター作業時
# settings.local.json で character-tools のみ有効化
claude

# クエスト作業に切り替え
# settings.local.json を編集して quest-tools のみ有効化
# セッション再開
claude
```

### 実装例3: worktree ベース

**ディレクトリ構造**:

```
~/workspace/
├── glow-brain/                    # メインリポジトリ
├── glow-brain-character/          # キャラクター作業用
│   └── .claude/settings.local.json
├── glow-brain-quest/              # クエスト作業用
│   └── .claude/settings.local.json
└── glow-brain-item/               # アイテム作業用
    └── .claude/settings.local.json
```

**セットアップ**:

```bash
# メインリポジトリ
cd glow-brain

# キャラクター作業用 worktree
git worktree add ../glow-brain-character character-branch
cd ../glow-brain-character
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": true,
    "quest-tools@glow-skills": false,
    "item-tools@glow-skills": false
  }
}
EOF
claude  # キャラクター作業開始

# 別ターミナル - クエスト作業用 worktree
cd ~/workspace/glow-brain
git worktree add ../glow-brain-quest quest-branch
cd ../glow-brain-quest
cat > .claude/settings.local.json << 'EOF'
{
  "enabledPlugins": {
    "character-tools@glow-skills": false,
    "quest-tools@glow-skills": true,
    "item-tools@glow-skills": false
  }
}
EOF
claude  # クエスト作業開始
```

**利点**: 両方のセッションを同時に開いて、タスク間を切り替えられる。

## 参照ドキュメント

相談で参照した公式ドキュメントのURL一覧：

- [Claude Code settings - Configuration scopes](https://code.claude.com/docs/en/settings.md#configuration-scopes)
- [Claude Code settings - Settings precedence](https://code.claude.com/docs/en/settings.md#settings-precedence)
- [Claude Code plugins](https://code.claude.com/docs/en/plugins.md)
- [Claude Code skills](https://code.claude.com/docs/en/skills.md)
- [Claude Code common-workflows - Git worktrees](https://code.claude.com/docs/en/common-workflows.md#run-parallel-claude-code-sessions-with-git-worktrees)
- [Claude Code slash-commands](https://code.claude.com/docs/en/slash-commands.md)

## まとめ

### ユーザーの質問への回答

**Q: プロンプトから必要なプラグインを自動認識してロードすることはできない？**
- **A: ✗ できません。** プラグインは semantic similarity で自動選択されません。
- **解決策: スキルを使う** - スキルは自動認識されます。

**Q: 複数リポジトリクローンが必要？**
- **A: ✗ 必須ではありません。** より良い方法があります：
  1. **スキルベースアプローチ**（最も推奨）- プロンプトから自動認識
  2. **スコープシステム** - `.claude/settings.local.json` で個人設定
  3. **Git worktree** - 複数セッションを並行実行

### 最も推奨される方法

**⭐ スキルベースアプローチ**:

```
.github/skills/
├── character-id-numbering/SKILL.md  # description 充実
├── quest-id-numbering/SKILL.md       # description 充実
└── item-id-numbering/SKILL.md        # description 充実
```

**効果**:
- ✅ プロンプトから自動認識
- ✅ 設定変更不要
- ✅ タスク切り替えが自動
- ✅ GitHub Copilot でも使える

**プラグインを使う場合**:
- スコープシステム（`.claude/settings.local.json`）で個人設定を管理
- 複数リポジトリクローンは不要（Git worktree で十分）

---

*このレポートは `/guide-chat` コマンドにより自動生成されました*
