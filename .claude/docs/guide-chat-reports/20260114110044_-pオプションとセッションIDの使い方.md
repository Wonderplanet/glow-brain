# Claude Code ガイド相談レポート

**日付**: 2026年01月14日
**トピック**: `-p`オプションとセッションIDの正しい使い方

## 相談内容

- `claude -p` でプロンプトモードを実行すると出力されずフリーズする問題
- `-p`オプションと`--session-id`オプションの組み合わせ使用について
- セッションが作成されるが出力が表示されない理由
- この問題の解決方法

## 重要な結論・学び

### 1. `-p`オプション(プリントモード)の正しい動作

`-p`フラグは「プリントモード」として動作し、対話型モードを使わずクエリを実行します。

> 出典: [CLI Reference - Claude Code Documentation](https://code.claude.com/docs/en/cli-reference.md)

公式ドキュメントからの定義:

> `--print`, `-p`: Print response without interactive mode

**正しい使用例**:
```bash
claude -p "explain this function"
```

この場合、Claudeはプロンプトに対して回答し、結果を標準出力に表示してから**自動的にセッションを終了**します。

**ベストプラクティス**:
- プリントモードは1回のクエリ実行に使用する
- 対話が不要な自動化スクリプトやCI/CDパイプラインでの使用に適している
- セッションの永続化が不要な場合に使用する

**注意点**:
- プリントモードでは対話型REPLは起動しない
- 複数のやり取りが必要な場合は通常のインタラクティブモードを使用する

### 2. なぜ出力がされずフリーズするのか

> 出典: [Troubleshooting - Claude Code Documentation](https://code.claude.com/docs/en/troubleshooting.md)

トラブルシューティングドキュメントには以下の記載があります:

> ### Command hangs or freezes
>
> If Claude Code seems unresponsive:
>
> 1. Press Ctrl+C to attempt to cancel the current operation
> 2. If unresponsive, you may need to close the terminal and restart

**考えられる原因**:

1. **インタラクティブモードに入っている**: セッション指定により、Claude Codeが対話型REPLモードに入り、入力待機している
2. **セッションの永続化**: `--session-id`によりセッションが作成され、ターミナルがそのセッションの継続入力を待っている
3. **出力バッファの問題**: 出力処理が完了していない、またはストリーミング出力が待機中

**実際の動作分析**:

ユーザーが実行したコマンド:
```bash
claude -p "セッションIDを指定してセッションを作ってpオプションで再開できるかテストする" --session-id B1234567-1234-1234-1234-123456789ADF
```

この場合:
- セッションは作成されている(再実行でエラーが出るため)
- `-p`フラグが正しく解釈されていない可能性がある
- インタラクティブモードで起動しているが、出力表示前に待機状態になっている

### 3. `-p`オプションと`--session-id`オプションの正しい使い方

> 出典: [CLI Reference - Claude Code Documentation](https://code.claude.com/docs/en/cli-reference.md)

**`--print`, `-p`フラグ**:
```
Print response without interactive mode (see SDK documentation for programmatic usage details)
Example: claude -p "query"
```

**`--session-id`フラグ**:
```
Use a specific session ID for the conversation (must be a valid UUID)
Example: claude --session-id "550e8400-e29b-41d4-a716-446655440000"
```

**重要**: これらのオプションは異なる目的を持つため、**通常は一緒に使用しません**。

#### 正しい使用パターン

**パターン1: プリントモードで1回のクエリ実行(セッション不要)**
```bash
claude -p "セッションIDを指定してセッションを作ってpオプションで再開できるかテストする"
```

**パターン2: セッションを指定して対話モードで開始**
```bash
claude --session-id "550e8400-e29b-41d4-a716-446655440000"
```

**パターン3: セッションを再開**
```bash
claude -r "session-name"
# または
claude --resume "550e8400-e29b-41d4-a716-446655440000"
```

**ベストプラクティス**:
- プリントモードは通常、セッション管理不要の1回限りのクエリに使用
- セッション管理が必要な場合は対話モードを使用
- `-p`と`--session-id`の組み合わせは非標準的な使用方法

**注意点**:
- `--session-id`は有効なUUID形式である必要がある
- 同じセッションIDは同時に複数使用できない

### 4. 問題を解決するための対策

**ユーザーの実行コマンドの問題点**:
```bash
claude -p "セッションIDを指定してセッションを作ってpオプションで再開できるかテストする" --session-id B1234567-1234-1234-1234-123456789ADF
```

**推奨される解決策**:

#### 解決策1: セッションIDを使わずプリントモードのみ使用

```bash
claude -p "テストクエリ"
```

このシンプルな形式で、プリントモードの動作を確認できます。

#### 解決策2: フラグの順序を変更

```bash
claude -p --session-id "B1234567-1234-1234-1234-123456789ADF" "セッションIDを指定してセッションを作ってpオプションで再開できるかテストする"
```

フラグを先に配置し、プロンプトを最後にすることで、パース順序の問題を回避できる可能性があります。

#### 解決策3: セッション管理が必要な場合は対話モードを使用

```bash
# 最初のセッション作成(セッションIDを指定)
claude --session-id "550e8400-e29b-41d4-a716-446655440000"

# 後で再開
claude --resume "550e8400-e29b-41d4-a716-446655440000"
```

#### 解決策4: 既存セッションのクリーンアップ

フリーズしたセッションが残っている場合:

```bash
# セッション一覧を確認
/sessions

# 不要なセッションを削除(インタラクティブモード内で)
/delete <session-name>
```

または、セッションデータベースから直接削除することも可能です(上級者向け)。

**フリーズした場合の対処**:
1. `Ctrl+C`を押して現在の操作をキャンセル
2. 応答がない場合は、ターミナルを閉じて再起動
3. セッションが残っている場合は削除してから再試行

## 参照ドキュメント

相談で参照した公式ドキュメント:

- [CLI Reference - Claude Code Documentation](https://code.claude.com/docs/en/cli-reference.md)
- [Interactive Mode - Claude Code Documentation](https://code.claude.com/docs/en/interactive-mode.md)
- [Troubleshooting - Claude Code Documentation](https://code.claude.com/docs/en/troubleshooting.md)
- [Common Workflows - Claude Code Documentation](https://code.claude.com/docs/en/common-workflows.md)

## 次のアクション

1. **シンプルなプリントモードのテスト**: まず`claude -p "test"`のような単純なコマンドで動作確認
2. **セッション管理の理解**: `-p`とセッション管理は別の目的であることを理解する
3. **フリーズ時の対処法を確認**: `Ctrl+C`やターミナル再起動の手順を把握
4. **問題が継続する場合**: `/bug`コマンドでバグレポートを作成

## まとめ

`-p`オプションと`--session-id`オプションの組み合わせは非標準的な使用方法であり、意図した動作をしない可能性があります。通常は:

- **プリントモード**: 1回限りのクエリに使用(セッション不要)
- **セッション管理**: 対話モードで継続的な会話に使用

この2つは別々に使用するのが推奨されます。

---

*このレポートは `/guide-chat` コマンドにより自動生成されました*
