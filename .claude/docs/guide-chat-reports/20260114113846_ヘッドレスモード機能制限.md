# Claude Code ガイド相談レポート

**日付**: 2026年01月14日
**トピック**: ヘッドレスモード（`claude -p`）での各種機能の使用可否

## 相談内容

- `claude -p` でヘッドレスに実行した場合、skills、commands、subagentsなどのClaude Code各種機能に制限があるか？
- それぞれの機能が使用可能かどうか
- ヘッドレスモードでの回避策やベストプラクティス

## 重要な結論・学び

### 機能使用可否の全体像

Claude Codeのヘッドレスモード（`claude -p`）では、**機能によって使用可否が大きく異なります**。

| 機能 | 使用可否 | 備考 |
|-----|---------|------|
| **Subagents** | ✓ 使用可能 | `--agents` フラグで動的定義が必要 |
| **Skills** | ✗ 使用不可 | 自動検出メカニズムが制限される |
| **Slash Commands** | ✗ 使用不可 | インタラクティブモード専用 |

---

### 1. Subagents（サブエージェント）- ✓ 使用可能

**結論**: ヘッドレスモードでも`--agents` フラグを使用すれば完全に機能します。

> 出典: [CLI Reference - agents flag](https://code.claude.com/docs/en/cli-reference.md)

**使用例**:

```bash
claude -p --agents '{
  "code-reviewer": {
    "description": "Expert code reviewer",
    "prompt": "You are a senior code reviewer...",
    "tools": ["Read", "Grep", "Glob", "Bash"],
    "model": "sonnet"
  }
}' "Review this code for issues"
```

**ベストプラクティス**:
- JSON形式で動的にエージェント定義を渡す
- 必要なツールのみを`tools`配列で指定
- `description`を明確に記述してエージェントの役割を定義
- 適切なモデル（`sonnet`, `haiku`, `opus`）を選択

**注意点**:
- `.claude/agents/`に定義されたファイルベースのサブエージェントは、ヘッドレスモードでの動作が要確認
- 自動化スクリプトでは`--agents`フラグで動的定義する方が確実

---

### 2. Skills（スキル）- ✗ 使用不可

**結論**: ヘッドレスモードではスキルの自動検出メカニズムが制限されるため、実質的に使用できません。

> 出典: [Skills Documentation](https://code.claude.com/docs/en/skills.md)

公式ドキュメントの記述：
> "Skills are **model-invoked**: Claude decides which Skills to use based on your request."

**制限の理由**:
- スキルは自動検出メカニズムに依存している
- ヘッドレスモードではこのメカニズムが制限される
- スキルのメタデータが完全にロードされない可能性がある

**回避策**:
- スキルの機能を`--agents`フラグでサブエージェントとして再実装する
- タスクを直接プロンプトに詳細に記述する
- インタラクティブモードを使用する

---

### 3. Slash Commands（スラッシュコマンド）- ✗ 使用不可

**結論**: ヘッドレスモードでは使用できません。インタラクティブモード専用の機能です。

> 出典: [Headless Mode Documentation](https://code.claude.com/docs/en/headless.md)

公式ドキュメントの記述：
> "Slash commands like `/commit` are only available in interactive mode. In `-p` mode, describe the task you want to accomplish instead."

**使用不可の例**:
```bash
# これは動作しない
claude -p "/commit"
```

**代替方法**:
```bash
# タスクを直接プロンプトで記述
claude -p "Review my staged changes and create a commit message"
```

**ベストプラクティス**:
- スラッシュコマンドの代わりに、実行したいタスクを自然言語で詳細に記述
- 具体的な指示を含める（例: "Create a commit with a descriptive message following conventional commits format"）
- 必要に応じて`--allowedTools`フラグで使用可能なツールを制限

---

## ヘッドレスモードでのベストプラクティス

ヘッドレスモード（`-p`）で自動化やスクリプト化する場合の推奨アプローチ：

### 1. Subagentsを活用する

`--agents` フラグで動的にエージェントを定義し、専門的なタスクを委譲します。

```bash
claude -p --agents '{
  "validator": {
    "description": "CSV validator",
    "prompt": "Validate CSV files against schema",
    "tools": ["Read", "Bash"],
    "model": "haiku"
  }
}' "Validate all CSV files in ./data"
```

### 2. CLIフラグで制御する

公式のCLIフラグを活用して動作を制御します：

- `--allowedTools` - 使用可能なツールを制限
- `--output-format` - 出力形式を指定（json, text）
- `--system-prompt` - システムプロンプトをカスタマイズ
- `--max-turns` - 最大ターン数を制限

> 出典: [CLI Reference](https://code.claude.com/docs/en/cli-reference.md)

### 3. プロンプトで明示的に指示する

タスクを直接プロンプトに含め、期待する動作を明確に記述します。

```bash
claude -p "Analyze the code in src/app.ts and:
1. Identify potential security vulnerabilities
2. Suggest improvements for performance
3. Output findings in JSON format"
```

### 4. Agent SDKの使用を検討

より複雑な自動化や高度な制御が必要な場合は、Agent SDKの使用が推奨されます。

> 出典: [Headless Mode - Next Steps](https://code.claude.com/docs/en/headless.md)

Agent SDKを使用すると：
- プログラマティックに完全な制御が可能
- カスタムツールの追加が容易
- 複雑なワークフローの実装が可能

---

## 参照ドキュメント

各トピックで参照した公式ドキュメントのURL一覧：

- [CLI Reference](https://code.claude.com/docs/en/cli-reference.md) - CLIフラグと`--agents`の詳細
- [Headless Mode](https://code.claude.com/docs/en/headless.md) - ヘッドレスモードの制限と使用方法
- [Skills Documentation](https://code.claude.com/docs/en/skills.md) - スキルの仕組みと制限
- [Subagents Configuration](https://code.claude.com/docs/en/sub-agents.md) - サブエージェントの設定
- [Agent SDK Overview](https://platform.claude.com/docs/en/agent-sdk/overview) - プログラマティック実行の詳細

---

## 次のアクション

今後試してみるべきこと：

1. **Subagentsの動的定義を試す** - `--agents`フラグでカスタムエージェントを定義し、実際のタスクで検証
2. **ファイルベースのSubagentsの動作確認** - `.claude/agents/`に定義されたエージェントがヘッドレスモードで動作するか検証
3. **Agent SDKへの移行を検討** - 複雑な自動化タスクにはAgent SDKの使用を検討
4. **CIパイプラインでの活用** - ヘッドレスモードを使ったCI/CDパイプラインの実装

---

*このレポートは `/guide-chat` コマンドにより自動生成されました*
