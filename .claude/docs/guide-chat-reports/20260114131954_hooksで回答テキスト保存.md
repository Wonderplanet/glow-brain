# Claude Code ガイド相談レポート

**日付**: 2026年01月14日
**トピック**: Hooksを使ったClaude回答テキストの保存方法

## 相談内容

- Claude Codeのhooksを使って、ユーザープロンプトに対するClaudeの回答テキストを完全な形で欠損なく抽出・保存する方法
- Hooks以外の代替手段（CLI、ツール等）の検討

## 重要な結論・学び

### Hooksで直接実現することの制限

**Stop イベントでは回答テキストが直接取得できない**

公式ドキュメントによると、Stopイベント（Claude回答完了時）のHook Inputには、Claudeの回答テキストそのものが含まれていません。

> 出典: [Hooks reference - Stop and SubagentStop Input](https://code.claude.com/docs/en/hooks.md#stop-and-subagentStop-input)

**Stop イベントで取得できる情報**:
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../00893aaf-19fa-41d2-8238-13269b9b3ca0.jsonl",
  "permission_mode": "default",
  "hook_event_name": "Stop",
  "stop_hook_active": true
}
```

回答テキストは含まれていませんが、`transcript_path`が含まれており、これを活用した迂回策が可能です。

### トランスクリプトパスを使った迂回策

**Stop hook + トランスクリプトファイル読み込み**

TranscriptファイルはJSONL形式で、ユーザープロンプトとClaudeの全回答が記録されています。このファイルを読み込んで回答を抽出できます。

**実装例（save-response.sh）**:
```bash
#!/bin/bash

INPUT=$(cat)
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path')
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')

if [ -f "$TRANSCRIPT_PATH" ]; then
  # JSONLから最後のアシスタント回答を抽出
  RESPONSE=$(tail -100 "$TRANSCRIPT_PATH" | \
    jq -r 'select(.role == "assistant" or .type == "assistant") | .content // .text' | \
    tail -1)

  OUTPUT_DIR="${CLAUDE_PROJECT_DIR}/.claude/responses"
  mkdir -p "$OUTPUT_DIR"

  echo "$RESPONSE" > "$OUTPUT_DIR/${SESSION_ID}.txt"
  echo "✓ Response saved: $OUTPUT_DIR/${SESSION_ID}.txt"
fi

exit 0
```

**settings.json設定例**:
```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "\"$CLAUDE_PROJECT_DIR\"/.claude/hooks/save-response.sh"
          }
        ]
      }
    ]
  }
}
```

> 出典: [Hooks reference](https://code.claude.com/docs/en/hooks.md)

**ベストプラクティス**:
- トランスクリプトファイルは必ず存在確認してから読み込む
- jqを使ってJSON解析を行う（堅牢性が高い）
- セッションIDやタイムスタンプでファイル名を一意にする

**注意点**:
- トランスクリプトファイルはJSONL形式（1行1JSON）のため、tail等で末尾を読むか、全体を読み込んで最後のアシスタント回答を抽出する必要がある
- 複数のアシスタント回答がある場合、最後のものを取得するロジックが必要

### Headless モード（推奨）

**最も確実で欠損のない方法**

Headless モードを使えば、Claudeの回答をパイプで直接取得できるため、欠損のリスクが最小です。

> 出典: [Headless documentation](https://code.claude.com/docs/en/headless.md)

**コード例**:
```bash
# プロンプトを送信して、回答をファイルに保存
echo "あなたの質問" | claude > ~/claude-responses/response.txt

# または、JSONで構造化出力を取得
echo "質問" | claude --output json | jq '.response' > ~/responses/response.json
```

**ベストプラクティス**:
- パイプを使った直接的な入出力で欠損リスクを最小化
- JSON出力を使えば構造化データとして保存可能
- 既存のシェルスクリプトやワークフローに組み込みやすい

**注意点**:
- Headless モードはClaude Code CLIの対話セッション外で動作する
- 対話的なClaude Code CLIセッション内での回答保存には向かない（別プロセスとして実行）

### セキュリティに関する重要な注意

公式ドキュメントでは、Hooksのセキュリティリスクについて明確に警告しています。

> Hooks execute arbitrary shell commands on your system automatically. Malicious or poorly written hooks can cause data loss or system damage.

> 出典: [Hooks - Security Considerations](https://code.claude.com/docs/en/hooks.md#security-considerations)

**セキュリティベストプラクティス**:
- Hookスクリプトは必ず信頼できるソースから取得する
- 実行前にスクリプトの内容を確認する
- 不要な権限（sudo等）は使わない
- 定期的にHook設定を見直す

## 方法の比較

| 方法 | 可行性 | 欠損リスク | 複雑度 | 用途 |
|-----|------|--------|------|-----|
| **Hooks + トランスクリプト読み込み** | ✓ 可能 | 低～中 | 中 | 対話セッション内での自動保存 |
| **Headless モード** | ✓ 推奨 | 最小 | 低 | スクリプト化、バッチ処理 |
| **Hook の Stop イベント直接取得** | ✗ 不可 | - | - | - |

## 推奨方針

1. **最も信頼性が高い**: Headless モード（`claude ... > file.txt`）
   - 欠損リスクが最小
   - シンプルで理解しやすい
   - 既存のワークフローに統合しやすい

2. **Claude Code CLI内で実現したい**: Stop hook + トランスクリプト解析
   - 対話セッション内で自動的に回答を保存したい場合に有効
   - トランスクリプトファイル読み込みが必要（やや複雑）

## 参照ドキュメント

各トピックで参照した公式ドキュメントのURL一覧：

- [Hooks reference](https://code.claude.com/docs/en/hooks.md)
- [Hooks guide - Quickstart](https://code.claude.com/docs/en/hooks-guide.md)
- [Headless mode](https://code.claude.com/docs/en/headless.md)

## 次のアクション

- Stop hookとトランスクリプト読み込みの実装を試す
- Headless モードでの自動化スクリプトを検討
- 保存先ディレクトリの構成を設計（日付別、セッション別など）
- セキュリティ面でのHookスクリプトのレビュー体制を整える

---

*このレポートは `/guide-chat` コマンドにより自動生成されました*
