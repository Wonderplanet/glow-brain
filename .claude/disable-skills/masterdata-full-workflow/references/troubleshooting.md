# トラブルシューティングガイド

## よくある問題と解決方法

### ステップ1: 要件ファイル構成生成が失敗する

**症状**:
- `要件ファイル構成.md`が生成されない
- エラーメッセージが表示される

**確認項目**:
1. 要件フォルダが存在するか
   ```bash
   ls -la マスタデータ/施策/[施策名]/要件/
   ```

2. 要件フォルダ内にファイルが存在するか
   ```bash
   find マスタデータ/施策/[施策名]/要件/ -type f
   ```

3. ファイルが読み取り可能か
   ```bash
   ls -l マスタデータ/施策/[施策名]/要件/
   ```

**解決方法**:
- 要件フォルダが存在しない場合: フォルダを作成し、仕様書ファイルを配置
- ファイルが読み取り不可の場合: 権限を修正 `chmod 644 <ファイル>`

### ステップ2: コンテンツタイプが識別されない

**症状**:
- `identify_content_types.py`の実行結果が空
- 「コンテンツタイプが識別されませんでした」と表示される

**確認項目**:
1. 要件ファイル構成.mdが生成されているか
   ```bash
   cat マスタデータ/施策/[施策名]/要件ファイル構成.md
   ```

2. ファイル名パターンが識別パターンに合致しているか
   - 要件ファイル構成.mdの内容を確認
   - `scripts/content_type_patterns.json`のパターンと比較

**解決方法**:
- パターンが合致しない場合: `content_type_patterns.json`を更新
- 手動でコンテンツタイプを指定する場合: ステップ3で直接コンテンツタイプを指定

**警告として扱う**:
- コンテンツタイプが識別できなくても、スキルは警告を出して継続します
- 必要に応じて手動でコンテンツタイプを指定してsubagentを起動できます

### ステップ3: subagent起動が失敗する

**症状**:
- subagentがエラーで終了する
- CSVファイルが生成されない

**確認項目**:
1. content-masterdata-generator subagentが存在するか
   ```bash
   ls -la .claude/subagents/content-masterdata-generator/
   ```

2. subagentの引数が正しいか
   - `content_type`: コンテンツタイプ名
   - `施策ディレクトリ`: 正しいパス

3. 一部のsubagentが失敗しても、他のsubagentは継続実行されるか

**解決方法**:
- subagentが存在しない場合: subagentを作成
- 引数が誤っている場合: 正しい引数で再実行
- 一部失敗の場合: 失敗したコンテンツタイプのみ再実行

### ステップ4: 統合REPORTに「未作成のマスタデータ」がある

**症状**:
- REPORT.mdに「未作成のマスタデータ」セクションが存在する
- 一部のCSVファイルが生成されていない

**これはエラーです**: 以下を確認してください

**確認項目**:
1. 該当するsubagentが正常に完了したか
   - subagentのログを確認
   - エラーメッセージがないか確認

2. subagent内でmasterdata-generatorスキルが途中で停止していないか
   - generatorスキルのログを確認
   - 「途中で止めない」原則が守られているか確認

3. 不明点を推測して実装を続けているか
   - 既存データのパターンから推測しているか
   - 質問せずに実装を継続しているか

**正しい動作**:
- 各subagent内でgeneratorスキルは途中で止めずに最後まで実行
- 不明点は既存データのパターンから推測して実装継続
- REPORTに「未作成のマスタデータ」セクションを作成しない

**解決方法**:
- 該当するsubagentを再実行し、全マスタデータを生成
- generatorスキルに「途中で止めない」指示を明示
- 不明点がある場合は、既存データのパターンを参照するよう指示

### 一般的なエラーハンドリング

**ステップ1でエラー**:
- ステップ2には進まない
- エラー内容を確認し、修正後に再実行

**ステップ2でコンテンツタイプが識別できない**:
- 警告を出して継続
- 手動でコンテンツタイプを指定可能

**ステップ3で一部のsubagentが失敗**:
- 他のsubagentは継続実行
- 失敗したsubagentのみ再実行

**ステップ4で部分的な失敗**:
- 統合REPORT.mdに失敗内容を記録
- 完了したコンテンツタイプの結果は保持

## デバッグ方法

### スクリプトの手動実行

コンテンツタイプ識別スクリプトを手動で実行してデバッグ:

```bash
python3 .claude/skills/masterdata-full-workflow/scripts/identify_content_types.py \
  マスタデータ/施策/[施策名]/要件ファイル構成.md \
  --output text
```

JSON形式で詳細を確認:

```bash
python3 .claude/skills/masterdata-full-workflow/scripts/identify_content_types.py \
  マスタデータ/施策/[施策名]/要件ファイル構成.md \
  --output json
```

### パターンファイルのカスタマイズ

`scripts/content_type_patterns.json`を編集してパターンを追加:

```json
{
  "patterns": {
    "new_type": {
      "keywords": ["新しいパターン", "別のキーワード"],
      "description": "新しいコンテンツタイプの説明"
    }
  }
}
```

### ログの確認

各subagentのログを確認して問題を特定:

1. subagentの実行ログを確認
2. エラーメッセージを特定
3. 該当する処理を再実行

## パフォーマンス最適化

### 並列実行の最大化

- ステップ3で複数のsubagentを同時に起動することで、処理時間を短縮
- 単一メッセージで複数のTask呼び出しを行う

### コンテキスト肥大化の防止

- 各subagentは独立したセッションで動作
- 親スキルのコンテキストには部分REPORTのみを返却
- CSVファイルは施策ディレクトリに直接保存

## サポート

問題が解決しない場合:

1. エラーメッセージとログを保存
2. 再現手順を記録
3. 開発チームに問い合わせ
