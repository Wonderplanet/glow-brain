---
name: masterdata-generator
description: 要件に基づいてマスタデータを生成。スキーマ調査、CSV生成、検証、レポート作成を一括実行。マスタデータを生成、マスタデータ作成で使用。
allowed-tools: Read, Write, Bash, Skill, TodoWrite, Task
argument-hint: 要件の説明
---

# マスタデータ 生成スキル

このスキルは、要件に基づいてマスタデータを生成します。スキーマ調査、CSV生成、検証、レポート作成を一括実行します。

マスタデータ-2プロンプトの内容を完全に実装しています。

## ⚠️ タスク完遂の原則

**このタスクは、要件に含まれる全てのマスタデータを最後まで作り切ることが目的です。**

### 絶対に守るべきルール

1. **途中で止めない**: 一部のデータだけ作成して報告書を書いて終了するのは禁止
2. **完了条件**: REPORTの「未作成のマスタデータ」セクションが**ゼロ**になるまで作業を継続
3. **不確実性への対処**:
   - 仕様が不明確でも、既存データのパターンから推測して実装を続ける
   - 立ち止まって確認を求めるのではなく、最も合理的なアプローチを推測して継続
4. **段階的完了の禁止**: 「コアデータだけ先に作る」という段階的アプローチは取らない
5. **全体実装**: 要件に含まれる全てのマスタデータを1回のタスクで完成させる

### タスク完了の定義

以下の条件を**全て**満たすまで作業を継続してください:
- ✅ 要件に記載された全てのマスタデータが生成されている
- ✅ REPORTの「未作成のマスタデータ」セクションが存在しない、または空である
- ✅ 全てのCSVファイルが適切な形式で保存されている
- ✅ データ整合性チェックが全て完了している

## 入力

要件の説明を受け取ります:
- 例: 「新春限定ガチャを追加したい。期間は2026年1月1日〜1月31日。10連ガチャで1回確定報酬あり。」

## 出力

以下のファイルを生成します:
- **CSVファイル**: `マスタデータ/施策/[施策名]/[ModelName].csv`
- **REPORTファイル**: `マスタデータ/施策/[施策名]/REPORT.md`

## タスク

以下のステップに従って、マスタデータを生成してください:

### 1. 要件の理解と分析

ユーザーから提供された要件を分析し、以下を明確にします:

- **データの目的**: 何のためのマスタデータか（例: 新ガチャ、新イベント、新キャラクター）
- **対象となるマスタデータ**: どのモデル（Mst/Opr）を使用するか（**全て洗い出す**）
- **データ量**: 何件のレコードが必要か
- **関連データ**: 他のマスタデータとの関連性（**漏れなくリストアップ**）

⚠️ **注意**: この段階で必要な全てのマスタデータをリストアップしてください。後で「未作成」として残すのは避けてください。

**TodoWriteでタスクを管理**:
```
TodoWrite([
  {"content": "要件を分析してマスタデータリストを作成", "status": "in_progress", ...},
  {"content": "<ModelName1>.csv を生成", "status": "pending", ...},
  {"content": "<ModelName2>.csv を生成", "status": "pending", ...},
  ...
])
```

### 2. 既存データ構造の調査

**必須**: 必ず以下のスキルを使用してスキーマ情報を調査してください:

```
Skill(skill: "masterdata-schema-inspector", args: "<ModelName>")
```

このスキルで取得する情報:
- テーブル名（PascalCase → snake_case + 複数形）
- カラム定義（型、NULL可否、デフォルト値、ENUM選択肢）
- CSVテンプレートファイルの構造
- 既存マスタデータのパターン

**CSVテンプレートファイルの取得（最優先）**:

**重要**: CSV作成時は必ず対応するテンプレートファイルをコピーして使用してください:

```bash
# テンプレートファイルをコピー
cp projects/glow-masterdata/sheet_schema/[ModelName].csv マスタデータ/施策/[施策名]/[ModelName].csv
```

テンプレートファイルの構造:
- 1行目: `memo`（説明用）
- 2行目: `TABLE,モデル名,モデル名,...`（各カラムが所属するテーブル）
- 3行目: `ENABLE,カラム1,カラム2,...`（実際のヘッダー）

**テンプレートファイルのヘッダー（3行目）に完全に従ってデータを作成してください。**

### 3. データの設計

調査結果に基づき、以下を設計します:

- **データスキーマ**: カラム定義と型
- **データ内容**: 要件を満たす具体的な値
- **整合性**: 既存データとの整合性（IDの重複回避、外部キー制約など）
- **命名規則**: asset_keyやidの命名パターンに従う

⚠️ **注意**:
- 不明確な仕様があっても、既存データのパターンから推測して設計を進めてください
- 「仕様が不明なので作成しない」という判断は避け、合理的な推測で実装してください
- 全てのマスタデータに対して設計を完了させてください

### 4. CSVファイルの生成

設計に基づいて**全ての**CSVファイルを生成します:

```csv
ENABLE,id,column1,column2,...
e,value1,value2,value3,...
e,value1,value2,value3,...
```

**重要な注意事項**:
- IDは既存データと重複しないこと
- `__NULL__`の使用ルール:
  - **nullable列のみ**: `__NULL__` を使用可能
  - **NOT NULL列**: 空文字列（何も書かない）またはデフォルト値を使用
  - スキーマのnullable制約を必ず確認すること
- 日時カラムは`YYYY-MM-DD HH:MM:SS`形式
- release_keyは最新の日付（例: 202601010）を使用

**ファイルの保存**:
```
マスタデータ/施策/[施策名]/[ModelName].csv
```

### 5. DDLスキーマとの整合性チェックと自動修正

**必須**: 全てのCSVファイルを生成した後、以下のスキルで検証してください:

```
Skill(skill: "masterdata-validator", args: "<csv_file_path> <ModelName>")
```

このスキルで実施される検証:
- 6-1. スキーマJSONファイルの参照
- 6-2. カラムの存在確認
- 6-3. データ型の検証（ENUM、INT、DATETIME）
- 6-4. 制約の検証（PRIMARY KEY、UNIQUE、NOT NULL）
- 6-5. 自動修正の実施
- 6-6. 修正ログの出力

修正ログを記録して、後でREPORTに含めてください。

### 6. 生成レポートの作成

**全てのマスタデータを生成した後に**、データ生成結果をMarkdown形式でレポートします:

```
マスタデータ/施策/[施策名]/REPORT.md
```

⚠️ **重要**: レポートを書く前に、要件に含まれる全てのマスタデータが生成されていることを確認してください。

レポートには以下を含めてください:

```markdown
# マスタデータ生成レポート

## 要件概要
[ユーザーが指定した要件の要約]

## 生成データ一覧

### [ModelName1].csv
- **レコード数**: X件
- **主要カラム**: column1, column2, ...
- **データ概要**: [簡潔な説明]

### [ModelName2].csv
- **レコード数**: X件
- **主要カラム**: column1, column2, ...
- **データ概要**: [簡潔な説明]

## データ設計の詳細

### ID範囲
- [ModelName1]: [開始ID] ~ [終了ID]
- [ModelName2]: [開始ID] ~ [終了ID]

### 命名規則
- IDパターン: [説明]
- asset_keyパターン: [説明]

### 参照した既存データ
- [既存ファイル名1]: [参照目的]
- [既存ファイル名2]: [参照目的]

## スキーマ検証と修正

[masterdata-validator スキルで実施したスキーマ検証の結果をここに記載]

### [ModelName1].csv
- ✅ スキーマチェック完了: 問題なし

### [ModelName2].csv
- ⚠️ 修正内容:
  - [修正内容を具体的に記載]

## データ整合性チェック

- [x] **スキーマJSONとの整合性を確認**
- [x] **CSVテンプレートファイルのヘッダーに完全に従っている**
- [x] IDの重複がないことを確認
- [x] 必須カラムがすべて埋まっている
- [x] 日時形式が正しい
- [x] 外部キー制約を満たしている
- [x] 命名規則に準拠している
- [x] ENUM型の値が許可された値のみであることを確認
- [x] データ型が正しいことを確認
- [x] **要件に含まれる全てのマスタデータが生成されている**

## 備考
[その他の重要な情報や注意事項]
```

⚠️ **レポートに関する重要な注意**:
- レポートに「未作成のマスタデータ」セクションを作成してはいけません
- 全てのマスタデータが完成してからレポートを書いてください
- もし途中で不明点がある場合は、既存データのパターンから推測して実装を続けてください

## ベストプラクティス

### タスク完遂の徹底 🎯
- **完全実装**: 要件に含まれる全てのマスタデータを1回のタスクで完成させる
- **途中終了の禁止**: 一部だけ作成して報告書を書いて終了しない
- **不確実性への対処**: 不明点があっても既存パターンから推測して実装を続ける
- **段階的完了の回避**: 「まずコアデータだけ」という段階的アプローチは取らない
- **完了条件の遵守**: REPORTに「未作成」が残らないようにする

### データ品質
- **DDLスキーマ準拠**: サーバー側のテーブル定義と完全に一致させる
- **整合性**: 既存データと矛盾しない
- **完全性**: 必須カラムはすべて埋める
- **妥当性**: 値の範囲やフォーマットが正しい
- **一貫性**: 命名規則やパターンを統一
- **制約遵守**: PRIMARY KEY、UNIQUE、NOT NULL制約を満たす

### CSVテンプレートの活用 ✨
- **最優先ルール**: CSVファイルは必ずテンプレートファイルをコピーして作成する
- **ヘッダー厳守**: テンプレートファイルの3行目（ヘッダー行）に完全に従う
- **テンプレートの構造理解**: 1行目（memo）、2行目（TABLE指定）、3行目（ヘッダー）を把握する
- **カラム追加禁止**: テンプレートにないカラムを独自に追加しない

### スキーマ検証の徹底 ⚠️
- **必須ステップ**: CSV生成後、必ずmasterdata-validatorスキルで検証する
- **自動修正**: 不正なカラムは自動削除、不足カラムは自動追加
- **データ型チェック**: ENUM、INT、DATETIME型の値を厳密に検証
- **制約チェック**: PRIMARY KEY重複、UNIQUE違反、NOT NULL違反を検出
- **修正ログ**: 全ての修正内容をREPORTに記録

## 重要な注意事項

### タスク完遂に関する重要事項 ⚠️
- **絶対にやってはいけないこと**:
  - ❌ 一部のマスタデータだけ作成して報告書を書いて終了する
  - ❌ 「未作成のマスタデータ」セクションをREPORTに追加する
  - ❌ 不明点があるからといって作業を途中で止める
  - ❌ 「まずコアデータだけ」という段階的アプローチ
- **必ずやるべきこと**:
  - ✅ 要件に含まれる全てのマスタデータを完成させる
  - ✅ 不明点は既存データから推測して実装を続ける
  - ✅ REPORTを書く前に全データが揃っていることを確認する
  - ✅ データ整合性チェックを全て完了させる

## 依存スキル

このスキルは以下のスキルに依存します:

- `masterdata-schema-inspector`: スキーマ情報の調査
- `masterdata-validator`: CSV検証と自動修正

## ディレクトリ構造

```
マスタデータ/
└── 施策/
    └── [施策名]/
        ├── 要件/                  ← ユーザーが事前に用意
        ├── 要件ファイル構成.md     ← 別スキルで生成済み
        ├── REPORT.md              ← このスキルで生成
        ├── [ModelName1].csv       ← このスキルで生成
        └── [ModelName2].csv       ← このスキルで生成
```

## 使用例

### 基本的な使用方法

スキルを起動:
```
Skill(skill: "masterdata-generator", args: "新春限定ガチャを追加。期間は2026年1月1日〜1月31日。10連ガチャで1回確定報酬あり。")
```

### 期待される動作

1. 要件を分析してマスタデータをリストアップ
2. TodoWriteで進捗管理
3. 各マスタデータに対して:
   - schema-inspectorでスキーマ調査
   - テンプレートファイルをコピー
   - CSVデータを生成
   - validatorで検証
4. REPORT.mdを生成
5. 全成果物の確認

---

このスキルを使用することで、マスタデータを効率的に生成できます。
