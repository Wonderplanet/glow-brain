---
name: masterdata-full-workflow
description: 施策のマスタデータ生成フルワークフロー。要件分析→コンテンツタイプ別並列生成→統合を一括実行。マスタデータフル実行、施策のマスタデータを作成で使用。
allowed-tools: Skill, Task, Read, Write
argument-hint: 施策ディレクトリパス
---

# マスタデータ フル実行ワークフロー

このスキルは、施策のマスタデータ生成フルワークフローを実行します。要件ファイル構成の分析→マスタデータ生成までを1回の実行で完遂します。

マスタデータ-0プロンプトの内容を完全に実装しています。

## 前提条件

このワークフローを実行する前に、以下の準備が必要です:

```
マスタデータ/施策/[施策名]/
└── 要件/    ← ユーザーが仕様書ファイルを事前に配置
```

## 入力

施策ディレクトリパスを受け取ります:
- 例: `マスタデータ/施策/新春ガチャ`

## 出力

以下のファイルを生成します:
- **要件ファイル構成.md**: 要件フォルダの構造分析結果
- **CSVファイル群**: 全てのマスタデータCSV
- **REPORT.md**: データ生成レポート

## タスク

指定された施策ディレクトリに対して、以下の4つのステップを**順番に実行**してください:

### ステップ1: 要件ファイル構成ドキュメントの生成

`masterdata-requirement-analyzer` スキルを実行してください:

```
Skill(skill: "masterdata-requirement-analyzer", args: "<施策ディレクトリパス>")
```

これにより、`[施策ディレクトリ]/要件ファイル構成.md` が生成されます。

**処理内容**:
- `[施策ディレクトリ]/要件/` フォルダ内のファイルを分析
- ファイル構造と関係性をまとめた`要件ファイル構成.md`を生成
- 施策ディレクトリ直下に保存

### ステップ2: コンテンツタイプの識別

`要件ファイル構成.md`を読み込み、以下のパターンマッチングでコンテンツタイプを識別してください:

```
Read(file_path: "<施策ディレクトリ>/要件ファイル構成.md")
```

**識別パターン**:
- `"06_ガシャ"` or `"ガシャ.*設計書"` or `"ピックアップガシャ"` → **gacha** (ガチャ系)
- `"03_降臨バトル"` → **battle** (バトル系)
- `"04_ミッション"` → **mission** (ミッション系)
- `"07_ショップ"` or `"パック.*設計書"` → **shop** (ショップ/パック系)
- `"交換所"` → **exchange** (交換所系)

識別結果の例: `["gacha", "battle", "mission"]`

### ステップ3: コンテンツ別subagentの並列起動

**重要**: 識別されたコンテンツタイプごとに、`content-masterdata-generator` subagentを並列起動してください。

**並列実行の方法**: 単一メッセージで複数のTask呼び出しを行います。

```
Task(subagent_type: "content-masterdata-generator",
     description: "ガチャ関連マスタデータ生成",
     prompt: "content_type: gacha\n施策ディレクトリ: <施策ディレクトリパス>")

Task(subagent_type: "content-masterdata-generator",
     description: "バトル関連マスタデータ生成",
     prompt: "content_type: battle\n施策ディレクトリ: <施策ディレクトリパス>")

Task(subagent_type: "content-masterdata-generator",
     description: "ミッション関連マスタデータ生成",
     prompt: "content_type: mission\n施策ディレクトリ: <施策ディレクトリパス>")
```

各subagent instanceは部分REPORTを返却します。

### ステップ4: 結果の統合とREPORT生成

各subagent instanceから返却された部分REPORTを統合し、施策ディレクトリ直下に最終的な`REPORT.md`を生成してください:

```
Write(file_path: "<施策ディレクトリ>/REPORT.md", content: "...")
```

**REPORT.mdの構成**:
- 要件概要
- 生成データ一覧（全instanceの結果を統合）
- スキーマ検証と修正（全instanceの結果を統合）
- データ整合性チェック

## 重要な注意事項

### タスク完遂の原則 ⚠️

- **全てのステップを完全に実行**: ステップ1-4を必ず完遂してください
- **途中で止めない**: ステップ3では、各subagentが要件に含まれる全てのマスタデータを最後まで生成します
- **完了条件**: 統合REPORT.mdに「未作成のマスタデータ」が残らないようにしてください

### 完了の確認

以下が全て完了していることを確認してください:

#### ステップ1の成果物
- ✅ `[施策ディレクトリ]/要件ファイル構成.md` が生成されている

#### ステップ2の成果物
- ✅ コンテンツタイプが正しく識別されている

#### ステップ3の成果物
- ✅ 識別された全てのコンテンツタイプに対してsubagentが起動されている
- ✅ **全てのCSVファイルがテンプレートファイルからコピーして作成されている**
- ✅ 全てのマスタデータCSVファイルが施策ディレクトリ直下に生成されている
- ✅ 各subagentから部分REPORTが返却されている

#### ステップ4の成果物
- ✅ `REPORT.md` が施策ディレクトリ直下に生成されている
- ✅ REPORTに全コンテンツタイプの結果が統合されている
- ✅ REPORTに「未作成のマスタデータ」セクションが存在しない
- ✅ REPORTに「スキーマ検証と修正」セクションが含まれている

## 出力形式

### 最終的なディレクトリ構造

```
マスタデータ/施策/[施策名]/
├── 要件/                    ← ユーザーが事前に用意
│   ├── 仕様書1.html
│   └── 仕様書2.html
├── 要件ファイル構成.md       ← ステップ1で生成
├── REPORT.md                ← ステップ2で生成
├── [ModelName1].csv         ← ステップ2で生成
├── [ModelName2].csv         ← ステップ2で生成
└── [ModelName3].csv         ← ステップ2で生成
```

## ベストプラクティス

### 順次実行の徹底

ステップ1-4は必ず順番に実行してください:
1. ステップ1: requirement-analyzer実行
2. ステップ2: コンテンツタイプ識別
3. ステップ3: subagent並列起動（同時実行可能）
4. ステップ4: 結果統合とREPORT生成

### 並列実行の活用

- ステップ3では、複数のcontent-masterdata-generatorを並列起動します
- 単一メッセージで複数のTask呼び出しを行うことで、並列実行を実現します
- 各subagentは独立したセッションで動作し、コンテキスト肥大化を防ぎます

### エラーハンドリング

- ステップ1でエラーが発生した場合、ステップ2には進まない
- ステップ2でコンテンツタイプが識別できない場合、警告して継続
- ステップ3で一部のsubagentが失敗しても、他のsubagentは継続実行
- ステップ4で部分的な失敗を統合REPORT.mdに記録

### データ完成度の確認

ステップ4完了後、以下を確認:
- 要件に記載された全てのマスタデータが生成されている
- 統合REPORT.mdに「未作成のマスタデータ」セクションがない
- 統合REPORT.mdに「スキーマ検証と修正」セクションが含まれている

## 依存スキルとsubagent

このスキルは以下のスキルとsubagentに依存します:

**直接依存**:
- `masterdata-requirement-analyzer` (スキル): 要件ファイル構成分析
- `content-masterdata-generator` (subagent): コンテンツタイプ別マスタデータ生成

**間接的な依存** (content-masterdata-generator経由):
- `masterdata-generator` (スキル): マスタデータ生成
- `masterdata-schema-inspector` (スキル): スキーマ情報調査
- `masterdata-validator` (スキル): CSV検証

## 使用例

### 基本的な使用方法

スキルを起動:
```
Skill(skill: "masterdata-full-workflow", args: "マスタデータ/施策/新春ガチャ")
```

### 前提条件

事前に要件フォルダが準備されている:
```
マスタデータ/施策/新春ガチャ/
└── 要件/
    ├── 01_概要.html
    ├── 02_ガチャ仕様.html
    └── 03_報酬設定.html
```

### 期待される動作

1. ステップ1: 要件ファイル構成.mdを生成
2. ステップ2: コンテンツタイプ識別 (例: ["gacha"])
3. ステップ3: content-masterdata-generator subagent起動（ガチャ関連のみ）
4. ステップ4: 統合REPORT.mdを生成
5. 全成果物の確認

### 期待される出力

```
マスタデータ/施策/新春ガチャ/
├── 要件/
│   ├── 01_概要.html
│   ├── 02_ガチャ仕様.html
│   └── 03_報酬設定.html
├── 要件ファイル構成.md       ← 新規生成
├── REPORT.md                ← 新規生成
├── OprGacha.csv             ← 新規生成
├── OprGachaI18n.csv         ← 新規生成
└── MstGachaPrizeGroup.csv   ← 新規生成
```

## トラブルシューティング

### ステップ1が失敗する場合

- 要件フォルダが存在するか確認
- 要件フォルダ内にファイルが存在するか確認
- ファイルが読み取り可能か確認

### ステップ2が失敗する場合（コンテンツタイプ識別）

- 要件ファイル構成.mdが生成されているか確認
- ファイル名パターンが識別パターンに合致しているか確認
- コンテンツタイプが識別できなくても警告して継続します

### ステップ3が失敗する場合（subagent起動）

- content-masterdata-generatorsubagentが存在するか確認
- subagentの引数（content_type, 施策ディレクトリ）が正しいか確認
- 一部のsubagentが失敗しても、他のsubagentは継続実行されます

### 統合REPORTに「未作成のマスタデータ」がある場合

⚠️ これは**エラー**です。以下を確認:
- 該当するsubagentが正常に完了したか
- subagent内でmasterdata-generatorスキルが途中で停止していないか
- 不明点を推測して実装を続けているか

正しい動作:
- 各subagent内でgeneratorスキルは途中で止めずに最後まで実行
- 不明点は既存データのパターンから推測して実装継続
- REPORTに「未作成のマスタデータ」セクションを作成しない

## 注意事項

- **参照専用リポジトリ**: `projects/` 配下は参照のみ。編集しないでください。
- **全ステップ必須**: ステップ1-4を必ず完遂してください。
- **コンテキスト肥大化対策**: 複数のコンテンツタイプがある場合、各subagentは独立したセッションで動作します。
- **並列実行**: ステップ3ではsubagentを並列起動することで、効率的に処理します。
- **新規コンテンツタイプ追加**: 新しいコンテンツタイプを追加する場合は、content-masterdata-generator subagentのマッピングを更新してください。

---

このスキルを使用することで、施策のマスタデータ生成フルワークフローをコンテキスト肥大化を防ぎつつ、効率的に実行できます。
