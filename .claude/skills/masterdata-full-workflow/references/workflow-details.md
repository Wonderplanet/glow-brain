# マスタデータ生成ワークフロー詳細ガイド

## ワークフローの全体像

このスキルは4つのステップで施策のマスタデータを生成します：

1. **要件分析**: 要件フォルダ内のファイルを分析し、構成ドキュメントを生成
2. **コンテンツタイプ識別**: 要件から必要なマスタデータのタイプを自動識別
3. **並列生成**: 識別されたタイプごとにsubagentを並列起動してマスタデータを生成
4. **統合**: 各subagentの結果を統合し、最終レポートを生成

## 各ステップの詳細

### ステップ1: 要件ファイル構成ドキュメントの生成

**実行するスキル**: `masterdata-requirement-analyzer`

**入力**: 施策ディレクトリパス

**出力**: `[施策ディレクトリ]/要件ファイル構成.md`

**処理内容**:
- `[施策ディレクトリ]/要件/` フォルダ内のファイルを分析
- ファイル構造と関係性をまとめたドキュメントを生成
- 施策ディレクトリ直下に保存

### ステップ2: コンテンツタイプの識別

**使用するスクリプト**: `scripts/identify_content_types.py`

**入力**: 要件ファイル構成.md

**出力**: コンテンツタイプのリスト（例: ["gacha", "battle", "mission"]）

**識別パターン**:

| コンテンツタイプ | キーワードパターン | 説明 |
|-----------------|-------------------|------|
| gacha | `06_ガシャ`, `ガシャ.*設計書`, `ピックアップガシャ` | ガチャ関連 |
| battle | `03_降臨バトル` | バトル関連 |
| mission | `04_ミッション` | ミッション関連 |
| shop | `07_ショップ`, `パック.*設計書` | ショップ/パック関連 |
| exchange | `交換所` | 交換所関連 |

**パターンのカスタマイズ**:
- `scripts/content_type_patterns.json`を編集することで、新しいコンテンツタイプや識別パターンを追加可能

### ステップ3: コンテンツ別subagentの並列起動

**使用するsubagent**: `content-masterdata-generator`

**並列実行の仕組み**:
- 単一メッセージで複数のTask呼び出しを行うことで並列実行を実現
- 各subagentは独立したセッションで動作し、コンテキスト肥大化を防止

**各subagentへの入力**:
```
content_type: <コンテンツタイプ>
施策ディレクトリ: <施策ディレクトリパス>
```

**各subagentの出力**:
- CSVファイル群（施策ディレクトリ直下に生成）
- 部分REPORT（生成したデータの詳細）

### ステップ4: 結果の統合とREPORT生成

**処理内容**:
- 各subagentから返却された部分REPORTを収集
- `assets/REPORT_template.md`を基に統合REPORTを生成
- 施策ディレクトリ直下に`REPORT.md`として保存

**REPORTの構成**:
- 施策概要
- 要件概要
- 生成データ一覧（全コンテンツタイプ統合）
- スキーマ検証と修正（全コンテンツタイプ統合）
- データ整合性チェック
- 完了状況

## タスク完遂の原則

### 重要な方針

1. **全ステップを完全に実行**: ステップ1-4を必ず完遂する
2. **途中で止めない**: 各subagentは要件に含まれる全マスタデータを最後まで生成
3. **完了条件**: 統合REPORT.mdに「未作成のマスタデータ」が残らないようにする

### 完了チェックリスト

#### ステップ1の成果物
- ✅ `[施策ディレクトリ]/要件ファイル構成.md` が生成されている

#### ステップ2の成果物
- ✅ コンテンツタイプが正しく識別されている

#### ステップ3の成果物
- ✅ 識別された全てのコンテンツタイプに対してsubagentが起動されている
- ✅ 全てのCSVファイルがテンプレートファイルからコピーして作成されている
- ✅ 全てのマスタデータCSVファイルが施策ディレクトリ直下に生成されている
- ✅ 各subagentから部分REPORTが返却されている

#### ステップ4の成果物
- ✅ `REPORT.md` が施策ディレクトリ直下に生成されている
- ✅ REPORTに全コンテンツタイプの結果が統合されている
- ✅ REPORTに「未作成のマスタデータ」セクションが存在しない
- ✅ REPORTに「スキーマ検証と修正」セクションが含まれている

## 最終的なディレクトリ構造

```
マスタデータ/施策/[施策名]/
├── 要件/                    ← ユーザーが事前に用意
│   ├── 仕様書1.html
│   └── 仕様書2.html
├── 要件ファイル構成.md       ← ステップ1で生成
├── REPORT.md                ← ステップ4で生成
├── [ModelName1].csv         ← ステップ3で生成
├── [ModelName2].csv         ← ステップ3で生成
└── [ModelName3].csv         ← ステップ3で生成
```

## ベストプラクティス

### 順次実行の徹底

ステップ1-4は必ず順番に実行:
1. ステップ1: requirement-analyzer実行
2. ステップ2: コンテンツタイプ識別
3. ステップ3: subagent並列起動（同時実行可能）
4. ステップ4: 結果統合とREPORT生成

### 並列実行の活用

- ステップ3では、複数のcontent-masterdata-generatorを並列起動
- 単一メッセージで複数のTask呼び出しを行うことで並列実行を実現
- 各subagentは独立したセッションで動作し、コンテキスト肥大化を防止

### データ完成度の確認

ステップ4完了後、以下を確認:
- 要件に記載された全てのマスタデータが生成されている
- 統合REPORT.mdに「未作成のマスタデータ」セクションがない
- 統合REPORT.mdに「スキーマ検証と修正」セクションが含まれている

## 依存スキルとsubagent

このスキルは以下のスキルとsubagentに依存します：

**直接依存**:
- `masterdata-requirement-analyzer` (スキル): 要件ファイル構成分析
- `content-masterdata-generator` (subagent): コンテンツタイプ別マスタデータ生成

**間接的な依存** (content-masterdata-generator経由):
- `masterdata-generator` (スキル): マスタデータ生成
- `masterdata-schema-inspector` (スキル): スキーマ情報調査
- `masterdata-validator` (スキル): CSV検証

## 新しいコンテンツタイプの追加

新しいコンテンツタイプを追加する場合：

1. `scripts/content_type_patterns.json`に新しいパターンを追加
2. `content-masterdata-generator` subagentに新しいコンテンツタイプのマッピングを追加

例：
```json
{
  "patterns": {
    "event": {
      "keywords": ["イベント", "期間限定"],
      "description": "イベント関連のマスタデータ"
    }
  }
}
```
