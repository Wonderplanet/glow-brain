# 実装例: ガチャ仕様書の要件抽出・分類

このドキュメントは、ガチャ仕様書から要件を抽出・分類する実践例です。

## 元の仕様書（サンプル）

```markdown
# 限定ガチャ機能 ゲーム体験仕様書

## 背景・目的
期間限定イベント施策として新ガチャ機能を追加し、売上向上を目指す。

## 機能説明

### ガチャ実行
- ユーザーは新しい限定ガチャを引くことができる
- ガチャ結果に応じてアイテムが付与される
- 特定の条件を満たすと特別演出が発生する
- 10連ガチャの場合、最低1つはレアアイテムが確定する

### ガチャ履歴
- ガチャ実行履歴を確認できる
- 累計回数に応じて天井報酬が付与される

## 運用設計

### 運用制御
- ガチャのON/OFFは設定テーブルで切り替え可能
- 確率設定は管理画面から変更可能
- 設定変更後、即時反映される
- 緊急時にはロールバック可能

### 監視・ログ
- ガチャ実行ログを記録する
- 異常な実行パターンを検知する

## 非機能要件

### 性能
- ガチャAPI実行は500ms以内
- 同時接続1000ユーザーに耐える設計

### 安全性
- 二重実行を防止する
- 不正なリクエストを検知・遮断する
- トランザクションの一貫性を保証する

## 実装方針

### 既存実装の活用
- 既存のGachaUseCaseを拡張して実装
- 既存のuser_itemsテーブルに保存
- 既存のRewardUseCaseで報酬付与処理を実装
- 新しいテーブルは作成しない

### 制約事項
- 既存のガチャAPIとの互換性を維持する
- クライアント側の大幅な変更は避ける
- Laravel 8系で実装する
- ECS on Fargate上で動作する
```

## 抽出プロセス

### ステップ1: セクションごとに要件候補を抽出

#### 背景・目的セクション
- 「期間限定イベント施策」 → ビジネス要件
- 「売上向上を目指す」 → ビジネス要件

#### 機能説明セクション
- 「限定ガチャを引くことができる」 → 機能要件
- 「ガチャ結果に応じてアイテムが付与される」 → 機能要件
- 「特別演出が発生する」 → 機能要件
- 「10連ガチャの最低1つはレアアイテム確定」 → 機能要件
- 「ガチャ実行履歴を確認できる」 → 機能要件
- 「累計回数に応じて天井報酬が付与される」 → 機能要件

#### 運用設計セクション
- 「設定テーブルでON/OFF切り替え可能」 → 運用要件
- 「管理画面から確率設定を変更可能」 → 運用要件
- 「設定変更後、即時反映」 → 運用要件
- 「緊急時にロールバック可能」 → 運用要件
- 「ガチャ実行ログを記録」 → 運用要件
- 「異常な実行パターンを検知」 → 運用要件（またはNF-要件）

#### 非機能要件セクション
- 「ガチャAPI実行は500ms以内」 → 非機能要件
- 「同時接続1000ユーザーに耐える」 → 非機能要件
- 「二重実行を防止」 → 非機能要件
- 「不正なリクエストを検知・遮断」 → 非機能要件
- 「トランザクション一貫性保証」 → 非機能要件

#### 実装方針セクション
- 「既存GachaUseCaseを拡張」 → 実装要件
- 「既存user_itemsテーブルに保存」 → 実装要件
- 「既存RewardUseCaseで報酬付与」 → 実装要件
- 「新しいテーブルは作成しない」 → 実装要件

#### 制約事項セクション
- 「既存ガチャAPIとの互換性維持」 → 制約条件
- 「クライアント側の大幅な変更は避ける」 → 制約条件
- 「Laravel 8系で実装」 → 制約条件
- 「ECS on Fargate上で動作」 → 制約条件

## 分類結果

### Markdownテーブル形式

```markdown
# 要件分類結果: 限定ガチャ機能

## 1. 機能要件（Functional Requirement）

| No | 要件 | 説明 |
|---|---|---|
| F-1 | 限定ガチャ実行 | ユーザーは新しい限定ガチャを引くことができる |
| F-2 | アイテム付与 | ガチャ結果に応じてアイテムが付与される |
| F-3 | 特別演出 | 特定の条件を満たすと特別演出が発生する |
| F-4 | 10連レア確定 | 10連ガチャの場合、最低1つはレアアイテムが確定する |
| F-5 | ガチャ履歴確認 | ガチャ実行履歴を確認できる |
| F-6 | 天井報酬 | 累計回数に応じて天井報酬が付与される |

## 2. 非機能要件（Non-Functional Requirement）

| No | 要件 | 説明 |
|---|---|---|
| NF-1 | レスポンス時間 | ガチャAPI実行は500ms以内 |
| NF-2 | 高負荷耐性 | 同時接続1000ユーザーに耐える設計 |
| NF-3 | 二重実行防止 | 二重実行を防止する仕組みが必要 |
| NF-4 | 不正検知 | 不正なリクエストを検知・遮断する |
| NF-5 | トランザクション一貫性 | トランザクションの一貫性を保証する |

## 3. 運用要件（Operational Requirement）

| No | 要件 | 説明 |
|---|---|---|
| O-1 | 機能ON/OFF制御 | ガチャのON/OFFは設定テーブルで切り替え可能 |
| O-2 | 確率設定変更 | 確率設定は管理画面から変更可能 |
| O-3 | 即時反映 | 設定変更後、即時反映される |
| O-4 | ロールバック | 緊急時にはロールバック可能 |
| O-5 | ログ記録 | ガチャ実行ログを記録する |
| O-6 | 異常検知 | 異常な実行パターンを検知する |

## 4. 制約条件（Constraint）

| No | 要件 | 説明 |
|---|---|---|
| C-1 | API互換性維持 | 既存のガチャAPIとの互換性を維持する |
| C-2 | クライアント変更最小化 | クライアント側の大幅な変更は避ける |
| C-3 | Laravelバージョン | Laravel 8系で実装する |
| C-4 | 実行環境 | ECS on Fargate上で動作する |

## 5. 実装要件（Implementation Requirement）

| No | 要件 | 説明 |
|---|---|---|
| I-1 | GachaUseCase拡張 | 既存のGachaUseCaseを拡張して実装 |
| I-2 | 既存テーブル使用 | 既存のuser_itemsテーブルに保存 |
| I-3 | RewardUseCase流用 | 既存のRewardUseCaseで報酬付与処理を実装 |
| I-4 | 新規テーブル禁止 | 新しいテーブルは作成しない |

## 6. ビジネス要件（Business Requirement）

| No | 要件 | 説明 |
|---|---|---|
| B-1 | 期間限定イベント | 期間限定イベント施策として実施 |
| B-2 | 売上向上 | 新ガチャ機能により売上向上を目指す |

## 要約

- **機能要件**: 6件
- **非機能要件**: 5件
- **運用要件**: 6件
- **制約条件**: 4件
- **実装要件**: 4件
- **ビジネス要件**: 2件
- **合計**: 27件
```

## 分類のポイント解説

### F-4（10連レア確定）
- **判定**: 機能要件
- **理由**: ユーザー体験のルール・結果が変わる
- **注意点**: 実装ロジックではなく、ゲーム体験の仕様

### O-6（異常検知）vs NF-4（不正検知）
- **O-6（異常検知）**: 運用要件
  - 理由: 運営が異常を監視・対応できるようにする機能
- **NF-4（不正検知）**: 非機能要件
  - 理由: システムの安全性を担保する機能

**ポイント**: 似た機能でも、目的が「運営の操作性」なら運用要件、「システムの品質・安全性」なら非機能要件

### I-2（既存テーブル使用）
- **判定**: 実装要件
- **理由**: 「どう作るか」の話（既存テーブルを使う実装方針）
- **注意**: 似た記述でも「使わなければならない」という前提なら制約条件になる

**この例での判断**:
- 文脈から「実装方針」として記載されているため実装要件と判断
- もし「制約事項」セクションに記載されていたら制約条件と判断する可能性もある

## 迷った要件の判定例

### 「異常な実行パターンを検知する」

**候補:**
- 運用要件: 運営が異常を把握できる
- 非機能要件: システムの安全性を担保する

**判定:** 運用要件（O-6）

**理由:**
- 「検知する」という表現から、運営による監視・対応が主目的と判断
- もし「異常実行を自動的に遮断する」なら非機能要件（NF-4に近い）

### 「新しいテーブルは作成しない」

**候補:**
- 制約条件: 設計の選択肢を縛る前提
- 実装要件: 実装方針の指示

**判定:** 実装要件（I-4）

**理由:**
- 「実装方針」セクションに記載されている
- 「こう作るべき」という方針の指示と判断
- もし「データベース設計の制約」として記載されていれば制約条件

**文脈による判断の重要性:**
- セクション名や前後の文脈を考慮
- 同じ記述でも、文脈によって分類が変わることがある

## 複雑な要件の分解例

### 元の記述
> 「ガチャのON/OFFは設定テーブルで切り替え可能で、設定変更後、即時反映される」

### 分解後
- O-1: 機能ON/OFF制御（設定テーブルで切り替え可能）
- O-3: 即時反映（設定変更後、即時反映）

**ポイント**: 1つの文に複数の要件が含まれる場合は分解して抽出

## JSON形式の出力例

```json
{
  "functional_requirements": [
    {
      "no": "F-1",
      "name": "限定ガチャ実行",
      "description": "ユーザーは新しい限定ガチャを引くことができる"
    },
    {
      "no": "F-2",
      "name": "アイテム付与",
      "description": "ガチャ結果に応じてアイテムが付与される"
    }
  ],
  "non_functional_requirements": [
    {
      "no": "NF-1",
      "name": "レスポンス時間",
      "description": "ガチャAPI実行は500ms以内"
    },
    {
      "no": "NF-2",
      "name": "高負荷耐性",
      "description": "同時接続1000ユーザーに耐える設計"
    }
  ],
  "operational_requirements": [
    {
      "no": "O-1",
      "name": "機能ON/OFF制御",
      "description": "ガチャのON/OFFは設定テーブルで切り替え可能"
    },
    {
      "no": "O-2",
      "name": "確率設定変更",
      "description": "確率設定は管理画面から変更可能"
    }
  ],
  "constraints": [
    {
      "no": "C-1",
      "name": "API互換性維持",
      "description": "既存のガチャAPIとの互換性を維持する"
    },
    {
      "no": "C-2",
      "name": "クライアント変更最小化",
      "description": "クライアント側の大幅な変更は避ける"
    }
  ],
  "implementation_requirements": [
    {
      "no": "I-1",
      "name": "GachaUseCase拡張",
      "description": "既存のGachaUseCaseを拡張して実装"
    },
    {
      "no": "I-2",
      "name": "既存テーブル使用",
      "description": "既存のuser_itemsテーブルに保存"
    }
  ],
  "business_requirements": [
    {
      "no": "B-1",
      "name": "期間限定イベント",
      "description": "期間限定イベント施策として実施"
    },
    {
      "no": "B-2",
      "name": "売上向上",
      "description": "新ガチャ機能により売上向上を目指す"
    }
  ],
  "summary": {
    "functional_requirements": 6,
    "non_functional_requirements": 5,
    "operational_requirements": 6,
    "constraints": 4,
    "implementation_requirements": 4,
    "business_requirements": 2,
    "total": 27
  }
}
```

## まとめ

ガチャ仕様書の分類では、以下のポイントに注意しました:

1. **運用要件と非機能要件の区別**: 目的が「運営の操作性」か「システムの品質」かで判断
2. **実装要件と制約条件の区別**: 「実装方針」か「前提条件」かで判断
3. **複合的な記述の分解**: 1つの文に複数の要件が含まれる場合は分解
4. **文脈による判断**: セクション名や前後の文脈を考慮して分類

この例では27件の要件を抽出しましたが、実際のプロジェクトではさらに多くの要件が含まれることがあります。

## 後続フロー

要件整理が完了したら、実装するコンポーネントに応じて次のステップに進みます:

### サーバー実装の場合
- `api-design-principles` スキルで設計原則を参照しながらAPI設計書を作成
- サーバーAPI実装

### クライアント実装の場合
- クライアント設計書を作成（※今後、クライアント向けスキル作成予定）
- クライアント実装
