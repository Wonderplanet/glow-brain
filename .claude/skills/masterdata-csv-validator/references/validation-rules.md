# マスタデータ検証ルール詳細

## テンプレート検証

### ヘッダー形式チェック

**Row 1（memo行）**
- 1行目の最初のセルは `memo` でなければならない
- 他のセルは任意（通常は空）

**Row 2（TABLE行）**
- 2行目の最初のセルは `TABLE,<テーブル名>` 形式
- 例: `TABLE,mst_events` または `TABLE,opr_gachas`

**Row 3（ENABLE/カラム名行）**
- 3行目の最初のセルは `ENABLE`
- 2列目以降がカラム名
- カラム順序はテンプレートと完全一致必須

### カラム検証

**カラム順序**
- テンプレートCSVと完全一致が必須
- 順序が異なる場合はエラー

**カラム名**
- テンプレートに存在しないカラムは `extra_column` エラー
- テンプレートにあるがCSVにないカラムは `missing_column` エラー

## CSV形式検証

### 改行の扱い

**正しい形式**
```csv
id,description
1,"これは\\n改行を含む\\nテキストです"
```

**誤った形式（エラー）**
```csv
id,description
1,"これは
改行を含む
テキストです"
```

実際の改行文字が含まれている場合は **warning** レベルで報告されます。

### ダブルクォートのエスケープ

**正しい形式**
```csv
id,json_data
1,"{""key"": ""value""}"
```

セル内のダブルクォートは `""` でエスケープします。

### NULL値の扱い

**NULL許可カラム**
- 空文字列（何も書かない）でOK
- 例: `id,name,description` → `1,テスト,` （descriptionが空）

**NULL不可カラム**
- 空値はエラー
- 適切なデフォルト値を設定必須

## DBスキーマ検証

### 型チェック

**整数型（int, bigint, tinyint等）**
- 数値のみ許可
- 例: `100`, `-50`
- エラー例: `abc`, `12.5`

**小数型（decimal, float, double）**
- 数値（小数点含む）許可
- 例: `10.5`, `-3.14`

**文字列型（varchar, text）**
- 任意の文字列許可
- 長さ制限はDBスキーマの `max_length` で確認

**日時型（date, datetime, timestamp）**
- ISO 8601形式: `YYYY-MM-DD HH:MM:SS`
- 例: `2024-01-15 10:30:00`
- エラー例: `2024/01/15`, `Jan 15, 2024`

### enum値チェック

enum型カラムは定義された値のみ許可されます。

**例: gacha_type**
```json
"enum_values": ["Normal", "Special", "Limited"]
```

`Normal`, `Special`, `Limited` 以外の値はエラーになります。

### NULL許可チェック

**nullable: false のカラム**
- 空値は許可されない
- 必ず値を設定する必要がある

**nullable: true のカラム**
- 空値OK

## 外部キー制約（今後実装予定）

関連テーブルとの整合性チェック。

**例: opr_gacha_prizes.opr_gacha_id**
- `opr_gachas` テーブルに該当IDが存在するか確認
- 存在しない場合はエラー

## データ整合性チェック（今後実装予定）

**日付の前後関係**
- `start_at` < `end_at` のチェック
- 例: イベント開始日 < イベント終了日

**数値の範囲チェック**
- 確率合計が100%かチェック（ガチャ排出率等）
- 報酬数量が正の値かチェック

## エラーレベル

### critical（エラー）
- テンプレート不一致
- CSV形式エラー
- 型不一致
- enum値不正
- NULL不可カラムの空値

### warning（警告）
- セル内の実際の改行文字（エスケープ推奨だが動作可能）
- テンプレートファイル未発見（スキップされるが警告）
