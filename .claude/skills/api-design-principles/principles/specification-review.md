# 仕様書の批判的検討

## 原則

**仕様書の内容をそのまま実装するのではなく、内容について疑い、既存実装での対応可能性を深く検討する。**

ゲーム体験仕様書からAPI設計書を作る際、仕様書をそのままの状態で実装しようとすると、設計がうまくいかないケースがあります。

## 背景

ゲーム体験仕様書は、以下の特性を持ちます:

- **ユーザー体験の視点で書かれている**: 技術的実現可能性より、体験の理想を優先
- **実装詳細を考慮していない**: サーバー・クライアントの責務分離や既存実装との整合性は未考慮
- **新規機能を前提としている**: 既存機能の流用可能性を検討していない
- **文言通りの実装を想定している**: 抽象化・汎用化の余地があっても明示されない

仕様書を鵜呑みにして実装すると、以下の問題が発生します:

- 実装コストが不必要に高くなる
- 既存機能と重複する機能が増える
- 将来の保守・拡張が困難になる
- システム全体の複雑性が増大する

## 検討プロセス

仕様書を受け取ったら、以下の問いを必ず自問してください:

### 1. そもそも対応が必要な要件なのか？

- この要件は本当にサーバー側で実装すべきか？
- クライアント側だけで実現できないか？
- マスタデータの設定で対応できないか？
- 運営オペレーションで代替できないか？

**判断基準**:
- サーバーが関与しないと、不正・データ不整合が発生するか？
- 永続化が必要か？
- 複数プラットフォーム間で一貫性が必要か？

### 2. 既存の実装で対応できるのではないか？

- 似た機能が既に存在しないか？
- 既存APIのパラメータ追加で対応できないか？
- 既存のドメインロジックを組み合わせれば実現できないか？

**調査手順**:
1. 類似機能を既存コードベースから検索
2. 既存のマスタテーブル・ユーザーテーブルを確認
3. 既存APIのレスポンス構造を確認
4. 既存実装のドメイン概念を整理

### 3. 内容を既存のものに読み替えて流用できるか？

仕様書の文言にとらわれず、**本質的な要求**を抽出します。

**例**:
- 仕様書: 「新しい『コレクションボーナス』機能を実装」
- 本質: 「条件達成で報酬付与」→ 既存のミッション機能で実現可能

- 仕様書: 「専用の『イベントポイント』を管理」
- 本質: 「数値の蓄積と表示」→ 汎用的な `usr_user_parameters` で対応可能

### 4. 設計を汎用化できないか？

仕様書が特定のイベント・施策に特化していても、実装は汎用的にすべきです。

**悪い例**:
- イベント名を含む専用テーブル: `usr_summer_event_progress`
- ハードコードされたロジック: `if (eventId === 'summer_2025') {...}`

**良い例**:
- 汎用テーブル: `usr_event_progresses`
- マスタドリブン: `mst_events` のパラメータで制御

## 判断基準

以下のフローチャートで判断します:

```
仕様書の要件
  ↓
本当にサーバー実装が必要か？
  ├─ NO → クライアント・マスタ・運用で対応
  └─ YES
      ↓
  既存機能で実現できるか？
      ├─ YES → 既存機能を流用（必要に応じて拡張）
      └─ NO
          ↓
      既存機能を無理に使うと設計が歪むか？
          ├─ YES → 新規実装を検討
          └─ NO → 既存機能の拡張を検討
```

## 具体例

### 例1: 期間限定ミッションの新規実装要求

**仕様書の記載**:
> 「夏イベント専用のミッション機能を実装。専用の進捗管理とUI表示が必要。」

**批判的検討**:
1. **そもそも必要か？**: YES（ユーザーが達成状況を確認する必要がある）
2. **既存で対応可能か？**: 期間限定ミッション機能が既に存在
3. **読み替え可能か？**: 「期間限定ミッション」の一種として実装可能
4. **汎用化できるか？**: マスタデータで制御することで、将来のイベントでも再利用可能

**結論**: 新規実装不要。既存の期間限定ミッション機能を流用。

---

### 例2: 専用ポイントシステムの実装要求

**仕様書の記載**:
> 「『冒険ポイント』という新しい通貨を導入。獲得・消費・履歴管理が必要。」

**批判的検討**:
1. **そもそも必要か？**: YES（ポイントの永続化が必要）
2. **既存で対応可能か？**: 汎用的な `usr_user_parameters` または `usr_items` で管理可能
3. **読み替え可能か？**: 「アイテム」の一種として扱える
4. **汎用化できるか？**: マスタデータ (`mst_items`) で定義すれば、専用テーブル不要

**結論**: 新規テーブル不要。`usr_items` + `mst_items` で実装。

---

### 例3: 複雑な条件分岐を持つ報酬付与

**仕様書の記載**:
> 「ユーザーのランクと達成回数に応じて、報酬内容が変化する。」

**批判的検討**:
1. **そもそも必要か？**: YES（サーバー側で報酬を確定する必要がある）
2. **既存で対応可能か？**: 既存の報酬付与ロジックに条件判定を追加
3. **読み替え可能か？**: 「条件付き報酬」は汎用的なパターン
4. **汎用化できるか？**: マスタデータで条件と報酬をセットで定義

**結論**: 既存の報酬ロジックを拡張。マスタドリブンで条件を管理。

## チェックリスト

仕様書を検討する際は、以下を確認してください:

- [ ] 仕様書の要求を「本質」レベルで理解した
- [ ] 既存機能の調査を十分に実施した
- [ ] 新規実装の必要性を説明できる
- [ ] 汎用化の可能性を検討した
- [ ] 将来の拡張シナリオを考慮した

## 関連原則

- [データベース設計の慎重性](database-design.md) - 安易なテーブル追加を避ける
- [ミッション実装のコスト意識](mission-reuse.md) - ミッション流用の具体例
