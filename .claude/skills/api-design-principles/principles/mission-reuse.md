# ミッション実装のコスト意識

## 原則

**新規でミッションを実装するコストは高すぎるので、既存を無理のない形で流用することをまず第一に考える。**

## 背景

ミッション機能の新規実装は、以下の理由から非常に高コストです:

### 実装コスト
- **サーバー側**: 達成条件判定ロジック、進捗管理、報酬付与、DB設計
- **クライアント側**: UI実装、演出、画面遷移、通知
- **マスタデータ**: テーブル設計、CSV作成、バリデーション

### 保守コスト
- 新しいバグの混入リスク
- 既存ミッションとの整合性確保
- 運営オペレーションの複雑化
- ドキュメント・テストの追加

### 運用コスト
- CS対応の増加（新しい不具合パターン）
- 監視・ログ解析の対象増加
- 施策設計時の選択肢増加による意思決定コスト

## ミッション分類の整理

GLOWにおけるミッションは、以下のように分類されます:

### 1. デイリーミッション
- **表示画面**: デイリーミッション画面
- **特徴**: 毎日リセット、固定の達成条件
- **識別データ**: なし（画面で一意に識別）

### 2. ウィークリーミッション
- **表示画面**: ウィークリーミッション画面
- **特徴**: 毎週リセット、固定の達成条件
- **識別データ**: なし（画面で一意に識別）

### 3. 通常ミッション（常設）
- **表示画面**: 通常ミッション画面
- **特徴**: リセットなし、永続的
- **識別データ**: なし（画面で一意に識別）

### 4. 期間限定ミッション
- **表示画面**: 機能ごとに異なる（例: 降臨バトル画面、イベント画面）
- **特徴**: 期間指定、機能に紐づく
- **識別データ**: **機能ごとに識別できるデータが存在** (例: `mst_advent_battle_id`)

## 流用戦略

上記の分類を踏まえ、以下の戦略で既存ミッションを流用します:

### 戦略1: 期間限定ミッションの流用を最優先

期間限定ミッションは**機能ごとに識別できるデータ**を持っているため、新しい機能でも流用しやすい設計になっています。

**例: 降臨バトルミッション**
- マスタデータ: `mst_advent_battle_missions`
- 識別データ: `mst_advent_battle_id`（どの降臨バトルに紐づくか）
- 表示画面: 降臨バトル画面内

**新機能での流用例**:
- 新イベント「討伐クエスト」を実装する場合
- マスタデータ: `mst_raid_quest_missions`（新規）
- 識別データ: `mst_raid_quest_id`（どの討伐クエストに紐づくか）
- 表示画面: 討伐クエスト画面内
- **サーバーロジック**: 期間限定ミッションの既存実装を流用

### 戦略2: 既存ミッション種別で対応可能か検討

新しい要求が、既存のミッション種別で実現できないか必ず検討します。

**判断基準**:
- リセット周期は既存種別と一致するか？
- 達成条件の種類は既存で対応可能か？
- 表示場所は既存画面で問題ないか？

### 戦略3: マスタデータでの差別化を優先

新しい要求の大半は、**マスタデータのパラメータで制御**することで実現できます。

**悪い例**: 新規ミッション種別を実装
```typescript
// 新しいミッション種別を追加
enum MissionType {
  Daily,
  Weekly,
  Normal,
  Event,        // 既存
  AdventBattle, // 既存
  NewFeature,   // ❌ 新規追加
}
```

**良い例**: 期間限定ミッションとして実装
```csv
# mst_new_feature_missions.csv
id,mst_new_feature_id,mission_type,condition_type,condition_value,...
mission_001,feature_001,clear_count,complete_stage,5,...
```

### 戦略4: 新規実装が必要な場合の判断

以下の条件を**すべて満たす場合のみ**、新規ミッション実装を検討します:

- [ ] 既存のミッション種別では達成条件が表現できない
- [ ] 期間限定ミッションの流用では設計が歪む
- [ ] マスタデータの拡張では対応不可能
- [ ] 将来的に他の機能でも再利用できる汎用性がある
- [ ] 実装・保守コストを正当化できるビジネス価値がある

## 具体例

### 例1: 新イベント「タワーバトル」のミッション

**要求**:
> タワーバトル専用のミッション機能。階層クリアごとに達成判定。

**検討プロセス**:
1. **既存種別で対応可能か？**: NO（デイリー/ウィークリーは不適）
2. **期間限定ミッションで流用可能か？**: YES
   - 識別データ: `mst_tower_battle_id`
   - 達成条件: 既存の「ステージクリア」系で対応可能
   - 表示画面: タワーバトル画面内
3. **マスタデータで差別化**: マスタCSVで階層ごとの条件を定義

**結論**: 期間限定ミッションを流用。新規実装不要。

---

### 例2: 「累計ログインミッション」の追加要求

**要求**:
> 累計ログイン日数に応じた報酬付与ミッション。

**検討プロセス**:
1. **既存種別で対応可能か？**: YES
   - 通常ミッション（常設）として実装可能
   - 達成条件: 既存の「ログイン日数」で対応可能
2. **マスタデータで差別化**: `mst_missions` に新しい条件を追加

**結論**: 通常ミッションを流用。新規実装不要。

---

### 例3: 「連続ログインボーナス」との混同

**要求**:
> 連続ログインボーナスを実装したい。

**検討プロセス**:
1. **ミッションで実装すべきか？**: **NO**
   - 連続ログインボーナスは「ミッション」ではなく「ログインボーナス」機能
   - GLOWでは `mst_login_bonuses` が既に存在
2. **既存のログインボーナス機能で対応**: YES

**結論**: ミッションとして実装しない。既存のログインボーナス機能を使用。

## チェックリスト

新しいミッション要求を受けたら、以下を確認してください:

- [ ] 既存の4種類のミッション（デイリー/ウィークリー/通常/期間限定）を調査した
- [ ] 期間限定ミッションの流用可能性を最優先で検討した
- [ ] マスタデータでの差別化可能性を検討した
- [ ] 新規実装が必要な理由を明確に説明できる
- [ ] 他機能（ログインボーナス等）での実現可能性を検討した

## 関連原則

- [データベース設計の慎重性](database-design.md) - 安易なテーブル追加を避ける
- [仕様書の批判的検討](specification-review.md) - 仕様書の要求を鵜呑みにしない

## 補足: 降臨バトルミッションの設計

降臨バトルミッションは、期間限定ミッションの良い設計例です:

```
mst_advent_battle_missions
├─ id (ミッションID)
├─ mst_advent_battle_id (どの降臨バトルに紐づくか)
├─ mission_type (達成条件の種類)
├─ condition_value (達成条件の値)
├─ reward_* (報酬定義)
└─ start_at / end_at (期間)
```

**この設計の優れた点**:
- 降臨バトルごとに独立したミッションを定義できる
- サーバーロジックは汎用的（降臨バトルIDで絞り込むだけ）
- 新しい降臨バトルでも同じ構造を使える
- 他の機能でも同じパターンを適用できる
