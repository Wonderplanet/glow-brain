# データベース設計の慎重性

## 原則

**ユーザーデータの管理テーブルや列は、必須ではない限り無闇に増やさない。**

本当に必要な情報なのかをまずは精査する必要があります。

## 背景

データベース設計における安易なテーブル・列の追加は、以下の問題を引き起こします:

- **保守コストの増大**: テーブルが増えるたびに、マイグレーション、バックアップ、監視の対象が増える
- **パフォーマンス劣化**: 不要なJOINやINDEXが増え、クエリが複雑化する
- **データ整合性リスク**: 管理対象が増えるほど、データ不整合のリスクが高まる
- **認知負荷の増加**: 開発者が把握すべきスキーマが肥大化し、理解コストが上がる

## 検討プロセス

新しいテーブルや列を追加する前に、以下を必ず検討してください:

### 1. 本当に永続化が必要か？

- クライアント側で計算・保持できないか？
- マスタデータで表現できないか？
- 既存のテーブルから導出できないか？

### 2. 既存テーブルで代替できないか？

- 似た概念を持つテーブルが既に存在しないか？
- 既存テーブルに列を追加する方が自然ではないか？

### 3. ライフサイクルと更新頻度

- データは頻繁に更新されるか？
- データの保持期間はどれくらいか？
- ログテーブルで十分ではないか？

### 4. 将来の拡張性

- この設計は将来の仕様変更に耐えられるか？
- 特定の施策・イベント専用になっていないか？
- 汎用的な設計にできないか？

## 判断基準

以下の条件を**すべて満たす場合のみ**、新規テーブル・列の追加を検討します:

- [ ] 他の方法では実現不可能、または著しく設計が歪む
- [ ] ユーザー体験の実現に不可欠
- [ ] データ整合性・パフォーマンス上のメリットが明確
- [ ] 将来的な保守・拡張に悪影響を与えない

## 具体例

### ❌ 悪い例: 安易なテーブル追加

```sql
-- イベント専用のテーブルを毎回追加
CREATE TABLE usr_event_a_progress (...)
CREATE TABLE usr_event_b_progress (...)
CREATE TABLE usr_event_c_progress (...)
```

**問題点**:
- イベントごとにテーブルが増殖
- 共通化できるロジックが分散
- 終了イベントのテーブルが残り続ける

### ✅ 良い例: 汎用テーブルで設計

```sql
-- 汎用的な進捗管理テーブル
CREATE TABLE usr_event_progresses (
  usr_user_id VARCHAR(255) NOT NULL,
  mst_event_id VARCHAR(255) NOT NULL,
  progress_data JSON NOT NULL,
  PRIMARY KEY (usr_user_id, mst_event_id)
)
```

**メリット**:
- イベントが増えてもテーブルは増えない
- マスタデータで仕様を制御できる
- 共通ロジックの再利用が容易

## チェックリスト

新規テーブル・列を追加する際は、以下を確認してください:

- [ ] 既存テーブルの調査を実施した
- [ ] クライアント側での代替案を検討した
- [ ] マスタデータでの表現可能性を検討した
- [ ] 将来の拡張シナリオを考慮した
- [ ] レビュアーに判断理由を説明できる

## 関連原則

- [仕様書の批判的検討](specification-review.md) - 仕様書の要求を鵜呑みにしない
- [ミッション実装のコスト意識](mission-reuse.md) - 既存機能の流用を優先する
