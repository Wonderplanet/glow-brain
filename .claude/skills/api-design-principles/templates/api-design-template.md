# API設計書テンプレート

このドキュメントは、GLOW API設計書の標準フォーマットを定義します。

参照元: `domain/tasks/design/api/templates/API設計書_参考フォーマット.md`

## 目次構成

API設計書は以下のセクションで構成されます:

1. [仕様書](#仕様書)
2. [シーケンス図](#シーケンス図)
3. [エラー設計](#エラー設計)
4. [API仕様](#api仕様)
5. [DB設計](#db設計)
6. [テーブル一覧](#テーブル一覧)

---

## 1. 仕様書

### 1.1 要点まとめ

機能の概要、設計方針、DB変更点、API変更点を簡潔にまとめます。

**記載内容**:
- **概要**: 機能の説明を3-5文で記述
- **設計方針**: 重要な設計判断を箇条書き
- **DB変更点**: 新規追加・既存変更を明記
- **API**: 新規エンドポイント・既存変更を明記

**設計原則チェック**:
- [ ] [データベース設計の慎重性](../principles/database-design.md) - 新規テーブルは本当に必要か？
- [ ] [仕様書の批判的検討](../principles/specification-review.md) - 既存機能で対応できないか？
- [ ] [ミッション実装のコスト意識](../principles/mission-reuse.md) - 既存ミッションを流用できないか？

---

### 1.2 仕様確認

参照ドキュメントと仕様の重要ポイントを表形式で整理します。

**記載内容**:
- 既存実装コードのパス
- 関連ドキュメントのパス
- 仕様ポイント（表形式）

---

## 2. シーケンス図

Mermaid形式でAPI呼び出しのフローを可視化します。

**記載のポイント**:
- 正常系と異常系（エラーケース）を明記
- リクエストパラメータの説明
- DB操作（取得・更新）を明示
- ログ記録のタイミング

---

## 3. エラー設計

**重要**: クライアントとの認識共有を必須とします。

エラーコード、発生条件、クライアント挙動を表形式で定義します。

**記載内容**:
- エラーコード
- 新規/既存の区分
- エラー内容
- 発生条件（具体的に）
- クライアント挙動（ダイアログ表示、画面遷移）

---

## 4. API仕様

エンドポイントごとに、リクエスト・レスポンスを詳細に定義します。

**記載内容**:
- エンドポイント名とHTTPメソッド
- リクエストパラメータ（JSON例 + 説明）
- レスポンス（JSON例 + 説明）
- 既存との互換性（該当する場合）

**レスポンスの基本構造**:
- `usrParameter`: ユーザーパラメータの変更差分
- `usrItems`: アイテム変更差分
- 機能固有のレスポンス
- 報酬リスト（演出用）

---

## 5. DB設計

### 5.1 マスター/オペレーション

マスタテーブル（`mst_*`、`opr_*`）を定義します。

**記載内容**:
- テーブル名（新規/既存改修を明記）
- テーブルの説明
- カラム定義（列名、index、データ型、説明）
- 制約条件
- i18nテーブル（多言語対応が必要な場合）

**設計原則チェック**:
- [ ] [データベース設計の慎重性](../principles/database-design.md) - 本当に新規テーブルが必要か？

---

### 5.2 ユーザー

ユーザーテーブル（`usr_*`）を定義します。

**TiDB最適化のためのPK設計**:
- **1ユーザーあたり1レコード**: PK は `usr_user_id`
- **1ユーザーあたり複数レコード**: 複合PK `(usr_user_id, ドメインID or マスタID)`

**記載内容**:
- テーブル名（新規/既存改修を明記）
- テーブルの説明
- カラム定義
- 利用箇所
- 設計上の注意

**設計原則チェック**:
- [ ] [データベース設計の慎重性](../principles/database-design.md) - 列は本当に必要か？

---

### 5.3 ログ

ログテーブル（`log_*`）を定義します。

**記載内容**:
- テーブル名（新規/既存改修を明記）
- テーブルの説明
- カラム定義（nginx_request_id、request_id、logging_no は標準項目）
- ログ記録タイミング

---

## 6. テーブル一覧

全テーブルを一覧表で整理します。

**記載内容**:
- テーブル名
- 新規/既存の区分
- 概要

---

## 設計時の注意事項

### 必ず確認すべき設計原則

1. **[データベース設計の慎重性](../principles/database-design.md)**
   - 新規テーブル・列の追加は本当に必要か？
   - 既存テーブルで代替できないか？

2. **[仕様書の批判的検討](../principles/specification-review.md)**
   - 仕様書の要求を鵜呑みにしていないか？
   - 既存実装で対応できないか？

3. **[ミッション実装のコスト意識](../principles/mission-reuse.md)**
   - 既存ミッションを流用できないか？
   - 期間限定ミッションのパターンを適用できないか？

### レビュー前のチェックリスト

- [ ] 3つの設計原則をすべて確認した
- [ ] 既存実装の調査を十分に実施した
- [ ] エラー設計でクライアントとの認識共有が完了している
- [ ] シーケンス図で正常系・異常系を網羅している
- [ ] テーブル設計でTiDB最適化を考慮している

---

## 関連ドキュメント

### プロジェクト共通ルール
- 要件分類: `domain/tasks/design/api/rules/ゲーム体験仕様書_要件分類ルール.md`
- サーバー要件判定: `domain/tasks/design/api/rules/サーバー要件判定ルール.md`
- サーバー実現方針: `domain/tasks/design/api/rules/サーバー実現方針ルール.md`

### 設計原則
- [データベース設計の慎重性](../principles/database-design.md)
- [仕様書の批判的検討](../principles/specification-review.md)
- [ミッション実装のコスト意識](../principles/mission-reuse.md)
