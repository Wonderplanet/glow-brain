# インゲーム設計書チェックツール

Google Apps Script (GAS) で実装された、スプレッドシート上の設計書とマスターデータの整合性を確認するツールです。

## 概要

設計書（スプレッドシートのシート）からマスターデータ形式へデータを変換し、参照先のマスタースプレッドシートと照合します。設計書の記入内容が正しくマスターデータに反映されているかを自動チェックします。

## 機能一覧

スプレッドシートを開くと「🔧 設計書チェック」メニューが追加されます。

| メニュー | 機能 |
|---------|------|
| 🔄 データ生成/更新 | 設計書からマスターデータ形式のシートを生成・更新 |
| 🔍 生成済みデータのチェックのみ | 既に生成済みのシートとマスターを照合 |
| ⚡ データ生成＋チェック実行 | 生成と照合を一括実行 |
| 🗑️ 生成データの削除 | 生成済みシートをすべて削除 |
| 🚀 ダイレクトチェック（高速） | 中間シートを作らず直接照合（高速） |
| 🔧 マスターデータ上書き（実験的） | 差分を選択してマスターに書き戻す |
| 🩺 事前診断（書き出ししない） | 設定ミスや項目未検出を書き出し前に診断 |

## 使い方フロー

シナリオ別に、どの機能をどの順で使うかを示します。

---

### シナリオ1: 初めてセットアップするとき

```
[1] シート構成を準備する
    チェック対象管理 / マッピング設定シート / master_config を作成
        ↓
[2] 🩺 事前診断（書き出ししない）
    設定ミス・項目未検出を書き出し前に確認
        ↓ 問題があれば設定を修正して再診断
[3] ⚡ データ生成＋チェック実行
    設計書からデータを生成し、マスターと照合
        ↓
[4] チェック結果ダイアログで確認
    OK → 完了 / エラーあり → 設計書またはマスターを修正して再実行
```

---

### シナリオ2: 設計書を更新してチェックしたいとき（通常運用）

速度を優先する場合：

```
🚀 ダイレクトチェック（高速）
    中間シートを生成せず、設計書から直接マスターと照合
        ↓
チェック結果ダイアログで確認
```

中間データを目視確認したい場合：

```
[1] 🔄 データ生成/更新
    設計書から中間シート（マスターデータ形式）を生成
        ↓ 生成されたシートを手動で確認（省略可）
[2] 🔍 生成済みデータのチェックのみ
    生成済みシートとマスターを照合
        ↓
チェック結果ダイアログで確認
```

> **どちらを使うか**
> - 設計書が複数あり素早く確認したい → ダイレクトチェック
> - 生成結果を目で追いたい・デバッグしたい → 生成してからチェック

---

### シナリオ3: マスターへ差分を反映したいとき

> 前提：マッピングに `ユニークキー=TRUE` の列が設定されていること

```
[1] ⚡ データ生成＋チェック  または  🚀 ダイレクトチェック
    「ユニークキーは一致するが値が異なる」差分を検出
        ↓ エラーあり
[2] 🔧 マスターデータ上書き（実験的）
    差分ダイアログが開く
    → 上書きしたいレコードを選択して「上書き実行」
        ↓
参照先のマスタースプレッドシートが更新される
上書きバックアップログシートに更新前の値が記録される
```

---

### シナリオ4: うまく動かないとき（0件・エラー）

```
🩺 事前診断（書き出ししない）
    ↓
診断ダイアログでエラーコードを確認
    ↓
エラーコードに応じて修正

CFG-001 / CFG-002  → チェック対象管理シートの設定を確認
MAP-001〜003       → マッピング設定シートの記載を確認
DATA-001           → 設計書シートが存在するか確認
DATA-002           → 項目名の表記（全角/半角、記号）を確認
DATA-010           → 空白無視の設定・データ行の値を確認
RNG-001            → 設計書範囲のA1記法を確認
CFG-010            → チェック対象管理のマスターURLを確認
    ↓
再度 事前診断 → 問題なければ通常のフローへ
```

---

### シナリオ5: 生成データをリセットしたいとき

```
🗑️ 生成データの削除
    ツールが生成した中間シートをすべて削除（元の設計書シートは消えない）
        ↓
必要に応じて再度 🔄 データ生成/更新 を実行
```

---

## 必要なシート構成

このツールを動かすには、スプレッドシートに以下のシートが必要です。

### 1. `チェック対象管理`（必須）

チェック対象の設計書シートと照合先マスターURLを管理します。

| 列名 | 内容 |
|------|------|
| チェック | TRUE にした行が処理対象 |
| シート名 | 設計書シートの名前 |
| マッピング | 使用するマッピング設定シートの名前 |
| マスターURL | 照合先マスタースプレッドシートのURL |
| 最終チェック日時 | ツールが自動更新 |
| 結果 | ツールが自動更新 |

### 2. `マッピング設定シート`（必須）

設計書の項目とマスターデータの列の対応を定義します（シート名は `設計書_マッピング` でも可）。

| 列名 | 内容 |
|------|------|
| 項目名 | 設計書内のセルに書かれた項目ラベル |
| 方向 | データ展開方向：`▼`/`↓`（下）、`▶`/`→`（右） |
| 設計書範囲 | A1記法での固定範囲指定（例：`B3:B50`） |
| マスター名 | 対応するマスターシート名 |
| マスター列名 | 対応するマスターの列名 |
| チェック無視 | TRUE にするとチェック時に比較対象から除外 |
| ユニークキー | TRUE にするとユニークキー照合で差分を検出 |
| 展開タイプ | `通常`：行ごとに展開、`下方継承`：全行に同じ値を適用 |
| 空白無視 | TRUE にすると空白行をスキップ |

### 3. `master_config`（任意）

マスターデータの読み取り開始位置を指定します。省略するとデフォルト設定が使われます。

| 列 | 内容 |
|----|------|
| A | マスターシート名 |
| B | 開始行（ヘッダー行） |
| C | 開始列 |

## データ抽出のしくみ

設計書からのデータ抽出には2つの方法があります。

### 方向指定（`方向` 列を使用）

項目名でセルを検索し、その隣からデータを取得します。

- `▼` / `↓` → 項目名の**下方向**にデータが並んでいる
- `▶` / `→` → 項目名の**右方向**にデータが並んでいる

連続する空白が3つ続くと末尾とみなして終了します。`空白無視=TRUE` の場合は最後の非空白セルまでを範囲とします。

### 範囲指定（`設計書範囲` 列を使用）

A1記法（例：`C5:G5`）でデータ範囲を直接指定します。

## 照合のしくみ

### ユニークキーあり（推奨）

`ユニークキー=TRUE` の列を使って照合します。

1. ユニークキーが一致するマスター行を探す
2. 一致行の全列を比較する
3. 差分がある場合は「上書き候補」として検出する

### ユニークキーなし

生成データの各行が、マスターデータのいずれかの行と完全一致するかを確認します。

## マスターデータ上書き機能

ユニークキーで一致する行に差分がある場合、UIダイアログで上書き対象を選択して参照先マスタースプレッドシートに書き戻せます（実験的機能）。

実行すると `上書きバックアップログ` シートに更新前の値が記録されます。

## 事前診断機能

`🩺 事前診断` を実行すると、書き出しを行わずに以下のような問題を検出します。

| エラーコード | 内容 |
|------------|------|
| CFG-001 | チェック対象管理シートが存在しない |
| CFG-002 | チェック列がONの設計書が0件 |
| CFG-010 | マスターURLが未設定 |
| MAP-001 | マッピングからマスター名が取得できない |
| MAP-002 | 設計書に対応するマッピングシートがない |
| MAP-003 | マッピング行が0件 |
| DATA-001 | 設計書シートが存在しない |
| DATA-002 | 指定した項目名がシートで見つからない |
| DATA-010 | 書き出しレコードが0件 |
| RNG-001 | 設計書範囲の指定が不正 |

## チェック結果の確認

チェック完了後のダイアログでは以下の操作が可能です。

- エラーのみ表示フィルター
- キーワード検索
- 全展開/全折りたたみ
- CSV・JSONでのダウンロード
- テキストのクリップボードコピー

## ファイル構成

```
in-game-design-doc-checker/
├── コード.js         # メインスクリプト
├── appsscript.json   # GASプロジェクト設定（タイムゾーン: Asia/Tokyo、ランタイム: V8）
└── .clasp.json       # clasp（ローカル開発ツール）設定
```

## 開発・デプロイ

[clasp](https://github.com/google/clasp) を使ってローカルからGASへプッシュできます。

```bash
# 初回セットアップ
npm install -g @google/clasp
clasp login

# プッシュ
clasp push
```
