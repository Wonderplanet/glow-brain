# マッピング設定シート

## これは何か

一言で言うと、**「設計書のどのセルが、マスターデータのどの列に対応するか」を定義する変換テーブル**です。

---

## なぜ必要か

設計書とマスターデータは**レイアウトが全然違います**。

```
【設計書シート（人間が読みやすい形）】

  イベントID  ▼          イベント名  ▼
  ─────────              ─────────
  1001                   ホリデーイベント
  1002                   サマーフェス
  1003                   ウィンターカップ


【マスターデータ（DBに入れる形）】

  id    | name
  ──────|──────────────
  1001  | ホリデーイベント
  1002  | サマーフェス
  1003  | ウィンターカップ
```

ツールが設計書の内容を自動で読み取ってマスターと照合するために、「設計書のどこを読んで、マスターのどこと突合するか」を教える役割を持ちます。

---

## 基本構造：1行 = 1項目の対応関係

シートの **1行が「設計書の1項目 → マスターの1列」** の対応を表します。

上の例だと2行こうなります。

| 項目名 | 方向 | マスター名 | マスター列名 | 展開タイプ | 空白無視 | ユニークキー |
|--------|-----|----------|------------|---------|---------|------------|
| イベントID | ▼ | MstEvent | id | 通常 | TRUE | TRUE |
| イベント名 | ▼ | MstEvent | name | 通常 | TRUE | FALSE |

---

## 各列の意味

### 項目名

設計書内のセルを文字列検索するキーです。シート内に「イベントID」というセルがあれば、そこを起点にデータを取得します。

> 大文字小文字・全角半角が違うとヒットしないので注意

---

### 方向

項目名セルの**どちら側にデータが並んでいるか**を指定します。

| 値 | 意味 | 使用例 |
|----|------|--------|
| `▼` または `↓` | 項目名の下にデータが並ぶ | 縦に並んだリスト |
| `▶` または `→` | 項目名の右にデータが並ぶ | 横に並んだリスト |

```
【▼ の例】          【▶ の例】

  ステージID  ▼       難易度  ▶  EASY  NORMAL  HARD
  ──────
  201
  202
  203
```

データの末尾は「空白セルが3つ連続したら終了」とみなします。

---

### 設計書範囲

方向指定ではなく、**A1記法でセル範囲を直接指定する**場合に使います。方向と設計書範囲はどちらか一方を設定します。

```
例: B3:B50  /  C5:G5
```

---

### マスター名

対応するマスターのシート名です。照合先スプレッドシート内のシート名と一致している必要があります。

```
例: MstEvent, MstStage, OprGacha
```

---

### マスター列名

対応するマスターの列名（ヘッダー行の値）です。

```
例: id, name, event_id, difficulty
```

---

### 展開タイプ

設計書から取得した値をレコードに展開する方法を指定します。

#### 通常

行ごとに別々の値を取得します。繰り返し系のデータに使います。

```
  ステージID  ▼
  ──────
  201          → レコード1の stage_id = 201
  202          → レコード2の stage_id = 202
  203          → レコード3の stage_id = 203
```

#### 下方継承

1つのセルの値を、全レコードに使い回します。設計書上でひとつだけ書かれているヘッダー情報（所属イベントIDなど）に使います。

```
  イベントID  B3
  ──────────
  1001         → 全レコードの event_id = 1001
```

---

### チェック無視

マスターには存在するが設計書には書かれていない列（`created_at` など自動生成カラム）を照合対象から外します。

| 値 | 動作 |
|----|------|
| `FALSE`（デフォルト） | 照合時に比較対象に含める |
| `TRUE` | データ生成には含めるが、照合では比較しない |

---

### ユニークキー

照合時に**どの列でマスターの行を特定するか**を指定します。

| 設定 | 照合方法 |
|------|---------|
| 設定なし | 全列が完全一致しているかを確認 |
| `TRUE` の列あり | ユニークキーでマスターの行を特定してから、他の列を比較 |

ユニークキーがあると、差分がある場合に「どの行のどの列が違うか」まで特定できるようになり、上書き候補として検出できます。

```
例: id 列をユニークキーにすると…

  id=1002 のマスター行を探す → 見つかった → name を比較 → 違う → 差分として報告
```

---

### 空白無視

設計書に見た目上のスペース行が入っていても、その行を除いてデータを取得します。

| 値 | 動作 |
|----|------|
| `FALSE`（デフォルト） | 空白セルも含めて取得（連続3空白で終了） |
| `TRUE` | 空白セルをスキップし、最後の非空白セルまでを範囲とする |

---

## 複数マスターへの対応

1枚のマッピング設定シートで、複数のマスターへの対応関係を定義できます。マスター名が違う行は別々のマスターシートに書き出されます。

| 項目名 | 方向 | マスター名 | マスター列名 | 展開タイプ |
|--------|-----|----------|------------|---------|
| イベントID | ▼ | MstEvent | id | 通常 |
| イベント名 | ▼ | MstEvent | name | 通常 |
| ステージID | ▼ | MstStage | id | 通常 |
| ステージ名 | ▼ | MstStage | name | 通常 |
| ステージ難易度 | ▶ | MstStage | difficulty | 通常 |

---

## 設計書ごとに別のマッピングを使う

`チェック対象管理` シートの `マッピング` 列で、設計書シートごとに異なるマッピング設定シートを指定できます。省略するとデフォルトの `マッピング設定シート`（または `設計書_マッピング`）が使われます。

```
チェック対象管理シート：

  チェック | シート名           | マッピング
  ─────────|──────────────────|──────────────
  TRUE     | イベントA設計書   | マッピング設定シート
  TRUE     | イベントB設計書   | イベントB_マッピング
```
