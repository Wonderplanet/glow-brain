# データ生成/更新

設計書シートからデータを読み取り、マスターデータ形式の中間シートを生成（または差分更新）する機能です。

---

## 全体の処理フロー

```
menuUpdateGeneratedData()
    │
    ├─ [1] getCheckTargetSheets()
    │       チェック対象管理シートから「チェック=TRUE」の設計書名を収集
    │
    ├─ [2] groupMappingsByMaster()
    │       マッピング設定を読んで「マスター名 → {mappings, designSheets}」に整理
    │
    └─ [3] updateMasterSheets()
            マスターシートごとに差分更新を実行
```

---

## 各ステップの詳細

### [1] チェック対象の設計書を収集

`チェック対象管理` シートを読み、`チェック` 列が `TRUE` になっている行の `シート名` を集めます。

```
チェック対象管理シート:

  チェック | シート名         | マッピング
  ─────────|──────────────── |──────────
  TRUE     | イベントA設計書  | マッピング設定シート  ← 対象
  FALSE    | イベントB設計書  | マッピング設定シート  ← スキップ
  TRUE     | ステージ設計書   | マッピング設定シート  ← 対象
```

---

### [2] マッピングをマスター名でグループ化

各設計書のマッピング設定シートを読み込み、「どのマスターに何の設計書が関係するか」を整理します。

```
マッピング設定シート:

  項目名       | マスター名  | マスター列名
  ─────────────|────────────|───────────
  イベントID   | MstEvent   | id
  イベント名   | MstEvent   | name
  ステージID   | MstStage   | id
  ステージ名   | MstStage   | name

↓ グループ化後

{
  MstEvent: {
    mappings: [{ masterColumn: 'id' }, { masterColumn: 'name' }],
    designSheets: ['イベントA設計書']
  },
  MstStage: {
    mappings: [{ masterColumn: 'id' }, { masterColumn: 'name' }],
    designSheets: ['ステージ設計書']
  }
}
```

複数の設計書シートが同じマスターに紐づく場合、`designSheets` に複数のシート名が入り、後でまとめて処理されます。

**重複排除**: 同じ `マスター列名` + `チェック無視` の組み合わせが複数あっても1件だけ保持します。

---

### [3] 差分更新（updateMasterSheets）

マスター名ごとに以下の分岐で処理されます。

```
生成シート（バインドスプシ内）が存在しない？
    YES → generateMasterSheets() で新規作成して終了
    NO  ↓

既存データが1行以下（ヘッダーのみ or 空）？
    YES → generateMasterSheets() で新規生成して終了
    NO  ↓

差分更新モード
    1. 既存データを「シート名」列（A列）でグループ化
    2. 設計書から新データを収集・「シート名」でグループ化
    3. チェック対象の設計書シート → 新データで上書き
    4. チェック対象外の設計書シート → 既存データをそのまま保持
    5. シートをclearして全件書き戻し
```

#### 差分更新の具体例

```
【更新前の生成シート（MstEvent）】

  シート名        | id   | name
  ─────────────── |──────|──────────────
  イベントA設計書 | 1001 | ホリデーイベント
  イベントA設計書 | 1002 | サマーフェス
  イベントB設計書 | 2001 | ウィンターカップ  ← チェックOFF（触らない）


【イベントA設計書を修正後、データ生成/更新を実行】

  シート名        | id   | name
  ─────────────── |──────|──────────────
  イベントA設計書 | 1001 | ホリデーイベント2  ← 新データに差し替え
  イベントA設計書 | 1003 | 秋祭りイベント     ← 新データに差し替え
  イベントB設計書 | 2001 | ウィンターカップ   ← そのまま保持
```

チェック対象外のシートのデータは変更されません。これが「データ生成/更新」の最大の特徴です。

---

## 新規生成（generateMasterSheets）との違い

「データ生成＋チェック実行」や初回生成時に呼ばれる `generateMasterSheets` は **全件置き換え** です。

| | データ生成/更新 | データ生成＋チェック |
|--|----------------|-------------------|
| 関数 | `updateMasterSheets` | `generateMasterSheets` |
| 既存データ | チェック対象外の行を**保持** | **全消去**して書き直し |
| 用途 | 一部の設計書だけ更新したいとき | 全設計書を一括で作り直すとき |

---

## 生成シートの構造

バインドスプシ内に `マスター名` と同じ名前のシートが作られます。

```
【MstEvent シート（生成結果）】

  A列             | B列  | C列
  シート名        | id   | name
  ─────────────── |──────|──────────────
  イベントA設計書 | 1001 | ホリデーイベント
  イベントA設計書 | 1002 | サマーフェス
```

- **A列（シート名）**: どの設計書から来たデータか。差分更新のキーとして使われます
- **B列以降**: マッピング設定シートの `マスター列名` 順に並ぶ

---

## 設計書からのデータ収集（collectRecordsForMaster / extractRecordsFromDesignSheet）

差分更新・新規生成どちらも、設計書からのデータ収集は共通の処理です。

```
collectRecordsForMaster()
    │
    └─ 各設計書シートに対して extractRecordsFromDesignSheet() を呼ぶ
            │
            ├─ シート全体を1回で取得（getDataRange().getValues()）
            │
            ├─ 空白無視=TRUEの列があれば、最後の非空白セルまでを走査範囲として事前計算
            │   （computeBoundsForIgnoreBlank）
            │
            ├─ 各マッピングに対してデータを抽出
            │   ├─ 方向指定あり → findItemInData() で項目名を検索し、その方向にデータを取得
            │   └─ 範囲指定あり → getRange() で直接取得
            │
            └─ レコードを組み立て
                ├─ 展開タイプ「通常」: 各インデックスの値を使用
                ├─ 展開タイプ「下方継承」: 最初の値を全レコードで使い回し
                └─ 空白無視=TRUEの列が空ならそのレコードをスキップ
```

### レコード数の決定

「通常」タイプのマッピングのうち、最も件数が多い列の件数が全体のレコード数になります。

```
例：
  ステージID（通常）  → 3件
  ステージ名（通常）  → 3件
  イベントID（下方継承）→ 1件（→ 全3レコードに同じ値が入る）

→ レコード数 = 3
```

全てのマッピングが「下方継承」のみの場合は、最低1レコードが生成されます。

---

## 完了後の動作

| 状況 | 結果 |
|------|------|
| 1件以上生成された | 「データ更新完了」ダイアログを表示 |
| 全マスターが0件 | 事前診断ダイアログを表示（原因推定） |
| 例外発生 | エラーダイアログを表示 |
