<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
      input[type="text"] { width: 80%; padding: 10px; margin-bottom: 10px; }
      select { padding: 8px; margin-left: 10px; margin-bottom: 10px; }
      button { padding: 10px 20px; cursor: pointer; background: #4285f4; color: white; border: none; border-radius: 4px; }
      button:disabled { background: #ccc; }
      #status { margin-top: 20px; font-weight: bold; }
      #stats { margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px; display: none; }
      #logs { margin-top: 20px; border: 1px solid #ccc; padding: 10px; background: #fafafa; font-size: 13px; font-family: monospace; display: none; white-space: pre-wrap; line-height: 1.5; }
      .log-info { color: #333; }
      .log-success { color: #0a0; font-weight: bold; }
      .log-warn { color: #f80; font-weight: bold; }
      .log-error { color: #f00; font-weight: bold; }
      #logs a { color: #0066cc; text-decoration: underline; }
      #logs a:hover { background: #e6f2ff; }
    </style>
  </head>
  <body>
    <h2>設計書HTML一括ダウンロード</h2>
    <p>一覧シートのURLを入力してください：</p>
    <input type="text" id="url" placeholder="https://docs.google.com/spreadsheets/d/...">
    <br>
    <label for="format">出力形式：</label>
    <select id="format">
      <option value="html" selected>HTML</option>
      <option value="csv">CSV</option>
    </select>
    <br>
    <label>
      <input type="checkbox" id="enableLogs">
      リアルタイムログ表示
    </label>
    <br><br>
    <button id="btn" onclick="startProcess()">ZIPを作成してダウンロード</button>
    <div id="status"></div>
    <div id="stats"></div>
    <div id="logs"></div>

    <script>
      let sessionId = null;
      let logPoller = null;
      let lastLogCount = 0;

      function startProcess() {
        const url = document.getElementById('url').value;
        const format = document.getElementById('format').value;
        const enableLogs = document.getElementById('enableLogs').checked;
        if (!url) { alert('URLを入力してください'); return; }

        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const stats = document.getElementById('stats');
        const logs = document.getElementById('logs');

        btn.disabled = true;
        status.innerText = '解析中...（シート数が多いと時間がかかります）';
        stats.style.display = 'none';
        lastLogCount = 0;

        // セッションID生成
        sessionId = 'session_' + Date.now();

        // ログポーリング開始（リアルタイムログが有効な場合のみ）
        if (enableLogs) {
          logs.style.display = 'block';
          logs.innerHTML = '';
          logPoller = setInterval(pollLogs, 1000);
        } else {
          logs.style.display = 'none';
        }

        // メイン処理開始
        google.script.run
          .withSuccessHandler(onComplete)
          .withFailureHandler(showError)
          .processSpreadsheets(url, sessionId, format);
      }

      function pollLogs() {
        google.script.run
          .withSuccessHandler(displayLogs)
          .withFailureHandler(function(err) {
            // ポーリングエラーは無視（処理中の一時的なエラー）
            console.log('ログ取得エラー:', err);
          })
          .fetchLogs(sessionId);
      }

      function displayLogs(allLogs) {
        const logs = document.getElementById('logs');

        // 新しいログのみを追記
        if (allLogs.length > lastLogCount) {
          const newLogs = allLogs.slice(lastLogCount);
          newLogs.forEach(log => {
            // console.logにも出力
            const logPrefix = `[${log.type.toUpperCase()}]`;
            if (log.url) {
              console.log(logPrefix, log.message, log.url);
            } else {
              console.log(logPrefix, log.message);
            }

            // UI表示
            const logLine = document.createElement('div');
            logLine.className = 'log-' + log.type;

            if (log.url) {
              const linkText = log.name || log.url;
              logLine.innerHTML = log.message + ': <a href="' + log.url + '" target="_blank" style="color: #0066cc; text-decoration: underline;">' + linkText + '</a>';
            } else {
              logLine.innerText = log.message;
            }

            logs.appendChild(logLine);
          });
          lastLogCount = allLogs.length;
        }
      }

      function onComplete(result) {
        const enableLogs = document.getElementById('enableLogs').checked;

        // ポーリング停止
        if (logPoller) {
          clearInterval(logPoller);
        }

        if (enableLogs) {
          // 最終ログを取得して表示
          google.script.run
            .withSuccessHandler(function(finalLogs) {
              displayLogs(finalLogs);
              downloadZip(result);
            })
            .fetchLogs(sessionId);
        } else {
          downloadZip(result);
        }
      }

      function downloadZip(result) {
        const status = document.getElementById('status');
        const stats = document.getElementById('stats');

        // 統計情報表示
        if (result.stats) {
          stats.style.display = 'block';
          stats.innerHTML = `
            <strong>処理結果：</strong><br>
            ・詳細シート: ${result.stats.detailSheetsSuccess}/${result.stats.detailSheetsTotal}件成功<br>
            ・設計書: ${result.stats.designDocsTotal}件検出<br>
            ・生成ファイル: ${result.stats.filesGenerated}件<br>
            ・エラー/警告: ${result.stats.errors}件
          `;
        }

        // エラーがある場合
        if (result.error) {
          status.innerText = 'エラーが発生しました: ' + result.error;
          document.getElementById('btn').disabled = false;
          return;
        }

        // ZIPダウンロード
        if (result.data) {
          const byteCharacters = atob(result.data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], {type: 'application/zip'});

          const link = document.createElement('a');
          link.href = window.URL.createObjectURL(blob);
          link.download = result.fileName;
          link.click();

          status.innerText = 'ダウンロード完了！';
        }

        document.getElementById('btn').disabled = false;
      }

      function showError(err) {
        // ポーリング停止
        if (logPoller) {
          clearInterval(logPoller);
        }

        const status = document.getElementById('status');
        const logs = document.getElementById('logs');

        status.innerText = 'エラーが発生しました: ' + err.message;

        // エラーログを追加
        const logLine = document.createElement('div');
        logLine.className = 'log-error';
        logLine.innerText = 'エラー: ' + err.message;
        logs.appendChild(logLine);

        document.getElementById('btn').disabled = false;
      }
    </script>
  </body>
</html>