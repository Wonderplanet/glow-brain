<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      line-height: 1.6;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
      font-size: 24px;
      border-bottom: 2px solid #4285f4;
      padding-bottom: 10px;
    }

    /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      background: #f0f0f0;
      border: none;
      border-radius: 8px 8px 0 0;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }
    .tab:hover { background: #e0e0e0; }
    .tab.active {
      background: white;
      color: #4285f4;
      border-bottom: 2px solid #4285f4;
      margin-bottom: -2px;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    button {
      padding: 12px 24px;
      cursor: pointer;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover { background: #3367d6; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #5f6368;
      margin-left: 10px;
    }
    button.secondary:hover { background: #4a4d52; }

    /* ã‚¹ãƒ—ã‚·ä¸€è¦§ */
    .spreadsheet-list {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      background: #fafafa;
      max-height: 400px;
      overflow-y: auto;
    }
    .spreadsheet-item {
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      transition: background 0.2s;
    }
    .spreadsheet-item:hover { background: #f5f5f5; }
    .spreadsheet-item input[type="checkbox"] {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .spreadsheet-item label {
      margin: 0;
      cursor: pointer;
      flex: 1;
      font-weight: normal;
    }
    .list-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .list-actions button.link {
      background: none;
      color: #4285f4;
      padding: 5px 10px;
      text-decoration: underline;
      font-size: 13px;
    }
    .list-actions button.link:hover {
      background: #e8f0fe;
    }

    /* ãƒ­ã‚°è¡¨ç¤º */
    #logs {
      margin-top: 20px;
      border: 1px solid #333;
      padding: 15px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-size: 13px;
      font-family: 'Courier New', monospace;
      display: none;
      white-space: pre-wrap;
      line-height: 1.6;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-info { color: #d4d4d4; }
    .log-success { color: #4ec9b0; font-weight: bold; }
    .log-warn { color: #ce9178; font-weight: bold; }
    .log-error { color: #f48771; font-weight: bold; }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    #status {
      margin-top: 15px;
      padding: 12px;
      background: #e8f0fe;
      border-left: 4px solid #4285f4;
      border-radius: 4px;
      display: none;
    }
    #status.show { display: block; }

    /* ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ */
    .usecase-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .usecase-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
      transition: box-shadow 0.2s;
    }
    .usecase-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .usecase-card h3 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }
    .usecase-card p {
      color: #666;
      margin-bottom: 15px;
    }
    .usecase-card button {
      width: 100%;
    }
    .usecase-card button:disabled {
      background: #e0e0e0;
      color: #999;
    }

    .note {
      margin-top: 20px;
      padding: 12px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      font-size: 13px;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Spreadsheet CSV Exporter</h1>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('single')">å˜ä¸€ã‚¹ãƒ—ã‚·</button>
      <button class="tab" onclick="switchTab('bulk')">ãƒ•ã‚©ãƒ«ãƒ€ä¸€æ‹¬</button>
      <button class="tab" onclick="switchTab('usecase')">ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹</button>
    </div>

    <!-- å˜ä¸€ã‚¹ãƒ—ã‚·ã‚¿ãƒ– -->
    <div id="tab-single" class="tab-content active">
      <p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å…¨ã‚·ãƒ¼ãƒˆã‚’CSVã«å¤‰æ›ã—ã¦ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
      <label for="single-url">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLï¼š</label>
      <input type="text" id="single-url" placeholder="https://docs.google.com/spreadsheets/d/...">
      <button id="btn-single" onclick="downloadSingle()">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <!-- ãƒ•ã‚©ãƒ«ãƒ€ä¸€æ‹¬ã‚¿ãƒ– -->
    <div id="tab-bulk" class="tab-content">
      <p>Google Driveãƒ•ã‚©ãƒ«ãƒ€ã®URLã¾ãŸã¯IDã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
      <label for="folder-input">ãƒ•ã‚©ãƒ«ãƒ€URL / IDï¼š</label>
      <input type="text" id="folder-input" placeholder="https://drive.google.com/drive/folders/... ã¾ãŸã¯ ãƒ•ã‚©ãƒ«ãƒ€ID">
      <button id="btn-list" onclick="listSpreadsheets()">ä¸€è¦§å–å¾—</button>

      <div id="spreadsheet-list" class="spreadsheet-list" style="display: none;">
        <div id="list-container"></div>
        <div class="list-actions">
          <button class="link" onclick="selectAll()">å…¨é¸æŠ</button>
          <button class="link" onclick="deselectAll()">å…¨è§£é™¤</button>
          <span id="selected-count" style="margin-left: auto; color: #666; font-size: 13px;"></span>
        </div>
        <button id="btn-bulk-download" onclick="downloadSelected()" style="margin-top: 15px; width: 100%;">é¸æŠã—ãŸã‚‚ã®ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚¿ãƒ– -->
    <div id="tab-usecase" class="tab-content">
      <p>ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å‘ã‘ã®å°‚ç”¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚</p>

      <div class="usecase-cards">
        <div class="usecase-card">
          <h3>ğŸ® ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿é‹å–¶ä»•æ§˜æ›¸</h3>
          <p>é‹å–¶ä»•æ§˜æ›¸ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å¿…è¦ãªãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
          <button disabled>æº–å‚™ä¸­</button>
        </div>

        <div class="usecase-card">
          <h3>âœ… QAãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹</h3>
          <p>QAã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</p>
          <button disabled>æº–å‚™ä¸­</button>
        </div>

        <div class="usecase-card" id="card-sheet-filter">
          <h3>ğŸ“‹ ã‚·ãƒ¼ãƒˆåãƒ•ã‚£ãƒ«ã‚¿ä¸€æ‹¬</h3>
          <p>ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã€æŒ‡å®šã—ãŸã‚·ãƒ¼ãƒˆåã®ã¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
          <label for="filter-folder-url">ãƒ•ã‚©ãƒ«ãƒ€URL / IDï¼š</label>
          <input type="text" id="filter-folder-url" placeholder="https://drive.google.com/drive/folders/...">
          <label for="filter-sheet-name" style="margin-top: 10px; display: block;">ã‚·ãƒ¼ãƒˆåï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ï¼š</label>
          <input type="text" id="filter-sheet-name" placeholder="ä¾‹: MstEvent">
          <button id="btn-filter-download" onclick="downloadFilteredSheets()" style="margin-top: 15px;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>

        <div class="usecase-card">
          <h3>â• æ–°è¦ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹è¿½åŠ </h3>
          <p>ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã€ã“ã®Webã‚¢ãƒ—ãƒªã‚’æ‹¡å¼µã—ã¦ãã ã•ã„ã€‚</p>
          <button disabled>é–‹ç™ºè€…å‘ã‘</button>
        </div>
      </div>

      <div class="note">
        <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong> ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯ã€ã‚³ãƒ¼ãƒ‰.jsã«æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ ã—ã€ã“ã®HTMLã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status"></div>

    <!-- ãƒ­ã‚°è¡¨ç¤º -->
    <div id="logs"></div>
  </div>

  <script>
    let sessionId = null;
    let logPoller = null;
    let lastLogCount = 0;
    let spreadsheetData = []; // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
      clearStatus();
    }

    // å˜ä¸€ã‚¹ãƒ—ã‚·ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadSingle() {
      const url = document.getElementById('single-url').value;
      if (!url) {
        alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById('btn-single');
      btn.disabled = true;

      sessionId = 'session_' + Date.now();
      showStatus('å‡¦ç†ä¸­...', 'info');
      startLogPolling();

      google.script.run
        .withSuccessHandler(onDownloadComplete)
        .withFailureHandler(onError)
        .downloadSingleSpreadsheet(url, sessionId);
    }

    // ãƒ•ã‚©ãƒ«ãƒ€å†…ã‚¹ãƒ—ã‚·ä¸€è¦§å–å¾—
    function listSpreadsheets() {
      const folderInput = document.getElementById('folder-input').value;
      if (!folderInput) {
        alert('ãƒ•ã‚©ãƒ«ãƒ€URL ã¾ãŸã¯ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById('btn-list');
      btn.disabled = true;

      sessionId = 'session_' + Date.now();
      showStatus('ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œç´¢ä¸­...', 'info');
      startLogPolling();

      google.script.run
        .withSuccessHandler(onListComplete)
        .withFailureHandler(onError)
        .listSpreadsheetsInFolder(folderInput, sessionId);
    }

    // ä¸€è¦§å–å¾—å®Œäº†
    function onListComplete(result) {
      stopLogPolling();
      const btn = document.getElementById('btn-list');
      btn.disabled = false;

      if (result.error) {
        showStatus('ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        return;
      }

      spreadsheetData = result.spreadsheets;

      if (spreadsheetData.length === 0) {
        showStatus('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warn');
        return;
      }

      showStatus(`${spreadsheetData.length}ä»¶ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸ`, 'success');

      // ä¸€è¦§è¡¨ç¤º
      const listContainer = document.getElementById('list-container');
      listContainer.innerHTML = '';

      spreadsheetData.forEach((ss, index) => {
        const item = document.createElement('div');
        item.className = 'spreadsheet-item';
        item.innerHTML = `
          <input type="checkbox" id="ss-${index}" value="${ss.id}" onchange="updateSelectedCount()">
          <label for="ss-${index}">${ss.name}</label>
        `;
        listContainer.appendChild(item);
      });

      document.getElementById('spreadsheet-list').style.display = 'block';
      updateSelectedCount();
    }

    // é¸æŠæ•°ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('#list-container input[type="checkbox"]');
      const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
      document.getElementById('selected-count').innerText = `${checked}ä»¶é¸æŠä¸­`;
    }

    // å…¨é¸æŠ
    function selectAll() {
      document.querySelectorAll('#list-container input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateSelectedCount();
    }

    // å…¨è§£é™¤
    function deselectAll() {
      document.querySelectorAll('#list-container input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateSelectedCount();
    }

    // é¸æŠã—ãŸã‚¹ãƒ—ã‚·ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆé †æ¬¡å‡¦ç†ï¼‰
    function downloadSelected() {
      const checkboxes = document.querySelectorAll('#list-container input[type="checkbox"]:checked');

      if (checkboxes.length === 0) {
        alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const selectedIds = Array.from(checkboxes).map(cb => cb.value);

      const btn = document.getElementById('btn-bulk-download');
      btn.disabled = true;

      sessionId = 'session_' + Date.now();
      showStatus(`${selectedIds.length}ä»¶ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å‡¦ç†ä¸­...`, 'info');
      startLogPolling();

      // é †æ¬¡ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      processNextSpreadsheet(selectedIds, 0);
    }

    // é †æ¬¡å‡¦ç†ï¼ˆå†å¸°çš„ã«1ã¤ãšã¤ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
    function processNextSpreadsheet(ids, index) {
      if (index >= ids.length) {
        // å…¨ã¦å®Œäº†
        stopLogPolling();
        showStatus('å…¨ã¦ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
        document.getElementById('btn-bulk-download').disabled = false;
        return;
      }

      const ssId = ids[index];
      const ssName = spreadsheetData.find(s => s.id === ssId)?.name || 'Unknown';

      showStatus(`[${index + 1}/${ids.length}] ${ssName} ã‚’å‡¦ç†ä¸­...`, 'info');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            showStatus(`[${index + 1}/${ids.length}] ã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
          } else {
            // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadZip(result);
          }

          // æ¬¡ã®ã‚¹ãƒ—ã‚·ã‚’å‡¦ç†ï¼ˆ500mså¾…æ©Ÿï¼‰
          setTimeout(() => {
            processNextSpreadsheet(ids, index + 1);
          }, 500);
        })
        .withFailureHandler(function(err) {
          showStatus(`[${index + 1}/${ids.length}] ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æ¬¡ã¸é€²ã‚€
          setTimeout(() => {
            processNextSpreadsheet(ids, index + 1);
          }, 500);
        })
        .downloadSpreadsheetById(ssId, sessionId);
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†
    function onDownloadComplete(result) {
      stopLogPolling();
      document.getElementById('btn-single').disabled = false;

      if (result.error) {
        showStatus('ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        return;
      }

      downloadZip(result);
      showStatus('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼', 'success');
    }

    // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadZip(result) {
      if (!result.data) return;

      const byteCharacters = atob(result.data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], {type: 'application/zip'});

      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = result.fileName;
      link.click();
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.innerText = message;
      status.className = 'show';

      // è‰²åˆ†ã‘
      if (type === 'success') {
        status.style.background = '#d4edda';
        status.style.borderColor = '#28a745';
        status.style.color = '#155724';
      } else if (type === 'error') {
        status.style.background = '#f8d7da';
        status.style.borderColor = '#dc3545';
        status.style.color = '#721c24';
      } else if (type === 'warn') {
        status.style.background = '#fff3cd';
        status.style.borderColor = '#ffc107';
        status.style.color = '#856404';
      } else {
        status.style.background = '#e8f0fe';
        status.style.borderColor = '#4285f4';
        status.style.color = '#1a73e8';
      }
    }

    function clearStatus() {
      document.getElementById('status').className = '';
      document.getElementById('logs').style.display = 'none';
    }

    // ãƒ­ã‚°ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
    function startLogPolling() {
      document.getElementById('logs').style.display = 'block';
      document.getElementById('logs').innerHTML = '';
      lastLogCount = 0;
      logPoller = setInterval(pollLogs, 5000);  // 5ç§’ã”ã¨
    }

    // ãƒ­ã‚°ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
    function stopLogPolling() {
      if (logPoller) {
        clearInterval(logPoller);
        logPoller = null;
      }
    }

    // ãƒ­ã‚°å–å¾—
    function pollLogs() {
      google.script.run
        .withSuccessHandler(displayLogs)
        .withFailureHandler(err => console.log('ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', err))
        .fetchLogs(sessionId);
    }

    // ãƒ­ã‚°è¡¨ç¤º
    function displayLogs(allLogs) {
      const logs = document.getElementById('logs');

      if (allLogs.length > lastLogCount) {
        const newLogs = allLogs.slice(lastLogCount);
        newLogs.forEach(log => {
          const logLine = document.createElement('div');
          logLine.className = 'log-' + log.type;
          logLine.innerText = log.message;
          logs.appendChild(logLine);
        });
        lastLogCount = allLogs.length;

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        logs.scrollTop = logs.scrollHeight;
      }
    }

    // ã‚·ãƒ¼ãƒˆåãƒ•ã‚£ãƒ«ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadFilteredSheets() {
      const folderInput = document.getElementById('filter-folder-url').value;
      const sheetName = document.getElementById('filter-sheet-name').value;

      if (!folderInput) {
        alert('ãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!sheetName) {
        alert('ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById('btn-filter-download');
      btn.disabled = true;

      sessionId = 'session_' + Date.now();
      showStatus(`ã‚·ãƒ¼ãƒˆã€Œ${sheetName}ã€ã‚’æ¤œç´¢ä¸­...`, 'info');
      startLogPolling();

      google.script.run
        .withSuccessHandler(onFilteredDownloadComplete)
        .withFailureHandler(onError)
        .downloadFilteredSheets(folderInput, sheetName, sessionId);
    }

    // ã‚·ãƒ¼ãƒˆåãƒ•ã‚£ãƒ«ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†
    function onFilteredDownloadComplete(result) {
      stopLogPolling();
      document.getElementById('btn-filter-download').disabled = false;

      if (result.error) {
        showStatus('ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
        return;
      }

      if (result.matchCount === 0) {
        showStatus(result.message, 'warn');
        return;
      }

      downloadZip(result);
      showStatus(result.message, 'success');
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function onError(err) {
      stopLogPolling();
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');

      // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('btn-single').disabled = false;
      document.getElementById('btn-list').disabled = false;
      document.getElementById('btn-bulk-download').disabled = false;
    }
  </script>
</body>
</html>
