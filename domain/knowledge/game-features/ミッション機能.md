# ミッション機能

## 概要

ミッション機能は、プレイヤーに対して様々な達成条件を提示し、達成時に報酬を付与するゲーム内システムです。

---

## アプリ画面

### 画面構成

ミッション機能は**4つのタブ**で構成され、タブ切り替えで各種ミッションにアクセスできます。

#### 1. ログインボーナスタブ

![ログインボーナス](../../raw-data/app-screen/20251227/ログインボーナス.jpg)

- 7日間のスタンプカード形式
- 毎日ログインで自動達成、報酬を即座に表示
- 報酬は自動受け取り（ユーザー操作不要）

#### 2. デイリーミッションタブ

![デイリーミッション](../../raw-data/app-screen/20251227/デイリーミッション.jpg)

- 日次リセットされるミッション一覧
- 上部にボーナスポイントゲージと宝箱報酬表示
- 各ミッションに進捗ゲージと受け取りボタン
- 挑戦するボタン → 対象機能へ遷移
- 一括受け取りボタン（画面下部）

#### 3. ウィークリーミッションタブ

- デイリーミッションと同様のUI構成
- 週次リセット

#### 4. アチーブメントミッションタブ

- 永続的な達成目標
- グループごとに段階的に開放（依存関係あり）
- ボーナスポイント表示なし

#### 5. 初心者ミッション（期間限定表示）

![初心者ミッション](../../raw-data/app-screen/20251227/初心者ミッション.jpg)

- 新規ユーザー向けの期間限定ミッション
- 下部に7日間の日付タブ表示
- ボーナスポイント宝箱表示（「プリズム1500個もらえる！」等）

#### 6. イベントミッション（イベント期間中のみ）

![イベントミッション](../../raw-data/app-screen/20251227/イベントミッション.jpg)

- イベント開催期間中のみ表示
- イベント専用のミッション一覧
- 「いいジャン祭限定ログインボーナス」と「いいジャン祭ミッション」の2タブ構成
- イベント終了までの残り時間表示

### 共通UI要素

- **タブ切り替え**：ログインボーナス / デイリー / ウィークリー / アチーブメント
- **バッジ表示**：受け取り可能な報酬があるタブに赤丸通知
- **次回更新時刻**：「残り10時間」等、リアルタイムカウントダウン
- **一括受け取りボタン**：達成済みミッションをまとめて受け取り
- **閉じるボタン**：ミッション画面を閉じてホーム画面へ戻る

---

## 他の画面からのミッション機能へのアクセス

### ホーム画面のミッションアイコン

![ホーム画面](../../raw-data/app-screen/20251227/ホーム.jpg)

ホーム画面の左側には、ミッション関連のアイコンが配置されています。

| アイコン | 遷移先 | バッジ表示条件 |
|---------|--------|---------------|
| 初心者ミッション | ミッション画面（初心者ミッションタブ） | 受け取られていない初心者ミッション報酬がある |
| デイリーミッション | ミッション画面（デイリーミッションタブ） | 受け取られていないデイリーミッション報酬がある |
| イベントミッション | ミッション画面（イベントミッションタブ） | 受け取られていないイベントミッション報酬がある |

**バッジの更新タイミング**
- ホーム画面表示時
- 他の画面から戻ってきた時（報酬受け取り後など）
- 10秒ごとの自動更新（ホーム画面表示中）

### 降臨バトル画面のミッションアイコン

![降臨バトルトップ](../../raw-data/app-screen/20251227/降臨バトルトップ.jpg)

降臨バトル画面の右下に「降臨バトルミッション」アイコンが配置されています。

| アイコン | 遷移先 | バッジ表示条件 |
|---------|--------|---------------|
| 降臨バトルミッション | ミッション画面（降臨バトルミッション） | 受け取られていない降臨バトルミッション報酬がある |

**バッジの更新タイミング**
- 降臨バトル画面表示時
- ミッション画面から戻る時（報酬受け取り後など）

---

## 画面遷移

### ミッション画面への遷移

```
ホーム画面
  ├─ 初心者ミッションアイコン → ミッション画面（初心者ミッションタブ）
  ├─ デイリーミッションアイコン → ミッション画面（デイリーミッションタブ）
  └─ イベントミッションアイコン → ミッション画面（イベントミッションタブ）

降臨バトル画面
  └─ 降臨バトルミッションアイコン → ミッション画面（降臨バトルミッション）
```

### タブ切り替え

```
ミッションメイン画面
  ├─ ログインボーナスタブ → ログインボーナス画面
  ├─ デイリーミッションタブ → デイリーミッション一覧
  ├─ ウィークリーミッションタブ → ウィークリーミッション一覧
  └─ アチーブメントタブ → アチーブメント一覧
```

### ミッションからの遷移（チャレンジボタン）

各ミッションの「チャレンジする」ボタンから、達成条件に関連する画面へ遷移します。

| 遷移先設定 | 遷移先画面 |
|-----------|-----------|
| `Home` / `StageSelect` | ホーム画面（ミッション画面を閉じる） |
| `QuestSelect` | クエスト選択画面 |
| `UnitList` | ユニット一覧画面 |
| `IdleIncentive` | 探索画面 |
| `OutpostEnhance` | アウトポスト強化画面 |
| `Gacha` | ガチャ画面 |
| `Event` | イベント画面 |
| `Pvp` | PvP画面 |
| `Web` | 外部Webサイト（ブラウザで開く） |

※ `Web` の場合、ブラウザからアプリに戻ると自動的にミッション達成判定を実行

### 報酬受け取り後の遷移

```
ミッション一覧画面
  ↓ 受け取りボタンをタップ
報酬確認ポップアップ
  ↓ 閉じる
ミッション一覧画面（バッジとボタン状態が自動更新）
```

---

## APIリクエスト

### 実行タイミングと用途

| タイミング | API | メソッド | 用途 |
|-----------|-----|---------|------|
| **ミッション画面表示時** | `/api/mission/update_and_fetch` | POST | 全ミッション種別（Achievement/DailyBonus/Daily/Weekly/Beginner）の進捗・達成状態・報酬受け取り状態を取得。ローカル通知スケジュールも更新。 |
| **イベントミッション画面表示時** | `/api/mission/event_update_and_fetch` | POST | イベントミッション（Event/EventDaily）の進捗・達成状態を取得。 |
| **降臨バトルミッション画面表示時** | `/api/mission/advent_battle_fetch` | POST | 降臨バトル関連のミッション（EventとLimitedTerm）を取得。 |
| **一括報酬受け取り時** | `/api/mission/bulk_receive_reward` | POST | 選択したミッション種別（missionType）と複数のミッションID（mstMissionIds）を指定して、達成済みミッションの報酬を一括取得。レスポンスに全報酬とボーナスポイント報酬を含む。 |
| **Webミッション達成判定時** | `/api/mission/clear_on_call` | POST | アチーブメントミッションの「Web」遷移先を持つミッションで、ユーザーがWebサイトを訪問後にアプリへ復帰した際に自動実行。サーバー側で達成判定を行う。 |
| **イベントデイリーボーナス受け取り時** | `/api/mission/event_daily_bonus_update` | POST | イベント期間中のデイリーログインボーナスを更新・受け取り。 |
| **バッジ情報更新時** | `/api/game/badge` | GET | 各種ミッションの未受け取り報酬数を取得し、ホーム画面や各画面のバッジ表示を更新。ホーム画面表示時、他画面から戻った時、10秒ごとの定期更新で実行。 |

### API呼び出しフロー

#### ミッション画面表示フロー

```
ユーザーがミッション画面を開く
  ↓
API: POST /api/mission/update_and_fetch
  ↓
レスポンス：
  - usrMissionAchievements（アチーブメント進捗）
  - usrMissionDailyBonuses（ログインボーナス進捗）
  - usrMissionDailies（デイリーミッション進捗）
  - usrMissionWeeklies（ウィークリーミッション進捗）
  - usrMissionBeginners（初心者ミッション進捗）
  - usrMissionBonusPoints（ボーナスポイント状態）
  ↓
画面描画
  - ミッション一覧表示
  - バッジ表示更新
  - ボーナスポイントゲージ表示
  - 次回更新時刻表示
```

#### 報酬受け取りフロー

```
ユーザーが「一括受け取り」ボタンをタップ
  ↓
API: POST /api/mission/bulk_receive_reward
  Body: { missionType: "Daily", mstMissionIds: ["daily_001", "daily_002", ...] }
  ↓
レスポンス：
  - missionReceiveRewards（受け取り結果、未受取理由を含む）
  - missionRewards（報酬詳細）
  - usrParameter（更新されたユーザーパラメータ）
  - usrItems（更新されたアイテム所持数）
  - usrUnits（更新されたユニット所持数）
  - userLevel（レベルアップ情報）
  ↓
報酬確認ポップアップ表示
  ↓
ボーナスポイント報酬確認（宝箱を開けた場合）
  ↓
画面再描画
  - バッジ表示更新
  - 一括受け取りボタンの状態更新
```

#### Webミッション達成判定フロー

```
ユーザーがアチーブメントミッションの「チャレンジする」をタップ
  ↓
遷移先が "Web" の場合
  ↓
外部ブラウザでWebサイトを開く
  ↓
ユーザーがアプリに復帰
  ↓
API: POST /api/mission/clear_on_call
  Body: { missionType: "Achievement", mstMissionId: "ach_web_001" }
  ↓
レスポンス：
  - usrMissionAchievements（更新された進捗）
  ↓
画面再描画（進捗ゲージ更新）
```

#### バッジ情報更新フロー

```
ホーム画面表示時 / 他画面から戻った時 / 10秒ごとの定期更新
  ↓
API: GET /api/game/badge
  ↓
レスポンス：
  - badges
    - unreceivedMissionRewardCount（通常ミッション未受け取り数）
    - unreceivedMissionBeginnerRewardCount（初心者ミッション未受け取り数）
    - unreceivedMissionEventRewardCounts[]（イベントごとのミッション未受け取り数）
      - mstEventId
      - count
    - unreceivedMissionAdventBattleRewardCount（降臨バトルミッション未受け取り数）
    - unopenedMessageCount（未開封メッセージ数）
  ↓
バッジ情報をキャッシュに保存
  ↓
各画面のバッジ表示を更新
  - ホーム画面：ミッションアイコンのバッジ（初心者/デイリー/イベント）
  - クエストコンテンツトップ：イベントごとのミッションバッジ
  - 降臨バトル画面：降臨バトルミッションバッジ
```

---

## マスタテーブル設定

ミッション機能で使用するマスタテーブルは以下の通りです。

### 基本マスタテーブル

| テーブル名 | 役割 |
|-----------|------|
| `MstMissionAchievement` | アチーブメントミッション定義（達成条件、報酬グループID、ソート順、遷移先） |
| `MstMissionAchievementI18n` | アチーブメントミッションの多言語テキスト（説明文） |
| `MstMissionAchievementDependency` | アチーブメントミッションの依存関係（グループ内の開放順序） |
| `MstMissionDaily` | デイリーミッション定義（達成条件、ボーナスポイント、報酬グループID） |
| `MstMissionDailyI18n` | デイリーミッションの多言語テキスト |
| `MstMissionWeekly` | ウィークリーミッション定義 |
| `MstMissionWeeklyI18n` | ウィークリーミッションの多言語テキスト |
| `MstMissionBeginner` | 初心者ミッション定義（開放日数、達成条件、ボーナスポイント） |
| `MstMissionBeginnerI18n` | 初心者ミッションの多言語テキスト（タイトル、説明文） |
| `MstMissionBeginnerPromptPhraseI18n` | 初心者ミッション促進フレーズ（期間指定で表示） |

### イベントミッション用マスタテーブル

| テーブル名 | 役割 |
|-----------|------|
| `MstMissionEvent` | イベントミッション定義（イベントID、達成条件、カテゴリ） |
| `MstMissionEventI18n` | イベントミッションの多言語テキスト |
| `MstMissionEventDependency` | イベントミッションの依存関係 |
| `MstMissionEventDaily` | イベントデイリーミッション定義 |
| `MstMissionEventDailyI18n` | イベントデイリーミッションの多言語テキスト |
| `MstMissionLimitedTerm` | 期間限定ミッション定義（開始・終了日時、カテゴリ） |
| `MstMissionLimitedTermDependency` | 期間限定ミッションの依存関係 |
| `MstMissionLimitedTermI18n` | 期間限定ミッションの多言語テキスト |

### 報酬とボーナス用マスタテーブル

| テーブル名 | 役割 |
|-----------|------|
| `MstMissionReward` | ミッション報酬定義（報酬グループID、リソースタイプ、リソースID、数量） |
| `MstMissionDailyBonus` | デイリーログインボーナス定義（ログイン日数、報酬グループID） |
| `MstMissionEventDailyBonus` | イベントデイリーログインボーナス定義 |
| `MstMissionEventDailyBonusSchedule` | イベントデイリーログインボーナススケジュール（開始・終了日時） |
| `MstDailyBonusReward` | デイリーボーナス報酬定義（グループID、リソースタイプ、数量） |

### カムバックボーナス用マスタテーブル

| テーブル名 | 役割 |
|-----------|------|
| `MstComebackBonus` | カムバックボーナス定義（ログイン日数、報酬グループID） |
| `MstComebackBonusSchedule` | カムバックボーナススケジュール（休眠条件日数、有効期間、開始・終了日時） |

---

## 参考資料

- [ミッション画面スクリーンショット](../../raw-data/app-screen/20251227/)
- [ホーム画面](../../raw-data/app-screen/20251227/ホーム.jpg) - ミッションアイコンとバッジ表示
- [降臨バトルトップ](../../raw-data/app-screen/20251227/降臨バトルトップ.jpg) - 降臨バトルミッションアイコン
- [API定義](../../projects/glow-schema/Schema/Mission.yml)
