# MstKomaLine 詳細解説

## 1. 概要

`MstKomaLine` はインゲームバトルのフィールドを構成する**コマライン（行）定義テーブル**です。

GLOW のインゲームフィールドは **ページ（MstPage）→ コマライン（MstKomaLine）→ コマ（キャラ/オブジェクト）** の3階層で構成されます。各コマラインは1つのページに属し、縦方向の「行」を表します。1ライン内には最大4つのコマ（koma1〜koma4）を配置でき、各コマに独立してエフェクトを設定できます。

| 項目 | 内容 |
|------|------|
| **DBテーブル名** | （スキーマ未定義、CSVのみ） |
| **CSVファイル名** | `MstKomaLine.csv` |
| **クライアントクラス** | `MstKomaLineData.cs` |
| **総レコード数** | 1,419件 |
| **主なユースケース** | インゲームバトルフィールドのコマ配置定義 |

---

## 2. 全カラム一覧

### 基本情報

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| `ENABLE` | varchar | - | 有効フラグ（CSVでは `e` が入力される） |
| `id` | varchar | NO | コマラインの一意識別子（主キー） |
| `mst_page_id` | varchar | NO | 所属ページID（MstPage.id への外部キー） |
| `row` | integer | NO | ページ内の行番号（1〜N、上から順番） |
| `height` | float | NO | ライン高さの相対比率（例：0.52、0.55） |
| `koma_line_layout_asset_key` | float | YES | ラインレイアウトのアセット番号（0.55、1〜12の整数値） |
| `release_key` | integer | NO | リリースキー（マスタデータ反映制御） |

### コマ1（必須スロット）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| `koma1_asset_key` | varchar | NO | コマのキャラ/オブジェクトアセットキー |
| `koma1_width` | float | NO | コマの横幅比率（ライン幅を1.0とした相対値） |
| `koma1_back_ground_offset` | float | NO | 背景テクスチャの縦オフセット |
| `koma1_effect_type` | varchar | NO | コマエフェクトの種類（`KomaEffectType` enum） |
| `koma1_effect_parameter1` | integer | YES | エフェクトのパラメータ1（効果値・%など） |
| `koma1_effect_parameter2` | float | YES | エフェクトのパラメータ2（継続時間など） |
| `koma1_effect_target_side` | varchar | NO | エフェクト対象側（`KomaEffectTargetSide` enum） |
| `koma1_effect_target_colors` | varchar | YES | エフェクト対象のカラー絞り込み（`All` または色名カンマ区切り） |
| `koma1_effect_target_roles` | varchar | YES | エフェクト対象のロール絞り込み（`All` またはロール名カンマ区切り） |

### コマ2〜4（オプションスロット）

koma2〜4 は koma1 と同一カラム構造。NULL可（コマが存在しない場合は空文字またはNULL）。

| カラム名パターン | 型 | NULL | 説明 |
|----------------|-----|------|------|
| `koma{N}_asset_key` | varchar | YES | コマNのアセットキー（空なら未使用） |
| `koma{N}_width` | float | YES | コマNの横幅比率 |
| `koma{N}_back_ground_offset` | float | YES | コマNの背景オフセット |
| `koma{N}_effect_type` | varchar | YES | コマNのエフェクト種別 |
| `koma{N}_effect_parameter1` | varchar | YES | コマNのエフェクトパラメータ1 |
| `koma{N}_effect_parameter2` | varchar | YES | コマNのエフェクトパラメータ2 |
| `koma{N}_effect_target_side` | varchar | YES | コマNのエフェクト対象側 |
| `koma{N}_effect_target_colors` | varchar | YES | コマNのエフェクト対象カラー |
| `koma{N}_effect_target_roles` | varchar | YES | コマNのエフェクト対象ロール |

---

## 3. 主要な enum / フラグの解説

### KomaEffectType（コマエフェクト種別）

クライアント定義: `KomaEffectType.cs`（AutoGenerated）

| 値 | 説明 | parameter1 | parameter2 |
|----|------|-----------|-----------|
| `None` | エフェクトなし | 0（固定） | 0（固定） |
| `AttackPowerUp` | 攻撃力アップ | 上昇率（%）例：10, 20, 50 | 0（未使用） |
| `AttackPowerDown` | 攻撃力ダウン | 低下率（%）例：15, 30, 50 | 0（未使用） |
| `MoveSpeedUp` | 移動速度アップ | 上昇率（%） | 0（未使用） |
| `SlipDamage` | スリップダメージ | ダメージ量 | 0（未使用） |
| `Gust` | 吹き飛ばし | 持続時間（ティック数） | 方向（TargetSideで決定） |
| `Poison` | 毒（持続状態効果） | 継続時間（TickCount換算） | 効果強度 |
| `Darkness` | 暗闇（視界妨害） | 0（固定） | 0（固定） |
| `Burn` | 燃焼（持続ダメージ） | ダメージ量（例：100） | 継続時間（例：1000） |
| `Stun` | スタン（行動不能） | 継続時間 | 0（未使用） |
| `Freeze` | 凍結（行動不能） | 継続時間 | 0（未使用） |
| `Weakening` | 弱体化 | 効果値 | 0（未使用） |

**エフェクト処理の分類**（KomaModelFactory.cs より）:
- `Gust`: 専用クラス `GustKomaEffectModel`
- `Poison`, `Burn`, `Stun`, `Freeze` など持続系: `PersistentStateKomaEffectModel`
- `Darkness`: 専用クラス `DarknessKomaEffectModel`
- その他: 汎用 `StateKomaEffectModel`

### KomaEffectTargetSide（エフェクト対象サイド）

クライアント定義: `KomaEffectTargetSide.cs`（AutoGenerated）

| 値 | 説明 |
|----|------|
| `All` | プレイヤー・敵の両方を対象 |
| `Player` | プレイヤー側のキャラのみ対象 |
| `Enemy` | 敵キャラのみ対象 |

> Gust エフェクトは `TargetSide == Enemy` で右方向（`GustEffectDirection.ToEnemy`）、それ以外で左方向（`GustEffectDirection.ToPlayer`）になる。

### koma_line_layout_asset_key（ラインレイアウト番号）

コマの視覚的配置パターンを示すアセット参照番号。取り得る値:

| 値 | 備考 |
|----|------|
| 0.55 | 特殊レイアウト |
| 1〜12 | レイアウトパターン1〜12 |

1コマ構成では通常 `1.0`、2コマ以上では幅比率に合わせたパターン番号を使用。

---

## 4. 命名規則 / IDの生成ルール

### id の命名規則

コマラインIDは対応するページIDに行番号を付加したパターンが多い:

```
{mst_page_id}_{row番号}
```

**例:**
- ページ `normal_dan_00001` → `normal_dan_00001_1`, `normal_dan_00001_2`, ...
- ページ `event_dan1_chara01_00001` → `event_dan1_chara01_00001_1`, ...

一部のテストデータや開発用データは独自形式:
- `plan_test_stage001_01`（ゼロパディング2桁形式）
- `line_develop_001_1`（developプレフィックス形式）

### mst_page_id のパターン（実データより）

| パターン | 説明 |
|---------|------|
| `normal_*` | 通常ステージのページ |
| `hard_*` | ハードステージのページ |
| `veryhard_*` | ベリーハードステージのページ |
| `event_{キャラ名}_*` | イベントステージのページ |
| `plan_test_*` | テスト用ページ |
| `page_develop_*` | 開発用ページ |

---

## 5. 他テーブルとの連携

```
MstPage (1)
    └── MstKomaLine (N)  ← mst_page_id で結合
            ├── koma1_asset_key → キャラ/オブジェクトアセット
            ├── koma2_asset_key → キャラ/オブジェクトアセット
            ├── koma3_asset_key → キャラ/オブジェクトアセット
            └── koma4_asset_key → キャラ/オブジェクトアセット
```

| 参照先 | 結合カラム | 説明 |
|--------|---------|------|
| `MstPage` | `mst_page_id` → `MstPage.id` | 親テーブル。ページに属するラインをすべて取得してフィールドを構築する |

**クライアント実装での使用箇所**（主要ファイル）:

| ファイル | 用途 |
|---------|------|
| `InitializeInGameUseCase.cs` | インゲーム初期化時にコマラインデータを読み込む |
| `KomaModelFactory.cs` | コマラインの1コマからKomaModelを生成 |
| `FieldViewConstructDataBuilder.cs` | フィールドビューのデータ構築 |
| `KomaExpander.cs` | コマの展開表示処理 |
| `PageComponent.cs` | ページUIコンポーネントの構築 |
| `AttackRangeConverter.cs` | 攻撃範囲計算でのコマライン参照 |

---

## 6. 実データ例

### 例1: シンプルな1コマライン（None エフェクト）

```
id:                       plan_test_stage001_01
mst_page_id:              plan_test_stage001
row:                      1
height:                   0.55
koma_line_layout_asset_key: 1
koma1_asset_key:          jig_00003
koma1_width:              1.0
koma1_back_ground_offset: -0.5
koma1_effect_type:        None
koma1_effect_parameter1:  0
koma2_asset_key:          (空)
release_key:              999999999
```

→ 1コマのみ、エフェクトなしの基本的なライン。

### 例2: 2コマ構成・異なるエフェクト付き

```
id:                       normal_dan_00002_2
mst_page_id:              normal_dan_00002
row:                      2
height:                   0.52
koma_line_layout_asset_key: 5
koma1_asset_key:          dan_00006
koma1_width:              0.25
koma1_effect_type:        Darkness
koma1_effect_parameter1:  0
koma2_asset_key:          dan_00006
koma2_width:              0.75
koma2_effect_type:        Darkness
koma2_effect_parameter1:  0
release_key:              (リリースキー)
```

→ 同一キャラを2コマ配置し、両方に暗闇エフェクト。幅比率 0.25 + 0.75 = 1.0 でライン幅を分割。

### 例3: 3コマ構成・複合エフェクト

```
id:                       hard_dan_00006_2
mst_page_id:              hard_dan_00006
row:                      2
koma_line_layout_asset_key: 9
koma1_asset_key:          dan_00007
koma1_width:              0.25
koma1_effect_type:        Darkness
koma2_asset_key:          dan_00007
koma2_width:              0.5
koma2_effect_type:        AttackPowerUp
koma3_asset_key:          dan_00007
koma3_width:              (残り)
koma4_asset_key:          (空)
```

→ 3コマ構成で、コマごとに異なるエフェクトを割り当て。

### 例4: 攻撃力アップ/ダウンエフェクト付きライン

```
id:                       line_develop_001_1
mst_page_id:              page_develop_001
koma1_asset_key:          glo_00001
koma1_width:              0.4
koma1_effect_type:        None
koma2_asset_key:          glo_00001
koma2_width:              0.6
koma2_effect_type:        AttackPowerDown
koma2_effect_parameter1:  50     ← 攻撃力50%ダウン
koma2_effect_parameter2:  0
koma2_effect_target_side: All
```

---

## 7. 設定時のポイント

### コマ幅の合計

1ライン内のすべてのコマ幅（`koma1_width` + `koma2_width` + ...）は **合計 1.0** になるよう設定する。1コマのみの場合は `koma1_width = 1.0`。

### エフェクト設定の必須条件

- `koma1_effect_type` は必須（`None` で「エフェクトなし」を明示）
- エフェクトが `None` の場合も `koma1_effect_target_side = All` を設定する
- `koma2_asset_key` が空の場合、koma2のエフェクト関連フィールドもすべて空/NULLにする

### koma1 は必須スロット

koma1 は必ず設定が必要。koma2〜4 はオプションで、使用しない場合は空欄にする。

### koma_line_layout_asset_key の選択

コマ数と幅比率に合わせて適切なレイアウト番号を選択する:
- 1コマ全幅: `1` が一般的
- 2コマ: 幅比率に応じて `2`〜`8` 付近から選択
- 3コマ以上: `9`〜`12` 付近から選択

### Gust エフェクトの方向制御

Gust エフェクトは `koma{N}_effect_target_side` で方向が決まる:
- `Enemy` → 右方向（敵を吹き飛ばす）
- `Player` または `All` → 左方向（プレイヤーを吹き飛ばす）

### タブ混入に注意

CSVデータに `AttackPowerDown\t\t\t\t` のようなタブ文字が混入しているケースが確認されている。CSV作成時はenum値のトリミングを確認すること。
