# インゲーム マスタデータ リレーション図

> 参照リリースキー: 202602015

---

## 1. 全体構造（4層の概要）

```mermaid
flowchart TD
    subgraph QUEST["🗂️ クエスト層（コンテンツ入口）"]
        MstEvent["MstEvent\nイベント"]
        MstQuest["MstQuest\nクエスト"]
        MstQuestI18n["MstQuestI18n\n名称・テキスト"]
        MstQuestBonusUnit["MstQuestBonusUnit\nユニットボーナス"]
        MstQuestEventBonusSchedule["MstQuestEventBonusSchedule\nイベントボーナス"]
    end

    subgraph STAGE["⚔️ ステージ層（個別バトル設定）"]
        MstStage["MstStage\nステージ"]
        MstStageI18n["MstStageI18n\n名称"]
        MstStageEventSetting["MstStageEventSetting\n期間・制限設定"]
        MstStageEventReward["MstStageEventReward\nドロップ報酬"]
        MstStageClearTimeReward["MstStageClearTimeReward\nタイムアタック報酬"]
        MstStageEndCondition["MstStageEndCondition\n終了条件"]
        MstInGameSpecialRule["MstInGameSpecialRule\n特別ルール"]
    end

    subgraph INGAME["🏟️ インゲーム層（バトルフィールド設定）"]
        MstInGame["MstInGame\nインゲーム"]
        MstInGameI18n["MstInGameI18n\n説明文・ティップス"]
    end

    subgraph FIELD["🗺️ フィールド層（地形）"]
        MstPage["MstPage\nページ"]
        MstKomaLine["MstKomaLine\nコマ配置・効果"]
    end

    subgraph ENEMY["👾 敵層"]
        MstAutoPlayerSequence["MstAutoPlayerSequence\n敵出現シーケンス"]
        MstEnemyStageParameter["MstEnemyStageParameter\n敵パラメータ"]
        MstEnemyCharacter["MstEnemyCharacter\n敵キャラ"]
        MstEnemyCharacterI18n["MstEnemyCharacterI18n\n名称"]
        MstEnemyOutpost["MstEnemyOutpost\n敵砦"]
        MstInGameGimmickObject["MstInGameGimmickObject\nギミックオブジェクト"]
    end

    MstEvent --> MstQuest
    MstQuest --> MstQuestI18n
    MstQuest --> MstQuestBonusUnit
    MstQuest --> MstQuestEventBonusSchedule
    MstQuest --> MstStage

    MstStage --> MstStageI18n
    MstStage --> MstStageEventSetting
    MstStage --> MstStageEventReward
    MstStage --> MstStageClearTimeReward
    MstStage --> MstStageEndCondition
    MstStage -->|target_id| MstInGameSpecialRule
    MstStage --> MstInGame

    MstInGame --> MstInGameI18n
    MstInGame --> MstPage
    MstInGame --> MstEnemyOutpost
    MstInGame -->|boss_mst_enemy_stage_parameter_id| MstEnemyStageParameter
    MstInGame -->|sequence_set_id| MstAutoPlayerSequence

    MstPage --> MstKomaLine

    MstAutoPlayerSequence -->|action_value| MstEnemyStageParameter
    MstAutoPlayerSequence -->|action_value| MstInGameGimmickObject
    MstEnemyStageParameter --> MstEnemyCharacter
    MstEnemyCharacter --> MstEnemyCharacterI18n
```

---

## 2. クエスト〜ステージ層 ER図

```mermaid
erDiagram
    MstEvent {
        string id PK
        string asset_key
        datetime start_date
        datetime end_date
    }

    MstQuest {
        string id PK
        string quest_type "Normal/Event/Enhance/Tutorial"
        string mst_event_id FK
        int sort_order
        string asset_key
        string quest_group
        string difficulty
        datetime start_date
        datetime end_date
    }

    MstQuestI18n {
        string id PK
        string mst_quest_id FK
        string language
        string name
        string category_name
        string flavor_text
    }

    MstQuestBonusUnit {
        int id PK
        string mst_quest_id FK
        string mst_unit_id FK
        float coin_bonus_rate
        datetime start_at
        datetime end_at
    }

    MstQuestEventBonusSchedule {
        int id PK
        string mst_quest_id FK
        string event_bonus_group_id
        datetime start_at
        datetime end_at
    }

    MstStage {
        string id PK
        string mst_quest_id FK
        string mst_in_game_id FK
        int stage_number
        int recommended_level
        int cost_stamina
        int exp
        int coin
        string prev_mst_stage_id FK
        string auto_lap_type "NULL/AfterClear"
        int max_auto_lap_count
        int sort_order
        string asset_key
        datetime start_at
        datetime end_at
    }

    MstStageI18n {
        string id PK
        string mst_stage_id FK
        string language
        string name
        string category_name
    }

    MstStageEventSetting {
        int id PK
        string mst_stage_id FK
        string reset_type "NULL/Daily"
        int clearable_count
        int ad_challenge_count
        datetime start_at
        datetime end_at
        string background_asset_key
    }

    MstStageEventReward {
        int id PK
        string mst_stage_id FK
        string reward_category "FirstClear/Random"
        string resource_type
        string resource_id
        int resource_amount
        int percentage
        int sort_order
    }

    MstStageClearTimeReward {
        string id PK
        string mst_stage_id FK
        int upper_clear_time_ms
        string resource_type
        string resource_id
        int resource_amount
    }

    MstStageEndCondition {
        string id PK
        string mst_stage_id FK
        string stage_end_type "Victory/Defeat/Finish"
        string condition_type
        string condition_value1
        string condition_value2
    }

    MstInGameSpecialRule {
        string id PK
        string content_type "Stage/AdventBattle/Pvp"
        string target_id FK
        string rule_type
        string rule_value
        datetime start_at
        datetime end_at
    }

    MstEvent ||--o{ MstQuest : "mst_event_id"
    MstQuest ||--o{ MstQuestI18n : "mst_quest_id"
    MstQuest ||--o{ MstQuestBonusUnit : "mst_quest_id"
    MstQuest ||--o{ MstQuestEventBonusSchedule : "mst_quest_id"
    MstQuest ||--o{ MstStage : "mst_quest_id"
    MstStage ||--o{ MstStageI18n : "mst_stage_id"
    MstStage ||--o{ MstStageEventSetting : "mst_stage_id"
    MstStage ||--o{ MstStageEventReward : "mst_stage_id"
    MstStage ||--o{ MstStageClearTimeReward : "mst_stage_id"
    MstStage |o--o{ MstStageEndCondition : "mst_stage_id"
    MstStage |o--o{ MstInGameSpecialRule : "target_id"
    MstStage |o--o| MstStage : "prev_mst_stage_id(自己参照)"
```

---

## 3. インゲーム〜敵設定層 ER図

```mermaid
erDiagram
    MstStage {
        string id PK
        string mst_in_game_id FK
    }

    MstInGame {
        string id PK
        string mst_auto_player_sequence_set_id FK
        string mst_page_id FK
        string mst_enemy_outpost_id FK
        string boss_mst_enemy_stage_parameter_id FK
        string bgm_asset_key
        string boss_bgm_asset_key
        int boss_count
        float normal_enemy_hp_coef
        float normal_enemy_attack_coef
        float normal_enemy_speed_coef
        float boss_enemy_hp_coef
        float boss_enemy_attack_coef
        float boss_enemy_speed_coef
    }

    MstInGameI18n {
        string id PK
        string mst_in_game_id FK
        string language
        string result_tips
        string description
    }

    MstPage {
        string id PK
    }

    MstKomaLine {
        string id PK
        string mst_page_id FK
        int row
        float height
        string koma_line_layout_asset_key
        string koma1_asset_key
        float koma1_width
        string koma1_effect_type
        string koma1_effect_target_side "All/Player/Enemy"
        string koma1_effect_target_colors
        string koma1_effect_target_roles
        string koma2_asset_key
        string koma3_asset_key
        string koma4_asset_key
    }

    MstAutoPlayerSequence {
        string id PK
        string sequence_set_id FK
        string sequence_group_id
        string sequence_element_id
        string priority_sequence_element_id FK
        string condition_type
        string condition_value
        string action_type
        string action_value FK
        int summon_count
        int summon_interval
        string summon_animation_type
        float summon_position
        string move_start_condition_type
        string move_stop_condition_type
        string aura_type "Default/Boss/AdventBoss1-3"
        string death_type "Normal/Escape"
        float enemy_hp_coef
        float enemy_attack_coef
        float enemy_speed_coef
        int override_drop_battle_point
        int defeated_score
    }

    MstEnemyStageParameter {
        string id PK
        string mst_enemy_character_id FK
        string character_unit_kind "Normal/Boss/AdventBattleBoss"
        string role_type
        string color "Colorless/Red/Blue/Yellow/Green"
        int sort_order
        int hp
        int damage_knock_back_count
        int move_speed
        float well_distance
        int attack_power
        int attack_combo_cycle
        string mst_unit_ability_id1 FK
        int drop_battle_point
        string mst_transformation_enemy_stage_parameter_id FK
        string transformation_condition_type "None/HpPercentage/StageTime"
        string transformation_condition_value
    }

    MstEnemyCharacter {
        string id PK
        string mst_series_id FK
        string asset_key
        bool is_phantomized
        bool is_displayed_encyclopedia
    }

    MstEnemyCharacterI18n {
        string id PK
        string mst_enemy_character_id FK
        string language
        string name
    }

    MstEnemyOutpost {
        string id PK
        int hp
        bool is_damage_invalidation
        string artwork_asset_key
    }

    MstInGameGimmickObject {
        string id PK
        string asset_key
    }

    MstSeries {
        string id PK
    }

    MstStage ||--|| MstInGame : "mst_in_game_id"
    MstInGame ||--o{ MstAutoPlayerSequence : "sequence_set_id"
    MstInGame ||--|| MstPage : "mst_page_id"
    MstInGame ||--|| MstEnemyOutpost : "mst_enemy_outpost_id"
    MstInGame |o--|| MstEnemyStageParameter : "boss_mst_enemy_stage_parameter_id"
    MstInGame ||--o{ MstInGameI18n : "mst_in_game_id"
    MstPage ||--o{ MstKomaLine : "mst_page_id"
    MstAutoPlayerSequence |o--|| MstEnemyStageParameter : "action_value(SummonEnemy)"
    MstAutoPlayerSequence |o--|| MstInGameGimmickObject : "action_value(SummonGimmickObject)"
    MstAutoPlayerSequence |o--|| MstAutoPlayerSequence : "priority_sequence_element_id"
    MstEnemyStageParameter ||--|| MstEnemyCharacter : "mst_enemy_character_id"
    MstEnemyStageParameter |o--|| MstEnemyStageParameter : "mst_transformation_enemy_stage_parameter_id"
    MstEnemyCharacter ||--o{ MstEnemyCharacterI18n : "mst_enemy_character_id"
    MstEnemyCharacter }o--|| MstSeries : "mst_series_id"
```

---

## 4. IDの命名パターンとID連鎖

```mermaid
flowchart LR
    subgraph CONVENTION["同一IDを共有するテーブル群"]
        A["MstInGame.id\n= event_you1_charaget01_00001"]
        B["MstAutoPlayerSequence\n.sequence_set_id\n= event_you1_charaget01_00001"]
        C["MstStage.mst_in_game_id\n= event_you1_charaget01_00001"]
        D["MstPage.id\n= event_you1_charaget01_00001"]
        E["MstEnemyOutpost.id\n= event_you1_charaget01_00001"]
        F["MstInGameI18n.mst_in_game_id\n= event_you1_charaget01_00001"]

        A -.->|同一ID| B
        A -.->|同一ID| D
        A -.->|同一ID| E
        C -->|FK参照| A
        F -->|FK参照| A
    end
```

---

## 5. 敵出現シーケンス構造

```mermaid
flowchart TD
    SET["sequence_set_id\n= MstInGame.id\n（ステージ単位のグループ）"]

    SET --> GROUP_DEFAULT["sequence_group_id = 空\n（デフォルトグループ）"]
    SET --> GROUP_NEXT["sequence_group_id = 'phase2'\n（フェーズ切り替え後）"]

    GROUP_DEFAULT --> E1["element_id=1\n条件: InitialSummon\nアクション: SummonEnemy(ボス)"]
    GROUP_DEFAULT --> E2["element_id=2\n条件: ElapsedTime(500ms)\nアクション: SummonEnemy(雑魚×5)"]
    GROUP_DEFAULT --> E3["element_id=3\n条件: ElapsedTime(3000ms)\nアクション: SummonEnemy(別雑魚×11)"]
    GROUP_DEFAULT --> E4["...\n条件: OutpostHpPercentage\nアクション: SwitchSequenceGroup(phase2)"]

    GROUP_NEXT --> E5["element_id=1\n条件: InitialSummon\nアクション: SummonEnemy(強化ボス)"]

    style SET fill:#4a9eff,color:#fff
    style GROUP_DEFAULT fill:#22c55e,color:#fff
    style GROUP_NEXT fill:#f97316,color:#fff
```

---

## 6. 特別ルール（MstInGameSpecialRule）の設定パターン

```mermaid
flowchart LR
    STAGE["MstStage.id\n（チャレンジ/サベージ系）"]

    STAGE --> R1["SpeedAttack\nrule_value=1000\n（タイムアタック）"]
    STAGE --> R2["NoContinue\nrule_value=1\n（コンティニュー禁止）"]
    STAGE --> R3["PartySeries\nrule_value=spy\n（使用可能シリーズ制限）"]
    STAGE --> R4["PartySeries\nrule_value=mag\n（複数設定=複数シリーズ可）"]

    style STAGE fill:#8b5cf6,color:#fff
    style R1 fill:#ef4444,color:#fff
    style R2 fill:#ef4444,color:#fff
    style R3 fill:#f59e0b,color:#fff
    style R4 fill:#f59e0b,color:#fff
```

---

## 7. コマフィールド構造（MstPage → MstKomaLine）

```mermaid
flowchart TD
    PAGE["MstPage\n（バトルフィールド1面分）"]

    PAGE --> ROW1["MstKomaLine row=1\n上段"]
    PAGE --> ROW2["MstKomaLine row=2\n下段"]

    ROW1 --> K1["koma1\nasset: you_00004\nwidth: 0.4\neffect: None"]
    ROW1 --> K2["koma2\nasset: you_00004\nwidth: 0.6\neffect: None"]
    ROW2 --> K3["koma3\nasset: you_00004\nwidth: 1.0\neffect: AttackPowerDown\ntarget: Enemy,All"]

    style PAGE fill:#0ea5e9,color:#fff
    style ROW1 fill:#10b981,color:#fff
    style ROW2 fill:#10b981,color:#fff
```

---

## リレーション記号の凡例

| 記号 | 意味 |
|------|------|
| `\|\|` | 必須（1件） |
| `\|o` | 任意（0または1件） |
| `o{` | 0以上（オプション） |
| `\|{` | 1以上（必須） |
| `→` | 参照方向（FK側から参照先） |
| `←` | 被参照（参照される側） |
