# 差分ファイル17個の詳細分析

## エグゼクティブサマリー

17個の差分ファイルを分析した結果、以下のパターンが明らかになりました。

**差分総数**:
- 追加漏れ（正解にあるが生成結果にない）: 約260行
- 削除誤り（生成結果にあるが正解にない）: 約250行
- 値の相違（IDは一致するが値が異なる）: 約40行

**主要な根本原因**:
1. **ID命名規則の理解不足** - 報酬系テーブルでID末尾の番号付け規則が異なる（例: `_01` vs `_1`）
2. **背景アセットキーの推測誤り** - イベント固有のアセットキーを他イベントのものと混同
3. **報酬カテゴリの誤解** - `MaxScore` vs `RaidTotalScore` など報酬タイプの理解不足
4. **ステージ構成の過剰生成** - 運営仕様書にない7話・8話を生成
5. **細かい値の推測誤差** - スタミナ消費、コイン、経験値などの推測値の精度不足
6. **NULL値表現の不統一** - `__NULL__` vs 空文字列の使い分けが不明確

---

## ファイル別詳細分析

### 1. MstAdventBattle.csv
**差分タイプ**: 値の相違（1行）

**差分内容**:
- `display_mst_unit_id1`: `chara_jig_00601` → `enemy_jig_00601`（キャラと敵の混同）
- `asset_key`: `jig_00002` → `jig_00001`（アセットキー推測誤り）
- `challengeable_count`: `5` → `3`（挑戦可能回数の推測誤り）

**根本原因**:
- 運営仕様書に表示ユニットの明示がなく、キャラクターIDと敵IDを混同
- アセットキーの推測ロジックが不正確

**改善提案**:
- レイドボス表示には`enemy_*`プレフィックスを使うルールを学習
- アセットキーはイベントIDベースで生成（`event_jig_00001` → `jig_00001`）

---

### 2. MstAdventBattleClearReward.csv
**差分タイプ**: 削除誤り（1行）

**差分内容**:
- 固定報酬として`Coin 300`が余分に生成された

**根本原因**:
- 運営仕様書のクリア報酬欄で固定報酬とランダム報酬の区別が曖昧
- スキルが「固定報酬」として余分な行を生成

**改善提案**:
- クリア報酬テーブルは報酬グループで管理されているため、固定報酬は別テーブル（MstAdventBattleReward）で定義すべき
- 運営仕様書に明示的な記載がない場合は生成しない

---

### 3. MstAdventBattleReward.csv
**差分タイプ**: 完全不一致（追加120行、削除102行）

**差分内容**:
- 生成結果のIDは`_01`, `_02`形式（例: `quest_raid_jig1_reward_group_00001_01_01`）
- 正解のIDは`_1`, `_2`形式（例: `quest_raid_jig1_reward_group_00001_01_1`）
- 生成結果には余分な`resource_id`（`prism_glo_00001`など）が含まれる箇所がある
- 正解の一部行には`resource_id`が空の場合がある

**根本原因**:
- **ID命名規則の理解不足** - 報酬個別ID末尾の番号が`01, 02`ではなく`1, 2`形式
- **resource_idの使い分け理解不足** - FreeDiamondやCoinの場合にresource_idを入れるべきかの判断誤り

**改善提案**:
- 報酬テーブルのID生成ロジックを見直し、末尾番号はゼロ埋めなし（`_1`, `_2`, ...）を採用
- FreeDiamond/Coinなどの共通リソースはresource_idを空にする明確なルールを学習

---

### 4. MstAdventBattleRewardGroup.csv
**差分タイプ**: 混合（追加43行、削除25行、変更3行）

**差分内容**:
- 生成結果は`Rank`カテゴリの報酬グループを25個生成（`quest_raid_jig1_reward_group_00001_rank_01` など）
- 正解には`Rank`カテゴリは存在せず、代わりに`MaxScore`（最高スコア報酬）と`RaidTotalScore`（累計スコア報酬）がある
- 条件値も大きく異なる（生成: 150000/200000/300000、正解: 500/5000/15000など）

**根本原因**:
- **報酬カテゴリの誤解** - ランキング報酬（Rank）と累計スコア報酬（RaidTotalScore）を混同
- 運営仕様書に「ランキング報酬」の記載があったが、実装は異なる形式だった可能性

**改善提案**:
- レイドイベントでは`Rank`ではなく`MaxScore`と`RaidTotalScore`を使うパターンを学習
- 条件値はスコア閾値として適切な範囲（500〜300000）を推測

---

### 5. MstEventI18n.csv
**差分タイプ**: 値の相違（1行）

**差分内容**:
- `balloon`: `地獄楽 いいジャン祭` → `地獄楽いいジャン祭`（スペース有無）
- `name`: `地獄楽 いいジャン祭` → `地獄楽いいジャン祭`（スペース有無）

**根本原因**:
- 運営仕様書の表記に余分なスペースが含まれていた、またはスキルがスペースを挿入した

**改善提案**:
- 日本語テキストの正規化処理を改善（全角スペース除去）
- 運営仕様書の表記をそのまま使う場合、スペース有無をチェック

---

### 6. MstHomeBanner.csv
**差分タイプ**: 混合（追加3行、削除1行）

**差分内容**:
- 生成結果は1個のバナー（ID=31、イベント遷移、終了日時2026-02-16 10:59:59）
- 正解は3個のバナー（ID=23イベント、ID=24/25ガチャ、全て終了日時2026-02-02 14:59:59）

**根本原因**:
- **バナー数の推測不足** - イベントに対してガチャバナーも必要だが生成されなかった
- **終了日時の推測誤り** - イベント終了日時とバナー表示終了日時が異なるケースを考慮していない
- **ID採番ルールの不理解** - 既存の最大IDを調査せずに生成した

**改善提案**:
- イベント開催時は通常、イベントバナー + ガチャバナー複数が必要
- バナー終了日時はイベント終了より前の可能性を考慮
- 既存データから最大IDを取得し、連番を生成

---

### 7. MstPack.csv
**差分タイプ**: 混合（追加1行、変更1行）

**差分内容**:
- `event_item_pack_12`が追加漏れ（お一人様1回限定パック）
- `monthly_item_pack_3`の`sale_condition`と`pack_decoration`が空文字列だが、正解は`__NULL__`

**根本原因**:
- 運営仕様書に記載されたパック情報を見落とした可能性
- NULL値の表現方法が不統一（`__NULL__` vs 空文字列）

**改善提案**:
- NULL値は明示的に`__NULL__`を使う統一ルールを学習
- 運営仕様書のパック一覧を全てチェック

---

### 8. MstPackContent.csv
**差分タイプ**: 追加漏れ（4行）

**差分内容**:
- `event_item_pack_12`の内容物4個が漏れている（メモリーフラグメント3種、チケット1種）

**根本原因**:
- MstPackで`event_item_pack_12`を生成していなかったため、連鎖的に内容物も生成されなかった

**改善提案**:
- パック作成時に必ず内容物も同時生成
- 親テーブル（MstPack）が存在しない場合は警告

---

### 9. MstPackI18n.csv
**差分タイプ**: 追加漏れ（1行）

**差分内容**:
- `event_item_pack_12_ja`が漏れている

**根本原因**:
- MstPackで`event_item_pack_12`を生成していなかったため、連鎖的にI18nも生成されなかった

**改善提案**:
- 親テーブル作成時に必ずI18nテーブルも同時生成

---

### 10. MstQuest.csv
**差分タイプ**: 値の相違（2行）

**差分内容**:
1. `quest_event_jig1_charaget02`:
   - `quest_group`: `event_jig1_charaget_sagiri` → `event_jig1_charaget_boot`（キャラ名推測誤り）
   - `end_date`: `2026-02-16 10:59:59` → `2026-02-16 14:59:59`（時刻推測誤り）
2. `quest_event_jig1_1day`:
   - `end_date`: `2026-02-02 03:59:59` → `2026-02-2 03:59:59`（ゼロ埋め有無）

**根本原因**:
- キャラクター取得クエストのグループ名をキャラ名から推測したが誤り
- 日時のフォーマットが不統一（`02` vs `2`）

**改善提案**:
- クエストグループ名は運営仕様書に明記されている場合のみ使用
- 日時フォーマットの統一ルール整備（ゼロ埋めの有無）

---

### 11. MstQuestI18n.csv
**差分タイプ**: 値の相違（1行）

**差分内容**:
- `category_name`: `高難度` → `高難易度`（表記揺れ）

**根本原因**:
- 類似する日本語表現の推測誤り

**改善提案**:
- カテゴリ名は既存データから完全一致で取得
- 運営仕様書の表記をそのまま使用

---

### 12. MstStage.csv
**差分タイプ**: 大規模な混合（追加8行、削除12行、変更11行）

**差分内容**:
1. **削除誤り**: `event_jig1_charaget01_00007`, `_00008`、`event_jig1_charaget02_00007`, `_00008` など（ステージ7話・8話）が余分に生成されている
2. **prev_mst_stage_idの誤り**:
   - 生成結果では`event_jig1_charaget01_00008`を前提としているが、正解では`event_jig1_charaget01_00006`が前ステージ
3. **値の推測誤差**:
   - `cost_stamina`: 7 → 10、`coin`: 150 → 200、`recommended_level`: 20 → 25 など
   - `asset_key`: 他イベント（`event_sur1_*`）のアセットキーを使用してしまった
4. **auto_lap_type**: 空文字列 → `__NULL__`
5. **end_at**: `2026-02-16 10:59:59` → `2026-02-16 14:59:59`（キャラクター取得クエスト02系）

**根本原因**:
- **ステージ数の推測過剰** - 運営仕様書に記載のない7話・8話を生成
- **アセットキーの混同** - 他イベント（`event_sur1_*`）のアセットキーを使ってしまった
- **パラメータ推測の精度不足** - スタミナ、報酬、レベルなどの計算ロジックが不正確
- **NULL値表現の不統一** - `auto_lap_type`で空文字列と`__NULL__`の使い分けが不明確

**改善提案**:
- ステージ数は運営仕様書に明記された数のみ生成（過剰生成しない）
- アセットキーはイベントIDから生成（`event_jig_00001` → `event_jig1_*`）
- パラメータ推測ロジックを改善（既存データのパターン分析）
- NULL値は`__NULL__`に統一

---

### 13. MstStageEventReward.csv
**差分タイプ**: 完全不一致（追加70行、削除78行）

**差分内容**:
- ID範囲が完全に異なる（生成: 393-470、正解: 539-608）
- キャラクター取得ステージの報酬が異なる
  - 生成は`chara_jig_00701`（ガビ丸）の報酬を生成
  - 正解は`chara_jig_00601`（佐切）の報酬

**根本原因**:
- **ID採番の開始位置誤り** - 既存データの最大IDを調査せずに生成
- **キャラクター取得対象の誤り** - クエスト02（佐切）の報酬をクエスト01（ガビ丸）と混同

**改善提案**:
- ID生成時は必ず既存データの最大IDを取得して連番生成
- クエストIDとキャラクターIDの対応関係を明確に管理

---

### 14. MstStageEventSetting.csv
**差分タイプ**: 完全不一致（追加20行、削除24行）

**差分内容**:
- ID範囲が完全に異なる（生成: 121-144、正解: 162-181）
- ステージ数が異なる（生成は7話・8話を含む24個、正解は20個）
- `background_asset_key`が異なる
  - 生成: 全て`jig_00001`または`jig_00003`
  - 正解: `jig_00001`（1日限定）、`jig_00002`（佐切）、`jig_00003`（ガビ丸）
- `mst_stage_rule_group_id`と`reset_type`が空文字列 vs `__NULL__`

**根本原因**:
- ID採番位置の誤り
- ステージ数過剰生成の連鎖影響
- 背景アセットキーの推測誤り（クエスト別に異なるアセットが必要）
- NULL値表現の不統一

**改善提案**:
- 背景アセットキーはクエストIDに基づいて生成（`charaget01` → `jig_00003`、`charaget02` → `jig_00002`）
- NULL値は`__NULL__`に統一

---

### 15. MstStageI18n.csv
**差分タイプ**: 混合（削除4行、変更20行）

**差分内容**:
- 削除誤り: 7話・8話のI18nが余分に生成されている
- 値の相違: ステージ名が番号形式（`1話`, `2話`, `Stage 1`など）ではなく、実際のタイトル文字列
  - 生成: `1話`, `2話`, `Stage 1` など
  - 正解: `朱印の者たち`, `必ず生きて帰る`, `本能が告げている 危険だと`, `手負いの獣は恐ろしいぞ` など

**根本原因**:
- **ステージ名の推測方法が不適切** - 番号やプレースホルダーではなく、実際のストーリータイトルが必要
- 運営仕様書にステージ名の記載があるはずだが、それを活用していない

**改善提案**:
- ステージ名は運営仕様書から直接取得（推測しない）
- 運営仕様書に記載がない場合は警告を出す

---

### 16. MstStoreProduct.csv
**差分タイプ**: 追加漏れ（6行）

**差分内容**:
- 6個のストア商品が漏れている（ID: 50, 64-68）
- これらは課金パックに対応する商品IDと思われる

**根本原因**:
- 運営仕様書の課金パック情報からストア商品を生成していない
- パック作成時に対応するストア商品も自動生成する仕組みがない

**改善提案**:
- パック作成時にストア商品も自動生成
- 商品IDとパックIDの関連付けを明確に管理

---

### 17. MstStoreProductI18n.csv
**差分タイプ**: 追加漏れ（6行）

**差分内容**:
- 6個のストア商品I18nが漏れている

**根本原因**:
- MstStoreProductが生成されなかったため、連鎖的にI18nも生成されなかった

**改善提案**:
- ストア商品作成時に必ずI18nも同時生成

---

## 差分パターン別サマリー

| パターン | ファイル数 | 総差分行数 | 主な原因 |
|---------|----------|-----------|---------|
| **追加漏れ（正解にあるが生成結果にない）** | 11個 | 約260行 | 親テーブル未生成の連鎖、ID採番誤り、運営仕様書の見落とし |
| **削除誤り（生成結果にあるが正解にない）** | 8個 | 約250行 | ステージ数過剰生成、ID命名規則誤り、報酬カテゴリ誤解 |
| **値の相違（IDは一致するが値が異なる）** | 9個 | 約40行 | パラメータ推測精度不足、アセットキー混同、NULL値不統一、テキスト推測誤り |

---

## 根本原因別サマリー

### 1. ID命名規則・採番の理解不足（5ファイル）
**影響ファイル**: MstAdventBattleReward, MstAdventBattleRewardGroup, MstHomeBanner, MstStageEventReward, MstStageEventSetting

**問題**:
- 報酬IDの末尾番号が`_01, _02`ではなく`_1, _2`形式
- ID採番時に既存データの最大IDを調査していない

**改善案**:
- ID生成ロジックをデータベースから既存IDを取得し、連番生成
- 報酬系テーブルの末尾番号はゼロ埋めなしルールを明確化

---

### 2. アセットキーの推測誤り（4ファイル）
**影響ファイル**: MstAdventBattle, MstStage, MstStageEventSetting, MstStageI18n

**問題**:
- 他イベント（`event_sur1_*`）のアセットキーを使用
- イベントIDとアセットキーの対応関係を誤解

**改善案**:
- アセットキーはイベントIDから生成（`event_jig_00001` → `jig_00001`, `jig_00002`, `jig_00003`）
- 背景アセットキーはクエストタイプ別に割り当て

---

### 3. データ依存関係の考慮漏れ（6ファイル）
**影響ファイル**: MstPack → MstPackContent, MstPackI18n / MstStoreProduct → MstStoreProductI18n

**問題**:
- 親テーブルが生成されないと子テーブルも生成されない連鎖

**改善案**:
- 親テーブル作成時に子テーブルも自動生成する仕組み
- テーブル間依存関係の明確な管理

---

### 4. 運営仕様書の記載不足・解釈誤り（7ファイル）
**影響ファイル**: MstAdventBattleRewardGroup, MstHomeBanner, MstQuest, MstStage, MstStageI18n

**問題**:
- ランキング報酬 vs 累計スコア報酬の混同
- ステージ数の過剰生成（7話・8話）
- ステージ名の推測誤り（番号 vs 実際のタイトル）

**改善案**:
- 運営仕様書に明記されていない情報は推測せず警告
- レイドイベントの報酬カテゴリパターンを学習
- ステージ名は仕様書から直接取得

---

### 5. 推測値の精度不足（3ファイル）
**影響ファイル**: MstAdventBattle, MstStage

**問題**:
- スタミナ消費、コイン、経験値、推奨レベルなどの推測誤差

**改善案**:
- 既存データのパターン分析による推測精度向上
- ステージ進行に応じたパラメータ増加率の学習

---

### 6. NULL値表現の不統一（4ファイル）
**影響ファイル**: MstPack, MstStage, MstStageEventSetting

**問題**:
- 空文字列 vs `__NULL__`の使い分けが不明確

**改善案**:
- NULL値は全て`__NULL__`に統一
- スキーマ定義で明確化

---

### 7. テキスト表記の揺れ（3ファイル）
**影響ファイル**: MstEventI18n, MstQuestI18n, MstStageI18n

**問題**:
- スペース有無（`地獄楽 いいジャン祭` vs `地獄楽いいジャン祭`）
- 表記揺れ（`高難度` vs `高難易度`）

**改善案**:
- テキスト正規化処理の改善
- 運営仕様書の表記をそのまま使用

---

## 全体的な改善提案

### 1. ID生成ロジックの改善
- 既存データから最大IDを取得し、連番生成
- 報酬系テーブルの末尾番号ルール明確化（ゼロ埋めなし: `_1`, `_2`, ...）

### 2. データ依存関係の自動管理
- 親テーブル作成時に子テーブル（I18n, Content等）も自動生成
- テーブル間の整合性チェック

### 3. アセットキー生成ルールの明確化
- イベントIDベースの生成ルール
- クエストタイプ別の背景アセットキー割り当て

### 4. NULL値表現の統一
- 全てのNULL値を`__NULL__`で表現
- スキーマ定義での明確化

### 5. 運営仕様書の活用強化
- ステージ名、キャラクター名などは仕様書から直接取得
- 推測が必要な箇所は明確に警告

### 6. 推測ロジックの改善
- 既存データのパターン分析
- パラメータ増加率などの学習

### 7. バリデーション強化
- 生成後の整合性チェック
- 親子関係、ID重複、必須項目などの検証
