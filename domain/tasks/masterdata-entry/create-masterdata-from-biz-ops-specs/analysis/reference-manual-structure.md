# 参考手順書の構造分析

## ディレクトリ構成

```
domain/tasks/masterdata-entry/gemini/mission/
├── アチーブメントミッション_プロンプト.md
├── アチーブメントミッション_マスタデータ設定手順書.md
├── イベントミッション_プロンプト.md
├── イベントミッション_マスタデータ設定手順書.md
├── イベントログインボーナス_プロンプト.md
├── イベントログインボーナス_マスタデータ設定手順書.md
├── 降臨バトルミッション_プロンプト.md
└── 降臨バトルミッション_マスタデータ設定手順書.md
```

**ファイル構成パターン:**
- 各機能について**2ファイルセット**で管理
  - `{機能名}_マスタデータ設定手順書.md` - 詳細な作成手順
  - `{機能名}_プロンプト.md` - LLMへの指示書

## 主要ファイル一覧

### 手順書ファイル

1. **イベントミッション_マスタデータ設定手順書.md** (35KB)
   - イベント期間中に表示されるミッションの作成手順
   - 3シート構成 (MstMissionEvent + Dependency + Reward)
   - criterion_typeの詳細な一覧(40種類以上)
   - destination_sceneとcriterion_typeの相関関係

2. **アチーブメントミッション_マスタデータ設定手順書.md** (32KB)
   - 恒常的に表示されるアチーブメントミッションの作成手順
   - 3シート構成 (MstMissionAchievement + Dependency + Reward)
   - 頻繁に使用されるcriterion_typeの優先度付き一覧

3. **降臨バトルミッション_マスタデータ設定手順書.md** (14KB)
   - 期間限定の降臨バトルミッションの作成手順
   - 2シート構成 (MstMissionLimitedTerm + Reward)
   - criterion_typeは3種類のみ(シンプル)

4. **イベントログインボーナス_マスタデータ設定手順書.md** (16KB)
   - ログインボーナスの作成手順
   - 対象外(今回の分析範囲外)

### プロンプトファイル

各手順書に対応するプロンプトファイルは、LLMに手順書を渡す際の指示を記載:
- 作業内容
- 入力パラメータ(release_key, イベントID等)
- 出力形式(Markdown表形式)
- 推測値レポートの作成指示

---

## 手順書の構成要素

### セクション構造

すべての手順書に共通する基本構造:

1. **概要** - 手順書の目的と対象
2. **対象テーブル** - 作成するシート構成の説明
3. **作成フロー** - 段階的な作成手順
   - 3.1 仕様書の確認
   - 3.2 各シートの作成
   - 3.3 データ整合性のチェック
   - 3.4 出力フォーマット
4. **各シートの詳細** - テーブルごとの設定ルール
5. **データ整合性のチェック** - 必須チェック項目と推奨チェック項目
6. **出力フォーマット** - 最終的なシート構成と具体例

### 記載情報の種類

- [x] **対象テーブル一覧** - 作成するシート構成の明記
- [x] **採番ルール** - ID・group_id・reward_group_idの採番規則
- [x] **設定項目の説明** - 各カラムの設定ルールとテーブル形式での整理
- [x] **必須/任意の区別** - ENABLEカラム、固定値カラム、空欄カラムの明示
- [x] **データ整合性チェック項目** - 必須チェック・推奨チェックの分類
- [x] **注意事項・よくあるミス** - 大文字小文字の一致、criterion_valueの設定有無
- [x] **サンプルデータ** - 各シートの具体的な作成例
- [x] **enum値の一覧** - criterion_type, destination_scene, resource_typeの詳細一覧
- [x] **リレーション関係** - テーブル間の関連性の説明
- [x] **シートスキーマ** - TABLE行・ENABLE行の具体的な記載

---

## 具体例

### 採番ルールの記載例

**イベントミッション (`MstMissionEvent.mst_mission_reward_group_id`)**

```
{作品ID}_{イベント連番5桁}_event_reward_{報酬段階}

パラメータ:
- 作品コード: 3文字の作品識別子 (osh, kai, glo)
- イベント連番5桁: イベントごとに採番 (00001からゼロパディング)
- 報酬段階: 報酬のステップ番号

報酬段階のゼロパディングルール:
- 通常: 2桁ゼロパディング (01, 02, 03...28)
- 例外 (osh: 推しの子のみ): ゼロパディングなし (1, 2, 3...53)

採番例:
kai_00001_event_reward_01   (怪獣8号 イベント1 報酬段階1)
osh_00001_event_reward_1    (推しの子 イベント1 報酬段階1)
glo_00001_event_reward_01   (GLOW全体 イベント1 報酬段階1)
```

**アチーブメントミッション (`MstMissionAchievement.id`)**

```
achievement_{グループ番号}_{連番}

パラメータ:
- グループ番号: 1から順番に採番 (アンダースコア区切りなし)
- 連番: グループ内で1から順番に採番 (3桁ゼロパディング)

採番例:
achievement_1_001   (グループ1 ミッション1)
achievement_2_101   (グループ2 ミッション101)
```

**降臨バトルミッション (`MstMissionLimitedTerm.id`)**

```
limited_term_{連番}

採番例:
limited_term_33
limited_term_34
```

---

### データ整合性チェックの記載例

**必須チェック項目 (イベントミッション)**

```
- [ ] ヘッダーの列順が正しいか
  - スキーマファイルと完全一致している

- [ ] IDの一意性
  - すべてのidが一意である
  - 他のリリースのidと重複していない

- [ ] ID採番ルール
  - MstMissionEvent.id: event_{作品ID}_{イベント連番5桁}_{ミッション連番}
  - MstMissionEvent.mst_event_id: MstEventテーブルに存在するイベントID
  - MstMissionEvent.mst_mission_reward_group_id: 上記の採番ルールに従う
  - MstMissionReward.group_id: MstMissionEvent.mst_mission_reward_group_idと同じ値

- [ ] criterion_typeの正確性
  - 「criterion_type設定一覧」に記載されたいずれかを使用している
  - 大文字小文字が正確に一致している (例: StageClearCount ○, stageclearcount ×)
  - criterion_valueの設定有無が正しい (必要なタイプには設定、不要なタイプは空欄)

- [ ] destination_sceneの正確性
  - criterion_typeに対応するdestination_sceneが設定されている
  - criterion_type一覧表の「destination_scene候補」列と一致している
```

**推奨チェック項目**

```
- [ ] 命名規則の統一
  - idのプレフィックスが統一されている

- [ ] 説明文の品質
  - 誤字脱字がない
  - ユーザーが理解しやすい表現である

- [ ] 依存関係の妥当性
  - unlock_orderが1から連番で設定されている
  - 同じgroup_id内で欠番がない
```

---

### enum値一覧の記載例

**criterion_type (イベントミッション)**

| criterion_type | 説明 | criterion_value | criterion_count | destination_scene候補 | 使用例 |
|---------------|------|----------------|----------------|---------------------|--------|
| **SpecificItemCollect** | 指定アイテムを収集 | アイテムID (mst_items.id)<br>例: `item_glo_00001` | 集めて欲しいアイテム個数 | Event | いいジャンメダル【赤】を200個集めよう |
| **DefeatEnemyCount** | インゲームで敵を撃破 | 空欄(`__NULL__`) | 撃破して欲しい敵数 | Event / StageSelect | 敵を100体撃破しよう |
| **SpecificGachaDrawCount** | 特定ガシャを引く | ガシャID (opr_gachas.id)<br>例: `gasho_001` | ガシャを引いて欲しい回数 | Gacha | 賀正ガシャ2026を10回引こう |

**destination_scene**

| destination_scene | 説明 | 主な用途 |
|------------------|------|---------|
| **Event** | イベント画面 | イベント関連ミッション (最も使用頻度が高い) |
| **Gacha** | ガシャ画面 | ガシャ引き回数ミッション |
| **QuestSelect** | クエスト選択画面 | クエスト・原画・エンブレム系ミッション |

**resource_type**

| resource_type | 説明 | resource_id | 参照先テーブル | 主な用途 |
|--------------|------|------------|--------------|---------|
| **Coin** | コイン(ゲーム内通貨) | 不要(空欄) | - | ミッション報酬の定番 |
| **FreeDiamond** | 無償プリズム | 不要(空欄) | - | 重要なミッション報酬 |
| **Item** | アイテム(チケット、素材など) | **必要** | **MstItem** | ガシャチケット、育成素材 |

---

### シートスキーマの記載例

**MstMissionEvent シート**

```
TABLE,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEvent,MstMissionEventI18n
ENABLE,id,release_key,mst_event_id,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene,description.ja
e,event_osh_00001_1,202512020,event_osh_00001,StageClearCount,,5,__NULL__,,0,,osh_00001_event_reward_1,1,Event,ステージを5回クリアしよう
```

**重要な特徴:**
- **TABLE行**: 各カラムがどのテーブルに属するかを示す
- **ENABLE行**: カラム名を示す
- **データ行**: ENABLEカラムは`e`(有効化)固定
- **I18n統合**: MstMissionEventI18nは独立したシートではなく、description.jaカラムとして統合

---

## 手順書テンプレート案

新しい機能の手順書を作成する際の推奨テンプレート:

```markdown
# {機能名} マスタデータ設定手順書

## 概要

{機能名}のマスタデータ作成手順を記載します。
本手順書に従うことで、ゲーム内でエラーが発生しない正確なマスタデータを作成できます。

## 対象テーブル

{機能名}では、以下のNシート構成でマスタデータを作成します。

**出力シート**:
- **{テーブル名1}** - {概要}
- **{テーブル名2}** - {概要}
- ...

**重要**: {I18nテーブルの扱いについて記載}

## 作成フロー

### 1. 仕様書の確認

運営仕様書から以下の情報を抽出します。

**必要情報**:
- {項目1}
- {項目2}
- ...

### 2. {テーブル名1} シートの作成

#### 2.1 シートスキーマ

このシートには、TABLE行、ENABLE行、データ行が含まれます。

**TABLE行**:
```
TABLE,{テーブル名},{テーブル名},...
```

**ENABLEと列名行**:
```
ENABLE,{カラム名1},{カラム名2},...
```

#### 2.2 各カラムの設定ルール

| カラム名 | 設定ルール |
|---------|-----------|
| **ENABLE** | 固定値: `e` (有効化) |
| **{カラム名1}** | {設定ルール} |
| **{カラム名2}** | {設定ルール} |
| ... | ... |

#### 2.3 {重要なenum値} 設定一覧

{機能名}で使用可能な{enum値名}は以下の通りです。**大文字小文字を正確に一致**させてください。

| {enum値名} | 説明 | {関連カラム1} | {関連カラム2} | 使用例 |
|-----------|------|-------------|-------------|--------|
| **{値1}** | {説明} | {設定内容} | {設定内容} | {使用例} |
| **{値2}** | {説明} | {設定内容} | {設定内容} | {使用例} |

#### 2.4 {機能名}固有の設定

{機能名}では、以下のように設定します。

- **{カラム名1}**: {設定ルール}
- **{カラム名2}**: {設定ルール}

#### 2.5 ID採番ルール

{テーブル名}のIDは、以下の形式で採番します。

```
{採番パターン}

パラメータ:
- {パラメータ1}: {説明}
- {パラメータ2}: {説明}

採番例:
{例1}
{例2}
```

#### 2.6 作成例

```
TABLE,{テーブル名},{テーブル名},...
ENABLE,{カラム名1},{カラム名2},...
e,{値1},{値2},...
e,{値1},{値2},...
```

#### 2.7 説明文作成のポイント

- {ポイント1}
- {ポイント2}
- ...

### 3. {テーブル名2} シートの作成

(同様の構造で記載)

### N. データ整合性のチェック

マスタデータ作成後、以下の項目を確認してください。

#### N.1 必須チェック項目

- [ ] **ヘッダーの列順が正しいか**
  - スキーマファイルと完全一致している

- [ ] **IDの一意性**
  - すべてのidが一意である
  - 他のリリースのidと重複していない

- [ ] **ID採番ルール**
  - {テーブル名1}.id: {採番ルール}
  - {テーブル名2}.id: {採番ルール}

- [ ] **リレーションの整合性**
  - `{テーブル名1}.{カラム名}` = `{テーブル名2}.{カラム名}`

- [ ] **enum値の正確性**
  - 「{enum値名}設定一覧」に記載されたいずれかを使用している
  - 大文字小文字が正確に一致している

- [ ] **数値の妥当性**
  - {数値カラム}が正の整数である

#### N.2 推奨チェック項目

- [ ] **命名規則の統一**
  - idのプレフィックスが統一されている

- [ ] **説明文の品質**
  - 誤字脱字がない
  - ユーザーが理解しやすい表現である

### N+1. 出力フォーマット

最終的な出力は以下のNシート構成で行います。

#### (N+1).1 {テーブル名1} シート

| TABLE | {テーブル名1} | {テーブル名1} | ... |
|-------|-------------|-------------|-----|
| **ENABLE** | **{カラム名1}** | **{カラム名2}** | ... |
| e | {値1} | {値2} | ... |

#### (N+1).2 {テーブル名2} シート

(同様の構造で記載)

#### 重要なポイント

- **TABLE行は必須**: 各シートの先頭にTABLE行を含める
- **Nシート構成**: {シート構成の説明}
- **I18nの扱い**: {I18nの統合方法}
```

---

## プロンプトテンプレート案

新しい機能のプロンプトファイルを作成する際の推奨テンプレート:

```markdown
# {機能名}マスタデータ作成プロンプト

## 作業内容

手順書({機能名}_マスタデータ設定手順書.md)に従って、
添付した運営仕様書から{機能名}のマスタデータを作成してください。
運営仕様書: {ファイル名}

新規リソース情報など、データ作成に必要な追加情報があれば、追加情報ファイルとして追加します。
追加情報ファイル:
- {追加ファイル1}
- {追加ファイル2}

## 入力パラメータ

- release_key: {release_keyを指定}
- {パラメータ1}: {説明}
- {パラメータ2}: {説明}
- {テーブル名}.id: {採番の開始番号}

## 出力形式

### 1. マスタデータ

- 手順書の「データ整合性のチェック」を満たしたデータになっていることを必ずチェックし、問題があれば修正完了してから出力する
- Markdown表形式で出力（スプレッドシートへのエクスポート・コピーボタンが正常に表示される形式）

### 2. 推測値レポート（必須）

作成したデータのうち、以下に該当するものを必ずレポートしてください：

- **添付ファイルにも手順書にも記載がなく、推測で決定したID値**
- 手順書通りに作成したID値は対象外

**レポート形式:**
```
## 推測値レポート

### [テーブル名].[カラム名]
- 値: [設定した値]
- 理由: [推測した根拠]
- 確認事項: [ユーザーが確認すべき内容]
```

**重要:** このレポートを怠ると、データインポートエラーや本番不具合のリスクが高まります。推測で決定した値は必ず報告してください。
```

---

## 今回の作成に活かすポイント

### この構造を参考にすべき理由

1. **階層的な情報構造**
   - 概要→詳細→具体例という段階的な説明
   - LLMが理解しやすく、人間にも読みやすい

2. **enum値の完全な一覧化**
   - criterion_type, destination_scene, resource_typeなど
   - 大文字小文字の区別を明記
   - 使用例を併記してわかりやすく

3. **テーブル形式での整理**
   - カラムごとの設定ルールを一覧化
   - enum値の詳細説明をテーブル化
   - 視認性が高く、検索しやすい

4. **採番ルールの明文化**
   - パターン・パラメータ・例を明記
   - 例外パターンも記載(oshのゼロパディング無し等)

5. **チェックリスト形式**
   - 必須・推奨の分類
   - チェックボックス形式で確認漏れを防止

6. **シートスキーマの明示**
   - TABLE行・ENABLE行の具体的な記載
   - I18n統合の仕様を明記

7. **プロンプトファイルとの分離**
   - 手順書: 詳細な作成ルール
   - プロンプト: LLMへの指示と入力パラメータ
   - 役割分担が明確

### 改善・追加すべき点

1. **version管理の追加**
   - 手順書自体のバージョン情報
   - 最終更新日・更新履歴

2. **参照先テーブルの明記**
   - criterion_value等で参照するテーブル名を明記
   - 外部キー制約の説明を追加

3. **エラーパターンの事例集**
   - よくあるミスとその修正方法
   - 実際に発生したエラー事例

4. **データ量の目安**
   - 通常のレコード数の目安
   - 異常に多い/少ない場合の警告

5. **相互参照の強化**
   - 関連する他の手順書へのリンク
   - 共通セクションの参照

6. **テスト手順の追加**
   - 作成後のテスト方法
   - インポート前の確認項目

7. **図解の追加**
   - テーブル間のリレーション図
   - データフローの図解

---

## 分析結果サマリー

### 手順書の特徴

- **3種類の手順書を分析** (イベントミッション、アチーブメントミッション、降臨バトルミッション)
- **共通構造**: 概要→対象テーブル→作成フロー→シート詳細→チェック→出力フォーマット
- **詳細度**: 14KB〜35KB (機能の複雑度に応じて)
- **enum値の徹底**: criterion_type, destination_scene, resource_typeを詳細に列挙
- **採番ルールの体系化**: ID・group_id・reward_group_idの命名規則を明文化

### 再利用可能な要素

- セクション構造のテンプレート
- enum値一覧のテーブル形式
- 採番ルールの記載フォーマット
- チェックリストの構造
- シートスキーマの記載方法

### 今回の作成への応用

地獄楽マスタデータ作成手順書は、この構造を基に:
1. 対象テーブルを特定(入手要件、アイテム、報酬等)
2. enum値を抽出・整理
3. 採番ルールを定義
4. チェック項目を列挙
5. 具体例を作成

という流れで作成することが推奨されます。
