# バトル再挑戦時にスタミナが不足していた場合、スタミナ回復アイテムを使用するとエラーが表示される - Activity

**コメント #1** by Kazuya Adachi 
(2026-01-15 12:11:54)

1/15 福元
バトル再挑戦時、スタミナ不足ダイアログの回復ボタンをタップ時にエラーが表示されないことを確認いたしました。
 
確認ビルド：iOS #14(551)、AOS #14(553)
確認環境：develop
検証端末：iPhone13(iOS:17.0.3)
　　　　　Pixel9(AOS:14.0.0)



**コメント #2** by Keisuke Isayama 
(2026-01-14 12:42:25)

再挑戦時にスタミナ回復アイテムを使用する際にエラーが出ないように修正いたしました。
ご確認のほどよろしくお願いいたします。
ビルド番号
android:#548
ios:#545



**コメント #3** by Toshikazu Takahashi 
(2026-01-13 18:53:47)

## 調査方針・解決策の提案

### 現象整理
バトル再挑戦時にスタミナが不足していた場合、スタミナ回復アイテムを使用した際に「Zenject.ZenjectExeption」（エラーコード：CLE-1）が表示される不具合が発生しています。  
再現性が高く、iOS/AOS双方の検証環境で発生を確認しています。

---

### 類似案件の調査結果

過去タスクを確認しましたが、「バトル再挑戦時にスタミナが不足→スタミナ回復アイテム使用によるZenject例外発生」の直接的な類似事例はありません。

ただし、「ショップや課金処理」「ダイアログまわりでの進行不可」や「再挑戦ロジックでの通信エラー」「消費アイテム系の例外発生」など、複数箇所で「進行中の状態変化にアイテムを消費した際の想定外エラー」が散見されており、インゲーム・アイテム消費まわりの排他制御やデータ更新タイミングの不整合が主なボトルネックになりやすいことが確認できます。

---

### 対応方針
本件はバトル再挑戦時の「スタミナ不足」→「アイテムによるスタミナ回復要求」→「内部コンテキスト不整合によるZenject例外」と推察されます。  
想定される原因としては、
- スタミナ回復アイテムの使用処理が、再挑戦フローの遷移中ステータスとの同期に失敗している
- 再挑戦ボタン押下時点でスタミナ不足→アイテム回復による遷移中にViewModelインスタンスや依存オブジェクトが不正状態になる  
等が考えられます。

### 具体的な調査・修正案
1. **バトルリザルトおよび再挑戦時のスタミナ消費・回復アイテム使用フローの順序・状態管理の見直し**  
    - バトルリザルト表示中、および再挑戦ダイアログ表示中の状態遷移（ViewModelやZenjectコンテナ管理下のオブジェクト）をトレース  
    - スタミナ不足時アイテム消費のロジックで、未初期化または破棄済みオブジェクトへのアクセスが発生していないかバリデーション
2. **Zenject例外時のスタックトレース取得・関連箇所特定**
    - エラーログ出力箇所や周辺処理（特にDI関連）の呼び出し経路を洗い出し
3. **（必要に応じて）回復実行後の再挑戦リトライや再描画リクエストの設計見直し**
    - UI/UX的な処理の二重実行や競合が発生しないようガード
4. **アイテム消費時の同期的排他制御強化**
    - ミドルウェアやサーバとの通信タイミングなど、非同期処理を同期化もしくはエラーハンドリング強化

---

### 担当者アサイン提案
今回の現象は **バトルシーンのUI/状態管理・アイテム消費**および **依存性注入（Zenject）**に精通した方が望ましいため、以下の担当者アサインを推奨します。

#### 参考にすべき担当者・関連タスク（類似箇所）

- Takishima Daichi さん
  - バトルやアイテム処理・リザルトフロー関連のバグ対応が多く、通信断等の復帰系／再挑戦処理にも精通
  - 例：[インゲームで特定手順による進行不能系タスク](https://app.clickup.com/t/86eurc9nj)  
  - 例：[探索・アイテム表示周りの担当実績](https://app.clickup.com/t/86eure48b)
- 必要に応じて、フロー全体のUI制御面でのアサインとして Shingo Maeda さん も候補（イベントリザルト・ダイアログ等で複合的な修正経験あり）

---

### まとめ

本案件はUI状態管理とDIコンテナの連携不整合、それにともなうアイテム消費イベントの例外処理不足が疑われます。
類似タスクに強い担当者（Takishimaさん）を主担当とし、サーバ/クライアント双方でのエラーハンドリングや状態管理の見直しを行う方針で進行が妥当です。

---

#### 類似タスク・参考

- [インゲームで特定手順を行うと、小ローディングアニメーションが表示されたまま進行不能になる (Takishimaさん)](https://app.clickup.com/t/86eurc9nj)
- [探索にて、キャラが登場時や攻撃モーション時にアニメーションエリア外にはみ出している (Takishimaさん)](https://app.clickup.com/t/86eure48b)
- [インゲームのダメージ時擬音表現にて、強敵出現時にダメージが無いゲートに擬音表現がある (大橋さん、山下さん)](https://app.clickup.com/t/86er6xm72)

---

担当候補：**Takishima Daichi** さん  
（リザルト〜再挑戦フロー＋アイテム消費ロジックの調査・修正）


