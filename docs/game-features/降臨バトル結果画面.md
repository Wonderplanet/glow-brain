# 降臨バトル結果画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトル結果画面 |
| **画面番号** | 44-1-10-1 |
| **画面種別** | モーダル画面 |

## 概要

降臨バトル終了後に表示される結果画面です。プレイヤーはバトルで獲得したスコア、ランク、報酬を確認できます。スコアは「与ダメージ」「敵撃破数」「ボス撃破数」の3種類で構成され、それらの合計スコアに応じてランク（Bronze/Silver/Gold/Master）とランクレベルが決定されます。ハイスコア更新やランクアップ時には特別な演出が表示されます。

バトル完了後、プレイヤーは獲得した報酬を確認し、ステージの再挑戦（リトライ）を選択することができます。

## プレイヤーができること

### バトル結果の確認

#### スコア詳細の確認
- **与ダメージスコア**: バトル中に与えたダメージに応じたスコア
- **敵撃破スコア**: 倒した敵の数に応じたスコア
- **ボス撃破スコア**: ボスを倒したことによるスコア
- 各スコアはアニメーション付きでカウントアップ表示される

#### トータルスコアの確認
- 3種類のスコアの合計値が表示される
- ハイスコアを更新した場合は「NEW RECORD」マークが表示される
- 現在のスコアとハイスコアが並べて表示される

#### ランク情報の確認
- 現在のランク（Bronze/Silver/Gold/Master）とランクレベルが表示される
- 今回のバトルでランクまたはランクレベルがアップした場合、次のランクまでの進捗ゲージがアニメーション表示される
- ランクアップした場合は専用の演出が表示される
- 各ランクレベル到達時に獲得できる報酬が表示される

### 報酬の確認

#### 獲得報酬の表示
- バトルで獲得したアイテム、コイン、経験値などが一覧表示される
- 新しくユニットを入手した場合は専用の入手演出が表示される
- 各報酬アイコンをタップすることで詳細情報を確認できる

#### ユーザーレベルアップの確認
- バトルの経験値でユーザーレベルがアップした場合、レベルアップ結果が自動的に表示される

### 演出のスキップ

#### スキップボタン
- 画面下部の「SKIP」ボタン（またはタップ）で演出をスキップできる
- スキップ可能な演出は以下の順序で進行：
  1. スコア詳細のスライドイン
  2. トータルスコアのスライドイン
  3. スコアのカウントアップ
  4. ランクパネルの表示
  5. 報酬の表示
- 各演出完了後は自動的に次の演出に進む

### 再挑戦

#### リトライボタン
- 全ての演出完了後に「再挑戦」ボタンがアクティブになる
- ボタンをタップするとスタミナ消費確認やスタミナブーストの確認を経て、同じステージに再挑戦できる
- 再挑戦可能な状態でない場合、ボタンは非表示になる

### 画面を閉じる

#### 閉じるボタン
- 画面右上の閉じるボタンで画面を閉じる
- 閉じると前の画面（降臨バトル選択画面など）に戻る

## 画面の要素

### ヘッダー部分
- イベントキャンペーン残り時間（該当する場合）
- 閉じるボタン

### スコア表示エリア（上部）
- **スコア詳細パネル**:
  - 与ダメージスコア
  - 敵撃破スコア
  - ボス撃破スコア
  - 各スコアはアニメーション付きでスライドイン・カウントアップ表示

- **トータルスコアパネル**:
  - 合計スコア
  - ハイスコア
  - NEW RECORDマーク（更新時のみ）

### ランク表示エリア（中央）
- 現在のランクタイプ（Bronze/Silver/Gold/Master）
- ランクレベル
- 次のランクまでの進捗ゲージ
- ランクアップ時の獲得報酬アイコン

### 報酬表示エリア（下部）
- 獲得報酬アイコン一覧
- スクロール可能なリスト形式
- 各アイコンタップで詳細表示

### ボタンエリア
- **SKIPボタン**: 演出中に表示され、タップで演出スキップ
- **再挑戦ボタン**: 全演出完了後に表示・アクティブ化（再挑戦可能な場合のみ）
- **TAP TO CLOSE**: 全演出完了後にフェードイン表示

## 画面遷移

### この画面への遷移
- **InGame画面（降臨バトル）**: バトル勝利時に自動的に表示される
  - `InGamePresenter`から`AdventBattleResultViewController`が生成・表示される

### この画面からの遷移
- **ユニット入手演出**: 新規ユニット獲得時に自動的に表示される
- **ランクアップ演出**: ランクまたはランクレベルアップ時にモーダル表示される
  - `AdventBattleResultRankUpEffectViewController`が表示される
- **ユーザーレベルアップ演出**: 経験値取得でレベルアップした場合に自動的に表示される
- **アイテム詳細画面**: 報酬アイコンタップ時にモーダル表示される
- **InGame画面**: 再挑戦ボタンタップ時にスタミナ確認を経て同じステージへ遷移
- **降臨バトル選択画面など**: 閉じるボタンタップで前画面に戻る

## ゲーム仕様・制約事項

### スコア計算
- スコアは以下の3種類から構成される：
  - **与ダメージスコア**: バトル中に敵に与えたダメージ量
  - **敵撃破スコア**: 倒した敵の数
  - **ボス撃破スコア**: ボスを倒したことによる特別スコア
- トータルスコアは3種類の合計値

### ランクシステム
- ランクは累積スコアに応じて決定される
- ランクタイプ: Bronze → Silver → Gold → Master の順に昇格
- 各ランクタイプ内に複数のランクレベルが存在
- スコアが規定値を超えるとランクまたはランクレベルがアップ
- ランク/ランクレベルは降臨バトルごとに個別管理される

### ランクアップ報酬
- ランクまたはランクレベルに到達すると報酬を獲得
- 報酬は以下のカテゴリから設定される：
  - Rank: ランク到達報酬
  - MaxScore: ハイスコア更新報酬
  - Ranking: ランキング報酬（該当する場合）
  - RaidTotalScore: レイド累計スコア報酬（該当する場合）

### ハイスコア更新
- トータルスコアが過去の最高スコアを上回った場合、ハイスコアとして記録される
- ハイスコア更新時は「NEW RECORD」フラグが表示される

### 再挑戦の制約
- 再挑戦可能な場合のみリトライボタンが表示される
- 再挑戦にはスタミナが必要
- スタミナ不足時はスタミナ補充の選択肢が表示される
- 1日の挑戦可能回数に制限がある場合、制限に達すると再挑戦不可

### 演出の自動進行
- 演出は以下の順序で自動的に進行する：
  1. BGM再生（勝利リザルトBGM）
  2. 詳細スコアのスライドイン・カウントアップ
  3. トータルスコアのスライドイン・カウントアップ
  4. ランクパネルの表示
  5. ランクアップ演出（該当する場合）
  6. ユニット入手演出（該当する場合）
  7. 報酬パネルの表示
  8. ユーザーレベルアップ演出（該当する場合）

### イベントキャンペーン表示
- イベントキャンペーン期間中の場合、残り時間がバルーン表示される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleResultPresenter.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/Presenter/AdventBattleResultPresenter.cs`
- `Presentation/Presenters/AdventBattleResultRankUpEffectPresenter.cs`（ランクアップ演出用）

#### ViewModel
- `Presentation/ViewModels/AdventBattleResultViewModel.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/ViewModel/AdventBattleResultViewModel.cs`
- `Presentation/ViewModels/AdventBattleResultScoreViewModel.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/ViewModel/AdventBattleResultScoreViewModel.cs`
- `Presentation/ViewModels/AdventBattleResultScoreRankTargetViewModel.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/ViewModel/AdventBattleResultScoreRankTargetViewModel.cs`

#### ViewController
- `Presentation/View/AdventBattleResultViewController.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/View/AdventBattleResultViewController.cs`
- `Presentation/View/AdventBattleResultRankUpEffectViewController.cs`（ランクアップ演出用）

#### Model
- `Domain/Model/AdventBattleResultScoreModel.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Domain/Model/AdventBattleResultScoreModel.cs`
- `Domain/Model/AdventBattleResultScoreRankTargetModel.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Domain/Model/AdventBattleResultScoreRankTargetModel.cs`

#### Factory
- `Domain/Factory/AdventBattleResultScoreModelFactory.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Domain/Factory/AdventBattleResultScoreModelFactory.cs`
- `Presentation/Factory/AdventBattleResultScoreViewModelFactory.cs`
  - `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/Factory/AdventBattleResultScoreViewModelFactory.cs`

### AdventBattleResultViewModelの構造

画面全体のデータを保持するViewModel：

- **AcquiredPlayerResources**: 獲得した報酬のアイコンリスト
- **CurrentScore**: 今回のバトルのトータルスコア
- **HighScore**: これまでのハイスコア
- **NewRecordFlag**: ハイスコアを更新したかどうか
- **AdventBattleResultScoreViewModel**: スコア・ランク情報（詳細は下記）
- **RemainingEventCampaignTimeSpan**: イベントキャンペーン残り時間
- **UserLevelUpResult**: ユーザーレベルアップ結果情報
- **IsRetryAvailable**: 再挑戦可能かどうか

### AdventBattleResultScoreViewModelの構造

スコアとランクに関する詳細情報：

- **CurrentRankType**: 現在のランクタイプ（Bronze/Silver/Gold/Master）
- **CurrentScoreRankLevel**: 現在のランクレベル
- **AdventBattleResultScoreRankTargetModels**: ランクアップ目標情報のリスト
- **RankRewards**: ランク報酬のアイコンリスト
- **DamageScore**: 与ダメージスコア
- **EnemyDefeatScore**: 敵撃破スコア
- **BossEnemyDefeatScore**: ボス撃破スコア

**表示制御ロジック**：
- `IsRankOrRankLevelUp()`: ランクまたはランクレベルがアップしたかどうか
- `LastAchievedRankAndLevel()`: 最後に到達したランクとランクレベルを取得
- `IsScoreUpdated()`: スコアが更新されたかどうか

### 画面初期化時の引数

```csharp
AdventBattleResultViewController.Argument(AdventBattleResultViewModel viewModel)
```

この画面は`InGamePresenter`からバトル終了時に生成され、バトル結果データ（`VictoryResultModel`）から変換された`AdventBattleResultViewModel`を引数として受け取ります。

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.MstEventId | mst_advent_battles.mst_event_id | イベントID |
| MstAdventBattle.MstInGameId | mst_advent_battles.mst_in_game_id | インゲームID |
| MstAdventBattle.AdventBattleType | mst_advent_battles.advent_battle_type | バトルタイプ（ScoreChallenge/Raid） |
| MstAdventBattle.Exp | mst_advent_battles.exp | 獲得リーダーEXP |
| MstAdventBattle.Coin | mst_advent_battles.coin | 獲得コイン |
| MstAdventBattleScoreRank.Id | mst_advent_battle_ranks.id | ランクID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_ranks.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold/Master） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_ranks.rank_level | ランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_ranks.required_lower_score | ランク到達に必要な最低スコア |
| MstAdventBattleRewardGroup.Id | mst_advent_battle_reward_groups.id | 報酬グループID |
| MstAdventBattleRewardGroup.MstAdventBattleId | mst_advent_battle_reward_groups.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリー（MaxScore/Ranking/Rank/RaidTotalScore） |
| MstAdventBattleRewardGroup.ConditionValue | mst_advent_battle_reward_groups.condition_value | 報酬条件値 |
| MstAdventBattleReward.Id | mst_advent_battle_rewards.id | 報酬ID |
| MstAdventBattleReward.MstAdventBattleRewardGroupId | mst_advent_battle_rewards.mst_advent_battle_reward_group_id | 報酬グループID |
| MstAdventBattleReward.ResourceType | mst_advent_battle_rewards.resource_type | 報酬タイプ（Coin/FreeDiamond/Item/Emblem） |
| MstAdventBattleReward.ResourceId | mst_advent_battle_rewards.resource_id | 報酬ID（アイテムIDなど） |
| MstAdventBattleReward.ResourceAmount | mst_advent_battle_rewards.resource_amount | 報酬数量 |
| MstAdventBattleClearReward.Id | mst_advent_battle_clear_rewards.id | クリア報酬ID |
| MstAdventBattleClearReward.MstAdventBattleId | mst_advent_battle_clear_rewards.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleClearReward.RewardCategory | mst_advent_battle_clear_rewards.reward_category | 報酬カテゴリー（Always/FirstClear/Random） |
| MstAdventBattleClearReward.ResourceType | mst_advent_battle_clear_rewards.resource_type | 報酬タイプ |
| MstAdventBattleClearReward.ResourceId | mst_advent_battle_clear_rewards.resource_id | 報酬ID |
| MstAdventBattleClearReward.ResourceAmount | mst_advent_battle_clear_rewards.resource_amount | 報酬数量 |

#### ユーザーデータ（GameFetch）

この画面ではユーザーデータは直接参照していません。バトル結果データは`InGamePresenter`から引数として受け取ります。

### 呼び出しているAPI

この画面自体はAPIを呼び出しません。バトル結果データは`InGame`画面でのバトル終了時のAPI応答結果から取得され、引数として渡されます。

再挑戦ボタンタップ時は、`InGamePresenter`の`RetryButtonAction`がコールバックとして実行され、そこでスタミナ確認などの処理とAPI呼び出しが行われます。
