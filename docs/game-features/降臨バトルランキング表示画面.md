# 降臨バトルランキング表示画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルランキング表示画面 |
| **画面番号** | 44-4-2 |
| **画面種別** | メイン画面 |

## 概要

降臨バトルのランキング情報を表示する画面です。現在開催中または過去に開催された降臨バトルのTOP100ランキングと、プレイヤー自身のランキング情報を確認できます。各プレイヤーの最高スコア、順位、スコアランク（Master/Gold/Silver/Bronze）が表示されます。

## プレイヤーができること

### ランキング情報の閲覧

#### TOP100ランキングの確認
- 上位100位までのプレイヤーランキングを一覧表示
- 各プレイヤーの以下の情報を表示：
  - ランキング順位
  - プレイヤー名
  - 最高スコア
  - スコアランク（Master/Gold/Silver/Bronze）とランクレベル
  - アバターアイコン（設定したユニット）
  - エンブレム
- スコアが0点（ランキング参加条件未達成）のプレイヤーは除外される
- 自分自身がランキングに含まれる場合は、該当エントリがハイライト表示される

#### 自分のランキング情報の確認
- 画面に自分のランキング情報が表示される：
  - 現在の順位
  - 最高スコア
  - スコアランク（Master/Gold/Silver/Bronze）とランクレベル
  - プレイヤー名
  - アバターアイコン
  - エンブレム
- 集計中の場合は「集計中」フラグが表示される
- 表示状態は以下のいずれか：
  - **通常表示**: ランキングに参加し、スコアが反映されている
  - **未参加表示**: まだ降臨バトルに参加していない（EmptyCurrentRanking）
  - **参加条件未達成表示**: 参加したがスコアが0点でランキング対象外（NotAchieveRanking）
  - **除外表示**: 不正行為等によりランキングから除外されている（ExcludeRanking）

### ヘルプ情報の確認
- ヘルプボタンをタップすると、遊び方情報が表示される（実装予定）

### 画面の終了
- 戻るボタンをタップすると、前の画面に戻る

## 画面の要素

### ヘッダー部分
- 降臨バトル名の表示
- ヘルプボタン
- 戻るボタン

### 自分のランキング情報エリア
- 自分の順位・スコア・ランク情報
- アバターアイコンとエンブレム
- 集計中フラグ（該当する場合）
- 状態に応じた表示切り替え（未参加/参加条件未達成/除外）

### TOP100ランキングリスト
- 上位100位までのプレイヤー情報をリスト表示
- 各エントリには順位、名前、スコア、ランク、アイコン情報を含む
- 自分のエントリは強調表示

## 画面遷移

### この画面への遷移
- **降臨バトルトップ画面**: ランキングボタンをタップ
- 画面表示時に引数として降臨バトルID（`mstAdventBattleId`）とランキングViewModel（`AdventBattleRankingViewModel`）が渡される

### この画面からの遷移
- **前の画面（通常はホーム画面）**: 戻るボタンをタップ

## ゲーム仕様・制約事項

### ランキング参加条件
- 降臨バトルをプレイし、スコアが1点以上の場合にランキング参加
- スコアが0点の場合は参加条件未達成としてランキング対象外

### スコアランク（Rank Type）
- スコアに応じて4段階のランクタイプが設定される：
  - **Master**: 最上位ランク
  - **Gold**: 上位ランク
  - **Silver**: 中位ランク
  - **Bronze**: 下位ランク
- 各ランクタイプ内でさらにレベル（RankLevel）が設定される
- ランク判定は累計スコア（TotalScore）を基準に、`mst_advent_battle_ranks`テーブルの`required_lower_score`で決定される

### 集計中の判定
- 現在開催中の降臨バトルの場合：
  - ランキングAPIから取得したスコアと、ユーザーデータの最新スコアに差異がある場合に「集計中」と判定
- 終了済みの降臨バトルの場合：
  - 常に集計完了とみなす

### ランキング除外
- 不正行為等により`is_excluded_ranking`フラグが立っている場合、ランキング表示から除外される

### TOP100リストの仕様
- ランキング順位の昇順で表示（1位が最上位）
- スコアが0点のプレイヤーは除外される
- 自分自身がTOP100に入っている場合は、リスト内で該当エントリがハイライト表示

## 技術参考情報

### 画面実装パス
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/`

### 主要コンポーネント

#### Presenter
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Presenters/AdventBattleRankingPresenter.cs`

#### ViewModel
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingViewModel.cs`
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingElementViewModel.cs`
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingMyselfUserViewModel.cs`
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingOtherUserViewModel.cs`

#### View
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Views/AdventBattleRankingView.cs`
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Views/AdventBattleRankingViewController.cs`

#### UseCase
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Domain/UseCases/AdventBattleRankingUseCase.cs`

#### ModelFactory
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Domain/ModelFactories/AdventBattleRankingModelFactory.cs`

#### Translator
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Translators/AdventBattleRankingViewModelTranslator.cs`

### AdventBattleRankingViewModelの構造

**AdventBattleRankingViewModel**:
- `CurrentRanking`: AdventBattleRankingElementViewModel - 現在のランキング情報全体

**AdventBattleRankingElementViewModel**:
- `OtherUserViewModels`: IReadOnlyList<AdventBattleRankingOtherUserViewModel> - TOP100ランキングリスト
- `MyselfUserViewModel`: AdventBattleRankingMyselfUserViewModel - 自分のランキング情報
- `AdventBattleName`: AdventBattleName - 降臨バトル名

**AdventBattleRankingMyselfUserViewModel**（自分のランキング情報）:
- `UserName`: ユーザー名
- `MaxScore`: 最高スコア
- `EmblemIconAssetPath`: エンブレムアイコンのアセットパス
- `UnitIconAssetPath`: ユニットアイコンのアセットパス
- `Rank`: ランキング順位
- `RankType`: スコアランクタイプ（Master/Gold/Silver/Bronze）
- `RankLevel`: スコアランクレベル
- `CalculatingRankings`: 集計中フラグ
- `ViewStatus`: 表示状態（Normal/EmptyCurrentRanking/NotAchieveRanking/ExcludeRanking）

**AdventBattleRankingOtherUserViewModel**（他プレイヤーのランキング情報）:
- `UserName`: ユーザー名
- `MaxScore`: 最高スコア
- `EmblemIconAssetPath`: エンブレムアイコンのアセットパス
- `UnitIconAssetPath`: ユニットアイコンのアセットパス
- `Rank`: ランキング順位
- `IsMyself`: 自分自身かどうかのフラグ
- `RankType`: スコアランクタイプ（Master/Gold/Silver/Bronze）
- `RankLevel`: スコアランクレベル

**表示制御ロジック**:
- `AdventBattleRankingMyselfUserViewStatus`で表示状態を制御：
  - `Normal`: 通常表示
  - `EmptyCurrentRanking`: 未参加表示
  - `NotAchieveRanking`: 参加条件未達成表示
  - `ExcludeRanking`: ランキング除外表示

### 画面初期化時の引数

```csharp
AdventBattleRankingViewController.Argument(
    AdventBattleRankingViewModel adventBattleRankingViewModel
)
```

- `adventBattleRankingViewModel`: 表示するランキング情報（事前にUseCaseで取得済み）

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.AdventBattleName | mst_advent_battles_i18n.name（想定） | 降臨バトル名の多言語表示 |
| MstAdventBattleScoreRank.Id | mst_advent_battle_ranks.id | スコアランク設定ID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_ranks.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold/Master） |
| MstAdventBattleScoreRank.RankLevel | mst_advent_battle_ranks.rank_level | ランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_ranks.required_lower_score | ランク到達に必要な最低スコア |
| MstAdventBattleScoreRank.AssetKey | mst_advent_battle_ranks.asset_key | ランクアイコンのアセットキー |
| MstEmblem.AssetKey | mst_emblems.asset_key | エンブレムのアセットキー |
| MstEmblem.EmblemType | mst_emblems.emblem_type | エンブレムタイプ（Event/Series） |
| MstCharacter.AssetKey | mst_units.asset_key | ユニットのアセットキー |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserProfile.Name | usr_user_profiles.name | プレイヤー名 |
| UserProfile.MyId | usr_user_profiles.my_id | プレイヤーのMYID |
| UserProfile.MstEmblemId | usr_user_profiles.mst_emblem_id | 設定しているエンブレムID |
| UserProfile.MstUnitId | usr_user_profiles.mst_unit_id | アバターとして設定しているユニットID |
| UserAdventBattle.MstAdventBattleId | usr_advent_battles.mst_advent_battle_id | 降臨バトルID |
| UserAdventBattle.MaxScore | usr_advent_battles.max_score | 最高スコア（クライアント側の最新値） |
| UserAdventBattle.TotalScore | usr_advent_battles.total_score | 累計スコア（スコアランク判定に使用） |
| UserAdventBattle.IsExcludedRanking | usr_advent_battles.is_excluded_ranking | ランキング除外フラグ |

### 呼び出しているAPI

#### 画面表示前（UseCaseで呼び出し）

- **GET `/api/advent_battle/ranking`**: 降臨バトルランキング取得API
  - パラメータ:
    - `mstAdventBattleId` (string): 降臨バトルID
    - `isPrevious` (bool): 前回ランキングを取得するか（false = 現在のランキング）
  - 用途: TOP100ランキング情報と自分のランキング情報を取得
  - レスポンスに含まれる情報:
    - `RankingList`: TOP100のプレイヤーランキング情報（順位、名前、最高スコア、累計スコア、エンブレムID、ユニットID等）
    - `MyRanking`: 自分のランキング情報（順位、最高スコア、累計スコア、除外フラグ等）
