# 降臨バトルミッション画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルミッション画面 |
| **画面番号** | 44-1-7 |
| **画面種別** | モーダル画面 |

## 概要

降臨バトルに関連するミッションを一覧表示し、報酬を受け取るための専用画面です。イベントミッション（EventMission）と期間限定ミッション（LimitedTerm）の2種類のミッションが表示され、達成済みのミッションから報酬を個別または一括で受け取ることができます。

降臨バトル開催期間外は表示されません。

## プレイヤーができること

### ミッション一覧の確認

#### ミッション情報の表示
- ミッションの達成条件と説明を確認
- 現在の進捗状況（達成数/目標数）を確認
- 報酬アイテムとその数量を確認
- ミッションの残り期間を確認
- ミッションのステータス（未達成/達成済み/受取済み）を確認

### 報酬の受け取り

#### 個別受け取り
- ミッション達成後、ミッションごとに「受け取る」ボタンをタップ
- 報酬受け取りダイアログが表示され、獲得したアイテムを確認
- 報酬には経験値、コイン、ダイヤ、アイテム、エンブレム、ユニットが含まれる
- 報酬に経験値が含まれる場合、レベルアップする可能性がある

#### 一括受け取り
- 受け取り可能なミッションが1つ以上ある場合、「一括受け取り」ボタンが有効になる
- ボタンをタップすると、受け取り可能な全ミッションの報酬を一度に受け取り
- 複数の報酬が同じリソースタイプの場合はマージして表示される
- 通信中は一括受け取りボタンが無効化される

### ミッションへの挑戦

#### 挑戦ボタン
- 各ミッションの「挑戦」ボタンをタップ
- 降臨バトルTOP画面以外から開いた場合は、ダイアログが閉じるのみ（降臨バトル関連のミッションしか表示されないため）

### 報酬アイテムの詳細確認

#### アイテム詳細表示
- 報酬アイコンをタップすると、アイテム詳細モーダルが表示される
- アイテムの説明や効果を確認可能

## 画面の要素

### ヘッダー部分
- 画面タイトル
- 閉じるボタン（×ボタン）

### メイン表示エリア
- ミッション一覧（スクロール可能）
- 各ミッションセルには以下を表示：
  - ミッション説明文
  - 進捗状況（例：「3/5」）
  - 報酬アイコンと数量
  - 残り期間
  - ステータス別ボタン（未達成時：挑戦ボタン、達成時：受け取るボタン、受取済み：受取済み表示）

### ボタンエリア
- 一括受け取りボタン（受け取り可能なミッションがある場合のみ有効）

### フッター部分
- なし

## 画面遷移

### この画面への遷移
- **降臨バトルTOP画面**: ミッションアイコンをタップ

### この画面からの遷移
- **閉じる操作**:
  - 閉じるボタンをタップ、またはEscapeキー押下で画面を閉じる
  - 画面が閉じられる際、受け取り可能なミッションがあるかどうかのバッジ情報が更新される
- **報酬受け取り後**:
  - 報酬受け取りダイアログ（CommonReceiveView）が表示される
  - ヘッダーのステータスが更新される（経験値受け取りによるゲージアニメーション）
- **アイテム詳細表示**:
  - 報酬アイコンタップでアイテム詳細モーダルが表示される

## ゲーム仕様・制約事項

### 降臨バトル開催期間の制限
- 降臨バトルが開催されていない場合、この画面は表示されない（空のデータが返される）
- 降臨バトルの開催期間情報は `AdventBattleDateTimeEvaluator` で判定される

### ミッションの種類
- **イベントミッション（EventMission）**: `event_category` が `AdventBattle` のミッション
- **期間限定ミッション（LimitedTerm）**: `mission_category` が `AdventBattle` のミッション

### 報酬受け取りの制限
- 降臨バトル開催期間外は報酬を受け取れない
- 一括受け取りは期間限定ミッション（LimitedTerm）のみが対象

### 画面操作中の制限
- 通信中など操作不可能な状態でEscapeキーを押すと、無効操作メッセージが表示される
- 通信中は一括受け取りボタンが無効化される

### ミッション進捗の更新
- 画面表示時にサーバーからミッション情報を取得し、最新の進捗状況を表示
- 報酬受け取り後、ミッション一覧が自動的に更新される

## 技術参考情報

### 画面実装パス
- `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleMissionPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/Presenter/AdventBattleMissionPresenter.cs)
  - 主要なデリゲートメソッド：
    - `OnViewWillAppear()`: 画面表示時にミッション一覧を取得
    - `OnReceiveButtonTapped()`: 個別受け取りボタンタップ時
    - `OnBulkReceiveButtonTapped()`: 一括受け取りボタンタップ時
    - `OnChallengeButtonTapped()`: 挑戦ボタンタップ時
    - `OnRewardIconSelected()`: 報酬アイコンタップ時
    - `OnCloseButtonTapped()`: 閉じるボタンタップ時
    - `OnEscape()`: Escapeキー押下時

#### ViewModel
- `Presentation/ViewModels/AdventBattleMissionViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/ViewModel/AdventBattleMissionViewModel.cs)
  - `AdventBattleMissionCellViewModels`: ミッション一覧
  - `IsBulkReceivable`: 一括受け取り可能フラグ
- `Presentation/ViewModels/AdventBattleMissionCellViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/ViewModel/AdventBattleMissionCellViewModel.cs)
  - `AdventBattleMissionId`: ミッションID
  - `MissionType`: ミッションタイプ（LimitedTerm/Event）
  - `MissionStatus`: ステータス（Nothing/Receivable/Received）
  - `MissionProgress`: 進捗数
  - `CriterionCount`: 達成条件回数
  - `PlayerResourceIconViewModels`: 報酬アイコン一覧
  - `MissionDescription`: ミッション説明文
  - `DestinationScene`: 遷移先画面
  - `EndTimeSpan`: 残り期間

#### UseCase
- `Domain/UseCases/ShowAdventBattleMissionListUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Domain/UseCase/ShowAdventBattleMissionListUseCase.cs)
  - ミッション一覧の取得と降臨バトル開催期間の判定
- `Domain/UseCases/ReceiveAdventBattleMissionRewardUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Domain/UseCase/ReceiveAdventBattleMissionRewardUseCase.cs)
  - 個別ミッション報酬の受け取り処理
- `Domain/UseCases/BulkReceiveAdventBattleMissionRewardUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Domain/UseCase/BulkReceiveAdventBattleMissionRewardUseCase.cs)
  - 一括ミッション報酬の受け取り処理

#### Translator
- `Presentation/Translator/AdventBattleMissionViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/Translator/AdventBattleMissionViewModelTranslator.cs)
  - ドメインモデルからViewModelへの変換
  - 一括受け取り可能フラグの判定

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstMissionEventModel.Id | mst_mission_events.id | イベントミッションID |
| MstMissionEventModel.EventCategory | mst_mission_events.event_category | イベントカテゴリー（AdventBattle） |
| MstMissionEventModel.CriterionType | mst_mission_events.criterion_type | ミッション達成条件タイプ |
| MstMissionEventModel.CriterionValue | mst_mission_events.criterion_value | ミッション達成条件値 |
| MstMissionEventModel.CriterionCount | mst_mission_events.criterion_count | ミッション達成回数 |
| MstMissionEventModel.MstMissionRewardGroupId | mst_mission_events.mst_mission_reward_group_id | 報酬グループID |
| MstMissionEventModel.DestinationScene | mst_mission_events.destination_scene | ミッションから遷移する画面 |
| MstMissionLimitedTermModel.Id | mst_mission_limited_terms.id | 期間限定ミッションID |
| MstMissionLimitedTermModel.MissionCategory | mst_mission_limited_terms.mission_category | ミッションカテゴリー（AdventBattle） |
| MstMissionLimitedTermModel.CriterionType | mst_mission_limited_terms.criterion_type | ミッション達成条件タイプ |
| MstMissionLimitedTermModel.CriterionValue | mst_mission_limited_terms.criterion_value | ミッション達成条件値 |
| MstMissionLimitedTermModel.CriterionCount | mst_mission_limited_terms.criterion_count | ミッション達成回数 |
| MstMissionLimitedTermModel.MstMissionRewardGroupId | mst_mission_limited_terms.mst_mission_reward_group_id | 報酬グループID |
| MstMissionLimitedTermModel.DestinationScene | mst_mission_limited_terms.destination_scene | ミッションから遷移する画面 |
| MstMissionLimitedTermModel.StartAt | mst_mission_limited_terms.start_at | ミッション開始日時 |
| MstMissionLimitedTermModel.EndAt | mst_mission_limited_terms.end_at | ミッション終了日時 |
| MstMissionRewardModel.ResourceType | mst_mission_rewards.resource_type | 報酬タイプ（Exp/Coin/FreeDiamond/Item/Emblem/Unit） |
| MstMissionRewardModel.ResourceId | mst_mission_rewards.resource_id | 報酬リソースID |
| MstMissionRewardModel.ResourceAmount | mst_mission_rewards.resource_amount | 報酬の個数 |
| MstAdventBattleModel.EndDateTime | mst_advent_battles.end_at | 降臨バトル終了日時（ミッション残り期間計算に使用） |

#### ユーザーデータ（API レスポンス）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserMissionEventModel.MstMissionEventId | APIレスポンス: user_mission_events[].mst_mission_event_id | イベントミッションマスタID |
| UserMissionEventModel.Progress | APIレスポンス: user_mission_events[].progress | ミッション進捗数 |
| UserMissionEventModel.IsCleared | APIレスポンス: user_mission_events[].is_cleared | ミッション達成フラグ |
| UserMissionEventModel.IsReceivedReward | APIレスポンス: user_mission_events[].is_received_reward | 報酬受け取り済みフラグ |
| UserMissionLimitedTermModel.MstMissionLimitedTermId | APIレスポンス: user_mission_limited_terms[].mst_mission_limited_term_id | 期間限定ミッションマスタID |
| UserMissionLimitedTermModel.Progress | APIレスポンス: user_mission_limited_terms[].progress | ミッション進捗数 |
| UserMissionLimitedTermModel.IsCleared | APIレスポンス: user_mission_limited_terms[].is_cleared | ミッション達成フラグ |
| UserMissionLimitedTermModel.IsReceivedReward | APIレスポンス: user_mission_limited_terms[].is_received_reward | 報酬受け取り済みフラグ |
| UserParameterModel.Level | user_parameters.level | プレイヤーレベル（報酬受け取りでレベルアップする可能性がある） |
| UserParameterModel.Exp | user_parameters.exp | プレイヤー経験値 |

### 呼び出しているAPI

#### 画面表示時
- **POST `/api/mission/advent_battle_fetch`**: 降臨バトルミッション一覧取得
  - パラメータ: なし
  - 用途: 降臨バトル関連のミッション（イベントミッション・期間限定ミッション）の一覧と進捗を取得

#### 個別受け取り時
- **POST `/api/mission/bulk_receive_reward`**: ミッション報酬受け取り
  - パラメータ:
    - `missionType` (string): ミッションタイプ（"LimitedTerm" または "Event"）
    - `mstMissionIds` (string[]): ミッションID配列（個別の場合は1件のみ）
  - 用途: 指定したミッションの報酬を受け取る

#### 一括受け取り時
- **POST `/api/mission/bulk_receive_reward`**: ミッション報酬一括受け取り
  - パラメータ:
    - `missionType` (string): "LimitedTerm"（一括受け取りは期間限定ミッションのみ）
    - `mstMissionIds` (string[]): 受け取り可能なミッションID配列
  - 用途: 達成済みで未受け取りのミッション報酬を一括受け取り
