# 降臨バトルランキング結果画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルランキング結果画面 |
| **画面番号** | 44-4-3 |
| **画面種別** | ダイアログ |

## 概要

降臨バトルのランキング集計完了後、プレイヤーに自動的に表示されるダイアログです。前回の降臨バトルで獲得したスコアランク、順位、報酬を確認できます。プレイヤーがどのランク（ブロンズ、シルバー、ゴールド、マスター）に到達したか、そして何位にランクインしたかが演出とともに表示されます。

## プレイヤーができること

### ランキング結果の確認

#### スコアランク
- 自分が到達したランクタイプ（ブロンズ、シルバー、ゴールド、マスター）を確認できる
- ランクレベルを確認できる
- 獲得したスコアを確認できる

#### ランキング順位
- 自分のランキング順位を確認できる
- ランキング除外の場合は順位が表示されない

#### 獲得報酬
- ランキング順位に応じた報酬を確認できる
- 報酬アイコンが一覧表示される

#### 降臨バトル情報
- 対象となった降臨バトル名を確認できる
- 降臨バトルのタイプ（スコアチャレンジ/レイド）を確認できる
- 敵キャラクターの画像を確認できる

### 結果アニメーションの確認

#### 表示時の演出
- ダイアログ表示時に結果アニメーションが自動的に再生される
- アニメーション再生中は画面操作がブロックされる
- アニメーション完了後にダイアログの操作が可能になる

### ダイアログの閉じ方

#### 閉じるボタン
- 閉じるボタンをタップしてダイアログを閉じる
- 呼び出し元の画面に戻る

#### エスケープキー操作
- エスケープキーでダイアログを閉じることができる
- ただし、アニメーション再生中はエスケープキー操作が無効
- アニメーション再生中にエスケープキーを押すとメッセージが表示される

## 画面の要素

### 結果表示エリア
- 降臨バトル名
- 降臨バトルタイプ（スコアチャレンジ/レイド）
- 敵キャラクター画像
- スコアランクアイコン
- ランクレベル
- ランキング順位（除外されていない場合）
- 獲得スコア
- 獲得報酬アイコン一覧

### ボタンエリア
- 閉じるボタン

## 画面遷移

### この画面への遷移
- **自動表示**: 降臨バトルのランキング集計完了後、以下の条件を満たす場合に自動的に表示される
  - ランキング集計が完了した降臨バトルが存在する
  - そのランキング結果アニメーションをまだ再生していない
  - 降臨バトル終了から30日以内である
  - ランキング集計時間（デフォルト：数時間、設定可能）を経過している

### この画面からの遷移
- **元の画面に戻る**: 閉じるボタンまたはエスケープキーでダイアログを閉じる
  - ダイアログが閉じられた際に指定されたコールバックが実行される

## ゲーム仕様・制約事項

### 自動表示条件
- ランキング集計が完了した降臨バトルがある場合に自動表示される
- 集計時間は設定値（`mst_configs.AdventBattleRankingAggregateHours`）で制御される
- デフォルトの集計時間は定数で定義されている
- 降臨バトル終了から30日以上経過した結果は表示されない

### アニメーション再生の制御
- 同じ降臨バトルの結果アニメーションは1回のみ再生される
- 再生済みの情報はローカルに保存される（PreferenceRepository）
- アニメーション再生中は画面操作が無効化される
- アニメーション完了前にエスケープキーを押すと操作不可のメッセージが表示される

### ランキング除外
- ランキング除外フラグが立っている場合、順位は表示されない
- ランキング除外でもスコアランクと報酬は表示される

### 報酬の決定
- ランキング順位に応じて報酬が決定される
- 報酬は`mst_advent_battle_reward_groups`と`mst_advent_battle_rewards`から取得される
- 報酬カテゴリーは「Ranking」
- 報酬条件値はランキング順位を基準に判定される（順位以上で最も小さい条件値を持つ報酬グループ）

### 表示対象の降臨バトルの特定
- 現在時刻から集計時間を引いた時刻を基準にする
- その時刻より前に終了した降臨バトルのうち、最も新しいものを対象とする
- 該当する降臨バトルが存在しない場合、ダイアログは表示されない

### データの取得タイミング
- ダイアログ表示前にAPIから降臨バトル情報を取得する
- APIレスポンスにランキング情報が含まれている場合のみダイアログを表示する
- APIレスポンスが空の場合、ダイアログは表示されない

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/`

### 主要コンポーネント

#### Presenter
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Presenters/AdventBattleRankingResultPresenter.cs`

#### ViewModel
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/ViewModels/AdventBattleRankingResultViewModel.cs`

#### View
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Views/AdventBattleRankingResultView.cs`
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Views/AdventBattleRankingResultViewController.cs`

#### UseCase
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Domain/UseCases/AdventBattleRankingResultUseCase.cs`

#### ModelFactory
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Domain/ModelFactories/AdventBattleRankingResultModelFactory.cs`

#### Translator
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Translators/AdventBattleRankingResultViewModelTranslator.cs`

### AdventBattleRankingResultViewModelの構造
画面に表示するランキング結果情報を保持するViewModel。

主要プロパティ:
- RankType: ランクタイプ（Bronze/Silver/Gold/Master）
- RankLevel: ランクレベル
- Rank: ランキング順位
- Score: 獲得スコア
- RewardList: ランキング報酬リスト
- AdventBattleType: 降臨バトルタイプ（ScoreChallenge/Raid）
- EnemyImageAssetPath: 敵キャラクター画像パス
- AdventBattleName: 降臨バトル名

### 画面初期化時の引数
```csharp
AdventBattleRankingResultViewController.Argument(
    AdventBattleRankingResultViewModel: 表示するランキング結果ViewModel,
    OnCloseView: ダイアログを閉じた際のコールバック
)
```

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.BattleType | mst_advent_battles.advent_battle_type | 降臨バトルタイプ（ScoreChallenge/Raid） |
| MstAdventBattle.DisplayEnemyUnitIdFirst | mst_advent_battles.display_mst_unit_id1 | 結果画面に表示する敵キャラクターID |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | 降臨バトル終了日時（表示対象の判定に使用） |
| MstAdventBattle.AdventBattleName | mst_advent_battles_i18n.name | 降臨バトル名（多言語） |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_ranks.rank_type | スコアランクタイプ（Bronze/Silver/Gold/Master） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_ranks.rank_level | スコアランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_ranks.required_lower_score | ランク到達に必要な最低スコア（ランク判定に使用） |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリー（「Ranking」のみ使用） |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.condition_value | ランキング順位の条件値（報酬判定に使用） |
| MstAdventBattleReward.ResourceType | mst_advent_battle_rewards.resource_type | 報酬タイプ（Coin/FreeDiamond/Item/Emblem） |
| MstAdventBattleReward.ResourceId | mst_advent_battle_rewards.resource_id | 報酬ID（アイテムなどの場合） |
| MstAdventBattleReward.ResourceAmount | mst_advent_battle_rewards.resource_amount | 報酬数量 |
| MstEnemyCharacter.AssetKey | mst_enemy_characters.asset_key | 敵キャラクター画像アセットキー |
| MstConfig.AdventBattleRankingAggregateHours | mst_configs.value | ランキング集計時間（時間単位、デフォルト値あり） |

#### ユーザーデータ

この画面ではユーザーデータは直接使用されず、APIレスポンスから得られるランキング情報を使用します。

APIレスポンスに含まれる情報:
- AdventBattleResult.MstAdventBattleId: 対象の降臨バトルID
- AdventBattleResult.MyRanking.MaxScore: プレイヤーの最高スコア
- AdventBattleResult.MyRanking.TotalScore: プレイヤーの累計スコア
- AdventBattleResult.MyRanking.Rank: ランキング順位
- AdventBattleResult.MyRanking.IsExcludeRanking: ランキング除外フラグ

#### ローカルデータ（Preference）

| クライアント定義 | 保存場所 | クライアント説明 |
|----------------|---------|----------------|
| PreferenceRepository.AdventBattleRankingResultAnimationPlayedId | ローカルストレージ | アニメーション再生済みの降臨バトルID（重複再生防止） |

### 呼び出しているAPI

#### ダイアログ表示前
- **GET `/api/advent_battle/info`**: 降臨バトル情報取得API
  - パラメータ: なし
  - 用途: 最後に集計が完了した降臨バトルのランキング情報を取得
  - レスポンス: AdventBattleInfoResultModel（AdventBattleResult含む）
  - 注意: ランキング情報がない場合や条件を満たさない場合、ダイアログは表示されない
