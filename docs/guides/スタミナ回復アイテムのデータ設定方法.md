# スタミナ回復アイテムのデータ設定方法ガイド

## 目次

1. [概要](#概要)
2. [アイテムの種類](#アイテムの種類)
3. [データ設定の流れ](#データ設定の流れ)
4. [MstItem.csvの設定](#mstitemcsvの設定)
5. [MstItemI18n.csvの設定](#mstitemi18ncsvの設定)
6. [設定例](#設定例)
7. [注意事項](#注意事項)
8. [関連ドキュメント](#関連ドキュメント)

---

## 概要

スタミナ回復アイテムは、ユーザーが任意のタイミングで使用することでスタミナを回復できる消費アイテムです。

### 主な特徴

- **使用タイミング**: ユーザーが任意のタイミングで使用可能
- **回復方式**: パーセンテージ回復または固定値回復
- **複数個使用**: 1回のAPI呼び出しで複数個同時使用可能
- **上限制御**: システム上限999まで回復可能（ユーザー上限を超えても可）
- **配布方法**: ログインボーナス、ミッション報酬、イベント報酬など

---

## アイテムの種類

GLOWプロジェクトでは、2種類のスタミナ回復アイテムをサポートしています。

### 1. StaminaRecoveryPercent（パーセンテージ回復）

**特徴:**
- スタミナ上限値の指定したパーセンテージ分を回復
- ユーザーのレベルに応じて回復量が変動

**回復量計算式:**
```
回復量 = floor(スタミナ上限値 × effect_value%) × 使用個数
```

**使用例:**
- effect_value = "50" の場合、スタミナ上限値の50%を回復
- スタミナ上限値が180の場合: floor(180 × 0.5) = 90回復
- スタミナ上限値が200の場合: floor(200 × 0.5) = 100回復

### 2. StaminaRecoveryFixed（固定値回復）

**特徴:**
- 設定した固定値分を回復
- ユーザーのレベルに関わらず一定量を回復

**回復量計算式:**
```
回復量 = effect_value × 使用個数
```

**使用例:**
- effect_value = "10" の場合、常に10回復
- effect_value = "100" の場合、常に100回復

---

## データ設定の流れ

スタミナ回復アイテムを追加するには、以下の2つのCSVファイルにデータを追加します。

```
1. MstItem.csv          ← アイテムの基本情報を設定
2. MstItemI18n.csv      ← アイテムの表示名と説明文を設定
```

### 設定手順

1. **テンプレートCSVを確認**
   - `projects/glow-masterdata/sheet_schema/MstItem.csv` からヘッダー構造を確認

2. **アイテムIDを決定**
   - 命名規則に従ってアイテムIDを決定（例: `stamina_item_glo_00001`）

3. **MstItem.csvにレコードを追加**
   - アイテムの基本情報を設定

4. **MstItemI18n.csvにレコードを追加**
   - 日本語の表示名と説明文を設定

5. **既存データとの整合性を確認**
   - 既存のスタミナ回復アイテムと比較して設定が適切か確認

---

## MstItem.csvの設定

### CSVヘッダー構造

```csv
ENABLE,id,type,group_type,rarity,asset_key,effect_value,sort_order,start_date,end_date,release_key,item_type,destination_opr_product_id
```

### 各カラムの説明

| カラム名 | 必須 | 説明 | 設定例 |
|---------|------|------|--------|
| **ENABLE** | ✓ | レコードの有効/無効 | `e` (有効), `d` (無効) |
| **id** | ✓ | アイテムID（一意） | `stamina_item_glo_00001` |
| **type** | ✓ | アイテム種別 | `StaminaRecoveryPercent` または `StaminaRecoveryFixed` |
| **group_type** | ✓ | アイテムグループ種別 | `Etc` (その他), `Consumable` (消費アイテム) |
| **rarity** | ✓ | レアリティ | `R`, `SR`, `SSR`, `UR` |
| **asset_key** | ✓ | アセットキー（画像リソース） | アイテムIDと同じ値を推奨 |
| **effect_value** | ✓ | 回復量の値 | パーセンテージ: `"50"` (50%), 固定値: `"10"` (10回復) |
| **sort_order** | ✓ | ソート順（表示順） | `1`, `2`, `3` ... |
| **start_date** | ✓ | 有効開始日時 | `"2026-02-01 15:00:00"` |
| **end_date** | ✓ | 有効終了日時 | `"2037-12-31 23:59:59"` |
| **release_key** | ✓ | リリースキー | `202602010` (YYYYMMvv形式) |
| **item_type** | ✓ | アイテムタイプ（typeと同じ） | `StaminaRecoveryPercent` または `StaminaRecoveryFixed` |
| **destination_opr_product_id** | - | 遷移先OprProduct ID | 通常は空欄 |

### 重要ポイント

#### 1. アイテムID命名規則

```
stamina_item_glo_<連番5桁>
```

**例:**
- `stamina_item_glo_00001`
- `stamina_item_glo_00002`

#### 2. typeとitem_typeの設定

**必ず一致させる必要があります。**

- パーセンテージ回復: `StaminaRecoveryPercent`
- 固定値回復: `StaminaRecoveryFixed`

#### 3. effect_valueの設定

**パーセンテージ回復の場合:**
```
"50"  → スタミナ上限値の50%を回復
"100" → スタミナ上限値の100%を回復（全回復）
```

**固定値回復の場合:**
```
"10"  → 10回復
"50"  → 50回復
"100" → 100回復
```

#### 4. release_keyの設定

リリースキーは `YYYYMMvv` 形式で設定します。

**例:**
- `202602010` → 2026年2月の1回目のリリース
- `202602020` → 2026年2月の2回目のリリース

---

## MstItemI18n.csvの設定

### CSVヘッダー構造

```csv
ENABLE,release_key,id,mst_item_id,language,name,description
```

### 各カラムの説明

| カラム名 | 必須 | 説明 | 設定例 |
|---------|------|------|--------|
| **ENABLE** | ✓ | レコードの有効/無効 | `e` (有効), `d` (無効) |
| **release_key** | ✓ | リリースキー | `202602010` |
| **id** | ✓ | I18nレコードID（一意） | `stamina_item_glo_00001_ja` |
| **mst_item_id** | ✓ | 対応するMstItemのid | `stamina_item_glo_00001` |
| **language** | ✓ | 言語コード | `ja` (日本語) |
| **name** | ✓ | アイテムの表示名 | `スタミナドリンク` |
| **description** | ✓ | アイテムの説明文 | `使用することでスタミナを最大10回復できるアイテム` |

### 重要ポイント

#### 1. I18nレコードID命名規則

```
<mst_item_id>_<language>
```

**例:**
- `stamina_item_glo_00001_ja` → 日本語
- `stamina_item_glo_00001_en` → 英語（将来対応時）

#### 2. descriptionの記載内容

**パーセンテージ回復の場合:**
```
使用することでスタミナを上限値の50%回復できるアイテム
```

**固定値回復の場合:**
```
使用することでスタミナを最大10回復できるアイテム
```

「最大」という言葉を入れることで、システム上限999による切り捨てが発生する可能性があることを示唆します。

---

## 設定例

### 例1: 固定値回復アイテム（スタミナドリンク）

**MstItem.csv:**
```csv
e,stamina_item_glo_00001,StaminaRecoveryFixed,Etc,R,stamina_item_glo_00001,10,1,"2026-02-01 15:00:00","2037-12-31 23:59:59",202602010,StaminaRecoveryFixed,
```

**MstItemI18n.csv:**
```csv
e,202602010,stamina_item_glo_00001_ja,stamina_item_glo_00001,ja,スタミナドリンク,使用することでスタミナを最大10回復できるアイテム
```

**回復挙動:**
- 回復量: 常に10
- 使用個数2の場合: 10 × 2 = 20回復
- スタミナが995の場合: 995 + 10 = 999（上限999で切り捨てなし）
- スタミナが999の場合: 使用不可（エラー）

---

### 例2: 固定値回復アイテム（大量回復）

**MstItem.csv:**
```csv
e,stamina_item_glo_00002,StaminaRecoveryFixed,Consumable,SR,stamina_item_glo_00002,100,2,"2026-02-01 15:00:00","2037-12-31 23:59:59",202602010,StaminaRecoveryFixed,
```

**MstItemI18n.csv:**
```csv
e,202602010,stamina_item_glo_00002_ja,stamina_item_glo_00002,ja,スタミナドリンク・大,使用することでスタミナを最大100回復できるアイテム
```

**回復挙動:**
- 回復量: 常に100
- 使用個数3の場合: 100 × 3 = 300回復
- スタミナが901の場合: 901 + 100 = 999（切り捨て発生、実際は98回復）

---

### 例3: パーセンテージ回復アイテム

**MstItem.csv:**
```csv
e,stamina_item_glo_00003,StaminaRecoveryPercent,Consumable,SSR,stamina_item_glo_00003,50,3,"2026-02-01 15:00:00","2037-12-31 23:59:59",202602010,StaminaRecoveryPercent,
```

**MstItemI18n.csv:**
```csv
e,202602010,stamina_item_glo_00003_ja,stamina_item_glo_00003,ja,スタミナドリンク・50%,使用することでスタミナを上限値の50%回復できるアイテム
```

**回復挙動:**
- スタミナ上限値が180の場合: floor(180 × 0.5) = 90回復
- スタミナ上限値が200の場合: floor(200 × 0.5) = 100回復
- ユーザーのレベルによって回復量が変動

---

## 注意事項

### 1. 回復量とシステム上限

**システム上限: 999**

スタミナは999を超えることができません。回復後のスタミナが999を超える場合、999で打ち切られます。

**例:**
- 現在スタミナ: 950
- 回復量: 100
- 回復後: min(950 + 100, 999) = 999（実際の回復量は49）

### 2. 使用可否の判定

**スタミナが999の場合: 使用不可**

スタミナが既にシステム上限999に達している場合、スタミナ回復アイテムは使用できません。

**スタミナ上限値との関係:**

従来のスタミナ回復（パーセンテージ回復アイテム）では、「現在スタミナ < スタミナ上限値」の場合のみ使用可能でしたが、固定値回復アイテムの追加により、以下のように変更されました:

- **パーセンテージ回復アイテム**: 現在スタミナ < スタミナ上限値
- **固定値回復アイテム**: 現在スタミナ < システム上限999

### 3. 複数個使用

**1回のAPI呼び出しで複数個同時使用可能**

```
回復量 = effect_value × 使用個数
```

**例:**
- effect_value = 10、使用個数 = 5の場合: 10 × 5 = 50回復

**注意:**
- 使用個数はクライアント側のUIで選択可能
- 所持個数を超える使用はできない
- システム上限999を超える部分は切り捨て

### 4. 既存データとの整合性

**アイテムIDの重複チェック**

新しいアイテムを追加する際は、既存のアイテムIDと重複しないように注意してください。

```bash
# アイテムIDの重複チェック
grep "^e,stamina_item_glo_00001," projects/glow-masterdata/MstItem.csv
```

**連番の確認**

```bash
# 既存のスタミナ回復アイテムを確認
grep "StaminaRecovery" projects/glow-masterdata/MstItem.csv
```

### 5. リリースキーの管理

**同一リリースキーでグループ化**

同じリリースで追加されるアイテムは、同じrelease_keyを設定します。

**例:**
- v1.5.0リリースで追加: `202601020`
- v1.6.0リリースで追加: `202602010`

### 6. テンプレートCSVの重要性

**必ずテンプレートCSVの構造に従う**

`projects/glow-masterdata/sheet_schema/MstItem.csv` のヘッダー構造は変更しないでください。

- 列の順序を変更しない
- 列名を変更しない
- 列を追加・削除しない

これらの変更は、データ投入シート（Google Sheets）との整合性を破壊し、DB投入エラーの原因となります。

---

## 関連ドキュメント

### 仕様書・設計書

- **API設計書**: `projects/glow-server/docs/sdd/features/スタミナ回復アイテム/07_サーバーAPI設計書.md`
- **ゲーム体験仕様確認結果**: `projects/glow-server/docs/sdd/features/スタミナ回復アイテム/04_ゲーム体験仕様確認結果まとめ.md`
- **固定値回復v2仕様確認**: `projects/glow-server/docs/sdd-v2/features/スタミナ回復アイテムv2/02_仕様確認.md`

### マスタデータ作成ガイド

- **運営仕様マスタデータ作成ガイド**: `.ai-context/prompts/運営仕様書からマスタデータ作成の手順書.md`
- **マスターテーブル一覧調査方法**: `マスタデータ/docs/マスターテーブル一覧調査方法.md`

### DBスキーマ

- **master_tables_schema.json**: `projects/glow-server/api/database/schema/exports/master_tables_schema.json`
  - `mst_items` テーブルのスキーマ定義

### 既存データ参照

- **MstItem.csv**: `projects/glow-masterdata/MstItem.csv`
  - 既存のスタミナ回復アイテムの設定例を確認できます

- **MstItemI18n.csv**: `projects/glow-masterdata/MstItemI18n.csv`
  - 既存のアイテム名・説明文の記載例を確認できます

### テンプレート

- **MstItem CSVテンプレート**: `projects/glow-masterdata/sheet_schema/MstItem.csv`
  - CSVのヘッダー構造の正式なテンプレート

---

## まとめ

スタミナ回復アイテムのデータ設定は、以下の手順で行います:

1. **アイテムIDを決定** (`stamina_item_glo_<連番>`)
2. **MstItem.csvにレコード追加**
   - type/item_type: `StaminaRecoveryFixed` または `StaminaRecoveryPercent`
   - effect_value: 回復量（固定値またはパーセンテージ）
3. **MstItemI18n.csvにレコード追加**
   - 日本語の表示名と説明文
4. **既存データとの整合性確認**
   - アイテムIDの重複がないか
   - release_keyが適切か

設定する際は、必ずテンプレートCSVの構造に従い、既存のスタミナ回復アイテムを参考にしてください。

---

**作成日**: 2026-01-13  
**対象バージョン**: v1.5.0以降
