# mst_abilities テーブルのクライアント側実装調査報告

## 1. データ構造

### 1.1 テーブル定義

**mst_abilities テーブル (MstAbility.csv)**
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | アビリティID (例: `ability_gust_koma_block`) |
| ability_type | UnitAbilityType (enum) | アビリティタイプ (例: `SlipDamageKomaBlock`) |
| asset_key | string | アイコン等のアセットキー (例: `damage_koma_block`) |

**mst_ability_i18ns テーブル (MstAbilityI18n.csv)**
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | 多言語レコードID |
| mst_ability_id | string | mst_abilitiesテーブルへの外部キー |
| language | Language (enum) | 言語 (`ja`, `en` など) |
| description | string | アビリティ説明文 (プレースホルダー付き: `{0}`, `{1}`) |
| filter_title | string | フィルタ表示用タイトル |

**mst_unit_abilities テーブル (MstUnitAbility.csv)**
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ユニットアビリティID |
| mst_ability_id | string | mst_abilitiesテーブルへの外部キー |
| ability_parameter1 | string | パラメータ1 (数値や条件値) |
| ability_parameter2 | string | パラメータ2 |
| ability_parameter3 | string | パラメータ3 |

### 1.2 マスターデータクラス構造

**MstAbilityData** (自動生成)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstAbilityData.cs`

```csharp
public class MstAbilityData
{
    public string Id { get; set; }                    // ObscuredString
    public UnitAbilityType AbilityType { get; set; }
    public string AssetKey { get; set; }              // ObscuredString
}
```

**MstAbilityI18nData** (自動生成)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstAbilityI18nData.cs`

```csharp
public class MstAbilityI18nData
{
    public string Id { get; set; }                    // ObscuredString
    public string MstAbilityId { get; set; }          // ObscuredString
    public Language Language { get; set; }
    public string Description { get; set; }           // ObscuredString
    public string FilterTitle { get; set; }           // ObscuredString
}
```

**MstUnitAbilityData** (自動生成)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstUnitAbilityData.cs`

```csharp
public class MstUnitAbilityData
{
    public string Id { get; set; }                    // ObscuredString
    public string MstAbilityId { get; set; }          // ObscuredString
    public string AbilityParameter1 { get; set; }     // ObscuredString
    public string AbilityParameter2 { get; set; }     // ObscuredString
    public string AbilityParameter3 { get; set; }     // ObscuredString
}
```

### 1.3 ドメインモデルへの変換

**MstAbilityDataModel** (手動生成、データ層の中間モデル)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/ManualGenerated/MstAbilityDataModel.cs`

```csharp
public record MstAbilityDataModel(
    MstUnitAbilityData UnitAbility,
    MstAbilityData Ability,
    MstAbilityI18nData AbilityI18n,
    UnitRank UnlockUnitRank)
```

**UnitAbility** (ValueObject - ドメイン層)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/ValueObjects/UnitAbility.cs`

```csharp
public record UnitAbility(
    UnitAbilityType Type,
    UnitAbilityAssetKey AssetKey,
    UnitAbilityParameter Parameter1,
    UnitAbilityParameter Parameter2,
    UnitAbilityParameter Parameter3,
    ObscuredString Description,         // フォーマット済み説明文
    UnitRank UnlockUnitRank)
```

**MstUnitAbilityModel** (ドメインモデル)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/Models/MasterData/MstUnitAbilityModel.cs`

```csharp
public record MstUnitAbilityModel(MasterDataId Id, UnitAbility UnitAbility)
```

**MstAbilityDescriptionModel** (説明文専用モデル)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/Models/MasterData/MstAbilityDescriptionModel.cs`

```csharp
public record MstAbilityDescriptionModel(
    MasterDataId MstAbilityId,
    UnitAbilityType UnitAbilityType,
    ObscuredString Description,
    AbilityFilterTitle FilterTitle)
```

**UnitAbilityModel** (InGameシーン専用モデル)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Models/UnitAbilityModel.cs`

```csharp
public record UnitAbilityModel(
    UnitAbilityType Type,
    UnitAbilityParameter Parameter1,
    UnitAbilityParameter Parameter2,
    UnitAbilityParameter Parameter3,
    StateEffectSourceId StateEffectSourceId,
    ICommonConditionModel CommonConditionModel)
```

## 2. 読み込みと参照

### 2.1 データ取得フロー

```
MstData (JSON)
  ↓
DataStore.Get<MstAbilityData>()
  ↓
MasterDataRepository
  ↓ (Translator経由)
各種Model
```

### 2.2 リポジトリメソッド

**IMstAbilityDescriptionDataRepository** (インターフェース)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/Definitions/Repositories/MasterData/IMstAbilityDescriptionDataRepository.cs`

```csharp
public interface IMstAbilityDescriptionDataRepository
{
    IReadOnlyList<MstAbilityDescriptionModel> GetAbilityDescriptionModels();
}
```

**MasterDataRepository での実装** (2786行目付近)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Repositories/MasterData/MasterDataRepository.cs`

```csharp
IReadOnlyList<MstAbilityDescriptionModel> IMstAbilityDescriptionDataRepository.GetAbilityDescriptionModels()
{
    return GetOrCreateModelCache(CreateMstAbilityDescriptionModels).ToList();
}

IReadOnlyList<MstAbilityDescriptionModel> CreateMstAbilityDescriptionModels()
{
    var abilityI18NData = DataStore.Get<MstAbilityI18nData>();
    return DataStore.Get<MstAbilityData>()
        .Join(abilityI18NData, ability => ability.Id, i18n => i18n.MstAbilityId, (ability, i18n) => (ability, i18n))
        .Select(dataAndI18n => MstAbilityI18nDataTranslator.Translate(dataAndI18n.ability, dataAndI18n.i18n))
        .ToList();
}
```

### 2.3 Translator (データ層からドメイン層への変換)

**MstAbilityI18nDataTranslator**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Translators/MstAbilityI18nDataTranslator.cs`

```csharp
public static MstAbilityDescriptionModel Translate(MstAbilityData abilityData, MstAbilityI18nData mstAbilityI18NData)
{
    return new MstAbilityDescriptionModel(
        new MasterDataId(abilityData.Id),
        abilityData.AbilityType,
        mstAbilityI18NData.Description,
        new AbilityFilterTitle(mstAbilityI18NData.FilterTitle));
}
```

**MstUnitAbilityModelTranslator**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Translators/MstUnitAbilityModelTranslator.cs`

```csharp
public static MstUnitAbilityModel Translate(
    MstUnitAbilityData mstUnitAbilityData,
    MstAbilityData mstAbilityData,
    MstAbilityI18nData mstAbilityI18nData,
    UnitRank unlockUnitRank)
{
    // プレースホルダー {0}, {1} をパラメータで置換
    var description = ZString.Format(
        mstAbilityI18nData.Description,
        mstUnitAbilityData.AbilityParameter1,
        mstUnitAbilityData.AbilityParameter2);

    var unitAbility = new UnitAbility(
        mstAbilityData.AbilityType,
        new UnitAbilityAssetKey(mstAbilityData.AssetKey),
        new UnitAbilityParameter(mstUnitAbilityData.AbilityParameter1),
        new UnitAbilityParameter(mstUnitAbilityData.AbilityParameter2),
        new UnitAbilityParameter(mstUnitAbilityData.AbilityParameter3),
        description,
        unlockUnitRank);

    return new MstUnitAbilityModel(
        new MasterDataId(mstUnitAbilityData.Id),
        unitAbility);
}
```

### 2.4 キャラクターモデルへの組み込み

**CharacterDataTranslator** (829-860行目付近)
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Translators/CharacterDataTranslator.cs`

```csharp
var abilityDataList = new List<MstAbilityDataModel>()
{
    new(data.unitAbility1, data.ability1, data.abilityI18n1,
        new UnitRank(data.unit.AbilityUnlockRank1)),
    new(data.unitAbility2, data.ability2, data.abilityI18n2,
        new UnitRank(data.unit.AbilityUnlockRank2)),
    new(data.unitAbility3, data.ability3, data.abilityI18n3,
        new UnitRank(data.unit.AbilityUnlockRank3)),
};

// ランクアップ可能な最大ランクと比較して、解放不可能なアビリティはEmptyにする
if (data.unit.HasSpecificRankUp)
{
    var maxRank = GetUnitSpecificRankUpList(id).Max(x => x.Rank);
    abilityDataList = abilityDataList
        .Select(ability => ability.UnlockUnitRank <= maxRank
            ? ability
            : MstAbilityDataModel.Empty)
        .ToList();
}
else
{
    var maxRank = GetUnitRankUpList(data.unit.UnitLabel).Max(x => x.Rank);
    abilityDataList = abilityDataList
        .Select(ability => ability.UnlockUnitRank <= maxRank
            ? ability
            : MstAbilityDataModel.Empty)
        .ToList();
}

// キャラ特性
var abilities = mstAbilityDataList
    .Select(data => MstUnitAbilityModelTranslator.Translate(
        data.UnitAbility,
        data.Ability,
        data.AbilityI18n,
        data.UnlockUnitRank))
    .ToList();
```

## 3. 他テーブルとの関連

### 3.1 テーブルリレーション

```
mst_units
  └─ ability_unlock_rank1, ability_unlock_rank2, ability_unlock_rank3
     ↓
  └─ mst_unit_ability_id1, mst_unit_ability_id2, mst_unit_ability_id3
         ↓
mst_unit_abilities
  └─ mst_ability_id
     ↓
mst_abilities
  ├─ ability_type (UnitAbilityType enum)
  └─ asset_key (アイコン)
     ↓
mst_ability_i18ns
  ├─ description (多言語説明文: {0}, {1} プレースホルダー)
  └─ filter_title (フィルタ表示名)
```

### 3.2 ユニットとの関連

**MstCharacterModel**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/Models/MasterData/MstCharacterModel.cs` (44行目)

```csharp
public record MstCharacterModel(
    // ... 他のフィールド ...
    List<MstUnitAbilityModel> MstUnitAbilityModels,  // アビリティリスト(最大3つ)
    // ... 他のフィールド ...
)
{
    // 指定ランクで新規解放されるアビリティを取得
    public List<UnitAbility> GetNewlyUnlockedUnitAbilities(UnitRank rank)
    {
        return MstUnitAbilityModels
            .Where(model => !model.IsEmpty && rank == model.UnitAbility.UnlockUnitRank)
            .Select(model => model.UnitAbility)
            .ToList();
    }

    // 指定ランクまでに解放されているアビリティを取得
    public List<MstUnitAbilityModel> GetUnlockedMstUnitAbilityModels(UnitRank rank)
    {
        return MstUnitAbilityModels
            .Where(model => !model.IsEmpty && rank >= model.UnitAbility.UnlockUnitRank)
            .ToList();
    }
}
```

### 3.3 ステージ/バトルでの関連

```
MstCharacterModel
  └─ MstUnitAbilityModels (List<MstUnitAbilityModel>)
         ↓ CharacterUnitFactory.GenerateCharacterUnit
CharacterUnitModel
  └─ Abilities (List<UnitAbilityModel>)
         ↓ UnitAbilityProcess.UpdateUnitAbility
StateEffectModel (状態変化効果として適用)
```

## 4. ゲーム内での使用フロー

### 4.1 初期化処理

**キャラクター生成時 (CharacterUnitFactory)**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/ModelFactories/CharacterUnitFactory.cs` (282-285行目)

```csharp
var abilities = mstCharacter.GetUnlockedMstUnitAbilityModels(unitRank)
    .Select(mstAbility => mstAbility.UnitAbility)
    .Select(unitAbility => UnitAbilityModelFactory.Create(unitAbility))
    .ToList();
```

**UnitAbilityModelFactory.Create**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/ModelFactories/UnitAbilityModelFactory.cs`

```csharp
public UnitAbilityModel Create(UnitAbility ability)
{
    var commonConditionModel = CreateCommonConditionModel(ability);

    return new UnitAbilityModel(
        ability.Type,
        ability.Parameter1,
        ability.Parameter2,
        ability.Parameter3,
        StateEffectSourceIdProvider.GenerateNewId(),
        commonConditionModel);
}

ICommonConditionModel CreateCommonConditionModel(UnitAbility ability)
{
    switch (ability.Type)
    {
        case UnitAbilityType.DamageCutByHpPercentageLess:
        case UnitAbilityType.AttackPowerUpByHpPercentageLess:
            return CommonConditionModelFactory.Create(
                InGameCommonConditionType.MyHpLessThanOrEqualPercentage,
                ability.Parameter2.ToCommonConditionValue());

        case UnitAbilityType.DamageCutByHpPercentageOver:
        case UnitAbilityType.AttackPowerUpByHpPercentageOver:
            return CommonConditionModelFactory.Create(
                InGameCommonConditionType.MyHpMoreThanOrEqualPercentage,
                ability.Parameter2.ToCommonConditionValue());

        default:
            return EmptyCommonConditionModel.Instance;
    }
}
```

### 4.2 実行時の更新フロー

**バトル中の特性処理 (UnitAbilityProcess)**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/UpdateProcess/UnitAbilityProcess.cs`

```csharp
public IReadOnlyList<CharacterUnitModel> UpdateUnitAbility(IReadOnlyList<CharacterUnitModel> units)
{
    // キャラ特性による状態変化を付与／解除
    var updatedUnits = new List<CharacterUnitModel>();

    foreach (var unit in units)
    {
        var updatedUnit = UpdateCharacterUnitStateEffects(unit);
        updatedUnits.Add(updatedUnit);
    }

    return updatedUnits;
}

CharacterUnitModel UpdateCharacterUnitStateEffects(CharacterUnitModel unit)
{
    // 特性設定がない場合は何もしない
    if (unit.Abilities.Count <= 0) return unit;

    // 今いるコマとキャラの状態によって発動する状態変化効果をキャラに付与する
    var updatedEffects = GetUpdatedCharacterUnitStateEffects(unit, unit.LocatedKoma);

    return unit with { StateEffects = updatedEffects };
}
```

**状態変化効果への変換 (UnitAbilityModel.GetStateEffect)**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Models/UnitAbilityModel.cs` (91-149行目)

```csharp
public StateEffect GetStateEffect()
{
    return Type switch
    {
        UnitAbilityType.SlipDamageKomaBlock => CreateStateEffect(StateEffectType.SlipDamageKomaBlock),
        UnitAbilityType.AttackPowerUpInNormalKoma => CreateStateEffect(StateEffectType.AttackPowerUpInNormalKoma, Parameter1),
        UnitAbilityType.Guts => CreateStateEffect(
            StateEffectType.Guts,
            Parameter1.ToEffectiveCount(),
            Parameter2.ToEffectiveProbability(),
            TickCount.Infinity,
            StateEffectParameter.Empty,
            StateEffectConditionValue.Empty,
            StateEffectConditionValue.Empty),
        // ... 他のケース ...
        _ => StateEffect.Empty
    };
}
```

### 4.3 プレゼンテーション層での利用

**ユニット強化ランクアップ確認ダイアログ**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/UnitEnhanceRankUpConfirmDialog/Domain/UseCases/GetUnitEnhanceRankUpConfirmModelUseCase.cs` (47行目)

```csharp
var newlyUnlockedUnitAbilities = mstUnit.GetNewlyUnlockedUnitAbilities(afterStatusRank);
```

**ユニットソート・フィルタダイアログ**
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/UnitSortAndFilterDialog/Domain/UseCases/GetUnitSortAndFilterUseCase.cs` (20行目)

```csharp
var mstAbilityDescriptionModels = MstAbilityDescriptionDataRepository.GetAbilityDescriptionModels();
```

- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/UnitSortAndFilterDialog/Presentation/Translators/UnitSortAndFilterDialogViewModelTranslator.cs` (25-26行目)

```csharp
var abilityFilterTitleModels = useCaseModel.MstAbilityDescriptionModels.Select(model =>
    new UnitAbilityFilterTitleModel(model.UnitAbilityType, model.FilterTitle)).ToList();
```

## 5. 各列の具体的な使われ方

### 5.1 mst_abilities テーブル

**id列**
- 用途: アビリティの一意識別子
- 参照タイミング: mst_unit_abilitiesテーブルとのJOIN時
- 例: `ability_gust_koma_block`, `ability_slip_damage_koma_block`

**ability_type列 (UnitAbilityType enum)**
- 用途: アビリティの種類を定義
- 参照タイミング:
  - `UnitAbilityModel.GetStateEffect()` で状態変化効果への変換時
  - `UnitAbilityModel.ArisesStateEffectIn()` でコマ判定時
- 列挙値: (32種類)
  - `None`, `SlipDamageKomaBlock`, `AttackPowerUpInNormalKoma`, `GustKomaBlock`
  - `KnockBackBlock`, `Guts`, `StunBlock`, `FreezeBlock`
  - `AttackPowerUpByHpPercentageOver`, `DamageCutByHpPercentageLess` など
- ファイル: `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/Constants/AutoGenerated/UnitAbilityType.cs`

**asset_key列**
- 用途: アイコン画像のアセットキー
- 変換: `UnitAbilityIconAssetPath.FromAssetKey(AssetKey)` でパスに変換
- 例: `damage_koma_block`, `gust_koma_block`, `knockback_block`

### 5.2 mst_ability_i18ns テーブル

**description列**
- 用途: 多言語対応の説明文 (プレースホルダー付き)
- フォーマットタイミング: `MstUnitAbilityModelTranslator.Translate()` で `ZString.Format()` 使用
- プレースホルダー: `{0}`, `{1}` が `ability_parameter1`, `ability_parameter2` で置換される
- 例:
  - `"通常コマ時にいる間、攻撃が{0}％アップ"` → `"通常コマ時にいる間、攻撃が20％アップ"`
  - `"最大HP{1}%以上時攻撃力{0}%アップ"` → `"最大HP50%以上時攻撃力30%アップ"`

**filter_title列**
- 用途: ユニットフィルタ画面でのアビリティ名表示
- 参照タイミング: `UnitSortAndFilterDialogViewModelTranslator` でフィルタリスト作成時
- 例: `"ダメージコマ無効化"`, `"通常コマ時攻撃UP"`, `"根性"`

### 5.3 mst_unit_abilities テーブル

**ability_parameter1, 2, 3列**
- 用途: アビリティの数値パラメータ
- 型: 文字列 (実行時に `int.Parse()` で数値変換)
- 変換メソッド: `UnitAbilityParameter` が提供
  - `ToStateEffectParameter()`: 状態変化効果のパラメータ
  - `ToPercentage()`: パーセント値
  - `ToEffectiveCount()`: 発動回数
  - `ToEffectiveProbability()`: 発動確率
  - `ToStateEffectConditionValue()`: 状態変化条件値
  - `ToCommonConditionValue()`: 汎用条件値

**parameter1の用途例:**
- 攻撃力UP系: アップ率 (例: `20` → 20%UP)
- ダメージ軽減系: 軽減率 (例: `50` → 50%軽減)
- 根性: 発動回数 (例: `1` → 1回耐える)
- スタン無効化: 無効化確率 (例: `50` → 50%確率)

**parameter2の用途例:**
- HP条件系アビリティ: HP閾値パーセンテージ (例: `50` → 最大HPの50%)
- 根性: 発動確率 (例: `100` → 100%発動)
- スタン/氷結無効化: 条件値 (例: `All` → すべての状況)

**parameter3の用途例:**
- スタン/氷結無効化: 追加条件値

## 6. 実例

### 6.1 マスターデータ例

**ability_gust_koma_block (突風コマ無効化)**
```csv
# MstAbility.csv
ability_gust_koma_block,GustKomaBlock,gust_koma_block

# MstAbilityI18n.csv
ability_gust_koma_block_ja,ability_gust_koma_block,ja,突風コマ効果を無効化,突風コマ無効化

# MstUnitAbility.csv
ability_glo_00001,ability_gust_koma_block,20,0,0
```

**ability_StunBlock (スタン無効化)**
```csv
# MstAbility.csv
ability_StunBlock,StunBlock,stun_block

# MstAbilityI18n.csv
ability_StunBlock_ja,ability_StunBlock,ja,{0}%の確率でスタンを無効化,スタン攻撃無効化

# MstUnitAbility.csv
ability_kai_00002_01,ability_StunBlock,50,All,All  → "50%の確率でスタンを無効化"
ability_StunBlock_100,ability_StunBlock,100,All,All → "100%の確率でスタンを無効化"
```

**ability_attack_power_up_by_hp_percentage_over (HP条件攻撃UP)**
```csv
# MstAbility.csv
ability_attack_power_up_by_hp_percentage_over,AttackPowerUpByHpPercentageOver,conditional_attack_up

# MstAbilityI18n.csv
ability_attack_power_up_by_hp_percentage_over_ja,ability_attack_power_up_by_hp_percentage_over,ja,最大HP{1}%以上時攻撃力{0}%アップ,HP条件強化(以上/攻撃)

# 使用例 (仮想):
unit_ability_001,ability_attack_power_up_by_hp_percentage_over,30,50,0
  → "最大HP50%以上時攻撃力30%アップ"
```

### 6.2 コード実行例

**CharacterUnitModel生成時のアビリティ設定**
```
ファイル: /Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/ModelFactories/CharacterUnitFactory.cs:282-285

コードフロー:
1. MstCharacterModel.GetUnlockedMstUnitAbilityModels(unitRank)
   → ランクに応じた解放済みアビリティを取得
2. .Select(mstAbility => mstAbility.UnitAbility)
   → UnitAbility (ValueObject) に変換
3. .Select(unitAbility => UnitAbilityModelFactory.Create(unitAbility))
   → UnitAbilityModel (InGameドメインモデル) に変換
4. CharacterUnitModel の Abilities フィールドに設定
```

**バトル中のアビリティ発動**
```
ファイル: /Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/UpdateProcess/UnitAbilityProcess.cs:14-81

コードフロー:
1. 各フレームで UpdateUnitAbility() が呼ばれる
2. ユニットごとに UpdateCharacterUnitStateEffects() を実行
3. GetUpdatedCharacterUnitStateEffects() で発動条件をチェック
   - コマ位置判定: ability.ArisesStateEffectIn(currentLocatedKoma)
   - HP条件判定: ability.ArisesStateEffectConditionAchieved(context)
4. 発動するアビリティの StateEffect を生成
   - ability.GetStateEffect() で UnitAbilityType に応じた StateEffect 変換
5. StateEffectModel として CharacterUnitModel.StateEffects に追加
```

**ランクアップ時の新規解放アビリティ表示**
```
ファイル: /Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/UnitEnhanceRankUpConfirmDialog/Domain/UseCases/GetUnitEnhanceRankUpConfirmModelUseCase.cs:47

var newlyUnlockedUnitAbilities = mstUnit.GetNewlyUnlockedUnitAbilities(afterStatusRank);

実行例:
- ユニットがランク3 → ランク5にアップする場合
- AbilityUnlockRank1=1, AbilityUnlockRank2=3, AbilityUnlockRank3=5
- ランク5で GetNewlyUnlockedUnitAbilities(5) を呼ぶと
  → Ability3 (UnlockUnitRank=5) のみ返される
```

**フィルタ画面でのアビリティ一覧表示**
```
ファイル: /Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/UnitSortAndFilterDialog/Presentation/Translators/UnitSortAndFilterDialogViewModelTranslator.cs:25-26

var abilityFilterTitleModels = useCaseModel.MstAbilityDescriptionModels
    .Select(model => new UnitAbilityFilterTitleModel(model.UnitAbilityType, model.FilterTitle))
    .ToList();

実行結果:
- "ダメージコマ無効化"
- "通常コマ時攻撃UP"
- "突風コマ無効化"
- "根性"
- ... などのフィルタ項目リスト
```

## 7. データフロー図

### 7.1 データ読み込みフロー

```
【サーバーからのマスターデータ取得】
Server (JSON)
  ↓
MstData.MstAbility[] (配列)
  ↓
DataStore.Get<MstAbilityData>()
  ↓
MasterDataRepository
  ├─ CreateMstAbilityDescriptionModels()
  │    ↓ (Join + Translate)
  │  MstAbilityDescriptionModel (フィルタ用)
  │
  └─ CreateMstCharacterModels()
       ↓ (複雑なJOIN: unit, unitAbility1-3, ability1-3, abilityI18n1-3)
     MstAbilityDataModel (中間モデル)
       ↓ MstUnitAbilityModelTranslator.Translate()
     MstUnitAbilityModel
       ↓
     MstCharacterModel.MstUnitAbilityModels
```

### 7.2 バトル実行フロー

```
【キャラクター生成】
MstCharacterModel
  ↓ CharacterUnitFactory.GenerateCharacterUnit()
  ├─ GetUnlockedMstUnitAbilityModels(unitRank)
  ↓
UnitAbility (ValueObject)
  ↓ UnitAbilityModelFactory.Create()
UnitAbilityModel (InGame専用モデル)
  ↓
CharacterUnitModel.Abilities

【バトル中の処理】
UpdateBattleUseCase (毎フレーム)
  ↓
UnitAbilityProcess.UpdateUnitAbility()
  ↓
UnitAbilityModel.ArisesStateEffectIn(koma)  ← コマ位置判定
UnitAbilityModel.ArisesStateEffectConditionAchieved(context)  ← HP条件判定
  ↓ (条件満たす場合)
UnitAbilityModel.GetStateEffect()
  ↓ (UnitAbilityType → StateEffectType 変換)
StateEffect
  ↓ StateEffectModelFactory.Create()
StateEffectModel
  ↓
CharacterUnitModel.StateEffects (状態変化効果として適用)
  ↓
AttackPowerCalculator、DamageCalculator などで効果反映
```

### 7.3 UI表示フロー

```
【ランクアップ確認画面】
UserUnitModel + MstCharacterModel
  ↓
MstCharacterModel.GetNewlyUnlockedUnitAbilities(afterRank)
  ↓
List<UnitAbility>
  ↓
ViewModel (Description フィールドを表示)

【フィルタ画面】
MstAbilityDescriptionDataRepository.GetAbilityDescriptionModels()
  ↓
List<MstAbilityDescriptionModel>
  ↓ UnitSortAndFilterDialogViewModelTranslator
List<UnitAbilityFilterTitleModel>
  ↓
View (FilterTitle を表示)
```

---

## まとめ

**mst_abilitiesテーブルの主な役割:**
1. **アビリティ定義の管理**: 種類 (ability_type) とアセット (asset_key) の定義
2. **多言語対応**: mst_ability_i18ns テーブルで説明文とフィルタ名の多言語化
3. **ユニットへの紐付け**: mst_unit_abilities テーブルでパラメータ付きでユニットに設定
4. **バトルシステムとの連携**: UnitAbilityType に応じた StateEffect 変換
5. **UI表示**: フィルタ、ランクアップ確認、図鑑などでの表示

**特徴的な実装パターン:**
- **チート対策**: すべての文字列・数値が `ObscuredString` で保護
- **Translator パターン**: データ層とドメイン層の変換を責務分離
- **Record型**: イミュータブルなモデル設計
- **Empty パターン**: 各Modelに `Empty` 静的インスタンスを用意
- **プレースホルダー**: 説明文の `{0}`, `{1}` をパラメータで動的置換
