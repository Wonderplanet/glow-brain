# mst_attack_elements テーブルドキュメント

## 概要

`mst_attack_elements` テーブルは、GLOWゲーム内のキャラクターやユニットの攻撃パラメータの詳細な要素を定義するマスターデータテーブルです。1つの攻撃(mst_attack)は複数の攻撃要素(mst_attack_elements)を持つことができ、各要素が攻撃の具体的な挙動（範囲、ターゲット、ダメージ計算、エフェクトなど）を定義します。

---

## 1. データ構造

### 1.1 テーブル定義

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstAttackElementData.cs`

```csharp
public class MstAttackElementData
{
    public string Id { get; set; }                    // 攻撃要素の一意なID
    public string MstAttackId { get; set; }           // 親となるmst_attackのID
    public int SortOrder { get; set; }                // 同一攻撃内での実行順序

    // 攻撃タイプと対象
    public AttackType AttackType { get; set; }        // 攻撃タイプ（Direct, None等）
    public AttackTarget Target { get; set; }          // 攻撃対象（味方/敵）
    public AttackTargetType TargetType { get; set; }  // ターゲットタイプ（All, Random等）

    // ターゲットフィルター
    public string TargetColors { get; set; }          // 対象色のリスト（カンマ区切り）
    public string TargetRoles { get; set; }           // 対象ロールのリスト（カンマ区切り）
    public string TargetMstSeriesId { get; set; }     // 対象シリーズIDのリスト
    public string TargetMstUnitIds { get; set; }      // 対象ユニットIDのリスト

    // 攻撃範囲
    public AttackRangePointType RangeStartType { get; set; }  // 範囲開始点のタイプ
    public float RangeStartParameter { get; set; }            // 範囲開始パラメータ
    public AttackRangePointType RangeEndType { get; set; }    // 範囲終了点のタイプ
    public float RangeEndParameter { get; set; }              // 範囲終了パラメータ
    public int MaxTargetCount { get; set; }                   // 最大ターゲット数（-1で無制限）

    // ダメージとヒット
    public AttackDamageType DamageType { get; set; }  // ダメージタイプ
    public AttackHitType HitType { get; set; }        // ヒットタイプ
    public int HitParameter1 { get; set; }            // ヒットパラメータ1
    public int HitParameter2 { get; set; }            // ヒットパラメータ2
    public string HitEffectId { get; set; }           // ヒットエフェクトID（mst_attack_hit_effectへの参照）
    public bool IsHitStop { get; set; }               // ヒットストップの有無

    // 攻撃力
    public int Probability { get; set; }                      // 発動確率（%）
    public AttackPowerParameterType PowerParameterType { get; set; }  // 攻撃力パラメータタイプ
    public int PowerParameter { get; set; }                   // 攻撃力パラメータ値

    // ステートエフェクト（状態異常等）
    public StateEffectType EffectType { get; set; }   // エフェクトタイプ
    public int EffectiveCount { get; set; }           // 効果回数（-1で無限）
    public int EffectiveDuration { get; set; }        // 効果持続時間（-1で無限）
    public float EffectParameter { get; set; }        // エフェクトパラメータ

    // タイミング
    public int AttackDelay { get; set; }              // 攻撃発生までの遅延（tick数）
}
```

**特徴**:
- 全ての重要な値フィールドは `ObscuredXxx` 型でラップされ、チート対策が施されている
- 自動生成ファイルのため、直接編集は禁止

### 1.2 ドメインモデル（AttackElement）

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/ValueObjects/InGame/AttackElement.cs`

```csharp
public record AttackElement(
    MasterDataId Id,
    TickCount AttackDelay,              // 攻撃が発生するまでの時間
    TickCount HitDelay,                 // 攻撃が発生してからヒット判定がされるまでの時間
    AttackType AttackType,
    AttackRange AttackRange,
    FieldObjectCount MaxTargetCount,
    AttackViewId AttackViewId,
    AttackTarget AttackTarget,
    AttackTargetType AttackTargetType,
    IReadOnlyList<CharacterColor> TargetColors,
    IReadOnlyList<CharacterUnitRoleType> TargetRoles,
    IReadOnlyList<MasterDataId> TargetSeriesIds,
    IReadOnlyList<MasterDataId> TargetCharacterIds,
    AttackDamageType AttackDamageType,
    AttackHitData AttackHitData,
    AttackHitStopFlag IsHitStop,
    Percentage Probability,
    AttackPowerParameter PowerParameter,
    StateEffect StateEffect,
    IReadOnlyList<AttackSubElement> SubElements)
{
    public static AttackElement Empty { get; }
    public bool IsEmpty() => ReferenceEquals(this, Empty);
}
```

**特徴**:
- C#の `record` 型を使用した不変（Immutable）なデータ構造
- プリミティブ型ではなく、型安全なValue Objectを使用（`TickCount`, `Percentage` 等）
- 文字列のリストは具体的な型のコレクション（`IReadOnlyList<CharacterColor>`）に変換される
- `SubElements` を持ち、複雑な攻撃パターンをサポート

### 1.3 サブ要素（AttackSubElement）

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Domain/ValueObjects/InGame/AttackSubElement.cs`

```csharp
public record AttackSubElement(
    MasterDataId Id,
    AttackTargetType AttackTargetType,
    IReadOnlyList<CharacterColor> TargetColors,
    IReadOnlyList<CharacterUnitRoleType> TargetRoles,
    IReadOnlyList<MasterDataId> TargetSeriesIds,
    IReadOnlyList<MasterDataId> TargetCharacterIds,
    AttackDamageType AttackDamageType,
    AttackHitData AttackHitData,
    Percentage Probability,
    AttackPowerParameter PowerParameter,
    StateEffect StateEffect)
```

**用途**:
- `AttackType.None` の攻撃要素は、直前の攻撃要素の `SubElement` として扱われる
- 複数のターゲットに異なるダメージや効果を与える複雑な攻撃を実現

---

## 2. 読み込みと参照

### 2.1 データ取得フロー

```
MasterDataRepository.GetMstAttackModel()
  ↓
CreateAttackData() (private)
  ↓
DataStore.Get<MstAttackElementData>()
  .Where(d => d.MstAttackId == attackData.Id)
  ↓
AttackDataTranslator.ToAttackData()
  ↓
AttackElementDataTranslator.ToAttackElement()
  ↓
AttackElement (ドメインモデル)
```

### 2.2 リポジトリでの読み込み

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Repositories/MasterData/MasterDataRepository.cs:1460-1470`

```csharp
AttackData CreateAttackData(MstAttackData attackData)
{
    // 指定されたmst_attackに紐づく全ての攻撃要素を取得
    var elements = DataStore.Get<MstAttackElementData>()
        .Where(d => d.MstAttackId == attackData.Id)
        .ToList();

    var attackHitEffectDataList = DataStore.Get<MstAttackHitEffectData>()
        .ToList();

    return AttackDataTranslator.ToAttackData(attackData, elements, attackHitEffectDataList);
}
```

### 2.3 Translatorによる変換

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Translators/AttackDataTranslator.cs:31-91`

```csharp
static IReadOnlyList<AttackElement> ToAttackElements(
    IReadOnlyList<MstAttackElementData> mstElements,
    IReadOnlyList<MstAttackHitEffectData> mstAttackHitEffectDataList)
{
    var elements = new List<AttackElement>();
    if (mstElements.Count == 0) return elements;

    // SortOrderでソート
    var sortedMstElements = mstElements.OrderBy(mstElement => mstElement.SortOrder);

    var subElements = new List<AttackSubElement>();
    MstAttackElementData lastNonSubMstElementData = null;

    foreach (var mstElement in sortedMstElements)
    {
        // AttackType.None の場合はサブ要素として扱う
        if (mstElement.AttackType == AttackType.None)
        {
            var hitEffectData = mstAttackHitEffectDataList
                .FirstOrDefault(data => data.Id == mstElement.HitEffectId);
            var subElement = AttackElementDataTranslator.ToAttackSubElement(mstElement, hitEffectData);
            subElements.Add(subElement);
            continue;
        }

        // 前の要素があれば、SubElementsをまとめて変換
        if (lastNonSubMstElementData != null)
        {
            var mstAttackHitEffectData = mstAttackHitEffectDataList
                .FirstOrDefault(data => data.Id == lastNonSubMstElementData.HitEffectId);
            var element = AttackElementDataTranslator.ToAttackElement(
                lastNonSubMstElementData,
                subElements,
                mstAttackHitEffectData);
            elements.Add(element);
            subElements = new List<AttackSubElement>();
        }

        lastNonSubMstElementData = mstElement;
    }

    // 最後の要素を処理
    if (lastNonSubMstElementData != null)
    {
        var hitEffectData = mstAttackHitEffectDataList
            .FirstOrDefault(data => data.Id == lastNonSubMstElementData.HitEffectId);
        var element = AttackElementDataTranslator.ToAttackElement(
            lastNonSubMstElementData,
            subElements,
            hitEffectData);
        elements.Add(element);
    }

    return elements;
}
```

**変換のポイント**:
1. `SortOrder` でソートして順番を保証
2. `AttackType.None` の要素は `SubElement` として扱う
3. SubElementは直前のメイン要素にまとめられる
4. 文字列リスト → 型付きリスト への変換（`EnumListTranslator`, `MasterDataIdListTranslator`）
5. `-1` の値は `Infinity` に変換（`MaxTargetCount`, `EffectiveCount`, `EffectiveDuration`）

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Translators/AttackElementDataTranslator.cs:15-64`

```csharp
public static AttackElement ToAttackElement(
    MstAttackElementData data,
    IReadOnlyList<AttackSubElement> subElements,
    MstAttackHitEffectData mstAttackHitEffectData)
{
    var hitData = CreateAttackHitData(data, mstAttackHitEffectData);

    var effect = data.EffectType == StateEffectType.None
        ? StateEffect.Empty
        : new StateEffect(
            data.EffectType,
            data.EffectiveCount < 0
                ? EffectiveCount.Infinity
                : new EffectiveCount(data.EffectiveCount),
            EffectiveProbability.Hundred,
            data.EffectiveDuration < 0
                ? TickCount.Infinity
                : new TickCount(data.EffectiveDuration),
            new StateEffectParameter((decimal)data.EffectParameter),
            StateEffectConditionValue.Empty,
            StateEffectConditionValue.Empty);

    return new AttackElement(
        new MasterDataId(data.Id),
        new TickCount(data.AttackDelay),
        TickCount.Empty,
        data.AttackType,
        new AttackRange(
            data.RangeStartType,
            new AttackRangeParameter(data.RangeStartParameter),
            data.RangeEndType,
            new AttackRangeParameter(data.RangeEndParameter)),
        data.MaxTargetCount < 0
            ? FieldObjectCount.Infinity
            : new FieldObjectCount(data.MaxTargetCount),
        AttackViewId.Empty,
        data.Target,
        data.TargetType,
        EnumListTranslator.ToEnumList<CharacterColor>(data.TargetColors),
        EnumListTranslator.ToEnumList<CharacterUnitRoleType>(data.TargetRoles),
        MasterDataIdListTranslator.ToMasterDataIdList(data.TargetMstSeriesId),
        MasterDataIdListTranslator.ToMasterDataIdList(data.TargetMstUnitIds),
        data.DamageType,
        hitData,
        new AttackHitStopFlag(data.IsHitStop),
        new Percentage(data.Probability),
        new AttackPowerParameter(data.PowerParameterType, data.PowerParameter),
        effect,
        subElements);
}
```

---

## 3. 他テーブルとの関連

### 3.1 テーブルリレーション図

```
mst_unit
  ↓ (MstUnitId, AttackKind)
mst_attack
  ├─ id (攻撃ID)
  ├─ mstUnitId (ユニットID)
  ├─ unitGrade (グレード)
  ├─ attackKind (通常攻撃/特殊攻撃)
  └─ その他攻撃基本パラメータ
      ↓ (MstAttackId)
  mst_attack_elements ★このテーブル
      ├─ id (要素ID)
      ├─ mstAttackId (親攻撃ID)
      ├─ sortOrder (実行順序)
      ├─ hitEffectId → mst_attack_hit_effect
      └─ 攻撃要素詳細パラメータ
          ↓ (MstAttackElementId)
      mst_special_role_level_up_attack_element
          └─ レベルアップ時のパラメータ範囲定義
```

### 3.2 関連マスターデータテーブル

#### 3.2.1 親テーブル: mst_attack

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstAttackData.cs`

```csharp
public class MstAttackData
{
    public string Id { get; set; }                // 攻撃ID
    public string MstUnitId { get; set; }         // ユニットID
    public int UnitGrade { get; set; }            // ユニットグレード
    public AttackKind AttackKind { get; set; }    // 攻撃種別（Normal/Special）
    public string KillerColors { get; set; }      // キラーカラー
    public int KillerPercentage { get; set; }     // キラーダメージ倍率
    public int ActionFrames { get; set; }         // アクションフレーム数
    public int AttackDelay { get; set; }          // 攻撃遅延
    public int NextAttackInterval { get; set; }   // 次攻撃までの間隔
}
```

**関連**:
- `MstAttackElementData.MstAttackId` → `MstAttackData.Id`
- 1つの攻撃は複数の攻撃要素を持つ（1対多）

#### 3.2.2 参照テーブル: mst_attack_hit_effect

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstAttackHitEffectData.cs`

```csharp
public class MstAttackHitEffectData
{
    public string Id { get; set; }                        // エフェクトID
    public string Onomatopoeia1AssetKey { get; set; }     // オノマトペ1アセットキー
    public string Onomatopoeia2AssetKey { get; set; }     // オノマトペ2アセットキー
    public string Onomatopoeia3AssetKey { get; set; }     // オノマトペ3アセットキー
    public string SoundEffectAssetKey { get; set; }       // 効果音アセットキー
    public string KillerSoundEffectAssetKey { get; set; } // キラー時効果音アセットキー
}
```

**関連**:
- `MstAttackElementData.HitEffectId` → `MstAttackHitEffectData.Id`
- ヒット時の演出（オノマトペ、効果音）を定義

#### 3.2.3 拡張テーブル: mst_special_role_level_up_attack_element

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/MstSpecialRoleLevelUpAttackElementData.cs`

```csharp
public class MstSpecialRoleLevelUpAttackElementData
{
    public string Id { get; set; }                   // ID
    public string MstAttackElementId { get; set; }   // 攻撃要素ID
    public float MinPowerParameter { get; set; }     // 最小攻撃力パラメータ
    public float MaxPowerParameter { get; set; }     // 最大攻撃力パラメータ
    public int MinEffectiveCount { get; set; }       // 最小効果回数
    public int MaxEffectiveCount { get; set; }       // 最大効果回数
    public int MinEffectiveDuration { get; set; }    // 最小効果持続時間
    public int MaxEffectiveDuration { get; set; }    // 最大効果持続時間
    public decimal MinEffectParameter { get; set; }  // 最小エフェクトパラメータ
    public decimal MaxEffectParameter { get; set; }  // 最大エフェクトパラメータ
}
```

**関連**:
- `MstSpecialRoleLevelUpAttackElementData.MstAttackElementId` → `MstAttackElementData.Id`
- 特殊ロール（特殊キャラ）のレベルアップ時のパラメータ変動範囲を定義

### 3.3 データフロー全体像

```
ゲーム起動
  ↓
マスターデータ読み込み (DataStore)
  ↓
MasterDataRepository
  ├─ GetMstAttackModel(mstUnitId, attackKind)
  │   ↓
  │  mst_attack から該当データ取得
  │   ↓
  │  CreateAttackData()
  │   ↓
  │  mst_attack_elements を MstAttackId で絞り込み取得
  │   ↓
  │  AttackDataTranslator.ToAttackData()
  │   └─ SortOrderでソート
  │      └─ AttackElementDataTranslator.ToAttackElement()
  │          ├─ mst_attack_hit_effect 参照（HitEffectId）
  │          └─ SubElements を結合
  │
  └─ MstAttackModel (AttackData を含む)
      ↓
InGame バトル処理
  ↓
AttackModelFactory.Create()
  ├─ AttackElement を元に攻撃モデル生成
  │   └─ AttackType に応じて
  │       ├─ RangeAttackModel (Direct攻撃)
  │       ├─ PlaceItemAttackModel (設置系)
  │       └─ DeckAttackModel (デッキ攻撃)
  │
  └─ IAttackModel
      ↓
UpdateBattleUseCase / AttackProcess
  ↓
攻撃実行・ダメージ計算
  ↓
AttackResultModel 生成
  ↓
View更新 (FieldUnitView, PlacedItemView)
```

---

## 4. ゲーム内での使用フロー

### 4.1 初期化フロー

```
アプリ起動
  ↓
MasterDataRepository 初期化
  ↓
DataStore に全マスターデータ読み込み
  ├─ MstAttackData
  ├─ MstAttackElementData
  ├─ MstAttackHitEffectData
  └─ MstSpecialRoleLevelUpAttackElementData
```

### 4.2 バトル開始時のフロー

```
InGame シーン開始
  ↓
ユニット初期化 (CharacterUnitModel)
  ↓
MasterDataRepository.GetMstAttackModel(mstUnitId, AttackKind.Normal)
  ↓
AttackData (複数の AttackElement を含む) 取得
  ↓
CharacterUnitModel に保持
```

### 4.3 攻撃実行フロー

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/CharacterUnitAction/CharacterUnitAttackAction.cs`

```
CharacterUnitUpdateProcess
  ↓
CharacterUnitAttackAction.GetNextAction()
  ↓
攻撃判定
  ↓
AttackModelFactory.Create(
    fieldObjectId,
    attackerCharacterId,
    ...
    attackElement,  ★ AttackElement を使用
    ...)
  ↓
IAttackModel 生成
  ├─ RangeAttackModel (AttackType.Direct)
  ├─ PlaceItemAttackModel (AttackType.PlaceItem)
  └─ DeckAttackModel (AttackType.Deck)
  ↓
AttackProcess に渡される
  ↓
UpdateBattleUseCase
  ↓
IAttackModel.UpdateAttackModel()
  ├─ 遅延処理 (RemainingDelay)
  ├─ ターゲット選択 (AttackTargetSelector)
  │   └─ AttackElement.AttackRange でフィルタ
  │       AttackElement.TargetType でソート
  │       AttackElement.MaxTargetCount で制限
  │       AttackElement.TargetColors / TargetRoles で絞り込み
  ├─ 確率判定 (AttackElement.Probability)
  └─ AttackResultModel 生成
      ├─ ダメージ計算 (AttackElement.PowerParameter)
      ├─ ヒット処理 (AttackElement.AttackHitData)
      └─ 状態異常付与 (AttackElement.StateEffect)
```

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Models/AttackModel/RangeAttackModel.cs:38-80`

```csharp
public (IAttackModel, IReadOnlyList<IAttackResultModel>) UpdateAttackModel(AttackModelContext context)
{
    RangeAttackModel updatedAttack;
    IReadOnlyList<IAttackResultModel> attackResults = Array.Empty<IAttackResultModel>();

    if (!RemainingDelay.IsEmpty())
    {
        var remainingDelay = RemainingDelay - context.TickCount;

        if (remainingDelay.IsZero())
        {
            updatedAttack = this with { RemainingDelay = remainingDelay, IsEnd = true };
            attackResults = GetAttackResults(context);  // ★ 攻撃実行
        }
        else
        {
            updatedAttack = this with { RemainingDelay = remainingDelay, IsEnd = false };
        }
    }
    else
    {
        updatedAttack = this with { IsEnd = true };
        attackResults = GetAttackResults(context);
    }

    return (updatedAttack, attackResults);
}

IReadOnlyList<IAttackResultModel> GetAttackResults(AttackModelContext context)
{
    // ターゲット選択 (AttackElement の情報を使用)
    IReadOnlyList<IAttackTargetModel> targets = AttackTargetSelector.GetTargetsInRange(
        context.AttackTargetCandidates,
        TargetSelectionData,
        context.CoordinateConverter);

    if (targets.Count == 0) return Array.Empty<IAttackResultModel>();

    // 確率判定とダメージ計算
    var attackResults = targets
        .Where(_ => context.RandomProvider.Trial(AttackElement.Probability))  // ★ 確率判定
        .Select(target => context.AttackResultModelFactory.CreateHitAttackResult(
            this,
            AttackElement,  // ★ AttackElement を渡す
            target.Id))
        .ToList();

    return attackResults;
}
```

### 4.4 プレゼンテーション層での利用

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Presentation/Field/FieldUnitView.cs`

```
AttackResultModel
  ↓
FieldUnitView.OnDamaged()
  ├─ ダメージ演出
  ├─ ヒットエフェクト表示 (AttackHitData.OnomatopoeiaAssetKeys)
  ├─ 効果音再生 (AttackHitData.SoundEffectAssetKey)
  └─ ヒットストップ (AttackElement.IsHitStop)
```

---

## 5. 各列の具体的な使われ方

### 5.1 攻撃タイミング関連

#### AttackDelay
- **型**: `int` → `TickCount`
- **意味**: 攻撃アクションが開始してから実際に攻撃判定が発生するまでの遅延時間（フレーム数）
- **使用箇所**:
  - `AttackModelFactory` で `RemainingDelay` として設定
  - `RangeAttackModel.UpdateAttackModel()` で毎フレーム減算
- **特殊な値**: `0` の場合は即座に攻撃発生

### 5.2 攻撃範囲関連

#### RangeStartType / RangeStartParameter / RangeEndType / RangeEndParameter
- **型**: `AttackRangePointType`, `float`
- **意味**: 攻撃範囲の開始点と終了点を定義
- **使用箇所**:
  - `AttackElementDataTranslator` で `AttackRange` に変換
  - `AttackTargetSelector.GetTargetsInRange()` でターゲット選択時に使用
- **例**:
  - 開始点: `SelfPosition`, パラメータ: `0.0`
  - 終了点: `ForwardDistance`, パラメータ: `5.0`
  - → 自分から前方5.0の範囲内のターゲット

#### MaxTargetCount
- **型**: `int` → `FieldObjectCount`
- **意味**: この攻撃要素で同時に攻撃できる最大ターゲット数
- **特殊な値**: `-1` → `FieldObjectCount.Infinity` (無制限)
- **使用箇所**: `AttackTargetSelector` でターゲット数を制限

### 5.3 ターゲットフィルター関連

#### TargetColors
- **型**: `string` → `IReadOnlyList<CharacterColor>`
- **意味**: 攻撃対象とする色のリスト（カンマ区切り）
- **変換**: `EnumListTranslator.ToEnumList<CharacterColor>()`
- **使用箇所**: `AttackTargetSelector` でターゲットをフィルタ
- **例**: `"Red,Blue"` → `[CharacterColor.Red, CharacterColor.Blue]`

#### TargetRoles
- **型**: `string` → `IReadOnlyList<CharacterUnitRoleType>`
- **意味**: 攻撃対象とするロールのリスト
- **例**: `"Tank,Healer"` → タンクとヒーラーのみをターゲット

#### TargetMstSeriesId / TargetMstUnitIds
- **型**: `string` → `IReadOnlyList<MasterDataId>`
- **意味**: 特定のシリーズまたはユニットのみをターゲットとする
- **使用箇所**: `AttackTargetSelector` で特定キャラクターをフィルタ

### 5.4 ダメージ計算関連

#### PowerParameterType
- **型**: `AttackPowerParameterType` (enum)
- **値**: `Percentage` (割合), `FixedValue` (固定値) など
- **意味**: 攻撃力パラメータの解釈方法

#### PowerParameter
- **型**: `int`
- **意味**: 攻撃力の値（PowerParameterType に応じて解釈が変わる）
- **使用箇所**:
  - `AttackPowerParameter` に変換
  - `AttackResultModelFactory.CreateHitAttackResult()` でダメージ計算に使用
- **例**:
  - `PowerParameterType.Percentage`, `PowerParameter = 120` → 基礎攻撃力の120%
  - `PowerParameterType.FixedValue`, `PowerParameter = 500` → 固定500ダメージ

#### DamageType
- **型**: `AttackDamageType` (enum)
- **値**: `Physical` (物理), `Magical` (魔法), `None` (ダメージなし) など
- **使用箇所**: ダメージ計算時の属性判定、耐性計算

### 5.5 ヒット処理関連

#### HitType / HitParameter1 / HitParameter2
- **型**: `AttackHitType`, `int`, `int`
- **意味**: ヒット時の挙動を定義
- **使用箇所**:
  - `AttackHitData` に変換
  - ノックバック距離、吹き飛ばし方向などの計算に使用

#### HitEffectId
- **型**: `string` → `MstAttackHitEffectData` 参照
- **意味**: ヒット時のエフェクトID
- **使用箇所**:
  - `AttackElementDataTranslator.CreateAttackHitData()` で `mst_attack_hit_effect` を参照
  - オノマトペ、効果音のアセットキーを取得

#### IsHitStop
- **型**: `bool` → `AttackHitStopFlag`
- **意味**: ヒット時にゲームを一瞬停止させる演出の有無
- **使用箇所**: プレゼンテーション層でのヒット演出

#### Probability
- **型**: `int` → `Percentage`
- **意味**: この攻撃要素が発動する確率（%、0-100）
- **使用箇所**:
  - `RangeAttackModel.GetAttackResults()` で確率判定
  - `context.RandomProvider.Trial(AttackElement.Probability)`
- **例**: `100` → 必ず発動, `50` → 50%の確率で発動

### 5.6 状態異常関連

#### EffectType
- **型**: `StateEffectType` (enum)
- **値**: `Poison` (毒), `Burn` (燃焼), `Regeneration` (再生), `BuffAttack` (攻撃バフ) など
- **意味**: 付与する状態異常の種類

#### EffectiveCount
- **型**: `int` → `EffectiveCount`
- **意味**: 状態異常の効果回数
- **特殊な値**: `-1` → `EffectiveCount.Infinity` (無限回)
- **使用箇所**: 状態異常モデル生成時

#### EffectiveDuration
- **型**: `int` → `TickCount`
- **意味**: 状態異常の持続時間（フレーム数）
- **特殊な値**: `-1` → `TickCount.Infinity` (永続)

#### EffectParameter
- **型**: `float` → `StateEffectParameter`
- **意味**: 状態異常の効果量
- **例**:
  - `Poison` の場合: 毒ダメージ量
  - `BuffAttack` の場合: 攻撃力上昇率

### 5.7 その他

#### SortOrder
- **型**: `int`
- **意味**: 同一攻撃内の攻撃要素の実行順序
- **使用箇所**: `AttackDataTranslator` で `OrderBy(mstElement => mstElement.SortOrder)` によりソート
- **重要性**: 複数の攻撃要素がある場合、この順序で実行される

#### AttackType
- **型**: `AttackType` (enum)
- **値**: `Direct`, `PlaceItem`, `Deck`, `None`
- **意味**: 攻撃の種類
- **特殊な値**: `None` の場合は `SubElement` として扱われる
- **使用箇所**:
  - `AttackDataTranslator` で SubElement 判定
  - `AttackModelFactory` で攻撃モデルの型を決定
    - `Direct` → `RangeAttackModel`
    - `PlaceItem` → `PlaceItemAttackModel`
    - `Deck` → `DeckAttackModel`

---

## 6. 実例

### 6.1 コード箇所の具体例

#### 攻撃モデル生成

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Battle/ModelFactories/AttackModelFactory.cs:88-100`

```csharp
IAttackModel attack = attackElement.AttackType switch
{
    AttackType.Direct => new RangeAttackModel(
        _attackIdProvider.GenerateNewId(),
        fieldObjectId,
        stateEffectSourceId,
        attackElement,  // ★ AttackElement を渡す
        roleType,
        color,
        attackBaseData.KillerColors,
        attackBaseData.KillerPercentage,
        baseAttackPower,
        // ...
    ),
    // ...
};
```

#### ターゲット選択とダメージ計算

**ファイルパス**: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Domain/Models/AttackModel/RangeAttackModel.cs:68-80`

```csharp
IReadOnlyList<IAttackTargetModel> targets = AttackTargetSelector.GetTargetsInRange(
    context.AttackTargetCandidates,
    TargetSelectionData,  // ★ AttackElement.AttackRange 等が含まれる
    context.CoordinateConverter);

var attackResults = targets
    .Where(_ => context.RandomProvider.Trial(AttackElement.Probability))  // ★ 確率判定
    .Select(target => context.AttackResultModelFactory.CreateHitAttackResult(
        this,
        AttackElement,  // ★ ダメージ計算で使用
        target.Id))
    .ToList();
```

### 6.2 データ例（想定）

```csv
id,mstAttackId,sortOrder,attackType,target,targetType,targetColors,targetRoles,rangeStartType,rangeStartParameter,rangeEndType,rangeEndParameter,maxTargetCount,damageType,hitType,hitParameter1,hitParameter2,hitEffectId,isHitStop,probability,powerParameterType,powerParameter,effectType,effectiveCount,effectiveDuration,effectParameter,attackDelay
atk_elem_001,atk_001,0,Direct,Foe,Nearest,,,SelfPosition,0.0,ForwardDistance,3.0,1,Physical,Normal,0,0,hit_effect_001,true,100,Percentage,120,None,0,0,0.0,10
atk_elem_002,atk_001,1,None,Foe,All,Red,,SelfPosition,0.0,ForwardDistance,5.0,-1,Physical,Normal,0,0,hit_effect_002,false,50,FixedValue,200,Poison,5,300,10.0,0
atk_elem_003,atk_002,0,Direct,Friend,Random,,,SelfPosition,0.0,All,0.0,3,None,None,0,0,,false,100,Percentage,0,BuffAttack,-1,600,20.0,5
```

**説明**:
- **atk_elem_001**: 攻撃ID `atk_001` の1番目の要素。前方3.0範囲内の最も近い敵1体に物理ダメージ（基礎攻撃力の120%）、10フレーム遅延後に発動
- **atk_elem_002**: 攻撃ID `atk_001` の2番目の要素（SubElement）。前方5.0範囲内の赤色の全敵に50%の確率で固定200ダメージ + 毒（5回、300フレーム、毎回10ダメージ）
- **atk_elem_003**: 攻撃ID `atk_002` の1番目の要素。味方全体からランダムに3体を選び、攻撃力バフ（20%上昇、600フレーム持続、無限回）を付与、5フレーム遅延

---

## 7. まとめ

### 7.1 テーブルの役割

`mst_attack_elements` テーブルは、GLOWゲーム内の攻撃システムの詳細な挙動を定義する中核的なマスターデータです。以下の責務を持ちます：

1. **攻撃の詳細パラメータ定義**: 範囲、ターゲット、ダメージ、エフェクトなど
2. **複雑な攻撃パターンのサポート**: 複数要素 + SubElement による多段攻撃、条件付き効果
3. **柔軟なターゲティング**: 色、ロール、シリーズ、個別ユニットによるフィルタリング
4. **状態異常システム**: 毒、燃焼、バフ、デバフなどの効果を統一的に管理

### 7.2 設計の特徴

- **高い拡張性**: AttackType, DamageType, StateEffectType などの enum により、新しい攻撃種別を追加しやすい
- **データ駆動**: コードを変更せずに、CSVデータの変更だけで攻撃パターンを調整可能
- **型安全性**: ドメインレイヤーでは Value Object を使用し、型安全性とバグの防止を実現
- **チート対策**: Obscured型によるメモリ改ざん対策

### 7.3 開発時の注意点

1. **SortOrder の重要性**: 複数要素がある場合、実行順序が攻撃の挙動に影響する
2. **AttackType.None の扱い**: SubElement として直前の要素にマージされる
3. **-1 の特殊な意味**: MaxTargetCount, EffectiveCount, EffectiveDuration で「無限」を表す
4. **確率の単位**: Probability は 0-100 の整数（%）
5. **遅延の単位**: AttackDelay, EffectiveDuration は tick 数（フレーム数）

---

## 8. 関連ドキュメント

- [mst_attack テーブルドキュメント](./glow_client_mst_attack.md) *(未作成)*
- [mst_attack_hit_effect テーブルドキュメント](./glow_client_mst_attack_hit_effect.md) *(未作成)*
- [mst_special_role_level_up_attack_element テーブルドキュメント](./glow_client_mst_special_role_level_up_attack_element.md) *(未作成)*
- [攻撃システム全体設計書](../設計書/攻撃システム.md) *(未作成)*

---

**作成日**: 2025-12-29
**調査対象**: `projects/glow-client/`
**調査方法**: コード静的解析、ファイル読み取り、Grep検索
