# ミッション獲得先情報（destination_scene）の設定方法

## 📌 概要

`destination_scene`は、ミッション画面の「挑戦」ボタンを押したときに遷移する画面を指定するカラムです。

プレイヤーがミッションの達成条件を確認して「どこで達成できるか」を示すために、ミッションから関連画面へワンタップで移動できるようにする機能です。

## 設定仕様

### データ型と制約

- **データ型**: `varchar(255)` (文字列)
- **NULL許可**: 不可（必須項目）
- **設定値**: 1つの画面名のみ指定可能（**複数の画面は設定できません**）

### 設定可能な値

クライアント実装で定義されている画面名のみ設定可能です：

| 設定値 | 遷移先画面 | 用途例 |
|--------|-----------|--------|
| `Home` | ホーム画面 | ログイン系、デイリーボーナス受取など |
| `StageSelect` | ステージ選択画面 | クエストクリア系 |
| `QuestSelect` | クエスト選択画面 | 特定クエスト種別のプレイ |
| `IdleIncentive` | 放置報酬画面 | 放置報酬受取系 |
| `UnitList` | キャラクター一覧 | キャラ育成、編成系 |
| `OutpostEnhance` | 拠点強化画面 | 拠点関連のミッション |
| `Gacha` | ガチャ画面 | ガチャ実行系 |
| `Shop` | ショップ画面 | アイテム購入系 |
| `Pack` | パック商品画面 | パック購入系 |
| `Pass` | パス画面 | パス購入・報酬受取系 |
| `Event` | イベントトップ画面 | イベント参加系 |
| `Pvp` | PvP画面 | PvP参加・ランキング系 |
| `Exchange` | 交換所画面 | アイテム交換系 |
| `Web` | 外部Web画面 | SNSフォロー、外部リンク系 |
| `LinkBnId` | バンナムID連携画面 | アカウント連携系 |
| _(空文字)_ | 遷移なし | 「挑戦」ボタンを押すと「設定されておりません」と表示 |

## 実装の詳細

### 1. マスタデータテーブルでの設定

以下のミッションテーブルに`destination_scene`カラムが存在します：

- `MstMissionDaily` (デイリーミッション)
- `MstMissionWeekly` (ウィークリーミッション)
- `MstMissionAchievement` (アチーブメントミッション)
- `MstMissionBeginner` (ビギナーミッション)
- `MstMissionEvent` (イベントミッション)
- `MstMissionEventDaily` (イベントデイリーミッション)
- `MstMissionLimitedTerm` (期間限定ミッション)

### 2. CSV設定例

#### MstMissionDaily.csv の例

```csv
ENABLE,id,release_key,criterion_type,criterion_value,criterion_count,group_key,bonus_point,mst_mission_reward_group_id,sort_order,destination_scene
e,daily_2_1,202509010,LoginCount,,1,Daily1,20,,1,Home
e,daily_2_2,202509010,CoinCollect,,2000,Daily1,20,,2,StageSelect
e,daily_2_3,202509010,UnitEnhanceCount,,1,Daily1,20,,3,UnitList
e,daily_2_4,202509010,GachaCount,,1,Daily1,20,,4,Gacha
```

#### MstMissionAchievement.csv の例

```csv
ENABLE,id,release_key,criterion_type,criterion_value,criterion_count,unlock_criterion_type,unlock_criterion_value,unlock_criterion_count,group_key,mst_mission_reward_group_id,sort_order,destination_scene
e,achievement_2_1,202509010,FollowCompleted,https://x.com/example,1,__NULL__,,0,,achievement_2_1,1,Web
e,achievement_2_2,202509010,AccountCompleted,,1,__NULL__,,0,,achievement_2_2,2,LinkBnId
e,achievement_2_3,202509010,StageCleared,,10,__NULL__,,0,,achievement_2_3,3,QuestSelect
```

### 3. クライアント実装での処理

#### DestinationScene ValueObject

クライアントでは`DestinationScene.cs`で画面名を管理しています：

```csharp
public record DestinationScene(ObscuredString Value)
{
    public static DestinationScene Empty { get; } = new DestinationScene("");
    public static DestinationScene QuestSelect { get; } = new DestinationScene("QuestSelect");
    public static DestinationScene StageSelect { get; } = new DestinationScene("StageSelect");
    public static DestinationScene Home { get; } = new DestinationScene("Home");
    // ... 他の画面定義
}
```

#### Presenterでの分岐処理

`DailyMissionPresenter.cs`など各Presenterで、`destination_scene`の値に応じて遷移処理を実装：

```csharp
void IDailyMissionViewDelegate.OnChallenge(DestinationScene destination)
{
    var destinationScene = destination.TryToEnum();
    switch (destinationScene)
    {
        case DestinationSceneEnum.Home:
        case DestinationSceneEnum.StageSelect:
            MissionMainViewControl.DismissByChallenge();
            break;
        case DestinationSceneEnum.QuestSelect:
            MissionMainViewControl.DismissByChallenge();
            MissionNavigator.ShowHomeQuestSelectView();
            break;
        case DestinationSceneEnum.UnitList:
            MissionMainViewControl.DismissByChallenge();
            MissionNavigator.ShowUnitListView();
            break;
        // ... 他の画面への遷移処理
        case DestinationSceneEnum.Empty:
            Toast.MakeText("設定されておりません。").Show();
            break;
        default:
            Toast.MakeText("まだ実装されていません。").Show();
            break;
    }
}
```

## よくある質問

### Q1: 1列に複数の画面を設定できる？

**A: できません。**

`destination_scene`は`varchar(255)`型の単一値カラムで、1つのミッションにつき1つの遷移先しか設定できません。

クライアント実装でも単一の`DestinationScene`オブジェクトとして扱われており、複数の画面への分岐は想定されていません。

### Q2: 複数の画面に誘導したい場合はどうする？

**A: 複数のミッションを作成してください。**

例えば、「クエストクリア」と「キャラ育成」の両方を促したい場合：

- ミッション1: `criterion_type=StageCleared`, `destination_scene=StageSelect`
- ミッション2: `criterion_type=UnitEnhanceCount`, `destination_scene=UnitList`

のように、別々のミッションとして設定します。

### Q3: 設定値が間違っていた場合どうなる？

**A: クライアントで「まだ実装されていません。」と表示されます。**

`DestinationScene.cs`に定義されていない値を設定すると、`TryToEnum()`で`DestinationSceneEnum.Empty`に変換され、defaultケースで「まだ実装されていません。」というトーストが表示されます。

### Q4: 空文字を設定した場合は？

**A: 「設定されておりません。」と表示されます。**

空文字（空白）を設定すると`DestinationScene.Empty`として扱われ、「挑戦」ボタンを押しても画面遷移せず、「設定されておりません。」というメッセージが表示されます。

ただし、カラム定義では`nullable: false`のため、完全なNULLは設定できません。空文字は設定可能です。

### Q5: 新しい画面への遷移を追加したい場合は？

**A: クライアント実装の修正が必要です。**

新しい遷移先を追加する場合は、以下の3ステップが必要です：

1. `DestinationScene.cs`に新しい画面定義を追加
2. `DestinationSceneEnum`に対応するenumを追加
3. 各Presenter（`DailyMissionPresenter.cs`など）のswitchケースに遷移処理を実装

エンジニアに相談してください。

## ✅ チェックポイント

マスタデータを設定する際は、以下を確認してください：

1. **設定値が定義済みか確認**
   - 上記の「設定可能な値」表にある画面名のみ使用
   - 大文字・小文字を正確に一致させる（例: `Home` ○、`home` ×）

2. **ミッションの達成条件と遷移先の整合性**
   - 例: `criterion_type=StageCleared` なら `destination_scene=StageSelect` が自然
   - 例: `criterion_type=GachaCount` なら `destination_scene=Gacha` が自然

3. **空文字ではなく適切な画面を指定**
   - 空文字は避け、ユーザーが迷わないように適切な画面を設定
   - どうしても遷移先がない場合は`Home`を設定するのが無難

## 実データでの使用例

現在の`MstMissionDaily`での使用状況：

```
Home (ホーム画面) - ログイン系ミッション
StageSelect (ステージ選択) - クエストクリア系ミッション
IdleIncentive (放置報酬) - 放置報酬受取系ミッション
Gacha (ガチャ) - ガチャ実行系ミッション
Pvp (PvP画面) - PvP参加系ミッション
```

現在の`MstMissionAchievement`での使用状況：

```
Web (外部Web) - SNSフォロー系ミッション
LinkBnId (バンナムID連携) - アカウント連携系ミッション
QuestSelect (クエスト選択) - 特定クエスト種別クリア系ミッション
StageSelect (ステージ選択) - 一般クエストクリア系ミッション
UnitList (キャラ一覧) - キャラ育成系ミッション
OutpostEnhance (拠点強化) - 拠点関連ミッション
IdleIncentive (放置報酬) - 放置報酬関連ミッション
Home (ホーム) - その他汎用的なミッション
```

---

**まとめ:**
- `destination_scene`は**単一の画面名のみ**設定可能
- 複数の画面に誘導したい場合は、複数のミッションを作成
- 設定可能な値は`DestinationScene.cs`で定義されているものに限定
- ミッションの達成条件と遷移先が自然に対応するように設定
