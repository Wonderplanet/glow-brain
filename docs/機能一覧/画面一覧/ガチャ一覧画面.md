# ガチャ一覧画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャ一覧画面 |
| **画面番号** | 71-1-5 |
| **画面種別** | メイン画面 |

## 概要

プレイヤーが引くことのできるすべてのガチャを一覧表示する画面です。現在開催中のガチャがタイプ別に整理されて表示され、各ガチャの残り時間、無料・広告で引ける状態の通知バッジ、天井情報などを確認できます。

プレミアムガチャは画面の最下部に常に固定表示され、その他のガチャは開催期間に応じてスクロール可能なリストとして表示されます。チュートリアル中はチュートリアルガチャのみが表示され、スクロールが無効化されます。

## プレイヤーができること

### ガチャバナーの閲覧と選択

#### ガチャの種類を確認
- フェスティバルガチャ、ピックアップガチャ、無料ガチャ、チケットガチャ、有償限定ガチャ、メダルガチャ、プレミアムガチャなど多様な種類を一覧表示
- 各ガチャバナーには以下の情報が表示される
  - ガチャバナー画像
  - 残り期間テキスト（「残り〇日」「残り〇時間」など）
  - 天井情報（「あと〇〇回で確定」など）
  - 無料・広告で引ける場合の通知バッジ
  - ガチャの説明テキスト

#### バナーをタップして詳細画面へ遷移
- ガチャバナーをタップすると、そのガチャの詳細画面（ガチャコンテンツ画面）に遷移
- メンテナンス中のガチャはタップしてもメンテナンスダイアログが表示され、詳細画面へは遷移しない

### ガチャ情報の確認

#### 提供割合の確認
- ガチャバナーに表示される「提供割合」ボタンをタップ
- 提供割合ダイアログが表示され、各レアリティやアイテムの出現確率を確認可能
- ダイアログからアイテム詳細も確認できる

#### ラインナップの確認
- メダルガチャやチュートリアルガチャでは「ラインナップ」ボタンをタップ
- ガチャで入手できるアイテム一覧を表示

#### ガチャ詳細の確認
- プレミアムガチャの「詳細」ボタンをタップ
- ガチャの詳細情報ダイアログが表示される

### ガチャの実行

#### メダルガチャをその場で引く
- メダルガチャは一覧画面から直接ガチャを実行可能
- コストアイコンとコスト量が表示される
- コスト不足時はボタンがグレーアウトして引けない
- ボタンをタップするとガチャ確認ダイアログが表示され、実行を確定すると演出が再生される

#### チュートリアルガチャを引く
- チュートリアル中に表示される専用ガチャ
- 「ガチャを引く」ボタンから確認なしで直接実行
- チュートリアルガチャ表示中は画面スクロールが停止される

#### プレミアムガチャを引く
- 画面最下部に常に固定表示
- 単発ガチャと10連ガチャのボタンが表示される
- 広告ガチャが引ける場合、広告ガチャボタンとリセットまでの残り時間、引ける回数が表示される
- 各ボタンから直接ガチャ確認ダイアログを表示し、実行できる

### ガチャ履歴の確認

#### ガチャ履歴ボタンをタップ
- 画面内の「ガチャ履歴」ボタンをタップ
- 過去に引いたガチャの履歴ダイアログが表示される

## 画面の要素

### ヘッダー部分
- ガチャ履歴ボタン

### スクロール可能なガチャリスト
- フェスティバルガチャエリア（存在する場合）
  - 専用の横長バナーとレイアウト
  - 通知バッジ、残り時間、天井テキスト、提供割合ボタン
- ピックアップガチャエリア（存在する場合）
  - ガチャバナー、通知バッジ、残り時間、天井テキスト、提供割合ボタン
- 無料ガチャエリア（存在する場合）
  - 同様の構成
- チケットガチャエリア（存在する場合）
  - 同様の構成
- 有償限定ガチャエリア（存在する場合）
  - 同様の構成
- メダルガチャエリア（存在する場合）
  - ガチャバナー、コストアイコン、コスト量、残り時間、天井テキスト、ラインナップボタン、ガチャ実行ボタン

### 固定表示エリア（画面最下部）
- プレミアムガチャ
  - ガチャバナー
  - 通知バッジ
  - 単発ガチャボタン（コストアイコンとコスト量）
  - 10連ガチャボタン（コストアイコンとコスト量）
  - 広告ガチャボタン（引ける場合のみ）
  - 広告ガチャのリセット残り時間と引ける回数
  - 残り期間テキスト
  - 天井テキスト
  - 固定報酬説明文（該当する場合）
  - 詳細ボタン、提供割合ボタン

### チュートリアルガチャ（チュートリアル中のみ）
- ガチャバナー
- ガチャ説明テキスト
- 「ガチャを引く」ボタン
- ラインナップボタン

## 画面遷移

### この画面への遷移
- **ホーム画面**: フッターメニューの「ガチャ」タブをタップ

### この画面からの遷移
- **ガチャコンテンツ画面**: ガチャバナーをタップ
  - 選択したガチャの詳細情報と実行ボタンを表示
- **ガチャ確認ダイアログ**: メダルガチャやプレミアムガチャの実行ボタンをタップ
  - 確認後、ガチャ演出画面へ遷移
- **ガチャ演出画面**: ガチャ実行確定後
  - 演出再生後、ガチャ結果画面へ自動遷移
- **ガチャ結果画面**: ガチャ演出完了後
  - 獲得アイテムを表示
- **ガチャ提供割合ダイアログ**: 提供割合ボタンをタップ（モーダル表示）
- **ガチャラインナップダイアログ**: ラインナップボタンをタップ（モーダル表示）
- **ガチャ詳細ダイアログ**: プレミアムガチャの詳細ボタンをタップ（モーダル表示）
- **ガチャ履歴ダイアログ**: ガチャ履歴ボタンをタップ（モーダル表示）
- **コンテンツメンテナンスダイアログ**: メンテナンス中のガチャをタップ（モーダル表示）

## ゲーム仕様・制約事項

### ガチャの表示条件
- 開催期間内のガチャのみ表示
- 開放条件を満たしていないガチャは非表示
- 開放期間を持ち、期限切れのガチャは非表示
- チケット/メダルガチャで「未所持時非表示設定」がある場合、対応アイテムを持っていないと非表示
- 有償限定ガチャで上限まで引いている場合は非表示

### ガチャの優先度とソート
- ガチャはマスターデータのガチャ優先度（GachaPriority）に従ってソートされる
- 優先度が高いガチャほど上位に表示される

### チュートリアルガチャの特別挙動
- チュートリアル中（TutorialMainPart_start）のみ表示
- チュートリアルガチャが表示されている間はスクロールが無効化される
- 確認ダイアログなしで直接ガチャを実行

### プレミアムガチャの特別挙動
- 画面最下部に常に固定表示
- 単発ガチャと10連ガチャの2種類のボタン
- 広告ガチャの回数制限と日次リセット（04:00）
- 広告視聴後にローカル通知スケジュールが更新される

### メンテナンス対応
- メンテナンス中のガチャはタップ時にメンテナンスダイアログを表示
- 詳細画面への遷移をブロック

### ガチャ期間外エラー処理
- ガチャ実行中にガチャの開催期間が終了した場合
- N時間開放ガチャの有効期限が切れた場合
- エラーダイアログを表示し、ガチャ一覧画面に戻る

### ガチャ実行後の更新
- ガチャ実行後、ヘッダーとフッターのステータスとバッジが更新される
- 一覧画面に戻った際、直前にタップしたガチャの位置にスクロール

### 通知バッジ表示条件
- 無料または広告で引けるガチャの場合、通知バッジが表示される
- プレイヤーがコストなしで引ける状態であることを示す

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaList/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaListPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/Presenters/GachaListPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaListViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/ViewModels/GachaListViewModel.cs)
- `Presentation/ViewModels/GachaBannerViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/ViewModels/GachaBannerViewModel.cs)
- `Presentation/ViewModels/FestivalGachaBannerViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/ViewModels/FestivalGachaBannerViewModel.cs)
- `Presentation/ViewModels/PremiumGachaViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/ViewModels/PremiumGachaViewModel.cs)
- `Presentation/ViewModels/MedalGachaBannerViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/ViewModels/MedalGachaBannerViewModel.cs)
- `Presentation/ViewModels/TutorialGachaBannerViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/ViewModels/TutorialGachaBannerViewModel.cs)

#### View
- `Presentation/Views/GachaListViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/Views/GachaListViewController.cs)
- `Presentation/Views/GachaListView.cs`

#### UseCase
- `Domain/UseCases/GachaListUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Domain/UseCases/GachaListUseCase.cs)
- `Domain/UseCases/GachaDrawUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Domain/UseCases/GachaDrawUseCase.cs)
- `Domain/UseCases/TutorialGachaDrawUseCase.cs`

#### Translator
- `Presentation/Translator/GachaListViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaList/Presentation/Translator/GachaListViewModelTranslator.cs)

### GachaListViewModelの構造

画面全体のガチャ一覧を表すViewModel。各ガチャタイプ別にバナー情報を保持します。

- `FestivalBannerViewModels`: フェスティバルガチャのバナーリスト
- `PickupBannerViewModels`: ピックアップガチャのバナーリスト
- `FreeBannerViewModels`: 無料ガチャのバナーリスト
- `TicketBannerViewModels`: チケットガチャのバナーリスト
- `PaidOnlyBannerViewModels`: 有償限定ガチャのバナーリスト
- `MedalGachaBannerViewModels`: メダルガチャのバナーリスト
- `PremiumGachaViewModel`: プレミアムガチャの情報（固定表示）
- `TutorialGachaBannerViewModel`: チュートリアルガチャの情報
- `HeldAdSkipPassInfoViewModel`: 広告スキップパス所持情報

### 各種バナーViewModelの構造

#### GachaBannerViewModel（ピックアップ、無料、チケット、有償限定）
- `GachaId`: ガチャID
- `GachaType`: ガチャタイプ
- `GachaBannerAssetPath`: バナー画像パス
- `NotificationBadge`: 通知バッジ表示フラグ
- `GachaRemainingTimeText`: 残り時間テキスト
- `GachaDescription`: ガチャ説明文
- `GachaThresholdText`: 天井テキスト

#### FestivalGachaBannerViewModel
- `MstGachaId`: ガチャID
- `GachaType`: ガチャタイプ
- `FestivalGachaBannerAssetPath`: フェスティバル用バナー画像パス
- `NotificationBadge`: 通知バッジ表示フラグ
- `GachaRemainingTimeText`: 残り時間テキスト
- `GachaDescription`: ガチャ説明文
- `GachaThresholdText`: 天井テキスト

#### PremiumGachaViewModel（プレミアムガチャ）
- `GachaId`: ガチャID
- `GachaBannerAssetPath`: バナー画像パス
- `GachaDescription`: ガチャ説明文
- `NotificationBadge`: 通知バッジ表示フラグ
- `CostType`: コストタイプ
- `SingleDrawCostIconAssetPath`: 単発ガチャのコストアイコンパス
- `SingleDrawCostAmount`: 単発ガチャのコスト量
- `MultiDrawCostIconAssetPath`: 10連ガチャのコストアイコンパス
- `MultiDrawCostAmount`: 10連ガチャのコスト量
- `AdDrawableFlag`: 広告ガチャ実行可能フラグ
- `AdGachaResetRemainingText`: 広告ガチャリセットまでの残り時間テキスト
- `AdGachaDrawableCount`: 広告ガチャの引ける回数
- `GachaRemainingTimeText`: 残り時間テキスト
- `GachaThresholdText`: 天井テキスト
- `GachaFixedPrizeDescription`: 固定報酬説明文

#### MedalGachaBannerViewModel
- `GachaId`: ガチャID
- `GachaBannerAssetPath`: バナー画像パス
- `IconAssetPath`: コストアイコンパス
- `GachaDescription`: ガチャ説明文
- `DrawCostAmount`: 実行コスト量
- `DrawableFlag`: 実行可能フラグ
- `GachaRemainingTimeText`: 残り時間テキスト
- `GachaThresholdText`: 天井テキスト

#### TutorialGachaBannerViewModel
- `GachaId`: ガチャID
- `GachaBannerAssetPath`: バナー画像パス
- `GachaDescription`: ガチャ説明文

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| OprGacha.GachaId | opr_gacha.id | ガチャ一覧に表示するガチャの識別ID |
| OprGacha.GachaType | opr_gacha.gacha_type | ガチャの種別（フェスティバル、ピックアップ、無料、チケット、有償限定、メダル、プレミアム、チュートリアル） |
| OprGacha.DrawCountThresholdGroupId | opr_gacha.draw_count_threshold_group_id | 天井グループIDでOprGachaUpperとの紐付けに使用 |
| OprGacha.EnableAdPlay | opr_gacha.enable_ad_play | 広告ガチャが有効かどうかのフラグ |
| OprGacha.AdIntervalTimeMinutes | opr_gacha.ad_interval_time_minutes | 広告ガチャの実行間隔（分） |
| OprGacha.MultiDrawCount | opr_gacha.multi_draw_count | 10連ガチャの回数 |
| OprGacha.DailyPlayLimitCount | opr_gacha.daily_play_limit_count | 1日あたりのガチャ実行回数上限 |
| OprGacha.TotalPlayLimitCount | opr_gacha.total_play_limit_count | 期間中のガチャ実行回数上限 |
| OprGacha.DailyAdPlayLimitCount | opr_gacha.daily_ad_play_limit_count | 1日あたりの広告ガチャ実行回数上限 |
| OprGacha.TotalAdPlayLimitCount | opr_gacha.total_ad_play_limit_count | 期間中の広告ガチャ実行回数上限 |
| OprGacha.StartAt | opr_gacha.start_at | ガチャ開始日時 |
| OprGacha.EndAt | opr_gacha.end_at | ガチャ終了日時で残り時間表示に使用 |
| OprGacha.GachaName | opr_gacha.gacha_name | ガチャ名 |
| OprGacha.Description | opr_gacha.description | ガチャ説明文 |
| OprGacha.GachaBannerAssetKey | opr_gacha.gacha_banner_asset_key | ガチャバナー画像のアセットキー |
| OprGacha.GachaPriority | opr_gacha.gacha_priority | ガチャの表示優先度でソートに使用 |
| OprGacha.RarityThresholdText | opr_gacha.rarity_threshold_text | レアリティ天井のテキスト（例：「あと○○回でSSR確定」） |
| OprGacha.PickupThresholdText | opr_gacha.pickup_threshold_text | ピックアップ天井のテキスト（例：「あと○○回でピックアップ確定」） |
| OprGacha.UnlockConditionType | opr_gacha.unlock_condition_type | ガチャの解放条件タイプ（チュートリアル完了など） |
| OprGacha.UnlockDurationHours | opr_gacha.unlock_duration_hours | ガチャの開放期間（時間） |
| OprGacha.GachaFixedPrizeDescription | opr_gacha.gacha_fixed_prize_description | 確定報酬の説明文（例：「SR以上1体確定」） |
| OprGacha.GachaLogoAssetKey | opr_gacha.gacha_logo_asset_key | ガチャロゴ画像のアセットキー |
| OprGacha.AppearanceCondition | opr_gacha.appearance_condition | ガチャの表示条件（常時表示、チケット所持時など） |
| OprGachaUpper.DrawCountThresholdGroupId | opr_gacha_upper.upper_group | 天井グループID（OprGachaと紐付け） |
| OprGachaUpper.UpperType | opr_gacha_upper.upper_type | 天井タイプ（MaxRarity: レアリティ天井、Pickup: ピックアップ天井） |
| OprGachaUpper.GachaThresholdCount | opr_gacha_upper.count | 天井までの実行回数 |
| OprGachaUseResource.OprGachaId | opr_gacha_use_resource.opr_gacha_id | ガチャID |
| OprGachaUseResource.CostType | opr_gacha_use_resource.cost_type | コストタイプ（Diamond, PaidDiamond, Item, Free, Adなど） |
| OprGachaUseResource.MstCostId | opr_gacha_use_resource.mst_cost_id | アイテムコストのマスタID |
| OprGachaUseResource.CostAmount | opr_gacha_use_resource.cost_amount | コスト量（ダイヤ数やアイテム数） |
| OprGachaUseResource.GachaDrawCount | opr_gacha_use_resource.gacha_draw_count | 単発（1回）か10連（10回）かの区分 |
| OprGachaUseResource.GachaCostPriority | opr_gacha_use_resource.gacha_cost_priority | コストの優先度（複数コスト設定がある場合に使用） |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserGacha.OprGachaId | user_gacha.opr_gacha_id | ユーザーがプレイしたガチャのID |
| UserGacha.AdPlayedAt | user_gacha.ad_played_at | 最後に広告ガチャをプレイした日時 |
| UserGacha.PlayedAt | user_gacha.played_at | 最後にガチャをプレイした日時 |
| UserGacha.AdPlayedCount | user_gacha.ad_played_count | 広告ガチャの累計実行回数 |
| UserGacha.DailyAdPlayedCount | user_gacha.daily_ad_played_count | 1日あたりの広告ガチャ実行回数 |
| UserGacha.PlayedCount | user_gacha.played_count | ガチャの累計実行回数 |
| UserGacha.DailyPlayedCount | user_gacha.daily_played_count | 1日あたりのガチャ実行回数 |
| UserGacha.GachaExpireAt | user_gacha.gacha_expire_at | 個別有効期限（一部ガチャで設定） |
| UserDrawCountThreshold.DrawCountThresholdGroupId | user_gacha_draw_count_threshold.draw_count_threshold_group_id | 天井グループID |
| UserDrawCountThreshold.UpperType | user_gacha_draw_count_threshold.upper_type | 天井タイプ（MaxRarity or Pickup） |
| UserDrawCountThreshold.GachaPlayedCount | user_gacha_draw_count_threshold.gacha_played_count | 天井カウント用の実行済み回数 |
| UserItem.MstItemId | user_items.mst_item_id | アイテムID（チケット/メダルガチャのコスト判定） |
| UserItem.Amount | user_items.amount | アイテム所持数 |

### 呼び出しているAPI

#### ガチャ実行（広告ガチャ）
- **POST `/api/gacha/draw/ad`**: 広告視聴によるガチャ実行
  - パラメータ: `oprGachaId` (ガチャID), `drewCount` (実行済み回数)
  - 用途: 広告ガチャを実行し、結果を取得

#### ガチャ実行（ダイヤモンドガチャ）
- **POST `/api/gacha/draw/diamond`**: ダイヤモンド消費によるガチャ実行
  - パラメータ: `oprGachaId` (ガチャID), `drewCount` (実行済み回数), `playNum` (引く回数), `costNum` (コスト量)
  - 用途: ダイヤモンドを消費してガチャを実行

#### ガチャ実行（有償ダイヤモンドガチャ）
- **POST `/api/gacha/draw/paid_diamond`**: 有償ダイヤモンド消費によるガチャ実行
  - パラメータ: `oprGachaId` (ガチャID), `drewCount` (実行済み回数), `playNum` (引く回数), `costNum` (コスト量)
  - 用途: 有償ダイヤモンドを消費してガチャを実行

#### ガチャ実行（アイテムガチャ）
- **POST `/api/gacha/draw/item`**: アイテム消費によるガチャ実行
  - パラメータ: `oprGachaId` (ガチャID), `drewCount` (実行済み回数), `playNum` (引く回数), `costId` (コストアイテムID), `costNum` (コスト量)
  - 用途: チケットやメダルなどのアイテムを消費してガチャを実行

#### ガチャ実行（無料ガチャ）
- **POST `/api/gacha/draw/free`**: コストなしのガチャ実行
  - パラメータ: `oprGachaId` (ガチャID), `drewCount` (実行済み回数)
  - 用途: 無料ガチャを実行

#### ガチャ履歴取得
- **GET `/api/gacha/history`**: ガチャ履歴取得
  - 用途: ガチャ履歴ボタンタップ時に過去のガチャ結果を取得
