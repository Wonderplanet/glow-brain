# イベントステージトップ画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | イベントステージトップ画面 |
| **画面番号** | 42-1-3（イベントクエストステージ選択） |
| **画面種別** | メイン画面（Home内のコンテンツ） |

## 概要

イベント期間中に開催されるクエストの全ステージを確認し、プレイするステージを選択する画面です。プレイヤーは、カルーセルで各ステージの情報（推奨レベル、消費スタミナ、クリア状況）を確認した上で、目的のステージをタップして戦闘に向かうことができます。ステージの開放条件、報酬内容、特殊ルールなどの詳細情報も確認可能です。

## プレイヤーができること

### ステージ選択とゲーム開始

#### ステージのスクロール
- カルーセルで左右にスクロールしてステージを選択
- ステージの難度や報酬を確認しながら選択可能

#### ステージ情報の確認
- **ステージ名と難度**: 画面上部に選択中のステージ情報を表示
- **推奨レベル**: プレイに推奨される敵パーティのレベル
- **消費スタミナ**: このステージをプレイするのに必要なスタミナ量
- **クリア状況**: 未プレイ、初回クリア、複数回クリアなどのステータス
- **開放条件**: 未開放のステージは開放に必要な条件（前ステージクリアなど）を表示
- **1日のプレイ回数制限**: 1日あたりの実行可能回数と残り実行回数

#### ステージに関する詳細情報
- **ステージ情報ボタン**: タップしてステージの詳細（ドロップ報酬など）を確認
- **特殊ルール表示**: ステージに特殊ルールが設定されている場合に表示
  - タップして詳細ルール（敵キャラ限定、スキル制限など）を確認可能
- **スピードアタック報酬**: 規定ターン以内のクリアで獲得できる追加報酬
  - 達成状況（未達成・達成）を表示

#### イベント参加特典表示
- **イベント限定ドロップ（フラグメント）**: イベントステージで手に入るアートワークフラグメント
  - 取得可能な総数と既に取得済みの数を表示
  - 収集完了時はアイコンで表示
- **ボーナスユニット**: イベントに登場するキャラクター
  - 3体まで画像で表示
  - タップしてユニット詳細を確認可能

### パーティ編成と事前準備

- **パーティ編成ボタン**: このステージの戦闘に向けてパーティを編成
  - クエストコンテンツ固有の編成画面で調整可能
- **スタミナ回復**: スタミナが不足している場合は回復可能

### 関連コンテンツへのアクセス

- **ミッションボタン**: イベントの期間限定ミッションを確認
  - ミッション完了状況を表示
  - 報酬受け取り可能な件数がバッジで表示
- **イベント交換所ボタン**: イベント限定の交換ショップにアクセス
  - ドロップしたアイテムを交換できる
  - ボタンはイベント開催中のみ有効

### その他の操作

- **戻るボタン**: クエストコンテンツトップに戻る
- **新規開放ステージ演出**: ステージが新しく開放された場合、専用の演出が自動再生
  - 同時に開放された他のクエストの名前が表示される

## 画面の要素

### ヘッダー部分
- ステージ名とクエストカテゴリー表示
- イベント終了までの残り時間カウントダウン
- 現在編成しているパーティ名の表示
- 戻るボタン

### メイン表示エリア

#### ボーナスユニット表示
- イベントに登場する3体のキャラクター画像
- セリフバルーン表示（キャラクターの掛け合い）
- タップでユニット詳細モーダルを表示

#### ステージ選択カルーセル
- 左右にスクロール可能な複数ステージ表示
- 各ステージカード内の要素：
  - ステージ背景画像
  - ステージ番号
  - 推奨レベル
  - 消費スタミナ
  - クリアバッジ（初回クリア、複数回クリア）
  - ステージ未開放時は開放条件を表示
  - スタミナブースト表示（オートラップ対応ステージで表示）

#### ステージ詳細情報パネル
- **ステージタイトル**: 現在選択中のステージ名
- **1日のプレイ回数**: 残り実行回数と制限値
- **スピードアタック目標**: 達成状況（未達成時は残りターン数）
- **特殊ルール**: ルール内容と達成状況
- **報酬アイコン**: フラグメント取得完了時に表示

#### キャンペーン表示
- 開催中のキャンペーン効果を表示
  - スタミナ消費減少、プレイ回数追加増加など

### ボタンエリア

#### プレイ開始ボタン
- タップしてステージクリア画面に遷移
- スタミナ不足時はグレーアウト
- 開放条件未達成時は無効化

#### パーティ編成ボタン
- このステージの戦闘に向けてパーティ編成
- パーティ編成画面はモーダルで表示

#### ステージ情報ボタン
- 詳細情報を確認
- ドロップ報酬などを表示

#### 特殊ルール確認ボタン
- ルールが設定されている場合のみ表示
- タップで詳細ルール表示ダイアログを開く

### 右上エリア
- **ミッションバッジ**: 受け取り可能なミッション報酬数
- **ミッションボタン**: タップでイベントミッション画面を表示
- **イベント交換所ボタン**: タップでイベント限定ショップを表示

## 画面遷移

### この画面への遷移
- **イベントクエスト選択画面**: 特定のクエストグループを選択
  - 前回プレイしたステージが自動選択される
- **降臨バトルなど他のイベント**: クエストグループの指定で遷移

### この画面からの遷移

#### ゲーム開始
- **クエスト画面**: プレイボタンをタップ
  - ステージのクリア状況とプレイ可能回数をチェック
  - 選択したステージのステージIDを引き継ぎ

#### 情報確認・編成
- **ステージ情報モーダル**: ステージ情報ボタンをタップ
  - ドロップ報酬などの詳細を表示
- **パーティ編成画面**: パーティ編成ボタンをタップ
  - 画面はモーダルで表示
  - ステージIDを渡して編成を開始
- **特殊ルール詳細ダイアログ**: 特殊ルールボタンをタップ
  - ルール内容を詳細表示

#### コンテンツアクセス
- **イベントミッション画面**: ミッションボタンをタップ
  - イベントの期間限定ミッション一覧を表示
  - ミッション報酬の受け取り可能
- **イベント交換所画面**: イベント交換所ボタンをタップ
  - イベント限定ショップを表示
  - 開催中のイベントのみアクセス可能

#### 前画面に戻る
- **クエストコンテンツトップ**: 戻るボタンをタップ
  - イベント開催期限を超過していた場合は、自動的にホームに戻る

#### ユニット詳細
- **ユニット詳細モーダル**: ボーナスユニット画像をタップ
  - ユニットのステータス、スキル、必殺技などを確認
  - 最大ステータス（完凸状態）で表示

## ゲーム仕様・制約事項

### ステージ開放の条件
- ステージは前のステージをクリアすることで開放される
- 未開放のステージは選択できず、開放条件をトースト表示
- 開放予定のステージは開放日時を表示

### プレイ回数制限
- イベントステージには1日あたりの実行回数に上限あり
- 上限に達するとプレイボタンが無効化される
- 残り実行回数は画面上に常時表示
- キャンペーン期間中は追加実行回数が増加

### スタミナ消費と回復
- ステージごとに消費スタミナが設定
- キャンペーン期間中はスタミナ消費が減少することがある
- スタミナ不足時はプレイボタンがグレーアウト

### イベント期限
- イベントには開催期限が設定
- 期限超過後は自動的にホーム画面に戻される
- 残り時間のカウントダウン表示で期限を認識可能

### 新規開放演出
- ステージが新しく開放された場合、専用の演出が自動再生
- 演出は1回限り
- 開放と同じ条件で新規開放される他クエストの名前を表示

### ステージ選択の記憶
- プレイヤーが最後に選択したステージは記憶される
- 画面再訪時に前回選択したステージが自動選択される

### スピードアタック報酬
- 指定ターン以内にステージをクリアすると追加報酬を獲得
- 達成状況はステージごとに保存
- 未達成のステージは「達成困難」など挑戦状況を表示

### 特殊ルール
- ステージに特殊ルール（敵キャラ限定、スキル制限など）が設定されている場合あり
- ルール達成状況（達成済み/未達成）を表示
- 詳細ルール内容はタップして確認

### アートワークフラグメント
- イベントステージで手に入る限定アイテム
- ステージごとにドロップグループが設定
- 全フラグメント取得時は「取得完了」アイコンを表示

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/EventQuestTop/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/EventQuestTopPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestTop/Presentation/Presenters/EventQuestTopPresenter.cs)

#### ViewController
- `Presentation/Views/EventQuestTopViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestTop/Presentation/Views/EventQuestTopViewController.cs)

#### View
- `Presentation/Views/EventQuestTopView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestTop/Presentation/Views/EventQuestTopView.cs)

#### UseCase
- `Domain/UseCases/EventQuestTopUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestTop/Domain/UseCases/EventQuestTopUseCase.cs)

#### Translator
- `Presentation/Translators/EventQuestTopViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestTop/Presentation/Translators/EventQuestTopViewModelTranslator.cs)

### EventQuestTopViewModelの構造

```csharp
public record EventQuestTopViewModel(
    MasterDataId MstEventId,                    // イベントID
    MasterDataId MstQuestGroupId,               // クエストグループID
    EventName EventName,                        // イベント名
    QuestName QuestName,                        // クエスト名
    QuestName QuestCategoryName,                // クエストカテゴリ名
    IReadOnlyList<EventQuestTopUnitViewModel> Units,  // 表示ボーナスユニット（最大3体）
    RemainingTimeSpan RemainingAt,              // イベント終了までの残り時間
    MasterDataId InitialSelectStageMstStageId,  // 初期選択ステージID
    IReadOnlyList<EventQuestTopElementViewModel> Stages,  // ステージ一覧
    ShowStageReleaseAnimation ShowStageReleaseAnimation, // ステージ開放演出表示フラグ
    ArtworkFragmentNum GettableArtworkFragmentNum,  // 取得可能フラグメント総数
    ArtworkFragmentNum AcquiredArtworkFragmentNum,  // 取得済みフラグメント総数
    IReadOnlyList<CampaignViewModel> CampaignViewModels,  // 開催中キャンペーン
    IReadOnlyList<QuestName> NewReleaseQuestNames     // 同時開放クエスト名一覧
)
```

**表示制御ロジック**：
- `RemainingTimeText`: `TimeSpanFormatter.FormatUntilEnd(RemainingAt)` でカウントダウン表示用テキストを生成
- Stagesはカルーセルで順次表示
- Unitsは最初の3体のみ表示

### EventQuestTopElementViewModelの構造

```csharp
public record EventQuestTopElementViewModel(
    MasterDataId MstStageId,                           // ステージID
    StageNumber StageNumber,                           // ステージ番号
    StageRecommendedLevel RecommendedLevel,            // 推奨レベル
    StageIconAssetPath StageIconAssetPath,             // ステージアイコン
    StageName StageName,                               // ステージ名
    StageConsumeStamina StageConsumeStamina,           // 消費スタミナ
    StageReleaseStatus StageReleaseStatus,             // 開放ステータス
    StageClearStatus StageClearStatus,                 // クリアステータス
    StageReleaseRequireSentence ReleaseRequireSentence, // 開放条件テキスト
    UnlimitedCalculableDateTimeOffset EndAt,           // ステージ期限
    StageClearCount DailyClearCount,                   // 本日のクリア回数
    ClearableCount DailyPlayableCount,                 // 1日あたりの実行回数制限
    SpeedAttackViewModel SpeedAttackViewModel,         // スピードアタック情報
    StageRewardCompleteFlag IsShowArtworkFragmentIcon, // フラグメント取得完了フラグ
    StageRewardCompleteFlag IsShowRewardCompleteIcon,  // 報酬完了フラグ
    ExistsSpecialRuleFlag ExistsSpecialRule,           // 特殊ルール存在フラグ
    InGameSpecialRuleAchievedFlag IsSpecialRuleAchieved, // 特殊ルール達成フラグ
    KomaBackgroundAssetPath EventTopBackGroundAssetPath, // ステージ背景
    StaminaBoostBalloonType StaminaBoostBalloonType    // スタミナブースト表示タイプ
)
```

### 画面初期化時の引数

```csharp
EventQuestTopViewController.Argument(MasterDataId MstQuestGroupId)
```

**引数の説明**：
- `MstQuestGroupId`: クエストグループID（イベントクエスト選択画面から渡される）

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **MstEvent**<br>イベント基本情報 | Id | イベントID |
| | Name | イベント名 |
| **MstQuest**<br>クエスト情報 | Id | クエストID |
| | Name | クエスト名 |
| | CategoryName | クエストカテゴリー名 |
| | QuestGroupId | クエストグループID |
| | QuestType | クエストタイプ（Event） |
| | StartDate | クエスト開始日時 |
| | EndDate | クエスト終了日時 |
| | Difficulty | クエスト難度 |
| **MstStage**<br>ステージ情報 | Id | ステージID |
| | StageNumber | ステージ番号 |
| | QuestId | クエストID（MstQuestとの紐付け） |
| | Name | ステージ名 |
| | RecommendedLevel | 推奨レベル |
| | StageConsumeStamina | 消費スタミナ |
| | StageAssetKey | ステージアイコンアセットキー |
| | ReleaseRequiredMstStageId | 開放に必要な前ステージID |
| | StartAt | ステージ開放日時 |
| | EndAt | ステージ期限 |
| | MstArtworkFragmentDropGroupId | アートワークフラグメントドロップグループID |
| | AutoLapType | オートラップタイプ |
| **MstStageEventSetting**<br>イベントステージ設定 | MstStageId | ステージID |
| | ClearableCount | 1日あたりの実行回数制限 |
| | EventTopBackGroundAssetKey | イベントステージトップ背景アセットキー |
| **MstCharacter** (mst_units)<br>キャラクターマスタ | Id | ユニットID |
| | Name | ユニット名 |
| | AssetKey | ユニット画像アセットキー |
| **MstEventDisplayUnit**<br>イベント表示ユニット | MstQuestId | クエストID |
| | MstUnitId | ユニットID（MstCharacterとの紐付け） |
| | SpeechBalloonText1 | セリフバルーンテキスト1 |
| | SpeechBalloonText2 | セリフバルーンテキスト2 |
| | SpeechBalloonText3 | セリフバルーンテキスト3 |
| **MstArtworkFragment**<br>アートワークフラグメント | Id | フラグメントID |
| | MstArtworkFragmentDropGroupId | ドロップグループID |
| **MstInGameSpecialRule**<br>ゲーム内特殊ルール | Id | ルールID |
| | MstStageId | ステージID |
| | InGameContentType | コンテンツタイプ（Stage） |
| **MstCampaign**<br>キャンペーン情報 | Id | キャンペーンID |
| | TargetQuestId | 対象クエストID |
| | CampaignTargetType | キャンペーン対象タイプ（EventQuest） |
| | CampaignType | キャンペーンタイプ（ChallengeCount等） |
| | EffectValue | 効果値（減少量や増加量） |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserStageEvent**<br>ユーザーイベントステージ進捗 | MstStageId | ステージID |
| | ResetClearCount | 本日のクリア回数 |
| **UserArtworkFragment**<br>ユーザーアートワークフラグメント | MstArtworkFragmentId | フラグメントID |
| **QuestStageReleaseAnimation**<br>ステージ開放演出状態 | NewReleaseMstStageId | 新規開放ステージID（演出表示用） |

**表の読み方**:
- 各テーブルの説明行は、テーブル名（太字）と日本語での説明
- 以下の行は使用されているカラムの説明

---

**最終更新**: 2025-12-24
