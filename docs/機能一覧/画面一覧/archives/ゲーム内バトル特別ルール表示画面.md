# ゲーム内バトル特別ルール表示画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ゲーム内バトル特別ルール表示画面 |
| **画面種別** | モーダル画面 |

## 概要

ステージや降臨バトルなどのゲーム内コンテンツに設定された特別ルールを表示するモーダル画面です。プレイヤーはこの画面で、ユニット編成時の制限条件（必要なユニット数、レアリティ制限、シリーズ指定など）や、バトル中の特別な勝敗条件（敵撃破数制限、制限時間など）、その他の特別なルール（スピードアタック、継続禁止など）を確認できます。

## プレイヤーができること

### ルール情報の確認

#### 編成制限ルール
- **ユニット数制限**: 編成できるユニット数の上限を確認
- **レアリティ制限**: 特定のレアリティ以上のユニットのみ使用可能かどうかを確認
- **シリーズ指定**: 特定の作品シリーズに所属するユニットのみ使用可能な場合、そのシリーズロゴを確認
- **ロールタイプ制限**: 特定のロールタイプ（アタッカー、ディフェンダーなど）のみ使用可能な場合を確認
- **攻撃範囲制限**: 特定の攻撃範囲を持つユニットのみ使用可能な場合を確認
- **サモンコスト制限**: ユニットのサモンコストに上下限がある場合を確認

#### バトル特別ルール
- **敵撃破ルール**: 敵を倒すことで勝利する条件（合計n体の敵撃破、特定の敵撃破など）を確認
- **制限時間**: 時間内に敵を倒さないと敗北する場合、制限時間を確認
- **オブジェクト防衛**: 防衛対象を守る必要があるかどうかを確認
- **敵タワー無敵**: 敵タワーがダメージを受けない場合を確認
- **スピードアタック**: 一定時間内にバトルを終わらせる必要があるかどうかを確認
- **継続禁止**: バトル中の継続機能が使用できない場合を確認
- **敵タワーHP変更**: 敵タワーのHPが通常と異なる場合を確認

### 画面の閉じ方
- **「×」ボタン** または **背景タップ**: 画面を閉じる

## 画面の要素

### ヘッダー部分
- **「×」閉じるボタン**: 画面を閉じる
- **セクションタイトル**: 「編成制限」「その他のルール」などのセクション分け

### メイン表示エリア

#### 編成制限セクション（該当する場合のみ表示）
編成時に守る必要のある制限条件を表示：

- **ユニット数**
  - 「編成可能ユニット数: n体」という形式で表示

- **レアリティ制限**
  - 対象のレアリティアイコンを表示
  - 複数指定されている場合は複数個表示

- **シリーズ指定**
  - シリーズロゴ（作品のアイコン）を表示
  - 複数シリーズが指定されている場合は複数個表示

- **ロールタイプ制限**
  - 対象のロールアイコン（アタッカー、ディフェンダーなど）を表示
  - 複数指定されている場合は複数個表示

- **攻撃範囲制限**
  - 対象の攻撃範囲アイコン（近距離、遠距離など）を表示
  - 複数指定されている場合は複数個表示

- **サモンコスト制限**
  - 「コスト○以上」「コスト○以下」などの条件を表示

#### その他のルールセクション（該当する場合のみ表示）
バトル中の特別なルールを表示：

- **敵撃破ルール**
  - 「敵n体を撃破すると勝利」という形式で表示
  - 特定の敵（敵ボスなど）指定がある場合は「【敵名】n体を撃破すると勝利」と表示

- **制限時間**
  - 「制限時間: mm分ss秒」という形式で表示
  - 時間経過で勝利 or 敗北 のどちらになるかを表示

- **オブジェクト防衛**
  - 「防衛対象を守る必要があります」と表示

- **敵タワー無敵**
  - 「敵タワーはダメージを受けません」と表示

- **スピードアタック**
  - 「スピードアタック: 指定時間内にバトル終了を目指す」と表示

- **継続禁止**
  - 「継続は使用できません」と表示

- **敵タワーHP変更**
  - 「敵タワーHP: n」という形式で表示

### フッター部分
表示されるルールがない場合：
- 「特別なルールはありません」というメッセージを表示

## 画面遷移

### この画面への遷移
- **ホーム画面**: ステージ詳細からルール確認ボタンをタップ
- **ホームパーティ編成画面**: ステージを選択してルール確認ボタンをタップ
- **イベントクエスト一覧画面**: ステージを選択してルール確認ボタンをタップ
- **降臨バトル画面**: 降臨バトル詳細からルール確認ボタンをタップ
- **ユニット選択画面**: ステージ情報がある場合、ルール確認ボタンをタップ

### この画面からの遷移
- **「×」ボタンをタップ**: 呼び出し元の画面に戻る
- **背景タップ**: 呼び出し元の画面に戻る

## ゲーム仕様・制約事項

### ルール表示の判定
特別ルールが存在するかどうかは、以下の条件で判定されます：

- **MstInGameSpecialRuleが設定されている**: 編成制限ルールが存在
- **MstDefenseTargetが存在する**: オブジェクト防衛ルールが存在
- **MstEnemyOutpostのIsDamageInvalidationがTrue**: 敵タワー無敵ルールが存在
- **MstStageEndConditionが設定されている**:
  - `DefeatedEnemyCount`: 敵撃破ルールが存在
  - `DefeatUnit`: 特定敵撃破ルールが存在
  - `TimeOver`: 制限時間ルールが存在

### ルール表示の論理

#### スピードアタックについての注意
- **メインクエスト（QuestType.Normal）**: スピードアタックは特別ルール扱いしない（常時表示なし）
- **その他のクエスト**: スピードアタックが設定されている場合は表示

#### 編成制限ルールの有無
`ExistsFormationRule`フラグで判定：
- `True`: 編成制限ルールが1つ以上存在 → 「編成制限」セクションを表示
- `False`: 編成制限ルールが存在しない → 「編成制限」セクションを非表示

#### その他のルールの有無
`ExistsOtherRule`フラグで判定：
- `True`: 以下のいずれかが該当
  - オブジェクト防衛ルール
  - 敵撃破ルール
  - 特定敵撃破ルール
  - 敵タワー無敵ルール
  - スピードアタック
  - 敵タワーHP変更ルール
  - 継続禁止ルール
- `False`: 上記のいずれも該当しない

#### ルール情報の有無チェック
ViewModel のすべてのプロパティが空の場合、特別ルール画面そのものが表示されず、単に「特別なルールはありません」と表示されます。

### 画面初期化時の引数

```csharp
InGameSpecialRuleViewController.Argument(
    SpecialRuleTargetMstId,           // ステージ/降臨バトルのマスタID
    SpecialRuleContentType,           // Stage または AdventBattle
    IsFromUnitSelect                  // ユニット選択画面からの遷移かどうか
)
```

**IsFromUnitSelectフラグの役割**：
- `True`: ユニット選択画面から遷移 → ヘッダーコメントで「編成制限に注意してください」という警告表示
- `False`: その他の画面から遷移 → 通常の説明表示

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/InGameSpecialRulePresenter.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Presentation/Presenters/InGameSpecialRulePresenter.cs)

#### ViewController
- `Presentation/Views/InGameSpecialRuleViewController.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Presentation/Views/InGameSpecialRuleViewController.cs)

#### View
- `Presentation/Views/InGameSpecialRuleView.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Presentation/Views/InGameSpecialRuleView.cs)

#### ViewModel
- `Presentation/ViewModels/InGameSpecialRuleViewModel.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Presentation/ViewModels/InGameSpecialRuleViewModel.cs)

#### UseCase
- `Domain/UseCases/InGameSpecialRuleUseCase.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Domain/UseCases/InGameSpecialRuleUseCase.cs)

#### Translator
- `Presentation/Translators/InGameSpecialRuleViewModelTranslator.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Presentation/Translators/InGameSpecialRuleViewModelTranslator.cs)

#### ModelFactory
- `Domain/ModelFactories/InGameSpecialRuleModelFactory.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Domain/ModelFactories/InGameSpecialRuleModelFactory.cs)

#### Evaluator
- `Domain/Evaluator/InGameSpecialRuleEvaluator.cs` (/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGameSpecialRule/Domain/Evaluator/InGameSpecialRuleEvaluator.cs)

### InGameSpecialRuleViewModelの構造

ゲーム内バトルの特別ルール情報を表現するViewModel。以下のデータ構造で構成されています：

#### 編成制限関連
- `SeriesLogoImagePathList`: シリーズ指定時のシリーズロゴ画像パスリスト
- `UnitRarities`: レアリティ制限時の対象レアリティリスト
- `UnitRoleTypes`: ロールタイプ制限時の対象ロールタイプリスト
- `UnitAmount`: ユニット数制限時の編成可能ユニット数
- `UnitAttackRangeTypes`: 攻撃範囲制限時の対象攻撃範囲リスト

#### バトルルール関連
- `EnemyDestructionCount`: 敵撃破ルール時の撃破必要敵数
- `IsEnemyDestruction`: 敵撃破ルールの有無フラグ
- `SpecificEnemyDestructionTargetName`: 特定敵撃破ルール時の敵キャラ名
- `SpecificEnemyDestructionCount`: 特定敵撃破ルール時の撃破必要敵数
- `IsSpecificEnemyDestruction`: 特定敵撃破ルールの有無フラグ
- `TimeLimit`: 制限時間ルール時の制限時間情報
- `IsDefenseTarget`: オブジェクト防衛ルールの有無フラグ
- `IsEnemyOutpostDamageInvalidation`: 敵タワー無敵ルールの有無フラグ
- `IsStartOutpostHp`: 敵タワーHP変更ルールの有無フラグ
- `StartOutpostHp`: 敵タワーHP変更ルール時の敵タワーHP値
- `IsNoContinue`: 継続禁止ルールの有無フラグ
- `IsSpeedAttack`: スピードアタックの有無フラグ

#### ルール集約フラグ
- `ExistsFormationRule`: 編成制限ルール存在フラグ（PartyUnitNum, PartyRarity, PartySeries, PartyAttackRangeType, PartyRoleType, PartySummonCostUpperEqual, PartySummonCostLowerEqualのいずれかが存在）
- `ExistsOtherRule`: その他のルール存在フラグ（防衛、敵撃破、敵タワー無敵、スピードアタック、敵タワーHP、継続禁止のいずれかが存在）
- `IsFromUnitSelect`: ユニット選択画面からの遷移フラグ

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **MstInGameSpecialRule**<br>バトル特別ルール設定 | Id | ルール設定ID |
| | ContentType | インゲームコンテンツタイプ（Stage or AdventBattle） |
| | TargetId | 各コンテンツのマスタID（ステージID or 降臨バトルID） |
| | RuleType | ルールタイプ（PartyUnitNum, PartyRarity, PartySeries等） |
| | RuleValue | ルール値（レアリティ値、シリーズID等） |
| | StartAt | ルール開始日時 |
| | EndAt | ルール終了日時 |
| **MstStage**<br>ステージマスタ | Id | ステージID |
| | MstQuestId | クエストID（MstQuestと紐付け） |
| | MstInGameId | インゲームID（敵配置情報と紐付け） |
| | MstEnemyOutpostId | 敵タワーID（MstEnemyOutpostと紐付け） |
| | MstDefenseTargetId | 防衛対象ID（防衛ルールの有無判定） |
| **MstQuest**<br>クエストマスタ | Id | クエストID |
| | QuestType | クエストタイプ（Normal, Event等） |
| **MstStageEndCondition**<br>ステージ終了条件 | MstStageId | ステージID |
| | StageEndType | 終了タイプ（Victory, Defeat, Finish） |
| | ConditionType | 条件タイプ（DefeatedEnemyCount, DefeatUnit, TimeOver等） |
| | ConditionValue1 | 条件値1（撃破敵数、敵ID、制限時間（秒）） |
| | ConditionValue2 | 条件値2（複数条件が必要な場合） |
| **MstEnemyOutpost**<br>敵タワー設定 | Id | 敵タワーID |
| | IsDamageInvalidation | ダメージ無敵フラグ |
| | Hp | 敵タワーHP |
| **MstEnemyCharacter**<br>敵キャラマスタ | Id | 敵キャラID |
| | Name | 敵キャラ名（特定敵撃破ルール時に表示） |
| | MstSeriesId | シリーズID（シリーズ指定ルール時に使用） |
| **MstSeries**<br>シリーズマスタ | Id | シリーズID |
| | SeriesAssetKey | シリーズロゴアセットキー（UI表示用） |
| **MstAdventBattle**<br>降臨バトルマスタ | Id | 降臨バトルID |
| | MstEnemyOutpostId | 敵タワーID（MstEnemyOutpostと紐付け） |
| | MstDefenseTargetId | 防衛対象ID（防衛ルールの有無判定） |

#### ユーザーデータ（GameFetch）

なし（この画面はマスタデータのみで構成）

---

**最終更新**: 2025-12-24
