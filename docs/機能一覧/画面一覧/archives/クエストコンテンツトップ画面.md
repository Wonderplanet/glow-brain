# クエストコンテンツトップ画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | クエストコンテンツトップ画面 |
| **画面種別** | メイン画面 |

## 概要

ゲーム内で挑戦できるすべてのクエスト・バトルコンテンツの入口となる画面です。プレイヤーは、イベントクエスト、強化クエスト（日替わり）、降臨バトル、ランクマッチ（PvP）といった複数のコンテンツを一覧表示で確認できます。各コンテンツの開催状況、挑戦回数の残り状況、終了までの時間などをひとめで把握でき、プレイしたいコンテンツを選択して進むことができます。

## プレイヤーができること

### コンテンツの選択と進行

#### イベントクエストへの進行
- 現在開催中のイベントクエストを一覧表示
- イベント名、バナー画像、開催期間を確認
- イベントカードをタップして、難易度別のクエスト選択画面へ遷移
- ミッションの未受取報酬があればバッジで表示
- イベントに紐付いたキャンペーン情報（挑戦回数ボーナスなど）を表示

#### 強化クエストへの進行
- 日替わり強化クエスト（コイン獲得クエスト）を表示
- コイン、経験値などを獲得できるクエストを確認
- クエストあたりの挑戦回数制限と、本日の残り挑戦回数を表示
- 広告視聴で挑戦回数を追加できる場合、その情報も表示
- リセット時間（翌日への更新時刻）をカウントダウン表示
- 強化クエストの「強化クエスト」カードをタップして実行

#### 降臨バトルへの進行
- 現在開催中または開催予定の降臨バトルを表示
- ボス戦のような高難度バトルで、ランキング競争がある
- ランキング結果の表示や、開催前のプレビュー情報を確認可能
- 挑戦回数の制限と、本日の残り挑戦回数を表示
- 挑戦回数リセット時刻をカウントダウン表示
- 降臨バトル開催時の参加条件（クリア要件など）を確認
- 「降臨バトル」カードをタップして詳細画面へ進む
- ランキングボタンから最新ランキングを確認可能

#### ランクマッチ（PvP）への進行
- プレイヤー対戦の「ランクマッチ」をコンテンツとして提供
- シーズンの開催状況（開催中、集計中、未開催など）を表示
- 参加には開放条件（特定ステージのクリアなど）がある場合、その旨を表示
- 挑戦チケット（ガチャチケット等ではなく、対戦用の専用チケット）の保有数を表示
- チケット回復時刻をカウントダウン表示
- 「ランクマッチ」カードをタップして対戦画面へ進む

### 情報表示と状態管理

#### 開催状況と開放状態の表示
- **開催中**: ボタンが有効でコンテンツを選択可能
- **開催予定**: グレーアウト表示で、開始まで時間をカウントダウン
- **開催終了**: グレーアウト表示で、前回のランキングやイベント情報をプレビュー表示
- **参加条件未達**: ロックアイコン表示で、開放条件を説明するトーストを表示
- **ランキング集計中**: ランクマッチで、最新結果集計中を表示し、操作不可

#### バッジと通知
- イベントにミッションの未受取報酬がある場合、赤い「通知」バッジを表示
- イベント内でキャンペーンや特別な特典がある場合、その旨を表示

#### 時間管理
- イベント終了時刻、挑戦回数リセット時刻など、複数の時間情報をカウントダウン表示
- プレイヤーが次のアクションを計画できるよう、残り時間を明確に表示

### その他の操作

- **戻るボタン**: ホーム画面に戻る
- **リロード**: 画面データを更新（イベント開催状況などの最新情報を取得）
- **スクロール**: コンテンツが複数ある場合、上下スクロールで一覧を参照

## 画面の要素

### 表示セクション

表示順番は固定で、以下の順序となっています：

1. **イベントセクション**
   - 開催中のイベントクエストをカード形式で並列表示
   - イベント名、バナー画像、終了時刻を表示
   - 複数イベント同時開催時は横並び表示（スクロール可能）

2. **強化クエストセクション**
   - 開催中の強化クエストをカード形式で表示
   - コイン、経験値などの種別ごとに分かれている場合あり
   - 本日の挑戦回数と残り回数、リセット時刻を表示

3. **ランクマッチセクション**
   - PvPの「ランクマッチ」をカード形式で表示
   - 現在のシーズン情報と参加状態を表示

4. **降臨バトルセクション**
   - 現在開催中または開催予定の降臨バトルをカード形式で表示
   - 複数同時開催の場合は最も早い開始予定のものを優先表示

### コンテンツカード（共通要素）

各コンテンツは以下の要素を含むカード形式で表示：

- **コンテンツ名**
  - イベント名、強化クエスト名など
  - タップ時の遷移先が変わる

- **バナー画像またはアイコン**
  - イベントの場合：バナー画像
  - 降臨バトルの場合：ボス画像やアートワーク
  - 強化クエストの場合：コンテンツアイコン

- **開催期間と残り時間**
  - 「残り○日○時間○分」形式でカウントダウン表示
  - 開催前の場合は「○日後に開始」と表示

- **挑戦回数情報**（強化クエスト、降臨バトル、ランクマッチのみ）
  - 「残り○回」「広告で追加」など
  - リセット時刻を表示

- **参加条件**（降臨バトル、ランクマッチのみ）
  - 条件未達時にロックアイコンとテキスト表示
  - 条件達成済みは表示なし

- **通知バッジ**（イベントのみ）
  - ミッション未受取時に赤いバッジを表示

- **ランキング情報**（降臨バトルのみ）
  - ランキングボタン：開催終了後も前回ランキングを表示可能

## 画面遷移

### この画面への遷移
- **ホーム画面（メイン画面）**: ホームメニューの「クエスト」をタップ
- **イベント通知**: イベント開始時の通知から遷移

### この画面からの遷移
- **イベントクエスト選択画面**: イベントカードをタップ
  - 難易度別のクエスト一覧を表示
  - 特定の難易度を選択して実行へ

- **強化クエスト実行画面**: 強化クエストカードをタップ
  - 挑戦回数確認・消費確認ダイアログを表示
  - 承認後、クエスト実行へ

- **降臨バトル詳細画面**: 降臨バトルカードをタップ
  - ボス情報、推奨パーティなど詳細情報を表示
  - 開催予定の場合はプレビュー表示
  - 実行ボタンから戦闘開始へ

- **降臨バトルランキング画面**: 降臨バトルのランキングボタンをタップ
  - 最新のランキング結果を表示
  - プレイヤーのスコアと順位を確認可能

- **ランクマッチ画面**: ランクマッチカードをタップ
  - マッチング画面や戦闘画面へ進む

- **メンテナンス画面**: コンテンツメンテナンス中の場合
  - メンテナンス情報ダイアログを表示
  - チュートリアル中の場合は自動的にチュートリアルを終了

## ゲーム仕様・制約事項

### コンテンツの表示判定

#### イベントクエスト
- **表示対象**: 現在時刻が開始～終了期間内のイベント
- **複数同時開催対応**: 複数イベント表示可能
- **表示順**: 開始時刻が最新のものから降順（新しいイベントが上位）
- **説明**: イベント終了後は自動的に一覧から削除される

#### 強化クエスト
- **表示対象**: 開催日が今日（日替わり更新後）のクエスト
- **複数表示**: コインクエスト、経験値クエストなど、複数種別が存在
- **挑戦回数制限**: 1日あたりの上限回数を超えると「挑戦不可」状態に
- **広告ボーナス**: 広告視聴で追加の挑戦回数を獲得可能（「広告で追加」と表示）
- **リセット時刻**: 毎日決まった時刻に回数がリセット

#### 降臨バトル
- **表示優先度**: 開催中のものを優先、ない場合は開催予定のものを表示
- **単一表示**: 複数同時開催でも、最初の1つだけ表示（チュートリアル制約による）
- **状態遷移**:
  - 開催予定 → 開催中 → 集計中 → 開催終了
  - 各状態で表示と操作が異なる

#### ランクマッチ
- **シーズン制**: 現在のシーズン情報を表示
- **参加条件**: 特定ステージクリアやランク要件がある場合、条件達成まで操作不可
- **集計期間**: ランキング集計中（通常シーズン終了後）は参加不可
- **チケット回復**: 対戦チケットは回復タイマーに従ってリセット

### 挑戦回数とリセット

#### 強化クエスト
- **通常回数**: 1日あたりの上限（例：10回）
- **広告回数**: 広告視聴で追加可能な回数（例：10回）
- **回数カウント**: 本日のリセット時刻（例：23:59）から翌日のリセット時刻まで継続

#### 降臨バトル
- **リセット時刻**: 強化クエストと同一の日替わり時刻
- **回数超過時の表示**: 「挑戦回数の上限に達しました」と表示
- **継続挑戦**: 上限到達後、次のリセット時刻までボタンがグレーアウト

### 参加条件と開放

#### 降臨バトル
- **ランク要件**: プレイヤーランクが一定以上必要な場合あり
- **ステージクリア要件**: 特定ステージをクリアしていないと参加不可
- **条件表示**: ロックアイコンで施錠状態を表示
- **条件説明**: タップで「XXをクリアしてください」などのメッセージ表示

#### ランクマッチ（PvP）
- **参加条件**: 特定ステージクリア（例：メインストーリー第1章第1話クリア）
- **ランク要件**: プレイヤーランクが一定以上必要な場合あり
- **未達時**: 「参加にはランクマッチの参加条件を満たす必要があります」とトースト表示

### メンテナンスと無効化

- **コンテンツメンテナンス**: 各コンテンツ（強化クエスト、降臨バトル、PvP）ごとにメンテナンス情報を管理
- **メンテナンス中の表示**: コンテンツカードはグレーアウト
- **メンテナンスダイアログ**: タップ時に「メンテナンス中です」ダイアログを表示
- **チュートリアルの自動終了**: メンテナンスダイアログ表示時、進行中のチュートリアルを自動終了

### ランキング表示

#### 降臨バトル
- **表示条件**: ランキングボタンが表示されるのは、ランキング集計が完了している場合
- **最新ランキング**: 現在のシーズンで最新のランキング結果を表示
- **プレイヤーのスコア**: 自プレイヤーのスコアと現在の順位を表示
- **タイミング**: 開催終了後、集計完了まではランキング表示は不可

### キャンペーン表示

- **イベント内キャンペーン**: クエスト実行時に獲得報酬が増加するキャンペーン
- **表示方法**: イベントカード上に「ボーナス内容」を表示
- **例**: 「挑戦回数を+1増加」「獲得経験値が2倍」など

### 時間表示形式

- **残り時間**: 「残り○日○時間○分」形式
- **開始予定**: 「あと○日○時間○分で開始」
- **更新予定**: 「あと○時間○分で更新」
- **リセット時刻**: 24時間制で表示（例：「翌04:00にリセット」）

## 技術参考情報

### 画面実装パス
`Assets/GLOW/Scripts/Runtime/Scenes/QuestContentTop/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenter/QuestContentTopPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/QuestContentTop/Presentation/Presenter/QuestContentTopPresenter.cs)

#### ViewController
- `Presentation/ViewController/QuestContentTopViewController.cs`

#### ViewModels
- `Presentation/ViewModel/QuestContentTopViewModel.cs` - 画面全体のViewModel
- `Presentation/ViewModel/QuestContentTopSectionViewModel.cs` - セクション（イベント、強化、PvP、降臨）ごとのViewModel
- `Presentation/ViewModel/QuestContentCellViewModel.cs` - 個別コンテンツカードのViewModel

#### UseCase
- `Domain/QuestContentTopUseCase.cs` - 画面初期化とデータ更新のメインロジック
- `Domain/GetLatestEventUseCase.cs` - 最新イベント情報取得
- `Domain/GetEventNotificationUseCase.cs` - イベント通知・バルーン情報取得
- `Domain/GetRecentAdventBattleRankingUseCase.cs` - 降臨バトルランキング取得
- `Domain/UpdateBadgeForContentTopUseCase.cs` - 各イベントのミッション未受取バッジ更新
- `Domain/CheckOpenAdventBattleUseCase.cs` - 降臨バトル開催状況確認
- `Domain/CheckPvpOpenUseCase.cs` - PvP開催状況確認

#### Translator
- `Presentation/Translator/QuestContentTopViewModelTranslator.cs` - UseCaseModelからViewModelへの変換

#### Factories
- `Domain/Factory/QuestContentTopModelFactory.cs` - イベント、強化クエスト、降臨バトルのUseCaseModel作成
- `Domain/Factory/QuestContentTopPvpModelFactory.cs` - PvPのUseCaseModel作成
- `Domain/Factory/QuestContentReleaseRequiredSentenceFactory.cs` - 開放条件メッセージ生成

#### Enums
- `Domain/enums/QuestContentTopSectionType.cs` - セクション種別（Daily, EndContent, Event, Pvp, Other）
- `Domain/enums/QuestContentTopElementType.cs` - コンテンツ種別（Pvp, Enhance, Event, AdventBattle, Limited, Other）
- `Domain/enums/QuestContentOpeningStatusAtTimeType.cs` - 時間ベースの開催状態（Opening, BeforeOpen, OutOfLimit, Totalizing）
- `Domain/enums/QuestContentOpeningStatusAtUserStatus.cs` - ユーザーベースの参加状態（None, RankLocked, StageLocked, OverLimitChallengeCount）
- `Domain/enums/QuestContentTopChallengeType.cs` - 挑戦タイプ（Normal, Ad, Ticket）

### QuestContentTopViewModelの構造

画面全体のViewModel：
- `SectionViewModels`: リスト形式で複数セクション（イベント、強化、PvP、降臨）を保持
- `CreateAllItems()`: すべてのセクションから個別カードViewModelを取り出すヘルパーメソッド

### QuestContentCellViewModelの主要プロパティ

| プロパティ | 説明 |
|-----------|------|
| `ElementType` | コンテンツ種別（イベント、強化クエスト、降臨バトル、PvP） |
| `OpeningStatusModel` | 開催状況（時間ベース）と参加状態（ユーザーベース） |
| `ChallengeCount` | 本日の残り挑戦回数 |
| `ChallengeType` | 挑戦タイプ（通常/広告/チケット） |
| `ChallengeResetTime` | リセット（更新）までの時間 |
| `LimitTime` | 終了（または開始）までの時間 |
| `HasRanking` | ランキング表示フラグ（降臨バトル） |
| `HasRankingNotification` | ランキング更新通知フラグ |
| `HasBannerBadgeNotification` | バナー通知フラグ（イベントミッション未受取など） |
| `MstEventId` | イベントID（イベント/キャンペーン用） |
| `EventName` | イベント/コンテンツ名 |
| `BannerAssetPath` | バナー画像パス（イベント用） |
| `CampaignViewModels` | キャンペーン情報リスト |

### 表示制御ロジック

**主要な判定メソッド**（QuestContentCellViewModel）:
- `IsOpening`: 開催中で参加可能状態か
- `IsLimitTimeVisible`: 残り時間を表示するか
- `IsShowPrevRanking`: 前回のランキング結果を表示するか
- `IsGrayOutVisible()`: グレーアウト表示するか
- `IsButtonInteractable()`: ボタンを有効にするか
- `ShouldShowLockObj()`: ロックアイコンを表示するか
- `ShouldShowLimitChallengeObj()`: 挑戦回数制限アイコンを表示するか
- `IsChallengeTextVisible()`: 挑戦回数テキストを表示するか
- `CanExecuteTappedAction()`: タップ時の処理を実行できるか

### 画面初期化と更新フロー

1. **ViewWillAppear時の処理**:
   - BGM再生（quest_content_top）
   - EventQuestWireFrameの登録
   - `Refresh()`呼び出し

2. **Refresh()の処理**:
   - `QuestContentTopUseCase.UpdateAndGetQuestContentTopUseCaseModel()` - 全セクションデータ取得
   - ViewModelへの変換
   - `UpdateEventMissionBadge()` - イベントミッション未受取バッジ非同期更新

3. **アクセス日時の更新**:
   - `ContentTopAccessPreferenceRepository.SaveAccessTime()` - プレイヤーの最終アクセス時刻を記録

### 画面オープン時の遷移先処理

#### イベントクエスト選択へ
- `EventQuestWireFrame.SubscribeContentTopViewController()` でコンテンツトップの状態を購読
- イベント開催/終了時に自動で画面データをリフレッシュ

#### 降臨バトルへ
- 開催状況を `CheckOpenAdventBattleUseCase.IsOpen()` で確認
- 非開催時は `AdventBattleWireFrame.ShowCloseMessage()` でメッセージ表示

#### PvP（ランクマッチ）へ
- 開催状況を `CheckPvpOpenUseCase.GetModel()` で確認
- 集計中・非開催・参加条件未達など、各種メッセージを表示

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| **MstEvent** | **mst_events**<br>イベントマスタ | Id, Name, StartAt, EndAt, MstSeriesId, AssetKey を取得。開催中のイベントを判定・表示 |
| | | 複数イベント同時開催対応で、開始時刻の最新順でソート |
| **MstQuest** | **mst_quests**<br>クエストマスタ | QuestType (Enhance), StartDate, EndDate を取得。強化クエストの表示対象判定 |
| | | Difficulty を取得し、キャンペーン効果（挑戦回数追加など）を計算 |
| **MstStage** | **mst_stages**<br>ステージマスタ | 強化クエストのステージごとに使用。ステージIDと紐付け |
| **MstAdventBattle** | **mst_adventure_battles**<br>降臨バトルマスタ | Id, StartDateTime, EndDateTime を取得。開催状況の判定に使用 |
| | | 複数同時開催でも最初の1つだけ表示する仕様 |
| **MstConfig** | **mst_configs**<br>設定マスタ | EnhanceQuestChallengeLimit, EnhanceQuestChallengeAdLimit を取得。強化クエストの回数制限を取得 |
| | | キャンペーン効果による追加回数を計算 |
| **MstPvp** | **mst_pvps**<br>PvP設定マスタ | Name, ItemChallengeCost を取得。シーズン情報と対戦コスト（チケット）を表示 |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| **UserStageEnhance** | **user_stage_enhances**<br>ユーザーステージ強化 | MstStageId, ResetChallengeCount, ResetAdChallengeCount を取得。本日の挑戦回数カウント |
| **UserPvpStatus** | **user_pvp_statuses**<br>ユーザーPvP状態 | 対戦チケット残数、順位情報などを取得。ランクマッチの参加状態表示 |
| **SysPvpSeason** | **sys_pvp_seasons**<br>PvPシーズン情報 | Id, StartAt, EndAt を取得。現在シーズンの開催期間をカウントダウン表示 |
| **BadgeModel** | **（ゲーム内キャッシュ）** | UnreceivedMissionEventRewardCountById() でイベント別の未受取ミッション数をカウント。バッジ表示判定 |

### 呼び出しているAPI

#### [画面初期化・リフレッシュ]
- **GET `/api/game/version`**: ゲームバージョン情報取得
  - 用途: マスタデータと運営データの更新確認。`QuestContentTopUseCase.UpdateAndGetQuestContentTopUseCaseModel()` 呼び出し時に間接的に必要

#### [降臨バトルランキング取得]
- **GET `/api/adventure_battle/ranking`**: 降臨バトルの最新ランキング情報取得
  - パラメータ: なし（最新シーズン自動取得）
  - 用途: 「ランキング」ボタンをタップ時に、`GetRecentAdventBattleRankingUseCase.GetRecentAdventBattleRanking()` で呼び出し

#### [PvP状態確認]
- 直接的なAPI呼び出しなし
  - 用途: `CheckPvpOpenUseCase` は GameFetch（ゲーム起動時に取得済みのユーザーデータ）から PvP状態を判定

#### [イベント通知取得]
- 直接的なAPI呼び出しなし（現在未実装の可能性）
  - 用途: `GetEventNotificationUseCase` は、開催中イベントの情報とキャラクタースタンド画像を組み合わせてバルーン表示

---

**最終更新**: 2025-12-24
