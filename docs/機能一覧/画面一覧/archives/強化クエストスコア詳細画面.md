# 強化クエストスコア詳細画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 強化クエストスコア詳細画面 |
| **画面番号** | 42-5-3-1 |
| **画面種別** | ダイアログ（モーダル） |

## 概要

強化クエストでプレイヤーが獲得できるスコアの閾値と報酬内容を確認するダイアログです。プレイヤーが強化クエストにおいて特定のスコア以上を達成した場合に得られるコイン報酬の詳細情報を表示します。スコアごとに異なるコイン倍率（Small, Medium, Large, ExtraLarge）が適用されることを確認できます。

## プレイヤーができること

### スコア報酬一覧を確認する

#### スコア閾値の確認
- **スコアの最低ライン**: 各報酬レベルに必要なスコアを表示
- **スコア表示形式**: "○○,○○○ pt" 形式で表示
- **複数レベル**: 複数のスコア閾値が存在し、高いスコアほど上位に表示

#### コイン報酬の確認
- **報酬倍率**: 各スコア閾値に対応するコイン倍率を表示
- **報酬サイズアイコン**: Small（小）、Medium（中）、Large（大）、ExtraLarge（最大）をアイコンで表示
- **実際の獲得量**: 倍率に基づいて計算された具体的なコイン獲得量

### ダイアログを閉じる

- **戻るボタン**: タップしてダイアログを閉じ、強化クエストトップ画面に戻る

## 画面の要素

### ヘッダー部分
- ダイアログのタイトル（画面上部）
- 戻るボタン

### メイン表示エリア
- **スコア報酬一覧リスト**
  - スクロール可能なリスト形式
  - リスト上部から順に、スコア閾値が高い順に表示
  - 各リスト行の構成：
    - スコア閾値（左側）: "○○,○○○ pt ~"
    - コイン倍率（中央）: 倍数を示す数値（例："x2"）
    - 報酬アイコン（右側）: Small/Medium/Large/ExtraLargeを示すアイコン

### 画面遷移

#### この画面への遷移
- **強化クエストトップ画面**: ヘルプボタンをタップしたときに表示

#### この画面からの遷移
- **強化クエストトップ画面**: 戻るボタンをタップ
  - 遷移後、スコア詳細ダイアログが閉じられる

## ゲーム仕様・制約事項

### スコア報酬の仕組み
- 強化クエストで獲得したスコアが特定の閾値に達すると、コイン報酬を獲得
- スコア閾値は複数段階で設定されている
- 複数の閾値を満たす場合は、最も高い閾値の報酬を獲得
- 例）300ptの閾値と500ptの閾値がある場合、550ptを獲得すれば500ptの報酬を取得

### コイン倍率について
- 報酬は"倍率"で表現される（実際のコイン量は基礎値×倍率で計算）
- 4段階の倍率レベルが存在：
  - **Small（小）**: 最小倍率
  - **Medium（中）**: 通常倍率
  - **Large（大）**: 高倍率
  - **ExtraLarge（最大）**: 最高倍率

### スコア表示
- スコアは3桁区切りで表示（例："1,000 pt", "10,000 pt"）
- 表示される各スコアは「○○以上」という意味（ダイアログ上の「~」で示唆）

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/EnhanceQuestScoreDetailPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Presentation/Presenters/EnhanceQuestScoreDetailPresenter.cs)
  - `OnViewDidLoad()`: 画面ロード時にスコア詳細情報を取得して表示
  - `OnBackButtonTapped()`: 戻るボタンの処理

#### ViewController
- `Presentation/Views/EnhanceQuestScoreDetailViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Presentation/Views/EnhanceQuestScoreDetailViewController.cs)
  - `Setup()`: ViewModelを受け取ってUIを初期化

#### View
- `Presentation/Views/EnhanceQuestScoreDetailView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Presentation/Views/EnhanceQuestScoreDetailView.cs)
  - UICollectionViewを使用してスコア報酬リストを表示
  - リストの管理とセルの作成を担当

#### ListCell
- `Presentation/Views/EnhanceQuestScoreDetailListCell.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Presentation/Views/EnhanceQuestScoreDetailListCell.cs)
  - `SetUpScore()`: スコア閾値を表示
  - `SetUpRewardMultiplier()`: コイン倍率を表示
  - `SetUpRewardIcon()`: 報酬サイズアイコンを表示

#### ViewModel
- `Presentation/ViewModels/EnhanceQuestScoreDetailViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Presentation/ViewModels/EnhanceQuestScoreDetailViewModel.cs)
  - `Cells`: スコア報酬リスト（EnhanceQuestScoreDetailCellViewModel の読み取り専用リスト）

#### Translator
- `Presentation/Translators/EnhanceQuestScoreDetailViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Presentation/Translators/EnhanceQuestScoreDetailViewModelTranslator.cs)
  - Domain層のModel → Presentation層のViewModelへの変換

#### UseCase
- `Domain/UseCases/EnhanceQuestScoreDetailUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestScoreDetail/Domain/UseCases/EnhanceQuestScoreDetailUseCase.cs)
  - `GetScoreDetail()`: マスタデータからスコア詳細情報を取得

### EnhanceQuestScoreDetailViewModelの構造

```csharp
public record EnhanceQuestScoreDetailViewModel(
    IReadOnlyList<EnhanceQuestScoreDetailCellViewModel> Cells);
```

各セル（EnhanceQuestScoreDetailCellViewModel）の構成：

```csharp
public record EnhanceQuestScoreDetailCellViewModel(
    EnhanceQuestMinThresholdScore EnhanceQuestMinThresholdScore,  // スコア閾値
    ItemAmount CoinRewardAmount,                                  // コイン倍率
    CoinRewardSizeType CoinRewardSizeType);                       // 報酬アイコンタイプ
```

**表示制御ロジック**：
- `Cells`リストの個数分だけリストセルが作成される
- スコア閾値が高い順に表示（UseCase内で降順ソート）
- 最初のロード時にリストのスクロール位置を最上部にリセット

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **MstStageEnhanceRewardParam**<br>強化クエストスコア報酬パラメータ | MinThresholdScore | スコアの最低閾値。この値以上を達成すると対応する報酬を獲得 |
| | CoinRewardAmount | 獲得するコインの倍率。ItemAmountで管理される |
| | CoinRewardSizeType | 報酬の視覚的なサイズ区分（Small, Medium, Large, ExtraLarge） |

**補足**:
- `MstStageEnhanceRewardParam` テーブルはゲーム起動時にマスタデータとしてメモリに読み込まれる
- クライアント実装での定義：`MstStageEnhanceRewardParamModel`
- 画面に表示される際は高い順にソートされて表示される

#### ユーザーデータ（GameFetch）

なし（この画面はマスタデータのみで構成）

---

## 補足情報

### データ取得の仕組み

1. 画面がロードされる
2. `EnhanceQuestScoreDetailUseCase.GetScoreDetail()` が実行
3. `IMstStageEnhanceRewardParamDataRepository` からマスタデータを取得
4. スコア閾値で降順ソート（高いスコアが上に表示）
5. `Translator` でDomain層ModelをPresentation層ViewModelに変換
6. UIに表示

### 表示順序について

- UseCase内で `OrderByDescending(mst => mst.MinThresholdScore)` により、スコア閾値が最も高いものから順に表示
- 最初にスクロール位置が最上部に設定されるため、最高の報酬が見やすい位置に表示される

---

**最終更新**: 2025-12-24
