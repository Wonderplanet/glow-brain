# ガチャアニメーション画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャアニメーション画面 |
| **画面番号** | 71-1-3 |
| **画面種別** | フルスクリーン演出画面 |

## 概要

ガチャを引いた後に表示される演出画面です。プレイヤーがどのユニットやアイテムを獲得したかを、臨場感のある演出で見せる画面です。開始時のレアリティ演出から始まり、獲得結果が1体ずつ表示されます。専用のBGMが再生され、ガチャの興奮を高める演出が施されています。

## プレイヤーができること

### 演出の視聴

#### 開始演出（スタートアニメーション）
- ガチャ結果のレアリティに応じた演出が自動再生される
- レアリティによって演出内容が変化（R、SR、SSR、URで異なる）
- ガチャで獲得したユニット/アイテムのサムネイルアイコンが表示される
- 開始レアリティから最終レアリティへの演出が進行

#### 獲得演出（リザルトアニメーション）
- 獲得したユニット/アイテムが1体ずつ順番に表示される
- ユニットの場合：
  - キャラクター画像
  - キャラクター名
  - ロール（役割）とカラー
  - レアリティ
  - シリーズロゴ
  - 吹き出しセリフ（召喚時）
  - 新規獲得の場合は「NEW」バッジ表示
- アイテムの場合：
  - アイテムアイコン
  - アイテム名
  - 獲得数量

### 演出のスキップ

#### 全スキップボタン
- 開始演出後に表示される
- タップすると以下の動作：
  - 開始演出が即座に終了
  - 新規獲得（NEW）のユニット/アイテムのみ結果演出を表示
  - 既に所持済みのユニット/アイテムの演出はスキップ
  - 新規獲得が1つもない場合は即座に画面が閉じる

#### 個別スキップ（結果演出中）
- 各獲得演出を個別にスキップできる
- 画面タップで次の獲得演出へ進む

## 画面の要素

### 背景
- ガチャ演出専用の背景
- 開始演出中は非表示

### 開始演出エリア
- レアリティに応じた演出アニメーション
- レアリティアップバリエーション演出
  - R、SR、SSR、URそれぞれの演出パターン
  - 複数バリエーションからランダムで1つが表示される
- 獲得アイテム/ユニットのサムネイルアイコン配置

### 結果演出エリア
- ユニット/アイテムの詳細表示
- 演出アニメーション
- NEWバッジ（新規獲得時のみ）

### ボタンエリア

#### 全スキップボタン
- 位置：開始演出後に表示
- 機能：全演出をスキップし、新規獲得のみ表示

## 画面遷移

### この画面への遷移
- **ガチャコンテンツ画面**: ガチャ実行後に自動的に遷移
  - ガチャAPIの結果をキャッシュに保存した状態で表示

### この画面からの遷移
- **自動終了**: 全演出終了後、自動的に画面を閉じる
  - ガチャコンテンツ画面に戻る

## ゲーム仕様・制約事項

### 演出の仕様

#### レアリティ演出の決定ロジック
- 開始レアリティ：獲得ユニット/アイテムのレアリティからランダムで1つを選択
  - ただし、最大レアリティ以上にはならない
- 最終レアリティ：獲得したユニット/アイテムの中で最も高いレアリティ
- アイテムのレアリティは演出計算上はRとして扱われる

#### 新規獲得判定
- ユニットのみが新規獲得として扱われる
- アイテムは新規/既存の判定がない

#### 重複ユニットの表示
- 重複ユニットはアイテムに変換されて提供される
- 演出上は変換前のユニット情報を使用して表示
- ただし「NEW」バッジは表示されない（既に所持済みのため）

### BGM
- ガチャ演出専用BGMが再生される（BGM_gacha_animation）
- 画面表示時に他のBGMを停止し、ガチャBGMに切り替え

### バックキー（Androidなど）の挙動
- ガチャ演出中はバックキーを無効化
- バックキーを押すと「無効な操作」のトーストメッセージを表示
- 演出をスキップせずに最後まで見るか、スキップボタンを使用する必要がある

### データソース
- ガチャ結果はGachaCacheRepositoryから取得
- ガチャ実行時にAPIから取得した結果をキャッシュしたもの
- キャラクターマスターデータからユニット情報を取得
- アイテムマスターデータからアイテム情報を取得

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaAnimPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/Presenters/GachaAnimPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaAnimViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/ViewModels/GachaAnimViewModel.cs)
- `Presentation/ViewModels/GachaAnimStartViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/ViewModels/GachaAnimStartViewModel.cs)
- `Presentation/ViewModels/GachaAnimResultViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/ViewModels/GachaAnimResultViewModel.cs)
- `Presentation/ViewModels/GachaAnimIconInfo.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/ViewModels/GachaAnimIconInfo.cs)

#### View
- `Presentation/Views/GachaAnimViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/Views/GachaAnimViewController.cs)
- `Presentation/Views/GachaAnimView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/Views/GachaAnimView.cs)

#### UseCase
- `Domain/UseCases/GachaAnimUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Domain/UseCases/GachaAnimUseCase.cs)

#### Translator
- `Presentation/Translator/GachaAnimTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Presentation/Translator/GachaAnimTranslator.cs)

#### Evaluator
- `Domain/Evaluator/GachaAnimStartRarityEvaluator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaAnim/Domain/Evaluator/GachaAnimStartRarityEvaluator.cs)

### GachaAnimViewModelの構造

GachaAnimViewModelはガチャアニメーション全体のデータを保持します。

- **GachaAnimStartViewModel**: 開始演出用データ
  - StartRarity: 開始時のレアリティ演出
  - EndRarity: 最終レアリティ（最も高いレアリティ）
  - Count: 獲得数
  - IconInfos: サムネイルアイコン情報のリスト

- **GashaAnimResultViewModelList**: 獲得結果のリスト（各ユニット/アイテム）
  - ResourceType: リソース種別（ユニット/アイテム）
  - RoleType: ユニットのロール
  - CharacterColor: キャラクターカラー
  - Rarity: レアリティ
  - SeriesLogoImagePath: シリーズロゴ画像パス
  - GachaAnimationUnitInfoAssetPath: ガチャアニメーション用ユニット情報アセットパス
  - CharacterName: キャラクター名
  - ItemIconAssetPath: アイテムアイコンパス
  - ItemName: アイテム名
  - NewFlg: 新規獲得フラグ
  - UnitImageAssetPath: ユニット画像アセットパス
  - SpeechBalloonText: 召喚時の吹き出しセリフ

### 開始レアリティの決定ロジック

GachaAnimStartRarityEvaluatorが以下のロジックで決定：
1. 獲得したユニット/アイテムのレアリティリストからランダムで1つを選択
2. 選択したレアリティが最大レアリティ以上の場合は最大レアリティに調整
3. これにより、開始演出から最終演出への「レアリティアップ」演出が可能

### 演出のバリエーション

各レアリティごとに複数のバリエーション演出が用意されており、画面表示時にランダムで1つが選ばれます：
- Rレアリティ演出バリエーション
- SRレアリティ演出バリエーション
- SSRレアリティ演出バリエーション
- URレアリティ演出バリエーション

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstCharacter.Id | mst_units.id | ガチャで獲得したユニットのID |
| MstCharacter.Name | mst_units.name | ガチャで獲得したユニット名を表示 |
| MstCharacter.Rarity | mst_units.rarity | ユニットのレアリティ（演出パターンとバッジ表示に使用） |
| MstCharacter.RoleType | mst_units.role_type | ユニットのロール表示（アタッカー、ディフェンダーなど） |
| MstCharacter.Color | mst_units.color | キャラクターカラー（属性）を表示 |
| MstCharacter.SeriesAssetKey | mst_units.series_asset_key | シリーズロゴ画像の表示用アセットキー |
| MstCharacter.AssetKey | mst_units.asset_key | キャラクターのカットイン画像表示用アセットキー |
| MstCharacter.SpeechBalloons | mst_speech_balloons テーブルから取得 | 召喚時の吹き出しセリフを表示（ConditionTypeがSummonのもの） |
| MstItem.Id | mst_items.id | ガチャで獲得したアイテムのID |
| MstItem.Name | mst_items.name | ガチャで獲得したアイテム名を表示 |
| MstItem.ItemAssetKey | mst_items.item_asset_key | アイテムアイコン表示用のアセットキー |

#### キャッシュデータ

この画面では、ガチャ実行時にAPIから取得してキャッシュした結果データを使用します。

| データ種別 | プロパティ | 説明 |
|-----------|---------|------|
| **GachaResultModel**<br>ガチャ結果キャッシュ | ResourceType | リソース種別（Unit または Item） |
| | ResourceId | リソースのマスタデータID（ユニットIDまたはアイテムID） |
| | ResourceAmount | 獲得数量 |
| | PreConversionResource | 変換前のリソース情報（重複ユニットがアイテムに変換された場合、変換前のユニット情報を保持） |

**データソース**: `GachaCacheRepository.GetGachaResultModels()`
ガチャコンテンツ画面でガチャAPI（`POST /api/gacha/draw`）を実行した結果をキャッシュしたもの。

### 呼び出しているAPI

この画面ではAPI呼び出しを行いません。

ガチャ結果のデータは以下から取得：
- **GachaCacheRepository**: ガチャ実行時にキャッシュされた結果
- **MstCharacterDataRepository**: キャラクターマスターデータ
- **MstItemDataRepository**: アイテムマスターデータ
