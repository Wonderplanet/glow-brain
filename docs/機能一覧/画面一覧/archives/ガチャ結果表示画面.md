# ガチャ結果表示画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャ結果表示画面 |
| **画面番号** | 71-1-4 |
| **画面種別** | メイン画面 |

## 概要

ガチャを引いた後、入手したユニットやアイテムを確認する画面です。単発ガチャの場合は1枠、10連ガチャの場合は10枠の結果が一覧で表示されます。新規入手したユニットにはアバターアイコンとNEWバッジが表示されます。また、重複ユニットがかけらに自動変換された場合は、変換前のユニットと変換後のかけらが並べて表示されます。

結果を確認した後、そのまま再度ガチャを引くことも可能で、各ユニットやアイテムの詳細をタップして確認することもできます。

## プレイヤーができること

### ガチャ結果の確認

#### 入手したアイテムの表示
- ガチャで入手した全てのユニット・アイテムが一覧で表示される
- 新規入手ユニットには「NEW」バッジが表示される
- ユニット入手時は、そのユニットのアバターアイコンも表示される

#### かけら変換の確認
- 重複ユニットが自動的にかけらに変換された場合、変換前のユニットと変換後のかけらが並んで表示される
- 変換がある場合のみ表示される

#### アイテム詳細の確認
- 各ユニット・アイテムアイコンをタップして詳細情報を表示
- アイテム詳細モーダルが開き、ステータスや説明を確認できる

### 再度ガチャを引く

#### もう一度引くボタン
- 同じガチャを同じ回数で再度実行できる
- ボタンが表示される条件：
  - アイテム・ダイヤの残量が十分
  - プリズム以外で引いた場合、前回と同じコストタイプで引ける
  - ガチャの回数制限に達していない
  - 広告ガチャの場合、再視聴可能な状態
- 上記条件を満たさない場合、ボタンは非表示またはグレーアウト

#### 再抽選の実行
- ボタンをタップするとガチャ確認ダイアログが表示される
- 確認後、再度ガチャ演出と結果画面へ遷移

### チュートリアルガチャ専用操作

#### 結果の確定（チュートリアルのみ）
- チュートリアルガチャ（UR1体確定）の場合のみ表示される
- 「確定」ボタンをタップすると確認ダイアログが表示される
- 確定すると：
  - 入手したユニットが保存される
  - URユニット（または最初のユニット）がリーダーとして全編成に自動設定される
  - URユニット（または最初のユニット）がアバターに自動設定される
  - チュートリアルが進行する

#### 引き直し（チュートリアルのみ）
- チュートリアルガチャでは何度でも引き直しが可能
- 「引き直す」ボタンをタップすると引き直し確認ダイアログが表示される
- ダイアログからラインナップも確認可能
- 引き直しを実行すると、再度ガチャ演出から開始される

### 画面を閉じる

#### 結果画面を閉じる
- 画面外タップまたは戻るボタンで閉じる
- 閉じると：
  - ホームBGMに切り替わる
  - ガチャ演出用アセットがアンロードされる
  - 元の画面（ガチャコンテンツまたはガチャ一覧）に戻る

#### アプリレビュー表示
- 特定条件を満たすとアプリストアレビュー画面が表示される
- 表示条件：
  - 過去にガチャでURを引いた後のレビュー表示がまだ行われていない
  - チュートリアルガチャではない
  - 今回の結果にURが含まれている

## 画面の要素

### メインエリア
- **結果アイコン一覧**: 入手したユニット・アイテムのアイコンをグリッド表示
- **NEWバッジ**: 新規入手ユニットに表示
- **アバターアイコン**: 新規入手ユニットのキャラクターアイコン
- **変換前後の表示**: かけら変換があった場合、元のユニットと変換後のかけらを並べて表示

### ボタンエリア

#### 通常ガチャの場合
- **もう一度引くボタン**: 再度同じガチャを実行（条件を満たす場合のみ表示）
- **閉じるボタン**: 画面を閉じて元の画面に戻る

#### チュートリアルガチャの場合
- **確定ボタン**: ガチャ結果を確定してユニットを獲得
- **引き直すボタン**: ガチャを引き直す

## 画面遷移

### この画面への遷移
- **ガチャ演出画面**: ガチャ演出終了後、自動的に遷移

### この画面からの遷移
- **ガチャ確認ダイアログ**: 「もう一度引く」ボタンタップ時
  - 確認後、再度ガチャ演出へ
- **アイテム詳細モーダル**: アイテムアイコンタップ時
  - 詳細確認後、この画面に戻る
- **チュートリアルガチャ引き直し確認ダイアログ**: 「引き直す」ボタンタップ時（チュートリアルのみ）
  - ラインナップ表示オプションあり
  - 確定後、再度ガチャ演出へ
- **元の画面**: 画面を閉じた時
  - ガチャコンテンツ画面（ガチャコンテンツから遷移した場合）
  - ガチャ一覧画面（ガチャ一覧から遷移した場合）

## ゲーム仕様・制約事項

### 再度引くボタンの表示条件

ボタンが表示されるには以下の全ての条件を満たす必要があります：

1. **コスト充足**: ガチャを引くためのダイヤ・アイテムが十分にある
2. **コストタイプの一致**: プリズム以外で引いた場合、前回と同じコストタイプで引ける
3. **回数制限**: ガチャの引ける回数上限に達していない
4. **広告ガチャ**: 広告ガチャの場合、再視聴可能な状態である

チュートリアルガチャは常に引き直し可能です。

### かけら変換の表示

- 重複ユニットが入手された場合、自動的にかけらに変換される
- 変換があった場合：
  - 変換前のユニットアイコンが左側に表示
  - 変換後のかけらアイコンが右側に表示
- 変換がない場合は通常通りアイテムアイコンのみ表示

### チュートリアルガチャの特殊仕様

#### 確定時の挙動
- 入手したユニットの中からURがあればUR、なければ最初のユニットを選択
- 選択されたユニットは：
  - 全ての編成のリーダーに自動設定される
  - プレイヤーのアバターに自動設定される
- チュートリアルステータスが更新される

#### 引き直し
- チュートリアルガチャは回数制限なく引き直し可能
- 引き直しても消費リソースは不要
- 前回の結果は破棄され、新しい結果に置き換わる

### アプリレビュー表示のトリガー

以下の条件を全て満たす場合、画面を閉じる際にアプリストアレビュー依頼が表示されます：

1. 過去にURガチャ後のレビュー表示が行われていない
2. チュートリアルガチャではない
3. 今回の結果にレアリティURのユニットが含まれている

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaResultPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Presentation/Presenters/GachaResultPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaResultViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Presentation/ViewModels/GachaResultViewModel.cs)
- `Presentation/ViewModels/GachaResultCellViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Presentation/ViewModels/GachaResultCellViewModel.cs)
- `Presentation/ViewModels/GachaResultAvatorViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Presentation/ViewModels/GachaResultAvatorViewModel.cs)

#### View
- `Presentation/Views/GachaResultViewController.cs`
- `Presentation/Views/GachaResultView.cs`
- `Presentation/Views/GachaResultIconComponent.cs`
- `Presentation/Views/GachaResultCharacterIconComponent.cs`
- `Presentation/Views/GachaResultRarityIconComponent.cs`

#### UseCase
- `Domain/UseCases/GachaResultUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Domain/UseCases/GachaResultUseCase.cs)
- `Domain/UseCases/TutorialGachaResultConfirmUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Domain/UseCases/TutorialGachaResultConfirmUseCase.cs)
- `Domain/UseCases/TutorialGachaReDrawUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaResult/Domain/UseCases/TutorialGachaReDrawUseCase.cs)

### GachaResultViewModelの構造

ガチャ結果画面全体の表示データを保持します。

- `GachaType`: ガチャの種類（通常/チュートリアルなど）
- `CellViewModels`: 各結果アイテムのViewModel一覧
- `ConvertedCellViewModels`: かけら変換後のアイテム一覧（変換がある場合のみ）
- `AvatarViewModels`: 新規入手ユニットのアバターアイコン一覧
- `ExistsPreConversionResource`: かけら変換があるかどうかのフラグ

### GachaResultCellViewModelの構造

各ガチャ結果アイテムの表示データを保持します。

- `PlayerResourceIconViewModel`: アイテムのアイコン表示情報（アイコン、レアリティ、数量など）
- `IsNewUnitBadge`: NEWバッジを表示するかのフラグ（新規入手ユニットの場合true）

### 画面初期化時のデータ取得

画面表示時、`GachaResultUseCase.GetGachaResultUseCase()`でキャッシュから以下のデータを取得します：

- ガチャ結果（入手したユニット・アイテム一覧）
- ガチャ情報（ガチャID、引いた回数など）
- 再度引けるかどうかのフラグ
- かけら変換情報
- アプリレビュー表示フラグ

取得後、キャッシュはクリアされます。

### 呼び出しているAPI

#### チュートリアルガチャ確定時
- **POST `/api/tutorial/gacha_confirm`**: チュートリアルガチャ結果確定
  - 用途: ガチャで入手したユニット・アイテムを確定し、チュートリアルを進行
  - レスポンス: 確定したユニット・アイテム情報、チュートリアルステータス

- **POST `/api/party/save`**: 編成保存
  - パラメータ: 編成情報（全編成にURまたは最初のユニットをリーダー設定）
  - 用途: 入手したユニットを全ての編成に自動設定

- **POST `/api/user/change_avatar`**: アバター変更
  - パラメータ: mstUnitId（URまたは最初のユニットのID）
  - 用途: 入手したユニットをプレイヤーアバターに自動設定

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstCharacter.Id | mst_units.id | 入手したユニットのID |
| MstCharacter.Name | mst_units.name | ユニット名（アイテム詳細表示用） |
| MstCharacter.Rarity | mst_units.rarity | レアリティ（アプリレビュー表示判定・アイコン表示用） |
| MstCharacter.AssetKey | mst_units.asset_key | ユニットアセットキー（アバターアイコン表示用） |
| OprGacha.GachaId | opr_gachas.id | ガチャID（再度引く判定用） |
| OprGacha.GachaType | opr_gachas.gacha_type | ガチャタイプ（通常/チュートリアルなど）（チュートリアル判定用） |
| OprGacha.EnableAdPlay | opr_gachas.enable_ad_play | 広告ガチャ有効フラグ（再度引く判定用） |
| OprGacha.AdIntervalTimeMinutes | opr_gachas.ad_interval_time_minutes | 広告ガチャ実行間隔（再度引く判定用） |
| OprGacha.DailyPlayLimitCount | opr_gachas.daily_play_limit_count | 1日あたりの実行回数上限（再度引く判定用） |
| OprGacha.TotalPlayLimitCount | opr_gachas.total_play_limit_count | 期間中の実行回数上限（再度引く判定用） |
| OprGacha.DailyAdPlayLimitCount | opr_gachas.daily_ad_play_limit_count | 1日あたりの広告ガチャ実行回数上限（再度引く判定用） |
| OprGacha.TotalAdPlayLimitCount | opr_gachas.total_ad_play_limit_count | 期間中の広告ガチャ実行回数上限（再度引く判定用） |
| OprGachaUseResource.OprGachaId | opr_gacha_use_resources.opr_gacha_id | ガチャID（コスト取得用） |
| OprGachaUseResource.CostType | opr_gacha_use_resources.cost_type | コストタイプ（ダイヤ、アイテムなど）（再度引く判定用） |
| OprGachaUseResource.MstCostId | opr_gacha_use_resources.mst_cost_id | アイテムコストのマスタID（再度引く判定用） |
| OprGachaUseResource.CostAmount | opr_gacha_use_resources.cost_amount | 必要コスト量（再度引く判定用） |
| OprGachaUseResource.GachaDrawCount | opr_gacha_use_resources.gacha_draw_count | 単発（1）or 10連（10）（再度引く判定用） |
| OprGachaUseResource.GachaCostPriority | opr_gacha_use_resources.gacha_cost_priority | コスト優先度（複数コスト設定時の優先順位判定用） |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserGacha.OprGachaId | user_gachas.opr_gacha_id | ガチャID（実行履歴取得用） |
| UserGacha.PlayedAt | user_gachas.played_at | 最終実行日時（広告ガチャ間隔判定用） |
| UserGacha.AdPlayedAt | user_gachas.ad_played_at | 広告ガチャ最終実行日時（広告ガチャ間隔判定用） |
| UserGacha.PlayedCount | user_gachas.played_count | 通常ガチャ実行回数（回数制限判定用） |
| UserGacha.DailyPlayedCount | user_gachas.daily_played_count | 1日あたりの通常ガチャ実行回数（回数制限判定用） |
| UserGacha.AdPlayedCount | user_gachas.ad_played_count | 広告ガチャ実行回数（回数制限判定用） |
| UserGacha.DailyAdPlayedCount | user_gachas.daily_ad_played_count | 1日あたりの広告ガチャ実行回数（回数制限判定用） |
| UserGacha.GachaExpireAt | user_gachas.gacha_expire_at | 個別有効期限（一部ガチャで設定） |
| UserParameter.Coin | user_parameters.coin | コイン所持量（再度引く判定用） |
| UserParameter.FreeDiamond | user_parameters.free_diamond | 無償ダイヤ所持量（再度引く判定用） |
| UserParameter.PaidDiamondIos | user_parameters.paid_diamond_ios | iOS有償ダイヤ所持量（再度引く判定用） |
| UserParameter.PaidDiamondAndroid | user_parameters.paid_diamond_android | Android有償ダイヤ所持量（再度引く判定用） |
| UserItem.MstItemId | user_items.mst_item_id | アイテムID（チケット所持量確認用） |
| UserItem.Amount | user_items.amount | アイテム所持量（再度引く判定用） |
| UserUnit.MstUnitId | user_units.mst_unit_id | ユニットマスタID（チュートリアル確定時のリーダー・アバター設定用） |
| UserUnit.UsrUnitId | user_units.id | ユーザーユニットID（編成設定用） |
| UserParty.PartyNo | user_parties.party_no | 編成番号（チュートリアル確定時の全編成更新用） |
| UserParty.PartyName | user_parties.party_name | 編成名（チュートリアル確定時の編成保存用） |
| UserParty.Unit1 | user_parties.unit1 | リーダーユニットID（チュートリアル確定時のリーダー設定用） |
| UserProfile.MstUnitId | user_profiles.mst_unit_id | アバターユニットID（チュートリアル確定時のアバター変更用） |
