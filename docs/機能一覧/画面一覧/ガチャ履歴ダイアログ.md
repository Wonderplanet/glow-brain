# ガチャ履歴ダイアログ

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャ履歴ダイアログ |
| **画面種別** | ダイアログ |

## 概要

ガチャ履歴ダイアログは、プレイヤーが過去に引いたガチャの履歴を確認できる画面です。最大50件（5ページ×10件）までの履歴が時系列で表示され、各ガチャの日時、名称、コスト情報を一覧で確認できます。各履歴をタップすると、そのガチャで獲得した詳細な報酬内容を表示する「ガチャ履歴詳細ダイアログ」に遷移します。

## プレイヤーができること

### ガチャ履歴の閲覧

#### 履歴リストの確認
- 過去に引いたガチャの履歴を一覧で閲覧
- 各履歴には以下の情報が表示される
  - ガチャを引いた日時
  - ガチャの名称
  - 使用したコストの種類とアイコン（ダイヤ、アイテム、広告など）
  - 消費したコストの数量

#### ページネーション操作
- 1ページあたり10件の履歴を表示
- 最大5ページ（50件）まで表示可能
- 以下のページ操作が可能
  - 最初のページへ移動（|<ボタン）
  - 前のページへ移動（<ボタン）
  - 次のページへ移動（>ボタン）
  - 最後のページへ移動（>|ボタン）
- 操作不可能なボタンをタップすると専用の効果音が再生される
- ページ移動時は自動的にスクロール位置が最上部にリセットされる

### 詳細情報の確認

#### ガチャ履歴詳細への遷移
- 履歴セルをタップすると、そのガチャで獲得した報酬の詳細画面に遷移
- 遷移時に現在のページ番号とスクロール位置が記憶される
- 詳細画面から戻る際には、記憶されたページとスクロール位置に復帰する

## 画面の要素

### ヘッダー部分
- 画面タイトル表示
- 閉じるボタン（×ボタン）

### メイン表示エリア
- ガチャ履歴リスト（スクロール可能）
  - 各履歴セルに以下を表示
    - ガチャ実施日時
    - ガチャ名称
    - コストアイコン
    - コスト数量（広告ガチャの場合は「1」と表示）
  - セルはタップ可能で、タップすると詳細画面に遷移

### ページネーションエリア
- 4つのページ操作ボタン
  - 最初へ（|<）
  - 前へ（<）
  - 次へ（>）
  - 最後へ（>|）
- 現在のページ位置に応じてボタンの有効/無効が切り替わる
  - 最初のページでは「最初へ」「前へ」ボタンが無効
  - 最後のページでは「次へ」「最後へ」ボタンが無効

## 画面遷移

### この画面への遷移
- **ガチャコンテンツ画面**: 「履歴」ボタンをタップ

### この画面からの遷移
- **ガチャ履歴詳細ダイアログ**: 履歴セルをタップ
  - 遷移時に現在のページ番号とスクロール位置を引き継ぐ
  - ガチャ履歴ダイアログは一時的に閉じられる（詳細画面から戻る際に再表示される）

## ゲーム仕様・制約事項

### ページネーション仕様
- 1ページあたり10件の履歴を表示
- 最大5ページ（50件）まで表示
- 履歴が10件未満の場合でも1ページとして表示される
- 最終ページが10件に満たない場合は実際の件数のみ表示

### 履歴データの取得
- 画面表示時にサーバーから最新の履歴データを取得
- データがない場合は空のモデルが返される

### コスト表示の特殊処理
- 広告ガチャの場合、実際のコストに関わらず「1」と表示される
- コストタイプに応じた適切なアイコンが表示される（ダイヤ、コイン、アイテム、広告）

### 画面復帰動作
- ガチャ履歴詳細ダイアログから戻る際
  - 元のページ番号を維持
  - スクロール位置を記憶し、同じ位置に復帰
  - 閉じるボタンで閉じた場合のコールバックは実行されない（詳細画面表示のための一時的な閉じであるため）

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaHistoryDialogPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/Presentation/Presenters/GachaHistoryDialogPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaHistoryDialogViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/Presentation/ViewModels/GachaHistoryDialogViewModel.cs)
- `Presentation/ViewModels/GachaHistoryCellViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/Presentation/ViewModels/GachaHistoryCellViewModel.cs)

#### View
- `Presentation/Views/GachaHistoryDialogViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/Presentation/Views/GachaHistoryDialogViewController.cs)
- `Presentation/Views/GachaHistoryDialogView.cs`
- `Presentation/Views/GachaHistoryCell.cs`

#### UseCase
- `Domain/UseCases/GachaHistoryDialogUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/Domain/UseCases/GachaHistoryDialogUseCase.cs)

#### WireFrame
- `Presentation/Presenters/GachaHistoryWireFrame.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaHistoryDialog/Presentation/Presenters/GachaHistoryWireFrame.cs)

#### Translator
- `Presentation/Translator/GachaHistoryDialogViewModelTranslator.cs`

### GachaHistoryDialogViewModelの構造

ガチャ履歴一覧を表示するためのViewModel。

- `GachaHistoryCellViewModels`: 履歴セル情報のリスト
- `GachaHistoryDetailDialogViewModels`: 詳細ダイアログ情報のリスト

**表示制御ロジック**：

- `GetGachaHistoryCellViewModelsForCurrentPage(int currentPage)`: 指定ページの履歴セル情報を取得
- `GetGachaHistoryDetailDialogViewModelsForCurrentPage(int currentPage)`: 指定ページの詳細ダイアログ情報を取得
- `GetLastPageNum()`: 最終ページ番号を計算（最大5ページ）
- `CanGoToFirstPage(int currentPage)`: 最初のページへ移動可能か判定
- `CanGoToPreviousPage(int currentPage)`: 前のページへ移動可能か判定
- `CanGoToNextPage(int currentPage)`: 次のページへ移動可能か判定
- `CanGoToLastPage(int currentPage)`: 最後のページへ移動可能か判定

### GachaHistoryCellViewModelの構造

各履歴セルに表示される情報。

- `GachaDrawDate`: ガチャを引いた日時
- `GachaName`: ガチャ名称
- `IsAdDraw`: 広告ガチャかどうかのフラグ
- `PlayerResourceIconAssetPath`: コストアイコンのアセットパス
- `CostAmount`: 消費したコスト数量

### 画面初期化時の引数

```csharp
GachaHistoryDialogViewController.Argument(ViewModel, CurrentPage = 1)
```

- `ViewModel`: ガチャ履歴の表示データ
- `CurrentPage`: 表示する初期ページ番号（デフォルト: 1）

### 呼び出しているAPI

#### 画面表示時（履歴データ取得）
- **GET `/api/gacha/history`**: ガチャ履歴取得API
  - パラメータ: なし
  - 用途: プレイヤーの過去ガチャ履歴を取得（最大50件）

### コスト表示ロジック

UseCaseにおいて、コストタイプに応じた適切なアイコンパスを生成：

- **CostType.Coin**: コインアイコン
- **CostType.Diamond**: ダイヤアイコン
- **CostType.PaidDiamond**: ダイヤアイコン（有償ダイヤ）
- **CostType.Free**: ダイヤアイコン（無料の場合はプリズム扱い）
- **CostType.Item**: アイテムマスターから該当アイテムのアイコン
- **CostType.Ad**: 空パス（View側で広告アイコンを表示）
- **CostType.Cash**: 空パス（現金でのガチャは存在しない）

広告ガチャの場合、実際のコストに関わらずコスト数量を「1」に上書きして表示。

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **OprGacha**<br>ガチャ基本情報 | GachaName | ガチャ名称（履歴に表示） |
| **MstCharacter** (mst_units)<br>キャラクターマスタ | Id | ユニットID（変換対象キャラの取得） |
| | Name | ユニット名（報酬詳細に表示） |
| **MstItem**<br>アイテムマスタ | ItemAssetKey | アイコン表示用のアセットキー（コストがアイテムの場合に使用） |

