# イベントステージ選択画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | イベントステージ選択画面 |
| **画面番号** | 42-1-2（イベントクエスト選択） |
| **画面種別** | メイン画面 |

## 概要

開催中のイベントに含まれる複数のクエスト（ステージ）の一覧を表示し、プレイヤーが挑戦したいクエストを選択する画面です。各クエストの難易度や挑戦可能かどうかを確認できます。また、同時開催中の降臨バトルやイベント交換所へのアクセス、イベントミッションの確認も行えます。

## プレイヤーができること

### クエストを選択して挑戦する

#### 利用可能なクエストを選択
- クエスト一覧からタップして、そのクエスト内のステージ選択画面へ進む
- 各クエストの難易度（ノーマル、ハード、超ハードなど）が複数存在する場合がある
- アイコンやタイトルから各クエストの情報を確認

#### ロックされたクエストについて
- 未開催のクエストはロック表示（鍵アイコン）される
- 特定ステージをクリアすることが必須のクエストはロック表示され、必要クエストが表示される
- 本日の挑戦回数が終了したクエストはロック表示される
- ロックされたクエストをタップすると、ロック解除条件を説明するトーストが表示される
- 開催期間が終了したクエストは解除不可（グレーアウト表示）

#### Newマークの確認
- 初回挑戦可能なクエストに「New」マークが表示される

### イベント降臨バトルに挑戦する

#### 降臨バトルボタン
- イベント期間中に降臨バトルが開催されている場合、画面上に「降臨バトル」ボタンが表示される
- ボタンをタップすると、降臨バトル画面へ遷移
- ボタンが表示されない、またはグレーアウトしている場合もある

#### 降臨バトル開放条件
- プレイヤーのリーダーレベルが足りていない場合、グレーアウト表示される
- 条件を満たさない場合はトーストで条件を表示
- 開催前または開催終了済みの場合もボタンが表示されない

#### 降臨バトルの時間表示
- 開催前の場合：「開催まで：○時間○分」
- 開催中の場合：「終了まで：○時間○分」
- リアルタイムでカウントダウン表示

### イベント交換所にアクセスする

#### イベント交換所ボタン
- イベントに紐づいた交換所が存在する場合、画面上にボタンが表示される
- タップするとイベント交換所の画面へ遷移
- 交換所がない場合はボタンは表示されない

### イベントミッションを確認する

#### ミッションバッジ
- 未受け取りのミッション報酬がある場合、ミッションボタンにバッジが表示される
- バッジから報酬受け取りが可能であることが分かる

#### ミッション画面への遷移
- ミッションボタンをタップして、イベントミッション画面を表示
- ミッション一覧と報酬の確認ができる
- イベント開催期間終了後はミッション画面へアクセスできない

### イベント情報を確認する

#### イベント開催期間
- イベントの終了時刻までの残り時間をカウントダウン表示
- 終了までの日数・時間・分が表示される
- 期間終了後は画面にアクセスできなくなる

#### イベント背景
- イベントテーマに沿った背景画像が表示される

#### キャンペーン情報バルーン
- イベント期間中、経験値ボーナスなどのキャンペーンが開催中の場合、バルーン表示される
- 残り時間が表示される

## 画面の要素

### ヘッダー部分
- イベント名またはイベントテーマ
- 戻るボタン（一つ前の画面に戻る）
- ナビゲーション関連の要素

### 背景エリア
- イベントテーマに沿ったカスタム背景画像が表示される

### メイン表示エリア
**クエスト一覧**
- 各クエストが横スクロール可能なコレクションビューとして表示される
- 各クエストセル：
  - クエスト名
  - クエストサムネイル画像
  - ロックアイコン（クエストがロック中の場合）
  - ロック解除条件テキスト（必要ステージクリアなど）
  - Newマーク（初回挑戦時）

**イベント情報表示**
- イベント終了までの残り時間
- キャンペーン期間中の場合、キャンペーンバルーン表示

### ボタンエリア

#### 降臨バトルボタン（該当イベントのみ）
- 降臨バトルが開催中の場合に表示
- ボタン名：「降臨バトル」
- ステータスに応じて表示制御
  - 開催中：有効（タップ可能）
  - 開催前：ボタン表示、グレーアウト
  - リーダーレベルロック中：ボタン表示、グレーアウト、条件テキスト表示
  - 開催終了：ボタン非表示

#### イベント交換所ボタン（該当イベントのみ）
- 交換所が設定されている場合に表示
- ボタン名：「交換所」など

#### ミッションボタン
- 常に表示
- 未受け取り報酬がある場合、バッジ表示

#### イベント関連その他ボタン
- 画面デザインに応じて配置

### フッター部分
- イベント終了までの残り時間（繰り返し表示される場合もある）

## 画面遷移

### この画面への遷移
- **イベントトップ画面（EventQuestTop）**: イベント選択時
  - 遷移時引数：`MstEventId`（イベントマスタID）
- **ホーム画面**: イベントバナーをタップ

### この画面からの遷移
- **ステージ選択画面（EventStageSelect）**: クエストを選択
  - 遷移時：`MstQuestGroupId`（クエストグループID）を渡す
  - 遷移後、選択したクエスト内の難易度選択画面が表示される
  - ロック条件を満たさない場合は遷移しない（トースト表示）

- **降臨バトルトップ画面（AdventBattleTop）**: 降臨バトルボタンをタップ
  - 降臨バトルが開催中で、かつリーダーレベル条件を満たす場合のみ遷移可能
  - 開催終了時刻を越えた場合は、ホーム画面へ自動遷移
  - メンテナンス中の場合は、メンテナンスダイアログを表示

- **イベントミッション画面（EventMission）**: ミッションボタンをタップ
  - イベント開催期間中のみ遷移可能
  - イベント期間終了済みの場合は、ホーム画面へ自動遷移
  - ミッション画面から戻る際、バッジの更新が反映される

- **イベント交換所画面（ExchangeShop）**: 交換所ボタンをタップ
  - イベント開催期間中のみ遷移可能
  - イベント期間終了済みの場合は、ホーム画面へ自動遷移

- **ホーム画面**: 戻るボタンをタップ
  - イベント開催期間外の場合、降臨バトルボタン・ミッションボタン・交換所ボタンをタップした場合も遷移

## ゲーム仕様・制約事項

### クエスト開放条件
- **未開催クエスト**: イベント期間内の設定された開始日時に自動的に開放
- **前提ステージクリア**: 特定のクエストをクリアすることが前提条件のクエスト
  - ロック状態で「《クエスト名》の第○ステージをクリアしてください」などと表示される
- **本日の挑戦回数終了**: 1日あたりの挑戦回数制限がある場合、上限に達するとロック
  - 「本日の挑戦回数が終了しました」と表示
  - 翌日にリセット

### イベント開催期間
- イベントには開始時刻と終了時刻が設定されている
- 開催期間外の画面へのアクセスはできない
- 降臨バトルもイベントごとに開催期間が異なる
- イベント開催期間中であっても、クエストごとに独立した開催期間がある

### 降臨バトルの仕様
- イベントに紐づいている場合のみ表示
- リーダーレベルが一定以上であることが開放条件
- 開催前、開催中、開催終了のいずれかのステータスを持つ
- メンテナンス中は画面へアクセスできない

### イベント交換所の仕様
- イベントに紐づいている交換所がある場合のみボタン表示
- イベント開催期間中のみアクセス可能
- 交換所がない場合はトースト表示「対象のイベント交換所はありません」

### ミッション関連
- イベントごとのミッション管理
- ミッション報酬が未受け取りの場合、バッジ表示
- イベント期間終了後はミッション画面にアクセスできない
- ミッション画面から戻ると、バッジの状態が更新される

### 背景読み込み
- イベント背景画像は非同期で読み込まれる
- 読み込み完了後にアニメーション表示される
- インゲーム画面から戻ってきた際も再度アニメーション再生

### BGM制御
- 画面読み込み時にコンテンツトップ用BGMが再生される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/EventQuestSelect/`

### 主要コンポーネント

#### Presenter
- `Presentation/EventQuestSelectPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestSelect/Presentation/EventQuestSelectPresenter.cs:29)

#### ViewController/View
- `Presentation/EventQuestSelectViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EventQuestSelect/Presentation/EventQuestSelectViewController.cs:17)
- `Presentation/EventQuestSelectView.cs`
- `Presentation/IEventQuestSelectViewDelegate.cs`

#### ViewModel
- `Presentation/EventQuestSelectViewModel.cs`
- `Presentation/EventQuestSelectElementViewModel.cs`

#### UseCase
- `Domain/EventQuestListUseCase.cs`
- `Domain/EventOpenCheckUseCase.cs`
- `Domain/EventQuestOpenCheckUseCase.cs`
- `Domain/EventMissionBadgeUseCase.cs`
- `Domain/UseCase/EventExchangeShopCheckUseCase.cs`

#### Translator
- `Presentation/EventQuestSelectViewModelTranslator.cs`

#### その他
- `Presentation/EventQuestSelectCell.cs` - クエスト表示セル
- `Presentation/EventQuestBackGroundLoader.cs` - 背景画像読み込み
- `Presentation/EventQuestBackGroundComponent.cs` - 背景コンポーネント

### EventQuestSelectViewModelの構造

```csharp
public record EventQuestSelectViewModel(
    MasterDataId MstEventId,                           // イベントID
    MasterDataId MstAdventBattleId,                    // 降臨バトルID
    AdventBattleOpenStatus AdventBattleOpenStatus,     // 降臨バトルステータス
    AdventBattleOpenSentence AdventBattleOpenSentence, // 降臨バトル開放条件文
    AdventBattleRemainTimeSentence AdventBattleRemainTimeSentence, // 降臨バトル残り時間
    AdventBattleName AdventBattleName,                 // 降臨バトル名
    EventAssetKey EventAssetKey,                       // イベント背景アセット
    RemainingTimeSpan RemainingAt,                     // イベント残り時間
    DateTimeOffset EventEndAt,                         // イベント終了日時
    IReadOnlyList<EventQuestSelectElementViewModel> Quests, // クエスト一覧
    RemainingTimeSpan RemainingEventCampaignTimeSpan   // キャンペーン残り時間
)
```

**表示制御ロジック**：
- `RemainingAtText`: イベント終了までの時間を「○日○時間」形式で表示
- `IsOpen`: イベントが開催中かどうかのフラグ（画面上部のタイトルバー表示切り替え）

### EventQuestSelectElementViewModelの構造

各クエストの表示データ

```csharp
public record EventQuestSelectElementViewModel(
    MasterDataId MstQuestGroupId,                      // クエストグループID
    IReadOnlyList<QuestOpenStatus> OpenStatuses,       // クエストのステータスリスト
    NewQuestFlag IsNewQuest,                           // 初回挑戦フラグ
    QuestName Name,                                    // クエスト名
    EventQuestSelectElementAssetPath AssetPath,        // クエストサムネイル画像パス
    QuestUnlockRequirementDescription UnlockRequirementDescription // ロック解除条件説明
)
```

**表示制御メソッド**：
- `IsOpen()`: クエストが利用可能かを判定（ステータスが`Released`の場合）
- `ShouldShowLockIcon()`: ロックアイコンを表示するかを判定
  - 優先度：`NotOpenQuest`（未開催）→ ロック表示
  - ただし、開催期間終了は表示しない
  - ステージクリア未達成は表示
- `GetLockDescription()`: ロック条件テキストを取得
  - 「《クエスト名》の第○ステージをクリアしてください」
  - 「開催期間が終了しました」
  - 「本日の挑戦回数が終了しました」

### 画面初期化時の引数
```csharp
EventQuestSelectViewController.Argument(MasterDataId MstEventId)
```
- `MstEventId`: 表示対象のイベントID

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **MstEvent**<br>イベント基本情報 | Id | イベントID |
| | StartAt | イベント開始日時 |
| | EndAt | イベント終了日時 |
| | AssetKey | イベント背景画像のアセットキー |
| **MstQuest**<br>クエスト基本情報 | Id | クエストID |
| | MstEventId | 紐づくイベントID |
| | StartDate | クエスト開始日時 |
| | EndDate | クエスト終了日時 |
| | Difficulty | クエストの難易度 |
| | MstQuestGroupId | クエストグループID（複数難度グループ化） |
| **MstQuestGroup**<br>クエストグループ情報 | Id | クエストグループID |
| | Name | クエスト表示名 |
| | AssetKey | クエストサムネイル画像のアセットキー |
| **MstAdventBattle**<br>降臨バトル基本情報 | Id | 降臨バトルID |
| | MstEventId | 紐づくイベントID |
| | StartDateTime | 開催開始日時 |
| | EndDateTime | 開催終了日時 |
| | AdventBattleName | 降臨バトル名 |
| **MstExchangeShop**<br>イベント交換所情報 | Id | 交換所ID |
| | MstEventId | 紐づくイベントID |
| **MstCampaign**<br>キャンペーン情報（期間限定ボーナス） | TargetId | ターゲットID（クエストIDなど） |
| | TargetType | ターゲットタイプ（EventQuest など） |
| | EndAt | キャンペーン終了日時 |
| **MstTutorial**<br>チュートリアル情報 | TutorialFunctionName | 機能識別子（AdventBattle など） |
| | ConditionValue | 条件値（リーダーレベルなど） |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserEventMission**<br>ユーザーイベントミッション | MstEventId | イベントID |
| | IsReceived | ミッション報酬受け取り状態 |
| **UserQuestChallenge**<br>ユーザークエスト挑戦記録 | MstQuestGroupId | クエストグループID |
| | ChallengeCount | 本日の挑戦回数（リセット対象） |
| | MaxChallengeCount | 1日あたりの挑戦上限 |

### 呼び出しているAPI

EventQuestSelect画面では、表示に必要なマスタデータはすべてリポジトリから取得されます。**API呼び出しはありません**。

- マスタデータ取得: ローカルリポジトリより
- ユーザーデータ取得: GameFetch（ゲーム接続時に一括取得）より
