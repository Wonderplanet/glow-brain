# 降臨バトルミッション画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルミッション画面 |
| **画面番号** | 44-1-7（降臨バトル・ミッションアイコン） |
| **画面種別** | モーダル画面 |

## 概要

降臨バトル専用のミッション一覧を表示する画面です。開催中の降臨バトルに関連するイベントミッションと期間限定ミッションを確認し、達成したミッションの報酬を受け取ることができます。降臨バトルが開催されていない場合は表示されません。

## プレイヤーができること

### ミッション報酬を受け取る

#### 個別受け取り
- 達成済みの各ミッションから個別に報酬を受け取る
- 受け取りボタンをタップすると報酬演出が表示される
- 受け取り後、ミッションリストが更新される
- 経験値を受け取った場合、プレイヤーレベルアップの可能性あり

#### 一括受け取り
- 受け取り可能なすべてのミッションの報酬をまとめて受け取る
- 画面下部の「一括受け取り」ボタンをタップ
- 受け取り可能な報酬がない場合、ボタンは無効化される
- 受け取り後、ミッションリストが自動更新される

### ミッション情報を確認する

#### ミッション一覧表示
- **ミッション説明**: 達成条件の説明文
- **進捗状況**: 現在の進捗と目標値（例：「3/5」）
- **報酬内容**: 受け取れるアイテムやリソースのアイコン
- **残り時間**: 期間限定ミッションの場合、終了までの時間を表示
- **状態表示**:
  - 未達成：「挑戦」ボタン（グレー）
  - 達成済み（未受け取り）：「受け取り」ボタン（有効）
  - 受け取り済み：受け取り済み表示

#### 報酬詳細の確認
- 報酬アイコンをタップすると、アイテム詳細モーダルが表示される
- アイテムの説明や効果を確認できる

### その他の操作

- **閉じるボタン**: 画面を閉じて元の画面に戻る
- **Escapeキー**: 画面を閉じる（PC版）
- **挑戦ボタン**: ミッション達成のための画面へ遷移（降臨バトルTOP以外では表示されない）

## 画面の要素

### ヘッダー部分
- 画面タイトル（「降臨バトルミッション」など）
- 閉じるボタン

### メイン表示エリア
- **ミッションリスト（CollectionView）**
  - ミッション説明文
  - 進捗表示（現在値/目標値）
  - 報酬アイコン
  - 状態別ボタン
    - 未達成：「挑戦」ボタン（グレー）
    - 達成済み：「受け取り」ボタン（アクティブ）
    - 受け取り済み：受け取り完了表示
  - 期間限定ミッションの場合：残り時間表示

### ボタンエリア
- **一括受け取りボタン**
  - 受け取り可能な報酬がある場合：有効
  - 受け取り可能な報酬がない場合：無効化（グレーアウト）
  - 通信中は一時的に無効化される

### インジケーター
- 通信中はローディングインジケーターを表示
- データ取得完了後に非表示

## 画面遷移

### この画面への遷移
- **降臨バトルTOP画面**: ミッションアイコンをタップ
- その他、降臨バトル関連の画面からのアクセス

### この画面からの遷移
- **アイテム詳細モーダル**: 報酬アイコンをタップ
  - アイテムの説明や効果を確認
  - モーダルを閉じるとミッション画面に戻る
- **報酬受け取り演出**: 個別または一括受け取りボタンをタップ
  - 受け取った報酬の演出を表示
  - 演出後、自動的にミッション画面に戻る
  - ヘッダーの経験値ゲージアニメーションが再生される
- **元の画面**: 閉じるボタンまたはEscapeキー
  - 画面を閉じる際、受け取り可能な報酬の有無によってバッジ状態を更新

## ゲーム仕様・制約事項

### 降臨バトル開催期間の制限
- 降臨バトルが開催されていない場合、この画面は表示されない
- 開催期間外にアクセスしようとすると、空のミッションリストが返される
- 報酬受け取りも開催期間内のみ実行可能

### ミッション種別
- **イベントミッション**: 降臨バトルのイベントに紐づくミッション（`MissionType.Event`、`EventCategory.AdventBattle`）
- **期間限定ミッション**: 降臨バトルカテゴリの期間限定ミッション（`MissionType.LimitedTerm`、`MissionCategory.AdventBattle`）

### 進捗更新タイミング
- 画面表示時にAPIを呼び出してミッション進捗を更新・取得
- 報酬受け取り後にもミッション状態を再取得して最新化

### 一括受け取りの条件
- 達成済み（`IsCleared = true`）かつ未受け取り（`IsReceivedReward = false`）のミッションが1つ以上ある場合に有効化
- 該当するミッションがない場合はボタンが無効化される

### 報酬受け取りの影響
- 報酬にプレイヤー経験値が含まれる場合、レベルアップの可能性あり
- レベルアップ情報はキャッシュに保存され、後続の画面で参照される
- ヘッダーのステータス表示が更新される（経験値、アイテム所持数など）

### バッジ更新
- 画面を閉じる際、受け取り可能な報酬がある場合はバッジを表示
- 受け取り可能な報酬がない場合はバッジを非表示

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleMissionPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/Presenter/AdventBattleMissionPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/AdventBattleMissionViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/ViewModel/AdventBattleMissionViewModel.cs)
- `Presentation/ViewModels/AdventBattleMissionCellViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/ViewModel/AdventBattleMissionCellViewModel.cs)

#### View
- `Presentation/Views/AdventBattleMissionView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/View/AdventBattleMissionView.cs)
- `Presentation/Views/AdventBattleMissionViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/View/AdventBattleMissionViewController.cs)
- `Presentation/Views/IAdventBattleMissionViewDelegate.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/View/IAdventBattleMissionViewDelegate.cs)

#### UseCase
- `Domain/UseCases/ShowAdventBattleMissionListUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Domain/UseCase/ShowAdventBattleMissionListUseCase.cs)
- `Domain/UseCases/ReceiveAdventBattleMissionRewardUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Domain/UseCase/ReceiveAdventBattleMissionRewardUseCase.cs)
- `Domain/UseCases/BulkReceiveAdventBattleMissionRewardUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Domain/UseCase/BulkReceiveAdventBattleMissionRewardUseCase.cs)

#### Translator
- `Presentation/Translator/AdventBattleMissionViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleMission/Presentation/Translator/AdventBattleMissionViewModelTranslator.cs)

#### Applier
- `Domain/Applier/AdventBattleMissionReceivedRewardApplier.cs`
- `Domain/Applier/AdventBattleMissionReceivedStatusApplier.cs`

#### Evaluator
- `Domain/Evaluator/AdventBattleDateTimeEvaluator.cs`

### AdventBattleMissionViewModelの構造
画面全体のミッション情報を保持するデータ構造
- **AdventBattleMissionCellViewModels**: ミッションセル（各ミッション行）のViewModelリスト
- **IsBulkReceivable**: 一括受け取りボタンの有効/無効フラグ

### AdventBattleMissionCellViewModelの構造
各ミッション行の情報を保持するデータ構造
- **AdventBattleMissionId**: ミッションID（マスタデータID）
- **MissionType**: ミッション種別（`Event` または `LimitedTerm`）
- **MissionStatus**: ミッション状態（`Nothing`, `Receivable`, `Received`など）
- **MissionProgress**: 進捗値（現在値）
- **CriterionCount**: 目標値（達成条件の値）
- **PlayerResourceIconViewModels**: 報酬アイコンのViewModelリスト
- **MissionDescription**: ミッション説明文
- **DestinationScene**: 挑戦ボタンタップ時の遷移先シーン
- **EndTimeSpan**: 残り時間（期間限定ミッションの場合）

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstMissionEvent.Id | mst_mission_events.id | イベントミッションのID |
| MstMissionEvent.MstEventId | mst_mission_events.mst_event_id | イベントID（降臨バトルイベント） |
| MstMissionEvent.CriterionType | mst_mission_events.criterion_type | 達成条件のタイプ（クリア回数、累計ダメージなど） |
| MstMissionEvent.CriterionValue | mst_mission_events.criterion_value | 達成条件の値 |
| MstMissionEvent.CriterionCount | mst_mission_events.criterion_count | 達成条件の回数（目標値） |
| MstMissionEvent.MissionDescription | mst_mission_events.mission_description | ミッション説明文 |
| MstMissionEvent.UnlockCriterionType | mst_mission_events.unlock_criterion_type | 解放条件のタイプ |
| MstMissionEvent.UnlockCriterionValue | mst_mission_events.unlock_criterion_value | 解放条件の値 |
| MstMissionEvent.UnlockCriterionCount | mst_mission_events.unlock_criterion_count | 解放条件の回数 |
| MstMissionEvent.GroupKey | mst_mission_events.group_key | グループキー（ミッショングループ分け用） |
| MstMissionEvent.MstMissionRewardGroupId | mst_mission_events.mst_mission_reward_group_id | 報酬グループID |
| MstMissionEvent.SortOrder | mst_mission_events.sort_order | 表示順序 |
| MstMissionEvent.DestinationScene | mst_mission_events.destination_scene | 挑戦ボタンの遷移先シーン |
| MstMissionEvent.EventCategory | mst_mission_events.event_category | イベントカテゴリ（降臨バトルの場合`AdventBattle`） |
| MstMissionEvent.GroupId | mst_mission_events.group_id | グループID |
| MstMissionEvent.UnlockOrder | mst_mission_events.unlock_order | 解放順序 |
| MstMissionLimitedTerm.Id | mst_mission_limited_terms.id | 期間限定ミッションのID |
| MstMissionLimitedTerm.MissionProgressGroupKey | mst_mission_limited_terms.mission_progress_group_key | 進捗グループキー |
| MstMissionLimitedTerm.MissionCriterionType | mst_mission_limited_terms.mission_criterion_type | 達成条件のタイプ |
| MstMissionLimitedTerm.CriterionValue | mst_mission_limited_terms.criterion_value | 達成条件の値 |
| MstMissionLimitedTerm.CriterionCount | mst_mission_limited_terms.criterion_count | 達成条件の回数（目標値） |
| MstMissionLimitedTerm.MissionDescription | mst_mission_limited_terms.mission_description | ミッション説明文 |
| MstMissionLimitedTerm.MissionCategory | mst_mission_limited_terms.mission_category | ミッションカテゴリ（降臨バトルの場合`AdventBattle`） |
| MstMissionLimitedTerm.MstMissionRewardGroupId | mst_mission_limited_terms.mst_mission_reward_group_id | 報酬グループID |
| MstMissionLimitedTerm.SortOrder | mst_mission_limited_terms.sort_order | 表示順序 |
| MstMissionLimitedTerm.DestinationScene | mst_mission_limited_terms.destination_scene | 挑戦ボタンの遷移先シーン |
| MstMissionLimitedTerm.GroupId | mst_mission_limited_terms.group_id | グループID |
| MstMissionLimitedTerm.UnlockOrder | mst_mission_limited_terms.unlock_order | 解放順序 |
| MstMissionLimitedTerm.StartDate | mst_mission_limited_terms.start_date | ミッション開始日時 |
| MstMissionLimitedTerm.EndDate | mst_mission_limited_terms.end_date | ミッション終了日時 |
| MstMissionReward.Id | mst_mission_rewards.id | 報酬ID |
| MstMissionReward.GroupId | mst_mission_rewards.group_id | 報酬グループID（MstMissionEvent/LimitedTermと紐付け） |
| MstMissionReward.ResourceType | mst_mission_rewards.resource_type | 報酬リソースタイプ（アイテム、通貨など） |
| MstMissionReward.ResourceId | mst_mission_rewards.resource_id | 報酬リソースID（アイテムIDなど） |
| MstMissionReward.ResourceAmount | mst_mission_rewards.resource_amount | 報酬数量 |
| MstMissionReward.SortOrder | mst_mission_rewards.sort_order | 報酬の表示順序 |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserMissionEvent.MstMissionEventId | user_mission_events.mst_mission_event_id | イベントミッションID |
| UserMissionEvent.Progress | user_mission_events.progress | 現在の進捗値 |
| UserMissionEvent.IsCleared | user_mission_events.is_cleared | 達成済みフラグ |
| UserMissionEvent.IsReceivedReward | user_mission_events.is_received_reward | 報酬受け取り済みフラグ |
| UserMissionLimitedTerm.MstMissionLimitedTermId | user_mission_limited_terms.mst_mission_limited_term_id | 期間限定ミッションID |
| UserMissionLimitedTerm.Progress | user_mission_limited_terms.progress | 現在の進捗値 |
| UserMissionLimitedTerm.IsCleared | user_mission_limited_terms.is_cleared | 達成済みフラグ |
| UserMissionLimitedTerm.IsReceivedReward | user_mission_limited_terms.is_received_reward | 報酬受け取り済みフラグ |
| UserParameter.Level | user_parameters.level | プレイヤーレベル（報酬受け取り時のレベルアップ判定に使用） |
| UserParameter.Exp | user_parameters.exp | プレイヤー経験値（報酬受け取り時の更新に使用） |

### 呼び出しているAPI

#### 画面表示時
- **POST `/api/mission/advent_battle_fetch`**: 降臨バトルミッション情報取得
  - パラメータ: なし
  - 用途: 降臨バトル関連のミッション進捗を更新し、最新のミッション一覧を取得

#### 個別受け取り時
- **POST `/api/mission/bulk_receive_reward`**: ミッション報酬受け取り（個別）
  - パラメータ:
    - `missionType` (ミッション種別: `Event` または `LimitedTerm`)
    - `mstMissionIds` (ミッションIDの配列、個別の場合は1件のみ)
  - 用途: 指定したミッションの報酬を受け取り、ユーザーデータを更新

#### 一括受け取り時
- **POST `/api/mission/bulk_receive_reward`**: ミッション報酬一括受け取り
  - パラメータ:
    - `missionType` (ミッション種別: `LimitedTerm`)
    - `mstMissionIds` (受け取り可能なすべてのミッションIDの配列)
  - 用途: 達成済み・未受け取りのすべてのミッションの報酬をまとめて受け取り
