# ガチャラインアップダイアログ

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャラインアップダイアログ |
| **画面番号** | 71-1-12 |
| **画面種別** | モーダルダイアログ |

## 概要

ガチャの提供割合（BNEレギュレーション）を表示するダイアログです。プレイヤーはガチャから排出されるキャラクターやアイテムの一覧と、レアリティごとの提供確率を確認できます。タブ機能により、通常提供割合、確定枠（SSR以上）、最高レアリティ（UR）、ピックアップアイテムなど、カテゴリ別に情報を切り替えて閲覧できます。

## プレイヤーができること

### 提供割合の確認

#### タブ切り替えによる情報表示
- **通常タブ**: すべてのレアリティの提供割合を表示
- **確定枠タブ（SSR以上）**: 10連ガチャの確定枠の提供割合を表示（該当ガチャのみ）
- **URタブ**: UR（最高レアリティ）の提供割合のみを表示（該当ガチャのみ）
- **ピックアップタブ**: ピックアップ対象アイテムの提供割合を表示（該当ガチャのみ）
- タブをタップすることで表示内容が切り替わる
- タブ切り替え時、スクロール位置は自動的に最上部に戻る

#### レアリティ別の一覧表示
各タブ内で以下のレアリティごとにアイテムが表示される：
- **UR（Ultra Rare）**: 最高レアリティ
- **SSR（Super Super Rare）**: 超高レアリティ
- **SR（Super Rare）**: 高レアリティ
- **R（Rare）**: 通常レアリティ

各レアリティカテゴリには以下の情報が表示される：
- レアリティ名と提供確率（例: 「UR 3.0%」）
- そのレアリティに含まれるアイテム一覧（アイコン、キャラクター名、アイテム名）

### ダイアログの操作

#### 閉じる
- 画面上部の閉じるボタンをタップ
- ESCキー/戻るボタンでも閉じられる
- 閉じると元のガチャ画面に戻る

#### スクロール
- 提供アイテムが多い場合、縦スクロールで全体を閲覧可能

## 画面の要素

### ヘッダー部分
- タイトル表示
- 閉じるボタン（×アイコン）

### タブエリア
- 通常タブ（常に表示）
- 確定枠タブ（ガチャに確定枠がある場合のみ表示、タブテキストは動的）
- URタブ（URが提供される場合のみ表示）
- ピックアップタブ（ピックアップアイテムがある場合のみ表示）

タブの表示条件：
- すべてのタブが空（通常タブのみ）の場合、タブ自体が非表示になる
- 各タブは対応するデータが存在する場合のみ表示される

### メイン表示エリア
- スクロール可能なコンテンツエリア
- レアリティごとのセクション
  - レアリティ名と提供確率の見出し
  - アイテム一覧（グリッド形式）
    - アイテムアイコン
    - キャラクター名
    - リソース名
    - 番号パリティ（偶数/奇数による表示制御）

## 画面遷移

### この画面への遷移
- **ガチャコンテンツ画面**: 「ラインアップ」ボタンをタップ
- **ガチャ詳細ダイアログ**: 「ラインアップ」ボタンをタップ

### この画面からの遷移
- **閉じる操作**: 元のガチャ画面（遷移元画面）に戻る
  - GachaWireFrameのコールバックアクション経由で遷移元に戻る

## ゲーム仕様・制約事項

### タブ表示ルール
- 通常タブは必ず存在し、すべてのレアリティのアイテムを表示
- 確定枠タブは、10連ガチャでSSR以上確定などの仕様があるガチャのみ表示
- 確定枠タブのテキストは、ガチャごとに異なる文言が設定可能（例: 「SSR以上確定」「UR確定」など）
- URタブは、URレアリティのアイテムが提供されるガチャのみ表示
- ピックアップタブは、ピックアップ対象アイテムが設定されているガチャのみ表示

### 提供割合の計算
- 画面表示時にサーバーAPIを呼び出し、最新の提供割合データを取得
- レアリティごとの総確率と、各アイテムの個別確率が表示される

### スクロール動作
- タブ切り替え時は自動的にスクロール位置が最上部（verticalNormalizedPosition = 1）に戻る
- レイアウトの再計算が自動的に行われる

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaLineupDialogPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/Presenters/GachaLineupDialogPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaLineupDialogViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/ViewModels/GachaLineupDialogViewModel.cs)
- `Presentation/ViewModels/GachaLineupPageViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/ViewModels/GachaLineupPageViewModel.cs)
- `Presentation/ViewModels/GachaLineupListViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/ViewModels/GachaLineupListViewModel.cs)
- `Presentation/ViewModels/GachaLineupCellViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/ViewModels/GachaLineupCellViewModel.cs)
- `Presentation/ViewModels/GachaLineupCellListViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/ViewModels/GachaLineupCellListViewModel.cs)

#### View
- `Presentation/Views/GachaLineupDialogView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/Views/GachaLineupDialogView.cs)
- `Presentation/Views/GachaLineupDialogViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/Views/GachaLineupDialogViewController.cs)

#### UseCase
- `Domain/UseCases/GachaLineupDialogUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Domain/UseCases/GachaLineupDialogUseCase.cs)

#### Translator
- `Presentation/Translator/GachaLineupDialogViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Presentation/Translator/GachaLineupDialogViewModelTranslator.cs)

#### Factory
- `Domain/Factory/GachaLineupPageModelFactory.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaLineupDialog/Domain/Factory/GachaLineupPageModelFactory.cs)

### GachaLineupDialogViewModelの構造

データ階層は以下の通り：

```
GachaLineupDialogViewModel
├── NormalRatioPageViewModel (GachaLineupPageViewModel) - 通常タブ
│   ├── GachaPickupListViewModel (GachaLineupListViewModel) - ピックアップリスト
│   │   ├── URareLineupCellListViewModel (レアリティ別セル)
│   │   ├── SSRareLineupCellListViewModel
│   │   ├── SRareLineupCellListViewModel
│   │   └── RLineupCellListViewModel
│   └── GachaLineupListViewModel (GachaLineupListViewModel) - 通常ラインアップリスト
│       ├── URareLineupCellListViewModel
│       ├── SSRareLineupCellListViewModel
│       ├── SRareLineupCellListViewModel
│       └── RLineupCellListViewModel
├── SSRRatioPageViewModel (GachaLineupPageViewModel) - 確定枠タブ
├── URRatioPageViewModel (GachaLineupPageViewModel) - URタブ
├── PickupRatioPageViewModel (GachaLineupPageViewModel) - ピックアップタブ
└── GachaFixedPrizeDescription (確定枠の説明文字列)
```

#### GachaLineupCellListViewModel
- `RatioProbabilityAmount`: レアリティと提供確率
- `GachaLineupCellViewModels`: そのレアリティに含まれるアイテムのリスト

#### GachaLineupCellViewModel
- `ResourceModel`: ガチャリソースモデル
- `PlayerResourceIconViewModel`: アイテムアイコン情報
- `CharacterName`: キャラクター名
- `ResourceName`: リソース名
- `NumberParity`: 番号パリティ（偶数/奇数）
- `ClickIconEvent`: アイコンクリック時のイベント

#### GachaLineupListViewModel
- `TotalCellCount`: すべてのレアリティの総アイテム数を計算するプロパティ

### 画面初期化時の引数

```csharp
GachaLineupDialogViewController.Argument(
    MasterDataId OprGachaId,              // ガチャID
    GachaLineupDialogViewModel ViewModel  // 表示用ViewModel
)
```

- **OprGachaId**: どのガチャの提供割合を表示するかを特定
- **ViewModel**: 提供割合データを含む表示用データ（API取得後に生成される）

### 呼び出しているAPI

#### 画面表示時
- **GET `/api/gacha/prize`**: ガチャ提供割合取得API
  - パラメータ: `oprGachaId` (ガチャID)
  - 用途: ガチャの提供割合データ（レアリティ別、ピックアップ、確定枠など）を取得
  - 取得データ:
    - `NormalPrizePageModel`: 通常提供割合（全レアリティ）
    - `NormalPrizeInFixedPageModel`: 確定枠の提供割合（SSR以上など）
    - `UpperPrizeInMaxRarityPageModel`: 最高レアリティ（UR）の提供割合
    - `UpperPrizeInPickupPageModel`: ピックアップアイテムの提供割合

### タブタイプ定義

```csharp
enum GachaRatioTabType
{
    NormalRatioTab,   // 通常タブ
    SSRRatioTab,      // 確定枠タブ（SSR以上）
    URRatioTab,       // URタブ
    PickupRatioTab    // ピックアップタブ
}
```

### 画面遷移制御
- `GachaWireFrame.OnCloseGachaLineUpDialogViewAndInvokeAction()` を経由してダイアログを閉じる
- 閉じる際にコールバックアクション（`OnGachaLineUpCloseAction`）が実行され、遷移元画面に制御が戻る
