# ガチャ提供割合表示画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャ提供割合表示画面（GachaRatio） |
| **画面番号** | 71-1-12 |
| **画面種別** | モーダル画面 |

## 概要

ガチャの提供割合を確認できる画面です。ガチャで入手できるキャラクターやアイテムの出現確率を、レアリティ別や提供内容のタイプ別に詳細に表示します。

BNE（景品表示法）の規制要件に準拠した情報開示を行うための画面で、プレイヤーは自身が引きたいガチャの確率情報を事前に確認できます。

## プレイヤーができること

### 提供割合の閲覧

#### レアリティ別の提供割合確認
- 各レアリティ（UR、SSR、SR、R）の全体的な出現確率を確認
- パーセンテージ表示で視覚的に把握

#### タブ切り替えによる詳細確認
4つのタブで異なる提供割合情報を表示：
- **通常枠**: 通常のガチャ枠での提供割合
- **SSR確定枠**: SSR確定時の提供割合（該当する場合）
- **UR確定枠**: UR確定時の提供割合（該当する場合）
- **ピックアップ枠**: ピックアップ対象の提供割合

### 個別アイテムの確率確認

#### ラインナップリスト
- レアリティごとにグループ化された一覧表示
- 各アイテムの個別出現確率を表示
- キャラクター名/アイテム名の確認
- アイコンタップでさらに詳細を確認可能

#### ピックアップアイテムリスト
- ピックアップ対象アイテムの専用リスト
- 通常ラインナップよりも高確率であることを確認可能

### 画面操作

#### 閉じる操作
- 閉じるボタンをタップして画面を閉じる
- Escapeキー（デバッグ用）でも閉じることが可能

#### スクロール操作
- 縦スクロールで長いリストを閲覧
- スクロール位置は自動で管理される

## 画面の要素

### ヘッダー部分
- 画面タイトル「提供割合」
- 閉じるボタン（×）

### タブエリア
- 4つのタブボタン
  - 通常枠タブ
  - SSR確定枠タブ
  - UR確定枠タブ
  - ピックアップ枠タブ
- 選択中のタブがハイライト表示
- タブの内容は対象ガチャによって変動

### メイン表示エリア

#### レアリティ別確率表示
- UR、SSR、SR、Rの4段階で確率を表示
- パーセンテージ数値とレアリティアイコン

#### ピックアップリスト（該当する場合）
- ピックアップ対象のキャラクター/アイテム一覧
- 各アイテムの個別確率
- アイコン画像
- キャラクター名/アイテム名
- 出現確率（%表示）

#### 全ラインナップリスト
- レアリティごとにセクション分け
- 各セクション内の合計確率表示
- 個別アイテムの詳細情報
  - アイコン画像
  - キャラクター名/アイテム名
  - 個別出現確率（%表示）
- 偶数/奇数行で背景色を変えて見やすく表示

### スクロールエリア
- 縦スクロール可能な一覧表示
- スムーズなスクロール動作
- 自動的に前回の位置を保持

## 画面遷移

### この画面への遷移
- **ガチャコンテンツ画面**: 「提供割合」ボタンをタップ
  - ガチャIDとViewModel（API取得済みデータ）を引数として受け取る

### この画面からの遷移
- **閉じる操作**: 元の画面（ガチャコンテンツ画面）に戻る
- **アイコンタップ**: 詳細画面への遷移（実装による）

## ゲーム仕様・制約事項

### 提供割合の種類

#### 通常枠（NormalRatioTab）
- 基本的なガチャ枠での提供割合
- すべてのガチャで表示される

#### SSR確定枠（SSRRatioTab）
- SSR以上が確定する枠での提供割合
- 該当するガチャのみ表示

#### UR確定枠（URRatioTab）
- UR確定枠での提供割合
- 該当するガチャのみ表示（高レアリティ確定ガチャなど）

#### ピックアップ枠（PickupRatioTab）
- ピックアップキャラクター/アイテムの提供割合
- ピックアップガチャの場合のみ表示

### 表示内容の制御

#### データ取得タイミング
- 画面表示前にガチャコンテンツ画面でAPIからデータ取得済み
- この画面では受け取ったデータを表示のみ

#### タブの表示条件
- データが空の場合、該当タブは非表示または無効化される可能性
- 初期表示は通常枠タブ

#### 確率表示
- 小数点以下の桁数はOutputRatioクラスで管理
- 合計100%になるよう調整されたデータ

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaRatio/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaRatioPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaRatio/Presentation/Presenters/GachaRatioPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaRatioDialogViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaRatio/Presentation/ViewModels/GachaRatioDialogViewModel.cs)
- `Presentation/ViewModels/GachaRatioPageViewModel.cs`
- `Presentation/ViewModels/GachaRatioByRarityViewModel.cs`
- `Presentation/ViewModels/GachaRatioLineupListViewModel.cs`
- `Presentation/ViewModels/GachaRatioLineupCellViewModel.cs`
- `Presentation/ViewModels/GachaRatioLineupViewModel.cs`
- `Presentation/ViewModels/GachaRatioRarityRatioItemViewModel.cs`

#### View
- `Presentation/Views/GachaRatioDialogViewController.cs`

#### UseCase
- `Domain/UseCases/GachaRatioDialogUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaRatio/Domain/UseCases/GachaRatioDialogUseCase.cs)

#### Translator
- `Presentation/Translator/GachaRatioDialogViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaRatio/Presentation/Translator/GachaRatioDialogViewModelTranslator.cs)

### GachaRatioDialogViewModelの構造

画面全体のデータ構造：
- `NormalRatioPageViewModel`: 通常枠のページデータ
- `SSRRatioPageViewModel`: SSR確定枠のページデータ
- `URRatioPageViewModel`: UR確定枠のページデータ
- `PickupRatioPageViewModel`: ピックアップ枠のページデータ
- `GachaFixedPrizeDescription`: 確定演出の説明テキスト

#### GachaRatioPageViewModel（各タブのデータ）
- `ByRarityViewModel`: レアリティ別の合計確率
  - UR、SSR、SR、Rの4つの確率
- `GachaRatioPickupListViewModel`: ピックアップアイテムリスト
- `GachaRatioLineupListViewModel`: 全ラインナップリスト
  - レアリティごとにグループ化
  - 各グループの合計確率
  - 個別アイテムのセルViewModel

#### GachaRatioLineupCellViewModel（個別アイテム）
- `ResourceModel`: リソース情報
- `PlayerResourceIconViewModel`: アイコン表示用データ
- `CharacterName`: キャラクター名
- `ResourceName`: リソース名
- `OutputRatio`: 出現確率
- `NumberParity`: 偶数奇数判定（背景色制御用）
- `ClickIconEvent`: アイコンタップ時のイベント

### 画面初期化時の引数

```csharp
GachaRatioDialogViewController.Argument(
    MasterDataId oprGachaId,  // ガチャID
    GachaRatioDialogViewModel viewModel  // 表示データ（API取得済み）
)
```

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **OprGacha**<br>ガチャ基本情報 | GachaFixedPrizeDescription | 確定演出の説明テキスト（例：「SR以上1体確定」「ピックアップキャラ確定」など） |

#### APIレスポンス（GachaPrizeResultData）

提供割合情報はこの画面では API(`GET /api/gacha/prize`)から取得するため、クライアント側のマスタデータではなく、サーバーから動的に返されるデータです。

| データ項目 | 説明 |
|----------|------|
| **RarityProbabilities** | 各レアリティ（UR、SSR、SR、R）の全体的な出現確率 |
| **ProbabilityGroups** | 各レアリティ内のグループ分けされた確率情報 |
| **FixedProbabilities** | 確定枠（SSR確定、UR確定など）での提供割合 |
| **UpperProbabilities** | ピックアップ枠での提供割合 |

### 呼び出しているAPI

#### 画面初期化時（UseCaseで呼び出し）
- **GET `/api/gacha/prize`**: ガチャ提供割合取得API
  - パラメータ: `oprGachaId` (ガチャマスターデータID)
  - 用途: ガチャの提供割合情報をすべて取得
  - レスポンス内容:
    - 通常枠の提供割合
    - SSR確定枠の提供割合
    - UR確定枠の提供割合
    - ピックアップ枠の提供割合
    - 各レアリティの合計確率
    - 個別アイテムの出現確率

### タブ種別定数

`Domain/Constants/GachaRatioTabType.cs`で定義：
- `NormalRatioTab`: 通常枠
- `SSRRatioTab`: SSR確定枠
- `URRatioTab`: UR確定枠
- `PickupRatioTab`: ピックアップ枠
