# 降臨バトル結果画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトル結果画面 |
| **画面番号** | 44-1-10-1 |
| **画面種別** | モーダル画面 |

## 概要

降臨バトル（スコアチャレンジ型コンテンツ）のバトル終了後に表示される結果画面です。バトルで獲得したスコアの詳細と総合スコア、ランクアップ演出、獲得報酬を段階的に表示します。スコアに応じてBronze、Silver、Gold、Masterのランクとレベルが設定され、ランクアップした場合は専用のエフェクト演出が再生されます。

## プレイヤーができること

### スコア確認

#### 詳細スコアの確認
- ダメージスコア、敵撃破スコア、ボス撃破スコアの3種類を確認
- スライドインアニメーションとカウントアップアニメーションで表示
- アニメーション中でもタップでスキップ可能

#### 総合スコアの確認
- 今回の総合スコアを表示
- ハイスコア更新時は「NEW RECORD」表示
- スコアランク達成度ゲージのアニメーション表示

### ランクアップ演出

#### ランク昇格の確認
- Bronze → Silver → Gold → Master の順でランクアップ
- 各ランクには複数のレベルが存在
- ランクアップまたはランクレベルアップ時に専用モーダルを表示
- ランクアップモーダルでは以下を表示：
  - ランクアップエフェクト
  - 到達したランクとレベル
  - 獲得したランク報酬

#### ランクアップモーダルの操作
- スキップボタンでアニメーションをスキップ
- 全アニメーション完了後、閉じるボタンで閉じる

### 報酬確認

#### 獲得報酬の確認
- バトルで獲得した報酬アイテムを表示
- アイテムアイコンをタップで詳細表示
- 獲得ユニットがある場合は専用の獲得演出を表示

### バトル再挑戦

#### リトライ機能
- 再挑戦ボタンからバトルをリトライ
- スタミナ不足時はスタミナブースト確認を表示
- アニメーション完了後に再挑戦ボタンが有効化

### 画面操作

#### アニメーションスキップ
- 画面タップでアニメーションをスキップ
- 段階的にスキップ：詳細スコア → 総合スコア → ランクパネル → 報酬表示

#### ユーザーレベルアップ
- バトルで経験値を獲得しレベルアップした場合、結果演出後に表示

## 画面の要素

### ヘッダー部分
- イベントキャンペーン残り時間（該当する場合）
- 閉じるボタン

### スコア表示エリア

#### 詳細スコアパネル
- ダメージスコア
- 敵撃破スコア
- ボス撃破スコア
- 矢印アイコン（加算表現）

#### 総合スコアパネル
- 今回の総合スコア
- ハイスコア
- NEW RECORDマーク（更新時）

#### ランクパネル
- 現在のランクタイプ（Bronze/Silver/Gold/Master）
- ランクレベル
- ランク達成度ゲージ
- 次のランクまでの必要スコア表示

### 報酬表示エリア
- 獲得報酬アイテムのアイコンリスト
- スクロール可能（多数の報酬がある場合）

### ボタンエリア
- 閉じるボタン（全アニメーション完了後に「タップして閉じる」テキスト表示）
- 再挑戦ボタン（アニメーション完了後に有効化）

## 画面遷移

### この画面への遷移
- **降臨バトル画面**: バトル勝利時に自動的に表示

### この画面からの遷移
- **アイテム詳細モーダル**: 報酬アイテムのアイコンをタップ
  - トランジションなしのレイアウト保持表示
- **ユニット獲得演出画面**: 新規ユニット獲得時に自動的に表示
  - ランクアップ演出後に表示
- **ユーザーレベルアップ画面**: レベルアップ時に自動的に表示
  - 報酬表示完了後に表示
- **ランクアップエフェクトモーダル**: ランクまたはランクレベルアップ時に自動的に表示
  - ランクパネルアニメーション後に表示
- **降臨バトル画面**: 再挑戦ボタンをタップ
  - スタミナ確認・ブースト確認を経てバトルを再実行
- **前の画面**: 閉じるボタンをタップ

## ゲーム仕様・制約事項

### スコア計算
- ダメージスコア: バトル中に与えたダメージ量に応じて算出
- 敵撃破スコア: 撃破した敵の数に応じて算出
- ボス撃破スコア: ボス敵の撃破に応じて算出
- 総合スコア = ダメージスコア + 敵撃破スコア + ボス撃破スコア

### ランクシステム
- ランクタイプ: Bronze → Silver → Gold → Master（4段階）
- 各ランクタイプに複数のレベルが存在
- 必要スコアを達成することでランクまたはレベルがアップ
- Masterランクの最大レベルに到達すると、それ以上のランクアップなし

### ランクアップ演出の条件
- ランクタイプが上昇した場合（例: Bronze → Silver）
- 同じランクタイプ内でレベルが上昇した場合（例: Silver Lv.1 → Lv.2）
- 複数ランク・レベルを一度に飛び越えた場合は、最終到達ランク・レベルを表示

### ランク報酬
- ランクアップ時に対応する報酬を獲得
- 報酬は降臨バトルごとに設定される

### アニメーション演出
- アニメーションは段階的に再生：
  1. 詳細スコアスライドイン
  2. 詳細スコアカウントアップ
  3. 総合スコアスライドイン
  4. 総合スコアカウントアップ
  5. ランクパネル表示
  6. ランクアップエフェクト（該当時）
  7. ユニット獲得演出（該当時）
  8. 報酬表示

### 再挑戦機能
- 再挑戦ボタンは全アニメーション完了後に有効化
- スタミナ不足時はスタミナブースト確認ダイアログを表示
- スタミナブーストを使用するか、スタミナ回復アイテムを使用して再挑戦可能

### イベントキャンペーン
- 降臨バトルがイベントキャンペーン対象の場合、残り時間を表示

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleResultPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/Presenter/AdventBattleResultPresenter.cs)
- `Presentation/Presenters/AdventBattleResultRankUpEffectPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/Presenter/AdventBattleResultRankUpEffectPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/AdventBattleResultViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/ViewModel/AdventBattleResultViewModel.cs)
- `Presentation/ViewModels/AdventBattleResultScoreViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/ViewModel/AdventBattleResultScoreViewModel.cs)
- `Presentation/ViewModels/AdventBattleResultScoreRankTargetViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/ViewModel/AdventBattleResultScoreRankTargetViewModel.cs)

#### View
- `Presentation/Views/AdventBattleResultView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/View/AdventBattleResultView.cs)
- `Presentation/Views/AdventBattleResultViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/View/AdventBattleResultViewController.cs)
- `Presentation/Views/AdventBattleResultRankUpEffectView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/View/AdventBattleResultRankUpEffectView.cs)
- `Presentation/Views/AdventBattleResultRankUpEffectViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/View/AdventBattleResultRankUpEffectViewController.cs)

#### Model
- `Domain/Model/AdventBattleResultScoreModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Domain/Model/AdventBattleResultScoreModel.cs)
- `Domain/Model/AdventBattleResultScoreRankTargetModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Domain/Model/AdventBattleResultScoreRankTargetModel.cs)

#### Factory
- `Domain/Factory/AdventBattleResultScoreModelFactory.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Domain/Factory/AdventBattleResultScoreModelFactory.cs)
- `Presentation/Factory/AdventBattleResultScoreViewModelFactory.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleResult/Presentation/Factory/AdventBattleResultScoreViewModelFactory.cs)

### AdventBattleResultViewModelの構造
バトル結果画面全体の情報を保持

- **AcquiredPlayerResources**: 獲得した報酬リソースのアイコンViewModel
- **CurrentScore**: 今回の総合スコア
- **HighScore**: ハイスコア
- **NewRecordFlag**: ハイスコア更新フラグ
- **AdventBattleResultScoreViewModel**: スコアとランク情報（詳細）
- **RemainingEventCampaignTimeSpan**: イベントキャンペーン残り時間
- **UserLevelUpResult**: ユーザーレベルアップ結果
- **IsRetryAvailable**: 再挑戦可能フラグ

### AdventBattleResultScoreViewModelの構造
スコアとランク情報の詳細を保持

- **CurrentRankType**: 現在のランクタイプ（Bronze/Silver/Gold/Master）
- **CurrentScoreRankLevel**: 現在のランクレベル
- **AdventBattleResultScoreRankTargetModels**: ランクアップ目標情報のリスト
- **RankRewards**: ランク報酬のリスト
- **DamageScore**: ダメージスコア
- **EnemyDefeatScore**: 敵撃破スコア
- **BossEnemyDefeatScore**: ボス撃破スコア

**ランクアップ判定ロジック**：
- `IsRankOrRankLevelUp()`: ランクまたはランクレベルがアップしたかを判定
- `LastAchievedRankAndLevel()`: 最後に達成したランクとレベルを取得
- `IsScoreUpdated()`: スコアが更新されたかを判定

### AdventBattleResultScoreRankTargetViewModelの構造
ランクアップ目標の情報を保持

- **BeforeTotalScore**: 加算前の総合スコア
- **AfterTotalScore**: 加算後の総合スコア
- **TargetRankLowerRequiredScore**: 目標ランクの必要最低スコア
- **TargetRankType**: 目標ランクタイプ
- **TargetScoreRankLevel**: 目標スコアランクレベル
- **BeforeGaugeRate**: 加算前のゲージ割合
- **AfterGaugeRate**: 加算後のゲージ割合

**達成判定ロジック**：
- `IsAchievedRank()`: 目標ランクを達成したかを判定
- `IsTargetMaxRankLevel()`: 最大ランクレベルに到達したかを判定
- `IsScoreUpdated()`: スコアが更新されたかを判定

### 画面初期化時の引数
```csharp
AdventBattleResultViewController.Argument(AdventBattleResultViewModel)
```
バトル結果のスコア、報酬、ランク情報などを含むViewModelを引数として受け取ります。

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattleScoreRank.Id | mst_advent_battle_ranks.id | ランクマスタID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_ranks.mst_advent_battle_id | 降臨バトルID（どの降臨バトルのランク設定か） |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold/Master） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_ranks.rank_level | ランクレベル（各ランクタイプ内の細かいレベル） |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_ranks.required_lower_score | このランクとレベル到達に必要な最低スコア |

- **クライアント定義**: glow-client実装での使われ方の定義情報（アッパーキャメルの単数クラス名.プロパティ名）
- **サーバー定義**: glow-server/DB上での定義情報（スネークケースの複数形テーブル名.スネークケースのカラム名）
- **クライアント説明**: glow-client実装での対象画面での使われ方を簡潔に説明

#### ユーザーデータ（GameFetch）

この画面では、バトル結果時点で既にスコアやランク情報が算出されているため、GameFetchで取得されるユーザーデータは直接参照されません。バトル結果情報（VictoryResultModel）として渡されたデータを表示します。

### BGM
- BGM_victory_result（勝利リザルトBGM）をクロスフェードで再生

### サウンドエフェクト
- SSE_051_002（ランクアップエフェクトモーダルでのランクアップ演出時）

### データの流れ

1. **InGamePresenter**: バトル終了時に結果データを生成
   - `VictoryResultModel` を受け取り、`AdventBattleResultViewModel` を構築
   - スコア情報、報酬情報、ランクアップ情報を含む

2. **AdventBattleResultScoreModelFactory**: ランク情報の生成
   - バトル前のスコアとバトル後のスコアを比較
   - 達成したランクとレベルを計算
   - ランクアップ演出用のアニメーションデータ（ゲージ割合など）を生成

3. **AdventBattleResultScoreViewModelFactory**: Presentation層への変換
   - Domain層のModelをViewModel層に変換
   - ゲージ割合の計算など、表示用の情報を加工

4. **AdventBattleResultPresenter**: アニメーション制御
   - 段階的なアニメーションの実行とスキップ制御
   - ランクアップ判定と専用モーダルの表示制御
   - ユーザーレベルアップ結果の表示制御
