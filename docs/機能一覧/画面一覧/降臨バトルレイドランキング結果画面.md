# 降臨バトルレイドランキング結果画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルレイドランキング結果画面 |
| **画面番号** | 44-4-3-1 |
| **画面種別** | モーダルダイアログ |

## 概要

降臨バトルのレイド（協力バトル）タイプでランキング期間が終了した際に、プレイヤーのランキング結果を表示するダイアログです。ホーム画面への登場時に自動的にポップアップ表示され、プレイヤーの最終順位、スコア、獲得した報酬をアニメーション付きで演出します。

この画面はレイド型の降臨バトルに特化しており、通常のスコアチャレンジタイプとは別の専用UIを持ちます。

## プレイヤーができること

### ランキング結果の確認

#### スコアと順位の表示
- 降臨バトル名とランキング結果タイトルが表示される
- 自分が獲得した最高スコアが表示される
- スライドインアニメーションで画面が登場

#### 敵キャラクターの確認
- 降臨バトルのボスキャラクターがアニメーション付きで登場
- キャラクターが待機モーションでループ再生される

#### 獲得報酬の確認
- ランキング順位に応じた報酬が表示される
- 報酬パネルが拡張アニメーションで表示される
- 報酬アイテムがアニメーション付きで順番に表示される

### アニメーションのスキップ

#### 画面タップによるスキップ
- アニメーション再生中に画面をタップすると該当アニメーションをスキップ
- スキップは以下の順序で段階的に実行される：
  1. スライドインアニメーションをスキップ
  2. 敵キャラクターアニメーションをスキップ
  3. 報酬アニメーションをスキップ
  4. 全アニメーション完了後のタップでダイアログを閉じる

### ダイアログを閉じる

#### 全演出完了後の終了
- すべてのアニメーションが完了した状態で画面をタップ
- ダイアログが閉じて元の画面に戻る
- 閉じた際にコールバック処理が実行される（呼び出し元で定義）

## 画面の要素

### ヘッダー部分
- **タイトルテキスト**: 「{降臨バトル名}ランキング結果」の形式で表示

### メイン表示エリア
- **ボスキャラクター表示**: 降臨バトルのボス敵ユニット画像
  - 3Dモデル（Spine）がアニメーション表示される
  - 影コンポーネント付き
  - キャラクターがいない場合は非表示
- **スコア表示**: プレイヤーの獲得スコア
  - 数値フォーマットで見やすく表示

### 報酬表示エリア
- **報酬パネル**: 獲得した報酬アイテムのリスト
  - アイコンリスト形式で表示
  - アニメーション付きで順次表示
  - 報酬がない場合は空のまま

### アニメーション要素
- **スライドインアニメーション**: 画面全体の登場演出
- **ボス激突アニメーション**: ボスキャラクターの登場演出
- **報酬拡張アニメーション**: 報酬パネルの展開演出
- **報酬アイテムアニメーション**: 個別アイテムの表示演出

## 画面遷移

### この画面への遷移
- **ホーム画面**: 降臨バトルランキング集計完了後、ホーム画面登場時に自動表示
  - 条件：レイドタイプの降臨バトルのランキング結果が存在する
  - 条件：ランキング順位が1位以上（0位ではない）
  - 条件：まだ再生していない結果である
  - 条件：終了から30日以内

### この画面からの遷移
- **ホーム画面に戻る**: 画面タップでダイアログを閉じる
  - 全アニメーション完了後のタップで発動
  - コールバック処理が実行された後、モーダルがDismissされる

## ゲーム仕様・制約事項

### 表示条件

#### 降臨バトルタイプ
- レイドタイプ（協力バトル）の降臨バトルのみ表示
- スコアチャレンジタイプは別の画面（AdventBattleRankingResult）を使用

#### ランキング結果の有効性
- ランキング順位が0位（ランキング圏外）の場合は表示しない
- ランキング結果が空の場合は表示しない

#### 表示タイミング制御
- 降臨バトル終了から集計時間（デフォルト：設定で変更可能）を経過した時点で表示対象
- 同じ降臨バトルの結果は1回のみ表示（再生済みフラグで管理）
- 降臨バトル終了から30日以上経過した結果は表示しない

### アニメーション仕様

#### スキップ動作
- アニメーション中に画面をタップすると現在再生中のアニメーションをスキップ
- スキップ時は該当アニメーションの最終フレームに即座に移行
- 次のアニメーションに自動的に進む

#### アニメーション順序
1. スライドインアニメーション（"SlideIn"）
2. 敵アイコンアニメーション（"BossClash" → "BossClashResult_in"）
3. 敵ループアニメーション（"BossClashResult_loop"）
4. 報酬パネルアニメーション（"ExpandReward"）
5. 獲得アイテムアニメーション（アイコンごとに順次表示）

### 報酬表示ロジック

#### ランキング報酬の特定
- 降臨バトルの報酬グループからランキングカテゴリの報酬を抽出
- プレイヤーの順位以上で最も近い報酬条件の報酬を選択
- 該当する報酬がない場合は空リストを表示

#### スコアランク判定
- プレイヤーのトータルスコアから該当するスコアランクを特定
- 必要下限スコアを満たす最高ランクを選択
- ランクタイプ（Bronze/Silver/Gold等）とランクレベルを取得

### 再生管理

#### 再生済みフラグ
- PreferenceRepositoryに降臨バトルIDを保存
- 同じ降臨バトルIDの結果は2回目以降表示しない
- アニメーション開始前ではなく、API取得成功時に保存

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRaidRankingResult/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleRaidRankingResultPresenter.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRaidRankingResult/Presentation/Presenters/AdventBattleRaidRankingResultPresenter.cs`

#### ViewController
- `Presentation/Views/AdventBattleRaidRankingResultViewController.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRaidRankingResult/Presentation/Views/AdventBattleRaidRankingResultViewController.cs`

#### View
- `Presentation/Views/AdventBattleRaidRankingResultView.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRaidRankingResult/Presentation/Views/AdventBattleRaidRankingResultView.cs`

#### Component
- `Presentation/Components/AdventBattleRankingResultBossComponent.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRaidRankingResult/Presentation/Components/AdventBattleRankingResultBossComponent.cs`

#### Delegate Interface
- `Presentation/Views/IAdventBattleRaidRankingResultViewDelegate.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRaidRankingResult/Presentation/Views/IAdventBattleRaidRankingResultViewDelegate.cs`

### 使用している関連コンポーネント

#### UseCase（共通）
- `AdventBattleRankingResult/Domain/UseCases/AdventBattleRankingResultUseCase.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Domain/UseCases/AdventBattleRankingResultUseCase.cs`

#### ViewModel（共通）
- `AdventBattleRankingResult/Presentation/ViewModels/AdventBattleRankingResultViewModel.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/ViewModels/AdventBattleRankingResultViewModel.cs`

#### ModelFactory（共通）
- `AdventBattleRankingResult/Domain/ModelFactories/AdventBattleRankingResultModelFactory.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Domain/ModelFactories/AdventBattleRankingResultModelFactory.cs`

#### Translator（共通）
- `AdventBattleRankingResult/Presentation/Translators/AdventBattleRankingResultViewModelTranslator.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Translators/AdventBattleRankingResultViewModelTranslator.cs`

#### 呼び出し元
- `Home/Presentation/Presenters/HomeAppearanceAction/Actions/AdventBattleRankingResultAction.cs`
  - パス: `projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/Home/Presentation/Presenters/HomeAppearanceAction/Actions/AdventBattleRankingResultAction.cs`

### AdventBattleRankingResultViewModelの構造

レイド型とスコアチャレンジ型で共通のViewModel。この画面ではレイド型の場合に使用される。

```csharp
public record AdventBattleRankingResultViewModel(
    RankType RankType,                                          // ランクタイプ（Bronze/Silver/Gold等）
    AdventBattleScoreRankLevel RankLevel,                       // スコアランクレベル
    AdventBattleRankingRank Rank,                               // プレイヤーの順位
    AdventBattleScore Score,                                    // プレイヤーの最高スコア
    IReadOnlyList<PlayerResourceIconViewModel> RewardList,      // 獲得報酬リスト
    AdventBattleType AdventBattleType,                          // 降臨バトルタイプ（Raid/ScoreChallenge）
    UnitImageAssetPath EnemyImageAssetPath,                     // 敵ユニット画像パス
    AdventBattleName AdventBattleName)                          // 降臨バトル名
```

### 画面初期化時の引数

```csharp
AdventBattleRaidRankingResultViewController.Argument(
    AdventBattleRankingResultViewModel AdventBattleRankingResultViewModel,  // ランキング結果ViewModel
    Action OnCloseView)                                                      // 閉じた時のコールバック
```

- `AdventBattleRankingResultViewModel`: 表示するランキング結果データ
- `OnCloseView`: ダイアログを閉じた時に実行されるコールバック関数

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID（ランキング結果の対象バトルを特定） |
| MstAdventBattle.AdventBattleName | mst_advent_battles.name | 降臨バトル名（画面タイトルに表示） |
| MstAdventBattle.BattleType | mst_advent_battles.battle_type | バトルタイプ（Raid/ScoreChallengeを判定し、この画面はRaidのみ表示） |
| MstAdventBattle.DisplayEnemyUnitIdFirst | mst_advent_battles.display_enemy_unit_id_first | 表示する敵ユニットID（ボスキャラクター表示に使用） |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | 降臨バトル終了日時（ランキング集計完了タイミングの計算に使用） |
| MstAdventBattleScoreRank.Id | mst_advent_battle_score_ranks.id | スコアランクID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_score_ranks.mst_advent_battle_id | 所属する降臨バトルID |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_score_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold等） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_score_ranks.level | スコアランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_score_ranks.required_lower_score | このランクに必要な下限スコア（ランク判定に使用） |
| MstAdventBattleRewardGroup.Id | mst_advent_battle_reward_groups.id | 報酬グループID |
| MstAdventBattleRewardGroup.MstAdventBattleId | mst_advent_battle_reward_groups.mst_advent_battle_id | 所属する降臨バトルID |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリ（Rankingカテゴリを抽出） |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.reward_condition | 報酬条件（ランキング順位の閾値） |
| MstAdventBattleRewardGroup.Rewards | mst_advent_battle_rewards.* (JSON配列) | 報酬アイテムリスト（各報酬の種類・ID・数量） |
| MstEnemyCharacter.Id | mst_enemy_characters.id | 敵キャラクターID |
| MstEnemyCharacter.AssetKey | mst_enemy_characters.asset_key | 敵ユニット画像のアセットキー（Spineモデルのパス特定に使用） |
| MstConfig.Key | mst_configs.key | 設定キー（AdventBattleRankingAggregateHoursを使用） |
| MstConfig.Value | mst_configs.value | 設定値（ランキング集計時間（時間単位）をint型で取得） |

#### ユーザーデータ（API取得）

APIから取得されるユーザーのランキング情報：

| データ項目 | 説明 |
|-----------|------|
| AdventBattleInfoResultModel.AdventBattleResult.MstAdventBattleId | 対象の降臨バトルID（マスタデータとの紐付け） |
| AdventBattleInfoResultModel.AdventBattleResult.MyRanking.Rank | プレイヤーのランキング順位 |
| AdventBattleInfoResultModel.AdventBattleResult.MyRanking.MaxScore | プレイヤーの最高スコア（画面に表示） |
| AdventBattleInfoResultModel.AdventBattleResult.MyRanking.TotalScore | プレイヤーの合計スコア（ランク判定に使用） |
| AdventBattleInfoResultModel.AdventBattleResult.MyRanking.IsExcludeRanking | ランキング除外フラグ |

#### プリファレンス（ローカル保存）

| データ項目 | 説明 |
|-----------|------|
| PreferenceRepository.AdventBattleRankingResultAnimationPlayedId | 再生済み降臨バトルID（同じ結果を2回表示しないための管理） |

### 呼び出しているAPI

#### ランキング結果取得時（画面表示前）
- **GET `/api/advent_battle/info`**: 降臨バトル情報取得API
  - パラメータ: なし
  - 用途: プレイヤーの降臨バトルランキング結果を取得（順位、スコア、対象バトルID等）
  - 備考: UseCaseでAPI呼び出し後、ランキング結果の有効性を判定してから画面表示

### 表示制御ロジック

#### ランキング結果の表示判定（UseCaseで実行）

1. **集計時間考慮**: 降臨バトル終了時刻 + 集計時間（デフォルトまたはMstConfig設定値）
2. **最終開催バトル特定**: 集計完了時刻より前に終了した降臨バトルのうち、最も新しいものを選択
3. **再生済みチェック**: PreferenceRepositoryに保存された再生済みIDと一致する場合はスキップ
4. **期限チェック**: 集計完了から30日以上経過している場合はスキップ
5. **API取得**: 降臨バトル情報APIを呼び出し
6. **ランク・順位チェック**: 順位が0（圏外）の場合はスキップ
7. **再生フラグ保存**: 上記をすべてパスした場合、再生済みフラグを保存
8. **画面表示判定**: ViewModelのAdventBattleTypeがRaidの場合にこの画面を表示

#### アニメーション制御

各アニメーションは`CancellationTokenSource`で管理され、タップによるキャンセルが可能：
- `_slideInAnimationCancellationTokenSource`: スライドインアニメーション制御
- `_enemyIconAnimationCancellationTokenSource`: 敵アイコンアニメーション制御
- `_rewardAnimationCancellationTokenSource`: 報酬アニメーション制御

タップ時の挙動（`OnViewTapped`）：
1. スライドインアニメーション未完了 → スライドインをスキップ
2. 敵アイコンアニメーション未完了 → 敵アイコンをスキップ
3. 報酬アニメーション未完了 → 報酬をスキップ
4. すべて完了済み → ダイアログを閉じる

### 関連する定数・設定値

- `AdventBattleConst.DefaultAdventBattleRankingAggregateHours`: デフォルトランキング集計時間（時間単位）
- `AdventBattleConst.RankingResultNotificationTermDays`: ランキング結果通知の有効期限（30日）
- `MstConfigKey.AdventBattleRankingAggregateHours`: ランキング集計時間の設定キー
- `AdventBattleType.Raid`: レイドタイプ（この画面で表示）
- `AdventBattleType.ScoreChallenge`: スコアチャレンジタイプ（別画面で表示）
- `AdventBattleRewardCategory.Ranking`: ランキング報酬カテゴリ
