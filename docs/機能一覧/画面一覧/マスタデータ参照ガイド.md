# マスタデータ参照ガイド

画面ドキュメント作成時に「この画面でどのマスタデータを使っているか」を整理するための参考ガイドです。

## 目次
1. [マスタデータ配信の仕組み](#マスタデータ配信の仕組み)
2. [データの種類と命名規則](#データの種類と命名規則)
3. [DBテーブルとクライアント側の対応関係](#dbテーブルとクライアント側の対応関係)
4. [画面ドキュメントでのマスタデータ記載方法](#画面ドキュメントでのマスタデータ記載方法)
5. [実例：ガチャコンテンツ画面](#実例ガチャコンテンツ画面)

---

## マスタデータ配信の仕組み

### 全体フロー

```
┌─────────────────┐
│ 1. CSV作成      │  glow-masterdata リポジトリ
│ (MstUnit.csv等) │  - MstUnit.csv
└────────┬────────┘  - OprGacha.csv
         │            - MstItem.csv 等
         │
         ↓
┌─────────────────┐
│ 2. DB投入       │  glow-server/api/database
│ (管理ツール)    │  - mst_units テーブル
└────────┬────────┘  - opr_gacha テーブル
         │            - mst_items テーブル 等
         │
         ↓
┌─────────────────┐
│ 3. JSON生成     │  管理ツール
│ (S3アップロード)│  - masterdata_{hash}.json
└────────┬────────┘  - operationdata_{hash}.json
         │
         ↓
┌─────────────────┐
│ 4. game/version │  glow-server API
│ API配信         │  GET /api/game/version
└────────┬────────┘  → S3パス・ハッシュ値を返す
         │
         ↓
┌─────────────────┐
│ 5. S3ダウンロード│ glow-client
│ クライアント    │  - MstUnitData (自動生成)
└────────┬────────┘  - OprGachaData (自動生成)
         │
         ↓
┌─────────────────┐
│ 6. Domain変換   │  glow-client
│ (Translator)    │  - MstCharacterModel
└─────────────────┘  - OprGachaModel
```

### game/version APIの役割

**エンドポイント**: `GET /api/game/version`

**レスポンス例**:
```json
{
  "mstHash": "abc123...",
  "mstPath": "0/masterdata/masterdata_abc123.json",
  "mstI18nHash": "def456...",
  "mstI18nPath": "0/masterdata_i18n/ja/masterdata_i18n_def456.json",
  "oprHash": "ghi789...",
  "oprPath": "0/operationdata/operationdata_ghi789.json",
  "oprI18nHash": "jkl012...",
  "oprI18nPath": "0/operationdata_i18n/ja/operationdata_i18n_jkl012.json"
}
```

**処理の流れ**:
1. クライアントバージョンに基づいてマスタバージョンを特定
2. `mng_master_releases`と`mng_master_release_versions`からハッシュ値とパスを取得
3. S3のパス情報をクライアントに返す
4. クライアントはS3から直接JSONをダウンロード

---

## データの種類と命名規則

### マスタデータの分類

| 分類 | プレフィックス | 説明 | 更新頻度 | 例 |
|------|---------------|------|---------|-----|
| **マスタデータ** | `Mst` | ゲームの固定データ | 低（アプリ更新時） | キャラ、アイテム、ステージ |
| **運営データ** | `Opr` | 運営で更新する動的データ | 高（イベント時） | ガチャ、イベント、キャンペーン |
| **管理データ** | `Mng` | システム管理用データ | - | バージョン管理、リリース管理 |

### 命名規則の役割分担

#### 1. CSV（glow-masterdata）
```
MstUnit.csv          → ユニット（キャラクター）の基本データ
OprGacha.csv         → ガチャ設定データ
MstItem.csv          → アイテム基本データ
```

#### 2. DBテーブル（glow-server）
```
mst_units            → ユニットテーブル
opr_gacha            → ガチャテーブル
mst_items            → アイテムテーブル
```

#### 3. Data層（glow-client - AutoGenerated）

**場所**: `Assets/GLOW/Scripts/Runtime/Core/Data/Data/AutoGenerated/`

**特徴**:
- **自動生成される**（JSONデシリアライズ用DTO）
- `[DataMember]`, `[JsonProperty]` 属性を持つ
- ビジネスロジックなし
- 語尾に `Data` がつく

```csharp
// MstUnitData.cs
[Serializable]
public class MstUnitData
{
    [DataMember(Name = "id")][JsonProperty("id")]
    public string Id { get; set; }

    [DataMember(Name = "rarity")][JsonProperty("rarity")]
    public Rarity Rarity { get; set; }
    // ... プロパティのみ
}
```

#### 4. Domain層（glow-client - 手動作成）

**場所**: `Assets/GLOW/Scripts/Runtime/Core/Domain/Models/`

**特徴**:
- **手動で作成される**（ドメインモデル）
- C#の`record`型で定義
- ビジネスロジックとメソッドを持つ
- ValueObjectを使用（型安全性）
- 語尾に `Model` がつく

```csharp
// MstCharacterModel.cs
public record MstCharacterModel(
    MasterDataId Id,
    CharacterName Name,
    Rarity Rarity
    // ... ValueObjectを使用
)
{
    public static MstCharacterModel Empty { get; } = new(...);
    public bool IsEmpty() => ReferenceEquals(this, Empty);

    // ビジネスロジックメソッド
    public AttackCountPerMinute AttackCountPerMinute { get; }
}
```

#### 5. Repository（glow-client）

**命名の特徴**:
- `IMst{名前}DataRepository` という名前
- 実際には `Mst{名前}Model` を返す

```csharp
public interface IMstCharacterDataRepository
{
    MstCharacterModel GetCharacter(MasterDataId id);
    // ↑ MstCharacterDataではなくMstCharacterModelを返す
}
```

**理由**: "CharacterData（DBのmst_units）を管理するRepository"という意味

---

## DBテーブルとクライアント側の対応関係

### 主要マスタデータの対応表

| CSV | DBテーブル | Data層 | Domain層 | Repository |
|-----|-----------|--------|---------|-----------|
| MstUnit.csv | mst_units | MstUnitData | MstCharacterModel | IMstCharacterDataRepository |
| MstItem.csv | mst_items | MstItemData | MstItemModel | IMstItemDataRepository |
| MstStage.csv | mst_stages | MstStageData | MstStageModel | IMstStageDataRepository |
| MstAbility.csv | mst_abilities | MstAbilityData | MstAbilityModel | IMstAbilityDescriptionDataRepository |
| OprGacha.csv | opr_gacha | OprGachaData | OprGachaModel | IOprGachaRepository |
| OprGachaUpper.csv | opr_gacha_upper | OprGachaUpperData | OprGachaUpperModel | IOprGachaUpperRepository |
| OprGachaUseResource.csv | opr_gacha_use_resource | OprGachaUseResourceData | OprGachaUseResourceModel | IOprGachaUseResourceRepository |
| OprGachaDisplayUnitI18n.csv | opr_gacha_display_unit_i18n | OprGachaDisplayUnitI18nData | OprGachaDisplayUnitI18nModel | IOprGachaRepository |

### データ変換の流れ

```
JSON (S3)
  ↓ デシリアライズ
MstUnitData (Data層)
  ↓ Translator
MstCharacterModel (Domain層)
  ↓ UseCase/Translator
ViewModel (Presentation層)
  ↓ View
画面表示
```

### なぜ"Unit"が"Character"に変わるのか？

- **DB/Data層**: 技術的な名前として"Unit"を使用（データベース設計上の呼称）
- **Domain層**: ゲームデザイン的な概念として"Character"を使用（ユビキタス言語）
- ドメイン駆動設計の原則に従い、ビジネス層では意味のある名前を使う

---

## 画面ドキュメントでのマスタデータ記載方法

### 記載テンプレート

```markdown
### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **{テーブル名}**<br>{日本語名・簡単な説明} | {カラム名} | {説明} |
| | {カラム名} | {説明} |
| **{テーブル名}**<br>{日本語名・簡単な説明} | {カラム名} | {説明} |
| | {カラム名} | {説明} |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **{テーブル名}**<br>{日本語名・簡単な説明} | {カラム名} | {説明} |
| | {カラム名} | {説明} |
```

### 記載ポイント

1. **表形式で記載**
   - 一覧性が高く、AIコンテキストとしても解析しやすい
   - テーブル名列には、テーブル名（太字）+ 改行 + 日本語名・簡単な説明
   - 同じテーブルの複数カラムは、テーブル名列を空欄にして連続記載

2. **DBテーブル名ベースで記載**
   - ✅ `OprGacha` - ガチャ基本情報
   - ❌ `OprGachaData` や `OprGachaModel` とは書かない
   - DBテーブルが情報源なので、テーブル名をベースにする

3. **Mst/Oprの区分はしない**
   - すべて「マスタデータ」セクションにまとめて記載
   - テーブル名のプレフィックス（Mst/Opr）で種別は判別可能

4. **使用されているカラムのみ記載**
   - テーブルの全カラムではなく、画面で実際に使われているもののみ
   - カラム名は、Domain層のプロパティ名（パスカルケース）で記載

5. **データの用途を明記**
   - 単にカラム名を列挙するだけでなく、何のために使っているかを説明
   - 例: `GachaType`: ガチャタイプ（フェス、ピックアップ、無料など）

6. **データ間の関連を説明**
   - 外部キーの関連を明記
   - 例: `DrawCountThresholdGroupId`: 天井グループID（OprGachaUpperと紐付け）

7. **ユーザーデータも含める**
   - マスタデータだけでなく、ユーザーデータ（User*）も使っている場合は記載
   - GameFetchで取得されるユーザー固有のデータ

### コードから特定する方法

#### 1. UseCaseを確認

```csharp
// GachaContentUseCase.cs
public class GachaContentUseCase
{
    [Inject] IOprGachaRepository OprGachaRepository { get; }
    [Inject] IOprGachaUpperRepository OprGachaUpperRepository { get; }
    [Inject] IMstItemDataRepository MstItemDataRepository { get; }
    [Inject] IMstCharacterDataRepository MstCharacterDataRepository { get; }
    // ↑ これらのRepositoryから使用マスタを特定

    public GachaContentUseCaseModel GetGachaContentUseCaseModel(MasterDataId gachaId)
    {
        var gachaModel = OprGachaRepository.GetOprGachaModelFirstOrDefaultById(gachaId);
        // ↑ OprGachaを使用

        var gachaUseResourceModels = OprGachaUseResourceRepository.FindByGachaId(gachaModel.GachaId);
        // ↑ OprGachaUseResourceを使用
    }
}
```

#### 2. Modelファクトリーを確認

```csharp
// GachaDisplayUnitModelFactory.cs
public class GachaDisplayUnitModelFactory
{
    [Inject] IOprGachaRepository OprGachaRepository { get; }
    [Inject] IMstCharacterDataRepository MstCharacterDataRepository { get; }

    public List<GachaDisplayUnitModel> CreateGachaDisplayUnitModels(MasterDataId gachaId)
    {
        var gachaDisplayUnitModels = OprGachaRepository.GetOprGachaDisplayUnitI18nModelsById(gachaId);
        // ↑ OprGachaDisplayUnitI18nを使用

        var mstUnit = MstCharacterDataRepository.GetCharacter(model.PickupMstUnitId);
        // ↑ MstCharacter (mst_units) を使用
    }
}
```

#### 3. DBスキーマを確認

`projects/glow-server/api/database/schema/master_tables_ddl.sql`で実際のカラムを確認

```sql
CREATE TABLE `opr_gacha` (
  `id` varchar(255) NOT NULL COMMENT 'UUID',
  `gacha_type` enum(...) NOT NULL COMMENT 'ガチャタイプ',
  `start_at` timestamp NOT NULL COMMENT '開始日時',
  `end_at` timestamp NOT NULL COMMENT '終了日時',
  ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ガチャ設定';
```

---

## 実例：ガチャコンテンツ画面

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **OprGacha**<br>ガチャ基本情報 | GachaId | ガチャID |
| | GachaName | ガチャ名 |
| | GachaType | ガチャタイプ（フェス、ピックアップ、無料など） |
| | EndAt | 終了日時 |
| | EnableAdPlay | 広告ガチャ有効フラグ |
| | Description | ガチャ説明文 |
| | GachaLogoAssetKey | ガチャロゴのアセットキー |
| | DailyPlayLimitCount | 1日あたりの実行回数上限 |
| | TotalPlayLimitCount | 期間中の実行回数上限 |
| | RarityThresholdText | レアリティ天井テキスト（例：「あと○○回でSSR確定」） |
| | PickupThresholdText | ピックアップ天井テキスト（例：「あと○○回でピックアップ確定」） |
| | DrawCountThresholdGroupId | 天井グループID（OprGachaUpperとの紐付け用） |
| | GachaFixedPrizeDescription | 確定枠の説明（例：「SR以上1体確定」） |
| | UnlockConditionType | 解放条件タイプ |
| **OprGachaUpper**<br>ガチャ天井情報 | DrawCountThresholdGroupId | 天井グループID（OprGachaと紐付け） |
| | UpperType | 天井タイプ（`MaxRarity`: レアリティ天井、`Pickup`: ピックアップ天井） |
| | GachaThresholdCount | 天井までの回数 |
| **OprGachaUseResource**<br>ガチャコスト情報 | GachaId | ガチャID |
| | GachaDrawCount | 1回分 or 10回分 |
| | CostType | コストタイプ（`Diamond`, `PaidDiamond`, `Item`, `Free`, `Ad`など） |
| | MstCostId | アイテムIDなど（CostTypeがItemの場合に使用） |
| | CostAmount | コスト量 |
| | GachaCostPriority | 優先度（複数のコスト設定がある場合に使用） |
| **OprGachaDisplayUnit**<br>ガチャ表示ユニット情報 | PickupMstUnitId | 表示するユニットのマスタID（MstCharacterと紐付け） |
| | GachaDisplayUnitDescription | 表示説明文（ユニットの特徴など） |
| **MstCharacter** (mst_units)<br>キャラクターマスタ | Id | ユニットID |
| | Name | ユニット名 |
| | RoleType | ロールタイプ（アタッカー、ディフェンダーなど） |
| | Color | キャラクターカラー（属性） |
| | Rarity | レアリティ（R, SR, SSR, UR） |
| | SeriesAssetKey | シリーズアセットキー（シリーズロゴ表示用） |
| | AssetKey | キャラクターアセットキー（カットイン画像表示用） |
| **MstItem**<br>アイテムマスタ | ItemAssetKey | アイコン表示用のアセットキー |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserGacha**<br>ユーザーガチャ実行履歴 | OprGachaId | ガチャID |
| | GachaExpireAt | 個別有効期限（一部ガチャで設定） |
| **UserGachaDrawCountThreshold**<br>ユーザー天井カウント | DrawCountThresholdGroupId | 天井グループID |
| | UpperType | 天井タイプ（`MaxRarity` or `Pickup`） |
| | GachaPlayedCount | 実行済み回数 |
| **UserParameter**<br>ユーザーパラメータ | Coin | コイン所持量 |
| | Diamond | ダイヤ所持量（無償+有償の合計） |
| | PaidDiamond | 有償ダイヤ所持量 |
| **UserItem**<br>ユーザーアイテム | MstItemId | アイテムID |
| | Amount | 所持量 |

### コードでの使用箇所

#### UseCase
`GachaContentUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaContent/Domain/UseCases/GachaContentUseCase.cs:33)
```csharp
public GachaContentUseCaseModel GetGachaContentUseCaseModel(MasterDataId gachaId)
{
    // OprGachaを取得
    var gachaModel = OprGachaRepository.GetOprGachaModelFirstOrDefaultById(gachaId);

    // OprGachaUseResourceを取得
    var gachaUseResourceModels = OprGachaUseResourceRepository.FindByGachaId(gachaModel.GachaId);

    // UserGachaを取得
    var userGachaModel = gameFetchOtherModel.UserGachaModels
        .FirstOrDefault(model => model.OprGachaId == gachaId) ?? UserGachaModel.CreateById(gachaId);
}
```

#### ModelFactory
`GachaDisplayUnitModelFactory.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaContent/Domain/ModelFactory/GachaDisplayUnitModelFactory.cs:15)
```csharp
public List<GachaDisplayUnitModel> CreateGachaDisplayUnitModels(MasterDataId gachaId)
{
    // OprGachaDisplayUnitI18nを取得
    var gachaDisplayUnitModels = OprGachaRepository.GetOprGachaDisplayUnitI18nModelsById(gachaId);

    // MstCharacterを取得
    var mstUnit = MstCharacterDataRepository.GetCharacter(model.PickupMstUnitId);
}
```

---

## 補足情報

### データ取得のタイミング

1. **アプリ起動時**: `game/version` APIでバージョン情報取得
2. **初回/更新時**: S3からマスタデータJSON/MessagePackをダウンロード
3. **ローカルキャッシュ**: ハッシュ値が同じ場合はダウンロードスキップ
4. **メモリロード**: アプリ内でマスタデータをメモリに展開
5. **Repository経由**: 各画面でRepositoryを通じてマスタデータにアクセス

### 関連ドキュメント

- [マスタデータ配信機構](../../../projects/glow-server/docs/01_project/architecture/マスタデータ配信機構.md) - 詳細な配信の仕組み
- [master_tables_ddl.sql](../../../projects/glow-server/api/database/schema/master_tables_ddl.sql) - DBスキーマ定義
- [glow-masterdata](../../../projects/glow-masterdata/) - CSVマスタデータ

---

**最終更新**: 2025-12-24
