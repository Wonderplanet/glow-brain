# ゲームモード選択画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ゲームモード選択画面 |
| **画面種別** | モーダル画面 |

## 概要

ホーム画面から表示されるモーダル画面で、プレイヤーがプレイするクエストのモードを選択できます。メインクエスト（通常クエスト）と現在開催中のイベントクエストを選択でき、選択したモードに応じてクエスト画面へ遷移します。イベントの終了時間のカウントダウンも表示されるため、プレイヤーはリアルタイムで開催状況を確認できます。

## プレイヤーができること

### ゲームモードを選択する

#### メインクエストを選択
- メインクエスト（通常クエスト）をタップして選択
- メインクエストは常に利用可能
- 選択後、メインクエスト画面へ遷移

#### イベントクエストを選択
- 現在開催中のイベントクエストをタップして選択
- イベント終了時刻までのカウントダウン表示で、残り時間を確認可能
- イベント期間中は選択可能
- イベント終了時刻が経過している場合、確認ダイアログが表示される
  - ダイアログ内容：「イベントは終了しました。次回開催をお待ちください。」
  - ダイアログを閉じた後、クエスト画面へ遷移
- 選択後、イベントクエスト画面へ遷移

### 情報を確認する

#### 各モードの表示情報
- **モード画像**: メインクエストまたはイベント名のアイコン
- **残り時間**: イベントの終了までのカウントダウン（イベントのみ）
- **選択状態**: 現在選択しているモードに選択チェックマークが表示される

### その他の操作

- **閉じるボタン**: 画面を下にスライドして閉じる
- **背景タップ**: 背面の背景をタップしても画面が閉じる

## 画面の要素

### ヘッダー部分
- **閉じるボタン**: 画面を閉じるために使用
- ボタン位置は画面上部右側

### メイン表示エリア
- **ゲームモード一覧**
  - 各モードはコレクションビューで表示
  - メインクエストが最初に表示され、その下に現在開催中のイベント順に表示
  - 各セルには以下の情報が含まれる：
    - モード画像（固定値またはアセット）
    - 残り時間表示（イベントのみ）
    - 選択状態インジケーター（選択チェックマーク）

### アニメーション
- **表示アニメーション**: 画面が下から上にスライドして表示される（0.3秒間、Ease.OutQuint）
- **非表示アニメーション**: 画面が上から下にスライドして非表示になる（0.3秒間、Ease.OutQuint）

## 画面遷移

### この画面への遷移
- **ホーム画面**: ホーム画面のプレイボタンをタップ
  - 画面が表示されるたびに開催状況が再読み込みされる

### この画面からの遷移
- **メインクエスト画面**: メインクエストを選択
  - 遷移後、前回選択していたモードが「メインクエスト」として記録される
- **イベントクエスト画面**: イベントクエストを選択
  - イベント終了時刻が経過している場合、確認ダイアログを表示してから遷移
  - 遷移後、前回選択していたモードが「イベント」として記録される
  - 選択したイベントIDが記録される
- **ホーム画面**: 閉じるボタンまたは背景をタップ
  - 画面のみを非表示にし、ホーム画面へ戻る

## ゲーム仕様・制約事項

### イベント開催期間の判定
- イベントは開催期間内（開始時刻以上かつ終了時刻未満）に表示
- 終了時刻に到達すると自動的に非表示になる
- 終了時刻が経過しているイベントをタップした場合、確認ダイアログが表示される

### 残り時間の表示
- イベント終了までの残り時間がリアルタイムで更新表示される
- 残り時間がない場合（TimeSpan.Zero）は時間表示が非表示になる
- 時間フォーマット：[TimeSpanFormatter](時間フォーマット処理)で整形

### 選択状態の管理
- ホーム画面から遷移する際の前回選択モード（保存されたクエストID）を確認
- 該当するモードがあれば選択状態で表示
- 選択状態は各モードのセル画像横に表示

### 画面リロード
- この画面が表示されるたびに（OnViewWillAppear）、マスタデータを再取得する
- イベント開催状況が変化した際に、即座に反映される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GameModeSelectPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/Presenters/GameModeSelectPresenter.cs)
  - 画面のロジック処理：ゲームモード選択時の確認判定、モード更新
  - イベント終了時刻の判定処理

#### ViewController
- `Presentation/Views/GameModeSelectViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/Views/GameModeSelectViewController.cs)
  - コレクションビューのデリゲート・データソース実装
  - 画面の表示・非表示アニメーション制御

#### View
- `Presentation/Views/GameModeSelectView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/Views/GameModeSelectView.cs)
- `Presentation/Views/GameModeSelectCell.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/Views/GameModeSelectCell.cs)

#### ViewModel
- `Presentation/ViewModels/GameModeSelectViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/ViewModels/GameModeSelectViewModel.cs)
- `Presentation/ViewModels/GameModeSelectItemViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/ViewModels/GameModeSelectItemViewModel.cs)

#### Translator
- `Presentation/ViewModels/GameModeSelectViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Presentation/ViewModels/GameModeSelectViewModelTranslator.cs)

#### UseCase
- `Domain/UseCases/GameModeSelectUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Domain/UseCases/GameModeSelectUseCase.cs)
- `Domain/UseCases/UpdateCurrentMstQuestIdUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GameModeSelect/Domain/UseCases/UpdateCurrentMstQuestIdUseCase.cs)

### GameModeSelectViewModelの構造

```csharp
public record GameModeSelectViewModel(IReadOnlyList<GameModeSelectItemViewModel> Items)
```

#### プロパティ
- **Items**: 選択可能なゲームモード一覧
  - メインクエストを先頭に、その後イベントが時系列で続く

### GameModeSelectItemViewModelの構造

```csharp
public record GameModeSelectItemViewModel(
    GameModeSelectingFlag IsSelected,           // 選択状態
    GameModeType Type,                           // モード種別
    MasterDataId MstEventId,                     // マスタデータID
    DateTimeOffset EndAt,                        // 終了時刻
    GameModeSelectAssetKey GameModeSelectAssetKey, // アセットキー
    EventAssetKey EventAssetKey,                 // イベントアセットキー
    TimeSpan LimitTime)                          // 残り時間
{
    public bool ShowsLimitTime => LimitTime != TimeSpan.Zero;  // 残り時間表示判定
}
```

#### プロパティ説明
- **IsSelected**: 現在選択状ているかを示すフラグ
- **Type**: ゲームモード種別（MeinQuest/Event/Reprint）
- **MstEventId**: マスタイベントのID
- **EndAt**: イベント終了時刻
- **GameModeSelectAssetKey**: ボタンのアセットキー（イベント名など）
- **EventAssetKey**: イベント識別用のアセットキー
- **LimitTime**: 現在時刻からイベント終了時刻までの残り時間
- **ShowsLimitTime**: 残り時間を表示すべきかの判定（TimeSpanが0以外ならtrue）

### データ取得の流れ

1. **OnViewWillAppear**時に画面が表示される
2. **GameModeSelectUseCase.GetGameModeSelectUseCaseModel()**を呼び出し
   - 保存されているクエストIDから前回選択モードを取得
   - IMstEventDataRepositoryから現在開催中のイベント一覧を取得
   - 各イベントの残り時間を計算
   - メインクエストと開催中イベントをリストに含める
3. **GameModeSelectViewModelTranslator.Translate()**でUseCaseモデルをViewModelへ変換
4. **SetViewModel()**でUIを更新

### ゲームモード選択時の処理

1. **OnGameModeButtonTap()**でプレゼンターがゲームモード選択を受け取る
2. イベント終了時刻をチェック
   - 終了時刻が経過している場合：確認ダイアログを表示
   - 終了時刻内の場合：そのまま遷移
3. **UpdateCurrentMstQuestIdUseCase.UpdateCurrentMstQuestId()**で選択モードを記録
   - **HomeCurrentQuestSelectFactory**でクエストIDを決定
   - **PreferenceRepository.SetCurrentHomeTopSelectMstQuestId()**に保存
4. **onSelectGameMode()**コールバックで画面遷移を実行

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstEvent.Id<br>MstEvent.StartAt<br>MstEvent.EndAt<br>MstEvent.AssetKey | mst_events.id<br>mst_events.start_at<br>mst_events.end_at<br>mst_events.asset_key | イベント開催期間、イベントロゴアセットキー |
| MstQuest.Id<br>MstQuest.QuestType | mst_quests.id<br>mst_quests.quest_type | クエストID、クエスト種別（Normal/Event） |

#### ユーザーデータ（Preference）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| CurrentHomeTopSelectMstQuestId | - | 前回選択したクエストID（ローカル保存） |

### 呼び出しているAPI

この画面ではAPIを直接呼び出していません。マスタデータはリポジトリ経由でローカルDBから取得されます。
