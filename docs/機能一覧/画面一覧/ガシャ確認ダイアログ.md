# ガシャ確認ダイアログ

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガシャ確認ダイアログ |
| **画面番号** | 71-1-19 |
| **画面種別** | ダイアログ |

## 概要

ガシャを実行する前に表示される確認ダイアログです。ガシャを引くために必要なコスト（ダイヤ、チケット、広告視聴など）と、実行後の所持ダイヤ数を確認できます。プレイヤーはここでコストを確認し、実行するか、またはコスト不足の場合はショップへ遷移して購入することができます。

## プレイヤーができること

### ガシャ実行の確認と決定

#### 単発ガシャの実行
- 1回分のガシャを実行
- コスト（ダイヤ、チケット、広告など）を確認
- 実行ボタンをタップしてガシャを引く
- コスト不足の場合はボタンが操作不可

#### 連続ガシャの実行
- 複数回（10連など）のガシャを実行
- 必要なコストの総額を確認
- 実行ボタンをタップしてガシャを引く

#### チケットガシャの数量選択
- アイテムコスト（チケット）の単発ガシャの場合のみ
- ダイアログ内で引く回数を選択可能
- 選択した回数に応じてコストが計算される

#### 広告ガシャの実行
- 広告視聴によるガシャの実行
- リセットまでの残り時間を確認
- 残りの実行可能回数を確認
- 広告スキップパス所持状況を確認

#### チュートリアルガシャの実行
- チュートリアル専用のガシャを実行
- 特別な処理でガシャが実行される

### コスト不足時の対応

#### ショップへの遷移
- ダイヤ不足時にショップボタンをタップ
- ダイヤ購入ダイアログが表示される
- 購入完了後、ダイアログの表示が自動更新される

#### 特定商取引法の確認
- 特定商取引法ボタンをタップ
- WebViewで特定商取引法に基づく表記を表示

### ダイアログの操作

#### 閉じる
- 閉じるボタンまたはバックキーでダイアログを閉じる
- ガシャコンテンツ画面に戻る
- チュートリアル中はバックキーが無効化される

## 画面の要素

### ヘッダー部分
- ガシャ名の表示
- 閉じるボタン

### コスト表示エリア
- 消費コストの種類とアイコン（ダイヤ、チケット、広告など）
- 消費コスト名称
- 消費コスト数量
- ガシャ実行回数（単発/10連など）

### 所持状況表示エリア
- **ダイヤコストの場合**:
  - 現在の所持ダイヤ数（無償/有償の内訳）
  - 実行後の所持ダイヤ数（消費後の残り）
  - 不足している場合は警告表示

- **アイテムコストの場合**:
  - 現在の所持アイテム数
  - 不足している場合は警告表示
  - 単発ガシャの場合は数量選択UI

- **広告コストの場合**:
  - リセットまでの残り時間
  - 残り実行可能回数
  - 広告スキップパス所持情報

### ボタンエリア
- **実行ボタン**: ガシャを実行
  - コスト不足時は操作不可状態
- **ショップボタン**: ダイヤ購入画面へ遷移（ダイヤ不足時に表示）
- **特定商取引法ボタン**: 法的表記の確認

## 画面遷移

### この画面への遷移
- **ガシャコンテンツ画面**: 単発ガシャボタンまたは連続ガシャボタンをタップ
  - 引数: ガシャID、ガシャ実行タイプ（単発/連続）

### この画面からの遷移
- **ガシャ結果画面**: 実行ボタンをタップ
  - ガシャAPIが実行され、結果画面へ自動遷移
  - ダイアログは自動的に閉じられる

- **ダイヤ購入ダイアログ**: ショップボタンをタップ
  - モーダル表示
  - 購入完了後、このダイアログに戻る
  - ヘッダーとダイアログの表示が自動更新される

- **WebView（特定商取引法）**: 特定商取引法ボタンをタップ

- **ガシャコンテンツ画面**: 閉じるボタンまたはバックキーでダイアログを閉じる

## ゲーム仕様・制約事項

### コストタイプによる挙動の違い

#### ダイヤコスト
- 無償ダイヤから優先的に消費
- 無償ダイヤ不足分は有償ダイヤから消費
- 実行後の所持数が事前に表示される

#### 有償ダイヤ限定コスト
- 有償ダイヤのみから消費
- 無償ダイヤは消費されない
- 有償ダイヤが不足している場合は実行不可

#### アイテムコスト（チケット）
- 単発ガシャの場合のみ数量選択が可能
- 所持数が不足している場合は実行不可
- 不足時はこのダイアログが表示されない仕様（コード上のコメントより）

#### 広告コスト
- 1日の実行可能回数に制限あり
- リセット時刻（04:00）まで待つ必要がある
- 広告スキップパス所持時は広告視聴なしで実行可能

### ショップ購入後の挙動
- ダイヤ購入ダイアログから戻った際、自動的に表示が更新される
- ヘッダーのプレイヤーリソース表示も同時に更新される

### チュートリアル時の特別処理
- チュートリアルガシャの場合、専用のガシャ実行処理が呼ばれる
- バックキーが無効化される
- 操作を促すトーストメッセージが表示される

### メンテナンス中の挙動
- ショップがメンテナンス中の場合、ショップボタンをタップするとメンテナンスダイアログが表示される
- ガシャ実行自体はメンテナンスの影響を受けない

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaConfirmDialogPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/Presentation/Presenters/GachaConfirmDialogPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaConfirmDialogViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/Presentation/ViewModels/GachaConfirmDialogViewModel.cs)

#### View
- `Presentation/Views/GachaConfirmDialogView.cs`
- `Presentation/Views/GachaConfirmDialogViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/Presentation/Views/GachaConfirmDialogViewController.cs)
- `Presentation/Views/IGachaConfirmDialogViewDelegate.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/Presentation/Views/IGachaConfirmDialogViewDelegate.cs)

#### UseCase
- `Domain/UseCases/GachaConfirmDialogUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/Domain/UseCases/GachaConfirmDialogUseCase.cs)

#### Model
- `Domain/Model/GachaConfirmDialogUseCaseModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaConfirm/Domain/Model/GachaConfirmDialogUseCaseModel.cs)

### GachaConfirmDialogViewModelの構造
ガシャ実行確認に必要な情報を保持するViewModel

- **GachaId**: ガシャのマスターデータID
- **GachaType**: ガシャタイプ（通常/チュートリアルなど）
- **CostId**: コストアイテムのマスターデータID
- **GachaDrawType**: ガシャ実行タイプ（単発/連続/広告）
- **CostType**: コストタイプ（ダイヤ/有償ダイヤ/アイテム/広告）
- **DrawableFlag**: 実行可能フラグ（コスト不足時はfalse）
- **GachaName**: ガシャ名
- **CostAmount**: 消費コスト数
- **CostName**: コストアイテム名
- **GachaDrawCount**: ガシャ実行回数（1回/10回など）
- **PlayerResourceIconAssetPath**: プレイヤーリソースアイコンのパス
- **PlayerItemAmount**: プレイヤーのアイテム所持数
- **PlayerFreeDiamondAmount**: プレイヤーの無償ダイヤ所持数
- **PlayerFreeDiamondAmountAfterConsumption**: 消費後の無償ダイヤ数
- **PlayerPaidDiamondAmount**: プレイヤーの有償ダイヤ所持数
- **PlayerPaidDiamondAmountAfterConsumption**: 消費後の有償ダイヤ数
- **AdGachaResetRemainingTimeSpan**: 広告ガシャのリセットまでの残り時間
- **AdGachaDrawableCount**: 広告ガシャの残り実行可能回数
- **HeldAdSkipPassInfoViewModel**: 広告スキップパス所持情報

### 画面初期化時の引数
```csharp
GachaConfirmDialogViewController.Argument(
    MasterDataId GachaId,      // ガシャID
    GachaDrawType GachaDrawType // ガシャ実行タイプ（単発/連続/広告）
)
```

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **OprGacha**<br>ガチャ基本情報 | GachaId | ガチャID |
| | GachaName | ガチャ名 |
| | GachaType | ガチャタイプ（通常、チュートリアルなど） |
| **OprGachaUseResource**<br>ガチャコスト情報 | GachaId | ガチャID |
| | GachaDrawCount | 1回分 or 10回分 |
| | CostType | コストタイプ（`Diamond`, `PaidDiamond`, `Item`, `Ad`など） |
| | MstCostId | アイテムIDなど（CostTypeがItemの場合に使用） |
| | CostAmount | コスト量 |
| | GachaCostPriority | 優先度（複数のコスト設定がある場合に使用） |
| **MstItem**<br>アイテムマスタ | Name | アイテム名 |
| | ItemAssetKey | アイコン表示用のアセットキー |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserParameter**<br>ユーザーパラメータ | FreeDiamond | 無償ダイヤ所持量 |
| | PaidDiamond | 有償ダイヤ所持量 |
| **UserItem**<br>ユーザーアイテム | MstItemId | アイテムID |
| | Amount | 所持量 |
| **UserGacha**<br>ユーザーガチャ実行履歴 | OprGachaId | ガチャID |

### 呼び出しているAPI
このダイアログではAPI呼び出しは行われません。表示に必要なデータはすべてローカルのRepositoryから取得されます。

ガシャ実行ボタンをタップすると、`IGachaDrawControl.GachaDraw()`または`IGachaDrawControl.TutorialGachaDraw()`が呼ばれ、別の処理でガシャAPIが実行されます。
