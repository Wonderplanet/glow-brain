# 降臨バトル報酬一覧画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトル報酬一覧画面 |
| **画面番号** | 44-5-1（降臨バトル > 報酬） |
| **画面種別** | モーダル画面 |

## 概要

降臨バトルで獲得できる報酬の一覧を確認するための画面です。プレイヤーは、ランキング報酬、スコアランク報酬、協力スコア報酬など、降臨バトルで入手できる報酬情報を確認できます。降臨バトルのタイプ（スコアチャレンジ/レイドバトル）によって表示されるタブと報酬内容が異なります。

## プレイヤーができること

### 報酬情報の閲覧

#### ランキング報酬タブ
- **個人スコアランキング報酬**: 個人のスコア順位に応じた報酬を確認
- **順位別の報酬内容**: 1位、2位～10位、11位～100位など、順位区分ごとの報酬を表示
- **報酬アイテムの詳細**: 報酬アイテムのアイコンをタップして詳細を確認

#### スコアランクタブ
- **スコアランク報酬**: 獲得スコアに応じたランク報酬を確認
- **ランク条件**: 各ランク（ブロンズ、シルバー、ゴールドなど）の到達スコア条件
- **達成済み報酬**: 現在のスコアで既に達成しているランクは区別表示
- **現在のスコアとランク**: 自分の現在のスコアと到達ランクを確認

#### レイドタブ（レイドバトルのみ）
- **協力スコア報酬**: 全プレイヤーの合計スコアに応じた報酬を確認
- **協力スコア条件**: 各報酬の獲得に必要な全体合計スコア
- **達成済み報酬**: 現在の協力スコアで既に達成している報酬は区別表示
- **現在の協力スコア**: 全プレイヤーの合計スコアを確認

### 報酬アイテムの詳細確認
- 報酬アイテムのアイコンをタップすると、アイテム詳細モーダルが表示される
- ダイヤ、コイン、アイテム、ユニットなど、あらゆる報酬アイテムの詳細を確認可能

### その他の操作
- **タブ切り替え**: ランキング、スコアランク、レイド（該当する場合）のタブを切り替え
- **戻るボタン**: 前の画面に戻る

## 画面の要素

### ヘッダー部分
- 画面タイトル（「報酬一覧」など）
- 戻るボタン

### 開催期間表示エリア
- 降臨バトルの残り時間
- カウントダウン表示（1秒ごとに更新）

### タブボタンエリア
- **ランキングタブ**: ランキング報酬の表示
- **スコアランクタブ**: スコアランク報酬の表示
- **レイドタブ**: 協力スコア報酬の表示（レイドバトルの場合のみ表示）
- 選択中のタブはハイライト表示

### 現在のステータス表示エリア（スコアチャレンジの場合）
- **個人スコア**: プレイヤーの現在の総合スコア
- **現在のランク**: スコアに応じた現在のランク（ブロンズ、シルバー、ゴールドなど）

### 現在のステータス表示エリア（レイドバトルの場合）
- **個人スコア**: プレイヤーの現在の総合スコア
- **協力スコア**: 全プレイヤーの合計スコア（レイドタブで表示）

### 報酬リスト表示エリア

#### ランキング報酬リスト
- **順位表示**: 「1位」「2位～10位」などの順位区分
- **報酬アイコン**: 複数の報酬アイテムを横並びで表示
- **アイテム名と個数**: 各報酬の名称と獲得量

#### スコアランク報酬リスト
- **ランク表示**: ブロンズ、シルバー、ゴールドなどのランクアイコン
- **必要スコア**: そのランクに到達するために必要なスコア
- **報酬アイコン**: 複数の報酬アイテムを横並びで表示
- **達成済み表示**: 既に達成したランクは特別な表示（チェックマークなど）

#### 協力スコア報酬リスト（レイドバトルのみ）
- **必要協力スコア**: 報酬獲得に必要な全体合計スコア
- **報酬アイコン**: 複数の報酬アイテムを横並びで表示
- **達成済み表示**: 既に達成した報酬は特別な表示（チェックマークなど）

## 画面遷移

### この画面への遷移
- **降臨バトル関連画面**: 報酬一覧ボタンをタップ

### この画面からの遷移
- **アイテム詳細モーダル**: 報酬アイテムのアイコンをタップ
  - 報酬アイテムの詳細情報を表示
  - トランジションレイアウトなしで表示される
- **前の画面**: 戻るボタンをタップ

## ゲーム仕様・制約事項

### 降臨バトルのタイプ

#### スコアチャレンジ
- **ランキングタブ**: 個人スコアランキングによる報酬
- **スコアランクタブ**: スコアに応じたランク報酬
- **レイドタブ**: 表示されない

#### レイドバトル
- **ランキングタブ**: 個人スコアランキングによる報酬
- **スコアランクタブ**: スコアに応じたランク報酬
- **レイドタブ**: 全プレイヤーの協力スコアによる報酬

### 報酬の達成判定

#### ランキング報酬
- イベント終了時の最終順位で確定
- 画面では順位による報酬内容のみを表示（達成済み表示なし）

#### スコアランク報酬
- プレイヤーの現在の総合スコアに基づいて達成済み判定
- 必要スコアに到達しているランクは達成済みとして表示
- 現在のランクが画面上に表示される

#### 協力スコア報酬（レイドバトルのみ）
- 全プレイヤーの合計スコアに基づいて達成済み判定
- 必要協力スコアに到達している報酬は達成済みとして表示
- 一度以上プレイしないと獲得できない仕様（プレイ回数が0の場合は未達成扱い）

### 残り時間の更新
- 降臨バトルの終了までの残り時間を1秒ごとに自動更新
- カウントダウン表示

### タブ切り替え
- 同じタブを複数回タップしても切り替え処理は行われない（無駄な更新を防止）
- タブ切り替え時に表示内容が更新される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleRewardListPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/Presentation/Presenter/AdventBattleRewardListPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/AdventBattleRewardListViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/Presentation/ViewModel/AdventBattleRewardListViewModel.cs)
- `Presentation/ViewModels/AdventBattleSingleRankingRewardCellViewModel.cs`
- `Presentation/ViewModels/AdventBattleIntervalRankingRewardCellViewModel.cs`
- `Presentation/ViewModels/AdventBattleScoreRankRewardCellViewModel.cs`
- `Presentation/ViewModels/AdventBattleRaidTotalScoreRewardCellViewModel.cs`

#### View
- `Presentation/Views/AdventBattleRewardListViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/Presentation/View/AdventBattleRewardListViewController.cs)
- `Presentation/Views/AdventBattleRewardListView.cs`

#### UseCase
- `Domain/UseCases/ShowAdventBattleRewardListUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/Domain/UseCase/ShowAdventBattleRewardListUseCase.cs)

#### Factory
- `Domain/Factory/AdventBattleRewardModelFactory.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/Domain/Factory/AdventBattleRewardModelFactory.cs)

#### Translator
- `Presentation/Translator/AdventBattleRewardListViewModelTranslator.cs`
- `Presentation/Translator/AdventBattlePersonalRewardCellViewModelTranslator.cs`
- `Presentation/Translator/AdventBattleRaidTotalScoreRewardCellViewModelTranslator.cs`

### AdventBattleRewardListViewModelの構造

画面全体の報酬情報を保持するViewModel：

- `AdventBattleType`: 降臨バトルのタイプ（スコアチャレンジ/レイドバトル）
- `MyScore`: プレイヤーの現在の総合スコア
- `RaidTotalScore`: 協力スコアの合計値（レイドバトルの場合）
- `RankType`: 現在のスコアランクのタイプ（ブロンズ、シルバーなど）
- `RankLevel`: 現在のスコアランクレベル
- `RemainingTimeSpan`: 降臨バトルの残り時間
- `PersonalRankingRewardCellViewModels`: ランキング報酬のセルViewModelリスト
- `PersonalRankRewardCellViewModels`: スコアランク報酬のセルViewModelリスト
- `RaidTotalScoreRewardCellViewModels`: 協力スコア報酬のセルViewModelリスト

**表示制御ロジック**：
- 降臨バトルのタイプに応じて表示するタブと報酬リストを切り替え
- スコアチャレンジの場合は「ランキング」「スコアランク」タブのみ
- レイドバトルの場合は「ランキング」「スコアランク」「レイド」タブを表示

### 報酬セルViewModelの種類

#### ランキング報酬
- **AdventBattleSingleRankingRewardCellViewModel**: 単一順位の報酬（1位など）
  - `RankingRank`: 対象順位
  - `Rewards`: 報酬アイテムのリスト

- **AdventBattleIntervalRankingRewardCellViewModel**: 順位区分の報酬（2位～10位など）
  - `RankingRankLower`: 下端順位（例：2位）
  - `RankingRankUpper`: 上端順位（例：10位）
  - `Rewards`: 報酬アイテムのリスト

#### スコアランク報酬
- **AdventBattleScoreRankRewardCellViewModel**: スコアランク報酬
  - `RewardRankType`: ランクタイプ（ブロンズ、シルバーなど）
  - `RewardRankLevel`: ランクレベル
  - `RewardRankLowerScore`: 必要スコア
  - `DidReceiveReward`: 達成済みフラグ
  - `Rewards`: 報酬アイテムのリスト

#### 協力スコア報酬（レイドバトルのみ）
- **AdventBattleRaidTotalScoreRewardCellViewModel**: 協力スコア報酬
  - `RewardCondition`: 報酬獲得条件（必要協力スコア）
  - `DidReceiveReward`: 達成済みフラグ
  - `Rewards`: 報酬アイテムのリスト

### 画面初期化時の引数
```csharp
AdventBattleRewardListViewController.Argument(MasterDataId MstAdventBattleId)
```
- `MstAdventBattleId`: 表示対象の降臨バトルのマスタID

### タブの種類
```csharp
enum AdventBattleRewardListTabType
{
    Ranking,  // ランキング報酬タブ
    Rank,     // スコアランク報酬タブ
    Raid      // 協力スコア報酬タブ（レイドバトルのみ）
}
```

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| **MstAdventBattle**<br>降臨バトル基本情報 | |
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.BattleType | mst_advent_battles.battle_type | バトルタイプ（スコアチャレンジ/レイドバトル） |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | 降臨バトル終了日時（残り時間の計算に使用） |
| **MstAdventBattleRewardGroup**<br>降臨バトル報酬グループ情報 | |
| MstAdventBattleRewardGroup.Id | mst_advent_battle_reward_groups.id | 報酬グループID |
| MstAdventBattleRewardGroup.MstAdventBattleId | mst_advent_battle_reward_groups.mst_advent_battle_id | 降臨バトルID（紐付け用） |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリ（Ranking/Rank/RaidTotalScore） |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.reward_condition | 報酬獲得条件（順位、スコア、協力スコアなど） |
| MstAdventBattleRewardGroup.Rewards | - | 報酬アイテムのリスト（MstAdventBattleRewardのコレクション） |
| **MstAdventBattleReward**<br>降臨バトル報酬アイテム | |
| MstAdventBattleReward.Id | mst_advent_battle_rewards.id | 報酬アイテムID |
| MstAdventBattleReward.MstAdventBattleRewardGroupId | mst_advent_battle_rewards.mst_advent_battle_reward_group_id | 報酬グループID（紐付け用） |
| MstAdventBattleReward.ResourceType | mst_advent_battle_rewards.resource_type | リソースタイプ（ユニット、アイテム、ダイヤなど） |
| MstAdventBattleReward.ResourceId | mst_advent_battle_rewards.resource_id | リソースID（アイテムIDなど） |
| MstAdventBattleReward.ResourceAmount | mst_advent_battle_rewards.resource_amount | 報酬の個数 |
| **MstAdventBattleScoreRank**<br>降臨バトルスコアランク情報 | |
| MstAdventBattleScoreRank.Id | mst_advent_battle_score_ranks.id | スコアランクID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_score_ranks.mst_advent_battle_id | 降臨バトルID（紐付け用） |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_score_ranks.rank_type | ランクタイプ（ブロンズ、シルバーなど） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_score_ranks.score_rank_level | ランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_score_ranks.required_lower_score | そのランクに到達するために必要なスコア |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| **UserAdventBattle**<br>ユーザーの降臨バトルプレイ情報 | |
| UserAdventBattle.MstAdventBattleId | user_advent_battles.mst_advent_battle_id | 降臨バトルID |
| UserAdventBattle.TotalScore | user_advent_battles.total_score | ユーザーの総合スコア（現在のスコア表示・ランク判定に使用） |
| **AdventBattleRaidTotalScoreModel**<br>協力スコア情報（レイドバトルのみ） | |
| AdventBattleRaidTotalScoreModel.MstAdventBattleId | - | 降臨バトルID（GameFetchOtherから取得） |
| AdventBattleRaidTotalScoreModel.AdventBattleRaidTotalScore | - | 全プレイヤーの協力スコア合計値 |

### 報酬の達成判定ロジック

#### スコアランク報酬の達成判定
```csharp
// プレイヤーの現在のスコアが、そのランクの必要スコア以上であれば達成済み
var isReceived = rank.RequiredLowerScore <= currentRankModel.RequiredLowerScore;
```

#### 協力スコア報酬の達成判定
```csharp
// 現在の協力スコアが、必要協力スコア以上であれば達成済み
var isReceived = model.RewardCondition.ToAdventBattleRaidTotalScore() <= currentRaidTotalScore;
```
- ただし、プレイ回数が0の場合は協力スコアが0として扱われる（一度以上プレイが必要）

### 報酬カテゴリの種類
```csharp
enum AdventBattleRewardCategory
{
    MaxScore,        // 最高スコア報酬（画面では未使用）
    Ranking,         // ランキング報酬
    Rank,            // スコアランク報酬
    RaidTotalScore,  // 協力スコア報酬（レイドバトルのみ）
    Drop,            // ドロップ報酬（画面では未使用）
}
```

---

**最終更新**: 2025-12-24
