# 降臨バトル報酬一覧画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトル報酬一覧画面 |
| **画面番号** | 44-5-1 |
| **画面種別** | メイン画面 |

## 概要

降臨バトルで獲得できる報酬の一覧を確認できる画面です。プレイヤーは自分の現在のスコア、ランク、協力スコア（レイドタイプの場合）に応じた報酬条件と内容を確認できます。報酬は「ランキング報酬」「ランク報酬」「協力スコア報酬」の3つのタブに分類されており、各タブで異なる条件の報酬を確認できます。

画面上部にはイベント終了までの残り時間が表示され、プレイヤーの現在の進捗状況（スコア、ランク、協力スコア）も確認できます。既に達成済みの報酬条件は視覚的に区別して表示されます。

## プレイヤーができること

### 報酬の確認

#### ランキング報酬タブ
- イベント終了時の順位に応じた報酬を確認
- 1位や順位範囲（2位～5位など）ごとの報酬内容を表示
- 現在の自分の順位ではどの報酬が獲得できるか確認可能

#### ランク報酬タブ
- 累計スコアに応じて到達できるランク（Bronze、Silver、Gold、Master）ごとの報酬を確認
- 各ランクとそのレベルに必要なスコアと報酬内容を表示
- 現在達成済みのランク報酬は受取済み表示される
- 達成した報酬と未達成の報酬を視覚的に区別して確認可能

#### 協力スコア報酬タブ（レイドタイプのみ）
- 全プレイヤーの協力スコア合計に応じた報酬を確認
- 各スコア達成条件と報酬内容を表示
- 現在達成済みの協力スコア報酬は受取済み表示される
- 達成した報酬と未達成の報酬を視覚的に区別して確認可能

### 報酬アイテムの詳細確認

#### アイテムアイコンタップ
- 報酬アイテムのアイコンをタップすると詳細情報を表示
- アイテム詳細モーダルが表示される（画面遷移なし）
- モーダルを閉じると報酬一覧画面に戻る

### 画面操作

#### 戻るボタン
- 画面左上の戻るボタンで前の画面に戻る
- 一般的には降臨バトルのトップ画面などに戻る

## 画面の要素

### ヘッダー部分
- **戻るボタン**: 左上に配置、前画面に戻る
- **残り時間表示**: イベント終了までの時間をカウントダウン表示（1秒ごとに更新）

### 現在の進捗状況エリア
- **降臨バトルタイプ**: スコアチャレンジまたはレイド
- **マイスコア**: プレイヤーの累計スコア
- **協力スコア**: 全プレイヤーの協力スコア合計（レイドタイプのみ）
- **現在のランク**: プレイヤーの現在のランクタイプとレベル

### タブエリア
- **ランキングタブ**: ランキング報酬一覧を表示
- **ランクタブ**: ランク報酬一覧を表示
- **協力スコアタブ**: 協力スコア報酬一覧を表示（レイドタイプのみ）

### 報酬一覧エリア（ランキング報酬）
- **順位表示**: 1位、2位～5位などの順位範囲
- **報酬アイテムアイコン**: 獲得できるアイテムと個数
- **リスト形式**: スコア順（降順）に並べて表示

### 報酬一覧エリア（ランク報酬）
- **ランクタイプとレベル**: Bronze 1、Silver 3など
- **必要スコア**: そのランクに到達するための累計スコア
- **報酬アイテムアイコン**: 獲得できるアイテムと個数
- **受取状態**: 達成済み/未達成の表示
- **リスト形式**: スコア順（降順）に並べて表示

### 報酬一覧エリア（協力スコア報酬）
- **必要協力スコア**: 達成条件となる協力スコア合計
- **報酬アイテムアイコン**: 獲得できるアイテムと個数
- **受取状態**: 達成済み/未達成の表示
- **リスト形式**: スコア順（降順）に並べて表示

## 画面遷移

### この画面への遷移
- **降臨バトルトップ画面など**: 報酬一覧ボタンや報酬確認操作からこの画面が表示される
  - 遷移時には降臨バトルIDが引数として渡される

### この画面からの遷移
- **アイテム詳細モーダル**: 報酬アイテムのアイコンをタップ
  - 画面遷移なしでモーダル表示
  - モーダルを閉じると報酬一覧画面に戻る
- **前画面（戻る）**: 戻るボタンをタップ
  - 降臨バトルトップ画面などに戻る

## ゲーム仕様・制約事項

### 降臨バトルタイプ
- **スコアチャレンジ**: ランキング報酬とランク報酬が表示される
- **レイド**: ランキング報酬、ランク報酬、協力スコア報酬の3種類が表示される

### 報酬の受取状態表示

#### ランク報酬
- プレイヤーの現在の累計スコアが条件スコア以上の場合、受取済みフラグが立つ
- 視覚的に達成済み報酬と未達成報酬を区別して表示

#### 協力スコア報酬
- 協力スコア報酬は一度以上プレイしないと獲得できない仕様
- プレイ回数が0の場合は、達成条件を満たしていても受取済み扱いにならない
- 現在の協力スコア合計が条件スコア以上で、かつプレイ済みの場合に受取済みフラグが立つ

#### ランキング報酬
- ランキング報酬は一覧表示のみで、受取状態は表示されない（イベント終了後に確定するため）

### タブの初期表示
- 画面を開いた時、最初に「ランキング」タブが選択された状態で表示される
- 同じタブを再度タップしても何も起こらない

### 残り時間の更新
- 画面を開いている間、残り時間は1秒ごとに自動更新される
- イベント終了日時からの差分を計算して表示

### ランキング報酬の表示形式
- 1位の報酬は単独で表示
- 2位以降は順位範囲でグループ化される可能性がある（例：2位～5位、6位～10位など）
- 単独順位と順位範囲の2種類の表示形式がある

## 技術参考情報

### 画面実装パス
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRewardList/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleRewardListPresenter.cs`
  - タブ切り替えロジック（OnRankingTabButtonTapped、OnRankTabButtonTapped、OnRaidTabButtonTapped）
  - アイテムアイコンタップ時の処理（OnItemIconTapped）
  - 残り時間の更新ロジック（UpdateAdventBattleRemainingTime）

#### ViewModel
- `Presentation/ViewModels/AdventBattleRewardListViewModel.cs`
  - 降臨バトルタイプ、マイスコア、協力スコア、ランク情報を保持
  - ランキング報酬、ランク報酬、協力スコア報酬のリストを保持
- `Presentation/ViewModels/AdventBattleSingleRankingRewardCellViewModel.cs`
  - 単独順位のランキング報酬セル用ViewModel
- `Presentation/ViewModels/AdventBattleIntervalRankingRewardCellViewModel.cs`
  - 順位範囲のランキング報酬セル用ViewModel
- `Presentation/ViewModels/AdventBattleScoreRankRewardCellViewModel.cs`
  - ランク報酬セル用ViewModel
- `Presentation/ViewModels/AdventBattleRaidTotalScoreRewardCellViewModel.cs`
  - 協力スコア報酬セル用ViewModel

#### UseCase
- `Domain/UseCases/ShowAdventBattleRewardListUseCase.cs`
  - 降臨バトルの基本情報取得
  - プレイヤーの累計スコアと現在ランクの取得
  - 協力スコア合計の取得（レイドタイプの場合）
  - 各種報酬リストの生成
  - イベント残り時間の計算

#### Factory
- `Domain/Factory/AdventBattleRewardModelFactory.cs`
  - ランキング報酬モデルの生成（単独順位と順位範囲の判定含む）
  - ランク報酬モデルの生成（受取状態判定含む）
  - 協力スコア報酬モデルの生成（受取状態判定含む）

#### ValueObject
- `Presentation/ValueObject/AdventBattleRewardListTabType.cs`
  - タブ種別（Ranking、Rank、Raid）

### AdventBattleRewardListViewModelの構造
- **AdventBattleType**: 降臨バトルのタイプ（スコアチャレンジ/レイド）
- **MyScore**: プレイヤーの累計スコア
- **RaidTotalScore**: 協力スコア合計（レイドタイプのみ）
- **RankType**: プレイヤーの現在のランクタイプ（Bronze、Silver、Gold、Master）
- **RankLevel**: プレイヤーの現在のランクレベル
- **RemainingTimeSpan**: イベント終了までの残り時間
- **PersonalRankingRewardCellViewModels**: ランキング報酬のリスト
- **PersonalRankRewardCellViewModels**: ランク報酬のリスト
- **RaidTotalScoreRewardCellViewModels**: 協力スコア報酬のリスト

**表示制御ロジック**：
- タブタイプに応じて、対応する報酬リストを画面に表示
- 同じタブを再度タップしても処理をスキップ（_currentTabTypeでの判定）

### 画面初期化時の引数
```csharp
AdventBattleRewardListViewController.Argument(MasterDataId MstAdventBattleId)
```
- **MstAdventBattleId**: 対象となる降臨バトルのマスタデータID

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.BattleType | mst_advent_battles.advent_battle_type | 降臨バトルタイプ（スコアチャレンジ/レイド）の判定 |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | イベント終了日時、残り時間の計算に使用 |
| MstAdventBattleRank.Id | mst_advent_battle_ranks.id | ランクID |
| MstAdventBattleRank.RankType | mst_advent_battle_ranks.rank_type | ランクタイプ（Bronze、Silver、Gold、Master） |
| MstAdventBattleRank.ScoreRankLevel | mst_advent_battle_ranks.rank_level | ランクレベル（1、2、3など） |
| MstAdventBattleRank.RequiredLowerScore | mst_advent_battle_ranks.required_lower_score | ランク到達に必要な最低累計スコア、現在ランク判定とランク報酬の受取状態判定に使用 |
| MstAdventBattleRewardGroup.Id | mst_advent_battle_reward_groups.id | 報酬グループID |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリー（ランキング/ランク/協力スコア）、タブごとの報酬抽出に使用 |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.condition_value | 報酬条件値（順位、スコア値など）、報酬の表示順序と達成判定に使用 |
| MstAdventBattleReward.ResourceType | mst_advent_battle_rewards.resource_type | 報酬アイテムの種類（Coin、FreeDiamond、Item、Emblemなど） |
| MstAdventBattleReward.ResourceId | mst_advent_battle_rewards.resource_id | 報酬アイテムのID |
| MstAdventBattleReward.ResourceAmount | mst_advent_battle_rewards.resource_amount | 報酬アイテムの個数 |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserAdventBattle.MstAdventBattleId | usr_advent_battles.mst_advent_battle_id | 降臨バトルIDでのユーザーデータ特定 |
| UserAdventBattle.TotalScore | usr_advent_battles.total_score | プレイヤーの累計スコア、マイスコア表示と現在ランク判定、ランク報酬の受取状態判定に使用 |
| UserAdventBattle.ChallengeCount | usr_advent_battles.challenge_count | プレイ回数、協力スコア報酬の受取可否判定に使用（0回の場合は受取不可） |
| AdventBattleRaidTotalScoreModel.MstAdventBattleId | （キャッシュデータ） | 降臨バトルIDでの協力スコアデータ特定 |
| AdventBattleRaidTotalScoreModel.AdventBattleRaidTotalScore | （キャッシュデータ） | 全プレイヤーの協力スコア合計、協力スコア表示と協力スコア報酬の受取状態判定に使用 |

**補足**: AdventBattleRaidTotalScoreModelはGameFetchOtherに含まれるキャッシュデータで、レイドタイプの降臨バトルの協力スコア情報を保持します。

### 呼び出しているAPI
この画面ではAPI呼び出しは行われません。すべてのデータはGameRepositoryから取得され、ローカルデータを使用して報酬一覧を表示します。
