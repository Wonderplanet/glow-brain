# 降臨バトル画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトル画面 |
| **画面番号** | 44-1-1 |
| **画面種別** | メイン画面 |

## 概要

降臨バトルのトップ画面です。プレイヤーは期間限定で開催される強敵バトルに挑戦し、ハイスコアや累計スコアを競うことができます。スコアに応じた報酬の獲得状況や、現在のランク、ランキング情報を確認できます。また、協力バトル（レイド）モードでは全プレイヤーの合計スコアによる協力スコア報酬も獲得できます。

## プレイヤーができること

### バトルへの挑戦

#### 通常挑戦
- 1日の挑戦可能回数内でバトルを開始できる
- 挑戦回数はキャンペーン中に増加する場合がある
- パーティ編成を確認してバトルに進む

#### 広告視聴による挑戦
- 通常挑戦回数を使い切った場合、広告を視聴して追加挑戦できる
- 広告スキップパス所持時は広告視聴をスキップできる
- 1日の広告挑戦回数の上限がある

### スコアと報酬の確認

#### ハイスコア報酬
- 自分の最高スコアに応じた報酬を獲得できる
- 画面表示時に未受取の報酬を自動的に受け取る
- ゲージアニメーションで報酬到達状況が視覚的に表示される
- 複数の報酬段階があり、スコアが高いほど豪華な報酬を獲得

#### 協力スコア報酬（レイドモード限定）
- 全プレイヤーの合計スコアによる協力報酬を獲得できる
- 協力スコアが一定値に到達すると報酬が受け取れる
- 画面表示時に未受取の協力スコア報酬を自動的に受け取る

#### スコアランクの確認
- 累計スコアに応じたランク（ブロンズ、シルバー、ゴールド、マスター）を確認できる
- 次のランクに必要なスコアを確認できる

### 情報の確認と画面遷移

#### 敵の詳細情報
- 敵の詳細情報画面で出現する敵キャラクターの情報を確認できる

#### ランキングの確認
- ランキング画面でスコアランキングを確認できる
- ランキング集計中は「集計中」メッセージが表示され、閲覧できない
- ランキング更新は開催開始から一定時間後に行われる

#### 報酬一覧の確認
- 報酬一覧画面でハイスコア報酬、協力スコア報酬、ランキング報酬、ランク報酬を確認できる

#### ミッション確認
- ミッション画面で降臨バトル関連のミッションと報酬を確認できる
- 未受取ミッション報酬がある場合、バッジが表示される

#### ボーナスユニット確認
- イベントボーナス対象のユニットを一覧で確認できる

#### パーティ編成
- パーティ編成画面に遷移してバトル用のパーティを編成できる
- イベントボーナスが設定される

#### 特殊ルール確認
- 特殊ルールがある場合、特殊ルール画面で詳細を確認できる

### その他の機能

#### ヘルプの確認
- 降臨バトルと協力バトル（レイド）のヘルプダイアログを表示できる

#### チュートリアル
- 降臨バトル画面への初回遷移時にチュートリアルダイアログが自動表示される
- 協力スコア機能への初回遷移時にもチュートリアルダイアログが表示される

## 画面の要素

### ヘッダー部分
- 降臨バトル名
- ボス説明文
- 残り時間のカウントダウン表示
- ヘルプボタン
- 戻るボタン

### 敵表示エリア
- 敵キャラクター画像（最大3体）
- 背景画像（降臨バトルごとに異なる）
- 敵詳細ボタン

### スコア表示エリア
- 累計スコア
- 現在のランクアイコンとレベル
- 次のランクまでの必要スコア
- 最高スコア

### 協力スコアエリア（レイドモード限定）
- 協力スコア値
- 次の報酬までの必要スコア

### ハイスコア報酬ゲージ
- スコアゲージバー
- 報酬アイコンと到達スコア
- 獲得済みスタンプ表示
- ピックアップ報酬の強調表示

### 情報ボタンエリア
- ランキングボタン（集計中は吹き出し表示）
- 報酬一覧ボタン
- ミッションボタン（バッジ表示あり）
- ボーナスユニットボタン
- 特殊ルールボタン（特殊ルールがある場合のみ表示）

### パーティ情報とバトル開始エリア
- 現在のパーティ名表示
- パーティ編成ボタン
- バトル開始ボタン
- 残り挑戦回数表示
- キャンペーン情報表示（開催中の場合）
- 広告スキップパス情報表示（所持している場合）

## 画面遷移

### この画面への遷移
- **ホーム画面**: 降臨バトルバナーをタップ
- **降臨バトル関連画面**: 戻るボタンでこの画面に戻る

### この画面からの遷移
- **敵詳細画面**: 敵詳細ボタンをタップ
- **ランキング画面**: ランキングボタンをタップ（集計中はトーストメッセージ表示）
- **報酬一覧画面**: 報酬一覧ボタンをタップ
- **ミッション画面**: ミッションボタンをタップ
- **ボーナスユニット一覧画面**: ボーナスユニットボタンをタップ
- **パーティ編成画面**: パーティ編成ボタンをタップ
- **インゲーム画面**: バトル開始ボタンをタップ（バトル開始処理後）
- **特殊ルール画面**: 特殊ルールボタンをタップ
- **制限状態画面**: パーティが特殊ルール違反の場合に表示
- **ホーム画面**: 戻るボタンまたはエスケープキー

## ゲーム仕様・制約事項

### 開催期間
- 降臨バトルは開催期間が設定されている
- 開催期間外はこの画面に遷移できない
- 期間終了時刻を過ぎた状態でバトル開始を試みるとエラーメッセージが表示される

### 挑戦回数の制限
- 1日の通常挑戦回数が設定されている
- キャンペーン中は挑戦回数が増加する
- 通常挑戦回数を使い切ると広告挑戦のみ可能になる
- 広告挑戦も1日の上限回数が設定されている
- 挑戦回数は毎日リセットされる
- すべての挑戦回数を使い切った状態でバトル開始ボタンをタップするとメッセージが表示される

### 報酬の自動受取
- 画面表示時にハイスコア報酬の未受取分を自動的に受け取る
- 協力スコア報酬も同様に自動受取される
- 報酬受取時は演出が再生される（ゲージアニメーション、報酬受取ダイアログ）
- 報酬がない場合は演出をスキップして即座に画面表示される

### ハイスコアゲージアニメーション
- 前回表示時のスコアから現在のスコアまでゲージが伸びる
- 報酬到達時にスタンプ演出とSEが再生される
- アニメーション再生中は画面操作がブロックされる

### ランキング集計
- 開催開始から一定時間は「ランキング集計中」状態になる
- 集計中はランキングボタンに吹き出しが表示される
- 集計中にランキングボタンをタップするとトーストメッセージが表示される
- 集計完了後は吹き出しが消え、ランキング確認が可能になる
- 集計状態は1秒ごとに監視される

### バトルタイプ
- **スコアチャレンジ**: 個人スコアのみ競う
- **レイド**: 個人スコアと協力スコアの両方がある

### パーティ制限
- 特殊ルールが設定されている場合、パーティ編成に制限がある
- 制限違反のパーティでバトル開始を試みると制限状態画面が表示される

### チュートリアルダイアログ
- チュートリアルダイアログ表示中は画面から離脱できない
- バックキー操作が無効化される
- チュートリアル表示後、自動的にチュートリアル完了状態が保存される

### 広告視聴とスキップパス
- 広告視聴による挑戦時、広告スキップパス未所持の場合は広告確認ダイアログが表示される
- 広告スキップパス所持時は広告を視聴せずに挑戦できる
- 広告視聴成功後にバトル開始処理が実行される

### エラー処理
- バトル開始失敗時は操作可能状態に戻る
- エラー種類に応じた画面やメッセージが表示される（期間外、回数超過、パーティ不正）

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/`

### 主要コンポーネント

#### Presenter
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Presentation/Presenter/AdventBattleTop/AdventBattleTopPresenter.cs`

#### ViewModel
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Presentation/ViewModel/AdventBattleTopViewModel.cs`

#### UseCase
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/FetchAdventBattleTopInfoUseCase.cs`
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/AdventBattleStartUseCase.cs`
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/ReceiveAdventBattleScoreRewardsUseCase.cs`

#### Translator
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Presentation/Translator/AdventBattleTopViewModelTranslator.cs`

#### Service
- `/Users/junki.mizutani/Documents/workspace/glow/glow-brain/projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Services/AdventBattleService.cs`

### AdventBattleTopViewModelの構造
画面に表示する降臨バトルの情報を保持するViewModel。

主要プロパティ:
- MstAdventBattleId: 降臨バトルID
- BattleType: バトルタイプ（スコアチャレンジ/レイド）
- EventBonusGroupId: イベントボーナスグループID
- ChallengeableCount: 残り挑戦回数
- AdChallengeableCount: 残り広告挑戦回数
- AdventBattleChallengeType: 挑戦タイプ（通常/広告）
- TotalScore: 累計スコア
- MaxScore: 最高スコア
- RaidTotalScore: 協力スコア
- CurrentRankType: 現在のランクタイプ
- CurrentScoreRankLevel: 現在のランクレベル
- DisplayEnemyUnitFirst/Second/Third: 表示する敵ユニット画像パス
- KomaBackgroundAssetPath: 背景画像パス
- HighScoreRewards: ハイスコア報酬リスト
- AdventBattleRemainingTimeSpan: 残り時間
- HighScoreGaugeViewModel: ハイスコアゲージ表示用ViewModel
- ExistsSpecialRule: 特殊ルールの有無
- MissionBadge: ミッションバッジ表示フラグ
- CalculatingRankings: ランキング集計中フラグ
- AdventBattleName: 降臨バトル名
- AdventBattleBossDescription: ボス説明文
- HeldAdSkipPassInfoViewModel: 広告スキップパス情報
- CampaignViewModels: キャンペーン情報リスト

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.BattleType | mst_advent_battles.advent_battle_type | バトルタイプ（ScoreChallenge/Raid） |
| MstAdventBattle.EventBonusGroupId | mst_advent_battles.event_bonus_group_id | イベントボーナスグループID |
| MstAdventBattle.ChallengeCount | mst_advent_battles.challengeable_count | 1日の挑戦可能回数 |
| MstAdventBattle.AdChallengeCount | mst_advent_battles.ad_challengeable_count | 1日の広告挑戦可能回数 |
| MstAdventBattle.DisplayEnemyUnitIdFirst | mst_advent_battles.display_mst_unit_id1 | トップ画面に表示する敵キャラ1 |
| MstAdventBattle.DisplayEnemyUnitIdSecond | mst_advent_battles.display_mst_unit_id2 | トップ画面に表示する敵キャラ2 |
| MstAdventBattle.DisplayEnemyUnitIdThird | mst_advent_battles.display_mst_unit_id3 | トップ画面に表示する敵キャラ3 |
| MstAdventBattle.AdventBattleAssetKey | mst_advent_battles.asset_key | 背景アセットキー |
| MstAdventBattle.StartDateTime | mst_advent_battles.start_at | 開催開始日時 |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | 開催終了日時 |
| MstAdventBattle.AdventBattleName | mst_advent_battles_i18n.name | 降臨バトル名（多言語） |
| MstAdventBattle.AdventBattleBossDescription | mst_advent_battles_i18n.boss_description | ボス説明文（多言語） |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリー（MaxScore/Ranking/Rank/RaidTotalScore） |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.condition_value | 報酬条件値（スコアやランク） |
| MstAdventBattleReward.ResourceType | mst_advent_battle_rewards.resource_type | 報酬タイプ（Coin/FreeDiamond/Item/Emblem） |
| MstAdventBattleReward.ResourceId | mst_advent_battle_rewards.resource_id | 報酬ID |
| MstAdventBattleReward.ResourceAmount | mst_advent_battle_rewards.resource_amount | 報酬数量 |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold/Master） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_ranks.rank_level | ランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_ranks.required_lower_score | ランク到達に必要な最低スコア |
| MstEnemyCharacter.AssetKey | mst_units.asset_key | 敵キャラクター画像アセットキー |
| MstConfig.AdventBattleRankingUpdateIntervalMinutes | mst_configs | ランキング更新間隔（分） |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserAdventBattle.MstAdventBattleId | usr_advent_battles.mst_advent_battle_id | 降臨バトルID |
| UserAdventBattle.MaxScore | usr_advent_battles.max_score | プレイヤーの最高スコア |
| UserAdventBattle.TotalScore | usr_advent_battles.total_score | プレイヤーの累計スコア |
| UserAdventBattle.ResetChallengeCount | usr_advent_battles.reset_challenge_count | 使用済み挑戦回数（デイリーリセット） |
| UserAdventBattle.ResetAdChallengeCount | usr_advent_battles.reset_ad_challenge_count | 使用済み広告挑戦回数（デイリーリセット） |
| UserAdventBattle.HighScoreLastAnimationPlayed | usr_advent_battles.max_received_max_score_reward | 前回アニメーション再生時のスコア |
| AdventBattleRaidTotalScore.MstAdventBattleId | (協力スコアはサーバー集計値) | 降臨バトルID |
| AdventBattleRaidTotalScore.AdventBattleRaidTotalScore | (協力スコアはサーバー集計値) | 全プレイヤーの合計スコア |
| UserParameter | usr_users | ユーザーパラメータ（報酬受取後の更新） |
| UserItem | usr_items | ユーザーアイテム（報酬受取後の更新） |
| UserEmblem | usr_emblems | ユーザーエンブレム（報酬受取後の更新） |
| Badge.UnreceivedMissionAdventBattleRewardCount | (バッジ情報はGameFetch) | 未受取ミッション報酬数 |
| PartyCache.PartyName | usr_parties.name | 現在選択中のパーティ名 |

### 呼び出しているAPI

#### 画面初期化時
- **POST `/advent-battle/top`**: 降臨バトルトップAPI
  - パラメータ: mstAdventBattleId (降臨バトルID)
  - 用途: 未受取のハイスコア報酬と協力スコア報酬を受け取る
  - レスポンス: UserParameter、UserItems、UserEmblems、AdventBattleMaxScoreRewards、AdventBattleRaidTotalScoreRewards
  - 注意: ハイスコアに変動がない場合や受取可能報酬がない場合は呼び出されない

#### バトル開始時
- **POST `/advent-battle/start`**: 降臨バトル開始API
  - パラメータ: mstAdventBattleId (降臨バトルID), partyNo (パーティ番号), isChallengeAd (広告挑戦フラグ), inGameBattleLog (バトルログ)
  - 用途: バトルセッションを開始し、挑戦回数を消費する
  - エラー時の処理: 期間外、回数超過、パーティ制限違反などのエラーを返す

#### ランキング表示時
- **POST `/advent-battle/ranking`**: 降臨バトルランキングAPI
  - パラメータ: mstAdventBattleId (降臨バトルID), isPrevious (前回ランキングフラグ)
  - 用途: ランキング情報を取得（別画面での使用）
