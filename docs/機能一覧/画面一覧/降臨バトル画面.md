# 降臨バトル画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトル画面 (AdventBattle) |
| **画面種別** | メイン画面 |

## 概要

降臨バトルは、期間限定で開催される高難易度バトルコンテンツです。プレイヤーは強敵に挑戦し、ハイスコアを目指すことで報酬を獲得できます。スコアチャレンジ型と協力スコア型（レイドバトル）の2種類があり、協力スコア型では全プレイヤーの合計スコアに応じた追加報酬が用意されています。

## プレイヤーができること

### バトルへの挑戦

#### 通常挑戦
- 1日あたりの挑戦回数制限内でバトルに挑戦
- キャンペーン中は挑戦回数が増加する場合がある
- 挑戦回数を消費してバトルに参加

#### 広告視聴による追加挑戦
- 通常の挑戦回数を使い切った後、広告を視聴して追加挑戦が可能
- 広告スキップパスを所持している場合は広告視聴をスキップして挑戦できる
- 広告挑戦にも回数制限あり

#### パーティ編成
- バトル前にパーティ編成画面に遷移してユニットを編成
- イベントボーナス対象ユニットを確認できる
- 特別ルールの適用状態を確認できる

### スコアと報酬

#### ハイスコア報酬
- バトルで獲得したハイスコア（最高スコア）に応じて報酬を獲得
- 画面初回表示時にスコア達成報酬を自動受け取り
- ゲージが伸びるアニメーションとともに報酬を獲得
- 複数の報酬段階があり、スコアに応じて順次解放

#### 協力スコア報酬（レイドバトルの場合）
- 全プレイヤーの合計スコアに応じて報酬を獲得
- 協力スコアが一定値に達すると全員が報酬を受け取れる
- 画面初回表示時に自動受け取り

#### ランキング報酬
- プレイヤーのスコアに応じてランクが付与される（Bronze、Silver、Gold等）
- ランキング画面で順位を確認できる
- ランキングは定期的に集計され、集計中は「集計中」表示

### 情報確認

#### 敵情報の確認
- 敵の詳細情報ダイアログを表示
- 敵キャラクターの種類、ロール、属性を確認
- バトルの説明文を確認
- クリア報酬一覧を表示
- 特別ルール（制約条件）を確認

#### 報酬一覧の確認
- ハイスコア報酬の一覧を表示
- 協力スコア報酬の一覧を表示（レイドバトルの場合）
- ランキング報酬の一覧を表示

#### ボーナスユニットの確認
- イベントボーナス対象ユニットの一覧を表示
- ボーナス倍率を確認

#### ミッション
- 降臨バトル専用ミッションを確認
- ミッション報酬を受け取り
- 未受け取りミッションがある場合はバッジ表示

#### ヘルプ
- 降臨バトルの遊び方ダイアログを表示
- 協力スコアバトルの説明ダイアログを表示（レイドバトルの場合）

### チュートリアル

#### 初回遷移時のガイド
- 降臨バトル画面に初めて遷移した際に説明ダイアログを表示
- 協力スコアバトルに初めて遷移した際に説明ダイアログを表示
- チュートリアルダイアログ表示中は画面から離脱できない

## 画面の要素

### ヘッダー部分
- 降臨バトル名
- ボスの説明文
- 残り時間表示（期間終了までのカウントダウン）

### メイン表示エリア
- 敵キャラクター画像（最大3体）
- 背景画像（降臨バトル専用の背景）

### スコア表示エリア
- 現在のランク（Bronze、Silver、Gold等）
- 現在のランクレベル
- 次のランクまでの必要スコア
- 協力スコア（レイドバトルの場合）

### ハイスコア報酬ゲージ
- 現在のハイスコアを示すゲージ
- 各報酬段階のアイコンとスコア閾値
- 獲得済み報酬にはスタンプ表示
- ゲージ更新時のスクロールアニメーション

### 挑戦回数表示
- 残り挑戦回数
- 広告挑戦の残り回数
- キャンペーン中の追加回数表示

### ボタンエリア
- **バトル開始ボタン**: バトルに挑戦
  - 挑戦回数が0の場合は広告視聴確認ダイアログを表示
  - 広告挑戦回数も0の場合はグレーアウト
- **パーティ編成ボタン**: パーティ編成画面に遷移
- **敵詳細ボタン**: 敵情報ダイアログを表示
- **ランキングボタン**: ランキング画面に遷移
  - 集計中の場合は「集計中」バルーン表示
- **報酬一覧ボタン**: 報酬一覧画面に遷移
- **ミッションボタン**: ミッション画面に遷移
  - 未受け取りミッションがある場合はバッジ表示
- **ボーナスユニットボタン**: ボーナスユニット一覧を表示
- **ヘルプボタン**: ヘルプダイアログを表示
- **戻るボタン**: ホーム画面に戻る

### フッター部分
- 現在選択中のパーティ名
- 特別ルールボタン（特別ルールがある場合のみ表示）

## 画面遷移

### この画面への遷移
- **ホーム画面**: 降臨バトルアイコンをタップ

### この画面からの遷移
- **パーティ編成画面**: パーティ編成ボタンをタップ
  - イベントボーナスグループが設定された状態で遷移
- **バトル画面**: バトル開始ボタンをタップ
  - 広告視聴が必要な場合は広告視聴後に遷移
  - パーティが特別ルールを満たしていない場合はエラーダイアログ表示
  - 期間外の場合はエラーメッセージ表示
  - 挑戦回数不足の場合はエラーメッセージ表示
- **敵詳細ダイアログ**: 敵詳細ボタンをタップ
- **ランキング画面**: ランキングボタンをタップ
  - 集計中の場合はトーストメッセージで通知
- **報酬一覧画面**: 報酬一覧ボタンをタップ
- **ミッション画面**: ミッションボタンをタップ
- **ボーナスユニット一覧ダイアログ**: ボーナスユニットボタンをタップ
- **ヘルプダイアログ**: ヘルプボタンをタップ
- **特別ルールダイアログ**: 特別ルールボタンをタップ
- **ホーム画面**: 戻るボタンまたは画面外タップで戻る

## ゲーム仕様・制約事項

### 挑戦回数制限
- 1日あたりの通常挑戦回数が設定されている
- 挑戦回数は日次リセットで復活
- キャンペーン中は挑戦回数が増加する
- 通常挑戦回数を使い切った後は広告視聴で追加挑戦可能
- 広告挑戦にも回数制限あり

### バトルタイプ
- **スコアチャレンジ型**: 個人のスコアのみで競う
- **協力スコア型（レイドバトル）**: 全プレイヤーの合計スコアで報酬を獲得

### スコア計算
- バトル中の与ダメージや撃破した敵の種類に応じてスコアを獲得
- スコア加算方式（全敵撃破+拠点破壊、ダメージ量など）はバトルごとに設定
- ハイスコアは最高記録のみが保存される
- トータルスコアはすべてのバトルの合計

### ランキング集計
- ランキングは定期的に集計される
- 開始から一定時間は集計中となり、ランキング表示不可
- 集計完了後にランキング画面が閲覧可能

### 特別ルール
- 一部の降臨バトルでは特別ルール（制約条件）が適用される
- 特別ルールを満たさないパーティではバトルに挑戦できない
- 例: 特定属性のユニットのみ使用可能、特定ロールのユニット禁止など

### 期間限定
- 降臨バトルは期間限定で開催される
- 開催期間外はバトルに挑戦できない
- 画面上部に残り時間がカウントダウン表示される

### 報酬自動受け取り
- ハイスコア報酬と協力スコア報酬は画面表示時に自動的に受け取り処理が実行される
- 前回の画面表示時から新たに達成した報酬のみが演出される
- ゲージアニメーションとともに報酬が表示される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenter/AdventBattleTop/AdventBattleTopPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Presentation/Presenter/AdventBattleTop/AdventBattleTopPresenter.cs)
- `Presentation/Presenter/AdventBattleInfoPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Presentation/Presenter/AdventBattleInfoPresenter.cs)

#### ViewModel
- `Presentation/ViewModel/AdventBattleTopViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Presentation/ViewModel/AdventBattleTopViewModel.cs)

#### View
- `Presentation/View/AdventBattleTopViewController.cs`
- `Presentation/View/AdventBattleInfo/AdventBattleInfoViewController.cs`

#### UseCase
- `Domain/UseCase/FetchAdventBattleTopInfoUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/FetchAdventBattleTopInfoUseCase.cs)
- `Domain/UseCase/AdventBattleStartUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/AdventBattleStartUseCase.cs)
- `Domain/UseCase/AdventBattleInfoUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/AdventBattleInfoUseCase.cs)
- `Domain/UseCase/ReceiveAdventBattleScoreRewardsUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattle/Domain/UseCase/ReceiveAdventBattleScoreRewardsUseCase.cs)

#### Service
- `Core/Data/Services/AdventBattleService.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Core/Data/Services/AdventBattleService.cs)

#### WireFrame
- `Presentation/Presenter/AdventBattleTop/AdventBattleWireFrame.cs`

### AdventBattleTopViewModelの構造

画面表示に必要なデータを保持：

- `MstAdventBattleId`: 降臨バトルID
- `BattleType`: バトルタイプ（スコアチャレンジ / 協力スコア）
- `EventBonusGroupId`: イベントボーナスグループID
- `ChallengeableCount`: 残り挑戦回数
- `AdChallengeableCount`: 広告挑戦の残り回数
- `AdventBattleChallengeType`: 挑戦タイプ（通常 / 広告）
- `TotalScore`: トータルスコア
- `RequiredLowerScore`: 次のランクまでの必要スコア
- `MaxScore`: ハイスコア（最高スコア）
- `RaidTotalScore`: 協力スコア（レイドバトルの場合）
- `RequiredLowerRaidTotalScore`: 次の協力スコア報酬までの必要スコア
- `CurrentRankType`: 現在のランク
- `CurrentScoreRankLevel`: 現在のスコアランクレベル
- `DisplayEnemyUnitFirst/Second/Third`: 表示する敵ユニット画像パス
- `KomaBackgroundAssetPath`: 背景画像パス
- `HighScoreRewards`: ハイスコア報酬リスト
- `AdventBattleRemainingTimeSpan`: 終了までの残り時間
- `PartyName`: 選択中のパーティ名
- `HighScoreGaugeViewModel`: ハイスコアゲージのViewModel
- `ExistsSpecialRule`: 特別ルールの有無
- `MissionBadge`: ミッションバッジの表示状態
- `CalculatingRankings`: ランキング集計中フラグ
- `AdventBattleName`: 降臨バトル名
- `AdventBattleBossDescription`: ボス説明文
- `HeldAdSkipPassInfoViewModel`: 広告スキップパス所持情報
- `CampaignViewModels`: キャンペーン情報リスト

### 画面初期化の流れ

1. `FetchAdventBattleTopInfoUseCase.FetchAdventBattleTop()`でデータを取得
2. 開催期間内の降臨バトルを特定
3. マスタデータからバトル情報、報酬情報、敵情報を取得
4. ユーザーデータからスコア、挑戦回数、天井情報を取得
5. ViewModelに変換して画面に表示
6. 非同期で敵ユニット画像をロード
7. ハイスコア報酬の自動受け取り処理を実行
8. ゲージアニメーションを再生

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.MstEventId | mst_advent_battles.mst_event_id | イベントID |
| MstAdventBattle.AdventBattleAssetKey | mst_advent_battles.advent_battle_asset_key | 背景画像のアセットキー |
| MstAdventBattle.BattleType | mst_advent_battles.battle_type | バトルタイプ（スコアチャレンジ / 協力スコア） |
| MstAdventBattle.MstAutoPlayerSequenceSetId | mst_advent_battles.mst_auto_player_sequence_set_id | 敵配置シーケンスID |
| MstAdventBattle.EventBonusGroupId | mst_advent_battles.event_bonus_group_id | イベントボーナスグループID |
| MstAdventBattle.ChallengeCount | mst_advent_battles.challenge_count | 1日あたりの挑戦回数 |
| MstAdventBattle.AdChallengeCount | mst_advent_battles.ad_challenge_count | 広告挑戦の回数上限 |
| MstAdventBattle.DisplayEnemyUnitIdFirst | mst_advent_battles.display_enemy_unit_id_first | 表示する敵ユニット1 |
| MstAdventBattle.DisplayEnemyUnitIdSecond | mst_advent_battles.display_enemy_unit_id_second | 表示する敵ユニット2 |
| MstAdventBattle.DisplayEnemyUnitIdThird | mst_advent_battles.display_enemy_unit_id_third | 表示する敵ユニット3 |
| MstAdventBattle.StartDateTime | mst_advent_battles.start_at | 開催開始日時 |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | 開催終了日時 |
| MstAdventBattle.UserExp | mst_advent_battles.user_exp | クリア時の獲得経験値 |
| MstAdventBattle.Coin | mst_advent_battles.coin | クリア時の獲得コイン |
| MstAdventBattle.InGameDescription | mst_advent_battles.in_game_description | バトルの説明文 |
| MstAdventBattle.AdventBattleName | mst_advent_battles.advent_battle_name | 降臨バトル名 |
| MstAdventBattle.AdventBattleBossDescription | mst_advent_battles.advent_battle_boss_description | ボス説明文 |
| MstAdventBattle.ScoreAdditionType | mst_advent_battles.score_addition_type | スコア加算方式 |
| MstAdventBattle.MstInGameId | mst_advent_battles.mst_in_game_id | インゲームマスタID |
| MstAdventBattleRewardGroup.Id | mst_advent_battle_reward_groups.id | 報酬グループID |
| MstAdventBattleRewardGroup.MstAdventBattleId | mst_advent_battle_reward_groups.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリ（ハイスコア / 協力スコア / ランク） |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.reward_condition | 報酬獲得条件（スコア閾値） |
| MstAdventBattleRewardGroup.Rewards | mst_advent_battle_rewards.* | 報酬内容（MstAdventBattleRewardモデルのリスト） |
| MstAdventBattleScoreRank.Id | mst_advent_battle_score_ranks.id | スコアランクID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_score_ranks.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_score_ranks.rank_type | ランクタイプ（Bronze、Silver、Gold等） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_score_ranks.score_rank_level | ランクレベル |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_score_ranks.required_lower_score | 必要下限スコア |
| MstAdventBattleClearReward.ResourceType | mst_advent_battle_clear_rewards.resource_type | クリア報酬のリソースタイプ |
| MstAdventBattleClearReward.ResourceId | mst_advent_battle_clear_rewards.resource_id | クリア報酬のリソースID |
| MstAdventBattleClearReward.ResourceAmount | mst_advent_battle_clear_rewards.resource_amount | クリア報酬の数量 |
| MstAdventBattleClearReward.RewardCategory | mst_advent_battle_clear_rewards.reward_category | 報酬カテゴリ（初回 / 毎回） |
| MstEnemyCharacter.Id | mst_enemy_characters.id | 敵キャラクターID |
| MstEnemyCharacter.AssetKey | mst_enemy_characters.asset_key | 敵キャラクター画像のアセットキー |
| MstEnemyCharacter.Name | mst_enemy_characters.name | 敵キャラクター名 |
| MstConfig.Value | mst_configs.value | ランキング集計間隔などの設定値（AdventBattleRankingUpdateIntervalMinutes） |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserAdventBattle.MstAdventBattleId | user_advent_battles.mst_advent_battle_id | 降臨バトルID |
| UserAdventBattle.MaxScore | user_advent_battles.max_score | ハイスコア（最高スコア） |
| UserAdventBattle.TotalScore | user_advent_battles.total_score | トータルスコア（累計） |
| UserAdventBattle.HighScoreLastAnimationPlayed | user_advent_battles.high_score_last_animation_played | 前回のゲージアニメーション再生時のスコア |
| UserAdventBattle.ResetChallengeCount | user_advent_battles.reset_challenge_count | 本日の挑戦済み回数 |
| UserAdventBattle.ResetAdChallengeCount | user_advent_battles.reset_ad_challenge_count | 本日の広告挑戦済み回数 |
| UserAdventBattle.ClearCount | user_advent_battles.clear_count | クリア回数 |
| AdventBattleRaidTotalScore.MstAdventBattleId | advent_battle_raid_total_scores.mst_advent_battle_id | 降臨バトルID（協力スコア） |
| AdventBattleRaidTotalScore.AdventBattleRaidTotalScore | advent_battle_raid_total_scores.total_score | 全プレイヤーの協力スコア合計 |
| BadgeModel.UnreceivedMissionAdventBattleRewardCount | badges.unreceived_mission_advent_battle_reward_count | 未受け取り降臨バトルミッション数 |
| PartyModel.PartyNo | user_parties.party_no | パーティ番号 |
| PartyModel.PartyName | user_parties.party_name | パーティ名 |

### 呼び出しているAPI

#### バトル開始
- **POST `/api/advent_battle/start`**: 降臨バトル開始
  - パラメータ:
    - `mstAdventBattleId` (降臨バトルID)
    - `partyNo` (パーティ番号)
    - `isChallengeAd` (広告挑戦フラグ)
    - `inGameBattleLog` (バトル開始ログ)
  - 用途: バトル開始時の挑戦回数消費とバトルセッション開始

#### 報酬受け取り
- **POST `/api/advent_battle/top`**: 降臨バトルトップ情報取得と報酬受け取り
  - パラメータ: `mstAdventBattleId` (降臨バトルID)
  - 用途: 画面表示時に未受け取りのハイスコア報酬と協力スコア報酬を自動受け取り
  - レスポンス:
    - `UserParameter` (更新後のユーザーパラメータ)
    - `UserItems` (更新後のアイテム所持数)
    - `UserEmblems` (更新後の称号)
    - `AdventBattleMaxScoreRewards` (ハイスコア報酬)
    - `AdventBattleRaidTotalScoreRewards` (協力スコア報酬)

#### ランキング取得
- **GET `/api/advent_battle/ranking`**: ランキング情報取得
  - パラメータ:
    - `mstAdventBattleId` (降臨バトルID)
    - `isPrevious` (前回開催のランキングを取得するか)
  - 用途: ランキング画面表示時にランキングデータを取得
