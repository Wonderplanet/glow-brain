# InGame画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | InGame画面（ゲーム内バトル画面） |
| **画面種別** | メイン画面 |

## 概要

ゲームの核となるバトルシステムを統制する画面です。プレイヤーはユニットを出撃させて敵と戦い、ステージの目標を達成することでバトルを勝利・完了させます。バトル中は、リアルタイムで戦況が変化し、プレイヤーはユニット召喚、特殊攻撃発動、デッキ変更、自動戦闘の切り替えなど、複数の戦術的操作を行いながらバトルを進行させます。

## プレイヤーができること

### ユニット召喚

#### ユニットの出撃
- 画面下部のデッキから任意のユニットをタップして出撃させる
- ユニット出撃には「戦闘ポイント」というコストが必要
- 戦闘ポイント不足の場合はボタンがグレーアウト表示される
- 一部のユニットには再召喚のクールタイムが存在する
- クールタイム中のユニットはボタンにクールタイム表示が出る

#### スペシャルユニット（特殊ユニット）の召喚
- デッキ内の特殊ユニット枠から召喚可能
- 召喚前に確認ダイアログが表示される
- 召喚後、フィールド上にユニットを配置する位置を選択する
- 配置可能な範囲が視覚的に表示される

### 攻撃・スキル操作

#### 通常攻撃
- 出撃したユニットが自動的に敵を攻撃する
- 攻撃距離や攻撃方向はユニットの属性によって異なる

#### 必殺技（特殊攻撃）
- 各ユニットは固有の必殺技を持つ
- 必殺技は「クールタイム」により再使用までの待機時間が設定されている
- デッキのユニットアイコンをロングプレスすると、そのユニットの詳細情報を表示
- 必殺技発動時には「カットイン演出」が再生される場合がある

### 戦闘ゲージ操作

#### ラッシュ（Rush）ゲージ
- 戦闘ゲージが一定値まで溜まるとラッシュゲージが出現
- ラッシュゲージをタップすると、強力な必殺技「ラッシュ」を発動
- PvPモード時は、対手のラッシュゲージも表示される

### 戦闘速度変更

#### バトル速度の調整
- ヘッダーのバトル速度ボタンでゲームの進行速度を変更可能
- 通常（x1）、速い（x1.5, x2など）の複数段階から選択可能
- 一部クエストでは速度変更に制限がある場合がある

### 自動戦闘

#### オート機能
- ヘッダーのオートボタンで自動戦闘をオン/オフ
- オン時はユニット召喚と特殊攻撃が自動実行される
- 手動操作に切り替えることもできる
- チュートリアル完了までは隠されている場合がある

### デッキ変更

#### 1列/2列デッキ表示の切り替え
- 画面下部のデッキを1列表示と2列表示で切り替え可能
- 2列表示で6体以上のユニットを同時に表示できる

### 画面内メニュー操作

#### ポーズ・メニュー
- ヘッダーのメニューボタンをタップするとゲーム内メニューが開く
- バトル進行が一時停止される

#### ゲーム内オプション
- BGM/SE音量のミュート切り替え
- 必殺技カットイン設定の変更
- ダメージ表示設定の変更
- デッキ表示の1列/2列切り替え

#### ステージ中断（アボート）
- メニューから中断ボタンで戦闘を途中で終了
- ホーム画面に戻される
- PvPの場合は「ギブアップ」として敗北扱いになる

### ユニット詳細表示

#### ユニット情報の確認
- デッキ内のユニットアイコンをロングプレスでユニット詳細モーダルを表示
- ユニットのステータス、スキル、アビリティ情報を確認可能
- チュートリアル中はこの機能が制限される可能性がある

## 画面の要素

### ヘッダー部分

#### 左側情報
- **ステージ名・ステージナンバー**: 現在のステージ情報
- **タイマー表示**（制限時間がある場合）: 残り時間のカウントダウン
- **制限時間切れ警告**: 時間が少なくなると色が変わる

#### 右側ボタン
- **バトル速度ボタン**: 現在のバトル速度（x1, x1.5など）を表示、タップで速度変更
- **オートボタン**: オート戦闘のオン/オフ、チュートリアル未完了時は隠される
- **メニューボタン**: ゲーム内メニューを開く、チュートリアル未完了時は隠される

### メイン表示エリア

#### フィールド表示
- **プレイヤー側拠点（アウトポスト）**: 画面左側に配置、体力ゲージ表示
- **敵側拠点（アウトポスト）**: 画面右側に配置、体力ゲージ表示
- **バトルフィールド**: ユニットが配置・移動して戦闘が行われる領域
- **コマ（升目）**: フィールドがグリッド状に分割され、ユニット配置の基準になる

#### ユニット表示
- **味方ユニット**: フィールド上に配置、攻撃・防御の動作を表示
- **敵ユニット**: フィールド上に配置、ドラッグで詳細情報を表示可能な場合がある
- **ユニットHP**: 各ユニット上部にHPバー表示
- **ユニットステータスエフェクト**: 状態異常・バフ/デバフなどのアイコン表示

#### 画面左側情報パネル

##### ラッシュゲージ（プレイヤー側）
- 戦闘ゲージの累積状態を表示
- 一定値に達するとラッシュが発動可能になる
- 大きく目立つボタン配置で、タップすぐに発動できる

##### PvP対戦情報（PvPモード時）
- **対手ラッシュゲージ**: 相手のラッシュゲージ状態
- **スコア表示**: PvP専用のスコア情報

#### 画面中央下部情報

##### 戦闘ポイント表示
- 現在の戦闘ポイント値とゲージ
- ユニット召喚に消費される値

##### 戦闘成績情報（ステージによって異なる）
- **スコア**: 現在のスコア（スコアラッシュクエストなど）
- **シールド**: 防御関連の情報（防御ラッシュなど）
- **複合情報**: ステージ固有のゲーム仕様に応じた情報

### ボタンエリア

#### デッキ表示エリア
- **ユニットアイコン**: 6体または12体のユニットを表示
- **アイコン色分け**: ユニットのキャラクターカラー（属性）で視覚的区別
- **戦闘ポイント表示**: ユニット召喚に必要なコスト
- **クールタイム表示**: 再召喚待機中の場合、時間を表示
- **グレーアウト表示**: ポイント不足時またはロック中
- **ロック機能**: 一部ユニットが「ロック」状態になる場合がある（操作不可）

#### スペシャルユニット枠
- デッキ内の1～2枠が特殊ユニット枠として設定
- 通常ユニット異なるユニットを出撃させられる
- 確認ダイアログを経由して召喚

### ポップアップ・ダイアログ

#### ユニット詳細モーダル
- **ユニット情報**: ユニット名、アイコン、ロールタイプ
- **ステータス**: HP、攻撃力、防御力、移動速度など
- **スキル**: アビリティスキルの一覧と説明
- **必殺技**: 必殺技名、説明、クールタイム
- **状態エフェクト表示**: 現在受けている状態異常・バフ情報

#### スペシャルユニット召喚確認ダイアログ
- スペシャルユニット召喚前に意思確認
- キャンセル可能

#### ポーズ画面（メニュー開時）
- 詳細は「ゲーム内メニュー」参照

## 画面遷移

### この画面への遷移
- **ステージ選択画面**: ステージを選択してバトル開始
  - クエスト、ステージ、PvPなど複数の出撃方法がある
- **中断復帰**: アプリ終了後の再開時、続行選択時に復帰

### この画面からの遷移
- **バトル結果画面（勝利）**: ステージクリア条件達成時
  - 次のストーリーシーンや報酬確認画面に遷移
- **バトル結果画面（敗北・完了）**: バトル終了条件達成時
  - 敗北画面や完了画面に遷移
- **ゲーム内メニュー（ポーズ画面）**: メニューボタンをタップ
  - ゲーム進行が一時停止される
- **ユニット詳細モーダル**: デッキユニットをロングプレス
  - モーダル終了後、バトルは一時停止状態を保持
- **スペシャルユニット召喚確認ダイアログ**: スペシャルユニットをタップ
  - 確認または中止後、バトル画面に戻る

## ゲーム仕様・制約事項

### バトルシステム

#### 戦闘ポイント
- ユニット召喚に必要なコスト
- バトル開始時に一定値から始まる
- 敵ユニットが倒されると増加する
- 最大値がある
- ゲーム進行や敵の編成により戦闘ポイントの増加速度が変わる

#### 召喚システム
- ユニットの召喚には戦闘ポイントが必要
- 一部ユニットにはクールタイムが設定される
- スペシャルユニット召喚には確認ダイアログが出現する
- 召喚キューに追加され、順番に出撃する

#### ラッシュ
- 一定の戦闘条件でラッシュゲージが溜まる
- ゲージが満杯になるとラッシュが発動可能
- 発動時に強力な攻撃または効果が表現される
- PvPモードでは対手のラッシュゲージも同時に管理される

#### 必殺技（特殊攻撃）
- ユニットごとに固有の必殺技を持つ
- 必殺技発動時にはカットイン演出が表示される場合がある
- 必殺技発動後はクールタイムが開始する
- クールタイム中は再使用不可

### バトル勝敗判定

#### 勝利条件
- ステージごとに異なる終了条件が設定される
- 一般的には敵拠点の体力を0にする
- 特殊なステージでは「スコア到達」「時間内生存」など異なる条件がある

#### 敗北条件
- プレイヤー拠点の体力が0になる
- 制限時間切れ（時間制限があるステージの場合）

#### 継続（コンティニュー）
- 敗北時に一定の条件下で継続が可能な場合がある
- 継続にはコストが必要（スタミナ消費など）

### 画面の特殊仕様

#### チュートリアル連携
- ゲーム開始初期のバトルでチュートリアルが進行する
- チュートリアル中はオプションボタンとラッシュゲージが隠される
- ユニット詳細表示機能が制限される可能性がある
- チュートリアル固有の強制操作やハイライト表示がある

#### ポーズ機能
- メニューやユニット詳細表示時、バトルが一時停止される
- ポーズ中もタイマーは経過する場合がある
- ポーズ機能はゲーム仕様で制限される場合がある（例：PvP）

#### オート戦闘
- ユーザー設定でオン/オフを切り替え可能
- オン時は以下が自動実行される：
  - ユニット召喚の自動実行
  - 必殺技の自動発動（条件次第）
  - ラッシュの自動発動（設定により異なる）
- ゲーム進行状況によってオートが一時停止される場合がある

#### バトル速度
- 複数の速度段階から選択可能（x1, x1.5, x2など）
- 一部クエストでは速度変更が制限される
- チュートリアル中の速度変更は不可

#### データ表示
- **ダメージ表示**: オプションでダメージ数値表示のオン/オフを切り替え可能
- **エフェクト表示**: 一部のエフェクトが画面上に表示される
- **スコア表示**: ステージに応じてスコアが表示される

### コンテンツタイプ別仕様

#### 一般クエスト
- 通常のバトルシステムが適用される
- スコアシステムが適用される場合がある

#### 降臨バトル（AdventBattle）
- 特殊なボス敵が登場する
- ボス登場時に演出が再生される
- 漫画アニメーションが表示されない

#### PvPバトル
- プレイヤー同士の対戦
- 相手のラッシュゲージが表示される
- 中断機能が制限される（ギブアップのみ）

#### イベント限定クエスト
- イベント固有のゲーム仕様が適用される場合がある
- スコアラッシュなど、特殊なゲーム仕様が導入される場合がある

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/InGame/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/InGamePresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Presentation/Presenters/InGamePresenter.cs:92)
  - メインのバトル制御、イベント処理
- `Presentation/Presenters/InGameMenuPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Presentation/Presenters/InGameMenuPresenter.cs)
  - ゲーム内メニュー制御
- `Presentation/Presenters/InGameUnitDetailPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Presentation/Presenters/InGameUnitDetailPresenter.cs)
  - ユニット詳細表示制御

#### ViewModel
- `Presentation/ViewModels/InitializeViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Presentation/ViewModels/InitializeViewModel.cs)
  - バトル初期化時のデータ構造
- `Presentation/ViewModels/DeckUnitViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/InGame/Presentation/ViewModels/DeckUnitViewModel.cs)
  - デッキ内のユニット情報

#### View
- `Presentation/Views/InGameView.cs`
- `Presentation/Views/InGameViewController.cs`

#### UseCase
- `Domain/UseCases/InitializeInGameUseCase.cs` - バトル初期化
- `Domain/UseCases/UpdateBattleUseCase.cs` - バトル進行の更新処理
- `Domain/UseCases/SummonUserCharacterUseCase.cs` - ユニット召喚
- `Domain/UseCases/SummonSpecialUnitUseCase.cs` - スペシャルユニット召喚
- `Domain/UseCases/UseSpecialAttackUseCase.cs` - 必殺技発動
- `Domain/UseCases/ExecuteRushUseCase.cs` - ラッシュ発動
- `Domain/UseCases/ChangeBattleSpeedUseCase.cs` - バトル速度変更
- `Domain/UseCases/SwitchAutoUseCase.cs` - オート機能切り替え
- `Domain/UseCases/PreVictoryUseCase.cs` - 勝利前処理
- `Domain/UseCases/PreFinishUseCase.cs` - 完了前処理
- `Domain/UseCases/ShowInGameMenuUseCase.cs` - メニュー表示
- `Domain/UseCases/InGameUnitDetailUseCase.cs` - ユニット詳細情報取得

### InitializeViewModelの構造

バトル初期化時に必要なすべてのデータを保持する大規模な構造
- **ステージ情報**: ステージナンバー、ステージ名
- **デッキユニット**: 出撃可能なユニット一覧（DeckUnitViewModelのリスト）
- **マップ情報**: MstPageModel（コマページデータ）
- **拠点情報**: プレイヤー拠点、敵拠点のモデル
- **ラッシュ情報**: プレイヤー、PvP対手のラッシュモデル
- **初期配置ユニット**: 敵側の初期配置ユニット
- **ギミックオブジェクト**: 特殊なステージギミック
- **防御対象**: 防御すべき目標（防御ラッシュなど）
- **バトルポイント**: 現在の戦闘ポイント状態
- **バトル速度**: 初期バトル速度
- **自動戦闘フラグ**: オート機能の初期状態
- **バトルタイプ**: クエスト、PvP、降臨バトルなど
- **クエストタイプ**: スコアラッシュなど特殊タイプ
- **制限時間**: ステージに時間制限がある場合
- **終了条件**: バトルの勝敗判定条件

### DeckUnitViewModelの構造

デッキ内の各ユニット情報を保持
- **ロック状態**: IsDeckComponentLock（操作可否）
- **ユーザーユニットID**: UserDataId（プレイヤーのユニット識別子）
- **キャラクターID**: MasterDataId（マスタデータID）
- **アイコン**: CharacterIconAssetPath（表示用画像パス）
- **必殺技アイコン**: CharacterSpecialAttackIconAssetPath
- **ロールタイプ**: CharacterUnitRoleType（アタッカー、ディフェンダーなど）
- **色（属性）**: CharacterColor
- **レアリティ**: Rarity
- **召喚コスト**: BattlePoint（戦闘ポイント）
- **召喚クールタイム**: TickCount（最大待機時間）
- **残りクールタイム**: TickCount（現在の待機時間）
- **ポイント不足フラグ**: bool
- **召喚済みフラグ**: bool
- **スペシャルユニット召喚可否**: CanSummonAnySpecialUnitFlag
- **必殺技クールタイム**: TickCount（最大待機時間）
- **残り必殺技クールタイム**: TickCount（現在の待機時間）
- **必殺技発動可否**: bool

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **MstStage**<br>ステージマスタ | Id | ステージID |
| | Name | ステージ名 |
| | StageNumber | ステージナンバー |
| | InGameId | ゲーム内イベントID（MstInGameと紐付け） |
| **MstInGame**<br>ゲーム内イベント基本情報 | Id | イベントID |
| | Name | イベント名 |
| | MstPageId | コマページID（MstPageと紐付け） |
| | EventBonusGroupId | イベントボーナスグループID |
| | MstDefenseTargetId | 防御対象ID（防御ラッシュなど） |
| **MstPage**<br>コマページ（グリッドレイアウト） | Id | ページID |
| | PageWidth | ページ幅（コマ数） |
| | KomaLineHeightList | 各行の高さ |
| | TotalWidth | 合計幅 |
| **MstCharacter** (mst_units)<br>キャラクターマスタ | Id | ユニットID |
| | Name | ユニット名 |
| | RoleType | ロールタイプ（アタッカー、ディフェンダーなど） |
| | Color | キャラクターカラー（属性） |
| | Rarity | レアリティ（R, SR, SSR, UR） |
| | AssetKey | キャラクターアセットキー |
| | IconAssetKey | アイコン表示用アセットキー |
| | SpecialAttackIconAssetKey | 必殺技アイコンアセットキー |
| **MstEnemyCharacter**<br>敵キャラクターマスタ | Id | 敵ユニットID |
| | Name | 敵ユニット名 |
| | RoleType | ロールタイプ |
| **MstQuest**<br>クエスト情報 | Id | クエストID |
| | QuestName | クエスト名 |
| | QuestType | クエストタイプ |
| **MstAdventBattle**<br>降臨バトル情報 | Id | 降臨バトルID |
| | Name | ボス名 |
| | BossBGMAssetKey | ボスBGMアセットキー |
| **MstMangaAnimation**<br>漫画アニメーション | Id | アニメーションID |
| | StageId | 対象ステージID |
| | ConditionType | 条件タイプ（Victory, Finish） |
| | AssetKey | アニメーションアセットキー |
| | AnimationSpeed | 再生速度 |
| **MstInGameSpecialRule**<br>ゲーム内特殊ルール | Id | ルールID |
| | Name | ルール名 |
| | SpecialRuleType | ルールタイプ（スコアラッシュなど） |
| **MstInGameSpecialRuleUnitStatus**<br>特殊ルール時ユニットステータス | Id | ID |
| | RuleId | ルールID（MstInGameSpecialRuleと紐付け） |
| | UnitId | ユニットID（MstCharacterと紐付け） |
| | StatusBonus | ステータスボーナス値 |
| **MstStageEndCondition**<br>ステージ終了条件 | Id | 条件ID |
| | ConditionType | 終了条件タイプ |
| **MstConfig**<br>ゲーム設定値 | ConfigKey | 設定キー |
| | ConfigValue | 設定値 |
| **MstDefenseTarget**<br>防御対象設定 | Id | ID |
| | TargetType | 対象タイプ |
| **MstArtwork**<br>原画（イラストボーナス） | Id | 原画ID |
| | BonusHp | HPボーナス値 |
| **MstUnitEncyclopediaEffect**<br>ユニット図鑑エフェクト | Id | ID |
| | UnitId | ユニットID（MstCharacterと紐付け） |
| **MstUserLevel**<br>ユーザーレベル | Level | レベル値 |
| | RequiredExp | 必要経験値 |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserProperty**<br>ユーザー基本情報 | Coin | コイン所持量 |
| | Diamond | ダイヤ所持量 |
| **UserUnit**<br>ユーザーユニット情報 | Id | ユーザーユニットID |
| | UnitId | ユニットID（MstCharacterと紐付け） |
| | Level | ユニットレベル |
| | Experience | 現在経験値 |
| **UserDeck**<br>ユーザーデッキ情報 | DeckNumber | デッキ番号 |
| | UserUnitId | ユニットID（UserUnitと紐付け） |
| | DeckSlotNumber | スロット位置 |
| | IsTwoRowDeck | 2列表示フラグ |
| **UserInGamePreference**<br>インゲーム設定 | BattleSpeed | バトル速度設定 |
| | IsAutoEnabled | オート機能有効フラグ |
| | IsBgmMute | BGMミュートフラグ |
| | IsSeemMute | SEミュートフラグ |
| | IsDamageDisplay | ダメージ表示フラグ |
| | SpecialAttackCutInPlayType | 必殺技カットイン再生タイプ |
| **SpecialAttackCutInLog**<br>必殺技カットイン再生ログ | UnitId | ユニットID |
| | PlayedAt | 再生日時 |

### 呼び出しているAPI（該当する場合）

InGame画面は主にローカルデータを処理するため、画面表示中のAPI呼び出しは限定的です。

#### バトル進行中のAPI呼び出し
- **バトル勝利時**: バトル結果確定時に`POST /api/battle/result`など
  - 用途: バトル結果をサーバーに送信
- **PvP関連**: PvP継続時に`POST /api/pvp/giveup`など
  - 用途: ギブアップ結果をサーバーに送信
- **スタミナ消費**: バトル終了時にスタミナ消費処理
  - 用途: ユーザーリソース更新

#### バトル中のデータ更新
- ほとんどの処理はローカルで完結
- 敵AI、バトルロジック、ユニット召喚などはすべてクライアント側で計算
- サーバーとの通信はバトル開始前のデータ取得と、バトル終了後の結果送信に限定される

