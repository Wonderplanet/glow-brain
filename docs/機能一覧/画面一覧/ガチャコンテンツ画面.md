# ガチャコンテンツ画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガチャコンテンツ画面 |
| **画面番号** | 71-1-1（ガシャトップ） |
| **画面種別** | モーダル画面 |

## 概要

特定のガチャの詳細情報を確認し、実際にガチャを引くための画面です。プレイヤーは、排出されるユニットの確認、ガチャの開催期間や残り時間、必要なコスト、提供割合（確率）などを確認してからガチャを実行できます。

## プレイヤーができること

### ガチャを引く

#### 単発ガチャ
- 1回分のガチャを実行
- ダイヤまたはチケットを消費
- 一部ガチャでは回数制限あり
- コストが不足している場合はボタンがグレーアウト表示される

#### 10連ガチャ
- 10回分のガチャをまとめて実行
- 単発よりもお得な価格設定の場合あり
- 確定枠（特定レアリティ以上が1体確定）が設定されている場合あり
- 回数制限が設定されている場合あり
- コストが不足している場合はボタンがグレーアウト表示される

#### 広告ガチャ（無料）
- 広告視聴後、無料でガチャを引ける
- 1日あたりの実行回数に上限あり
- リセット時間が表示される
- 広告スキップパスを所持している場合、広告視聴をスキップ可能

### 情報を確認する

#### ガチャ基本情報
- **ガチャ名・ロゴ**: どのガチャイベントか
- **開催期間**: ガチャの開始・終了日時
- **残り時間**: 終了までのカウントダウン
- **ガチャ説明**: イベントの概要や特徴

#### 排出ユニット情報
- **排出対象一覧**: このガチャで入手できるユニット
- **ユニット画像**: キャラクターのビジュアル
- **レアリティ**: ユニットのレア度
- **ユニット詳細**: タップでステータスやスキルの詳細を表示
- **必殺技プレビュー**: 必殺技の演出を事前に確認可能

#### ガチャ詳細情報
- **提供割合（確率）**: 各ユニットの排出確率
- **天井情報**: 一定回数引いた際の保証内容
- **ガチャ詳細説明**: 詳しいルールや注意事項
- **特定商取引法に基づく表記**: 法的な記載事項

### その他の操作

- **戻るボタン**: ガチャ一覧画面に戻る
- **ユニット画像タップ**: ユニット詳細モーダルを表示
- **必殺技ボタンタップ**: 必殺技演出のプレビューを表示

## 画面の要素

### ヘッダー部分
- ガチャ名
- ガチャロゴ

### メイン表示エリア
- **開催期間表示**
  - 開催期間
  - 残り時間のカウントダウン
- **ガチャ説明文**
  - イベントの特徴や注目ポイント
- **排出ユニット一覧**
  - ユニットのサムネイル画像
  - ユニット名
  - レアリティ表示
  - タップでユニット詳細へ

### ボタンエリア

#### 単発ガチャボタン
- コスト表示（ダイヤ数またはチケット数）
- コストアイコン
- 回数制限がある場合は残り回数表示
- コスト不足時は不足表示とグレーアウト
- 回数上限到達時はボタン無効化

#### 10連ガチャボタン
- コスト表示（ダイヤ数またはチケット数）
- コストアイコン
- 確定枠の説明（例：「SR以上1体確定」）
- 回数制限がある場合は残り回数表示
- コスト不足時は不足表示とグレーアウト
- 回数上限到達時はボタン無効化

#### 広告ガチャボタン（該当ガチャのみ）
- 「広告を見て引く」などの表記
- 残り回数表示
- リセットまでの時間表示
- 回数上限到達時はボタン無効化

### フッター部分
- **提供割合ボタン**: タップで確率表示ダイアログを開く
- **ガチャ詳細ボタン**: タップで詳細説明ダイアログを開く
- **特定商取引法ボタン**: タップでWebビューを開く
- **天井情報**: 天井が設定されている場合の表示

## 画面遷移

### この画面への遷移
- **ガチャ一覧画面**: 特定のガチャを選択
- **ホーム画面**: ガチャバナーをタップ

### この画面からの遷移
- **ガチャ確認ダイアログ**: 単発/10連ボタンをタップ
  - 実行確認後、ガチャアニメーション画面へ
- **ユニット詳細モーダル**: 排出ユニット画像をタップ
  - ユニットのステータス、スキル、必殺技などを確認
  - 最大ステータス（完凸状態）で表示
- **ガチャ提供割合ダイアログ**: 提供割合ボタンをタップ
  - 各ユニット・アイテムの排出確率を表示
  - アイテムをタップすると詳細情報を表示
- **ガチャ詳細ダイアログ**: ガチャ詳細ボタンをタップ
  - ガチャのルールや注意事項の詳細を表示
- **特定商取引法Webビュー**: 特定商取引法ボタンをタップ
  - 法的な記載事項をWebビューで表示
- **必殺技プレビュー**: 必殺技ボタンをタップ
  - ユニットの必殺技演出をプレビュー再生
  - ヘッダーより前面に表示される
- **ガチャ一覧画面**: 戻るボタンをタップ

## ゲーム仕様・制約事項

### コスト種別
- **ダイヤ**: 課金通貨
  - 不足している場合でもボタンは押せる（タップ時にショップへ誘導）
- **チケット**: ガチャ専用アイテム
  - 不足している場合はボタンがグレーアウトし押せない

### 回数制限
- 一部のガチャには1日あたりまたは期間中の実行回数に上限がある
- 上限に達するとボタンが無効化される
- 残り回数が画面上に表示される

### 開催期間
- 各ガチャには開催期間が設定されている
- 残り時間がリアルタイムでカウントダウン表示される
- 開催期間外は画面にアクセスできない

### 解放条件
- 一部のガチャには解放条件（ユーザーランク、ストーリー進行度など）が設定されている
- 条件を満たしていない場合はアクセスできない

### 天井システム
- ガチャによっては天井（保証システム）が設定されている
- 一定回数引くことで特定のユニットや報酬が確定で入手できる
- 天井までの残り回数が画面上に表示される

### 確定枠
- 10連ガチャには確定枠が設定されている場合がある
- 例：「SR以上1体確定」「SSR確定」など
- 確定枠の内容は10連ガチャボタンの近くに表示される

### 広告ガチャの仕様
- 広告視聴が必要（広告スキップパス所持時は不要）
- 1日あたりの回数制限あり
- リセット時間は日付変更時刻
- 回数制限に達すると次回リセットまで実行不可

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaContent/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaContentPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaContent/Presentation/Presenters/GachaContentPresenter.cs:30)

#### ViewModel
- `Presentation/ViewModels/GachaContentViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaContent/Presentation/ViewModels/GachaContentViewModel.cs:10)
- `Presentation/ViewModels/GachaDisplayUnitViewModel.cs`

#### View
- `Presentation/Views/GachaContentView.cs`
- `Presentation/Views/GachaContentViewController.cs`
- `Presentation/Views/GachaContentPageView.cs`
- `Presentation/Views/IGachaContentViewDelegate.cs`

#### UseCase
- `Domain/UseCases/GachaContentUseCase.cs`
- `Domain/UseCases/GachaDetailDialogUseCase.cs`
- `Domain/UseCases/GachaRatioDialogUseCase.cs`

#### Translator
- `Presentation/Translator/GachaContentTranslator.cs`

### GachaContentViewModelの構造
ガチャ画面全体の情報を保持するデータ構造
- ガチャID、ガチャ名、ガチャタイプ
- 終了日時、残り時間テキスト
- 天井テキスト、ガチャ説明
- ガチャロゴパス、解放条件タイプ
- 単発/10連/広告ガチャそれぞれのコスト情報
- 排出ユニット一覧
- 回数上限到達フラグ

**表示制御ロジック**：ViewModelには以下のようなメソッドが実装され、UI表示を動的に制御
- ボタンの有効/無効判定
- グレーアウト表示の判定
- コスト不足テキストの表示判定
- 回数制限テキストの表示判定
- チケットコストテキストの表示判定

### 画面初期化時の引数
```csharp
GachaContentViewController.Argument(MasterDataId GachaId)
```
表示対象のガチャIDを引数として渡す

### 使用しているマスタデータ

この画面では以下のマスタデータを使用して情報を表示しています。

#### 運営データ（OprData）

##### OprGacha - ガチャ基本情報
ガチャの基本設定を管理するマスタデータ
- **GachaId**: ガチャID
- **GachaName**: ガチャ名
- **GachaType**: ガチャタイプ（フェス、ピックアップ、無料など）
- **EndAt**: 終了日時
- **EnableAdPlay**: 広告ガチャ有効フラグ
- **Description**: ガチャ説明文
- **GachaLogoAssetKey**: ガチャロゴのアセットキー
- **DailyPlayLimitCount**: 1日あたりの実行回数上限
- **TotalPlayLimitCount**: 期間中の実行回数上限
- **RarityThresholdText**: レアリティ天井テキスト（例：「あと○○回でSSR確定」）
- **PickupThresholdText**: ピックアップ天井テキスト（例：「あと○○回でピックアップ確定」）
- **DrawCountThresholdGroupId**: 天井グループID（OprGachaUpperとの紐付け用）
- **GachaFixedPrizeDescription**: 確定枠の説明（例：「SR以上1体確定」）
- **UnlockConditionType**: 解放条件タイプ

##### OprGachaUpper - ガチャ天井情報
天井システム（保証システム）の設定
- **DrawCountThresholdGroupId**: 天井グループID（OprGachaと紐付け）
- **UpperType**: 天井タイプ（`MaxRarity`: レアリティ天井、`Pickup`: ピックアップ天井）
- **GachaThresholdCount**: 天井までの回数

##### OprGachaUseResource - ガチャコスト情報
ガチャ実行に必要なコストの設定
- **GachaId**: ガチャID
- **GachaDrawCount**: 1回分 or 10回分
- **CostType**: コストタイプ（`Diamond`, `PaidDiamond`, `Item`, `Free`, `Ad`など）
- **MstCostId**: アイテムIDなど（CostTypeがItemの場合に使用）
- **CostAmount**: コスト量
- **GachaCostPriority**: 優先度（複数のコスト設定がある場合に使用）

##### OprGachaDisplayUnit - ガチャ表示ユニット情報
ガチャで排出される注目ユニットの表示設定
- **PickupMstUnitId**: 表示するユニットのマスタID（MstCharacterDataと紐付け）
- **GachaDisplayUnitDescription**: 表示説明文（ユニットの特徴など）

#### マスタデータ（MstData）

##### MstCharacterData - キャラクターマスタ
キャラクターの基本情報（OprGachaDisplayUnitから参照）
- **Id**: ユニットID
- **Name**: ユニット名
- **RoleType**: ロールタイプ（アタッカー、ディフェンダーなど）
- **Color**: キャラクターカラー（属性）
- **Rarity**: レアリティ（R, SR, SSR, UR）
- **SeriesAssetKey**: シリーズアセットキー（シリーズロゴ表示用）
- **AssetKey**: キャラクターアセットキー（カットイン画像表示用）

##### MstItemData - アイテムマスタ
チケットなどのアイテム情報（コストがItemの場合に使用）
- **ItemAssetKey**: アイコン表示用のアセットキー

#### ユーザーデータ（GameFetch）

##### UserGacha - ユーザーガチャ実行履歴
プレイヤーのガチャ実行状況
- **OprGachaId**: ガチャID
- **GachaExpireAt**: 個別有効期限（一部ガチャで設定）

##### UserGachaDrawCountThreshold - ユーザー天井カウント
プレイヤーの天井カウント進行状況
- **DrawCountThresholdGroupId**: 天井グループID
- **UpperType**: 天井タイプ（`MaxRarity` or `Pickup`）
- **GachaPlayedCount**: 実行済み回数

##### UserParameter - ユーザーパラメータ
プレイヤーのリソース所持量
- **Coin**: コイン所持量
- **Diamond**: ダイヤ所持量（無償+有償の合計）
- **PaidDiamond**: 有償ダイヤ所持量

##### UserItem - ユーザーアイテム
プレイヤーのアイテム所持状況（チケットなど）
- **MstItemId**: アイテムID
- **Amount**: 所持量

### 呼び出しているAPI

#### ガチャ提供割合ダイアログ表示時
- **GET `/api/gacha/prize`**: ガチャ提供割合取得
  - パラメータ: `oprGachaId` (ガチャID)
  - 用途: 各ユニット・アイテムの排出確率を取得

#### ガチャ詳細ダイアログ表示時
- **GET `/information/index`**: お知らせ一覧取得
  - パラメータ: `now` (現在時刻)
  - 用途: ガチャ詳細のお知らせコンテンツURLを取得
