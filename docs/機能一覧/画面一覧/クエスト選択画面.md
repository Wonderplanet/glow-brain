# QuestSelect画面（クエスト選択画面）

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | QuestSelect（クエスト選択画面） |
| **画面パス** | `Assets/GLOW/Scripts/Runtime/Scenes/QuestSelect/` |
| **Presenter** | `QuestSelectPresenter.cs` |
| **ViewController** | `QuestSelectViewController` |
| **画面種別** | サブ画面（モーダル/オーバーレイ） |

## 概要説明

同一クエストグループ内の難易度別クエストを選択するための画面。難易度（Normal、Hard等）を切り替えてクエストを選択します。

## 主要機能

### クエスト選択機能
- **難易度選択**
  - 難易度ボタンのタップでクエスト切り替え
  - 選択中の難易度のハイライト表示
- **クエスト確定**
  - 選択したクエストの適用
  - 選択クエスト変更時のコールバック実行

### 難易度制御機能
- **開放状態チェック**
  - 難易度の解放状態を判定
  - 未開放難易度の選択時にトースト表示
  - 解放条件テキストの表示
- **難易度開放状態の種類**
  - `Released`: 開放済み（選択可能）
  - `NotRelease`: 未開放（選択不可）

### 初期表示制御
- **初期選択クエストの設定**
  - 引数で指定されたクエストを初期選択状態で表示
  - 指定がない場合はデフォルトの難易度を選択

## UI構成要素

### QuestSelectViewModel
- **現在のインデックス** (CurrentIndex): 選択中のクエストインデックス
- **クエスト一覧** (Items): クエスト選択コンテンツのリスト

### QuestSelectContentUseCaseModel
- グループクエストID (GroupId)
- クエスト名
- 難易度情報一覧 (DifficultyItems)

### QuestSelectDifficultyUseCaseModel
- マスタークエストID (MstQuestId)
- 難易度 (Difficulty)
- 難易度開放状態 (DifficultyOpenStatus)
  - `Released`: 開放済み
  - `NotRelease`: 未開放
- 解放条件文言 (ReleaseRequiredSentence)

### QuestDifficultyItemViewModel
- 難易度 (Difficulty)
- 難易度ボタン表示情報
- 難易度テキスト
- 難易度スプライト

## 画面遷移

### 遷移元
- ホーム画面のステージ選択
- クエスト関連画面

### 遷移先
- クエスト選択後、前の画面に戻る
  - 選択クエストが変更された場合、コールバック実行

## 関連ファイル

### Presenter
- `Presentation/QuestSelectPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/QuestSelect/Presentation/QuestSelectPresenter.cs:15): メインPresenter

### ViewModel
- `Presentation/QuestSelectViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/QuestSelect/Presentation/QuestSelectViewModel.cs:6): メインViewModel
- `Presentation/QuestSelectContentViewModel.cs`: コンテンツViewModel
- `Presentation/QuestDifficultySelect/QuestDifficultyItemViewModel.cs`: 難易度アイテムViewModel

### UseCase
- `Domain/QuestSelectUseCase.cs`: クエスト選択UseCase
- `Domain/SelectQuestUseCase.cs`: クエスト選択適用UseCase

### Translator
- `Presentation/QuestSelectViewModelTranslator.cs`: ViewModelトランスレータ

### その他
- `Presentation/IQuestSelectViewDelegate.cs`: Viewデリゲート
- `Presentation/QuestUnlockRequirementDescription.cs`: 解放条件説明

## 実装詳細

### 主要メソッド

#### IQuestSelectViewDelegate.OnViewDidLoad()
画面読み込み時の初期化処理
- UseCaseからクエスト選択モデルを取得
- ViewModelに変換
- ViewControllerを初期化

#### IQuestSelectViewDelegate.OnDifficultySelected(MasterDataId mstGroupQuestId, Difficulty difficulty)
難易度選択時の処理
- 選択された難易度の開放状態をチェック
- 未開放の場合はトースト表示とエラー音再生
- 開放済みの場合は難易度を切り替え、選択音を再生

#### IQuestSelectViewDelegate.ApplySelectedQuest(MasterDataId mstQuestId)
選択クエスト適用処理
- 選択されたクエストが開放されているかチェック
- 未開放の場合は何もせず画面を閉じる
- 開放済みの場合はSelectQuestUseCaseでクエストを選択
- 画面を閉じる
- クエストが変更された場合、Argumentのコールバックを実行

#### GetDifficultyModel(MasterDataId mstQuestGroupId, Difficulty difficulty)
難易度モデル取得（グループIDと難易度から）
- クエストグループIDと難易度から該当する難易度モデルを取得
- 見つからない場合はEmptyを返す

#### GetDifficultyModel(MasterDataId mstQuestId)
難易度モデル取得（クエストIDから）
- クエストIDから該当する難易度モデルを取得
- 見つからない場合はEmptyを返す

### Argument

```csharp
QuestSelectViewController.Argument(
    MasterDataId InitialSelectedQuestId,
    Action StageSelected
)
```

- `InitialSelectedQuestId`: 初期選択するクエストID
- `StageSelected`: クエスト選択変更時に実行されるコールバック

## サウンド効果

- **選択成功時**: `SSE_000_002` - 難易度切り替え時
- **選択失敗時**: `SSE_000_013` - 未開放難易度選択時

## 備考

- Zenjectによる依存性注入を使用
- MVPパターンでPresenterがViewとUseCaseを仲介
- LINQ（FirstOrDefault、SelectMany）を使用してモデル検索
- 開放状態のチェックにより未開放コンテンツへのアクセスを制御
- トースト表示により解放条件をユーザーに通知
- コールバック機構により選択変更を呼び出し元に通知

## 更新履歴

| 日付 | 更新内容 |
|------|----------|
| 2025-12-23 | 初版作成 |
