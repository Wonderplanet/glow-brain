# ガシャコスト素材詳細表示

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | ガシャコスト素材詳細表示 |
| **画面番号** | 81-3-6 |
| **画面種別** | モーダル画面 |

## 概要

ガシャに使用できるチケットやコストアイテムの詳細情報を表示するモーダル画面です。プレイヤーはアイテムの説明、現在の所持数を確認でき、そのチケットが使用できるガシャが開催中の場合は、ワンタップでガシャ画面に遷移できます。

アイテムボックスからチケットをタップした際に表示され、ガシャの開催状況に応じて画面の内容が変化します。

## プレイヤーができること

### アイテム情報の確認

#### 基本情報の表示
- チケット/コストアイテムのアイコン
- アイテム名称
- 現在の所持数
- アイテムの説明文

### ガシャへの遷移

#### ガシャ画面へ移動（開催中の場合）
- 「ガシャへ」ボタンをタップすると、ホーム画面のガシャタブに遷移
- 遷移後、そのチケットが使用できるガシャが表示される
- 開催期間中のみボタンが有効化される

#### 開催期間外の表示
- ガシャ開催期間外の場合、「ガシャへ」ボタンがグレーアウト表示
- グレーアウト時にボタンをタップすると「ガシャ開催期間外です」というトーストメッセージが表示される

### 画面の閉じる
- 閉じるボタンをタップして画面を閉じる

## 画面の要素

### ヘッダー部分
- 閉じるボタン（✕）

### メイン表示エリア
- **アイテムアイコン**: チケット/コストアイテムの画像
- **アイテム名**: アイテムの名称
- **所持数**: 現在プレイヤーが所持している数量
- **説明文**: アイテムの用途や入手方法の説明

### ボタンエリア
- **ガシャへボタン**: ガシャ画面に遷移するボタン
  - 開催中: 通常表示、タップでホーム画面のガシャタブに遷移
  - 開催期間外: グレーアウト表示、タップで期間外メッセージを表示

## 画面遷移

### この画面への遷移
- **アイテムボックス画面（ItemBox）**: ガシャチケットをタップ
- **アイテム詳細表示画面（ItemDetail）**: ItemDetailWireFrame経由で呼び出し

### この画面からの遷移
- **ホーム画面（Home）**: 「ガシャへ」ボタンをタップ
  - ガシャタブが自動選択される
  - 該当するチケットが使用できるガシャが表示される

## ゲーム仕様・制約事項

### ガシャ開催状態の判定
- 現在時刻を基準に、開催中のガシャを判定
- チケットがコストとして使用できるガシャの中に、開催中のものがあるか確認
- 開催中のガシャが存在する場合のみ、「ガシャへ」ボタンが有効化される

### 遷移エリアの表示制御
- 画面初期化時に`ShowTransitAreaFlag`パラメータで遷移エリアの表示可否を制御
- `ShowTransitAreaFlag.False`の場合、遷移ボタンエリアが非表示になる
- アイテム詳細画面から呼び出す際に、遷移機能の有無を制御できる

### ボタンのグレーアウト条件
以下のいずれかに該当する場合、「ガシャへ」ボタンがグレーアウト表示される：
1. 遷移エリアが非表示設定（`ShowTransitAreaFlag.False`）
2. そのチケットが使用できるガシャが現在開催されていない

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/GachaCostItemDetailView/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/GachaCostItemDetailPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaCostItemDetailView/Presentation/Presenters/GachaCostItemDetailPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/GachaCostItemDetailViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaCostItemDetailView/Presentation/ViewModels/GachaCostItemDetailViewModel.cs)

#### View
- `Presentation/Views/GachaCostItemDetailViewController.cs`
- `Presentation/Views/GachaCostItemDetailView.cs`

#### UseCase
- `Domain/UseCases/GachaCostItemDetailUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaCostItemDetailView/Domain/UseCases/GachaCostItemDetailUseCase.cs)

#### Translator
- `Presentation/Translator/GachaCostItemDetailTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/GachaCostItemDetailView/Presentation/Translator/GachaCostItemDetailTranslator.cs)

#### Model
- `Domain/Models/GachaCostItemDetailUseCaseModel.cs`

#### ValueObject
- `Domain/ValueObject/TransitionButtonGrayOutFlag.cs`
- `Scenes/ItemDetail/Presentation/Views/ShowTransitAreaFlag.cs` (共通)

### GachaCostItemDetailViewModelの構造
画面に表示するデータを保持するViewModel：
- **IconViewModel**: アイテムのアイコン表示情報（`PlayerResourceIconViewModel`）
- **Name**: アイテム名（`PlayerResourceName`）
- **Description**: アイテムの説明文（`PlayerResourceDescription`）
- **IsTransitionButtonGrayOut**: 遷移ボタンのグレーアウト状態（`TransitionButtonGrayOutFlag`）
- **IsTransitAreaVisible**: 遷移エリアの表示/非表示（`ShowTransitAreaFlag`）

**表示制御ロジック**：
- アイコンには所持数も含まれる（`IconViewModel.Amount`）
- 遷移ボタンは`IsTransitionButtonGrayOut`と`IsTransitAreaVisible`の両方で制御

### 画面初期化時の引数
```csharp
GachaCostItemDetailViewController.Argument(
    MasterDataId MstCostId,            // コストアイテムのマスターデータID
    ShowTransitAreaFlag ShowTransitAreaFlag // 遷移エリアの表示フラグ
)
```

### ガシャ開催状態の判定ロジック
`GachaCostItemDetailUseCase`で以下の手順で判定：
1. 現在時刻を取得（`TimeProvider.Now`）
2. 開催中のガシャ一覧を取得（`OprGachaRepository.GetOprGachaModelsByDataTime`）
3. コストアイテムIDから使用可能なガシャIDを取得（`OprGachaUseResourceRepository.GetOprGachaUseResourceModelsByItemId`）
4. 使用可能なガシャIDと開催中のガシャIDを照合
5. 一致するものがあれば遷移ボタンを有効化、なければグレーアウト

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **OprGacha**<br>ガチャ基本情報 | GachaId | ガチャID |
| | StartAt | ガチャ開始日時 |
| | EndAt | ガチャ終了日時 |
| **OprGachaUseResource**<br>ガチャコスト情報 | OprGachaId | ガチャID |
| | MstCostId | コストアイテムのマスタID |
| **MstItem**<br>アイテムマスタ | Id | アイテムID |
| | ItemName | アイテム名 |
| | ItemAssetKey | アイコン表示用のアセットキー |
| | Description | アイテムの説明文 |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserItem**<br>ユーザーアイテム | MstItemId | アイテムID |
| | Amount | 所持量 |

### 呼び出しているAPI
なし（Repositoryからのデータ取得のみ）
