# 降臨バトルランキング結果画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルランキング結果表示ダイアログ |
| **画面番号** | 44-4-3 |
| **画面種別** | モーダル画面（ダイアログ） |

## 概要

降臨バトルのランキング期間終了後、プレイヤーのランキング結果と獲得した報酬を表示する画面です。ホーム画面表示時に自動的に表示され、前回の降臨バトルでの順位、スコア、達成したランク（ブロンズ～ダイヤモンド）、そして獲得した報酬を演出付きで確認できます。

この画面は特定条件を満たした場合のみ表示されます：
- 降臨バトル終了後、集計時間を考慮した期間内
- まだアニメーションを再生していない降臨バトル
- 30日以内に終了した降臨バトル
- プレイヤーがランキングに参加していた場合

## プレイヤーができること

### ランキング結果の確認

#### ランキング情報の表示
- 降臨バトルのタイトル名を確認
- 自分の順位を確認（1位、2位、3位、またはランク外）
- 達成したスコアランク（ブロンズ、シルバー、ゴールド、プラチナ、ダイヤモンド）とランクレベルを確認
- 獲得したスコアを確認

#### ランクアニメーション
- 画面表示時、順位に応じた演出アニメーションが自動再生される
  - 1位〜3位：特別な演出
  - ランク未参加：専用演出
  - 通常ランク：標準演出

#### 報酬の確認
- ランクアニメーション終了後、獲得した報酬アイテムがアニメーション付きで表示される
- 報酬アイテムのアイコンと個数を確認可能

### 画面を閉じる

#### 閉じる操作
- すべてのアニメーション再生完了後、「タップで閉じる」テキストとボタンが表示される
- 閉じるボタンをタップして画面を閉じる
- ESCキー（バックキー）でも閉じることができる

#### アニメーション再生中の制約
- アニメーション再生中にESCキー（バックキー）を押すと、無効な操作メッセージが表示される
- アニメーションが完全に終了するまで画面を閉じることはできない

## 画面の要素

### ヘッダー部分
- 降臨バトルのタイトル名

### メイン表示エリア
- **ランクアイコン**: ランクタイプ（ブロンズ〜ダイヤモンド）を表すアイコン
  - ランクレベルに応じたティアアニメーション付き
- **順位テキスト**: プレイヤーの順位（1位、2位、3位、またはランク外の場合の順位）
- **ランクテキスト**: ランクタイプ名とランクレベルを組み合わせた表示
- **スコアテキスト**: 達成したスコア

### 報酬表示エリア
- 獲得した報酬アイテムのアイコンリスト
- 各アイテムのアイコンと個数
- アニメーション付きで1つずつ表示

### フッター部分
- **タップで閉じるラベル**: アニメーション完了後に表示
- **閉じるボタン**: アニメーション完了後に表示され、タップ可能になる

## 画面遷移

### この画面への遷移
- **ホーム画面**: ホーム画面表示時に自動的に表示される（HomeAppearanceActionの仕組み）
  - 降臨バトル終了後、集計時間を考慮した期間内
  - まだアニメーションを再生していない降臨バトルがある場合
  - 30日以内に終了した降臨バトル
  - ランキング対象の降臨バトル（スコアチャレンジタイプ）

### この画面からの遷移
- **ホーム画面**: 閉じるボタンまたはESCキーで元のホーム画面に戻る
  - 画面を閉じた際、コールバックが実行されホーム画面の表示処理が継続される

## ゲーム仕様・制約事項

### 表示条件

#### 降臨バトル終了判定
- 降臨バトルの終了日時 + 集計時間（デフォルト12時間、`MstConfig.AdventBattleRankingAggregateHours`で変更可能）を経過した降臨バトルが対象
- 集計時間はランキング集計のための猶予期間

#### 再生済み判定
- 一度アニメーションを再生した降臨バトルIDは`PreferenceRepository`にローカル保存される
- 同じ降臨バトルのランキング結果アニメーションは1回のみ再生される

#### 期間制限
- 降臨バトル終了から30日以上経過した場合は表示されない
- これにより、長期間ログインしていなかったプレイヤーに古い結果が表示されることを防ぐ

#### ランキング参加判定
- ランキングに参加していない場合（ランクがゼロ）は表示されない
- スコアチャレンジタイプの降臨バトルのみ表示（レイドタイプは別画面）

### アニメーション仕様

#### ランクアニメーション
- 順位に応じてアニメーションパターンが変化：
  - `順位 = 0`: アニメーション値 4（ランク未参加）
  - `順位 = 1`: アニメーション値 1（1位専用演出）
  - `順位 = 2`: アニメーション値 2（2位専用演出）
  - `順位 = 3`: アニメーション値 3（3位専用演出）
  - `順位 >= 4`: アニメーション値 0（通常ランク演出）
- アニメーターの"RankingResultPanel@Loop"ステートに到達するまで待機

#### 報酬アイテムアニメーション
- ランクアニメーション完了後、自動的に再生
- アイテムアイコンが1つずつアニメーション付きで表示される
- すべてのアイテム表示完了まで待機

#### タップガード
- アニメーション再生中は画面全体のタップが無効化される
- アニメーション完了後、自動的にタップガードが解除される

### 報酬の決定ロジック

#### ランキング報酬の取得
- `MstAdventBattleRewardGroup`から報酬グループを取得
- 報酬カテゴリが「Ranking」のものを抽出
- プレイヤーの順位以上で、最も条件が近い報酬グループを選択
  - 例：順位が15位の場合、「11位〜20位」の報酬グループが適用される

#### スコアランクの決定
- `MstAdventBattleScoreRank`からスコアランクを取得
- プレイヤーのスコア以下で、最も高い必要スコアのランクを選択
  - 例：スコア12000の場合、必要スコア10000のゴールドランクが適用される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleRankingResultPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Presenters/AdventBattleRankingResultPresenter.cs)

#### ViewModel
- `Presentation/ViewModels/AdventBattleRankingResultViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/ViewModels/AdventBattleRankingResultViewModel.cs)

#### View
- `Presentation/Views/AdventBattleRankingResultView.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Views/AdventBattleRankingResultView.cs)
- `Presentation/Views/AdventBattleRankingResultViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Views/AdventBattleRankingResultViewController.cs)

#### UseCase
- `Domain/UseCases/AdventBattleRankingResultUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Domain/UseCases/AdventBattleRankingResultUseCase.cs)

#### Translator
- `Presentation/Translators/AdventBattleRankingResultViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Presentation/Translators/AdventBattleRankingResultViewModelTranslator.cs)

#### ModelFactory
- `Domain/ModelFactories/AdventBattleRankingResultModelFactory.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRankingResult/Domain/ModelFactories/AdventBattleRankingResultModelFactory.cs)

#### HomeAppearanceAction
- `Scenes/Home/Presentation/Presenters/HomeAppearanceAction/Actions/AdventBattleRankingResultAction.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/Home/Presentation/Presenters/HomeAppearanceAction/Actions/AdventBattleRankingResultAction.cs)

### AdventBattleRankingResultViewModelの構造

画面に表示するランキング結果のデータ構造：

- **RankType**: ランクタイプ（Bronze, Silver, Gold, Platinum, Diamond）
- **RankLevel**: ランクレベル（ランク内での段階、例：ゴールドⅢ）
- **Rank**: プレイヤーの順位
- **Score**: 達成したスコア
- **RewardList**: 獲得報酬アイテムのリスト（PlayerResourceIconViewModel）
- **AdventBattleType**: 降臨バトルタイプ（ScoreChallengeまたはRaid）
- **EnemyImageAssetPath**: 敵ユニットの画像アセットパス（降臨バトル識別用）
- **AdventBattleName**: 降臨バトル名

### 画面初期化時の引数

```csharp
AdventBattleRankingResultViewController.Argument(
    AdventBattleRankingResultViewModel AdventBattleRankingResultViewModel,
    Action OnCloseView
)
```

- **AdventBattleRankingResultViewModel**: 表示するランキング結果データ
- **OnCloseView**: 画面を閉じた際に呼ばれるコールバック

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID |
| MstAdventBattle.EndDateTime | mst_advent_battles.end_at | 降臨バトル終了日時（集計判定に使用） |
| MstAdventBattle.BattleType | mst_advent_battles.battle_type | バトルタイプ（スコアチャレンジ/レイド判定） |
| MstAdventBattle.DisplayEnemyUnitIdFirst | mst_advent_battles.display_enemy_unit_id_first | 表示する敵ユニットID（画面識別用） |
| MstAdventBattle.AdventBattleName | mst_advent_battles.advent_battle_name | 降臨バトル名 |
| MstAdventBattleScoreRank.Id | mst_advent_battle_score_ranks.id | スコアランクID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_score_ranks.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_score_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold/Platinum/Diamond） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_score_ranks.score_rank_level | ランクレベル（Ⅰ〜Ⅴ） |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_score_ranks.required_lower_score | 必要最低スコア |
| MstAdventBattleRewardGroup.Id | mst_advent_battle_reward_groups.id | 報酬グループID |
| MstAdventBattleRewardGroup.MstAdventBattleId | mst_advent_battle_reward_groups.mst_advent_battle_id | 降臨バトルID |
| MstAdventBattleRewardGroup.RewardCategory | mst_advent_battle_reward_groups.reward_category | 報酬カテゴリ（Ranking/Rank/Clear） |
| MstAdventBattleRewardGroup.RewardCondition | mst_advent_battle_reward_groups.reward_condition | 報酬条件（順位閾値） |
| MstAdventBattleReward.Id | mst_advent_battle_rewards.id | 報酬ID |
| MstAdventBattleReward.MstAdventBattleRewardGroupId | mst_advent_battle_rewards.mst_advent_battle_reward_group_id | 報酬グループID |
| MstAdventBattleReward.ResourceType | mst_advent_battle_rewards.resource_type | リソースタイプ（Character/Item/Coin/Diamond等） |
| MstAdventBattleReward.ResourceId | mst_advent_battle_rewards.resource_id | リソースID（アイテムID等） |
| MstAdventBattleReward.ResourceAmount | mst_advent_battle_rewards.resource_amount | 報酬数量 |
| MstEnemyCharacter.AssetKey | mst_enemy_characters.asset_key | 敵ユニット画像アセットキー |
| MstConfig.Key | mst_configs.key | 設定キー（AdventBattleRankingAggregateHours） |
| MstConfig.Value | mst_configs.value | 設定値（集計時間） |

#### Preferenceデータ（ローカル保存）

| クライアント定義 | 説明 |
|----------------|------|
| PreferenceRepository.AdventBattleRankingResultAnimationPlayedId | アニメーション再生済み降臨バトルID（重複再生防止） |

### 呼び出しているAPI

#### ホーム画面表示時（HomeAppearanceAction）
- **GET `/api/advent_battle/info`**: AdventBattleInfo取得
  - パラメータ: なし
  - 用途: 前回参加した降臨バトルのランキング情報とスコア情報を取得

### データ取得とロジック

#### 表示対象の降臨バトル特定ロジック

1. **集計時間の取得**:
   - `MstConfig.AdventBattleRankingAggregateHours`から集計時間を取得（デフォルト12時間）
   - 現在時刻から集計時間を引いた時刻を算出

2. **最後に終了した降臨バトルの特定**:
   - すべての降臨バトルから、終了日時が集計考慮時刻以下で最も新しいものを選択
   - 該当がない場合は表示しない

3. **再生済み判定**:
   - ローカル保存された再生済みIDと一致する場合は表示しない

4. **期間判定**:
   - 降臨バトル終了から30日以上経過している場合は表示しない

5. **API呼び出し**:
   - `/api/advent_battle/info`を呼び出してランキング結果を取得

6. **再生済みフラグ保存**:
   - アニメーション再生前に、ローカルに降臨バトルIDを保存

#### スコアランク決定ロジック

- プレイヤーのトータルスコア以下で、最も高い必要スコアのランクを選択
- OrderBy → Where → LastOrDefaultで最適なランクを取得

#### ランキング報酬決定ロジック

- 報酬カテゴリが「Ranking」のものから、プレイヤーの順位以上で最も条件が近い報酬グループを選択
- MinByAboveOrEqualLowerLimitで最適な報酬グループを取得

---

**最終更新**: 2025-12-24
