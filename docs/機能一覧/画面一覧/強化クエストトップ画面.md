# 強化クエストトップ画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 強化クエストトップ画面 |
| **画面番号** | 45_強化クエスト / 42-5_1日N回強化クエスト / 42-5-2_1日N回コイン獲得クエストTOP画面 |
| **画面種別** | メイン画面 |

## 概要

プレイヤーが強化クエスト（コイン獲得クエスト）に挑戦するための画面です。この画面では、現在のハイスコアや次のランク報酬の条件、本日の挑戦可能回数などを確認してから、クエストへの挑戦を開始できます。また、パーティ編成やボーナスユニット情報の確認もこの画面から行えます。

## プレイヤーができること

### クエストに挑戦する

#### 通常挑戦
- 本日分の挑戦可能回数を消費してクエストを実行
- スタミナを1消費して開始
- 挑戦回数に達した場合はボタンがグレーアウト表示される

#### 広告視聴による挑戦
- 広告を視聴して無料でクエストを実行（追加で実行可能）
- スタミナを1消費して開始
- 広告スキップパスを所持している場合、広告視聴をスキップ可能
- 広告視聴での挑戦可能回数に達した場合はボタンがグレーアウト表示される

### 画面情報の確認

#### ハイスコアと次の報酬条件
- **現在のハイスコア**: これまでの最高スコア
- **次のランク報酬**: 次に獲得できるランク報酬と必要スコア
- **報酬内容**: ランク達成時に獲得できるコイン量

#### 挑戦回数の確認
- **本日の挑戦可能回数**: 通常挑戦の残り回数
- **広告視聴での挑戦可能回数**: 広告経由での残り回数

#### パーティボーナス情報
- **現在のパーティ名**: 編成中のパーティ名
- **総ボーナス率**: 編成メンバーのボーナス合計（ボーナスユニットを編成している場合）

### パーティ編成・ボーナス確認

#### パーティ編成ボタン
- パーティ編成画面へ遷移
- ボーナスユニットを含めた編成が可能
- 編成後は画面に反映される

#### ボーナスユニット確認ボタン
- このクエストで有効なボーナスユニット一覧を表示
- ボーナスユニットの詳細情報や効果を確認可能

### その他の操作

#### 情報ボタン
- スコアランク詳細画面へ遷移
- ランク報酬の詳細情報を確認

#### ヘルプボタン
- 機能説明のチュートリアルダイアログを表示

#### 戻るボタン
- ホーム画面に戻る

## 画面の要素

### ヘッダー部分
- ハイスコア表示
- 次のランク報酬条件（スコア）
- 次のランク報酬内容（コイン量）

### メイン表示エリア

#### スコア情報セクション
- 現在のハイスコア
- 次の報酬獲得までに必要なスコア
- 次の報酬内容

#### パーティ情報セクション
- 現在のパーティ名
- 総ボーナス率（%表示）
- パーティ編成ボタン
- ボーナスユニット確認ボタン

#### キャンペーン情報セクション
- 開催中のキャンペーン表示
- 実施中のボーナスキャンペーンの詳細

### ボタンエリア

#### 通常挑戦ボタン
- クエスト開始ボタン
- 本日の残り挑戦回数を表示（例：「挑戦 5/10」）
- 挑戦回数が0の場合、ボタンがグレーアウト表示され「本日分のコイン獲得クエストへの挑戦可能回数が0回となりましたので挑戦できません。」というメッセージが表示される

#### 広告視聴挑戦ボタン
- 広告を視聴してから挑戦
- 広告スキップパスの所持状況に応じた表示切り替え
- 広告視聴での残り回数を表示
- 広告視聴での回数が0の場合、通常挑戦と同じメッセージが表示される

### フッター部分
- 戻るボタン
- 情報ボタン（スコア詳細へ）
- ヘルプボタン

## 画面遷移

### この画面への遷移
- **ホーム画面**: メニューから「強化クエスト」を選択

### この画面からの遷移
- **ゲーム内画面**: 「挑戦」ボタンをタップすると、強化クエストのステージが開始
  - 遷移後、クエスト実行となり、クリア時にハイスコアと報酬が更新される
  - 画面に戻ると、スコア情報が最新の状態に自動更新される

- **パーティ編成画面**: 「パーティ編成」ボタンをタップ
  - 編成後に戻ると、パーティ名とボーナス率が更新される

- **ボーナスユニット一覧画面**: 「ボーナスユニット」ボタンをタップ
  - このクエストで有効なボーナスユニットをモーダルで表示

- **スコア詳細画面**: 「情報」ボタンをタップ
  - ランク報酬の詳細情報を確認

- **チュートリアルダイアログ**: 「ヘルプ」ボタンをタップ、または初回遷移時に自動表示
  - 機能説明を確認

- **ホーム画面**: 「戻る」ボタンをタップ
  - 画面を閉じてホーム画面に戻る

## ゲーム仕様・制約事項

### 挑戦回数の管理

#### 通常挑戦
- **1日の上限**: マスタデータ`MstConfig.EnhanceQuestChallengeLimit`で設定
- **キャンペーン時の増加**: キャンペーン設定により上限を追加可能
- **リセット**: 毎日決められた時刻に自動リセット
- **ユーザーデータ**: `UserStageEnhance.ResetChallengeCount`で実行済み回数を管理

#### 広告視聴による挑戦
- **1日の上限**: マスタデータ`MstConfig.EnhanceQuestChallengeAdLimit`で設定
- **広告スキップパス**: 所持している場合、広告視聴をスキップ可能
- **リセット**: 毎日決められた時刻に自動リセット
- **ユーザーデータ**: `UserStageEnhance.ResetAdChallengeCount`で実行済み回数を管理

### ハイスコアと報酬

#### ハイスコア管理
- **初回クエスト実行時**: スコア0として記録開始
- **スコア更新**: クエスト実行後、より高いスコアを記録した場合に更新
- **ランク報酬**: スコアが設定した閾値に到達した場合に獲得

#### スコアランク報酬
- **報酬テーブル**: `MstStageEnhanceRewardParam`で各スコア閾値の報酬を管理
- **報酬内容**: コイン
- **次の報酬**: 次に到達できるスコア閾値と報酬内容を画面に表示

### パーティボーナス

#### ボーナスユニット
- **対象期間**: `MstQuestBonusUnit`の`StartAt`～`EndAt`で有効期間を管理
- **ボーナス計算**: 編成されたパーティメンバーがボーナス対象の場合、そのボーナス率を合計
- **パーティ単位**: パーティごとにボーナス率が異なる
- **表示更新**: パーティ編成画面から戻った時に自動更新

#### イベントボーナス
- **スケジュール**: `MstQuestEventBonusSchedule`で有効期間を管理
- **複数スケジュール対応**: 複数のスケジュールが重複している場合は、最新のスケジュールのボーナスを適用
- **ボーナスグループ**: `EventBonusGroupId`を通じて、ボーナス対象ユニットと紐付け

### チュートリアル

#### 初回表示
- **対象**: このクエスト画面への初回遷移時
- **チュートリアルID**: `TutorialFreePartIdDefinitions.TransitEnhanceQuest`
- **動作**: チュートリアルダイアログを自動表示
- **完了**: ダイアログを閉じた後、チュートリアル完了フラグが記録される

### ローカル通知

#### スケジュール管理
- **リセット時刻通知**: クエスト実行後、次のリセット時刻の通知がスケジュールされる
- **スケジュール関数**: `LocalNotificationScheduler.RefreshRemainCoinQuestSchedule()`で管理

## 技術参考情報

### 画面実装パス
`Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestTop/`

### 主要コンポーネント

#### Presenter
`Presentation/Presenters/EnhanceQuestTopPresenter.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestTop/Presentation/Presenters/EnhanceQuestTopPresenter.cs)

**主要メソッド**:
- `OnViewDidLoad()`: 画面初期化時に呼び出され、データを取得してViewModelに変換して表示
- `OnViewWillAppear()`: 画面表示時に呼び出され、パーティ情報とボーナス率を更新
- `OnEnhanceQuestButtonTapped()`: 通常挑戦ボタンをタップした時の処理
- `OnAdChallengeButtonTapped()`: 広告視聴挑戦ボタンをタップした時の処理
- `OnPartyFormationButtonTapped()`: パーティ編成ボタンをタップした時の処理
- `OnBonusUnitButtonTapped()`: ボーナスユニット確認ボタンをタップした時の処理
- `OnBackButtonTapped()`: 戻るボタンをタップした時の処理
- `OnInfoButtonTapped()`: 情報ボタンをタップした時の処理
- `OnHelpButtonTapped()`: ヘルプボタンをタップした時の処理
- `ShowTutorialDialogIfNeed()`: チュートリアル表示の判定と表示処理

#### ViewController
`Presentation/Views/EnhanceQuestTopViewController.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestTop/Presentation/Views/EnhanceQuestTopViewController.cs)

**主要メソッド**:
- `Setup(viewModel)`: 初期表示時のViewModelをセット
- `UpdateTopView(viewModel)`: パーティ名とボーナス率を更新

#### ViewModel
`Presentation/ViewModels/EnhanceQuestTopViewModel.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestTop/Presentation/ViewModels/EnhanceQuestTopViewModel.cs)

**プロパティ**:
- `HighScore`: 現在のハイスコア
- `NextThresholdScore`: 次のランク報酬の必要スコア
- `NextThresholdRewardAmount`: 次のランク報酬内容（コイン量）
- `ChallengeCount`: 本日の通常挑戦可能回数
- `AdChallengeCount`: 本日の広告視聴挑戦可能回数
- `TotalBonusPercentage`: パーティの総ボーナス率
- `PartyName`: 現在のパーティ名
- `HeldAdSkipPassInfoViewModel`: 所持している広告スキップパス情報
- `CampaignViewModels`: 実施中のキャンペーン一覧

#### UseCase
`Domain/UseCases/EnhanceQuestTopUseCase.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestTop/Domain/UseCases/EnhanceQuestTopUseCase.cs)

**主要メソッド**:
- `GetEnhanceQuestTop()`: 画面表示に必要なすべてのデータを取得して`EnhanceQuestTopModel`を返す

**処理内容**:
1. ユーザーのステージ強化データを取得（`UserStageEnhance`）
2. 現在の強化クエスト情報を取得
3. パーティ情報とボーナス計算を実行
4. 挑戦回数を計算（マスタ設定からキャンペーン効果を反映）
5. ハイスコアと次のランク報酬条件を取得
6. イベントボーナスの有効期限をチェック
7. 広告スキップパス情報を取得

#### Translator
`Presentation/Translators/UpdatedEnhanceQuestTopViewModelTranslator.cs` (projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/EnhanceQuestTop/Presentation/Translators/UpdatedEnhanceQuestTopViewModelTranslator.cs)

**役割**:
- `UpdateEnhanceQuestTopUseCaseModel`を`UpdatedEnhanceQuestTopViewModel`に変換
- パーティ名とボーナス率のみを更新する際に使用

### Modelの構造

#### EnhanceQuestTopModel
`Domain/Models/EnhanceQuestTopModel.cs`

**プロパティ**:
- `MstStageId`: ステージID
- `MstQuestId`: クエストID
- `HighScore`: 現在のハイスコア（`EnhanceQuestScore`）
- `NextThresholdScore`: 次のランク報酬の必要スコア（`EnhanceQuestMinThresholdScore`）
- `NextThresholdRewardAmount`: 次のランク報酬（コイン量）（`ItemAmount`）
- `ChallengeCount`: 本日の通常挑戦可能回数（`EnhanceQuestChallengeCount`）
- `AdChallengeCount`: 本日の広告視聴挑戦可能回数（`EnhanceQuestChallengeCount`）
- `TotalBonusPercentage`: パーティの総ボーナス率（`EventBonusPercentage`）
- `PartyName`: 現在のパーティ名（`PartyName`）
- `EventBonusGroupId`: イベントボーナスグループID（`EventBonusGroupId`）
- `HeldAdSkipPassInfoModel`: 所持している広告スキップパス情報
- `CampaignModels`: 実施中のキャンペーン一覧

#### UpdatedEnhanceQuestTopViewModel
`Presentation/ViewModels/UpdatedEnhanceQuestTopViewModel.cs`

**プロパティ**:
- `PartyName`: 現在のパーティ名
- `TotalBonusPercentage`: パーティの総ボーナス率

### Factory

#### EnhanceQuestModelFactory
`Domain/Factories/EnhanceQuestModelFactory.cs`

**役割**:
- 現在の強化クエスト情報（`EnhanceQuestModel`）を取得
- ユーザーのステージ強化データから対象ステージを特定、または初回実行時は最初のステージを取得
- 関連するマスタデータを組み立てる

#### QuestPartyModelFactory
`Domain/Factories/QuestPartyModelFactory.cs`

**役割**:
- パーティのボーナス率を計算
- ボーナスユニット対象期間をチェック
- 編成メンバーとボーナスユニットを紐付けて合計ボーナス率を算出

### 使用しているマスタデータ

#### マスタデータ

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **MstConfig**<br>ゲーム設定マスタ | EnhanceQuestChallengeLimit | 強化クエストの1日あたりの通常挑戦上限回数 |
| | EnhanceQuestChallengeAdLimit | 強化クエストの1日あたりの広告視聴挑戦上限回数 |
| **MstQuest**<br>クエストマスタ | Id | クエストID |
| | QuestType | クエストの種別（このクエストでは"Enhance"） |
| | Difficulty | クエストの難易度 |
| **MstStage**<br>ステージマスタ | Id | ステージID |
| | MstQuestId | 関連するクエストID |
| **MstStageEnhanceRewardParam**<br>強化クエスト報酬パラメータ | MinThresholdScore | スコア報酬の必要スコア閾値 |
| | CoinRewardAmount | 報酬内容（コイン量） |
| **MstQuestBonusUnit**<br>クエストボーナスユニット | MstUnitId | ボーナス対象ユニットID |
| | CoinBonusRate | コイン獲得ボーナス率 |
| | StartAt | ボーナス有効期間開始日時 |
| | EndAt | ボーナス有効期間終了日時 |
| **MstQuestEventBonusSchedule**<br>クエストイベントボーナススケジュール | MstQuestId | クエストID |
| | EventBonusGroupId | ボーナスグループID |
| | StartAt | スケジュール有効期間開始日時 |
| | EndAt | スケジュール有効期間終了日時 |
| **MstEventBonus**<br>イベントボーナスマスタ | EventBonusGroupId | ボーナスグループID |
| | EffectValue | キャンペーン効果値 |
| **MstCampaignSchedule**<br>キャンペーンスケジュール | CampaignTargetType | キャンペーン対象タイプ（"EnhanceQuest"） |
| | EffectValue | キャンペーン効果値（挑戦回数増加など） |

#### ユーザーデータ（GameFetch）

| テーブル名 | カラム名 | 説明 |
|-----------|---------|------|
| **UserStageEnhance**<br>ユーザーステージ強化実績 | MstStageId | ステージID |
| | MaxScore | 現在のハイスコア |
| | ResetChallengeCount | 本日の通常挑戦実行済み回数 |
| | ResetAdChallengeCount | 本日の広告視聴挑戦実行済み回数 |
| **UserPartyCache**<br>ユーザーパーティ情報キャッシュ | PartyName | パーティ名 |
| | UnitList | パーティに編成されたユニットID一覧 |
| **UserUnit**<br>ユーザーユニット | UsrUnitId | ユーザーのユニットID |
| | MstUnitId | マスタユニットID |

### 呼び出しているAPI

API呼び出しはありません。このシーンで使用されるすべてのデータは、GameFetchで事前に取得されたマスタデータとユーザーデータを参照することで画面表示が実現されています。
