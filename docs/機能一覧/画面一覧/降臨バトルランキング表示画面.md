# 降臨バトルランキング表示画面

## 基本情報

| 項目 | 内容 |
|------|------|
| **画面名** | 降臨バトルランキング表示画面 |
| **画面番号** | 44-4-2 |
| **画面種別** | サブ画面 |

## 概要

降臨バトルの現在のランキング状況を確認できる画面です。プレイヤーは自分のランキング順位や最高スコア、スコアランクを確認できるほか、TOP100の他のプレイヤーのランキング情報も閲覧できます。

## プレイヤーができること

### ランキング確認

#### 自分のランキング
- 自分の現在の順位を確認
- 自分の最高スコアを確認
- スコアランク（Bronze、Silver、Gold、Masterのランクとレベル）を確認
- 設定しているユニットアイコンとエンブレムを確認
- ランキング集計中の場合は「集計中」表示がされる

#### 他のプレイヤーのランキング
- TOP100のランキングを閲覧
- 各プレイヤーの順位、ユーザー名、最高スコア、スコアランクを確認
- 自分がTOP100に入っている場合、リスト内の自分の情報がハイライト表示される

### ヘルプ表示
- ヘルプボタンをタップして遊び方を確認（実装予定）

### 画面を閉じる
- 戻るボタンで前の画面に戻る

## 画面の要素

### ヘッダー部分
- タイトル表示: 降臨バトルの名前（例：「〇〇イベント降臨バトル」）
- ヘルプボタン
- 戻るボタン

### 自分の情報エリア
- ランキング順位
  - 通常時: 順位番号を表示
  - 集計中: 「集計中」表示
  - 未参加: 「未参加」表示
  - ランキング対象外: 「対象外」表示（不正行為などで除外された場合）
  - 参加条件未達: 「参加条件未達成」表示（スコアが0の場合）
- ユーザー名
- 最高スコア
- ユニットアイコン
- エンブレム
- スコアランクアイコン（RankType + RankLevel）

### ランキングリストエリア
- TOP100のプレイヤーリスト（スクロール可能）
- 各プレイヤーの表示項目：
  - 順位
  - ユーザー名
  - 最高スコア
  - ユニットアイコン
  - エンブレム
  - スコアランクアイコン
- 自分がTOP100に入っている場合は、該当行がハイライト表示

## 画面遷移

### この画面への遷移
- **降臨バトルコンテンツ画面**: ランキングボタンをタップ

### この画面からの遷移
- **前の画面（降臨バトルコンテンツ画面）**: 戻るボタンをタップ

## ゲーム仕様・制約事項

### ランキング表示ルール

#### 自分のランキング状態
画面には4つの状態があり、プレイヤーの参加状況に応じて表示が切り替わります：

1. **通常表示（Normal）**
   - 降臨バトルに参加し、ランキングスコアが記録されている状態
   - 順位、スコア、スコアランクが正常に表示される

2. **未参加（EmptyCurrentRanking）**
   - まだ降臨バトルに参加していない状態
   - 「未参加」と表示される

3. **参加条件未達成（NotAchieveRanking）**
   - 降臨バトルをプレイしたが、スコアが0でランキング対象外の状態
   - 「参加条件未達成」と表示される

4. **ランキング対象外（ExcludeRanking）**
   - 不正行為などでランキングから除外された状態
   - 「対象外」と表示される

#### ランキング集計中の表示
- イベント開催中、スコア更新直後などでランキングが集計中の場合
- 自分の最新スコアとランキング上のスコアが異なる場合に「集計中」と表示
- 集計が完了すると順位が更新される

#### TOP100の表示条件
- スコアが0（参加条件未達成）のプレイヤーはTOP100から除外される
- 順位順にソートされて表示される
- 自分がTOP100に入っている場合は自分の行がハイライト表示される

### スコアランクの仕組み
- 累積スコア（TotalScore）に応じてスコアランクが決定される
- ランクタイプ: Bronze → Silver → Gold → Master（昇順）
- 各ランクタイプ内でレベルが存在（1, 2, 3...）
- マスタデータ（MstAdventBattleScoreRank）の「必要下限スコア」を満たすと昇格

### 終了済みイベントの表示
- 終了済みの降臨バトルのランキングも閲覧可能
- 終了済みの場合は集計中表示は出ない
- 最終ランキング結果が表示される

## 技術参考情報

### 画面実装パス
- `Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/`

### 主要コンポーネント

#### Presenter
- `Presentation/Presenters/AdventBattleRankingPresenter.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Presenters/AdventBattleRankingPresenter.cs

#### ViewModel
- `Presentation/ViewModels/AdventBattleRankingViewModel.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingViewModel.cs
- `Presentation/ViewModels/AdventBattleRankingElementViewModel.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingElementViewModel.cs
- `Presentation/ViewModels/AdventBattleRankingMyselfUserViewModel.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingMyselfUserViewModel.cs
- `Presentation/ViewModels/AdventBattleRankingOtherUserViewModel.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/ViewModels/AdventBattleRankingOtherUserViewModel.cs

#### View
- `Presentation/Views/AdventBattleRankingView.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Views/AdventBattleRankingView.cs
- `Presentation/Views/AdventBattleRankingViewController.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Views/AdventBattleRankingViewController.cs

#### UseCase
- `Domain/UseCases/AdventBattleRankingUseCase.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Domain/UseCases/AdventBattleRankingUseCase.cs

#### Translator
- `Presentation/Translators/AdventBattleRankingViewModelTranslator.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Presentation/Translators/AdventBattleRankingViewModelTranslator.cs

#### ModelFactory
- `Domain/ModelFactories/AdventBattleRankingModelFactory.cs`
  - projects/glow-client/Assets/GLOW/Scripts/Runtime/Scenes/AdventBattleRanking/Domain/ModelFactories/AdventBattleRankingModelFactory.cs

### AdventBattleRankingViewModelの構造

#### AdventBattleRankingViewModel
画面全体のViewModel

- `CurrentRanking`: 現在のランキング情報（AdventBattleRankingElementViewModel）

#### AdventBattleRankingElementViewModel
ランキング要素のViewModel

- `OtherUserViewModels`: 他のプレイヤーのランキング情報リスト（AdventBattleRankingOtherUserViewModel）
- `MyselfUserViewModel`: 自分のランキング情報（AdventBattleRankingMyselfUserViewModel）
- `AdventBattleName`: 降臨バトルの名前

#### AdventBattleRankingMyselfUserViewModel
自分のランキング情報のViewModel

- `UserName`: プレイヤー名
- `MaxScore`: 最高スコア
- `EmblemIconAssetPath`: エンブレムアイコンのアセットパス
- `UnitIconAssetPath`: ユニットアイコンのアセットパス
- `Rank`: ランキング順位
- `RankType`: スコアランクのタイプ（Bronze/Silver/Gold/Master）
- `RankLevel`: スコアランクのレベル
- `CalculatingRankings`: ランキング集計中フラグ
- `ViewStatus`: 表示状態（Normal/EmptyCurrentRanking/NotAchieveRanking/ExcludeRanking）

**表示制御ロジック**：
- `ViewStatus`によって、自分のランキング表示の状態が切り替わる
  - `Normal`: 通常のランキング表示
  - `EmptyCurrentRanking`: 未参加表示
  - `NotAchieveRanking`: 参加条件未達成表示
  - `ExcludeRanking`: ランキング対象外表示

#### AdventBattleRankingOtherUserViewModel
他のプレイヤーのランキング情報のViewModel

- `UserName`: プレイヤー名
- `MaxScore`: 最高スコア
- `EmblemIconAssetPath`: エンブレムアイコンのアセットパス
- `UnitIconAssetPath`: ユニットアイコンのアセットパス
- `Rank`: ランキング順位
- `IsMyself`: 自分自身かどうかのフラグ（ハイライト表示用）
- `RankType`: スコアランクのタイプ
- `RankLevel`: スコアランクのレベル

### 画面初期化時の引数
```csharp
AdventBattleRankingViewController.Argument(
    AdventBattleRankingViewModel AdventBattleRankingViewModel
)
```
- `AdventBattleRankingViewModel`: ランキング表示に必要な全ての情報を含むViewModel

### 使用しているDBデータ

#### マスタデータ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| MstAdventBattle.Id | mst_advent_battles.id | 降臨バトルID（ランキング取得APIパラメータ） |
| MstAdventBattle.AdventBattleName | mst_advent_battles.name | 画面タイトルに表示される降臨バトル名 |
| MstAdventBattleScoreRank.Id | mst_advent_battle_score_ranks.id | スコアランクID |
| MstAdventBattleScoreRank.MstAdventBattleId | mst_advent_battle_score_ranks.mst_advent_battle_id | 対象の降臨バトルID |
| MstAdventBattleScoreRank.RankType | mst_advent_battle_score_ranks.rank_type | ランクタイプ（Bronze/Silver/Gold/Master） |
| MstAdventBattleScoreRank.ScoreRankLevel | mst_advent_battle_score_ranks.score_rank_level | スコアランクレベル（各ランクタイプ内のレベル） |
| MstAdventBattleScoreRank.RequiredLowerScore | mst_advent_battle_score_ranks.required_lower_score | ランク取得に必要な下限スコア |
| MstEmblem.Id | mst_emblems.id | エンブレムID |
| MstEmblem.AssetKey | mst_emblems.asset_key | エンブレムアイコンのアセットキー（表示用） |
| MstCharacter.Id | mst_units.id | キャラクター（ユニット）ID |
| MstCharacter.AssetKey | mst_units.asset_key | キャラクターアイコンのアセットキー（表示用） |

#### ユーザーデータ（GameFetch）

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| UserProfile.Name | user_profiles.name | 自分のユーザー名（自分の情報表示） |
| UserProfile.MstUnitId | user_profiles.mst_unit_id | 自分のプロフィールユニットID（自分のアイコン表示） |
| UserProfile.MstEmblemId | user_profiles.mst_emblem_id | 自分のプロフィールエンブレムID（自分のエンブレム表示） |
| UserProfile.MyId | user_profiles.my_id | 自分のユーザー識別ID（他プレイヤーリスト内で自分を判定） |
| UserAdventBattle.MstAdventBattleId | user_advent_battles.mst_advent_battle_id | ユーザーの降臨バトルID |
| UserAdventBattle.MaxScore | user_advent_battles.max_score | 自分の最高スコア（イベント開催中の最新スコア表示） |
| UserAdventBattle.TotalScore | user_advent_battles.total_score | 自分の累積スコア（スコアランク判定に使用） |

#### API取得データ

| クライアント定義 | サーバー定義 | クライアント説明 |
|----------------|-------------|----------------|
| AdventBattleRankingItemModel.UserMyId | - | ランキング参加者のユーザーID（TOP100リスト） |
| AdventBattleRankingItemModel.Rank | - | ランキング順位（TOP100リスト） |
| AdventBattleRankingItemModel.UserName | - | ランキング参加者のユーザー名（TOP100リスト） |
| AdventBattleRankingItemModel.MstUnitId | - | ランキング参加者のユニットID（TOP100リスト） |
| AdventBattleRankingItemModel.MstEmblemId | - | ランキング参加者のエンブレムID（TOP100リスト） |
| AdventBattleRankingItemModel.MaxScore | - | ランキング参加者の最高スコア（TOP100リスト） |
| AdventBattleRankingItemModel.TotalScore | - | ランキング参加者の累積スコア（スコアランク判定） |
| AdventBattleMyRankingModel.Rank | - | 自分のランキング順位 |
| AdventBattleMyRankingModel.MaxScore | - | 自分の最高スコア（終了済みイベントのみ使用） |
| AdventBattleMyRankingModel.TotalScore | - | 自分の累積スコア（終了済みイベントのスコアランク判定） |
| AdventBattleMyRankingModel.IsExcludeRanking | - | ランキングから除外されているかのフラグ |

### 呼び出しているAPI

#### 画面初期化時（画面を開く前）
- **GET `/api/advent_battle/ranking`**: 降臨バトルランキング取得API
  - パラメータ:
    - `mstAdventBattleId` (降臨バトルID)
    - `isPrevious` (前回のランキングを取得するかどうか - この画面では通常false)
  - 用途: 現在のランキング情報（TOP100と自分のランキング）を取得
  - レスポンス:
    - `RankingList`: TOP100のランキングリスト
    - `MyRanking`: 自分のランキング情報
