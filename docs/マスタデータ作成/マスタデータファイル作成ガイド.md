# マスタデータファイル作成ガイド

このドキュメントでは、GLOWプロジェクトのマスタデータファイル（glow-masterdata）の作成ルールと規約をまとめています。

## 概要

glow-masterdataリポジトリは、GLOWゲームのマスタデータを管理するリポジトリです。各マスタデータはCSV形式で保存され、データベーステーブル1つあたり1つのCSVファイルとして管理されます。

- **リポジトリ**: `glow-masterdata`
- **ファイル形式**: CSV
- **ファイル数**: 約164ファイル（2025年12月時点）
- **対応関係**: 1テーブル = 1 CSVファイル

## ファイル命名規則

### プレフィックス分類

マスタデータファイルは、プレフィックスによって用途が分類されます：

| プレフィックス | 用途 | 例 |
|------------|------|-----|
| `Mst` | マスタデータ（Master） | `MstUnit.csv`, `MstQuest.csv` |
| `Opr` | 運営データ（Operation） | `OprGacha.csv`, `OprCampaign.csv` |

### ファイル名の構成

```
{プレフィックス}{テーブル名}.csv
```

**例:**
- `MstUnit.csv` → `mst_unit` テーブル
- `MstUnitI18n.csv` → `mst_unit_i18n` テーブル
- `OprGacha.csv` → `opr_gacha` テーブル

### I18nファイル

多言語対応が必要なテーブルには、`I18n`サフィックスを持つファイルが存在します。

**例:**
- `MstUnit.csv` (基本データ) + `MstUnitI18n.csv` (多言語データ)
- `MstAbility.csv` (基本データ) + `MstAbilityI18n.csv` (多言語データ)

## CSVファイルの基本構造

### 1. ヘッダー行（1行目）

CSVファイルの1行目はカラム名を定義します。

```csv
ENABLE,id,fragment_mst_item_id,role_type,color,attack_range_type,...,release_key
```

**必須カラム:**
- `ENABLE`: データの有効/無効フラグ（必ず1列目）
- `id`: 主キー（通常2列目）
- `release_key`: バージョン管理用キー（通常最終列）

### 2. データ行（2行目以降）

各行が1レコードを表します。

```csv
e,chara_dan_00001,piece_dan_00001,Defense,Red,Short,...,202509010
,chara_old_00001,piece_old_00001,Attack,Blue,Middle,...,202509010
```

**ENABLEフラグ:**
- `e`: 有効（enabled）- ゲームで使用される
- 空文字: 無効 - ゲームでは使用されない

### 3. NULL値の表現

NULL値は特殊な文字列 `__NULL__` で表現します。

```csv
ENABLE,id,gacha_type,upper_group,enable_ad_play,...
e,Tutorial_001,Tutorial,__NULL__,1,...
```

**重要:** 空文字列とNULLは区別されます：
- 空欄: 空文字列（`""`）
- `__NULL__`: データベースのNULL値

## I18nファイルの構造

多言語対応データは、別ファイルで管理します。

### I18nファイルの必須カラム

```csv
ENABLE,release_key,id,mst_{table}_id,language,{translation_columns}
```

- `id`: I18nレコードの一意ID（通常は `{元のid}_{language}` 形式）
- `mst_{table}_id`: 親テーブルのIDへの外部キー
- `language`: 言語コード（`ja`, `en` など）

### I18nファイルの例

**MstUnitI18n.csv:**
```csv
ENABLE,release_key,id,mst_unit_id,language,name,description,detail
e,202509010,chara_dan_00001_ja,chara_dan_00001,ja,オカルン,"幽霊は信じていないが、宇宙人は信じている...",必殺ワザで...
e,202509010,chara_dan_00001_en,chara_dan_00001,en,Okarun,"A high school boy who doesn't believe in...",Special attack...
```

**対応関係:**
- `MstUnit.csv` の `id=chara_dan_00001`
- `MstUnitI18n.csv` の `mst_unit_id=chara_dan_00001` かつ `language=ja`

## データ型とフォーマット

### 文字列

- UTF-8エンコーディング
- ダブルクォートで囲む（カンマや改行を含む場合は必須）
- 改行は `\n` で表現

```csv
ENABLE,id,description
e,1,"これは1行目\nこれは2行目"
```

### 数値

- 整数: そのまま記述（例: `100`, `0`, `-5`）
- 小数: 小数点を使用（例: `1.5`, `0.25`）

```csv
ENABLE,id,damage,rate
e,1,100,1.5
```

### 日付時刻

- フォーマット: `YYYY-MM-DD HH:MM:SS`
- タイムゾーン: UTC

```csv
ENABLE,id,start_at,end_at
e,Tutorial_001,"2025-04-01 04:00:00","2038-01-01 00:00:00"
```

### ブール値

プロジェクトによって異なりますが、一般的には：
- `0` / `1`
- `true` / `false`（文字列として）

## バージョン管理

### release_key

`release_key` カラムは、マスタデータのバージョン管理に使用されます。

```csv
ENABLE,id,...,release_key
e,ability_attack_power_up,202509010
e,ability_new_feature,202512010
```

**フォーマット:**
- `YYYYMMVVV` 形式
  - `YYYY`: 年
  - `MM`: 月
  - `VVV`: バージョン番号（010, 020, 030...）

**例:**
- `202509010`: 2025年9月、バージョン01
- `202512020`: 2025年12月、バージョン02

## データ整合性ルール

### 1. 主キーの一意性

各ファイル内で `id` カラムの値は一意でなければなりません。

### 2. 外部キー参照

外部キーは、参照先テーブルに存在する有効な `id` を指定する必要があります。

**例:**
```csv
# MstUnit.csv
ENABLE,id,mst_series_id,...
e,chara_dan_00001,dan,...

# MstSeries.csv
ENABLE,id,...
e,dan,...
```

### 3. I18nデータの整合性

- I18nファイルの各レコードは、親テーブルの有効なレコードを参照する必要があります
- 少なくとも1つの言語（通常は `ja`）のデータが必要です

### 4. ENABLEフラグ

- `e`: データが有効で、ゲームで使用される
- 空文字: データが無効で、ゲームでは使用されない（削除せずに無効化）

## ベストプラクティス

### 1. ファイル編集

- **文字コード**: UTF-8（BOM なし）
- **改行コード**: LF（`\n`）
- **エディタ**: Excel よりも CSV エディタまたはテキストエディタを推奨
  - Excelは改行や引用符の扱いが不正確な場合があります

### 2. ID命名規則

プロジェクト内で一貫した命名規則を使用します。

**例（MstUnit）:**
```
chara_{series}_{number}
```
- `chara_dan_00001`: ダン シリーズのキャラクター1
- `chara_dan_00002`: ダン シリーズのキャラクター2
- `chara_gom_00001`: ゴム シリーズのキャラクター1

**例（MstItem）:**
```
{type}_{series}_{number}
```
- `piece_dan_00001`: ダン シリーズの破片アイテム1

### 3. データ追加時の注意

新しいデータを追加する際：
1. 適切な `release_key` を設定
2. 関連するI18nデータも同時に追加
3. 外部キー参照が正しいことを確認
4. `ENABLE` フラグは `e` で開始

### 4. データ削除の代わりに無効化

データを削除する代わりに、`ENABLE` フラグを空文字に設定します。

```csv
# 削除する代わりに
# BEFORE
e,old_data_001,...

# AFTER
,old_data_001,...
```

これにより：
- データの履歴が保持される
- 既存のデータベースとの互換性が維持される
- 必要に応じて再度有効化できる（`e`に戻す）

## glow-serverとの連携

### モデルクラス

各マスタデータテーブルには対応するモデルクラスが存在します。

**ディレクトリ構造:**
```
glow-server/
├── api/app/Domain/Resource/Mst/Models/
│   ├── MstUnit.php (ベースモデル)
│   ├── MstQuest.php
│   └── ...
└── admin/app/Models/Mst/
    ├── MstUnit.php (admin拡張モデル)
    ├── MstQuest.php
    └── ...
```

### リレーション

モデルクラスでリレーションが定義されます。

**例（MstUnit.php）:**
```php
public function mst_unit_i18n()
{
    return $this->hasOne(MstUnitI18n::class, 'mst_unit_id', 'id');
}

public function mst_series()
{
    return $this->hasOne(MstSeries::class, 'id', 'mst_series_id');
}
```

### Filament管理画面

glow-server/adminでは、Filamentを使用して管理画面が提供されます。

**リソースファイル:**
```
admin/app/Filament/Resources/
├── MstUnitResource.php
├── MstQuestResource.php
└── ...
```

これらのリソースで、マスタデータの閲覧、検索、フィルタリングが可能です。

## トラブルシューティング

### よくある問題

#### 1. CSVパースエラー

**症状:** データが正しく読み込まれない

**原因と対処:**
- カンマや改行を含むフィールドがダブルクォートで囲まれていない
  - → 該当フィールドを `"..."` で囲む
- 文字コードがUTF-8でない
  - → エディタでUTF-8に変換
- 改行コードがCRLFになっている
  - → LF（`\n`）に変換

#### 2. 外部キー参照エラー

**症状:** データベース読み込み時にエラー

**原因と対処:**
- 参照先のIDが存在しない
  - → 参照先テーブルに該当IDのレコードを追加
- 参照先のレコードが無効（`d`）になっている
  - → 参照先レコードを有効（`e`）にする

#### 3. I18nデータが表示されない

**症状:** ゲームで日本語テキストが表示されない

**原因と対処:**
- I18nファイルに `language=ja` のレコードがない
  - → 日本語レコードを追加
- I18nレコードの `mst_{table}_id` が親レコードの `id` と一致しない
  - → IDの対応を確認して修正

## 参考リソース

### 関連ファイル

- `glow-masterdata/`: マスタデータCSVファイル
- `glow-server/api/app/Domain/Resource/Mst/Models/`: ベースモデル定義
- `glow-server/admin/app/Models/Mst/`: Admin用モデル拡張
- `glow-server/admin/app/Filament/Resources/`: Filament管理画面リソース

### 命名規則の確認方法

既存のファイルを参考にして、プロジェクトの命名規則を確認します：

```bash
# IDのパターンを確認
grep "^e," projects/glow-masterdata/MstUnit.csv | head -5

# release_keyの値を確認
grep "^e," projects/glow-masterdata/MstUnit.csv | cut -d',' -f31 | sort -u
```

## まとめ

マスタデータファイルを作成する際の重要なポイント：

1. ✅ **ファイル名**: `{Mst|Opr}{TableName}.csv` 形式
2. ✅ **必須カラム**: `ENABLE`, `id`, `release_key`
3. ✅ **ENABLEフラグ**: 有効は `e`、無効は空文字
4. ✅ **NULL値**: `__NULL__` を使用
5. ✅ **I18nファイル**: 多言語対応には別ファイルを作成
6. ✅ **文字コード**: UTF-8（BOM なし）
7. ✅ **整合性**: 外部キー参照とI18nデータの整合性を保つ
8. ✅ **バージョン管理**: `release_key` を適切に設定

このガイドに従うことで、一貫性のあるマスタデータファイルを作成できます。
