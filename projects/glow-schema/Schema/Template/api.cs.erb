using System;
using System.Collections;
using System.Collections.Generic;
using System.Runtime.Serialization;
using System.Threading;
using Cysharp.Threading.Tasks;
using Newtonsoft.Json;
using UnityEngine;
using UnityHTTPLibrary;
using WPFramework.Data.Extensions;
using GLOW.Core.Data.Data;
using GLOW.Core.Domain.Constants;
using Zenject;

// ----------------------------------------------------------------------
// This file is auto-generated by SchemaBuilder. Do not modify directly.
// ----------------------------------------------------------------------

namespace GLOW.Core.Data.DataStores
{
    public sealed class <%= schema["name"] %>Api
    {
        <%- schema["actions"].each do |action| -%>
        [Serializable]
        class JsonParam<%= action["name"] %>
        {
            <%- action["params"].each do |p| -%>
            [IgnoreDataMember] [JsonIgnore]
            public <%= p["type"] %> <%= p["name"].camelize %> {
                get => <%= p["name"] %>;
                set => <%= p["name"] %> = value;
            }
            <%- end -%>
            <%- action["params"].each do |p| -%>
            [DataMember(Name = "<%= p["name"] %>")] [SerializeField] [JsonProperty("<%= p["name"] %>")] <%= p["type"] %> <%= p["name"] %>;
            <%- end -%>
        }
        <%- end -%>

        <%- unless schema["context"].nil? -%>
        [Inject(Id = WPFramework.Constants.Zenject.FrameworkInjectId.ServerApi.<%= schema["context"] %>)] ServerApi <%= schema["context"] %>APIContext { get; }
        <%- else -%>
        [Inject(Id = WPFramework.Constants.Zenject.FrameworkInjectId.ServerApi.Game)] ServerApi APIContext { get; }
        <%- end -%>

        <%- schema["actions"].each do |action| -%>
        public async UniTask<<%= action["response"] %>> <%= action["name"] %>(CancellationToken cancellationToken<%- if action["all_params"].length > 0 %>, <%- end -%><%= action["all_params"].map{|p| "#{p["type"]} #{p["name"].camelize(:lower)}"}.join(", ") %>  <%- if action["progress"] %><%- if action["all_params"].length > 0 %> ", " <%- end -%>IProgress<HTTPProgressData> progressReporter<%- end -%>)
        {
            <%- # パラメータをクエリで送るか -%>
            <%- use_query_params = !action["params"].empty? && action["method"].upcase == 'GET' -%>
            <%- unless action["params"].empty? -%>
            <%- if use_query_params -%>
            var payload = new Payload()
            {
                Data = Array.Empty<byte>(),
                ContentType = MimeTypes.Json
            };
            var uriParameters = System.Web.HttpUtility.ParseQueryString(string.Empty);
            <%- action["params"].each do |p| -%>
            uriParameters["<%= p["name"] %>"] = <%= p["name"] %>; 
            <%- end -%>
            <%- else -%>
            <%- # パラメータのRendering -%>
            var param = new JsonParam<%= action["name"] %>();
            <%- action["params"].each do |p| -%>
            <%- if p["type"].match(/\?$/) -%>
            if(<%= p["name"] %>.HasValue)
            {
                param.<%= p["name"].camelize %> = <%= p["name"] %>.Value;
            }
            <%- else -%>
            param.<%= p["name"].camelize %> = <%= p["name"] %>;
            <%- end -%>
            <%- end -%>
            var json = JsonConvert.SerializeObject(param);
            var payload = new Payload()
            {
                Data = System.Text.Encoding.UTF8.GetBytes(json),
                ContentType = MimeTypes.Json
            };
            <%- end -%>
            <%- else %>
            var payload = new Payload()
            {
                Data = Array.Empty<byte>(),
                ContentType = MimeTypes.Json
            };
            <%- end -%>
    
            <%- if use_query_params -%>
            return await <%= schema["context"] %>APIContext.<%= action["method"].capitalize %><<%= action["response"] %>>(cancellationToken, "<%= action["path"] %>?" + uriParameters, payload<%- if action["progress"] %>, progressReporter: progressReporter<%- end -%>);
            <%- else -%>
            return await <%= schema["context"] %>APIContext.<%= action["method"].capitalize %><<%= action["response"] %>>(cancellationToken, "<%= action["path"] %>", payload<%- if action["progress"] %>, progressReporter: progressReporter<%- end -%>);
            <%- end -%>
        }
        <%- end -%>
    }
}