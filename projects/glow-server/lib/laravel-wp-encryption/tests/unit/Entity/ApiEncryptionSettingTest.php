<?php

namespace WonderPlanet\Test\Unit\Entity;

use App\Domain\Common\Constants\ErrorCode;
use App\Domain\Common\Exceptions\GameException;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Config;
use PHPUnit\Framework\Attributes\Test;
use Tests\TestCase;
use WonderPlanet\Entity\ApiEncryptionSetting;

class ApiEncryptionSettingTest extends TestCase
{
    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub
    }

        #[Test]
    public function test_enableEncryption_リクエストにXRequestEncryptedがなければ299エラー()
    {
        // Setup
        Config::set('app.env', 'local');
        Config::set('wp_encryption.production_env_name', 'production');
        Config::set('wp_encryption.enabled', true);
        Config::set('wp_encryption.disable_header', 'X-Disable-Encryption');
        Config::set('wp_encryption.password', 'password');
        Config::set('wp_encryption.salt_header', 'Unique-Request-Identifier');

        $request = new Request();

        $this->expectException(GameException::class);
        $this->expectExceptionCode(ErrorCode::VALIDATION_ERROR);

        // メソッド実行
        ApiEncryptionSetting::create($request);
    }
    
    #[Test]
    public function test_enableEncryption_enabledがtrueかつdisable_headerがtrueなら有効()
    {
        // Setup
        Config::set('app.env', 'local');
        Config::set('wp_encryption.production_env_name', 'production');
        Config::set('wp_encryption.enabled', true);
        Config::set('wp_encryption.disable_header', 'X-Disable-Encryption');
        Config::set('wp_encryption.password', 'password');
        Config::set('wp_encryption.salt_header', 'Unique-Request-Identifier');

        $request = new Request();
        $request->headers->set('X-Disable-Encryption', 'true');

        // excute
        $encryptionSetting = ApiEncryptionSetting::create($request);

        $this->assertTrue($encryptionSetting->enableEncryption());
    }

    #[Test]
    public function test_enableEncryption_本番なら設定やリクエストヘッダによらず有効()
    {
        // Setup
        Config::set('app.env', 'production');
        Config::set('wp_encryption.production_env_name', 'production');
        Config::set('wp_encryption.enabled', false);
        Config::set('wp_encryption.disable_header', 'X-Disable-Encryption');
        Config::set('wp_encryption.password', 'password');
        Config::set('wp_encryption.salt_header', 'Unique-Request-Identifier');

        $request = new Request();
        $request->headers->set('X-Disable-Encryption', 'false');

        // excute
        $encryptionSetting = ApiEncryptionSetting::create($request);

        // 期待値チェック
        $this->assertTrue($encryptionSetting->enableEncryption());
    }

    #[Test]
    public function test_enableEncryption_enabledがfalseなら無効()
    {
        // Setup
        Config::set('app.env', 'local');
        Config::set('wp_encryption.production_env_name', 'production');
        Config::set('wp_encryption.enabled', false);
        Config::set('wp_encryption.disable_header', 'X-Disable-Encryption');
        Config::set('wp_encryption.password', 'password');
        Config::set('wp_encryption.salt_header', 'Unique-Request-Identifier');

        $request = new Request();
        $request->headers->set('X-Disable-Encryption', 'true');

        // excute
        $encryptionSetting = ApiEncryptionSetting::create($request);

        $this->assertFalse($encryptionSetting->enableEncryption());
    }
}
