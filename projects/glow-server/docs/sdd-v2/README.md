# SDD v2 (Spec-Driven Development v2)

## 概要

SDD v2は、ゲーム体験仕様書とコードベースから要件を抽出し、プランナー確認を経てAPI設計を行う設計フローです。**CodeRabbitと連携することで、PRレビュー時に機能要件の実装状況を自動チェック**します。

## 🎯 SDD v2 + CodeRabbitの効果

### レビュイー（実装者）
- ✅ チームレビュー前に機能要件漏れに気付ける
- ✅ 自己チェックで品質を向上できる
- ✅ 実装の抜け漏れを防止できる

### レビュワー
- ✅ 機能要件の実装状況が一目瞭然
- ✅ 非機能要件（パフォーマンス、セキュリティ、保守性）のレビューに集中できる
- ✅ レビュー時間を短縮できる

### チーム全体
- ✅ バグが少ない実装成果物
- ✅ 将来の追加/変更に強いコードベース
- ✅ プランナーとエンジニアの認識齟齬を削減

## 📁 ディレクトリ構造

```
docs/sdd-v2/
├── README.md                    # このファイル
├── features/                    # 機能別のSDD v2ドキュメント
│   └── {機能名}/
│       ├── 01_要件調査.md      # PDF要件 + コード調査要件 + 統合要件一覧
│       ├── 02_仕様確認.md      # 確定した仕様 + 残存する技術的判断事項
│       ├── 02_2_プランナー確認結果.md  # プランナーへの確認結果
│       └── 03_API設計.md       # API設計書（オプション）
├── templates/                   # ドキュメントテンプレート
├── prompts/                     # SDD v2生成用プロンプト
├── checklists/                  # チェックリスト
└── logs/                        # 実行ログ
```

## 🚀 SDD v2 設計フロー

### Phase 1: 要件調査（/api:sdd-v2:01-requirements）

**目的：** ゲーム体験仕様書PDFとコードベースから、サーバー側で考慮すべき要件を包括的に抽出

**成果物：** `01_要件調査.md`

**内容：**
- 機能概要
- PDFからの要件抽出（要件P-1, P-2, ...）
- コード調査からの追加要件（要件C-1, C-2, ...）
- **統合要件一覧**（カテゴリA〜E）← **CodeRabbitがチェックする要件リスト**
- 不明点・曖昧な点

### Phase 2: 仕様確認（/api:sdd-v2:02-spec-confirm）

**目的：** 要件調査で洗い出された不明点・曖昧点をレビューし、プランナーへの確認項目を整理

**成果物：**
- `02_仕様確認.md`
- `02_2_プランナー確認結果.md`（確認後）

**内容：**
- 明瞭な仕様と残存する技術的判断事項
- プランナーへの確認項目（Q1〜QN）
- 確認結果の統合

### Phase 3: API設計（/api:sdd-v2:03-api-design）

**目的：** 仕様確認結果を基に、実装可能な具体的なAPI設計書を作成

**成果物：** `03_API設計.md`

**内容：**
- API概要
- エンドポイント定義
- リクエスト/レスポンス仕様
- DB設計
- テスト観点

### Phase 4: API設計レビュー（/api:sdd-v2:03-2-api-review）

**目的：** API設計書の初稿をチェックリストに基づいて品質レビュー

**成果物：** レビュー結果と修正版API設計書

**内容：**
- 規約違反の検出
- 修正案の提示
- 設計書の更新

## 🔄 フルフロー実行

全フェーズを自動実行：

```bash
/api:sdd-v2:00-run-full {機能名}
```

**実行内容：**
1. Phase 1: 要件調査
2. Phase 2: 仕様確認（Phase 2で人間確認が必要）
3. Phase 3: API設計
4. Phase 4: API設計レビュー

## 🤖 CodeRabbitとの連携

### 仕組み

1. **SDD v2ドキュメントの読み込み**
   - `.coderabbit.yaml`の`knowledge_base.code_guidelines.filePatterns`に`docs/sdd-v2/features/**/*.md`を設定
   - CodeRabbitがSDD v2ドキュメントを自動読み込み

2. **機能要件チェックの実行**
   - PRレビュー時、CodeRabbitが`01_要件調査.md`の「統合要件一覧」を確認
   - 各要件の実装状況を自動チェック

3. **レポート生成**
   - 機能要件実装状況テーブルを生成
   - 未実装の要件を指摘
   - 部分実装の要件を警告

### CodeRabbitのレポート例

```markdown
#### 機能要件実装状況

| 要件ID | 要件タイトル | 実装状況 | 実装箇所 | 備考 |
|--------|-------------|---------|---------|------|
| REQ-A-1 | ステップ数の設定 | ✅ 実装済 | api/app/Domain/Gacha/Entities/StepUpGacha.php:45 | - |
| REQ-A-2 | ステップ進行状態の管理 | ✅ 実装済 | api/database/migrations/2025_12_12_create_usr_gacha_steps.php:23 | - |
| REQ-A-3 | ステップ遷移ロジック | ⚠️ 部分実装 | api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php:120 | 周回処理が未実装 |
| REQ-B-1 | ステップごとのプリズム設定 | ✅ 実装済 | api/app/Domain/Gacha/Repositories/GachaCostRepository.php:67 | - |
| REQ-B-2 | 無料ステップの設定 | ❌ 未実装 | - | 次のPRで実装予定 |

**未実装の要件：**
- REQ-B-2: 無料ステップの設定
- REQ-A-3: ステップ遷移ロジック（部分実装）
```

## 📝 統合要件一覧の書き方

`01_要件調査.md`の「統合要件一覧」セクションは、以下の形式で記載します：

```markdown
## 5. 統合要件一覧

### カテゴリ A: ステップ管理

| 要件ID | 要件タイトル | 出典 | 概要 |
|--------|-------------|------|------|
| REQ-A-1 | ステップ数の設定 | PDF P-1 | 最大10ステップまで設定可能 |
| REQ-A-2 | ステップ進行状態の管理 | Code C-3 | ユーザーの現在のステップ番号を記録 |
| REQ-A-3 | ステップ遷移ロジック | Code C-6 | ステップ実行後の自動遷移処理 |

### カテゴリ B: コスト設定

| 要件ID | 要件タイトル | 出典 | 概要 |
|--------|-------------|------|------|
| REQ-B-1 | ステップごとのプリズム設定 | PDF P-2 | 無償/有償プリズムの個数を各ステップで設定 |
| REQ-B-2 | 無料ステップの設定 | PDF P-4 | 特定ステップをコスト0に設定可能 |
```

**重要：**
- 要件IDは一意にする（REQ-{カテゴリ}-{番号}）
- カテゴリは機能特性で分類（A: ステップ管理、B: コスト設定、C: 確定枠・報酬設定、など）
- 出典を明記（PDF P-X または Code C-X）
- 概要は1〜2文で簡潔に記載

## 🔗 関連ドキュメント

- [CodeRabbit 機能要件チェック設定ガイド](../coderabbit-functional-requirements-check.md) - 詳細な設定方法
- [.coderabbit.yaml](../../.coderabbit.yaml) - CodeRabbit設定ファイル
- [PRテンプレート](../../.github/pull_request_template.md) - PR作成時のテンプレート

## 💡 使い方の例

### 新機能「ステップアップガシャ」を実装する場合

1. **SDD v2ドキュメントを作成**
   ```bash
   /api:sdd-v2:00-run-full ステップアップガシャ
   ```

2. **要件を確認**
   - `docs/sdd-v2/features/ステップアップガシャ/01_要件調査.md` の「統合要件一覧」を参照
   - 要件ID（REQ-A-1, REQ-A-2, ...）を確認

3. **実装する**
   - 要件IDを意識しながら実装
   - 各要件が完全に実装されているか確認

4. **PRを作成**
   ```markdown
   ## 機能要件チェック

   ### SDD v2ドキュメント
   - [x] SDD v2ドキュメントが存在する: `docs/sdd-v2/features/ステップアップガシャ/`

   ### 機能要件の実装状況
   - [x] REQ-A-1: ステップ数の設定
   - [x] REQ-A-2: ステップ進行状態の管理
   - [x] REQ-A-3: ステップ遷移ロジック
   - [x] REQ-B-1: ステップごとのプリズム設定
   - [ ] REQ-B-2: 無料ステップの設定（次のPRで実装予定）
   ```

5. **CodeRabbitのレビューを確認**
   - 機能要件実装状況レポートを確認
   - 未実装の要件があれば対応、または理由を説明

## ❓ よくある質問

### Q: 統合要件一覧はどの程度詳細に書くべきか？

**A:** 実装時に参照できる程度の詳細さが望ましいです：

- ✅ 良い例：「ステップごとのプリズム設定」→ 実装者が何を実装すべきかわかる
- ❌ 悪い例：「プリズム」→ 何を実装すべきか不明確

### Q: 要件IDの命名規則は？

**A:** `REQ-{カテゴリアルファベット}-{番号}` の形式を推奨：

- REQ-A-1, REQ-A-2, ... （カテゴリA）
- REQ-B-1, REQ-B-2, ... （カテゴリB）

カテゴリは機能特性で分類します。

### Q: CodeRabbitが要件をチェックしない場合は？

**A:** 以下を確認してください：

1. `docs/sdd-v2/features/{機能名}/01_要件調査.md` が存在するか
2. 「統合要件一覧」セクションが正しく記載されているか
3. PRテンプレートの「機能要件チェック」セクションに情報が記載されているか
4. `.coderabbit.yaml` の設定が正しいか

詳細は [CodeRabbit 機能要件チェック設定ガイド](../coderabbit-functional-requirements-check.md#トラブルシューティング) を参照してください。

### Q: 既存機能の修正時にもSDD v2ドキュメントは必要か？

**A:** 以下の場合は必要です：

- 機能要件が変更される場合
- 新しい要件が追加される場合
- 既存の要件の解釈が変わる場合

軽微な修正（バグフィックス、リファクタリングなど）であれば不要です。

## 🎓 学習リソース

### SDD v2の設計フロー

各フェーズの詳細な説明は、実際の機能例（`features/`）を参照してください：

- [features/ステップアップガシャ/](features/ステップアップガシャ/) - SDD v2の実例

### CodeRabbit設定の詳細

- [CodeRabbit 機能要件チェック設定ガイド](../coderabbit-functional-requirements-check.md)
- [CodeRabbit公式ドキュメント](https://docs.coderabbit.ai/)

## 📞 お問い合わせ

SDD v2やCodeRabbit連携に関する質問や改善提案がある場合は、GitHubのIssueまたはPRでお知らせください。
