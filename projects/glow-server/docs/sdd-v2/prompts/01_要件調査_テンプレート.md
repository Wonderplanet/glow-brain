# Stage 1: 要件調査テンプレート

あなたはバックエンドエンジニアの API 開発スペシャリストです。
ゲーム体験仕様書（PDF）とコードベースを調査し、サーバー側で考慮すべき要件を包括的に抽出してください。

## 入力

1. **ゲーム体験仕様書**: `@docs/sdd/features/{FEATURE_NAME}/ゲーム体験仕様書.pdf`
2. **コードベース**: glow-server リポジトリ全体

## 出力

**ファイル名**: `docs/sdd/features/{FEATURE_NAME}/01_要件調査.md`

---

## 作業手順

### Step 1: PDF からのサーバー要件抽出

PDF（ゲーム体験仕様書）から「サーバー側で考慮すべき要件」を抽出します。

**抽出ルール:**
1. PDF の「どのページ」「どの箇所」に書かれていたかを明記
2. サーバー要件に該当するテキストを仕様書からそのまま抜粋
3. バックエンド/API の観点から「サーバー側で考慮が必要となるポイント」を1行で補足
4. 実装方針の断定（「APIが必要」「DB更新が必須」等）は禁止

**除外対象:**
- サーバー非依存のUI仕様
- アニメーション、画面遷移、演出内容
- ゲーム内ロジックの記述でも、サーバーが関与しないもの

### Step 2: コードベース調査

PDF から抽出した要件をもとに、コードベースを調査して以下を明らかにします：

**調査対象:**
- **API層**: Controller、Request、Response、ルーティング（`routes/api.php`）
- **ドメイン層**: Entity、Model、Repository、Service、UseCase
- **データベース**: Migration、既存テーブル構造
- **設定**: Config、Constants、Enum

**抽出すべき追加要件:**
- 仕様書に明示されていない暗黙の前提・制約
- 既存機能との連携・依存関係
- データ管理（保存・更新・削除の条件、状態遷移）
- 制約・検証（バリデーション、ビジネスルール）
- 非機能要件（パフォーマンス、セキュリティ）

**重要: コードベース調査結果の分類**

発見した内容を以下の3つに分類してください：

1. **確定要件**: PDF仕様書にも記載があり、既存実装と一致
   - PDF仕様書の記載と既存コードの両方で確認できる要件

2. **推定要件（要確認）**: PDF記載なしだが、既存実装から推測可能
   - **必ずプランナー確認項目に含める**
   - 既存コードから推測される動作だが、新機能では異なる可能性がある要件
   - 特に既存にない新しいゲームメカニクスでは要注意

3. **技術的制約**: 実装上の制約で、プランナー確認不要
   - データベース設計、トランザクション制御など純粋に技術的な制約

### Step 3: 要件の整理と統合

PDF 抽出要件とコード調査要件を統合し、重複を排除して体系的に整理します。

---

## 出力フォーマット

```markdown
# 要件調査

## 1. ドキュメント情報

- **対象機能**: {FEATURE_NAME}
- **作成日**: YYYY-MM-DD
- **入力ソース**:
  - ゲーム体験仕様書.pdf
  - glow-server コードベース

## 2. 機能概要

（この機能がユーザーに提供するゲーム体験の概要を簡潔に記述）

---

## 3. PDF からの要件抽出

### 要件 P-1: （要件の簡潔なタイトル）
- **元ページ**: Page X, 「〜〜」のセクション
- **抜粋**:
  > （仕様書に書かれていた原文そのまま）
- **サーバー観点での補足**:
  - （データ管理 / 状態管理 / 検証 / 記録など、サーバー側で考慮すべき点を記載）

### 要件 P-2: ...
（同様に続ける）

---

## 4. コード調査からの追加要件

### 4.1 既存実装との関連

| 発見箇所 | 既存実装 | 新機能との関連 |
|----------|----------|----------------|
| ファイルパス:行番号 | 既存クラス/メソッド | 参照/拡張/依存 など |

### 4.2 確定要件（PDF記載あり）

PDF仕様書にも記載があり、既存実装と一致する要件

### 要件 C-1: （要件の簡潔なタイトル）
- **分類**: 確定要件
- **発見箇所**: `path/to/file.php:123`
- **PDF出典**: Page X（要件 P-Y に対応）
- **コード内容**:
  ```php
  （関連するコードの抜粋）
  ```
- **追加要件の説明**:
  - （仕様書の記載と既存実装が一致していることを確認）

### 4.3 推定要件（要確認）

**PDF記載なしだが、既存実装から推測可能な要件。必ずプランナー確認が必要**

### 要件 C-X: （要件の簡潔なタイトル）【要確認】
- **分類**: 推定要件（要確認）
- **発見箇所**: `path/to/file.php:123`
- **既存実装**: （通常のステージクリアではどう実装されているか）
- **不明点**: （新機能ではどうすべきかが不明確な点）
  - A案: ...（既存実装に倣う場合）
  - B案: ...（新機能で異なる実装にする場合）
- **影響**: （この判断がどの要件に影響するか）
- **推奨**: プランナー確認項目に追加

### 4.4 技術的制約

実装上の制約で、プランナー確認不要な項目

### 要件 C-Z: （要件の簡潔なタイトル）
- **分類**: 技術的制約
- **発見箇所**: `path/to/file.php:123`
- **コード内容**:
  ```php
  （関連するコードの抜粋）
  ```
- **追加要件の説明**:
  - （技術的な実装詳細、プランナー確認不要な理由）

---

## 5. 統合要件一覧

### カテゴリ A: （適切なカテゴリ名）

| 要件ID | 要件タイトル | 出典 | 概要 |
|--------|-------------|------|------|
| REQ-A-1 | ... | PDF P-1 | ... |
| REQ-A-2 | ... | Code C-3 | ... |

### カテゴリ B: ...
（同様に続ける）

---

## 6. 不明点・曖昧な点

以下の点は、次のステップ（仕様確認）でプランナーに確認が必要です：

| No | 不明点 | 影響範囲 | 想定される選択肢 |
|----|--------|----------|------------------|
| 1 | ... | ... | A案/B案/... |
| 2 | ... | ... | ... |

---

## 7. 次のステップ

- [ ] 不明点についてプランナー/企画担当に確認
- [ ] 確認結果をもとに仕様確認ドキュメントを作成
```

---

## 重要な原則

1. **実装非依存**: 「何を実現するか」のみ記述。「どう実装するか」には言及しない
2. **中立性**: 実装方式を断定しない
3. **トレーサビリティ**: 各要件の出典（PDF ページ or コードファイル）を明記
4. **網羅性**: PDF とコード両方から要件を抽出
5. **API要件のみ**: 管理ツール(admin)の要件は対象外

---

## コードベース調査の注意事項

**これらのルールを厳守してください:**

### 1. PDF記載なしの仕様は全て「不明点」として扱う

- 既存コードがそうしているからといって、新機能でも同じとは限らない
- 特に既存にない新しいゲームメカニクスでは必ず確認
- 既存実装の発見 → 仕様の推測 → **プランナー確認（必須）**

### 2. 既存コードは参考情報であり、確定仕様ではない

- 既存実装は特定のユースケースに対する実装にすぎない
- 新機能では異なる仕様が必要な可能性を常に検討する
- コード発見から直接確定させず、「推定要件（要確認）」として分類

### 3. 実装方式の断定禁止

- 「〜すべき」「〜が正しい」といった断定表現は使用しない
- 「〜と推測される（要確認）」「〜の可能性がある」と記述
- A案/B案など複数の選択肢を提示する

### 4. 異なる概念の混同に注意

新機能で導入される概念とサーバー側の記録・管理は独立して設計すべき：
- **ゲーム体験上の動作**: PDF仕様書に明記されている動作
- **サーバー側の記録・管理**: データ記録やカウント方法（PDF記載なしの場合が多い）

→ これらは別の概念であり、独立して設計すべき
→ 一方から他方を安易に推論せず、それぞれ確認する

---

## カテゴリ分けのガイドライン

要件を論理的にグループ化するためのカテゴリ例：

- **データ管理**: ゲーム内データの管理、状態の記録
- **報酬・アイテム付与**: 報酬の計算、アイテムの付与
- **条件判定・検証**: 実行条件のチェック、不正検知
- **ゲームロジック**: ゲームルールの実装
- **通知・同期**: クライアントへの通知、データ同期
- **集計・ランキング**: データの集計、ランキング計算
- **イベント管理**: 期間限定イベント、スケジュール管理
- **課金・決済**: 課金処理、購入履歴
- **外部連携**: 他システムとの連携

---

以上を踏まえて、ゲーム体験仕様書とコードベースを調査し、
包括的な要件調査ドキュメントを作成してください。
