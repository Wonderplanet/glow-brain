# Stage 3: API設計書テンプレート

あなたはゲームサーバー/API 開発のスペシャリストです。

仕様確認結果を基に、実装可能な具体的なAPI設計書を作成してください。
**交換所のAPI設計書フォーマットに厳密に従い**、それ以上増やさず、それ以下に減らさずに作成してください。

## 参照テンプレート

**必ず以下のテンプレートを参照し、セクション構成・記載形式を完全に踏襲してください:**

@docs/sdd-v2/templates/API設計書_参考フォーマット.md

## 入力

1. **要件調査結果**: `@docs/sdd-v2/features/{FEATURE_NAME}/01_要件調査.md`
2. **仕様確認結果**: `@docs/sdd-v2/features/{FEATURE_NAME}/02_仕様確認.md`
3. **プランナー確認結果**: `@docs/sdd-v2/features/{FEATURE_NAME}/02_2_プランナー確認結果.md`
4. **glow-schema**: 既存API定義（YAML）
5. **コードベース**: 既存実装パターン

## 出力

**ファイル名**: `docs/sdd-v2/features/{FEATURE_NAME}/03_API設計書.md`

---

## 作業手順

### Step 1: 入力ドキュメントの統合

1. 要件調査と仕様確認結果を読み込む
2. 確定した仕様を整理する
3. 残存する不明点があれば記録する

### Step 2: 仕様書セクションの作成

1. **要点まとめ**を作成
   - 概要: 機能の概要を3-5文で記述
   - DB変更点: 新規追加テーブル、既存テーブルへの変更
   - API: 新規追加API、既存APIへの変更
2. **仕様確認**を作成
   - 参照ドキュメント: 既存実装コードのパス
   - 仕様ポイント: 表形式で項目と内容を整理

### Step 3: シーケンス図の作成

1. メインフローを1つのmermaid図で表現
2. participant は `Client`, `Server`, `DB` のみ使用
3. 正常系とエラー系の分岐を含める

### Step 4: エラー設計

1. 発生しうるエラーケースの洗い出し
2. 表形式で記載: エラーコード、新規フラグ、エラー内容、発生条件、クライアント挙動
3. エラーハンドリング方針を記載

### Step 5: API仕様

1. 各エンドポイントのリクエスト/レスポンス設計
2. パラメータ説明とバリデーション要件
3. レスポンス説明
4. 既存との互換性（該当する場合）

### Step 6: DB設計

1. マスタテーブル（mst_*）の設計
2. ユーザーテーブル（usr_*）の設計（TiDB最適化考慮）
3. ログテーブル（log_*）の設計

### Step 7: テーブル一覧

- DB設計で記載したテーブルを一覧表にまとめる

### Step 8: 実装上の注意点

- トランザクション制御等の重要事項を記載

### Step 9: テスト観点

- 単体テスト、機能テスト、シナリオテストを記載

---

## 出力フォーマット

**以下のセクション構成を厳密に守ってください。番号は付けないでください。**

```markdown
# {FEATURE_NAME} API設計書

## 目次

- [仕様書](#仕様書)
  - [要点まとめ](#要点まとめ)
  - [仕様確認](#仕様確認)
- [シーケンス図](#シーケンス図)
- [エラー設計](#エラー設計)
- [API仕様](#api仕様)
- [DB設計](#db設計)
  - [マスター/オペレーション](#マスターオペレーション)
  - [ユーザー](#ユーザー)
  - [ログ](#ログ)
- [テーブル一覧](#テーブル一覧)
- [実装上の注意点](#実装上の注意点)
- [テスト観点](#テスト観点)

---

## 仕様書

### 要点まとめ

#### 概要
（機能の概要を3-5文で記述）

#### DB変更点
- **新規追加:**
  - `テーブル名`: 説明
- **既存テーブルへの変更:**
  - なし / あれば記載

#### API
- **新規追加:**
  - `POST /api/xxx`: 説明
- **既存APIへの変更:**
  - なし / あれば記載

### 仕様確認

#### 参照ドキュメント
- 既存実装コード: `パス`

#### 仕様ポイント

| 項目 | 内容 |
|------|------|
| ... | ... |

---

## シーケンス図

### {フロー名}

```mermaid
sequenceDiagram
    participant Client
    participant Server
    participant DB
    ...
```

---

## エラー設計

> クラサバで必ず認識共有する。
> クライアント側で、実際にどんな挙動にすべきか、不明瞭な状態をなくして、
> 本番リリース後に、CS対応も含めハンドリングしやすい状態にしておきたいです。

### {機能名}関連エラー

| エラーコード | 新規 | エラー内容 | 発生条件 | クライアント挙動 |
|------------|------|----------|---------|---------------|
| `ErrorCode::XXX` | - | ... | ... | ... |
| `ErrorCode::YYY` | 新規 | ... | ... | ... |

**エラーハンドリング方針:**
- ...

---

## API仕様

### POST /api/xxx

（エンドポイントの説明）

#### request

```json
{
  ...
}
```

**パラメータ説明:**
- `param1` (string, required): 説明

**バリデーション:**
- ...

#### response

```json
{
  ...
}
```

**レスポンス説明:**
- `field1`: 説明

**既存との互換性:**
- ...（該当する場合のみ）

---

## DB設計

### マスター/オペレーション

#### mst_xxx（新規/既存改修）

（テーブルの説明）

| 列名 | index | データ型/制約 | 説明 |
|------|-------|---------------|------|
| ... | ... | ... | ... |

**追加カラムの説明:**（既存改修の場合）
- ...

**制約:**
- ...

---

### ユーザー

> ⚠️ PKの貼り方について、TiDB最適化の観点から以下の方針:
>
> **1ユーザーあたり1レコードのみのテーブル**
> - PK：usr_user_id
>
> **1ユーザーあたり複数レコードできるテーブル**
> - 複合PK：usr_user_id, ドメインID or マスタID

#### usr_xxx（新規）

（テーブルの説明）

| 列名 | index | データ型/制約 | 説明 |
|------|-------|---------------|------|
| ... | ... | ... | ... |

**利用箇所:**
- POST /api/xxx: ...

**設計上の注意:**
- ...

---

### ログ

#### log_xxx（新規）

（ログの説明）

| 列名 | index | データ型/制約 | 説明 |
|------|-------|---------------|------|
| ... | ... | ... | ... |

**ログ記録タイミング:**
- POST /api/xxx: ...

**{フィールド名}例:**
```json
{
  ...
}
```

---

## テーブル一覧

| テーブル名 | 新規/既存 | 概要 |
|-----------|----------|------|
| ... | ... | ... |

---

## 実装上の注意点

### {注意点タイトル}

- ...

---

## テスト観点

### 単体テスト
- ...

### 機能テスト
- POST /api/xxx: 正常系（...）
- POST /api/xxx: 異常系（...）

### シナリオテスト
1. ...
2. ...
```

---

## 重要な原則

1. **フォーマット厳守**: 参照テンプレートのセクション構成を厳密に守る
2. **番号なし**: 見出しに番号を付けない（「## 1. xxx」ではなく「## xxx」）
3. **一貫性**: 既存実装パターンを踏襲し、アーキテクチャの一貫性を保つ
4. **具体性**: 実装者が迷わず実装できるレベルの詳細度
5. **API要件のみ**: 管理ツール(admin)の設計は対象外

---

## 含めないセクション

以下のセクションは**含めないでください**:

- ドキュメント情報
- 機能概要（仕様書に統合）
- API全体像（API仕様に統合）
- 実装ガイド
- 実装チェックリスト
- 参考資料

---

## シーケンス図ガイドライン

**使用可能なparticipant:**
- `Client`: クライアントアプリ
- `Server`: サーバー全体
- `DB`: データベース
- `Memento`: キャッシュ層（必要な場合のみ）
- `ExternalAPI`: 外部サービス（必要な場合のみ）

**使用禁止:**
- 具体的なサービス名: `StageService`, `RewardService` など
- 具体的なクラス名: `StageController`, `UsrStageSession` など

---

## DB設計ガイドライン

**usrテーブル:**
- PRIMARY KEYには必ずusr_user_idを含める
- 複合キーの場合、usr_user_idを最初に

**logテーブル:**
- PRIMARY KEYはAUTO_INCREMENTのid
- usr_user_idとcreated_atの複合インデックス必須

**mstテーブル:**
- マスタIDをPRIMARY KEY
- 論理削除が必要ならdeleted_atカラム追加

---

以上を踏まえて、参照テンプレートに完全に従ったAPI設計書を作成してください。
