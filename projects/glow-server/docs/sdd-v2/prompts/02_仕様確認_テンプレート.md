# Stage 2: 仕様確認テンプレート

あなたはゲームサーバー/API 開発のスペシャリストです。

要件調査で洗い出された不明点・曖昧点をレビューし、
プランナーへの確認項目を整理した上で、確認結果を統合してください。

## 入力

1. **要件調査結果**: `@docs/sdd/features/{FEATURE_NAME}/01_要件調査.md`
2. **プランナー確認結果**: ユーザーから提供される

## 出力

1. **確認項目リスト（確認前）**: `docs/sdd/features/{FEATURE_NAME}/02_仕様確認.md`
2. **確認結果統合（確認後）**: `docs/sdd/features/{FEATURE_NAME}/02_2_プランナー確認結果.md`

---

## 作業手順

### Phase A: 仕様レビューと確認項目の洗い出し

#### Step 1: 要件調査結果の分析

`01_要件調査.md` を読み込み、以下の観点で問題点・曖昧さを洗い出します：

**分析観点:**
1. 仕様上の未定義部分
2. ゲーム体験とコード実装の乖離
3. サーバー側で曖昧な要件
4. 状態管理に関する不明点
5. 他機能との連携漏れ
6. セキュリティ/不正対策上の曖昧さ
7. UI との役割分担が不明な箇所
8. 実現性に問題がある仕様

#### Step 1.5: 確定要件のレビュー（重要）

**Stage 1で確定された要件に対して、以下の観点でダブルチェックを実施してください：**

この手順は、Stage 1で誤って確定された要件を検出するための重要なステップです。

**チェック観点:**

1. **PDF仕様書に記載がない要件はないか？**
   - コード調査のみを出典とする要件（「Code C-X」のみ）をリストアップ
   - それらが本当に確定要件として扱ってよいか再検討

2. **既存コードの動作を前提としているが、新機能では異なる可能性がある要件はないか？**
   - 特に既存にない新しいゲームメカニクスを導入する場合
   - 既存実装からの推論で確定させた要件を再チェック

3. **「推定要件（要確認）」として分類すべきものが、確定要件に含まれていないか？**
   - PDF記載なしの仕様が確定要件として扱われていないか
   - 実装方式を断定している要件はないか

**検出した問題のある要件は:**
- 「推定要件（要確認）」に再分類
- プランナー確認項目に追加

#### Step 2: プランナー確認項目の判断

> **重要**: プランナーへの確認項目は最小限に抑えてください。
> 技術的な選択肢はサーバーチームで決定し、プランナーの負担を減らすことが重要です。

**プランナー確認が必要なもの:**
- ユーザーが画面で見る挙動・表示が変わる仕様の不明点
- ゲームバランスに関わるパラメータ（上限値、回数制限、確率など）
- 他機能（ミッション、ショップ等）との連携の要否
- 仕様書に明確な矛盾がある場合の解釈

**プランナー確認が不要なもの（サーバーチームで決定可能）:**
- 既存実装パターンで解決できる技術的な選択肢
- 実装方法の詳細で、ゲーム体験に影響しないもの
- 既存の技術基盤・アーキテクチャに関する判断

**プランナー確認が絶対に不要なもの（具体例）:**
- データ保存方法の選択（固定値 vs マスタデータ、DB設計）
- APIエンドポイントのURL設計（既存API使用 vs 専用API作成）
- エラーハンドリングの技術的詳細
- エッジケース（発生確率が極めて低いケース）の処理方法
- パフォーマンス最適化の選択
- 既存実装パターンの踏襲方法
- トランザクション設計
- ログ出力の詳細
- レスポンスデータの構造設計

**判断フローチャート:**

```
1. この不明点が解消されないと、ユーザーが画面で見る挙動が変わるか？
   - No → サーバー決定可能（「3.2 サーバー側で決定可能な事項」へ）
   - Yes → 次へ

2. 既存の類似機能で同じパターンが実装されているか？
   - Yes → サーバー決定可能（既存パターン踏襲）
   - No → 次へ

3. プランナーが回答できる内容か？（技術的すぎないか）
   - No → サーバー決定可能
   - Yes → プランナー確認必要
```

#### Step 3: 確認項目リストの作成

プランナーへの確認項目を質問形式で整理します。

#### Step 3.5: 出力前の自己検証（必須）

**各確認項目について、以下を検証してください：**

| チェック項目 | Yes の場合 |
|-------------|-----------|
| この質問はプランナーが回答可能か？（技術的すぎないか） | No → 「3.2 サーバー側で決定可能な事項」へ移動 |
| この質問の回答でユーザーが画面で見る挙動が変わるか？ | No → 「3.2 サーバー側で決定可能な事項」へ移動 |
| 「3.2 サーバー側で決定可能な事項」と同じ性質の項目ではないか？ | Yes → 「3.2」へ移動 |
| 既存実装パターンで解決できないか確認したか？ | 解決可能 → 「3.2」へ移動 |

**1つでもNoがあれば、その項目は「3.2 サーバー側で決定可能な事項」に移動してください。**

---

### Phase B: 確認結果の統合（プランナー確認後）

#### Step 4: 確認結果の受け取り

ユーザーから提供されるプランナー確認結果を読み取ります：
- ゲーム企画担当者からの回答内容
- 確認日時や確認方法（分かれば）

#### Step 5: 解決状況の評価

各不明点について以下を判定：
- 完全に解決
- 部分的に解決
- 未解決

#### Step 6: 確定仕様の整理

確認結果をもとに確定した仕様を明確に記述します。

---

## 出力フォーマット

### 02_仕様確認.md（確認前）

```markdown
# 仕様確認

## 1. ドキュメント情報

- **対象機能**: {FEATURE_NAME}
- **作成日**: YYYY-MM-DD
- **入力ソース**: 01_要件調査.md

## 2. 要約

- 現時点での仕様の明瞭さ/不明瞭さの総評
- 大きなリスク・不確定要素の概要

---

## 3. 仕様の詳細化（サーバー観点）

サーバーが扱う仕様を、曖昧さを排除した形で統合して整理してください。

### 3.1 確定している仕様

| 項目 | 仕様内容 | 根拠 |
|------|----------|------|
| ... | ... | PDF P-X / Code C-Y |

### 3.2 サーバー側で決定可能な事項

| 項目 | 決定内容 | 理由 |
|------|----------|------|
| ... | 既存パターンに倣う | コード調査で既存実装を確認 |

---

## 4. 確定要件のレビュー結果

**Stage 1で確定された要件のダブルチェック結果**

### 4.1 問題が検出された要件

以下の要件は、Stage 1で確定要件として扱われたが、再検討の結果、プランナー確認が必要と判定：

| 要件ID | 要件タイトル | 問題点 | 再分類 |
|--------|-------------|--------|--------|
| REQ-X-Y | ... | PDF記載なし、既存実装からの推論のみ | 推定要件（要確認） |

### 4.2 確定要件として妥当と判断

以下の要件は確定要件として問題なし：

| 要件ID | 要件タイトル | 確定理由 |
|--------|-------------|----------|
| REQ-A-1 | ... | PDF P-X に明記、既存実装と一致 |

---

## 5. 不明点・曖昧点

### 5.1 仕様書に記載がなく判断不能な項目

- **項目名**
  - 該当箇所:
  - 何が曖昧なのか:
  - サーバーとして明確化が必要な理由:

### 5.2 仕様書とコードの不一致

- **項目名**
  - 該当ファイル:
  - どのように矛盾しているか:
  - 影響:

### 5.3 ゲーム体験的に不自然な可能性がある項目

- **項目名**
  - 問題点:
  - 想定される影響:

---

## 6. プランナーへ確認が必要な項目（質問リスト）

以下の項目についてプランナー/企画担当への確認が必要です：

**注意:** このセクションには「4.1 問題が検出された要件」で再分類された項目も含めてください。

### Q1: （質問タイトル）
- **背景**: （なぜこの質問が必要か）
- **質問内容**: 〜〜について、どちらの挙動を想定していますか？
- **選択肢（あれば）**:
  - A案: ...
  - B案: ...
- **影響範囲**: （この回答によってどの要件に影響があるか）

### Q2: ...
（同様に続ける）

---

## 7. サーバー開発への影響

- 実装前に必ず詰めるべき論点
- 不明点が残る場合のリスク
- スケジュール・品質への影響

---

## 8. 次のステップ

- [ ] プランナーへ確認項目を連絡
- [ ] 確認結果を受け取り次第、02_2_プランナー確認結果.md を作成
```

---

### 02_2_プランナー確認結果.md（確認後）

```markdown
# プランナー確認結果

## 1. 確認実施概要

- **確認日時**: YYYY-MM-DD
- **確認方法**: 口頭 / チャット / ドキュメント
- **確認者**: （ゲーム企画担当者名）

## 2. 確認結果サマリー

| 指標 | 数値 |
|------|------|
| 確認項目総数 | X 項目 |
| 完全に解決 | Y 項目 |
| 部分的に解決 | Z 項目 |
| 未解決 | W 項目 |

---

## 3. 各質問の確認結果

### Q1: （質問タイトル）

- **元の質問**: 〜〜について、どちらの挙動を想定していますか？
- **回答内容**: （プランナーからの回答を整理して記載）
- **解決状況**: 完全に解決 / 部分的に解決 / 未解決
- **確定した仕様**:
  - （回答をもとに確定した仕様を明確に記述）
- **備考**: （補足事項、追加で確認が必要な点など）

### Q2: ...
（同様に続ける）

---

## 4. 確定仕様一覧

確認結果を反映した最終的な仕様を整理します。

### 4.1 確定した要件

| 要件ID | 要件タイトル | 確定した仕様 | 確認元 |
|--------|-------------|-------------|--------|
| REQ-A-1 | ... | ... | Q1 |
| REQ-A-2 | ... | ... | Q3 |

### 4.2 変更・追加された要件

| 要件ID | 変更内容 | 理由 |
|--------|----------|------|
| ... | ... | Q2での確認結果 |

---

## 5. 残存する不明点

### 5.1 まだ不明な点

- **項目名**
  - 何が不明なのか:
  - 追加で確認すべき内容:

### 5.2 新たに発生した疑問点

- （確認結果を受けて新たに発生した疑問点）

---

## 6. 仕様確定度の評価

- **全体的な仕様確定度**: XX%
- **API実装に必要な仕様が全て揃っているか**: Yes / No
- **実装開始の可否**: 可 / 条件付き可 / 不可

---

## 7. 次のステップ

- [ ] 残存する不明点の追加確認（必要な場合）
- [ ] API設計書の作成（Stage 3へ進む）
```

---

## 重要な原則

1. **段階的な進行**: まず確認項目を洗い出し（Phase A）、確認後に結果を統合（Phase B）
2. **明確な分類**: プランナー確認が必要なものと不要なものを明確に区別
3. **トレーサビリティ**: 各確定仕様がどの確認結果から導かれたかを明記
4. **曖昧さの排除**: 確定した仕様は明確に、曖昧さを残さない表現で記述
5. **正直な評価**: 不明点が残っている場合は隠さずに明記

---

## 表現ポリシー

- 実装方針（APIの追加等）を「断定しない」
- 「仕様確定に必要な論点」の抽出に集中する
- 推測が含まれる場合は「推測」と明記する
- コード調査で「既存実装パターンの適用範囲に該当する」と記載されている場合、それを不明点として扱わない

---

以上を踏まえて、仕様レビューと確認結果の統合を実施してください。
