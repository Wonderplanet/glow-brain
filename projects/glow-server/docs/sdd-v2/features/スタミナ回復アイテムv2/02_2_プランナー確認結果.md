# プランナー確認結果

## 1. ドキュメント情報

- **対象機能**: スタミナ回復アイテムv2
- **作成日**: 2025-12-17
- **確認日**: 2025-12-17
- **入力ソース**: 02_仕様確認.md の質問項目（Q1〜Q6）

## 2. 確認結果サマリー

### 解決状況

| 質問ID | 質問タイトル | 回答状況 | 解決ステータス |
|--------|-------------|---------|---------------|
| Q1 | 既存スタミナ回復方法の上限変更範囲 | ✅ 回答あり | ✅ 解決 |
| Q2 | 既存スタミナ回復方法での部分回復の許容 | ✅ 回答あり | ✅ 解決 |
| Q3 | 部分回復時の確認ダイアログ表示タイミング | ✅ 回答あり | ✅ 解決 |
| Q4 | 複数個使用時の使用可能個数計算ロジック | ✅ 回答あり | ✅ 解決 |
| Q5 | スタミナ回復ダイアログ統一の実装方針 | ✅ 回答あり | ✅ 解決 |
| Q6 | スタミナドリンクの回復量バリエーション | ✅ 回答あり | ✅ 解決 |

**総合評価**: すべての不明点が解決し、API設計に必要な仕様が確定しました。

---

## 3. 各質問への回答詳細

### Q1: 既存スタミナ回復方法の上限変更範囲

**質問内容:**
> 既存の割合回復アイテム（スタミナボトル等）も、システム上限999まで回復可能に変更しますか？

**プランナー回答:**
> 含む（既存の割合回復アイテム（StaminaRecoveryPercent）も上限999に変更される）

**確定仕様:**
- すべてのスタミナ回復方法（固定値回復、割合回復、プリズム、広告）でシステム上限999まで回復可能
- 既存の割合回復アイテムの上限チェックロジックを変更する必要がある

**サーバー実装への影響:**
| 影響箇所 | 修正内容 |
|----------|----------|
| ItemStaminaRecoveryService.php | 割合回復のバリデーションでシステム上限999をチェック |
| UserBuyStaminaService.php | プリズム・広告回復のバリデーションでシステム上限999をチェック |

---

### Q2: 既存スタミナ回復方法での部分回復の許容

**質問内容:**
> プリズム購入、広告視聴、割合回復アイテムでも部分回復を許容しますか？

**プランナー回答:**
> 適用される（プリズム・広告・既存割合回復アイテムにも部分回復が適用される）

**確定仕様:**
- すべてのスタミナ回復方法で部分回復を許容
- スタミナが999の場合のみエラー（全切り捨て）
- 一部でも回復できる場合は回復を許可（例: 950 + 100 → 999、50回復）

**サーバー実装への影響:**
| 影響箇所 | 修正内容 |
|----------|----------|
| UserBuyStaminaService.calcAndValidateAddStamina() | システム上限超過時にエラーを投げず、min(beforeStamina + addStamina, 999) で計算 |
| UserBuyStaminaService.addStamina() | 実際の回復量を計算してレスポンスに含める |
| ItemStaminaRecoveryService.validateUsingStaminaRecoveryPercentItem() | 部分回復許容のバリデーションロジックに変更 |

---

### Q3: 部分回復時の確認ダイアログ表示タイミング

**質問内容:**
> 部分回復が発生する場合の確認ダイアログは、いつ表示しますか？

**プランナー回答:**
> 使用前にクライアント側の実装で対応してもらう。サーバー側では特に何もしない

**確定仕様:**
- 確認ダイアログの表示制御はクライアント側で実装
- サーバー側では、使用可能個数や回復量の情報を提供する必要はない（クライアント側で計算）
- APIレスポンスには実際の回復量を含める（事後確認用）

**サーバー実装への影響:**
| 影響箇所 | 修正内容 |
|----------|----------|
| APIレスポンス設計 | 実際の回復量（actualRecoveryAmount）をレスポンスに含める |
| 事前計算API | 不要（クライアント側でマスタデータから計算） |

---

### Q4: 複数個使用時の使用可能個数計算ロジック

**質問内容:**
> スタミナ950でスタミナドリンク100を所持している場合、使用可能個数は何個ですか？

**プランナー回答:**
> 部分回復許容のため1個使用可、49だけ回復して999になる。51は切り捨て。このケースで2個は使えない。2個使おうとした場合はサーバーエラーを出す

**確定仕様:**
- 使用可能個数 = `floor((999 - currentStamina) / recoveryAmount)` で計算
- 例: スタミナ950、ドリンク100の場合
  - (999 - 950) / 100 = 0.49... → floor = 0個
  - ただし、部分回復許容のため1個は使用可能
  - **結論**: `max(1, floor((999 - currentStamina) / recoveryAmount))` （ただしスタミナが999の場合は0個）
- 2個以上使おうとした場合は INVALID_PARAMETER エラー

**サーバー実装への影響:**
| 影響箇所 | 修正内容 |
|----------|----------|
| ItemStaminaRecoveryService.validateUsingStaminaRecoveryFixedItem() | 使用可能個数のバリデーションロジック実装 |
| バリデーション計算式 | `amount <= max(1, floor((999 - currentStamina) / recoveryAmount))` かつ `currentStamina < 999` |

**補足説明:**
- スタミナ950でドリンク100を1個使用 → 950 + 100 = 1050、999でカット → 実際は49回復
- スタミナ950でドリンク100を2個使用 → 950 + 200 = 1150、999でカット → 実際は49回復（1個使用と同じ）
  - この場合、2個目は完全に無駄になるため、サーバーエラーで拒否
- 部分回復許容は「一部でも回復できる場合」に限定され、「回復量がゼロになる個数」は拒否

---

### Q5: スタミナ回復ダイアログ統一の実装方針

**質問内容:**
> スタミナ回復ダイアログに表示する情報は、どのように取得しますか？

**プランナー回答:**
> サーバー対応は不要。クライアント側にダウンロードされているマスタデータから取得してもらう。

**確定仕様:**
- スタミナ回復一覧APIは不要
- クライアント側で既存のマスタデータとユーザー所持アイテム情報から構築
- サーバー側では既存APIのみで対応

**サーバー実装への影響:**
| 影響箇所 | 修正内容 |
|----------|----------|
| 新規API | 不要 |
| 既存API | 変更なし |

---

### Q6: スタミナドリンクの回復量バリエーション

**質問内容:**
> スタミナドリンクの回復量は、10、50、100以外の値（例: 5、25、200等）も設定可能としますか？

**プランナー回答:**
> 予定あり（今後、任意の回復量のドリンクを追加する可能性がある）

**確定仕様:**
- effect_valueには任意の整数値を設定可能
- サーバー側では特定の値に限定せず、effect_valueをそのまま使用する設計
- バリデーションは範囲チェックのみ（1以上、999以下など）

**サーバー実装への影響:**
| 影響箇所 | 修正内容 |
|----------|----------|
| マスタデータ設計 | effect_valueに任意の整数値を許可 |
| バリデーション | 特定値のホワイトリストチェックは不要 |

---

## 4. 確定した仕様の統合

### 4.1 すべてのスタミナ回復方法の統一仕様

プランナー確認の結果、以下の仕様がすべてのスタミナ回復方法（固定値回復、割合回復、プリズム、広告）で統一されることが確定しました。

| 仕様項目 | 確定内容 | 影響範囲 |
|----------|----------|----------|
| システム上限 | 999まで回復可能 | すべての回復方法 |
| ユーザー上限の超過 | ユーザー上限を超えてもシステム上限999まで回復可能 | すべての回復方法 |
| 部分回復の許容 | 一部でも回復できる場合は回復を許可 | すべての回復方法 |
| 全切り捨て時のエラー | スタミナが999の場合は使用不可エラー | すべての回復方法 |

### 4.2 固定値回復アイテム固有の仕様

| 仕様項目 | 確定内容 |
|----------|----------|
| アイテム種別名 | StaminaRecoveryFixed（サーバー側で決定） |
| 回復量の設定 | effect_valueに任意の整数値（1〜999）を設定可能 |
| 複数個使用 | 1回のAPI呼び出しで複数個使用可能 |
| 使用可能個数の計算 | `max(1, floor((999 - currentStamina) / recoveryAmount))` ただしスタミナが999の場合は0個 |
| 使用可能個数超過時 | INVALID_PARAMETERエラー |

### 4.3 複数個使用時のバリデーション詳細

**使用可能個数の計算ロジック:**
```php
// スタミナが999の場合は使用不可
if ($currentStamina >= 999) {
    $maxUsableAmount = 0;
} else {
    // 部分回復許容のため、最低1個は使用可能
    $maxUsableAmount = max(1, floor((999 - $currentStamina) / $recoveryAmount));
}
```

**具体例:**
| 現在スタミナ | ドリンク回復量 | 使用可能個数 | 計算式 |
|-------------|--------------|-------------|--------|
| 999 | 100 | 0個 | 全切り捨てのためエラー |
| 950 | 100 | 1個 | max(1, floor((999-950)/100)) = max(1, 0) = 1 |
| 900 | 100 | 1個 | max(1, floor((999-900)/100)) = max(1, 0) = 1 |
| 899 | 100 | 1個 | max(1, floor((999-899)/100)) = max(1, 1) = 1 |
| 800 | 100 | 1個 | max(1, floor((999-800)/100)) = max(1, 1) = 1 |
| 500 | 100 | 4個 | max(1, floor((999-500)/100)) = max(1, 4) = 4 |
| 10 | 100 | 9個 | max(1, floor((999-10)/100)) = max(1, 9) = 9 |

**2個以上使用時の挙動:**
- スタミナ950でドリンク100を1個使用: 950 + 100 = 1050 → 999でカット（49回復、51切り捨て）→ 許可
- スタミナ950でドリンク100を2個使用: 950 + 200 = 1150 → 999でカット（49回復、151切り捨て）→ **拒否**（2個目が完全に無駄）

### 4.4 既存実装の修正範囲

プランナー確認の結果、以下の既存実装の修正が必要と確定しました。

| 修正箇所 | 修正内容 | 理由 |
|----------|----------|------|
| UserBuyStaminaService.calcAndValidateAddStamina() | システム上限999でチェック、部分回復許容 | Q1, Q2の回答（すべての回復方法で統一） |
| UserBuyStaminaService.addStamina() | 実際の回復量を計算してレスポンスに含める | Q3の回答（事後確認用） |
| ItemStaminaRecoveryService.applyStaminaRecoveryPercent() | システム上限999でチェック、部分回復許容 | Q1, Q2の回答（すべての回復方法で統一） |
| ItemStaminaRecoveryService.validateUsingStaminaRecoveryPercentItem() | 部分回復許容のバリデーションロジックに変更 | Q2の回答（すべての回復方法で統一） |

---

## 5. 残存する不明点・要確認事項

### 5.1 追加で確認が必要な項目

該当なし。すべての不明点が解決しました。

### 5.2 技術的検討が必要な項目

以下の項目は、プランナー確認は不要だが、サーバー実装時に技術的な検討が必要です。

| 項目 | 検討内容 |
|------|----------|
| 実際の回復量の計算タイミング | UseCaseで計算するか、Serviceで計算するか |
| 既存実装の互換性保持 | 割合回復アイテムの既存挙動との互換性をどう保つか |
| トランザクション管理 | アイテム消費とスタミナ加算の同一トランザクション処理 |

---

## 6. API設計への影響

### 6.1 新規実装が必要な項目

| 項目 | 内容 |
|------|------|
| ItemType.StaminaRecoveryFixed | 新しいアイテム種別の追加 |
| ItemStaminaRecoveryService.applyStaminaRecoveryFixed() | 固定値回復専用のサービスメソッド |
| ItemStaminaRecoveryService.validateUsingStaminaRecoveryFixedItem() | 固定値回復のバリデーションメソッド |
| glow-schema Item.yml | StaminaRecoveryFixed種別の定義 |
| マイグレーション | mst_items.type enumにStaminaRecoveryFixedを追加 |

### 6.2 既存実装の修正が必要な項目

| 項目 | 修正内容 |
|------|----------|
| UserBuyStaminaService.calcAndValidateAddStamina() | システム上限999でチェック、部分回復許容 |
| UserBuyStaminaService.addStamina() | 実際の回復量をレスポンスに含める |
| ItemStaminaRecoveryService.applyStaminaRecoveryPercent() | システム上限999でチェック、部分回復許容 |
| ItemStaminaRecoveryService.validateUsingStaminaRecoveryPercentItem() | 部分回復許容のバリデーションロジック |

### 6.3 新規実装が不要な項目

| 項目 | 理由 |
|------|------|
| スタミナ回復一覧API | クライアント側でマスタデータから構築（Q5の回答） |
| 使用可能個数の事前計算API | クライアント側でマスタデータから計算（Q3の回答） |

---

## 7. 次のステップ

- [ ] 確定した仕様をもとにAPI設計書（Stage 3）を作成
- [ ] 既存実装の修正範囲を精査し、影響範囲を確定
- [ ] glow-schemaにStaminaRecoveryFixed種別を追加
- [ ] マスタデータ設定（スタミナドリンク10、50、100）の準備

---

## 8. 確認履歴

| 確認項目 | 質問日 | 回答日 | 確認者 |
|----------|--------|--------|--------|
| Q1〜Q6 | 2025-12-17 | 2025-12-17 | プランナー |
