# 仕様確認

## 1. ドキュメント情報

- **対象機能**: スタミナ回復アイテムv2
- **作成日**: 2025-12-17
- **入力ソース**: 01_要件調査.md

## 2. 要約

**仕様の明瞭さ:**
- ゲーム体験仕様書（PDF）には、固定値回復アイテムの基本的な挙動（回復計算式、オーバーフロー、使用制限）が明記されている
- 追加確認事項により、システム上限999への統一と部分回復の許容が明確化されている
- 既存のスタミナ回復実装（割合回復、プリズム、広告）が存在し、参考パターンとして活用可能

**不明瞭な点:**
- 固定値回復アイテムの種別定義がマスタデータレベルで未定義
- 部分回復時のクライアント通知方法が不明
- スタミナ回復ダイアログ統一に伴うAPI要件が曖昧

**大きなリスク:**
- 既存実装（プリズム・広告・割合回復アイテム）の上限変更範囲が不明確
- 複数個使用時のバリデーションロジックとクライアント側ボタン制御の連携が詳細不明

---

## 3. 仕様の詳細化（サーバー観点）

### 3.1 確定している仕様

| 項目 | 仕様内容 | 根拠 |
|------|----------|------|
| システム上限値 | スタミナの絶対上限は999。すべてのスタミナ回復方法でこの上限を超えることはできない | PDF P-5, Code C-1 |
| 固定値回復の計算式 | 回復量 = アイテムのeffect_value（そのまま加算） | PDF P-2 |
| オーバーフロー許可 | ユーザーのスタミナ上限値（レベル依存）を超えてもシステム上限999までスタミナを保持可能 | PDF P-3, P-8 |
| システム上限超過時の切り捨て | 回復後にスタミナが999を超える場合、超過分は切り捨て | PDF P-2, P-8 |
| 部分回復の許容 | 一部でも回復できる場合は回復を許可（例: 901+100→999、98回復） | PDF P-13 |
| 全切り捨て時のエラー | スタミナが999の状態で回復しようとした場合はエラー（回復不可） | PDF P-13 |
| アイテム所持数0のエラー | アイテム所持数が0個の場合は使用不可 | PDF P-4 |
| 複数個使用 | スタミナドリンクは1回のAPI呼び出しで複数個同時使用可能 | PDF P-7 |
| 使用個数選択UI | 使用個数は±1と最大・最小ボタンで選択可能、デフォルトは1 | PDF P-7 |
| 割合回復アイテムの継続 | 既存の割合回復（StaminaRecoveryPercent）は削除せず継続サポート | PDF P-14 |
| 自然回復の事前適用 | アイテム使用前に自然回復を適用してから回復処理を実行 | Code C-4 |
| アイテム消費ログ | アイテム消費時にStaminaRecoveryLogTriggerでログ記録 | Code C-11 |
| エラーコード定義 | USER_STAMINA_FULL、USER_STAMINA_EXCEEDS_LIMITの既存エラーコードを活用 | Code C-2 |

### 3.2 サーバー側で決定可能な事項

| 項目 | 決定内容 | 理由 |
|------|----------|------|
| 固定値回復アイテムの種別名 | `StaminaRecoveryFixed` を新規ItemTypeとして追加 | 既存パターン（StaminaRecoveryPercent）との一貫性を保ち、割合回復と固定値回復を明確に区別するため |
| effect_valueの格納形式 | 固定値を文字列として格納（例: "10", "100"） | 既存のmst_items.effect_valueカラムの型に合わせる（varchar(255)） |
| 部分回復時の実際の回復量計算 | `min(beforeStamina + requestedAmount, 999)` で計算 | システム上限999を超えないよう切り捨て処理を実装 |
| 部分回復時のレスポンス | 実際の回復量（actualRecoveryAmount）をレスポンスに含める | クライアント側で切り捨て発生を認識できるようにする |
| 複数個使用時のトランザクション | アイテム消費とスタミナ加算を同一トランザクション内で実行 | 既存実装パターンに倣い、データ整合性を保証 |
| アイテム消費とログ記録 | UsrItemService::consumeItemで消費、StaminaRecoveryLogTriggerでログ記録 | 既存の割合回復実装と同じパターンを踏襲 |
| glow-schema定義 | Item.ymlにStaminaRecoveryFixed種別を追加 | 既存のStaminaRecoveryPercent追加時と同じ手順 |
| マイグレーション | mst_itemsテーブルのtype enumにStaminaRecoveryFixedを追加 | 既存のenum拡張パターンを踏襲 |

---

## 4. 確定要件のレビュー結果

### 4.1 問題が検出された要件

以下の要件は、Stage 1で確定要件として扱われたが、再検討の結果、プランナー確認が必要と判定：

| 要件ID | 要件タイトル | 問題点 | 再分類 |
|--------|-------------|--------|--------|
| REQ-E-1 | プリズム回復の上限変更 | PDF P-12には「プリズム、広告視聴の上限をシステム上限999に変更」とあるが、既存実装の挙動変更範囲が不明確 | 推定要件（要確認） |
| REQ-E-2 | 広告回復の上限変更 | 同上 | 推定要件（要確認） |
| REQ-E-3 | プリズム・広告での部分回復 | PDF P-13には固定値アイテムの例のみで、プリズム・広告にも適用するか明記なし | 推定要件（要確認） |
| REQ-C-6 | 既存の割合回復アイテムの上限変更（要件C-6） | PDF記載なし、追加確認事項にも明示なし | 推定要件（要確認） |

### 4.2 確定要件として妥当と判断

以下の要件は確定要件として問題なし：

| 要件ID | 要件タイトル | 確定理由 |
|--------|-------------|----------|
| REQ-C-1 | システム上限999の定義 | PDF P-5に明記、Code C-1で定数確認 |
| REQ-C-2 | ユーザー上限の超過許可 | PDF P-3, P-8に明記 |
| REQ-C-3 | システム上限999の厳守 | PDF P-2, P-8に明記 |
| REQ-C-4 | 部分回復の許容 | PDF P-13に明記（901+100の例） |
| REQ-C-5 | 全切り捨て時のエラー | PDF P-13に明記 |
| REQ-A-2 | 割合回復アイテムの継続サポート | PDF P-14（追加確認事項）に明記 |
| REQ-B-3 | 自然回復の事前適用 | 既存実装パターン（Code C-4）で確認、暗黙の前提として妥当 |

---

## 5. 不明点・曖昧点

### 5.1 仕様書に記載がなく判断不能な項目

#### (1) 既存スタミナ回復方法（プリズム・広告・割合回復アイテム）の上限変更範囲

- **該当箇所**: 追加確認事項「プリズム、広告視聴のスタミナ回復の上限もシステム上限999に変更」
- **何が曖昧なのか**:
  - プリズム・広告の上限変更は明記されているが、既存の割合回復アイテムの扱いが不明
  - これら既存機能でも「部分回復の許容」を適用するのか不明
- **サーバーとして明確化が必要な理由**:
  - UserBuyStaminaServiceの修正範囲を確定する必要がある
  - 既存機能の挙動変更はユーザー体験に影響するため、慎重な確認が必要

#### (2) 部分回復時のクライアント側通知方法

- **該当箇所**: PDF P-2「切り捨てになるパターンでは、確認ダイアログを表示するようにする」
- **何が曖昧なのか**:
  - 確認ダイアログは事前（使用前）に表示するのか、事後（使用後）に表示するのか
  - サーバーからクライアントへどのような情報を返すべきか（実際の回復量、切り捨て量、フラグ等）
- **サーバーとして明確化が必要な理由**:
  - APIレスポンス設計に影響
  - クライアント側の実装方針との整合性確保

#### (3) 複数個使用時の使用可能個数計算の境界条件

- **該当箇所**: PDF P-9「所持しているスタミナドリンクが0になるまでかつスタミナ最大所持上限の999まで」
- **何が曖昧なのか**:
  - 「999まで」は999ちょうどまでか、999を超えない範囲か
  - 例: スタミナ950でドリンク100を持っている場合、使用可能個数は0個か1個か
    - 0個解釈: 950+100=1050で999を超えるため使用不可
    - 1個解釈: 部分回復許容のため1個使用可（950→999）
- **サーバーとして明確化が必要な理由**:
  - バリデーションロジックの実装方針を確定する必要がある
  - クライアント側の±1ボタン、最大ボタンのグレーアウト制御と整合させる

#### (4) スタミナ回復ダイアログ統一に伴うAPI要件

- **該当箇所**: PDF P-6「スタミナ回復可能なアイテム、方法（広告視聴）など回復方法と所持リソースを全て表示する」
- **何が曖昧なのか**:
  - サーバー側で専用の一覧取得APIを提供するのか、クライアント側でマスタデータから構築するのか
  - 各回復方法の実行可否判定（残り回数、所持数など）をサーバー側で行うのか
- **サーバーとして明確化が必要な理由**:
  - 新規APIエンドポイント追加の要否を判断する必要がある
  - クライアント側の実装方針を確認してから設計すべき

### 5.2 仕様書とコードの不一致

該当なし。既存実装は割合回復のみで、固定値回復は新規実装のため矛盾なし。

### 5.3 ゲーム体験的に不自然な可能性がある項目

#### (1) スタミナドリンクの回復量バリエーション

- **問題点**: 仕様書にはスタミナドリンク10、50、100が記載されているが、他の値（例: 5、25、200）も設定可能か不明
- **想定される影響**: マスタデータ設定の自由度が不明確。将来の拡張性に影響

---

## 6. プランナーへ確認が必要な項目（質問リスト）

### Q1: 既存スタミナ回復方法の上限変更範囲

- **背景**: 追加確認事項には「プリズム、広告視聴の上限をシステム上限999に変更」とありますが、既存の割合回復アイテム（スタミナボトル等）の扱いが明記されていません
- **質問内容**: 既存の割合回復アイテムも、システム上限999まで回復可能に変更しますか？
- **選択肢**:
  - A案: 割合回復アイテムもシステム上限999まで回復可能に変更（新仕様に統一）
  - B案: 割合回復アイテムは従来通りユーザー上限（レベル依存）まで（挙動維持）
- **影響範囲**: REQ-C-6、既存ItemStaminaRecoveryServiceの修正要否

### Q2: 既存スタミナ回復方法での部分回復の許容

- **背景**: 追加確認事項には固定値アイテムの部分回復許容（901+100→999）が記載されていますが、プリズム・広告・割合回復アイテムでも同様に部分回復を許容するか明記されていません
- **質問内容**: プリズム購入、広告視聴、割合回復アイテムでも部分回復を許容しますか？
- **選択肢**:
  - A案: すべてのスタミナ回復方法で部分回復を許容（統一仕様）
  - B案: 固定値アイテムのみ部分回復許容、既存機能は従来通り（挙動維持）
- **影響範囲**: REQ-E-3、UserBuyStaminaServiceの修正範囲

### Q3: 部分回復時の確認ダイアログ表示タイミング

- **背景**: PDF P-2に「切り捨てになるパターンでは、確認ダイアログを表示する」とありますが、表示タイミングが不明です
- **質問内容**: 部分回復が発生する場合の確認ダイアログは、いつ表示しますか？
- **選択肢**:
  - A案: 使用前に確認ダイアログを表示（例: 「98回復しますが、2は切り捨てられます。使用しますか？」）
  - B案: 使用後に結果ダイアログを表示（例: 「98回復しました（2は切り捨て）」）
  - C案: 確認ダイアログなし、サーバーで自動的に部分回復を実行
- **影響範囲**: REQ-G-3、APIレスポンス設計

### Q4: 複数個使用時の使用可能個数計算ロジック

- **背景**: PDF P-9に「スタミナ最大所持上限の999まで」とありますが、部分回復許容との組み合わせで境界条件が曖昧です
- **質問内容**: スタミナ950でスタミナドリンク100を所持している場合、使用可能個数は何個ですか？
- **選択肢**:
  - A案: 0個（950+100=1050で999を超えるため使用不可、最大ボタンはグレーアウト）
  - B案: 1個（部分回復許容のため1個使用可、50回復して999になる）
- **影響範囲**: REQ-D-3、複数個使用時のバリデーションロジック、クライアント側ボタン制御

### Q5: スタミナ回復ダイアログ統一の実装方針

- **背景**: PDF P-6に「スタミナ回復可能なアイテム、方法を全て表示する」とありますが、データ取得方法が不明です
- **質問内容**: スタミナ回復ダイアログに表示する情報は、どのように取得しますか？
- **選択肢**:
  - A案: サーバー側で専用の一覧取得APIを提供（実行可否判定も含む）
  - B案: クライアント側で既存API（アイテム一覧、ユーザー情報等）から構築
- **影響範囲**: REQ-G-1、新規APIエンドポイント追加の要否

### Q6: スタミナドリンクの回復量バリエーション

- **背景**: 仕様書にはスタミナドリンク10、50、100が記載されていますが、将来的に他の値を追加する可能性があるか不明です
- **質問内容**: スタミナドリンクの回復量は、10、50、100以外の値（例: 5、25、200等）も設定可能としますか？
- **選択肢**:
  - A案: 任意の値を設定可能（マスタデータで柔軟に設定）
  - B案: 10、50、100のみに限定（将来的にも固定）
- **影響範囲**: マスタデータ設計、バリデーションロジック

---

## 7. サーバー開発への影響

### 実装前に必ず詰めるべき論点

1. **既存機能の挙動変更範囲**: プリズム・広告・割合回復アイテムの上限変更と部分回復許容の適用範囲を確定する必要がある（Q1, Q2）
2. **複数個使用時のバリデーション**: 使用可能個数計算ロジックを確定しないと、クライアント側ボタン制御と整合性が取れない（Q4）
3. **部分回復時のUI連携**: 確認ダイアログの表示タイミングとAPIレスポンス設計を確定する必要がある（Q3）

### 不明点が残る場合のリスク

- **既存機能への影響**: プリズム・広告回復の挙動変更範囲が不明確な場合、既存ユーザーの体験が変わる可能性があり、リスクが高い
- **クライアント連携**: 部分回復時の通知方法とボタン制御が不明確な場合、クライアント側実装との齟齬が発生する
- **データ整合性**: 使用可能個数のバリデーションが不明確な場合、不正な状態でアイテムが消費されるリスクがある

### スケジュール・品質への影響

- **影響度**: 中
- **理由**:
  - 固定値回復アイテム自体の実装は既存パターンを踏襲できるため実装難易度は低い
  - しかし、既存機能（プリズム・広告・割合回復）への影響範囲が不明確なため、修正範囲の見積もりに不確実性がある
  - プランナー確認結果によっては、既存実装の大幅な修正が必要になる可能性がある

---

## 8. 次のステップ

- [ ] プランナーへ確認項目（Q1〜Q6）を連絡
- [ ] 確認結果を受け取り次第、02_2_プランナー確認結果.md を作成
- [ ] 確定した仕様をもとにAPI設計書（Stage 3）を作成
