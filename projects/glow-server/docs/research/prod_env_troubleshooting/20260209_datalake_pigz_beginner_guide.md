# pigzå…¥é–€ã‚¬ã‚¤ãƒ‰

## ç›®æ¬¡

1. [pigzã¨ã¯](#pigzã¨ã¯)
2. [gzipã¨ã®é•ã„](#gzipã¨ã®é•ã„)
3. [ãªãœpigzã¯é«˜é€Ÿãªã®ã‹](#ãªãœpigzã¯é«˜é€Ÿãªã®ã‹)
4. [åŸºæœ¬çš„ãªä½¿ã„æ–¹](#åŸºæœ¬çš„ãªä½¿ã„æ–¹)
5. [ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®åˆ¶å¾¡](#ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®åˆ¶å¾¡)
6. [å®Ÿè·µä¾‹](#å®Ÿè·µä¾‹)
7. [æ³¨æ„ç‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#æ³¨æ„ç‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)

---

## pigzã¨ã¯

**pigz** = **P**arallel **I**mplementation of **GZ**ip

pigzã¯ã€gzipã®ä¸¦åˆ—å®Ÿè£…ç‰ˆã§ã™ã€‚å¾“æ¥ã®gzipã¨å®Œå…¨ã«äº’æ›æ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€**ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰** ã‚’ä½¿ã£ã¦åœ§ç¸®ãƒ»è§£å‡ã‚’é«˜é€ŸåŒ–ã—ã¾ã™ã€‚

### ç‰¹å¾´

- âœ… **gzipå®Œå…¨äº’æ›**: æ—¢å­˜ã®gzipãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ãˆã‚‹
- âœ… **é«˜é€Ÿ**: ãƒãƒ«ãƒã‚³ã‚¢CPUã‚’æ´»ç”¨ã—ã¦ä¸¦åˆ—å‡¦ç†
- âœ… **åŒã˜å“è³ª**: åœ§ç¸®ç‡ã¯gzipã¨åŒç­‰
- âœ… **ã‚³ãƒãƒ³ãƒ‰ã‚‚åŒã˜**: gzipã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒãã®ã¾ã¾ä½¿ãˆã‚‹

---

## gzipã¨ã®é•ã„

### gzip: ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰

```mermaid
graph LR
    Input[ğŸ“„ å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«] --> CPU1[ğŸ§‘â€ğŸ³ CPU1ã§åœ§ç¸®]
    CPU1 --> Output[ğŸ“¦ åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«]

    CPU2[ğŸ’¤ CPU2 ã‚¢ã‚¤ãƒ‰ãƒ«]
    CPU3[ğŸ’¤ CPU3 ã‚¢ã‚¤ãƒ‰ãƒ«]
    CPU4[ğŸ’¤ CPU4 ã‚¢ã‚¤ãƒ‰ãƒ«]

    style CPU2 fill:#e0e0e0
    style CPU3 fill:#e0e0e0
    style CPU4 fill:#e0e0e0
```

**gzipã®ç‰¹å¾´:**
- 1ã¤ã®CPUã‚³ã‚¢ã—ã‹ä½¿ã‚ãªã„
- ä»–ã®ã‚³ã‚¢ã¯éŠã‚“ã§ã„ã‚‹
- å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹

### pigz: ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰

```mermaid
graph TB
    Input[ğŸ“„ å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«] --> Split[åˆ†å‰²]

    Split --> Block1[ãƒ–ãƒ­ãƒƒã‚¯1]
    Split --> Block2[ãƒ–ãƒ­ãƒƒã‚¯2]
    Split --> Block3[ãƒ–ãƒ­ãƒƒã‚¯3]
    Split --> Block4[ãƒ–ãƒ­ãƒƒã‚¯4]

    Block1 --> CPU1[ğŸ§‘â€ğŸ³ CPU1ã§åœ§ç¸®]
    Block2 --> CPU2[ğŸ§‘â€ğŸ³ CPU2ã§åœ§ç¸®]
    Block3 --> CPU3[ğŸ§‘â€ğŸ³ CPU3ã§åœ§ç¸®]
    Block4 --> CPU4[ğŸ§‘â€ğŸ³ CPU4ã§åœ§ç¸®]

    CPU1 --> Merge[çµåˆ]
    CPU2 --> Merge
    CPU3 --> Merge
    CPU4 --> Merge

    Merge --> Output[ğŸ“¦ åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«]

    style CPU1 fill:#ffcccc
    style CPU2 fill:#ffcccc
    style CPU3 fill:#ffcccc
    style CPU4 fill:#ffcccc
```

**pigzã®ç‰¹å¾´:**
- è¤‡æ•°ã®CPUã‚³ã‚¢ã‚’åŒæ™‚ã«ä½¿ã†
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å°ã•ãªãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†å‰²ã—ã¦ä¸¦åˆ—åœ§ç¸®
- å‡¦ç†ãŒé«˜é€Ÿ

### æ€§èƒ½æ¯”è¼ƒ

| ãƒ„ãƒ¼ãƒ« | ä½¿ç”¨ã‚³ã‚¢ | 1GBãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®æ™‚é–“ï¼ˆä¾‹ï¼‰ | CPUä½¿ç”¨ç‡ |
|-------|---------|----------------------|----------|
| **gzip** | 1ã‚³ã‚¢ | 60ç§’ | 12.5%ï¼ˆ8ã‚³ã‚¢ä¸­1ã‚³ã‚¢ï¼‰ |
| **pigzï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰** | 8ã‚³ã‚¢ | 10ç§’ | 100%ï¼ˆ8ã‚³ã‚¢å…¨ã¦ï¼‰ |
| **pigz -p 2** | 2ã‚³ã‚¢ | 30ç§’ | 25%ï¼ˆ8ã‚³ã‚¢ä¸­2ã‚³ã‚¢ï¼‰ |

**çµè«–: pigzã¯gzipã‚ˆã‚Š5ï½6å€é€Ÿã„ï¼**

---

## ãªãœpigzã¯é«˜é€Ÿãªã®ã‹

### ä¸¦åˆ—å‡¦ç†ã®ä»•çµ„ã¿

pigzã¯å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å°ã•ãªãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ128KBï¼‰ã«åˆ†å‰²ã—ã€å„ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç‹¬ç«‹ã—ã¦åœ§ç¸®ã—ã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant File as å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«
    participant Main as ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰
    participant T1 as ã‚¹ãƒ¬ãƒƒãƒ‰1
    participant T2 as ã‚¹ãƒ¬ãƒƒãƒ‰2
    participant T3 as ã‚¹ãƒ¬ãƒƒãƒ‰3
    participant T4 as ã‚¹ãƒ¬ãƒƒãƒ‰4
    participant Output as å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«

    File->>Main: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    Main->>T1: ãƒ–ãƒ­ãƒƒã‚¯1ã‚’åœ§ç¸®
    Main->>T2: ãƒ–ãƒ­ãƒƒã‚¯2ã‚’åœ§ç¸®
    Main->>T3: ãƒ–ãƒ­ãƒƒã‚¯3ã‚’åœ§ç¸®
    Main->>T4: ãƒ–ãƒ­ãƒƒã‚¯4ã‚’åœ§ç¸®

    Note over T1,T4: ä¸¦åˆ—ã«åœ§ç¸®å‡¦ç†

    T1->>Main: åœ§ç¸®æ¸ˆã¿ãƒ–ãƒ­ãƒƒã‚¯1
    T2->>Main: åœ§ç¸®æ¸ˆã¿ãƒ–ãƒ­ãƒƒã‚¯2
    T3->>Main: åœ§ç¸®æ¸ˆã¿ãƒ–ãƒ­ãƒƒã‚¯3
    T4->>Main: åœ§ç¸®æ¸ˆã¿ãƒ–ãƒ­ãƒƒã‚¯4

    Main->>Output: é †ç•ªã«çµåˆã—ã¦å‡ºåŠ›
```

### ã‚¹ãƒ¬ãƒƒãƒ‰ã¨CPUã®é–¢ä¿‚

```mermaid
graph TB
    subgraph "8 vCPU ãƒã‚·ãƒ³"
        subgraph "pigz ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ"
            Thread1[ã‚¹ãƒ¬ãƒƒãƒ‰1] -.-> CPU1[ğŸ§‘â€ğŸ³ CPU1]
            Thread2[ã‚¹ãƒ¬ãƒƒãƒ‰2] -.-> CPU2[ğŸ§‘â€ğŸ³ CPU2]
            Thread3[ã‚¹ãƒ¬ãƒƒãƒ‰3] -.-> CPU3[ğŸ§‘â€ğŸ³ CPU3]
            Thread4[ã‚¹ãƒ¬ãƒƒãƒ‰4] -.-> CPU4[ğŸ§‘â€ğŸ³ CPU4]
            Thread5[ã‚¹ãƒ¬ãƒƒãƒ‰5] -.-> CPU5[ğŸ§‘â€ğŸ³ CPU5]
            Thread6[ã‚¹ãƒ¬ãƒƒãƒ‰6] -.-> CPU6[ğŸ§‘â€ğŸ³ CPU6]
            Thread7[ã‚¹ãƒ¬ãƒƒãƒ‰7] -.-> CPU7[ğŸ§‘â€ğŸ³ CPU7]
            Thread8[ã‚¹ãƒ¬ãƒƒãƒ‰8] -.-> CPU8[ğŸ§‘â€ğŸ³ CPU8]
        end
    end

    Note1["ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: nproc()ã§å–å¾—ã—ãŸCPUæ•°åˆ†ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èµ·å‹•<br/>â†’ 8 vCPUç’°å¢ƒã§ã¯8ã‚¹ãƒ¬ãƒƒãƒ‰èµ·å‹•<br/>â†’ CPUä½¿ç”¨ç‡ 100%"]

    style Note1 fill:#ffffcc
```

---

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# Ubuntu/Debian
apt-get install pigz

# macOS
brew install pigz

# Alpine Linuxï¼ˆDockerã‚³ãƒ³ãƒ†ãƒŠã§ã‚ˆãä½¿ã†ï¼‰
apk add pigz
```

### åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰

#### åœ§ç¸®

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
pigz file.txt
# â†’ file.txt.gz ãŒä½œæˆã•ã‚Œã‚‹

# æ¨™æº–å‡ºåŠ›ã«åœ§ç¸®çµæœã‚’å‡ºåŠ›ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯æ®‹ã‚‹ï¼‰
pigz -c file.txt > file.txt.gz

# è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®
pigz file1.txt file2.txt file3.txt
```

#### è§£å‡

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡ï¼ˆ.gzãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
pigz -d file.txt.gz
# ã¾ãŸã¯
unpigz file.txt.gz

# æ¨™æº–å‡ºåŠ›ã«è§£å‡çµæœã‚’å‡ºåŠ›ï¼ˆ.gzãƒ•ã‚¡ã‚¤ãƒ«ã¯æ®‹ã‚‹ï¼‰
pigz -dc file.txt.gz > file.txt
```

#### ãƒ‘ã‚¤ãƒ—å‡¦ç†

```bash
# åœ§ç¸®ã—ãªãŒã‚‰ãƒ‘ã‚¤ãƒ—å‡¦ç†
cat large_file.csv | pigz -c > large_file.csv.gz

# è§£å‡ã—ãªãŒã‚‰ãƒ‘ã‚¤ãƒ—å‡¦ç†
pigz -dc data.csv.gz | grep "keyword" | wc -l
```

---

## ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®åˆ¶å¾¡

### `-p` ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ—ãƒ­ã‚»ãƒƒã‚µæ•°æŒ‡å®š

pigzã®æœ€ã‚‚é‡è¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒ `-p` ã§ã™ã€‚ã“ã‚Œã§ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ï¼ˆ=ä½¿ç”¨ã™ã‚‹CPUã‚³ã‚¢æ•°ï¼‰ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

```bash
# 1ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œï¼ˆgzipã¨åŒã˜ï¼‰
pigz -p 1 -c file.txt > file.txt.gz

# 2ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
pigz -p 2 -c file.txt > file.txt.gz

# 4ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
pigz -p 4 -c file.txt > file.txt.gz

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå…¨ã‚³ã‚¢ã‚’ä½¿ç”¨ï¼‰
pigz -c file.txt > file.txt.gz
```

### ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®æ±ºã‚æ–¹

```mermaid
graph TD
    Start[ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’æ±ºã‚ã‚‹] --> Q1{å˜ç‹¬å®Ÿè¡Œ?}

    Q1 -->|Yes| High[é«˜ã„ã‚¹ãƒ¬ãƒƒãƒ‰æ•°<br/>-p å…¨ã‚³ã‚¢æ•°]
    Q1 -->|No| Q2{ä¸¦åˆ—å®Ÿè¡Œæ•°ã¯?}

    Q2 --> Calc[è¨ˆç®—å¼<br/>é©åˆ‡ãªã‚¹ãƒ¬ãƒƒãƒ‰æ•° = å…¨ã‚³ã‚¢æ•° Ã· ä¸¦åˆ—å®Ÿè¡Œæ•°]

    Calc --> Example1[ä¾‹: 8ã‚³ã‚¢ãƒ»4ä¸¦åˆ—<br/>â†’ pigz -p 2]
    Calc --> Example2[ä¾‹: 8ã‚³ã‚¢ãƒ»2ä¸¦åˆ—<br/>â†’ pigz -p 4]

    High --> Note1[CPUä½¿ç”¨ç‡ 100%<br/>æœ€é€Ÿ]
    Example1 --> Note2[CPUä½¿ç”¨ç‡ 50-75%<br/>ãƒãƒ©ãƒ³ã‚¹è‰¯ã—]

    style Note1 fill:#ffcccc
    style Note2 fill:#ccffcc
```

### å®Ÿè·µçš„ãªæŒ‡é‡

#### 1. å˜ç‹¬å®Ÿè¡Œã®å ´åˆ

```bash
# å…¨ã‚³ã‚¢ã‚’ä½¿ã£ã¦æœ€é€Ÿã§å‡¦ç†
pigz -c large_file.csv > large_file.csv.gz
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- æœ€é€Ÿã§å‡¦ç†å®Œäº†
- CPUä½¿ç”¨ç‡100%ã§ã‚‚å•é¡Œãªã—ï¼ˆä»–ã®å‡¦ç†ãŒãªã„ãŸã‚ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ä»–ã®å‡¦ç†ãŒã‚ã‚‹å ´åˆã€å½±éŸ¿ã‚’å—ã‘ã‚‹

#### 2. ä¸¦åˆ—å®Ÿè¡Œã®å ´åˆï¼ˆé‡è¦ï¼ï¼‰

```bash
# 4ã¤ã®pigzãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹å ´åˆï¼ˆ8ã‚³ã‚¢ç’°å¢ƒï¼‰
# å„pigzã¯2ã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ¶é™
parallel -j 4 "pigz -p 2 -c {} > {}.gz" ::: file1.csv file2.csv file3.csv file4.csv
```

**è¨ˆç®—å¼:**
```
é©åˆ‡ãªã‚¹ãƒ¬ãƒƒãƒ‰æ•° = å…¨ã‚³ã‚¢æ•° Ã· ä¸¦åˆ—å®Ÿè¡Œæ•°
8ã‚³ã‚¢ Ã· 4ä¸¦åˆ— = 2ã‚¹ãƒ¬ãƒƒãƒ‰
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- CPUä½¿ç”¨ç‡ãŒé©åˆ‡ï¼ˆ100%å‰å¾Œï¼‰
- å„ãƒ—ãƒ­ã‚»ã‚¹ãŒå‡ç­‰ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ãˆã‚‹
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¤ãƒƒãƒãŒå°‘ãªã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- å˜ç‹¬å®Ÿè¡Œã‚ˆã‚Š1ã¤ã‚ãŸã‚Šã¯é…ã„ï¼ˆã§ã‚‚å…¨ä½“ã§ã¯åŠ¹ç‡çš„ï¼‰

#### 3. æ§ãˆã‚ã«ä½¿ã†å ´åˆ

```bash
# 1ã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ¶é™ï¼ˆä»–ã®é‡è¦ãªå‡¦ç†ãŒã‚ã‚‹å ´åˆï¼‰
pigz -p 1 -c file.csv > file.csv.gz
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ä»–ã®å‡¦ç†ã«å½±éŸ¿ã‚’ä¸ãˆãªã„
- CPUä½¿ç”¨ç‡ãŒä½ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- gzipã¨åŒã˜é€Ÿåº¦ï¼ˆpigzã®åˆ©ç‚¹ãŒãªã„ï¼‰

---

## å®Ÿè·µä¾‹

### ä¾‹1: ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯è»¢é€ï¼ˆä»Šå›ã®å•é¡Œï¼‰

#### å•é¡ŒãŒã‚ã£ãŸã‚³ãƒ¼ãƒ‰

```bash
# 4ä¸¦åˆ—ã§pigzã‚’å®Ÿè¡Œ
parallel -j 4 convert_file ::: file1.csv file2.csv file3.csv file4.csv

# convert_fileé–¢æ•°ã®ä¸­
pigz -dc input.csv.gz | mlr ... | pigz -c > output.json.gz
# â†‘ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§8ã‚¹ãƒ¬ãƒƒãƒ‰ Ã— 2å› = 16ã‚¹ãƒ¬ãƒƒãƒ‰
# 4ãƒ—ãƒ­ã‚»ã‚¹ Ã— 16ã‚¹ãƒ¬ãƒƒãƒ‰ = 64ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ8ã‚³ã‚¢ã‚’å¥ªã„åˆã† â†’ CPU 100%ï¼
```

#### æ”¹å–„ã—ãŸã‚³ãƒ¼ãƒ‰

```bash
# 4ä¸¦åˆ—ã§å®Ÿè¡Œã€å„pigzã¯1-2ã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ¶é™
parallel -j 4 convert_file ::: file1.csv file2.csv file3.csv file4.csv

# convert_fileé–¢æ•°ã®ä¸­
pigz -p 2 -dc input.csv.gz | mlr ... | pigz -p 2 -c > output.json.gz
# â†‘ 2ã‚¹ãƒ¬ãƒƒãƒ‰ Ã— 2å› = 4ã‚¹ãƒ¬ãƒƒãƒ‰
# 4ãƒ—ãƒ­ã‚»ã‚¹ Ã— 4ã‚¹ãƒ¬ãƒƒãƒ‰ = 16ã‚¹ãƒ¬ãƒƒãƒ‰ â†’ CPUä½¿ç”¨ç‡ é©åˆ‡ï¼
```

### ä¾‹2: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åœ§ç¸®

#### ã‚·ãƒŠãƒªã‚ª: 100å€‹ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®

```bash
# æ‚ªã„ä¾‹: å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—åœ§ç¸®ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰åˆ¶é™ãªã—ï¼‰
parallel -j 8 "pigz {}" ::: logs/*.log
# â†’ 8ãƒ—ãƒ­ã‚»ã‚¹ Ã— 8ã‚¹ãƒ¬ãƒƒãƒ‰ = 64ã‚¹ãƒ¬ãƒƒãƒ‰ â†’ CPUéè² è·

# è‰¯ã„ä¾‹: ä¸¦åˆ—æ•°ã¨ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®ãƒãƒ©ãƒ³ã‚¹
parallel -j 4 "pigz -p 2 {}" ::: logs/*.log
# â†’ 4ãƒ—ãƒ­ã‚»ã‚¹ Ã— 2ã‚¹ãƒ¬ãƒƒãƒ‰ = 8ã‚¹ãƒ¬ãƒƒãƒ‰ â†’ CPUåŠ¹ç‡çš„
```

### ä¾‹3: ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```bash
# ãƒ‡ãƒ¼ã‚¿æŠ½å‡º â†’ å¤‰æ› â†’ åœ§ç¸®ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
mysql -e "SELECT * FROM large_table" \
  | jq -c '...' \
  | pigz -p 2 -c > output.json.gz

# ã‚¹ãƒ¬ãƒƒãƒ‰åˆ¶é™ã«ã‚ˆã‚Šã€MySQLæ¥ç¶šã‚„jqå‡¦ç†ã«ã‚‚CPUã‚’æ®‹ã›ã‚‹
```

---

## æ³¨æ„ç‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### âš ï¸ æ³¨æ„ç‚¹

#### 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ã‚³ã‚¢ã‚’ä½¿ã†

```bash
# ã“ã‚Œã¯8ã‚³ã‚¢ç’°å¢ƒã§8ã‚¹ãƒ¬ãƒƒãƒ‰èµ·å‹•ã™ã‚‹
pigz file.txt

# ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹å ´åˆã¯å¿…ãš -p ã§åˆ¶é™ã‚’ï¼
parallel -j 4 "pigz -p 2 {}" ::: files/*
```

#### 2. åœ§ç¸®ã¨è§£å‡ã®ä¸¡æ–¹ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½¿ã†

```bash
# ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã¯2å›pigzãŒå®Ÿè¡Œã•ã‚Œã‚‹
pigz -dc input.gz | process | pigz -c > output.gz
#     â†‘ 8ã‚¹ãƒ¬ãƒƒãƒ‰           â†‘ 8ã‚¹ãƒ¬ãƒƒãƒ‰
# åˆè¨ˆ16ã‚¹ãƒ¬ãƒƒãƒ‰ï¼

# ä¸¡æ–¹ã« -p ã‚’æŒ‡å®š
pigz -p 2 -dc input.gz | process | pigz -p 2 -c > output.gz
#     â†‘ 2ã‚¹ãƒ¬ãƒƒãƒ‰              â†‘ 2ã‚¹ãƒ¬ãƒƒãƒ‰
# åˆè¨ˆ4ã‚¹ãƒ¬ãƒƒãƒ‰
```

#### 3. å°ã•ã„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯åŠ¹æœãŒè–„ã„

```bash
# æ•°KBã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯pigzã®ä¸¦åˆ—åŒ–åŠ¹æœã¯å°ã•ã„
# â†’ èµ·å‹•ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®æ–¹ãŒå¤§ãã„å ´åˆãŒã‚ã‚‹

# ç›®å®‰: æ•°MBä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã§pigzã®åŠ¹æœãŒå‡ºã‚‹
```

#### 4. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚‚å¢—ãˆã‚‹

```bash
# ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ãŒå¤šã„ã¨ãƒ¡ãƒ¢ãƒªã‚‚å¤šãä½¿ã†
# å„ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç‹¬ç«‹ã—ãŸãƒãƒƒãƒ•ã‚¡ã‚’æŒã¤ãŸã‚

# 8ã‚¹ãƒ¬ãƒƒãƒ‰ â†’ ç´„32MBï¼ˆåœ§ç¸®ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚‹ï¼‰
# 1ã‚¹ãƒ¬ãƒƒãƒ‰ â†’ ç´„4MB
```

### âœ… ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### 1. ä¸¦åˆ—å®Ÿè¡Œæ™‚ã¯å¿…ãšã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’è¨ˆç®—

```bash
# å…¬å¼
ã‚¹ãƒ¬ãƒƒãƒ‰æ•° = å…¨ã‚³ã‚¢æ•° Ã· ä¸¦åˆ—å®Ÿè¡Œæ•°

# 8ã‚³ã‚¢ãƒ»4ä¸¦åˆ—
pigz -p 2 ...

# 16ã‚³ã‚¢ãƒ»8ä¸¦åˆ—
pigz -p 2 ...
```

#### 2. ç’°å¢ƒå¤‰æ•°ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¨­å®š

```bash
# ç’°å¢ƒå¤‰æ•°ã§ä¸¦åˆ—æ•°ã‚’åˆ¶å¾¡ï¼ˆä¸€éƒ¨ã®ç’°å¢ƒã§ã‚µãƒãƒ¼ãƒˆï¼‰
export PIGZ="-p 2"

# ã¾ãŸã¯é–¢æ•°ã§ãƒ©ãƒƒãƒ—
function safe_pigz() {
    pigz -p 2 "$@"
}
```

#### 3. ãƒ­ã‚°ã§å®Ÿéš›ã®ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’ç¢ºèª

```bash
# pigzã®è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›
pigz -v -p 2 file.txt
# pigz 2.6 -p 2
# ä½¿ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚„ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

#### 4. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```bash
# CPUä½¿ç”¨ç‡ã‚’ç›£è¦–ã—ãªãŒã‚‰å®Ÿè¡Œ
top &
pigz large_file.csv
# CPUä½¿ç”¨ç‡ãŒ100%ã«å¼µã‚Šä»˜ããªã‚‰ -p ã§èª¿æ•´
```

#### 5. åœ§ç¸®ãƒ¬ãƒ™ãƒ«ã‚‚è€ƒæ…®

```bash
# åœ§ç¸®ãƒ¬ãƒ™ãƒ«: 1(æœ€é€Ÿ) ï½ 9(æœ€é«˜åœ§ç¸®)
pigz -p 4 -1 file.txt  # æœ€é€Ÿã€ä½åœ§ç¸®ç‡
pigz -p 4 -6 file.txt  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
pigz -p 4 -9 file.txt  # æœ€é«˜åœ§ç¸®ã€é…ã„

# æ¨å¥¨: -6ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ãŒé€Ÿåº¦ã¨åœ§ç¸®ç‡ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„
```

---

## ã¾ã¨ã‚

### pigzã‚’ä½¿ã†ã¹ãå ´é¢

| ã‚·ãƒ¼ãƒ³ | æ¨å¥¨ | ç†ç”± |
|-------|------|------|
| **å¤§ãã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ•°MBä»¥ä¸Šï¼‰** | âœ… ä½¿ã† | ä¸¦åˆ—åŒ–ã®åŠ¹æœãŒå¤§ãã„ |
| **å°ã•ã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ•°KBï¼‰** | âŒ gzipã§OK | ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã§é€†ã«é…ã„ |
| **å˜ç‹¬å®Ÿè¡Œ** | âœ… ä½¿ã† | å…¨ã‚³ã‚¢ã‚’ä½¿ã£ã¦æœ€é€Ÿ |
| **ä¸¦åˆ—å®Ÿè¡Œ** | âš ï¸ -p ã§åˆ¶é™å¿…é ˆ | ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’åˆ¶å¾¡ã—ãªã„ã¨CPUéè² è· |
| **CPUã«ä½™è£•ãŒãªã„** | âŒ gzipã§OK | ä»–ã®å‡¦ç†ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ |

### é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **pigzã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ã‚³ã‚¢ã‚’ä½¿ã†**
   - ä¸¦åˆ—å®Ÿè¡Œæ™‚ã¯å¿…ãš `-p` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’åˆ¶é™

2. **é©åˆ‡ãªã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®è¨ˆç®—**
   ```
   ã‚¹ãƒ¬ãƒƒãƒ‰æ•° = å…¨ã‚³ã‚¢æ•° Ã· ä¸¦åˆ—å®Ÿè¡Œæ•°
   ```

3. **åœ§ç¸®ã¨è§£å‡ã®ä¸¡æ–¹ã§æ³¨æ„**
   - ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§2å›pigzã‚’ä½¿ã†å ´åˆã€ä¸¡æ–¹ã« `-p` ã‚’æŒ‡å®š

4. **gzipã‚ˆã‚Š5ï½6å€é€Ÿã„**
   - å¤§ãã„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†æ™‚é–“ã‚’å¤§å¹…ã«çŸ­ç¸®

5. **å®Œå…¨ãªgzipäº’æ›**
   - æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç½®ãæ›ãˆã‚‹ã ã‘ã§é«˜é€ŸåŒ–ã§ãã‚‹

### ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ

```bash
# åŸºæœ¬çš„ãªåœ§ç¸®
pigz file.txt                    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå…¨ã‚³ã‚¢ä½¿ç”¨ï¼‰
pigz -p 4 file.txt               # 4ã‚¹ãƒ¬ãƒƒãƒ‰ã«åˆ¶é™
pigz -c file.txt > file.txt.gz   # å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ®‹ã™

# åŸºæœ¬çš„ãªè§£å‡
pigz -d file.txt.gz              # è§£å‡
pigz -dc file.txt.gz > file.txt  # .gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ®‹ã™

# ä¸¦åˆ—å®Ÿè¡Œï¼ˆæ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
# 8ã‚³ã‚¢ç’°å¢ƒã§4ä¸¦åˆ—
parallel -j 4 "pigz -p 2 {}" ::: files/*

# ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
pigz -p 2 -dc input.gz | process | pigz -p 2 -c > output.gz

# åœ§ç¸®ãƒ¬ãƒ™ãƒ«æŒ‡å®š
pigz -p 4 -1 file.txt  # æœ€é€Ÿ
pigz -p 4 -9 file.txt  # æœ€é«˜åœ§ç¸®
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [pigzå…¬å¼ã‚µã‚¤ãƒˆ](https://zlib.net/pigz/)
- [pigz GitHub](https://github.com/madler/pigz)
- [é–¢é€£: ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯CPUå•é¡Œåˆ†æ](./20260209_datalake_cpu-usage-analysis.md)

---

**ä½œæˆæ—¥:** 2026-02-09
**æœ€çµ‚æ›´æ–°:** 2026-02-09
**é–¢é€£Issue:** [ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯CPUä½¿ç”¨ç‡100%å•é¡Œ](https://wonderplanet.atlassian.net/wiki/spaces/GLOW/pages/1528037400/2026+02+09)
