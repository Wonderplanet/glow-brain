# ステップアップガシャ - ガシャ検証システム改修要件詳細

## 📋 目次
1. [概要](#概要)
2. [調査結果サマリー](#調査結果サマリー)
3. [API側実装の確認](#api側実装の確認)
4. [管理ツール側実装の確認](#管理ツール側実装の確認)
5. [ギャップ分析](#ギャップ分析)
6. [改修要件詳細](#改修要件詳細)
7. [実装優先順位](#実装優先順位)
8. [テスト観点](#テスト観点)

---

## 概要

### 背景
v1.6.0でAPI側にステップアップガシャが実装されましたが、管理ツールのBNEガシャ検証システム（事前検証・事後検証）がステップアップガシャに対応していません。

### 目的
BNEガシャ排出率検証システムに正しいデータを送信し、ステップアップガシャの事前検証・事後検証を可能にする。

### 参照ドキュメント
- **仕様書**: `docs/tasks/admin/gacha-verification/specs/ガシャ検証.pdf`
- **データ定義**: `docs/tasks/admin/gacha-verification/specs/ガシャ検証システム_データ定義(拡張版)_190912/`
- **既存まとめ**: `docs/tasks/admin/gacha-verification/ステップアップガシャ対応まとめ.md`

---

## 調査結果サマリー

### API側の実装状況

#### ✅ 実装済み
1. **データベーステーブル**
   - `opr_stepup_gachas`: ステップアップガシャ設定テーブル
   - `opr_stepup_gacha_steps`: ステップごとの設定テーブル
   - `opr_stepup_gacha_step_rewards`: ステップごとのおまけ報酬テーブル
   - `log_gacha_actions`: ステップ情報を記録するカラム追加（`step_number`, `loop_count`）
   - `usr_gachas`: ユーザーのステップ進行状態を記録するカラム追加（`current_step_number`, `loop_count`）

2. **モデル・リポジトリ**
   - `OprStepUpGacha` モデル・Entity・Repository
   - `OprStepUpGachaStep` モデル・Entity・Repository
   - `OprStepUpGachaStepReward` モデル・Entity・Repository
   - `LogGachaAction` モデルに `setStepNumber()`, `setLoopCount()` メソッド追加

3. **ガシャタイプ**
   - `GachaType::STEPUP` が定義済み

4. **ガシャ実行ロジック**
   - `StepUpGachaService`: ステップアップガシャのビジネスロジック
   - `StepUpGachaDrawService`: ステップアップガシャの抽選処理
   - ガシャ実行時に `log_gacha_actions` テーブルへ `step_number` と `loop_count` が正しく記録される

### 管理ツール側の実装状況

#### ✅ 実装済み
1. **モデル**
   - `App\Models\Mst\OprStepUpGacha`: API側のモデルを継承（admin用の接続設定のみ）

2. **ガシャタイプ**
   - `App\Constants\GachaType::STEPUP` は定義済み
   - **⚠️ ただし、`label()` メソッドに `STEPUP` のケースが無いためエラーが発生**

#### ❌ 未実装・不足
1. **モデル**
   - `OprStepUpGachaStep` モデルが admin 側に存在しない
   - `OprStepUpGachaStepReward` モデルが admin 側に存在しない
   - `LogGachaAction` モデルは存在するが、リレーション設定が不足

2. **リポジトリ**
   - `OprStepUpGachaRepository` が admin 側に存在しない
   - `OprStepUpGachaStepRepository` が admin 側に存在しない
   - `OprStepUpGachaStepRewardRepository` が admin 側に存在しない
   - `LogGachaActionRepository` が存在しない

3. **事後検証（GenerateGachaLogJson.php）**
   - `step_no` が常に `0` 固定
   - `log_gacha_actions` テーブルとの結合処理が無い
   - 実際のステップ番号を取得・設定する処理が無い

4. **事前検証（GenerateGachaMasterJson.php）**
   - `steps` 配列が常に1要素のみ
   - ステップアップガシャの判定処理が無い
   - 複数ステップの `sets` を生成する処理が無い
   - ステップごとに異なる `prize_group_id` を使用する処理が無い

5. **ガシャシミュレーター（GachaSimulator.php）**
   - ステップアップガシャへの特別な対応が無い
   - ステップ選択UIが無い
   - ステップごとのシミュレーション処理が無い

---

## API側実装の確認

### テーブル構造

#### `opr_stepup_gachas` テーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ステップアップガシャID（主キー） |
| release_key | bigInteger | リリースキー |
| opr_gacha_id | string | `opr_gachas.id` への外部キー（ユニーク） |
| max_step_number | unsignedTinyInteger | 最大ステップ数（例: 5） |
| max_loop_count | unsignedInteger (nullable) | 最大周回数 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

#### `opr_stepup_gacha_steps` テーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ステップID（主キー） |
| release_key | bigInteger | リリースキー |
| opr_gacha_id | string | `opr_gachas.id` への外部キー |
| step_number | unsignedTinyInteger | ステップ番号（1, 2, 3...） |
| cost_type | enum | コスト種別（Diamond, PaidDiamond, Free, Item） |
| cost_id | string (nullable) | コストID |
| cost_num | unsignedInteger | コスト数 |
| draw_count | unsignedTinyInteger | 排出回数（何連ガシャか） |
| fixed_prize_count | unsignedTinyInteger | 確定枠数（0-10） |
| fixed_prize_rarity_threshold_type | enum (nullable) | 確定枠レアリティ条件（N, R, SR, SSR, UR） |
| prize_group_id | string (nullable) | 賞品グループID（通常枠） |
| fixed_prize_group_id | string (nullable) | 確定枠賞品グループID |
| is_first_free | boolean | 初回のみ無料フラグ |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

**複合ユニークキー**: `(opr_gacha_id, step_number)`

#### `opr_stepup_gacha_step_rewards` テーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ID（主キー） |
| release_key | bigInteger | リリースキー |
| opr_gacha_id | string | `opr_gachas.id` への外部キー |
| step_number | unsignedTinyInteger | ステップ番号 |
| loop_count_target | unsignedInteger (nullable) | 対象周回数（NULL=全周回） |
| resource_type | enum | 報酬リソースタイプ（Exp, Coin, FreeDiamond, Item, Emblem, Stamina, Unit） |
| resource_id | string (nullable) | 報酬リソースID |
| resource_amount | unsignedBigInteger | 報酬数量 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

**インデックス**: `idx_opr_gacha_id_step (opr_gacha_id, step_number)`

#### `log_gacha_actions` テーブル（追加カラム）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| step_number | unsignedTinyInteger (nullable) | 実行したステップ番号 |
| loop_count | unsignedInteger (nullable) | 実行時の周回数 |

#### `usr_gachas` テーブル（追加カラム）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| current_step_number | unsignedTinyInteger (nullable) | 現在のステップ番号 |
| loop_count | unsignedInteger (nullable) | 現在の周回数 |

### リポジトリ

#### `OprStepUpGachaRepository`
- **場所**: `api/app/Domain/Resource/Mst/Repositories/OprStepUpGachaRepository.php`
- **メソッド**:
  - `findByOprGachaId(string $oprGachaId): ?OprStepUpGachaEntity`
  - `getByOprGachaId(string $oprGachaId, bool $isThrowError = false): ?OprStepUpGachaEntity`

#### `OprStepUpGachaStepRepository`
- **場所**: `api/app/Domain/Resource/Mst/Repositories/OprStepUpGachaStepRepository.php`
- **メソッド**:
  - `getListByOprGachaId(string $oprGachaId): Collection<OprStepUpGachaStepEntity>` - ステップ番号順にソート済み
  - `findByOprGachaIdStepNumber(string $oprGachaId, int $stepNumber): ?OprStepUpGachaStepEntity`
  - `getByOprGachaIdStepNumber(string $oprGachaId, int $stepNumber, bool $isThrowError = false): ?OprStepUpGachaStepEntity`

### ガシャ実行時のログ記録

API側では、ガシャ実行時に以下のように `log_gacha_actions` テーブルへステップ情報を記録しています。

```php
// LogGachaAction モデルに setStepNumber() と setLoopCount() メソッドがある
$logGachaAction->setStepNumber($stepNumber);
$logGachaAction->setLoopCount($loopCount);
```

**重要**: `log_gacha` テーブルには `step_number` や `loop_count` が含まれていません。ステップ情報は `log_gacha_actions` テーブルにのみ記録されています。

### テーブル間の関連付け

`log_gacha` と `log_gacha_actions` を結合するには、以下のキーを使用します：

```sql
SELECT
    lg.*,
    lga.step_number,
    lga.loop_count
FROM log_gachas lg
INNER JOIN log_gacha_actions lga
    ON lg.usr_user_id = lga.usr_user_id
    AND lg.opr_gacha_id = lga.opr_gacha_id
    AND lg.nginx_request_id = lga.nginx_request_id
    AND lg.logging_no = lga.logging_no
    AND DATE(lg.created_at) = DATE(lga.created_at)
WHERE lg.opr_gacha_id = 'stepup_gacha_001'
    AND DATE(lg.created_at) = '2025-01-01';
```

**結合キー**:
- `usr_user_id`
- `opr_gacha_id`
- `nginx_request_id`
- `logging_no`
- `DATE(created_at)` - 日付が一致する必要がある

---

## 管理ツール側実装の確認

### 既存の事後検証コマンド

#### `GenerateGachaLogJson.php`
- **場所**: `admin/app/Console/Commands/GenerateGachaLogJson.php`
- **処理内容**:
  1. `LogGachaRepository` を使用して、指定日付のガシャログを取得
  2. 各ログの `result` 配列（抽選結果）をループ処理
  3. BNE仕様に準拠したJSON形式に変換
  4. S3にアップロード（`s3:/(ログROOT)/APP_ID/GASHA_ID/logs/YYYYMMDD/(サーバ識別子).json.gz`）

- **問題点**:
  - **Line 105**: `'step_no' => 0,` で常に固定
  - `log_gacha_actions` テーブルとの結合処理が無い
  - ステップ番号を取得する処理が無い

#### 出力JSONフォーマット（現状）
```json
{
  "app_id": "600",
  "gasha_id": "stepup_gacha_001",
  "is_full_box": 0,
  "exec_id": "01HQ...",
  "step_no": 0,  // ★常に0固定 → 実際のステップ番号が必要
  "set_name": "REGULAR",
  "timestamp": 1704067200,
  "user_id": "user001",
  "item_id": "item_001",
  "item_num": 1,
  "promised": 0,
  "selected_sp": []
}
```

### 既存の事前検証コマンド

#### `GenerateGachaMasterJson.php`
- **場所**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
- **処理内容**:
  1. 集計日中に開催中のガシャを取得
  2. 各ガシャの `prize_group_id` と `fixed_prize_group_id` から抽選アイテムを取得
  3. `sets` 配列を生成（通常枠・確定枠）
  4. BNE仕様に準拠したJSON形式に変換
  5. S3にアップロード（`s3:/(ログROOT)/APP_ID/GASHA_ID/gasha_YYYYMMDD.json`）

- **問題点**:
  - **Line 220-222**: `'steps' => [['sets' => $sets]]` で常に1ステップのみ
  - ステップアップガシャの判定処理が無い
  - 複数ステップの `sets` を生成する処理が無い
  - ステップごとに異なる `prize_group_id` を使用する処理が無い

#### 出力JSONフォーマット（現状）
```json
{
  "app_id": "600",
  "app_name": "お寿司屋さんDREAM2025",
  "gasha_id": "stepup_gacha_001",
  "gasha_name": "新春初回りイベント",
  "gasha_type": 0,
  "gasha_group_id": "",
  "open_time": 1704067200,
  "close_time": 1706745599,
  "steps": [  // ★常に1要素のみ → ステップ数分必要
    {
      "sets": [
        {
          "set_name": "REGULAR",
          "items": [...]
        }
      ]
    }
  ]
}
```

### ガシャシミュレーター

#### `GachaSimulator.php`
- **場所**: `admin/app/Filament/Pages/GachaSimulator.php`
- **処理内容**:
  1. ガシャIDを指定してシミュレーションを実行
  2. 指定回数ガシャを引いた場合の排出率を計算
  3. 設定値との誤差率をチェック（30%以内か）

- **問題点**:
  - ステップアップガシャへの特別な対応が無い
  - ステップ選択UIが無い
  - ステップごとのシミュレーション処理が無い

---

## ギャップ分析

### 1. モデル・リポジトリの不足

| 項目 | API側 | admin側 | ギャップ |
|-----|------|--------|---------|
| `OprStepUpGacha` モデル | ✅ 実装済み | ✅ 実装済み | なし |
| `OprStepUpGachaStep` モデル | ✅ 実装済み | ❌ 未実装 | **要追加** |
| `OprStepUpGachaStepReward` モデル | ✅ 実装済み | ❌ 未実装 | 要追加（優先度低） |
| `OprStepUpGachaRepository` | ✅ 実装済み | ❌ 未実装 | **要追加** |
| `OprStepUpGachaStepRepository` | ✅ 実装済み | ❌ 未実装 | **要追加** |
| `LogGachaActionRepository` | - | ❌ 未実装 | **要追加** |

### 2. ガシャタイプラベルの不足

| 項目 | API側 | admin側 | ギャップ |
|-----|------|--------|---------|
| `GachaType::STEPUP` 定義 | ✅ 実装済み | ✅ 実装済み | なし |
| `label()` メソッドに `STEPUP` のケース | ✅ 実装済み | ❌ 未実装 | **要追加（最優先）** |

**現状**: `admin/app/Constants/GachaType.php` の `label()` メソッドに `self::STEPUP => 'ステップアップ',` のケースが無いため、ステップアップガシャを選択すると例外が発生します。

### 3. 事後検証（ログJSON生成）の不足

| 項目 | 必要な実装 | 現状 | ギャップ |
|-----|-----------|------|---------|
| `step_no` の設定 | 実際のステップ番号 | 常に `0` | **要修正** |
| `log_gacha_actions` との結合 | 必要 | 無し | **要追加** |
| ステップ番号の取得 | 必要 | 無し | **要追加** |
| 周回数の取得 | 必要（仕様確認要） | 無し | 要追加（仕様次第） |

### 4. 事前検証（マスタJSON生成）の不足

| 項目 | 必要な実装 | 現状 | ギャップ |
|-----|-----------|------|---------|
| ステップアップガシャの判定 | `GachaType::STEPUP` で判定 | 無し | **要追加** |
| 複数ステップの生成 | `max_step_number` 分のステップ生成 | 常に1ステップ | **要追加** |
| ステップごとの `sets` 生成 | ステップごとの `prize_group_id` 使用 | 全ステップ同じ | **要追加** |
| 確定枠の処理 | ステップごとの `fixed_prize_group_id` 使用 | 全ステップ同じ | **要追加** |

### 5. ガシャシミュレーターの不足

| 項目 | 必要な実装 | 現状 | ギャップ |
|-----|-----------|------|---------|
| ステップ選択UI | ドロップダウン等 | 無し | 要追加 |
| ステップごとのシミュレーション | ステップごとに異なる抽選設定を使用 | 全ステップ同じ | 要追加 |
| ステップ番号の保存 | シミュレーションログに記録 | 無し | 要追加 |

---

## 改修要件詳細

### Phase 1: 緊急対応（最優先）

#### 1.1 GachaType.php のラベル追加【必須】

**ファイル**: `admin/app/Constants/GachaType.php`

**現状**:
```php
public function label(): string
{
    return match ($this) {
        self::TUTORIAL => 'チュートリアル',
        self::NORMAL => 'ノーマル',
        self::PREMIUM => 'プレミアム',
        self::PICKUP => 'ピックアップ',
        self::FREE => '無料',
        self::TICKET => 'チケット',
        self::FESTIVAL => 'フェス',
        self::PAID_ONLY => '有償限定',
        self::MEDAL => 'メダル',
        // ★ STEPUP のケースが無い
    };
}
```

**修正後**:
```php
public function label(): string
{
    return match ($this) {
        self::TUTORIAL => 'チュートリアル',
        self::NORMAL => 'ノーマル',
        self::PREMIUM => 'プレミアム',
        self::PICKUP => 'ピックアップ',
        self::FREE => '無料',
        self::TICKET => 'チケット',
        self::FESTIVAL => 'フェス',
        self::PAID_ONLY => '有償限定',
        self::MEDAL => 'メダル',
        self::STEPUP => 'ステップアップ', // ★追加
    };
}
```

**影響範囲**:
- ガシャ一覧画面、ガシャ詳細画面で `gacha_type_label` を表示する箇所
- ガシャシミュレーター画面

**工数**: 1分

**リスク**: なし（単純なラベル追加）

---

### Phase 2: 事後検証の対応【必須】

#### 2.1 admin側モデル・リポジトリの追加

##### 2.1.1 OprStepUpGachaStep モデルの追加

**ファイル**: `admin/app/Models/Mst/OprStepUpGachaStep.php`（新規作成）

```php
<?php

namespace App\Models\Mst;

use App\Constants\Database;
use App\Domain\Resource\Mst\Models\OprStepUpGachaStep as BaseOprStepUpGachaStep;

class OprStepUpGachaStep extends BaseOprStepUpGachaStep
{
    protected $connection = Database::MASTER_DATA_CONNECTION;

    public function opr_gacha()
    {
        return $this->belongsTo(OprGacha::class, 'opr_gacha_id', 'id');
    }

    public function opr_stepup_gacha()
    {
        return $this->belongsTo(OprStepUpGacha::class, 'opr_gacha_id', 'opr_gacha_id');
    }
}
```

##### 2.1.2 OprStepUpGachaRepository の追加

**ファイル**: `admin/app/Repositories/Mst/OprStepUpGachaRepository.php`（新規作成）

```php
<?php

declare(strict_types=1);

namespace App\Repositories\Mst;

use App\Models\Mst\OprStepUpGacha;
use Illuminate\Support\Collection;

class OprStepUpGachaRepository
{
    /**
     * opr_gacha_id でステップアップガシャ設定を取得
     *
     * @param string $oprGachaId
     * @return OprStepUpGacha|null
     */
    public function findByOprGachaId(string $oprGachaId): ?OprStepUpGacha
    {
        return OprStepUpGacha::query()
            ->where('opr_gacha_id', $oprGachaId)
            ->first();
    }

    /**
     * opr_gacha_id でステップアップガシャ設定を取得（存在しない場合は例外）
     *
     * @param string $oprGachaId
     * @return OprStepUpGacha
     * @throws \Exception
     */
    public function getByOprGachaId(string $oprGachaId): OprStepUpGacha
    {
        $entity = $this->findByOprGachaId($oprGachaId);
        if (!$entity) {
            throw new \Exception("OprStepUpGacha not found. opr_gacha_id: {$oprGachaId}");
        }
        return $entity;
    }
}
```

##### 2.1.3 OprStepUpGachaStepRepository の追加

**ファイル**: `admin/app/Repositories/Mst/OprStepUpGachaStepRepository.php`（新規作成）

```php
<?php

declare(strict_types=1);

namespace App\Repositories\Mst;

use App\Models\Mst\OprStepUpGachaStep;
use Illuminate\Support\Collection;

class OprStepUpGachaStepRepository
{
    /**
     * opr_gacha_id でステップ一覧を取得（ステップ番号順）
     *
     * @param string $oprGachaId
     * @return Collection<OprStepUpGachaStep>
     */
    public function getListByOprGachaId(string $oprGachaId): Collection
    {
        return OprStepUpGachaStep::query()
            ->where('opr_gacha_id', $oprGachaId)
            ->orderBy('step_number')
            ->get();
    }

    /**
     * opr_gacha_id とステップ番号でステップ情報を取得
     *
     * @param string $oprGachaId
     * @param int $stepNumber
     * @return OprStepUpGachaStep|null
     */
    public function findByOprGachaIdAndStepNumber(string $oprGachaId, int $stepNumber): ?OprStepUpGachaStep
    {
        return OprStepUpGachaStep::query()
            ->where('opr_gacha_id', $oprGachaId)
            ->where('step_number', $stepNumber)
            ->first();
    }

    /**
     * opr_gacha_id とステップ番号でステップ情報を取得（存在しない場合は例外）
     *
     * @param string $oprGachaId
     * @param int $stepNumber
     * @return OprStepUpGachaStep
     * @throws \Exception
     */
    public function getByOprGachaIdAndStepNumber(string $oprGachaId, int $stepNumber): OprStepUpGachaStep
    {
        $entity = $this->findByOprGachaIdAndStepNumber($oprGachaId, $stepNumber);
        if (!$entity) {
            throw new \Exception("OprStepUpGachaStep not found. opr_gacha_id: {$oprGachaId}, step_number: {$stepNumber}");
        }
        return $entity;
    }
}
```

##### 2.1.4 LogGachaActionRepository の追加

**ファイル**: `admin/app/Repositories/Log/LogGachaActionRepository.php`（新規作成）

```php
<?php

declare(strict_types=1);

namespace App\Repositories\Log;

use App\Models\Log\LogGachaAction;
use Carbon\CarbonImmutable;

class LogGachaActionRepository
{
    /**
     * log_gacha と同じキーで log_gacha_actions を取得
     *
     * @param string $usrUserId
     * @param string $oprGachaId
     * @param string $nginxRequestId
     * @param int $loggingNo
     * @param CarbonImmutable $createdAt
     * @return LogGachaAction|null
     */
    public function findByLoggingInfo(
        string $usrUserId,
        string $oprGachaId,
        string $nginxRequestId,
        int $loggingNo,
        CarbonImmutable $createdAt
    ): ?LogGachaAction {
        return LogGachaAction::query()
            ->where('usr_user_id', $usrUserId)
            ->where('opr_gacha_id', $oprGachaId)
            ->where('nginx_request_id', $nginxRequestId)
            ->where('logging_no', $loggingNo)
            ->whereDate('created_at', $createdAt->toDateString())
            ->first();
    }
}
```

#### 2.2 GenerateGachaLogJson.php の修正

**ファイル**: `admin/app/Console/Commands/GenerateGachaLogJson.php`

##### 2.2.1 リポジトリのインジェクション

```php
use App\Repositories\Log\LogGachaActionRepository;

class GenerateGachaLogJson extends Command
{
    // ...

    private function generateGachaLogJson(CarbonImmutable $targetDate)
    {
        // ...

        /** @var LogGachaActionRepository $logGachaActionRepository */
        $logGachaActionRepository = app()->make(LogGachaActionRepository::class);

        // ...
    }
}
```

##### 2.2.2 ステップ番号の取得と設定

**修正前**:
```php
$result = [
    'app_id' => $appId,
    'gasha_id' => $oprGachaId,
    'is_full_box' => 0,
    'exec_id' => $logGacha->getId(),
    // ステップアップガチャでは変更が必要
    'step_no' => 0,  // ★常に0固定
    'set_name' => $this->getSetName($drawnItem['prize_type']),
    'timestamp' => $logGacha->getCreatedAt()->getTimestamp(),
    'user_id' => $logGacha->getUsrUserId(),
    'item_id' => $drawnItem['resource_id'],
    'item_num' => $drawnItem['resource_amount'],
    'promised' => $this->calcPromised($drawnItem['prize_type']),
    'selected_sp' => []
];
```

**修正後**:
```php
// log_gacha_actions テーブルからステップ情報を取得
$logGachaAction = $logGachaActionRepository->findByLoggingInfo(
    $logGacha->getUsrUserId(),
    $logGacha->getOprGachaId(),
    $logGacha->getNginxRequestId(),
    $logGacha->getLoggingNo(),
    $logGacha->getCreatedAt()
);

$result = [
    'app_id' => $appId,
    'gasha_id' => $oprGachaId,
    'is_full_box' => 0,
    'exec_id' => $logGacha->getId(),
    // ステップアップガチャの場合は実際のステップ番号を設定
    // ステップアップガチャ以外は step_number が null なので 0 にフォールバック
    'step_no' => $logGachaAction?->step_number ?? 0,
    'set_name' => $this->getSetName($drawnItem['prize_type']),
    'timestamp' => $logGacha->getCreatedAt()->getTimestamp(),
    'user_id' => $logGacha->getUsrUserId(),
    'item_id' => $drawnItem['resource_id'],
    'item_num' => $drawnItem['resource_amount'],
    'promised' => $this->calcPromised($drawnItem['prize_type']),
    'selected_sp' => []
];
```

**注意点**:
- `$logGachaAction` が `null` の場合（通常ガシャ等）は `step_no` を `0` にフォールバック
- ステップアップガシャでも `step_number` が `null` の場合は `0` にフォールバック
- `loop_count` はBNE仕様書に記載が無いため、現時点では使用しない（必要になったら追加）

##### 2.2.3 パフォーマンス最適化（オプション）

ループ内で毎回 `findByLoggingInfo()` を呼び出すとパフォーマンスが悪化する可能性があるため、事前に一括取得することも検討してください。

```php
// ループ前に一括取得
$logGachaActions = LogGachaAction::query()
    ->whereBetween('created_at', [$startOfDay, $endOfDay])
    ->get()
    ->keyBy(function ($logGachaAction) {
        return sprintf(
            '%s_%s_%s_%d',
            $logGachaAction->usr_user_id,
            $logGachaAction->opr_gacha_id,
            $logGachaAction->nginx_request_id,
            $logGachaAction->logging_no
        );
    });

// ループ内で取得
$key = sprintf(
    '%s_%s_%s_%d',
    $logGacha->getUsrUserId(),
    $logGacha->getOprGachaId(),
    $logGacha->getNginxRequestId(),
    $logGacha->getLoggingNo()
);
$logGachaAction = $logGachaActions->get($key);
```

**工数**: 2-3時間

**テスト観点**:
- ステップアップガシャのログで `step_no` が正しく設定されているか
- 通常ガシャのログで `step_no` が `0` になっているか（デグレ防止）
- `log_gacha_actions` が存在しない場合に例外が発生しないか
- パフォーマンステスト（大量ログでも問題なく処理できるか）

---

### Phase 3: 事前検証の対応【必須】

#### 3.1 GenerateGachaMasterJson.php の修正

**ファイル**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`

##### 3.1.1 リポジトリのインジェクション

```php
use App\Constants\GachaType;
use App\Repositories\Mst\OprStepUpGachaRepository;
use App\Repositories\Mst\OprStepUpGachaStepRepository;

class GenerateGachaMasterJson extends Command
{
    // ...
}
```

##### 3.1.2 ステップアップガシャの判定と処理

**修正前**:
```php
$gachaMaster[$oprGacha->getId()] = [
    'app_id' => $appId,
    'app_name' => $appName,
    'gasha_id' => $oprGacha->getId(),
    'gasha_name' => $oprGachaI18ns->get($oprGacha->getId())?->getName() ?? '',
    'gasha_type' => 0,
    'gasha_group_id' => '',
    'open_time' => $oprGacha->getStartAt()->getTimestamp(),
    'close_time' => $oprGacha->getEndAt()->getTimestamp(),
    'steps' => [  // ★常に1ステップのみ
        ['sets' => $sets],
    ]
];
```

**修正後**:
```php
// ステップアップガシャの判定
$isStepUpGacha = $oprGacha->getGachaType() === \App\Domain\Gacha\Enums\GachaType::STEPUP->value;

$steps = [];
if ($isStepUpGacha) {
    // ステップアップガシャの場合は複数ステップを生成
    $steps = $this->generateStepUpGachaSteps(
        $oprGacha,
        $groupedOprGachaPrizes,
        $oprGachaUpperGroups,
        $gachaTable,
        $mstUnits,
        $mstItems
    );
} else {
    // 通常ガシャの場合は1ステップのみ
    $steps = [['sets' => $sets]];
}

$gachaMaster[$oprGacha->getId()] = [
    'app_id' => $appId,
    'app_name' => $appName,
    'gasha_id' => $oprGacha->getId(),
    'gasha_name' => $oprGachaI18ns->get($oprGacha->getId())?->getName() ?? '',
    'gasha_type' => 0,
    'gasha_group_id' => '',
    'open_time' => $oprGacha->getStartAt()->getTimestamp(),
    'close_time' => $oprGacha->getEndAt()->getTimestamp(),
    'steps' => $steps,
];
```

##### 3.1.3 generateStepUpGachaSteps メソッドの追加

```php
/**
 * ステップアップガシャの複数ステップを生成
 *
 * @param OprGachaEntity $oprGacha
 * @param Collection $groupedOprGachaPrizes key: prize_group_id, value: Collection<OprGachaPrize>
 * @param Collection $oprGachaUpperGroups key: upper_group, value: Collection<OprGachaUpper>
 * @param Collection $gachaTable 通常枠の抽選テーブル（参考用）
 * @param Collection $mstUnits
 * @param Collection $mstItems
 * @return array
 */
private function generateStepUpGachaSteps(
    $oprGacha,
    Collection $groupedOprGachaPrizes,
    Collection $oprGachaUpperGroups,
    Collection $gachaTable,
    Collection $mstUnits,
    Collection $mstItems
): array {
    /** @var OprStepUpGachaStepRepository $oprStepUpGachaStepRepository */
    $oprStepUpGachaStepRepository = app()->make(OprStepUpGachaStepRepository::class);

    // ステップ一覧を取得（ステップ番号順）
    $stepUpGachaSteps = $oprStepUpGachaStepRepository->getListByOprGachaId($oprGacha->getId());

    if ($stepUpGachaSteps->isEmpty()) {
        // ステップ情報が無い場合はフォールバック（通常ガシャと同じ）
        \Log::warning("StepUpGachaSteps not found. opr_gacha_id: {$oprGacha->getId()}");
        return [['sets' => []]];
    }

    $steps = [];
    foreach ($stepUpGachaSteps as $stepUpGachaStep) {
        // ステップごとに異なる prize_group_id を使用
        $prizeGroupId = $stepUpGachaStep->prize_group_id;
        $fixedPrizeGroupId = $stepUpGachaStep->fixed_prize_group_id;

        // 通常枠の抽選テーブルを取得
        $stepGachaTable = $groupedOprGachaPrizes->get($prizeGroupId, collect());
        $totalWeight = $stepGachaTable->sum(fn($entity) => $entity->getWeight());
        $normalItems = $this->oprGachaPrizesToArray($stepGachaTable, $totalWeight);

        $sets = [
            [
                'set_name' => GachaSetName::REGULAR->value,
                'items' => $normalItems,
            ]
        ];

        // 確定枠がある場合
        if ($fixedPrizeGroupId) {
            $fixedGachaTable = $groupedOprGachaPrizes->get($fixedPrizeGroupId, collect());
            $fixedTotalWeight = $fixedGachaTable->sum(fn($entity) => $entity->getWeight());
            $fixedItems = $this->oprGachaPrizesToArray($fixedGachaTable, $fixedTotalWeight);
            $sets[] = [
                'set_name' => GachaSetName::FIXED->value,
                'items' => $fixedItems,
            ];
        }

        // 天井がある場合は追加（ステップアップガシャでも天井がある可能性があるため）
        $oprGachaUppers = $oprGachaUpperGroups->get($oprGacha->getUpperGroup(), collect());
        if ($oprGachaUppers->isNotEmpty()) {
            foreach ($oprGachaUppers as $oprGachaUpper) {
                /** @var OprGachaUpperEntity $oprGachaUpper */

                $upperTable = collect();
                foreach ($stepGachaTable as $gachaTableItem) {
                    /** @var GachaBoxInterface $gachaTableItem */
                    if ($gachaTableItem->isUnit()) {
                        $rarity = $mstUnits->get($gachaTableItem->getResourceId())?->getRarity();
                    } elseif ($gachaTableItem->isItem()) {
                        $rarity = $mstItems->get($gachaTableItem->getResourceId())?->getRarity();
                    } else {
                        continue;
                    }
                    if ($rarity === RarityType::UR->value) {
                        if ($oprGachaUpper->isMaxRarity() || ($oprGachaUpper->isPickup() && $gachaTableItem->getPickup())) {
                            $upperTable->add($gachaTableItem);
                        }
                    }
                }
                $maxRarityTableTotalWeight = $upperTable->sum(fn($entity) => $entity->getWeight());
                $items = $this->oprGachaPrizesToArray($upperTable, $maxRarityTableTotalWeight);
                $setName = $oprGachaUpper->isPickup() ? GachaSetName::PICKUP->value : GachaSetName::MAX_RARITY->value;
                $sets[] = [
                    'set_name' => $setName,
                    'items' => $items
                ];
            }
        }

        $steps[] = ['sets' => $sets];
    }

    return $steps;
}
```

##### 3.1.4 prizeGroupIds の収集を修正

**修正前**:
```php
$prizeGroupIds = collect();
foreach ($oprGachas as $oprGacha) {
    $prizeGroupIds->push($oprGacha->getPrizeGroupId());
    if ($oprGacha->hasFixedPrizeGroup()) {
        $prizeGroupIds->push($oprGacha->getFixedPrizeGroupId());
    }
}
```

**修正後**:
```php
$prizeGroupIds = collect();
foreach ($oprGachas as $oprGacha) {
    $prizeGroupIds->push($oprGacha->getPrizeGroupId());
    if ($oprGacha->hasFixedPrizeGroup()) {
        $prizeGroupIds->push($oprGacha->getFixedPrizeGroupId());
    }

    // ステップアップガシャの場合は各ステップの prize_group_id も収集
    if ($oprGacha->getGachaType() === \App\Domain\Gacha\Enums\GachaType::STEPUP->value) {
        /** @var OprStepUpGachaStepRepository $oprStepUpGachaStepRepository */
        $oprStepUpGachaStepRepository = app()->make(OprStepUpGachaStepRepository::class);
        $stepUpGachaSteps = $oprStepUpGachaStepRepository->getListByOprGachaId($oprGacha->getId());

        foreach ($stepUpGachaSteps as $stepUpGachaStep) {
            if ($stepUpGachaStep->prize_group_id) {
                $prizeGroupIds->push($stepUpGachaStep->prize_group_id);
            }
            if ($stepUpGachaStep->fixed_prize_group_id) {
                $prizeGroupIds->push($stepUpGachaStep->fixed_prize_group_id);
            }
        }
    }
}
```

**工数**: 3-4時間

**テスト観点**:
- ステップアップガシャで複数ステップの `steps` 配列が生成されているか
- 各ステップで異なる `prize_group_id` が使用されているか
- 確定枠がステップごとに正しく設定されているか
- 通常ガシャで `steps` 配列が1要素のままか（デグレ防止）
- JSONフォーマットがBNE仕様に準拠しているか

---

### Phase 4: ガシャシミュレーターの対応【推奨】

#### 4.1 GachaSimulator.php の修正

**ファイル**: `admin/app/Filament/Pages/GachaSimulator.php`

##### 4.1.1 ステップ選択UIの追加

**追加プロパティ**:
```php
public ?int $selectedStepNumber = null;
public array $stepOptions = [];
```

**mount メソッドの修正**:
```php
public function mount()
{
    $this->breadcrumbList();
    $this->minimumPlayNum = $this->getMinimumSimulationNum();

    // ステップアップガシャの場合はステップ選択肢を生成
    $this->setupStepOptions();

    // 初期データの設定
    if (count($this->simulationResults) === 0) {
        $this->updatedPrizeType();
    }
}

private function setupStepOptions(): void
{
    $oprGacha = OprGacha::query()->find($this->oprGachaId);
    if (!$oprGacha) {
        return;
    }

    if ($oprGacha->gacha_type === \App\Domain\Gacha\Enums\GachaType::STEPUP->value) {
        /** @var \App\Repositories\Mst\OprStepUpGachaStepRepository $repository */
        $repository = app()->make(\App\Repositories\Mst\OprStepUpGachaStepRepository::class);
        $steps = $repository->getListByOprGachaId($this->oprGachaId);

        $this->stepOptions = $steps->mapWithKeys(function ($step) {
            return [$step->step_number => "ステップ {$step->step_number}"];
        })->toArray();

        // 初期値を設定
        if ($this->selectedStepNumber === null && !empty($this->stepOptions)) {
            $this->selectedStepNumber = array_key_first($this->stepOptions);
        }
    }
}
```

##### 4.1.2 ビューファイルにステップ選択UIを追加

**ファイル**: `admin/resources/views/filament/pages/gacha-simulator.blade.php`

```blade
@if (!empty($stepOptions))
    <x-filament::section>
        <x-slot name="heading">
            ステップ選択
        </x-slot>
        <x-filament::input.wrapper>
            <x-filament::input.select wire:model.live="selectedStepNumber">
                @foreach ($stepOptions as $stepNumber => $label)
                    <option value="{{ $stepNumber }}">{{ $label }}</option>
                @endforeach
            </x-filament::input.select>
        </x-filament::input.wrapper>
    </x-filament::section>
@endif
```

##### 4.1.3 ステップごとのシミュレーション処理

**シミュレーション実行メソッドの修正**:
```php
protected function simulateGacha(int $playNum)
{
    $oprGacha = OprGacha::query()->find($this->oprGachaId);
    if (!$oprGacha) {
        throw new \Exception("OprGacha not found. opr_gacha_id: {$this->oprGachaId}");
    }

    // ステップアップガシャの場合は選択されたステップの抽選設定を使用
    if ($oprGacha->gacha_type === \App\Domain\Gacha\Enums\GachaType::STEPUP->value) {
        if ($this->selectedStepNumber === null) {
            throw new \Exception("Step number is not selected.");
        }

        /** @var \App\Repositories\Mst\OprStepUpGachaStepRepository $repository */
        $repository = app()->make(\App\Repositories\Mst\OprStepUpGachaStepRepository::class);
        $stepUpGachaStep = $repository->getByOprGachaIdAndStepNumber($this->oprGachaId, $this->selectedStepNumber);

        // ステップ固有の prize_group_id を使用
        $prizeGroupId = $stepUpGachaStep->prize_group_id;
        $fixedPrizeGroupId = $stepUpGachaStep->fixed_prize_group_id;

        // 以降、この prizeGroupId を使用してシミュレーションを実行
        // （既存のシミュレーションロジックを呼び出す）
    } else {
        // 通常ガシャの場合は既存ロジックを使用
        // （既存のシミュレーションロジックを呼び出す）
    }
}
```

##### 4.1.4 シミュレーション結果の保存にステップ番号を追加

**AdmGachaSimulationLog の修正**:
- `step_number` カラムを追加（マイグレーション作成）
- シミュレーション結果保存時にステップ番号も記録

**マイグレーション**:
```php
Schema::table('adm_gacha_simulation_logs', function (Blueprint $table) {
    $table->unsignedTinyInteger('step_number')->nullable()->comment('ステップ番号')->after('opr_gacha_id');
});
```

**工数**: 4-6時間

**テスト観点**:
- ステップアップガシャでステップ選択UIが表示されるか
- 通常ガシャでステップ選択UIが表示されないか
- ステップごとに異なる抽選設定でシミュレーションが実行されるか
- シミュレーション結果にステップ番号が保存されるか

---

## 実装優先順位

### 優先度：最高（即座に対応必須）

1. **GachaType.php のラベル追加**
   - ファイル: `admin/app/Constants/GachaType.php`
   - 影響: ステップアップガシャを選択すると例外が発生
   - 工数: 1分
   - リスク: なし

### 優先度：高（必須対応）

2. **admin側モデル・リポジトリの追加**
   - ファイル:
     - `admin/app/Models/Mst/OprStepUpGachaStep.php`（新規）
     - `admin/app/Repositories/Mst/OprStepUpGachaRepository.php`（新規）
     - `admin/app/Repositories/Mst/OprStepUpGachaStepRepository.php`（新規）
     - `admin/app/Repositories/Log/LogGachaActionRepository.php`（新規）
   - 影響: 事後検証・事前検証で必要
   - 工数: 2時間
   - リスク: 低（既存コードへの影響なし）

3. **GenerateGachaLogJson.php の修正（事後検証）**
   - ファイル: `admin/app/Console/Commands/GenerateGachaLogJson.php`
   - 影響: 事後検証が正しく動作しない
   - 工数: 2-3時間
   - リスク: 中（既存の通常ガシャへの影響をテストで確認）

4. **GenerateGachaMasterJson.php の修正（事前検証）**
   - ファイル: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
   - 影響: 事前検証が正しく動作しない
   - 工数: 3-4時間
   - リスク: 中（既存の通常ガシャへの影響をテストで確認）

### 優先度：中（推奨対応）

5. **GachaSimulator.php の修正**
   - ファイル: `admin/app/Filament/Pages/GachaSimulator.php`
   - 影響: シミュレーション結果が不正確
   - 工数: 4-6時間
   - リスク: 低（シミュレーターは本番には影響しない）

---

## テスト観点

### 単体テスト

#### GenerateGachaLogJson.php
- [ ] ステップアップガシャのログで `step_no` が実際のステップ番号になっているか
- [ ] 通常ガシャのログで `step_no` が `0` になっているか（デグレ防止）
- [ ] `log_gacha_actions` が存在しない場合に例外が発生せず `0` にフォールバックするか
- [ ] ステップ番号が `null` の場合に `0` にフォールバックするか
- [ ] 大量のログでもパフォーマンス問題が無いか

#### GenerateGachaMasterJson.php
- [ ] ステップアップガシャで `steps` 配列が複数要素になっているか
- [ ] 各ステップで異なる `prize_group_id` が使用されているか
- [ ] 確定枠がステップごとに正しく設定されているか
- [ ] 天井設定がある場合、ステップごとに正しく設定されているか
- [ ] 通常ガシャで `steps` 配列が1要素のままか（デグレ防止）
- [ ] JSONフォーマットがBNE仕様に準拠しているか
- [ ] ステップ情報が存在しない場合にエラーハンドリングされているか

#### GachaSimulator.php
- [ ] ステップアップガシャでステップ選択UIが表示されるか
- [ ] 通常ガシャでステップ選択UIが表示されないか
- [ ] ステップごとに異なる抽選設定でシミュレーションが実行されるか
- [ ] シミュレーション結果にステップ番号が保存されるか
- [ ] 通常ガシャのシミュレーションが正しく実行されるか（デグレ防止）

### 結合テスト

- [ ] **事前検証フロー**: シミュレーター実行 → マスタJSON生成 → S3アップロード → BNEシステムで表示確認
- [ ] **事後検証フロー**: ガシャ実行 → ログJSON生成 → S3アップロード → BNEシステムで表示確認

### E2Eテスト

- [ ] 実際にステップアップガシャを実行
- [ ] ログが正しく記録されているか（`log_gacha_actions` テーブルの `step_number`, `loop_count`）
- [ ] 事前検証コマンドを実行してS3にアップロード
- [ ] 事後検証コマンドを実行してS3にアップロード
- [ ] BNEガシャ排出率検証システムで正しく表示されるか

### BNE仕様準拠チェック

#### マスタJSON（事前検証）
- [ ] `steps` 配列がステップ数分存在するか
- [ ] 各ステップの `sets` 配列に `set_name` と `items` が含まれているか
- [ ] `items` 配列の各要素に `id`, `item_num`, `weight`, `weight_sp` が含まれているか
- [ ] `weight` の合計が100%になっているか（誤差許容範囲内）

#### ログJSON（事後検証）
- [ ] `step_no` が実際のステップ番号になっているか
- [ ] `set_name` が正しく設定されているか（`REGULAR`, `FIXED` 等）
- [ ] `item_id`, `item_num` が正しく設定されているか
- [ ] `timestamp` がUNIXTIME（秒）形式になっているか
- [ ] `selected_sp` が空配列になっているか（当選アイテム選択型ガシャ以外）

---

## パフォーマンス考慮事項

### GenerateGachaLogJson.php

#### 問題点
ループ内で毎回 `LogGachaActionRepository::findByLoggingInfo()` を呼び出すと、大量のログがある場合にN+1問題が発生します。

#### 対策案1: 事前一括取得
```php
// ループ前に対象日のlog_gacha_actionsを全て取得
$logGachaActions = LogGachaAction::query()
    ->whereBetween('created_at', [$startOfDay, $endOfDay])
    ->get()
    ->keyBy(function ($logGachaAction) {
        return sprintf(
            '%s_%s_%s_%d',
            $logGachaAction->usr_user_id,
            $logGachaAction->opr_gacha_id,
            $logGachaAction->nginx_request_id,
            $logGachaAction->logging_no
        );
    });

// ループ内で取得
$key = sprintf(
    '%s_%s_%s_%d',
    $logGacha->getUsrUserId(),
    $logGacha->getOprGachaId(),
    $logGacha->getNginxRequestId(),
    $logGacha->getLoggingNo()
);
$logGachaAction = $logGachaActions->get($key);
```

#### 対策案2: ページング単位で取得
```php
// ページング単位でlog_gacha_actionsを取得
$usrUserIds = $logGachas->pluck('usr_user_id')->unique();
$oprGachaIds = $logGachas->pluck('opr_gacha_id')->unique();
$nginxRequestIds = $logGachas->pluck('nginx_request_id')->unique();

$logGachaActions = LogGachaAction::query()
    ->whereIn('usr_user_id', $usrUserIds)
    ->whereIn('opr_gacha_id', $oprGachaIds)
    ->whereIn('nginx_request_id', $nginxRequestIds)
    ->whereBetween('created_at', [$startOfDay, $endOfDay])
    ->get()
    ->keyBy(function ($logGachaAction) {
        // 同じキー生成ロジック
    });
```

**推奨**: 対策案2（ページング単位で取得）がメモリ効率とクエリ効率のバランスが良いです。

### GenerateGachaMasterJson.php

#### 問題点
ステップアップガシャの `prize_group_id` 収集時に、ガシャごとにリポジトリを呼び出すとN+1問題が発生します。

#### 対策案: 事前一括取得
```php
// 事前に全てのステップアップガシャステップを取得
$stepUpGachaIds = $oprGachas
    ->filter(fn($oprGacha) => $oprGacha->getGachaType() === \App\Domain\Gacha\Enums\GachaType::STEPUP->value)
    ->pluck('id');

$allStepUpGachaSteps = collect();
if ($stepUpGachaIds->isNotEmpty()) {
    $allStepUpGachaSteps = OprStepUpGachaStep::query()
        ->whereIn('opr_gacha_id', $stepUpGachaIds)
        ->get()
        ->groupBy('opr_gacha_id');
}

// ループ内で使用
foreach ($oprGachas as $oprGacha) {
    $prizeGroupIds->push($oprGacha->getPrizeGroupId());
    if ($oprGacha->hasFixedPrizeGroup()) {
        $prizeGroupIds->push($oprGacha->getFixedPrizeGroupId());
    }

    if ($oprGacha->getGachaType() === \App\Domain\Gacha\Enums\GachaType::STEPUP->value) {
        $stepUpGachaSteps = $allStepUpGachaSteps->get($oprGacha->getId(), collect());
        foreach ($stepUpGachaSteps as $stepUpGachaStep) {
            if ($stepUpGachaStep->prize_group_id) {
                $prizeGroupIds->push($stepUpGachaStep->prize_group_id);
            }
            if ($stepUpGachaStep->fixed_prize_group_id) {
                $prizeGroupIds->push($stepUpGachaStep->fixed_prize_group_id);
            }
        }
    }
}
```

---

## 注意事項・制約事項

### 1. BNE仕様準拠の厳守
BNE側の仕様に準拠しないと検証システムが正しく動作しません。JSONフォーマットは厳密に仕様書に従ってください。

### 2. デグレッションの防止
通常ガシャ、BOXガシャなど既存ガシャタイプへの影響確認が必須です。既存のログ・マスタ生成処理が壊れないように十分なテストを実施してください。

### 3. NULL値のハンドリング
ステップアップガシャ以外では `step_number` や `loop_count` が `null` です。`null` 値を適切に処理してください（デフォルト値として `0` を設定など）。

### 4. パフォーマンス考慮
`log_gacha` と `log_gacha_actions` の結合によるパフォーマンス影響を考慮してください。インデックスの設定確認やN+1問題の回避が必要です。

### 5. 事前・事後検証の両方に対応
事前検証（シミュレーター）と事後検証（ログ）の両方が必要です。片方だけでは不十分です。

### 6. ステップ情報の取得タイミング
`log_gacha_actions` テーブルは `log_gacha` テーブルと同じタイミングで書き込まれますが、万が一タイミングがずれる可能性も考慮してエラーハンドリングを実装してください。

### 7. 周回数（loop_count）の扱い
BNE仕様書（仕様書12ページ）に「※ステップ5のガシャをプレイすると、再びステップ1に戻ります。」とありますが、ログJSONに `loop_count` を含めるべきかBNE側の仕様を確認してください。現時点では `step_no` のみ実装し、必要になったら `loop_count` を追加する方針を推奨します。

### 8. ステップごとのおまけ報酬
`opr_stepup_gacha_step_rewards` テーブルには、ステップごとのおまけ報酬が定義されていますが、BNEガシャ検証システムには報酬情報を送信する必要はありません（抽選率の検証のみ）。そのため、`OprStepUpGachaStepReward` モデルは admin 側に追加不要です。

---

## 実装スケジュール（推奨）

### フェーズ1：緊急対応（1営業日）
- [ ] `GachaType.php` のラベル追加（1分）
- [ ] 動作確認・デプロイ

### フェーズ2：事後検証対応（2-3営業日）
- [ ] admin側モデル・リポジトリの追加（2時間）
- [ ] `GenerateGachaLogJson.php` の修正（2-3時間）
- [ ] 単体テストの作成・実行（2-3時間）
- [ ] 結合テストの実施（1-2時間）
- [ ] コードレビュー・修正（1-2時間）

### フェーズ3：事前検証対応（3-4営業日）
- [ ] `GenerateGachaMasterJson.php` の修正（3-4時間）
- [ ] 単体テストの作成・実行（2-3時間）
- [ ] 結合テストの実施（1-2時間）
- [ ] コードレビュー・修正（1-2時間）

### フェーズ4：シミュレーター対応（5-7営業日）
- [ ] `GachaSimulator.php` の修正（4-6時間）
- [ ] マイグレーション作成（1時間）
- [ ] 単体テストの作成・実行（2-3時間）
- [ ] E2Eテストの実施（2-3時間）
- [ ] コードレビュー・修正（1-2時間）

### フェーズ5：本番検証（1-2営業日）
- [ ] BNEガシャ排出率検証システムでの動作確認
- [ ] ステージング環境での動作確認
- [ ] 本番環境での動作確認

---

## 問い合わせ先

**BNEガシャ検証システム関連**:
- メール: gasha_mgmt@rd.bandainamcoent.co.jp
- 報告用ML: gasha_houkoku@bandainamcoent.co.jp

**BNEガシャ排出率検証システムURL**:
- 本番環境: https://bankadm.channel.or.jp/moderator/
- ステージング環境: https://bankstg.channel.or.jp/moderator/

---

## 参考資料

- **ガシャ検証.pdf**: `docs/tasks/admin/gacha-verification/specs/ガシャ検証.pdf`
- **ガシャ検証システム_データ定義(拡張版)**: `docs/tasks/admin/gacha-verification/specs/ガシャ検証システム_データ定義(拡張版)_190912/`
- **BNEガシャ排出率検証システム オンラインヘルプ**: BNEシステム内で参照可能
- **既存まとめ**: `docs/tasks/admin/gacha-verification/ステップアップガシャ対応まとめ.md`

---

**最終更新**: 2026-02-03
**作成者**: AI Assistant (Claude Sonnet 4.5)
**レビュー状態**: 未レビュー
