# ステップアップガシャ - ガシャ検証改修 実装計画書 v2

**アプローチ**: log_gachasにstep_numberカラム追加（アプローチB）

## 概要

ステップアップガシャのガシャ検証機能（事前検証・事後検証）を実装するため、`log_gachas`テーブルに`step_number`カラムを追加し、管理ツールのガシャ検証機能を拡張する。

**アプローチ比較**: 詳細は「ステップアップガシャ_アプローチ比較分析.md」を参照。

## 実装の全体像

### Phase 0: 緊急バグ修正（独立タスク）
- `GachaType.php`のラベル不足によるクラッシュ修正

### Phase 1: API側実装
- `log_gachas`に`step_number`カラム追加
- ガシャ実行時に`step_number`を記録

### Phase 2: admin側 事後検証対応
- ガシャログJSON生成コマンドでstep_number利用

### Phase 3: admin側 事前検証対応
- ガシャマスタJSON生成コマンドでステップアップ対応

### Phase 4: admin側 ガシャシミュレーター対応
- ステップ選択UIとステップ別シミュレーション

### Phase 5: テスト・検証
- 各フェーズのテストとBNEステージング検証

## Phase 0: GachaType.phpバグ修正（緊急）

### 概要

`GachaType.php`の`label()`メソッドに`STEPUP`ケースがなく、`labels()`呼び出し時にクラッシュする不具合を修正。

### 影響範囲

- **独立タスク**: ガシャ検証改修とは無関係
- **緊急度**: 高（ステップアップガシャ存在時にクラッシュ）
- **即時デプロイ可能**

### 実装内容

#### ファイル: `admin/app/Constants/GachaType.php`

```php
// 行25-35: label()メソッド
public function label(): string
{
    return match ($this) {
        self::NORMAL => '通常',
        self::TUTORIAL => 'チュートリアル',
        self::BOX => 'BOX',
        self::STEPUP => 'ステップアップ', // ← 追加
    };
}
```

**変更箇所**: 行34の`self::BOX => 'BOX',`の後に追加

### テスト

```php
// admin/tests/Unit/Constants/GachaTypeTest.php（新規作成）
<?php

namespace Tests\Unit\Constants;

use App\Constants\GachaType;
use Tests\TestCase;

class GachaTypeTest extends TestCase
{
    public function test_all_cases_have_labels(): void
    {
        // labels()がクラッシュしないことを確認
        $labels = GachaType::labels();

        $this->assertCount(4, $labels);
        $this->assertEquals('通常', $labels[GachaType::NORMAL->value]);
        $this->assertEquals('チュートリアル', $labels[GachaType::TUTORIAL->value]);
        $this->assertEquals('BOX', $labels[GachaType::BOX->value]);
        $this->assertEquals('ステップアップ', $labels[GachaType::STEPUP->value]);
    }

    public function test_stepup_label(): void
    {
        $this->assertEquals('ステップアップ', GachaType::STEPUP->label());
    }
}
```

### デプロイ

- admin側のみデプロイ
- API側への影響なし
- 即時デプロイ可能

---

## Phase 1: API側実装

### 概要

`log_gachas`テーブルに`step_number`カラムを追加し、ステップアップガシャ実行時に記録する。

### 1.1 マイグレーション

#### ファイル: `api/database/migrations/YYYY_MM_DD_HHMMSS_add_step_number_to_log_gachas.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('log_gachas', function (Blueprint $table) {
            $table->unsignedTinyInteger('step_number')
                ->nullable()
                ->after('drawn_at')
                ->comment('ステップ番号（ステップアップガシャ用、通常ガシャはnull）');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('log_gachas', function (Blueprint $table) {
            $table->dropColumn('step_number');
        });
    }
};
```

#### 実行コマンド

```bash
# マイグレーション作成
sail artisan make:migration add_step_number_to_log_gachas --path=database/migrations

# マイグレーション実行
sail artisan migrate

# ロールバック確認
sail artisan migrate:rollback
sail artisan migrate
```

### 1.2 モデル更新

#### ファイル: `api/app/Domain/Gacha/Models/LogGacha.php`

```php
/**
 * @property int $usr_user_id
 * @property int $opr_gacha_id
 * @property int $cost_type
 * @property int $draw_count
 * @property CarbonImmutable $drawn_at
 * @property int $summon_stone_count
 * @property int|null $step_number ステップ番号（ステップアップガシャ用、通常ガシャはnull）
 */
class LogGacha extends Model
{
    // 既存コード...

    /**
     * ステップ番号を取得
     *
     * @return int|null ステップ番号（ステップアップガシャ用、通常ガシャはnull）
     */
    public function getStepNumber(): ?int
    {
        return $this->step_number;
    }

    /**
     * ステップ番号を設定
     *
     * @param int|null $stepNumber ステップ番号
     * @return $this
     */
    public function setStepNumber(?int $stepNumber): self
    {
        $this->step_number = $stepNumber;
        return $this;
    }
}
```

**変更箇所**:
- @propertyに`step_number`追加
- `getStepNumber()`メソッド追加
- `setStepNumber()`メソッド追加

### 1.3 Repository更新

#### ファイル: `api/app/Domain/Gacha/Repositories/LogGachaRepository.php`

```php
public function create(
    int $usrUserId,
    int $oprGachaId,
    CostType $costType,
    int $drawCount,
    CarbonImmutable $drawnAt,
    int $summonStoneCount,
    ?int $stepNumber = null  // ← 追加
): LogGacha {
    $logGacha = new LogGacha();
    $logGacha->setUsrUserId($usrUserId);
    $logGacha->setOprGachaId($oprGachaId);
    $logGacha->setCostType($costType);
    $logGacha->setDrawCount($drawCount);
    $logGacha->setDrawnAt($drawnAt);
    $logGacha->setSummonStoneCount($summonStoneCount);
    $logGacha->setStepNumber($stepNumber);  // ← 追加

    LogModelManager::add($logGacha);

    return $logGacha;
}
```

**変更箇所**:
- `create()`メソッドに`?int $stepNumber = null`パラメータ追加
- `$logGacha->setStepNumber($stepNumber)`呼び出し追加

**後方互換性**: デフォルト引数`null`のため、既存コードは変更不要

### 1.4 Service更新

#### ファイル: `api/app/Domain/Gacha/Services/GachaLogService.php`

```php
public function sendGachaLog(
    int $usrUserId,
    int $oprGachaId,
    CostType $costType,
    int $drawCount,
    CarbonImmutable $drawnAt,
    int $summonStoneCount,
    ?int $stepNumber = null  // ← 追加
): void {
    $this->logGachaRepository->create(
        usrUserId: $usrUserId,
        oprGachaId: $oprGachaId,
        costType: $costType,
        drawCount: $drawCount,
        drawnAt: $drawnAt,
        summonStoneCount: $summonStoneCount,
        stepNumber: $stepNumber  // ← 追加
    );
}
```

**変更箇所**:
- `sendGachaLog()`メソッドに`?int $stepNumber = null`パラメータ追加
- `create()`呼び出しに`stepNumber: $stepNumber`追加

**後方互換性**: デフォルト引数`null`のため、既存コードは変更不要

### 1.5 StepUpGachaDrawService更新

#### ファイル: `api/app/Domain/Gacha/Services/Draw/StepUpGachaDrawService.php`

```php
// 行77: currentStepNumberの確定（既存）
$currentStepNumber = $stepUpGachaUserState->getStepNumber();

// 行172-178: ガシャログ送信（修正）
$this->gachaLogService->sendGachaLog(
    usrUserId: $usrUserId,
    oprGachaId: $stepUpGachaConfig->getOprGachaId(),
    costType: $stepUpGachaConfig->getCostType(),
    drawCount: $drawCount,
    drawnAt: $drawnAt,
    summonStoneCount: $summonStoneCount,
    stepNumber: $currentStepNumber  // ← 追加
);
```

**変更箇所**: 行178の後に`stepNumber: $currentStepNumber`追加

**安全性確認**: `$currentStepNumber`は行77で確定済み（100行以上前）

### 1.6 スキーマJSON更新

#### ファイル: `api/database/schema/exports/user_tables_schema.json`

```json
{
  "log_gachas": {
    "columns": {
      "usr_user_id": "bigint unsigned",
      "opr_gacha_id": "int unsigned",
      "cost_type": "tinyint unsigned",
      "draw_count": "tinyint unsigned",
      "drawn_at": "timestamp",
      "summon_stone_count": "int unsigned",
      "step_number": "tinyint unsigned|null"
    },
    "indexes": {
      "idx_usr_user_id_drawn_at": ["usr_user_id", "drawn_at"],
      "idx_opr_gacha_id_drawn_at": ["opr_gacha_id", "drawn_at"]
    }
  }
}
```

**変更箇所**: `step_number`カラム追加

**更新コマンド**:
```bash
sail artisan schema:export --path=database/schema/exports/user_tables_schema.json
```

### 1.7 既存コードへの影響確認

#### 通常ガシャ（影響なし）

```php
// api/app/Domain/Gacha/Services/Draw/StandardGachaDrawService.php:177-183
$this->gachaLogService->sendGachaLog(
    usrUserId: $usrUserId,
    oprGachaId: $gachaConfig->getOprGachaId(),
    costType: $gachaConfig->getCostType(),
    drawCount: $drawCount,
    drawnAt: $drawnAt,
    summonStoneCount: $summonStoneCount
    // stepNumber: null（デフォルト引数）
);
```

**変更不要**: デフォルト引数`null`が使用される

#### チュートリアルガシャ（影響なし）

```php
// api/app/Domain/Tutorial/Services/TutorialLogService.php
// sendGachaLog()を呼び出していない（独自実装）
```

**影響なし**: チュートリアルガシャは独自のログ記録ロジック

#### BOXガシャ（影響なし）

BOXガシャはステップ概念がないため、影響なし。

---

## Phase 2: admin側 事後検証対応

### 概要

ガシャログJSON生成コマンドで、`log_gachas.step_number`を利用してBNE形式のログJSONを生成する。

### 2.1 ログJSON生成コマンド修正

#### ファイル: `admin/app/Console/Commands/GenerateGachaLogJson.php`

```php
// 行105: step_no修正
// 修正前
'step_no' => 0,

// 修正後
'step_no' => $logGacha->getStepNumber() ? $logGacha->getStepNumber() - 1 : 0,
```

**重要**: BNE仕様はstep_noが0始まり、サーバーのstep_numberは1始まりのため`-1`変換が必要

**ロジック**:
- ステップアップガシャ: `step_number`が1以上 → BNE用に`-1`して0始まりに変換
- 通常ガシャ: `step_number`がnull → 0を返す

#### テストケース

```php
// admin/tests/Feature/Commands/GenerateGachaLogJsonTest.php

public function test_step_number_conversion(): void
{
    // ステップアップガシャ（step_number = 1）
    $logGacha = LogGacha::factory()->create(['step_number' => 1]);
    $json = $this->generateJson($logGacha);
    $this->assertEquals(0, $json['step_no']); // BNE仕様は0始まり

    // ステップアップガシャ（step_number = 3）
    $logGacha = LogGacha::factory()->create(['step_number' => 3]);
    $json = $this->generateJson($logGacha);
    $this->assertEquals(2, $json['step_no']);

    // 通常ガシャ（step_number = null）
    $logGacha = LogGacha::factory()->create(['step_number' => null]);
    $json = $this->generateJson($logGacha);
    $this->assertEquals(0, $json['step_no']);
}
```

### 2.2 Athena定義更新

#### ファイル: `admin/database/athena_tables/log/log_gachas.sql`

```sql
CREATE EXTERNAL TABLE IF NOT EXISTS `log_gachas` (
    `usr_user_id` BIGINT,
    `opr_gacha_id` INT,
    `cost_type` TINYINT,
    `draw_count` TINYINT,
    `drawn_at` TIMESTAMP,
    `summon_stone_count` INT,
    `step_number` TINYINT  -- 追加
)
PARTITIONED BY (dt STRING)
STORED AS PARQUET
LOCATION 's3://your-bucket/log_gachas/'
TBLPROPERTIES ('parquet.compression'='SNAPPY');
```

**変更箇所**: `step_number`カラム追加

**注意**: Athena定義の更新タイミングはAPIデプロイ後

---

## Phase 3: admin側 事前検証対応

### 概要

ガシャマスタJSON生成コマンドで、ステップアップガシャの複数ステップ情報を含むマスタJSONを生成する。

### 3.1 モデル追加

#### ファイル: `admin/app/Models/Mst/OprStepUpGachaStep.php`（新規作成）

```php
<?php

declare(strict_types=1);

namespace Admin\Models\Mst;

use Api\Domain\Gacha\Models\OprStepUpGachaStep as ApiOprStepUpGachaStep;

/**
 * ステップアップガシャステップマスタモデル（admin用）
 *
 * API側のモデルを継承して使用
 */
class OprStepUpGachaStep extends ApiOprStepUpGachaStep
{
    // API側モデルをそのまま継承
}
```

**理由**: API側の`OprStepUpGachaStep`モデルを再利用

### 3.2 Repository追加

#### ファイル: `admin/app/Repositories/Mst/OprStepUpGachaStepRepository.php`（新規作成）

```php
<?php

declare(strict_types=1);

namespace Admin\Repositories\Mst;

use Admin\Models\Mst\OprStepUpGachaStep;
use Illuminate\Support\Collection;

/**
 * ステップアップガシャステップリポジトリ
 */
class OprStepUpGachaStepRepository
{
    /**
     * 複数のopr_gacha_idに紐づくステップ一覧を取得
     *
     * @param array<int> $oprGachaIds
     * @return Collection<int, Collection<int, OprStepUpGachaStep>> opr_gacha_id => steps
     */
    public function getListByOprGachaIds(array $oprGachaIds): Collection
    {
        if (empty($oprGachaIds)) {
            return collect();
        }

        $steps = OprStepUpGachaStep::query()
            ->whereIn('opr_gacha_id', $oprGachaIds)
            ->orderBy('opr_gacha_id')
            ->orderBy('step_number')
            ->get();

        return $steps->groupBy('opr_gacha_id');
    }

    /**
     * 単一のopr_gacha_idに紐づくステップ一覧を取得
     *
     * @param int $oprGachaId
     * @return Collection<int, OprStepUpGachaStep>
     */
    public function getListByOprGachaId(int $oprGachaId): Collection
    {
        return OprStepUpGachaStep::query()
            ->where('opr_gacha_id', $oprGachaId)
            ->orderBy('step_number')
            ->get();
    }
}
```

**N+1対策**: `getListByOprGachaIds()`で複数ガシャの一括取得

### 3.3 マスタJSON生成コマンド修正

#### ファイル: `admin/app/Console/Commands/GenerateGachaMasterJson.php`

```php
<?php

namespace Admin\Console\Commands;

use Admin\Constants\GachaType;
use Admin\Models\Mst\OprGacha;
use Admin\Models\Mst\OprGachaReward;
use Admin\Repositories\Mst\OprStepUpGachaStepRepository;  // 追加
use Illuminate\Console\Command;

class GenerateGachaMasterJson extends Command
{
    protected $signature = 'generate:gacha-master-json {opr_gacha_id}';
    protected $description = 'Generate gacha master JSON for BNE verification';

    public function __construct(
        private readonly OprStepUpGachaStepRepository $stepUpGachaStepRepository  // 追加
    ) {
        parent::__construct();
    }

    public function handle(): int
    {
        $oprGachaId = (int) $this->argument('opr_gacha_id');
        $oprGacha = OprGacha::find($oprGachaId);

        if (!$oprGacha) {
            $this->error("OprGacha not found: {$oprGachaId}");
            return Command::FAILURE;
        }

        // ガシャタイプ判定
        $gachaType = GachaType::from($oprGacha->gacha_type);
        $isStepUpGacha = $gachaType === GachaType::STEPUP;

        if ($isStepUpGacha) {
            // ステップアップガシャ
            $json = $this->generateStepUpGachaJson($oprGacha);
        } else {
            // 通常ガシャ
            $json = $this->generateNormalGachaJson($oprGacha);
        }

        // JSON出力
        $outputPath = storage_path("app/gacha_master_{$oprGachaId}.json");
        file_put_contents($outputPath, json_encode($json, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));

        $this->info("Generated: {$outputPath}");
        return Command::SUCCESS;
    }

    /**
     * ステップアップガシャのマスタJSON生成
     */
    private function generateStepUpGachaJson(OprGacha $oprGacha): array
    {
        $steps = $this->stepUpGachaStepRepository->getListByOprGachaId($oprGacha->opr_gacha_id);

        $stepsArray = [];
        foreach ($steps as $step) {
            $rewards = OprGachaReward::query()
                ->where('opr_gacha_id', $oprGacha->opr_gacha_id)
                ->where('step_number', $step->step_number)
                ->get();

            $stepsArray[] = [
                'step_number' => $step->step_number - 1,  // BNE仕様は0始まり
                'draw_count' => $step->draw_count,
                'rewards' => $rewards->map(fn($r) => [
                    'reward_type' => $r->reward_type,
                    'reward_id' => $r->reward_id,
                    'reward_count' => $r->reward_count,
                    'weight' => $r->weight,
                ])->toArray(),
            ];
        }

        return [
            'opr_gacha_id' => $oprGacha->opr_gacha_id,
            'gacha_type' => 'step_up',
            'steps' => $stepsArray,
        ];
    }

    /**
     * 通常ガシャのマスタJSON生成（既存ロジック）
     */
    private function generateNormalGachaJson(OprGacha $oprGacha): array
    {
        // 既存の通常ガシャJSON生成ロジック
        // ...
    }
}
```

**変更内容**:
- `OprStepUpGachaStepRepository`をDI
- ガシャタイプ判定処理追加
- `generateStepUpGachaJson()`メソッド追加
- ステップごとの報酬情報を`steps`配列として生成
- BNE仕様に合わせてstep_numberを0始まりに変換（`-1`）

**BNE JSON形式**:
```json
{
  "opr_gacha_id": 12345,
  "gacha_type": "step_up",
  "steps": [
    {
      "step_number": 0,
      "draw_count": 10,
      "rewards": [
        {
          "reward_type": 1,
          "reward_id": 100,
          "reward_count": 1,
          "weight": 500
        }
      ]
    },
    {
      "step_number": 1,
      "draw_count": 10,
      "rewards": [...]
    }
  ]
}
```

---

## Phase 4: admin側 ガシャシミュレーター対応

### 概要

Filamentガシャシミュレーターページにステップ選択UIを追加し、ステップ別のシミュレーションを可能にする。

### 4.1 シミュレーターページ修正

#### ファイル: `admin/app/Filament/Pages/GachaSimulator.php`

```php
<?php

namespace Admin\Filament\Pages;

use Admin\Constants\GachaType;
use Admin\Models\Mst\OprGacha;
use Admin\Repositories\Mst\OprStepUpGachaStepRepository;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Concerns\InteractsWithForms;
use Filament\Forms\Form;
use Filament\Pages\Page;

class GachaSimulator extends Page implements HasForms
{
    use InteractsWithForms;

    protected static ?string $navigationIcon = 'heroicon-o-cube';
    protected static string $view = 'filament.pages.gacha-simulator';
    protected static ?string $navigationLabel = 'ガシャシミュレーター';

    public ?int $opr_gacha_id = null;
    public ?int $step_number = null;  // 追加
    public ?int $simulation_count = 100;
    public ?array $results = null;

    public function __construct(
        private readonly OprStepUpGachaStepRepository $stepUpGachaStepRepository
    ) {
        parent::__construct();
    }

    public function form(Form $form): Form
    {
        return $form
            ->schema([
                Select::make('opr_gacha_id')
                    ->label('ガシャ選択')
                    ->options(OprGacha::pluck('name', 'opr_gacha_id'))
                    ->required()
                    ->reactive()  // ステップ選択の表示切り替え用
                    ->afterStateUpdated(fn($set) => $set('step_number', null)),

                Select::make('step_number')
                    ->label('ステップ選択')
                    ->options(function (callable $get) {
                        $oprGachaId = $get('opr_gacha_id');
                        if (!$oprGachaId) {
                            return [];
                        }

                        $oprGacha = OprGacha::find($oprGachaId);
                        if (!$oprGacha || GachaType::from($oprGacha->gacha_type) !== GachaType::STEPUP) {
                            return [];
                        }

                        $steps = $this->stepUpGachaStepRepository->getListByOprGachaId($oprGachaId);
                        return $steps->mapWithKeys(fn($step) => [
                            $step->step_number => "ステップ {$step->step_number} ({$step->draw_count}回)",
                        ])->toArray();
                    })
                    ->visible(function (callable $get) {
                        $oprGachaId = $get('opr_gacha_id');
                        if (!$oprGachaId) {
                            return false;
                        }
                        $oprGacha = OprGacha::find($oprGachaId);
                        return $oprGacha && GachaType::from($oprGacha->gacha_type) === GachaType::STEPUP;
                    }),

                TextInput::make('simulation_count')
                    ->label('シミュレーション回数')
                    ->numeric()
                    ->default(100)
                    ->required(),
            ]);
    }

    public function simulate(): void
    {
        $oprGacha = OprGacha::find($this->opr_gacha_id);

        if (!$oprGacha) {
            $this->results = ['error' => 'ガシャが見つかりません'];
            return;
        }

        $gachaType = GachaType::from($oprGacha->gacha_type);

        if ($gachaType === GachaType::STEPUP && !$this->step_number) {
            $this->results = ['error' => 'ステップを選択してください'];
            return;
        }

        // シミュレーション実行
        $this->results = $this->executeSimulation($oprGacha, $this->step_number);
    }

    private function executeSimulation(OprGacha $oprGacha, ?int $stepNumber): array
    {
        // シミュレーションロジック（既存 + ステップ対応）
        // ...
    }
}
```

**変更内容**:
- `step_number`プロパティ追加
- `OprStepUpGachaStepRepository`をDI
- ステップ選択フィールド追加（ステップアップガシャ時のみ表示）
- `reactive()`でガシャ選択に応じてステップ選択を動的表示

### 4.2 ビュー修正

#### ファイル: `admin/resources/views/filament/pages/gacha-simulator.blade.php`

```blade
<x-filament::page>
    <form wire:submit.prevent="simulate">
        {{ $this->form }}

        <x-filament::button type="submit" class="mt-4">
            シミュレーション実行
        </x-filament::button>
    </form>

    @if($results)
        <div class="mt-6">
            <h3 class="text-lg font-semibold">シミュレーション結果</h3>

            @if(isset($results['error']))
                <div class="text-red-600">{{ $results['error'] }}</div>
            @else
                {{-- 結果表示（既存ロジック） --}}
                <div class="mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th>報酬</th>
                                <th>出現回数</th>
                                <th>出現率</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach($results['rewards'] as $reward)
                                <tr>
                                    <td>{{ $reward['name'] }}</td>
                                    <td>{{ $reward['count'] }}</td>
                                    <td>{{ $reward['rate'] }}%</td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            @endif
        </div>
    @endif
</x-filament::page>
```

**変更内容**: エラー表示追加（ステップ未選択時のメッセージ）

---

## Phase 5: テスト・検証

### 5.1 API側テスト

#### ファイル: `api/tests/Unit/Domain/Gacha/Models/LogGachaTest.php`

```php
<?php

namespace Tests\Unit\Domain\Gacha\Models;

use Api\Domain\Gacha\Models\LogGacha;
use Tests\TestCase;

class LogGachaTest extends TestCase
{
    public function test_step_number_getter_setter(): void
    {
        $logGacha = new LogGacha();

        // nullable
        $this->assertNull($logGacha->getStepNumber());

        // set/get
        $logGacha->setStepNumber(3);
        $this->assertEquals(3, $logGacha->getStepNumber());

        // null set
        $logGacha->setStepNumber(null);
        $this->assertNull($logGacha->getStepNumber());
    }
}
```

#### ファイル: `api/tests/Feature/Domain/Gacha/Services/Draw/StepUpGachaDrawServiceTest.php`

```php
public function test_step_number_is_recorded_in_log_gachas(): void
{
    // ステップアップガシャ実行
    $response = $this->drawStepUpGacha($usrUserId, $oprGachaId);

    // log_gachasにstep_numberが記録されているか確認
    $logGacha = LogGacha::query()
        ->where('usr_user_id', $usrUserId)
        ->where('opr_gacha_id', $oprGachaId)
        ->latest('drawn_at')
        ->first();

    $this->assertNotNull($logGacha);
    $this->assertNotNull($logGacha->getStepNumber());
    $this->assertEquals(1, $logGacha->getStepNumber()); // 初回はステップ1
}
```

### 5.2 admin側テスト

#### ファイル: `admin/tests/Feature/Commands/GenerateGachaLogJsonTest.php`

```php
public function test_step_up_gacha_log_json_generation(): void
{
    // ステップアップガシャログ作成
    $logGacha = LogGacha::factory()->create([
        'opr_gacha_id' => 12345,
        'step_number' => 2,  // ステップ2
    ]);

    // JSON生成
    $this->artisan('generate:gacha-log-json', [
        'usr_user_id' => $logGacha->usr_user_id,
    ])->assertSuccessful();

    // JSONファイル確認
    $json = json_decode(file_get_contents(storage_path("app/gacha_log_{$logGacha->usr_user_id}.json")), true);

    // step_noが0始まりで記録されているか確認
    $this->assertEquals(1, $json[0]['step_no']); // step_number=2 → step_no=1（0始まり）
}
```

#### ファイル: `admin/tests/Feature/Commands/GenerateGachaMasterJsonTest.php`

```php
public function test_step_up_gacha_master_json_generation(): void
{
    // ステップアップガシャマスタ作成
    $oprGacha = OprGacha::factory()->create(['gacha_type' => GachaType::STEPUP->value]);
    OprStepUpGachaStep::factory()->count(3)->create(['opr_gacha_id' => $oprGacha->opr_gacha_id]);

    // JSON生成
    $this->artisan('generate:gacha-master-json', [
        'opr_gacha_id' => $oprGacha->opr_gacha_id,
    ])->assertSuccessful();

    // JSONファイル確認
    $json = json_decode(file_get_contents(storage_path("app/gacha_master_{$oprGacha->opr_gacha_id}.json")), true);

    $this->assertEquals('step_up', $json['gacha_type']);
    $this->assertCount(3, $json['steps']);
    $this->assertEquals(0, $json['steps'][0]['step_number']); // 0始まり
    $this->assertEquals(1, $json['steps'][1]['step_number']);
    $this->assertEquals(2, $json['steps'][2]['step_number']);
}
```

### 5.3 コード品質チェック

```bash
# PHPStan
sail phpstan

# PHPCS
sail phpcs

# Deptrac
sail deptrac

# PHPUnit
sail phpunit
```

### 5.4 BNEステージング検証

#### 事前検証

1. ステップアップガシャのマスタJSON生成
   ```bash
   sail artisan generate:gacha-master-json 12345
   ```

2. 生成されたJSONをBNEに提供

3. BNE側でマスタ検証を実施

#### 事後検証

1. ステージング環境でステップアップガシャを実行

2. ガシャログJSON生成
   ```bash
   sail artisan generate:gacha-log-json 1000001
   ```

3. 生成されたJSONをBNEに提供

4. BNE側で排出結果検証を実施

#### 検証観点

- [ ] step_numberが正しく記録されているか
- [ ] BNE仕様（0始まり）に変換されているか
- [ ] 各ステップの排出テーブルが正しいか
- [ ] 排出結果がマスタ通りか
- [ ] 通常ガシャのデグレッションがないか

---

## デプロイ順序

### 1. Phase 0デプロイ（緊急・独立）

```bash
# admin側のみ
cd admin
git add app/Constants/GachaType.php tests/Unit/Constants/GachaTypeTest.php
git commit -m "[ガシャ検証] GachaType.php STEPUPラベル追加"
# PR作成・マージ・デプロイ
```

### 2. Phase 1デプロイ（API先行）

```bash
# API側
cd api
git add database/migrations/ app/Domain/Gacha/
sail artisan migrate  # ステージング・本番
git commit -m "[ガシャ検証] log_gachas step_number追加"
# PR作成・マージ・デプロイ
```

**重要**: admin側デプロイ前にAPIデプロイを完了させる

### 3. Phase 2-4デプロイ（admin一括）

```bash
# admin側
cd admin
git add app/Console/Commands/ app/Models/Mst/ app/Repositories/Mst/ app/Filament/Pages/ resources/views/
git commit -m "[ガシャ検証] ステップアップガシャ対応 - 事前/事後検証、シミュレーター"
# PR作成・マージ・デプロイ
```

### 4. BNEステージング検証

- ステージング環境で動作確認
- BNEへマスタJSON/ログJSON提供
- 検証結果フィードバック

### 5. 本番デプロイ

- ステージング検証完了後
- API → admin の順でデプロイ

---

## トラブルシューティング

### マイグレーションエラー

**症状**: `sail artisan migrate`でエラー

**原因**: カラム名重複、型不一致

**対処**:
```bash
sail artisan migrate:rollback
# マイグレーションファイル修正
sail artisan migrate
```

### N+1問題

**症状**: ログJSON生成が遅い

**原因**: `log_gacha_actions`への1件ずつクエリ

**対処**: アプローチBでは発生しない（`$logGacha->getStepNumber()`で直接取得）

### BNE検証エラー

**症状**: BNE側で「step_noが不正」エラー

**原因**: 0始まり変換の漏れ

**対処**: `$logGacha->getStepNumber() - 1`の変換を確認

---

## 関連ドキュメント

- [ステップアップガシャ_アプローチ比較分析.md](./ステップアップガシャ_アプローチ比較分析.md)
- [ステップアップガシャ_実装チェックリスト_v2.md](./ステップアップガシャ_実装チェックリスト_v2.md)
- [実装計画書.md](./実装計画書.md)（アプローチA版、参考）
- [実装チェックリスト.md](./実装チェックリスト.md)（アプローチA版、参考）

---

## まとめ

**アプローチB（log_gachasにstep_number追加）の採用により**:

- ✅ **実装量が最小**: 約37行（アプローチAの1/7）
- ✅ **admin側変更が最小**: たった1行
- ✅ **シンプルで保守しやすい**: JOINロジック不要
- ✅ **パフォーマンスが良い**: N+1問題なし
- ✅ **テストが容易**: 複雑なRepository不要
- ✅ **後方互換性あり**: 既存コード変更不要

**スムーズな実装とデプロイが期待できます。**
