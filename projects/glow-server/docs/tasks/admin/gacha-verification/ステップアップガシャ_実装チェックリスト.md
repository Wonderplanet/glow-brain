# ステップアップガシャ - ガシャ検証システム 実装チェックリスト

## 概要
このチェックリストは、管理ツールのBNEガシャ検証システムにステップアップガシャ対応を実装する際の作業項目をまとめたものです。

**関連ドキュメント**:
- 詳細要件: `ステップアップガシャ_ガシャ検証改修要件詳細.md`
- 既存まとめ: `ステップアップガシャ対応まとめ.md`

---

## Phase 1: 緊急対応（最優先）

### 1. GachaType.php のラベル追加

- [ ] **ファイル**: `admin/app/Constants/GachaType.php`
- [ ] **作業内容**: `label()` メソッドに `self::STEPUP => 'ステップアップ',` を追加
- [ ] **動作確認**: ステップアップガシャを選択しても例外が発生しないこと
- [ ] **デグレ確認**: 他のガシャタイプのラベルが正しく表示されること
- [ ] **コミット**: 変更をコミット
- [ ] **デプロイ**: ステージング環境にデプロイ
- [ ] **本番デプロイ**: 本番環境にデプロイ

**工数**: 1分
**担当者**: _________________
**完了日**: _________________

---

## Phase 2: 事後検証の対応（必須）

### 2. admin側モデル・リポジトリの追加

#### 2.1 OprStepUpGachaStep モデルの追加

- [ ] **ファイル**: `admin/app/Models/Mst/OprStepUpGachaStep.php`（新規作成）
- [ ] **作業内容**:
  - [ ] API側の `OprStepUpGachaStep` を継承
  - [ ] `protected $connection = Database::MASTER_DATA_CONNECTION;` を設定
  - [ ] `opr_gacha()` リレーションを追加
  - [ ] `opr_stepup_gacha()` リレーションを追加
- [ ] **動作確認**: モデルが正しく動作すること
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

#### 2.2 OprStepUpGachaRepository の追加

- [ ] **ファイル**: `admin/app/Repositories/Mst/OprStepUpGachaRepository.php`（新規作成）
- [ ] **作業内容**:
  - [ ] `findByOprGachaId(string $oprGachaId): ?OprStepUpGacha` メソッドを実装
  - [ ] `getByOprGachaId(string $oprGachaId): OprStepUpGacha` メソッドを実装（存在しない場合は例外）
- [ ] **単体テスト**: リポジトリのメソッドが正しく動作すること
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

#### 2.3 OprStepUpGachaStepRepository の追加

- [ ] **ファイル**: `admin/app/Repositories/Mst/OprStepUpGachaStepRepository.php`（新規作成）
- [ ] **作業内容**:
  - [ ] `getListByOprGachaId(string $oprGachaId): Collection` メソッドを実装（ステップ番号順）
  - [ ] `findByOprGachaIdAndStepNumber(string $oprGachaId, int $stepNumber): ?OprStepUpGachaStep` メソッドを実装
  - [ ] `getByOprGachaIdAndStepNumber(string $oprGachaId, int $stepNumber): OprStepUpGachaStep` メソッドを実装（存在しない場合は例外）
- [ ] **単体テスト**: リポジトリのメソッドが正しく動作すること
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

#### 2.4 LogGachaActionRepository の追加

- [ ] **ファイル**: `admin/app/Repositories/Log/LogGachaActionRepository.php`（新規作成）
- [ ] **作業内容**:
  - [ ] `findByLoggingInfo()` メソッドを実装
    - 引数: `usrUserId`, `oprGachaId`, `nginxRequestId`, `loggingNo`, `createdAt`
    - 戻り値: `?LogGachaAction`
- [ ] **単体テスト**: リポジトリのメソッドが正しく動作すること
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

### 3. GenerateGachaLogJson.php の修正

#### 3.1 リポジトリのインジェクション

- [ ] **ファイル**: `admin/app/Console/Commands/GenerateGachaLogJson.php`
- [ ] **作業内容**:
  - [ ] `use App\Repositories\Log\LogGachaActionRepository;` を追加
  - [ ] `generateGachaLogJson()` メソッド内で `LogGachaActionRepository` をインジェクション
- [ ] **コミット**: 変更をコミット

**工数**: 5分
**担当者**: _________________
**完了日**: _________________

#### 3.2 ステップ番号の取得と設定

- [ ] **ファイル**: `admin/app/Console/Commands/GenerateGachaLogJson.php`
- [ ] **作業内容**:
  - [ ] ループ内で `LogGachaActionRepository::findByLoggingInfo()` を呼び出し
  - [ ] `'step_no' => $logGachaAction?->step_number ?? 0,` に修正
- [ ] **パフォーマンス最適化**（オプション）:
  - [ ] ループ前に `log_gacha_actions` を一括取得
  - [ ] キーでマップ化して高速検索
- [ ] **単体テスト**:
  - [ ] ステップアップガシャのログで `step_no` が実際のステップ番号になっているか
  - [ ] 通常ガシャのログで `step_no` が `0` になっているか
  - [ ] `log_gacha_actions` が存在しない場合に例外が発生しないか
- [ ] **コミット**: 変更をコミット

**工数**: 2-3時間
**担当者**: _________________
**完了日**: _________________

### 4. テスト実施

#### 4.1 単体テスト

- [ ] **テストケース1**: ステップアップガシャのログで `step_no` が正しく設定される
- [ ] **テストケース2**: 通常ガシャのログで `step_no` が `0` になる（デグレ防止）
- [ ] **テストケース3**: `log_gacha_actions` が存在しない場合に例外が発生せず `0` にフォールバック
- [ ] **テストケース4**: ステップ番号が `null` の場合に `0` にフォールバック

**工数**: 2時間
**担当者**: _________________
**完了日**: _________________

#### 4.2 結合テスト

- [ ] **テストケース1**: コマンド実行 → S3にアップロード → ファイル内容確認
- [ ] **テストケース2**: BNEガシャ排出率検証システム（ステージング）で表示確認

**工数**: 1-2時間
**担当者**: _________________
**完了日**: _________________

### 5. コードレビュー・デプロイ

- [ ] **コードレビュー**: PRを作成してレビュー依頼
- [ ] **修正対応**: レビューコメントに対応
- [ ] **ステージングデプロイ**: ステージング環境にデプロイ
- [ ] **ステージング動作確認**: 動作確認
- [ ] **本番デプロイ**: 本番環境にデプロイ

**工数**: 1-2時間
**担当者**: _________________
**完了日**: _________________

---

## Phase 3: 事前検証の対応（必須）

### 6. GenerateGachaMasterJson.php の修正

#### 6.1 リポジトリのインジェクション

- [ ] **ファイル**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
- [ ] **作業内容**:
  - [ ] `use App\Constants\GachaType;` を追加
  - [ ] `use App\Repositories\Mst\OprStepUpGachaRepository;` を追加
  - [ ] `use App\Repositories\Mst\OprStepUpGachaStepRepository;` を追加
- [ ] **コミット**: 変更をコミット

**工数**: 5分
**担当者**: _________________
**完了日**: _________________

#### 6.2 ステップアップガシャの判定と処理

- [ ] **ファイル**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
- [ ] **作業内容**:
  - [ ] `$isStepUpGacha` の判定処理を追加
  - [ ] ステップアップガシャの場合は `generateStepUpGachaSteps()` メソッドを呼び出し
  - [ ] 通常ガシャの場合は既存ロジックを使用
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

#### 6.3 generateStepUpGachaSteps メソッドの追加

- [ ] **ファイル**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
- [ ] **作業内容**:
  - [ ] `generateStepUpGachaSteps()` メソッドを実装
  - [ ] ステップ一覧を取得（`OprStepUpGachaStepRepository::getListByOprGachaId()`）
  - [ ] 各ステップの `prize_group_id` から抽選テーブルを取得
  - [ ] 各ステップの `fixed_prize_group_id` から確定枠を取得
  - [ ] 天井設定がある場合は追加
  - [ ] `steps` 配列を返却
- [ ] **エラーハンドリング**: ステップ情報が無い場合のフォールバック処理
- [ ] **コミット**: 変更をコミット

**工数**: 2-3時間
**担当者**: _________________
**完了日**: _________________

#### 6.4 prizeGroupIds の収集を修正

- [ ] **ファイル**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
- [ ] **作業内容**:
  - [ ] ステップアップガシャの場合、各ステップの `prize_group_id` と `fixed_prize_group_id` も収集
  - [ ] N+1問題を回避するため、事前一括取得を実装
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

### 7. テスト実施

#### 7.1 単体テスト

- [ ] **テストケース1**: ステップアップガシャで `steps` 配列が複数要素になっている
- [ ] **テストケース2**: 各ステップで異なる `prize_group_id` が使用されている
- [ ] **テストケース3**: 確定枠がステップごとに正しく設定されている
- [ ] **テストケース4**: 天井設定がある場合、ステップごとに正しく設定されている
- [ ] **テストケース5**: 通常ガシャで `steps` 配列が1要素のまま（デグレ防止）
- [ ] **テストケース6**: JSONフォーマットがBNE仕様に準拠している
- [ ] **テストケース7**: ステップ情報が存在しない場合にエラーハンドリングされている

**工数**: 2-3時間
**担当者**: _________________
**完了日**: _________________

#### 7.2 結合テスト

- [ ] **テストケース1**: コマンド実行 → S3にアップロード → ファイル内容確認
- [ ] **テストケース2**: BNEガシャ排出率検証システム（ステージング）で表示確認
- [ ] **テストケース3**: 各ステップの提供割合が正しく表示されている

**工数**: 1-2時間
**担当者**: _________________
**完了日**: _________________

### 8. コードレビュー・デプロイ

- [ ] **コードレビュー**: PRを作成してレビュー依頼
- [ ] **修正対応**: レビューコメントに対応
- [ ] **ステージングデプロイ**: ステージング環境にデプロイ
- [ ] **ステージング動作確認**: 動作確認
- [ ] **本番デプロイ**: 本番環境にデプロイ

**工数**: 1-2時間
**担当者**: _________________
**完了日**: _________________

---

## Phase 4: ガシャシミュレーターの対応（推奨）

### 9. マイグレーション作成

#### 9.1 adm_gacha_simulation_logs テーブルに step_number カラムを追加

- [ ] **ファイル**: `admin/database/migrations/YYYY_MM_DD_HHMMSS_add_step_number_to_adm_gacha_simulation_logs_table.php`（新規作成）
- [ ] **作業内容**:
  - [ ] `step_number` カラム（unsignedTinyInteger, nullable）を追加
  - [ ] `down()` メソッドで `dropColumn` を実装
- [ ] **マイグレーション実行**: ローカル環境で実行
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

### 10. GachaSimulator.php の修正

#### 10.1 ステップ選択UIの追加

- [ ] **ファイル**: `admin/app/Filament/Pages/GachaSimulator.php`
- [ ] **作業内容**:
  - [ ] `public ?int $selectedStepNumber = null;` プロパティを追加
  - [ ] `public array $stepOptions = [];` プロパティを追加
  - [ ] `setupStepOptions()` メソッドを実装
  - [ ] `mount()` メソッドで `setupStepOptions()` を呼び出し
- [ ] **コミット**: 変更をコミット

**工数**: 1時間
**担当者**: _________________
**完了日**: _________________

#### 10.2 ビューファイルにステップ選択UIを追加

- [ ] **ファイル**: `admin/resources/views/filament/pages/gacha-simulator.blade.php`
- [ ] **作業内容**:
  - [ ] ステップアップガシャの場合のみステップ選択ドロップダウンを表示
  - [ ] `wire:model.live="selectedStepNumber"` でLivewireバインディング
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

#### 10.3 ステップごとのシミュレーション処理

- [ ] **ファイル**: `admin/app/Filament/Pages/GachaSimulator.php`
- [ ] **作業内容**:
  - [ ] シミュレーション実行メソッドでステップアップガシャの判定
  - [ ] 選択されたステップの `prize_group_id` と `fixed_prize_group_id` を取得
  - [ ] ステップ固有の抽選設定でシミュレーションを実行
- [ ] **コミット**: 変更をコミット

**工数**: 2-3時間
**担当者**: _________________
**完了日**: _________________

#### 10.4 シミュレーション結果の保存にステップ番号を追加

- [ ] **ファイル**: `admin/app/Filament/Pages/GachaSimulator.php`
- [ ] **作業内容**:
  - [ ] `AdmGachaSimulationLog` 保存時に `step_number` も記録
- [ ] **コミット**: 変更をコミット

**工数**: 30分
**担当者**: _________________
**完了日**: _________________

### 11. テスト実施

#### 11.1 単体テスト

- [ ] **テストケース1**: ステップアップガシャでステップ選択UIが表示される
- [ ] **テストケース2**: 通常ガシャでステップ選択UIが表示されない
- [ ] **テストケース3**: ステップごとに異なる抽選設定でシミュレーションが実行される
- [ ] **テストケース4**: シミュレーション結果にステップ番号が保存される
- [ ] **テストケース5**: 通常ガシャのシミュレーションが正しく実行される（デグレ防止）

**工数**: 2-3時間
**担当者**: _________________
**完了日**: _________________

#### 11.2 E2Eテスト

- [ ] **テストケース1**: ステップアップガシャでシミュレーション実行
- [ ] **テストケース2**: 各ステップの提供割合が正しく反映されている
- [ ] **テストケース3**: シミュレーション結果がデータベースに保存されている
- [ ] **テストケース4**: 誤差率チェックが正しく動作している

**工数**: 1-2時間
**担当者**: _________________
**完了日**: _________________

### 12. コードレビュー・デプロイ

- [ ] **コードレビュー**: PRを作成してレビュー依頼
- [ ] **修正対応**: レビューコメントに対応
- [ ] **ステージングデプロイ**: ステージング環境にデプロイ
- [ ] **マイグレーション実行**: ステージング環境でマイグレーション実行
- [ ] **ステージング動作確認**: 動作確認
- [ ] **本番デプロイ**: 本番環境にデプロイ
- [ ] **マイグレーション実行**: 本番環境でマイグレーション実行

**工数**: 1-2時間
**担当者**: _________________
**完了日**: _________________

---

## Phase 5: 本番検証（全フェーズ完了後）

### 13. BNEガシャ排出率検証システムでの検証

#### 13.1 事前検証（マスタJSON）

- [ ] **テストケース1**: ステージング環境でステップアップガシャのマスタJSONを生成
- [ ] **テストケース2**: S3にアップロードされていることを確認
- [ ] **テストケース3**: BNEステージング環境で表示確認
- [ ] **テストケース4**: 各ステップの提供割合が正しく表示されている
- [ ] **テストケース5**: JSONフォーマットがBNE仕様に準拠している
- [ ] **本番環境での確認**: 本番環境でも同様に確認

**工数**: 2時間
**担当者**: _________________
**完了日**: _________________

#### 13.2 事後検証（ログJSON）

- [ ] **テストケース1**: ステージング環境でステップアップガシャを実際に実行
- [ ] **テストケース2**: ログが正しく記録されている（`log_gacha_actions` テーブルの `step_number`, `loop_count`）
- [ ] **テストケース3**: ログJSONを生成してS3にアップロード
- [ ] **テストケース4**: BNEステージング環境で表示確認
- [ ] **テストケース5**: `step_no` が実際のステップ番号になっている
- [ ] **テストケース6**: JSONフォーマットがBNE仕様に準拠している
- [ ] **本番環境での確認**: 本番環境でも同様に確認

**工数**: 2時間
**担当者**: _________________
**完了日**: _________________

### 14. 最終確認

- [ ] **ドキュメント更新**: 必要に応じてドキュメントを更新
- [ ] **運用手順書作成**: 運用手順書を作成（必要に応じて）
- [ ] **完了報告**: 関係者に完了報告

**工数**: 1時間
**担当者**: _________________
**完了日**: _________________

---

## 全体進捗

| Phase | 状態 | 担当者 | 完了日 |
|-------|------|--------|--------|
| Phase 1: 緊急対応 | ⬜ 未着手 / 🔄 進行中 / ✅ 完了 | _________ | _________ |
| Phase 2: 事後検証 | ⬜ 未着手 / 🔄 進行中 / ✅ 完了 | _________ | _________ |
| Phase 3: 事前検証 | ⬜ 未着手 / 🔄 進行中 / ✅ 完了 | _________ | _________ |
| Phase 4: シミュレーター | ⬜ 未着手 / 🔄 進行中 / ✅ 完了 | _________ | _________ |
| Phase 5: 本番検証 | ⬜ 未着手 / 🔄 進行中 / ✅ 完了 | _________ | _________ |

---

## 問題・課題管理

| No | 問題・課題 | 状態 | 担当者 | 解決日 |
|----|-----------|------|--------|--------|
| 1  |           |      |        |        |
| 2  |           |      |        |        |
| 3  |           |      |        |        |

---

**最終更新**: 2026-02-03
**作成者**: AI Assistant (Claude Sonnet 4.5)
