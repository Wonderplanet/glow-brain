# ステップアップガシャ - ガシャ検証改修 実装チェックリスト v2

**アプローチ**: log_gachasにstep_numberカラム追加（アプローチB）

## 概要

このチェックリストは、ステップアップガシャのガシャ検証機能実装の進捗管理用です。各タスクを完了したらチェックマークを付けてください。

## Phase 0: GachaType.phpバグ修正（緊急・独立）

### 実装

- [ ] `admin/app/Constants/GachaType.php`の`label()`メソッドに`self::STEPUP => 'ステップアップ',`追加
  - [ ] 行34の`self::BOX => 'BOX',`の後に追加
  - [ ] カンマの付け忘れに注意

### テスト

- [ ] `admin/tests/Unit/Constants/GachaTypeTest.php`作成
  - [ ] `test_all_cases_have_labels()`テスト実装
  - [ ] `test_stepup_label()`テスト実装
- [ ] テスト実行: `sail phpunit --filter GachaTypeTest`
- [ ] 全テスト通過確認

### コード品質チェック

- [ ] `sail phpstan` 実行・エラーなし
- [ ] `sail phpcs` 実行・エラーなし

### デプロイ

- [ ] PR作成: `[ガシャ検証] GachaType.php STEPUPラベル追加`
- [ ] レビュー・承認
- [ ] マージ
- [ ] admin側デプロイ
- [ ] 動作確認（管理画面でガシャタイプ一覧表示）

---

## Phase 1: API側実装

### 1.1 マイグレーション

- [ ] マイグレーションファイル作成
  ```bash
  sail artisan make:migration add_step_number_to_log_gachas --path=database/migrations
  ```
- [ ] `up()`メソッド実装
  - [ ] `unsignedTinyInteger('step_number')`
  - [ ] `nullable()`
  - [ ] `after('drawn_at')`
  - [ ] `comment()`追加
- [ ] `down()`メソッド実装
  - [ ] `dropColumn('step_number')`
- [ ] マイグレーション実行テスト
  ```bash
  sail artisan migrate
  sail artisan migrate:rollback
  sail artisan migrate
  ```
- [ ] カラム追加確認
  ```bash
  sail mysql -e "DESCRIBE log_gachas;"
  ```

### 1.2 モデル更新

- [ ] `api/app/Domain/Gacha/Models/LogGacha.php`修正
  - [ ] `@property int|null $step_number`追加
  - [ ] `getStepNumber(): ?int`メソッド追加
  - [ ] `setStepNumber(?int $stepNumber): self`メソッド追加
- [ ] PHPDocの順序確認（カラム定義順と一致）

### 1.3 Repository更新

- [ ] `api/app/Domain/Gacha/Repositories/LogGachaRepository.php`修正
  - [ ] `create()`メソッドに`?int $stepNumber = null`パラメータ追加
  - [ ] `$logGacha->setStepNumber($stepNumber)`呼び出し追加
  - [ ] パラメータの順序確認（テーブルカラム順と一貫）

### 1.4 Service更新

- [ ] `api/app/Domain/Gacha/Services/GachaLogService.php`修正
  - [ ] `sendGachaLog()`メソッドに`?int $stepNumber = null`パラメータ追加
  - [ ] `create()`呼び出しに`stepNumber: $stepNumber`追加
  - [ ] 名前付き引数の順序確認

### 1.5 StepUpGachaDrawService更新

- [ ] `api/app/Domain/Gacha/Services/Draw/StepUpGachaDrawService.php`修正
  - [ ] 行77の`$currentStepNumber`確認
  - [ ] 行172-178の`sendGachaLog()`呼び出しに`stepNumber: $currentStepNumber`追加
  - [ ] `$currentStepNumber`が確定していることを確認

### 1.6 スキーマJSON更新

- [ ] スキーマエクスポート実行
  ```bash
  sail artisan schema:export --path=database/schema/exports/user_tables_schema.json
  ```
- [ ] `log_gachas`の`step_number`カラム確認
  - [ ] 型: `tinyint unsigned|null`
  - [ ] `after`の順序確認

### 1.7 後方互換性確認

- [ ] `StandardGachaDrawService.php`の影響確認
  - [ ] `sendGachaLog()`呼び出しが変更不要であることを確認
  - [ ] デフォルト引数`null`が使用されることを確認
- [ ] `TutorialLogService.php`の影響確認
  - [ ] `sendGachaLog()`を呼び出していないことを確認
  - [ ] 影響なしを確認

### テスト

- [ ] `api/tests/Unit/Domain/Gacha/Models/LogGachaTest.php`作成
  - [ ] `test_step_number_getter_setter()`実装
  - [ ] nullable、set/get、null setのテスト
- [ ] `api/tests/Feature/Domain/Gacha/Services/Draw/StepUpGachaDrawServiceTest.php`修正
  - [ ] `test_step_number_is_recorded_in_log_gachas()`追加
  - [ ] ステップアップガシャ実行後のstep_number記録確認
- [ ] 既存テスト実行・通過確認
  ```bash
  sail phpunit
  ```

### コード品質チェック

- [ ] `sail phpstan` 実行・エラーなし
- [ ] `sail phpcs` 実行・エラーなし
- [ ] `sail deptrac` 実行・エラーなし

### デプロイ

- [ ] PR作成: `[ガシャ検証] log_gachas step_number追加`
- [ ] レビュー・承認
- [ ] マージ
- [ ] ステージング環境デプロイ
  - [ ] マイグレーション実行
  - [ ] 動作確認（ステップアップガシャ実行）
  - [ ] `log_gachas.step_number`記録確認
- [ ] 本番環境デプロイ
  - [ ] マイグレーション実行
  - [ ] 動作確認

---

## Phase 2: admin側 事後検証対応

### 2.1 ログJSON生成コマンド修正

- [ ] `admin/app/Console/Commands/GenerateGachaLogJson.php`修正
  - [ ] 行105の`'step_no' => 0,`を以下に修正:
    ```php
    'step_no' => $logGacha->getStepNumber() ? $logGacha->getStepNumber() - 1 : 0,
    ```
  - [ ] BNE仕様（0始まり）への変換確認
  - [ ] nullチェックの確認

### 2.2 Athena定義更新

- [ ] `admin/database/athena_tables/log/log_gachas.sql`修正
  - [ ] `step_number TINYINT`カラム追加
  - [ ] カラム順序確認
  - [ ] コメント追加
- [ ] Athenaテーブル再作成（必要に応じて）

### テスト

- [ ] `admin/tests/Feature/Commands/GenerateGachaLogJsonTest.php`作成
  - [ ] `test_step_number_conversion()`実装
  - [ ] ステップアップガシャ（step_number=1）→ step_no=0
  - [ ] ステップアップガシャ（step_number=3）→ step_no=2
  - [ ] 通常ガシャ（step_number=null）→ step_no=0
- [ ] テスト実行: `sail phpunit --filter GenerateGachaLogJsonTest`
- [ ] 全テスト通過確認

### 動作確認

- [ ] ステップアップガシャログ作成（手動またはシード）
- [ ] コマンド実行
  ```bash
  sail artisan generate:gacha-log-json {usr_user_id}
  ```
- [ ] 生成されたJSON確認
  - [ ] `step_no`が0始まりで記録されているか
  - [ ] ステップアップガシャとして正しいフォーマットか

---

## Phase 3: admin側 事前検証対応

### 3.1 モデル追加

- [ ] `admin/app/Models/Mst/OprStepUpGachaStep.php`作成
  - [ ] API側モデル（`Api\Domain\Gacha\Models\OprStepUpGachaStep`）を継承
  - [ ] namespace確認: `Admin\Models\Mst`
  - [ ] クラス名確認: `OprStepUpGachaStep`

### 3.2 Repository追加

- [ ] `admin/app/Repositories/Mst/OprStepUpGachaStepRepository.php`作成
  - [ ] `getListByOprGachaIds(array $oprGachaIds): Collection`実装
    - [ ] 複数ガシャIDの一括取得（N+1対策）
    - [ ] opr_gacha_id、step_numberでソート
    - [ ] groupBy('opr_gacha_id')
  - [ ] `getListByOprGachaId(int $oprGachaId): Collection`実装
    - [ ] 単一ガシャIDのステップ一覧取得
    - [ ] step_numberでソート
  - [ ] PHPDoc、型宣言の確認

### 3.3 マスタJSON生成コマンド修正

- [ ] `admin/app/Console/Commands/GenerateGachaMasterJson.php`修正
  - [ ] `OprStepUpGachaStepRepository`をDI
  - [ ] `handle()`メソッドにガシャタイプ判定追加
    - [ ] `GachaType::from($oprGacha->gacha_type)`
    - [ ] `$isStepUpGacha`判定
  - [ ] `generateStepUpGachaJson()`メソッド追加
    - [ ] ステップ一覧取得
    - [ ] ステップごとの報酬情報取得
    - [ ] `step_number - 1`で0始まりに変換
    - [ ] `steps`配列生成
  - [ ] `generateNormalGachaJson()`メソッド分離（既存ロジック）
  - [ ] BNE JSON形式の確認
    ```json
    {
      "opr_gacha_id": 12345,
      "gacha_type": "step_up",
      "steps": [...]
    }
    ```

### テスト

- [ ] `admin/tests/Feature/Commands/GenerateGachaMasterJsonTest.php`作成
  - [ ] `test_step_up_gacha_master_json_generation()`実装
  - [ ] ステップアップガシャマスタ作成（Factory使用）
  - [ ] コマンド実行
  - [ ] JSON形式確認
    - [ ] `gacha_type`: `step_up`
    - [ ] `steps`配列の存在
    - [ ] `step_number`が0始まり
- [ ] テスト実行: `sail phpunit --filter GenerateGachaMasterJsonTest`
- [ ] 全テスト通過確認

### 動作確認

- [ ] ステップアップガシャマスタ作成（手動またはシード）
- [ ] コマンド実行
  ```bash
  sail artisan generate:gacha-master-json {opr_gacha_id}
  ```
- [ ] 生成されたJSON確認
  - [ ] `gacha_type`が`step_up`
  - [ ] `steps`配列が正しく生成されているか
  - [ ] 各ステップの`step_number`、`draw_count`、`rewards`確認

---

## Phase 4: admin側 ガシャシミュレーター対応

### 4.1 シミュレーターページ修正

- [ ] `admin/app/Filament/Pages/GachaSimulator.php`修正
  - [ ] `step_number`プロパティ追加（public ?int）
  - [ ] `OprStepUpGachaStepRepository`をDI
  - [ ] `form()`メソッドにステップ選択フィールド追加
    - [ ] `Select::make('step_number')`
    - [ ] `reactive()`でガシャ選択に応じて動的表示
    - [ ] `options()`でステップ一覧取得
    - [ ] `visible()`でステップアップガシャ時のみ表示
  - [ ] `simulate()`メソッドにステップ未選択チェック追加
  - [ ] `executeSimulation()`メソッドにステップ対応追加

### 4.2 ビュー修正

- [ ] `admin/resources/views/filament/pages/gacha-simulator.blade.php`修正
  - [ ] エラー表示追加（`@if(isset($results['error']))`）
  - [ ] ステップ選択UI確認
  - [ ] レスポンシブ対応確認

### テスト

- [ ] ブラウザテスト
  - [ ] 通常ガシャ選択時: ステップ選択が非表示
  - [ ] ステップアップガシャ選択時: ステップ選択が表示
  - [ ] ステップ未選択でシミュレート: エラーメッセージ表示
  - [ ] ステップ選択でシミュレート: 正常動作

### 動作確認

- [ ] admin管理画面ログイン
- [ ] ガシャシミュレーターページに遷移
- [ ] ステップアップガシャ選択
  - [ ] ステップ選択プルダウンが表示されるか
  - [ ] ステップ一覧が正しく表示されるか
- [ ] ステップ選択してシミュレーション実行
  - [ ] 正常に結果が表示されるか
  - [ ] 選択したステップの排出テーブルが使用されているか

---

## Phase 5: テスト・検証

### 5.1 統合テスト

- [ ] API側全テスト実行
  ```bash
  sail phpunit
  ```
- [ ] admin側全テスト実行
  ```bash
  sail phpunit
  ```
- [ ] 全テスト通過確認

### 5.2 コード品質チェック（最終）

- [ ] API側
  - [ ] `sail phpstan` 実行・エラーなし
  - [ ] `sail phpcs` 実行・エラーなし
  - [ ] `sail deptrac` 実行・エラーなし
- [ ] admin側
  - [ ] `sail phpstan` 実行・エラーなし
  - [ ] `sail phpcs` 実行・エラーなし

### 5.3 デグレッションテスト

- [ ] 通常ガシャ
  - [ ] ガシャ実行（`log_gachas.step_number`がnull）
  - [ ] ログJSON生成（`step_no`が0）
  - [ ] マスタJSON生成（既存フォーマット）
  - [ ] ガシャシミュレーター（ステップ選択非表示）
- [ ] BOXガシャ
  - [ ] ガシャ実行（`log_gachas.step_number`がnull）
  - [ ] ログJSON生成（`step_no`が0）
  - [ ] マスタJSON生成（既存フォーマット）
- [ ] チュートリアルガシャ
  - [ ] ガシャ実行（影響なし）

### 5.4 BNEステージング検証

#### 事前検証

- [ ] ステップアップガシャのマスタJSON生成
  ```bash
  sail artisan generate:gacha-master-json {opr_gacha_id}
  ```
- [ ] 生成されたJSONをBNEに提供
- [ ] BNE側でマスタ検証を実施
- [ ] BNEからのフィードバック対応

#### 事後検証

- [ ] ステージング環境でステップアップガシャを実行
  - [ ] 複数ステップ実行（ステップ1、ステップ2、ステップ3）
  - [ ] 各ステップでのガシャ実行確認
- [ ] ガシャログJSON生成
  ```bash
  sail artisan generate:gacha-log-json {usr_user_id}
  ```
- [ ] 生成されたJSONをBNEに提供
- [ ] BNE側で排出結果検証を実施
- [ ] BNEからのフィードバック対応

#### 検証観点チェック

- [ ] step_numberが正しく記録されているか
  - [ ] ステップ1: step_number=1
  - [ ] ステップ2: step_number=2
  - [ ] ステップ3: step_number=3
- [ ] BNE仕様（0始まり）に変換されているか
  - [ ] ステップ1: step_no=0
  - [ ] ステップ2: step_no=1
  - [ ] ステップ3: step_no=2
- [ ] 各ステップの排出テーブルが正しいか
  - [ ] ステップごとに異なる報酬が排出されるか
  - [ ] 排出確率がマスタ通りか
- [ ] 排出結果がマスタ通りか
  - [ ] 期待される報酬が排出されているか
  - [ ] 排出確率の偏りがないか
- [ ] 通常ガシャのデグレッションがないか
  - [ ] 通常ガシャの挙動に変化がないか
  - [ ] ログフォーマットが正しいか

---

## デプロイチェックリスト

### デプロイ準備

- [ ] 全テスト通過確認（API、admin）
- [ ] コード品質チェック通過確認（phpstan、phpcs、deptrac）
- [ ] デグレッションテスト完了
- [ ] BNEステージング検証完了

### デプロイ順序

#### 1. Phase 0デプロイ（緊急・独立）

- [ ] admin側PR作成・マージ
- [ ] admin側デプロイ
- [ ] 動作確認

#### 2. Phase 1デプロイ（API先行）

- [ ] API側PR作成・マージ
- [ ] ステージング環境デプロイ
  - [ ] マイグレーション実行
  - [ ] 動作確認
- [ ] 本番環境デプロイ
  - [ ] マイグレーション実行
  - [ ] 動作確認

#### 3. Phase 2-4デプロイ（admin一括）

- [ ] admin側PR作成・マージ
- [ ] ステージング環境デプロイ
  - [ ] 動作確認
  - [ ] ログJSON生成確認
  - [ ] マスタJSON生成確認
  - [ ] ガシャシミュレーター確認
- [ ] 本番環境デプロイ
  - [ ] 動作確認

### デプロイ後確認

- [ ] ステップアップガシャ実行確認
  - [ ] `log_gachas.step_number`記録確認
  - [ ] 各ステップの排出確認
- [ ] ログJSON生成確認
  - [ ] `step_no`が0始まりで記録されているか
- [ ] マスタJSON生成確認
  - [ ] `steps`配列が正しく生成されているか
- [ ] ガシャシミュレーター確認
  - [ ] ステップ選択UI動作確認
  - [ ] ステップ別シミュレーション動作確認
- [ ] 通常ガシャのデグレッション確認
  - [ ] 通常ガシャが正常に動作するか

---

## トラブルシューティングチェック

### マイグレーションエラー

- [ ] エラーログ確認
- [ ] カラム名重複チェック
- [ ] 型不一致チェック
- [ ] ロールバック・再実行

### テストエラー

- [ ] エラーログ確認
- [ ] Factory定義確認
- [ ] テストデータ確認
- [ ] アサーション見直し

### BNE検証エラー

- [ ] JSONフォーマット確認
- [ ] step_no変換確認（0始まり）
- [ ] 排出テーブル確認
- [ ] 排出確率確認

### パフォーマンス問題

- [ ] N+1クエリ確認（発生しないはず）
- [ ] インデックス確認
- [ ] クエリログ確認

---

## 完了基準

### Phase 0完了

- [x] GachaType.phpバグ修正完了
- [x] テスト通過
- [x] デプロイ完了

### Phase 1完了

- [x] API側実装完了
- [x] マイグレーション実行完了
- [x] テスト通過
- [x] デプロイ完了

### Phase 2完了

- [x] ログJSON生成コマンド修正完了
- [x] Athena定義更新完了
- [x] テスト通過

### Phase 3完了

- [x] マスタJSON生成コマンド修正完了
- [x] モデル・Repository追加完了
- [x] テスト通過

### Phase 4完了

- [x] ガシャシミュレーター対応完了
- [x] ブラウザテスト通過

### Phase 5完了

- [x] 統合テスト通過
- [x] コード品質チェック通過
- [x] デグレッションテスト通過
- [x] BNEステージング検証完了

### 全体完了

- [x] 全フェーズ完了
- [x] 全デプロイ完了
- [x] BNE本番検証完了
- [x] ドキュメント更新完了

---

## 備考

- 各チェック項目は完了したら`[x]`に変更してください
- 問題が発生した場合は、トラブルシューティングセクションを参照してください
- 不明点がある場合は、実装計画書を参照してください

## 関連ドキュメント

- [ステップアップガシャ_アプローチ比較分析.md](./ステップアップガシャ_アプローチ比較分析.md)
- [ステップアップガシャ_実装計画書_v2.md](./ステップアップガシャ_実装計画書_v2.md)
- [実装計画書.md](./実装計画書.md)（アプローチA版、参考）
- [実装チェックリスト.md](./実装チェックリスト.md)（アプローチA版、参考）
