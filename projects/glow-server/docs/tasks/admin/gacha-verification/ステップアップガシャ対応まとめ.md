# ステップアップガシャ - ガシャ検証対応まとめ

## 概要

v1.6.0でステップアップガシャが実装されましたが、BNEガシャ検証システム（事前検証・事後検証）への対応が不足しています。本ドキュメントでは、必要な対応を正確にまとめます。

## 参照仕様書

- **有料ガシャに関する各種対応(国内/海外) Ver.2.1.0** (docs/tasks/admin/gacha-verification/ガシャ検証.pdf)
- ページ12：提供割合表示例 A）④ステップアップ
- ページ16-18：事前検証・事後検証
- ページ19：事後検証仕様

---

## 🔴 必須対応事項

### 1. GenerateGachaLogJson.php（事後検証：ガシャ結果とマスターデータの送信）

#### 現状の問題
**ファイル**: `admin/app/Console/Commands/GenerateGachaLogJson.php`
**Line 104-105**:
```php
// ステップアップガチャでは変更が必要
'step_no' => 0,
```

現在は常に`step_no`を`0`に設定していますが、**実際のステップ番号を記録する必要があります**。

#### 必要な対応

##### 1.1 `log_gacha_actions`テーブルとの結合
`log_gacha`テーブルと`log_gacha_actions`テーブルを以下のフィールドで関連付けて、ステップ情報を取得：

**結合キー**:
- `usr_user_id`
- `opr_gacha_id`
- `nginx_request_id`
- `logging_no`
- `created_at`（同一日時のログ）

##### 1.2 ステップ番号とループ回数の取得
`log_gacha_actions`テーブルから以下の情報を取得：
- `step_number`: 実行したステップ番号（1-5など）
- `loop_count`: 実行時の周回数

##### 1.3 修正後のコード例
```php
// log_gacha_actionsテーブルからステップ情報を取得
$logGachaAction = $logGachaActionRepository->findByLoggingInfo(
    $logGacha->getUsrUserId(),
    $logGacha->getOprGachaId(),
    $logGacha->getNginxRequestId(),
    $logGacha->getLoggingNo(),
    $logGacha->getCreatedAt()
);

$result = [
    'app_id' => $appId,
    'gasha_id' => $oprGachaId,
    'is_full_box' => 0,
    'exec_id' => $logGacha->getId(),
    // ステップアップガチャの場合は実際のステップ番号を設定
    'step_no' => $logGachaAction?->getStepNumber() ?? 0,
    'set_name' => $this->getSetName($drawnItem['prize_type']),
    'timestamp' => $logGacha->getCreatedAt()->getTimestamp(),
    'user_id' => $logGacha->getUsrUserId(),
    'item_id' => $drawnItem['resource_id'],
    'item_num' => $drawnItem['resource_amount'],
    'promised' => $this->calcPromised($drawnItem['prize_type']),
    'selected_sp' => []
];
```

##### 1.4 ループ回数の扱い
- `loop_count`もログに含めるべきか、BNE側の仕様を確認
- 仕様書12ページに「※ステップ5のガシャをプレイすると、再びステップ1に戻ります。」とあるため、ループ回数の記録が重要

---

### 2. GenerateGachaMasterJson.php（事前検証：ガシャマスターデータ送信）

#### 現状の問題
**ファイル**: `admin/app/Console/Commands/GenerateGachaMasterJson.php`
**Line 220-222**:
```php
'steps' => [
    ['sets' => $sets],
]
```

現在は1つのステップしか生成していませんが、**ステップアップガシャの場合は複数のステップを生成する必要があります**。

#### 必要な対応

##### 2.1 ステップアップガシャの判定
`opr_gachas.gacha_type`が`STEPUP`の場合、ステップアップガシャとして処理：

```php
use App\Domain\Gacha\Enums\GachaType;

if ($oprGacha->getGachaType() === GachaType::STEPUP) {
    // ステップアップガシャの処理
    $steps = $this->generateStepUpGachaSteps($oprGacha);
} else {
    // 通常ガシャの処理
    $steps = [['sets' => $sets]];
}
```

##### 2.2 ステップ情報の取得
`opr_stepup_gachas`と`opr_stepup_gacha_steps`テーブルからステップ情報を取得：

**取得する情報**:
- `opr_stepup_gachas.max_step_number`: 最大ステップ数（例: 5）
- `opr_stepup_gachas.max_loop_count`: 最大ループ回数
- `opr_stepup_gacha_steps.step_number`: ステップ番号（1, 2, 3, 4, 5...）
- `opr_stepup_gacha_steps.prize_group_id`: 各ステップの通常枠抽選グループID
- `opr_stepup_gacha_steps.fixed_prize_group_id`: 各ステップの確定枠抽選グループID
- `opr_stepup_gacha_steps.fixed_prize_count`: 各ステップの確定枠数

##### 2.3 ステップごとの`sets`生成
各ステップごとに異なる`prize_group_id`を使用して`sets`を生成：

```php
private function generateStepUpGachaSteps(OprGachaEntity $oprGacha): array
{
    // ステップアップガシャ情報を取得
    $stepUpGacha = $this->oprStepUpGachaRepository->getByOprGachaId($oprGacha->getId());
    if (!$stepUpGacha) {
        return [['sets' => []]]; // フォールバック
    }

    // 各ステップ情報を取得
    $stepUpGachaSteps = $this->oprStepUpGachaStepRepository
        ->getByOprGachaId($oprGacha->getId())
        ->sortBy('step_number');

    $steps = [];
    foreach ($stepUpGachaSteps as $stepUpGachaStep) {
        // 通常枠のsets生成
        $gachaTable = $groupedOprGachaPrizes->get($stepUpGachaStep->getPrizeGroupId(), collect());
        $totalWeight = $gachaTable->sum(fn($entity) => $entity->getWeight());
        $normalItems = $this->oprGachaPrizesToArray($gachaTable, $totalWeight);

        $sets = [
            [
                'set_name' => GachaSetName::REGULAR->value,
                'items' => $normalItems,
            ]
        ];

        // 確定枠がある場合
        if ($stepUpGachaStep->getFixedPrizeGroupId()) {
            $fixedGachaTable = $groupedOprGachaPrizes->get($stepUpGachaStep->getFixedPrizeGroupId(), collect());
            $fixedTotalWeight = $fixedGachaTable->sum(fn($entity) => $entity->getWeight());
            $fixedItems = $this->oprGachaPrizesToArray($fixedGachaTable, $fixedTotalWeight);
            $sets[] = [
                'set_name' => GachaSetName::FIXED->value,
                'items' => $fixedItems,
            ];
        }

        $steps[] = ['sets' => $sets];
    }

    return $steps;
}
```

##### 2.4 出力JSONフォーマット（BNE仕様準拠）
```json
{
  "app_id": "600",
  "app_name": "お寿司屋さんDREAM2025",
  "gasha_id": "stepup_gacha_001",
  "gasha_name": "新春初回りイベント",
  "gasha_type": 0,
  "gasha_group_id": "",
  "open_time": 1704067200,
  "close_time": 1706745599,
  "steps": [
    {
      "sets": [
        {
          "set_name": "REGULAR",
          "items": [
            {"id": "item_001", "item_num": 1, "weight": 1.000, "weight_sp": 0},
            {"id": "item_002", "item_num": 1, "weight": 1.200, "weight_sp": 0}
          ]
        }
      ]
    },
    {
      "sets": [
        {
          "set_name": "REGULAR",
          "items": [
            {"id": "item_001", "item_num": 1, "weight": 1.500, "weight_sp": 0},
            {"id": "item_002", "item_num": 1, "weight": 2.400, "weight_sp": 0}
          ]
        }
      ]
    }
  ]
}
```

---

### 3. GachaSimulator.php（ガシャシミュレーター）

#### 現状の問題
**ファイル**: `admin/app/Filament/Pages/GachaSimulator.php`

現在はステップアップガシャへの特別な対応がありません。

#### 必要な対応

##### 3.1 ステップアップガシャの判定と表示
ステップアップガシャの場合、各ステップごとにシミュレーションを実行できるようにする：

**UIの追加**:
- ステップ選択ドロップダウン（ステップ1, ステップ2, ...）
- ループ回数の表示・選択機能

##### 3.2 ステップごとのシミュレーション
各ステップは異なる抽選設定を持つため、ステップごとにシミュレーションを実行：

```php
// ステップアップガシャの場合
if ($oprGacha->getGachaType() === GachaType::STEPUP) {
    // 選択されたステップの抽選設定を取得
    $stepUpGachaStep = $this->stepUpGachaStepRepository
        ->getByOprGachaIdAndStepNumber($oprGachaId, $selectedStepNumber);

    // ステップ固有の抽選BOXを取得
    $gachaLotteryBoxData = $this->stepUpGachaService->getLotteryBox(
        $oprGacha,
        $stepUpGachaStep
    );

    // シミュレーション実行
    $gachaSimulateResultEntity = $this->adminGachaService->simulateDraw(
        $oprGachaId,
        $gachaLotteryBoxData,
        $playNum,
        $this->prizeType
    );
}
```

##### 3.3 シミュレーション結果の保存
`AdmGachaSimulationLog`にステップ番号も含めて保存：

```php
// ステップアップガシャの場合はステップ番号も保存
$admGachaSimulationLog->updateWithSimulation(
    auth()->id(),
    $playNum,
    $mstGachaDataHash,
    $this->prizeType->value,
    $gachaPrizeSimulationResultEntities,
    $now,
    $stepNumber // ステップ番号を追加
);
```

---

### 4. GachaType.php（定数定義）

#### 現状の問題
**ファイル**: `admin/app/Constants/GachaType.php`
**Line 21-35**:

```php
case STEPUP = BaseGachaType::STEPUP->value;

public function label(): string
{
    return match ($this) {
        self::TUTORIAL => 'チュートリアル',
        self::NORMAL => 'ノーマル',
        self::PREMIUM => 'プレミアム',
        self::PICKUP => 'ピックアップ',
        self::FREE => '無料',
        self::TICKET => 'チケット',
        self::FESTIVAL => 'フェス',
        self::PAID_ONLY => '有償限定',
        self::MEDAL => 'メダル',
        // ★ STEPUPのcaseがない → エラーの原因
    };
}
```

#### 必要な対応
`label()`メソッドに`STEPUP`のcaseを追加：

```php
public function label(): string
{
    return match ($this) {
        self::TUTORIAL => 'チュートリアル',
        self::NORMAL => 'ノーマル',
        self::PREMIUM => 'プレミアム',
        self::PICKUP => 'ピックアップ',
        self::FREE => '無料',
        self::TICKET => 'チケット',
        self::FESTIVAL => 'フェス',
        self::PAID_ONLY => '有償限定',
        self::MEDAL => 'メダル',
        self::STEPUP => 'ステップアップ', // 追加
    };
}
```

---

## 📊 データ構造

### ステップアップガシャ関連テーブル

#### opr_stepup_gachas
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ステップアップガシャID |
| opr_gacha_id | string | opr_gachas.id |
| max_step_number | integer | 最大ステップ数（例: 5） |
| max_loop_count | integer | 最大ループ回数 |

#### opr_stepup_gacha_steps
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ステップID |
| opr_gacha_id | string | opr_gachas.id |
| step_number | integer | ステップ番号（1, 2, 3...） |
| prize_group_id | string | 通常枠の抽選グループID |
| fixed_prize_group_id | string | 確定枠の抽選グループID（nullable） |
| fixed_prize_count | integer | 確定枠の数 |
| cost_type | CostType | コストタイプ |
| cost_id | string | コストID |
| cost_num | integer | コスト数 |
| draw_count | integer | 抽選回数 |
| is_first_free | boolean | 初回無料フラグ |

#### log_gacha_actions（ステップ情報を記録）
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | string | ULID |
| usr_user_id | string | ユーザーID |
| opr_gacha_id | string | ガシャID |
| nginx_request_id | string | リクエストID |
| logging_no | integer | ログ順番 |
| cost_type | string | コストタイプ |
| draw_count | integer | 抽選回数 |
| **step_number** | integer | **実行したステップ番号** |
| **loop_count** | integer | **実行時の周回数** |
| created_at | timestamp | 作成日時 |

### テーブル間の関連付け

**`log_gacha` ⇔ `log_gacha_actions` の結合**:
```sql
SELECT
    lg.*,
    lga.step_number,
    lga.loop_count
FROM log_gachas lg
INNER JOIN log_gacha_actions lga
    ON lg.usr_user_id = lga.usr_user_id
    AND lg.opr_gacha_id = lga.opr_gacha_id
    AND lg.nginx_request_id = lga.nginx_request_id
    AND lg.logging_no = lga.logging_no
    AND DATE(lg.created_at) = DATE(lga.created_at)
WHERE lg.opr_gacha_id = 'stepup_gacha_001'
    AND DATE(lg.created_at) = '2025-01-01';
```

---

## 📋 BNE仕様書の要件（提供割合表示例）

### ステップアップガシャの提供割合表示仕様（仕様書12ページ）

**表示要件**:
1. **説明文で仕様を説明**
   - 「※10連ガシャをプレイする回数により、提供割合が変化します。それぞれの提供割合は、下記の一覧に準じます。」
   - 「※ステップ5のガシャをプレイすると、再びステップ1に戻ります。」

2. **各ステップの提供割合を一覧表示**
   - タブ等で画面を分ける仕様推奨
   - ステップ1（1回目）、ステップ2（2回目）、ステップ3（3回目）...

3. **各ステップで異なる提供割合**
   - 各ステップごとに異なる`prize_group_id`を使用
   - 各ステップごとに異なる確定枠設定が可能

**免責事項**:
```
■ご注意
※10連ガシャをプレイする回数により、提供割合が変化します。それぞれの
提供割合は、下記の一覧に準じます。
※ステップ5のガシャをプレイすると、再びステップ1に戻ります。
※それぞれの提供割合は、小数第4位を四捨五入して表示しているため、
合計値が100％にならない場合があります。
※本ガシャからは重複するアイテムが出現する可能性があります。
```

---

## 🧪 検証要件

### 事前検証（テスト環境での自主チェック）

**実施条件**（仕様書16ページ）:
- 新しいガシャを追加する際
- 提供割合を変更する際
- ガシャの中身を入れ替える際

**シミュレーション必要回数**（仕様書17ページ）:
- 最低提供割合に応じて実行回数を決定
- 例: 0.001～0.005％未満の場合は430万回

**チェック項目**:
1. 全アイテムが排出されるか
2. 設定と結果の誤差率が30％以内に収まっているか
3. アプリ内提供割合表示と設定に矛盾が無いか

**ステップアップガシャの場合の追加チェック**:
- ✅ 各ステップごとにシミュレーションを実行
- ✅ 各ステップの提供割合が正しく設定されているか
- ✅ ステップ進行が正しく機能しているか
- ✅ ループ処理が正しく動作しているか

### 事後検証（本番環境での排出ログ確認）

**検証方法**（仕様書18ページ）:
- 本番環境のガシャの排出ログを「BNEガシャ排出率検証システム」に蓄積
- 国内版のみ、外部委託会社がタイミング・タイトル抜き打ちで排出ログを確認

**開発要件**:
- 国内・海外ともに「BNEガシャ排出率検証システム」にガシャのログを送信
- 各バイナリ毎にガシャのログを送信

**ステップアップガシャの場合の追加要件**:
- ✅ `step_number`を正しくログに記録
- ✅ `loop_count`を正しくログに記録
- ✅ 各ステップのマスタ情報を正しく送信

---

## 🎯 実装優先順位

### 優先度：高（必須対応）

1. **GachaType.php**: `STEPUP`ラベルの追加
   - 影響範囲: 小
   - 工数: 1分
   - リスク: エラーの原因になる可能性

2. **GenerateGachaLogJson.php**: ステップ番号の記録
   - 影響範囲: 中
   - 工数: 2-3時間
   - リスク: 事後検証が正しく動作しない

3. **GenerateGachaMasterJson.php**: 複数ステップの生成
   - 影響範囲: 中
   - 工数: 3-4時間
   - リスク: 事前検証が正しく動作しない

### 優先度：中（推奨対応）

4. **GachaSimulator.php**: ステップごとのシミュレーション
   - 影響範囲: 中
   - 工数: 4-6時間
   - リスク: シミュレーション結果が不正確

---

## 📝 実装チェックリスト

### 1. GenerateGachaLogJson.php
- [ ] `LogGachaActionRepository`の作成または拡張
- [ ] `log_gacha`と`log_gacha_actions`の結合処理
- [ ] `step_number`の取得と設定
- [ ] `loop_count`の取得と設定（仕様確認後）
- [ ] ステップアップガシャ以外への影響確認（null値のハンドリング）
- [ ] 単体テストの作成

### 2. GenerateGachaMasterJson.php
- [ ] `OprStepUpGachaRepository`の確認
- [ ] `OprStepUpGachaStepRepository`の確認
- [ ] ステップアップガシャの判定ロジック
- [ ] `generateStepUpGachaSteps()`メソッドの実装
- [ ] 各ステップの`sets`生成ロジック
- [ ] ステップアップガシャ以外への影響確認
- [ ] JSONフォーマットのバリデーション
- [ ] 単体テストの作成

### 3. GachaSimulator.php
- [ ] ステップ選択UIの追加
- [ ] ループ回数表示UIの追加
- [ ] ステップごとのシミュレーションロジック
- [ ] `AdmGachaSimulationLog`へのステップ番号保存
- [ ] シミュレーション結果の表示調整
- [ ] 単体テストの作成

### 4. GachaType.php
- [ ] `label()`メソッドに`STEPUP`追加
- [ ] 既存コードへの影響確認

---

## 🔍 テスト観点

### 単体テスト

#### GenerateGachaLogJson.php
- [ ] ステップアップガシャのログが正しく生成される
- [ ] 通常ガシャのログが正しく生成される（デグレ防止）
- [ ] `log_gacha_actions`が存在しない場合のハンドリング
- [ ] ステップ番号がnullの場合のハンドリング

#### GenerateGachaMasterJson.php
- [ ] ステップアップガシャのマスタが正しく生成される
- [ ] 通常ガシャのマスタが正しく生成される（デグレ防止）
- [ ] ステップ数が異なる場合の対応（3ステップ、5ステップ、10ステップ等）
- [ ] 確定枠がない場合の対応
- [ ] JSONフォーマットのバリデーション

#### GachaSimulator.php
- [ ] 各ステップごとにシミュレーションが正しく実行される
- [ ] 通常ガシャのシミュレーションが正しく実行される（デグレ防止）
- [ ] ステップごとの提供割合が正しく反映される

### 結合テスト

- [ ] 事前検証：シミュレーター → マスタJSON生成 → BNEシステム送信
- [ ] 事後検証：ガシャ実行 → ログJSON生成 → BNEシステム送信
- [ ] BNEガシャ排出率検証システムでの表示確認

### E2Eテスト

- [ ] 実際にステップアップガシャを実行
- [ ] ログが正しく記録される
- [ ] BNEシステムに正しく送信される
- [ ] BNEシステムで正しく表示される

---

## 📞 問い合わせ先

**BNEガシャ検証システム関連**:
- メール: gasha_mgmt@rd.bandainamcoent.co.jp
- 報告用ML: gasha_houkoku@bandainamcoent.co.jp

**BNEガシャ排出率検証システムURL**:
- 本番環境: https://bankadm.channel.or.jp/moderator/
- ステージング環境: https://bankstg.channel.or.jp/moderator/

---

## 📚 参考資料

- ガシャ検証.pdf（本ドキュメント）
- ガシャ検証システム_データ定義(拡張版)（別紙）
- BNEガシャ排出率検証システム オンラインヘルプ

---

## 🚀 実装スケジュール（推奨）

### フェーズ1：緊急対応（1営業日）
1. `GachaType.php`のラベル追加
2. `GenerateGachaLogJson.php`の基本対応（step_number設定）

### フェーズ2：コア機能実装（3-5営業日）
3. `GenerateGachaMasterJson.php`の複数ステップ対応
4. 単体テスト作成
5. 結合テスト実施

### フェーズ3：シミュレーター対応（5-7営業日）
6. `GachaSimulator.php`のステップ対応
7. E2Eテスト実施
8. BNEシステムでの動作確認

---

## ⚠️ 注意事項

1. **BNE仕様準拠の厳守**
   - BNE側の仕様に準拠しないと検証システムが正しく動作しない
   - JSONフォーマットは厳密に仕様書に従う

2. **デグレッションの防止**
   - 通常ガシャ、BOXガシャなど既存ガシャタイプへの影響確認が必須
   - 既存のログ・マスタ生成処理が壊れないように注意

3. **NULL値のハンドリング**
   - ステップアップガシャ以外では`step_number`や`loop_count`がnull
   - null値を適切に処理する（デフォルト値として0を設定など）

4. **パフォーマンス考慮**
   - `log_gacha`と`log_gacha_actions`の結合によるパフォーマンス影響
   - インデックスの設定確認

5. **事前・事後検証の両方に対応**
   - 事前検証（シミュレーター）と事後検証（ログ）の両方が必要
   - 片方だけでは不十分

---

**最終更新**: 2026-02-03
**作成者**: AI Assistant
**レビュー状態**: 未レビュー
