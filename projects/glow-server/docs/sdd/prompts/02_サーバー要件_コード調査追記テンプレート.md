あなたはバックエンドエンジニアの API 開発スペシャリストです。

既に、ゲーム体験仕様書（PDF）から「サーバー要件抽出.md」を作成済みです。
しかし、そのファイルは「仕様書に明示されている範囲」でしか要件を拾えておらず、
コード上で事実上の前提となっている要件や、仕様書に書かれていない細かい制約は含まれていません。

これから行ってほしいのは、次の2つです：

1. `サーバー要件抽出.md` を起点に、対象機能に関する **既知のサーバー要件の一覧を把握する**
2. 実際のコードベースを調査して、**仕様書に書かれていない／抽出されていない追加のサーバー要件** を漏れなく洗い出す

=================
【前提情報】

- 仕様書からの抽出結果:
  - ファイル: `@docs/sdd/features/{FEATURE_NAME}/01_サーバー要件抽出.md`
- 対象機能の名前（キーワード）:
  - 例: スタミナブースト など
- 調査対象:
  - このリポジトリ内のコード全体（API 層、ドメイン層、ユースケース層、ジョブ、バッチ、マイグレーション、設定ファイルなど）

=================
【調査の目的】

- 仕様書からの「サーバー要件抽出.md」だけでは分からない、
  コード上で暗黙に前提とされているサーバー要件・制約・前提条件を洗い出し、
  **「追加で考慮すべきサーバー要件」として整理すること**。

- ここでいう「サーバー要件」は以下のようなものを含みます：
  - データの保存・更新・削除の条件
  - 状態遷移やフラグの扱い
  - バリデーションや制約
  - 例外ケースの扱い
  - 既存機能との連携・依存（ミッション・クエスト・ログ・ランキング等）
  - パフォーマンス・スケーラビリティに関わる前提
  - セキュリティ・認可・不正対策上の前提
  - 非同期処理・バッチ・キューに関する前提

※ 実装方式（新規 API を追加する/しない、DB スキーマをどうする 等）を「こうすべき」と決めつけるのではなく、
　**「サーバー側で前提になっていること・考慮が必要なこと」を要件レベルで整理する**ことが目的です。

=================
【作業手順のガイド】

以下のステップで、コード調査を進めてください：

1. `@docs/sdd/features/{FEATURE_NAME}/01_サーバー要件抽出.md` を読み、
   対象機能（例: {FEATURE_NAME}）に関する既知のサーバー要件をざっと把握する。

2. 対象機能名や関連キーワードでコード検索する：
   - 例: 「stamina」「boost」「quest」「mission」「energy」など
   - コントローラ / ルート定義 / ユースケースクラス / ドメインモデル / サービス / リポジトリ / バッチ / ジョブ を順番にたどる

3. 対象機能に関係しそうなコードについて、
   次の観点で「サーバー要件になりそうな内容」がないかを確認する：
   - 入力パラメータとその制約（null 不可、範囲、型）
   - 既存テーブルのカラムやフラグの意味・利用条件
   - 例外パターン（残高不足・上限超え・期間外・フラグ未設定 等）の扱い
   - 他機能との連携条件（ミッション、ログ、ランキング、実績 等）
   - イベント発行やログ出力の必須条件
   - 複数回リクエスト時の振る舞い（冪等性・重複防止）
   - 非同期処理やバッチ処理に依存した前提
   - 時刻・タイムゾーン・日付切替の前提
   - スタミナや通貨など他リソースとの整合性

4. 各コード断片から読み取れる「サーバー要件」を文章として整理する。
   - 仕様書に既に書かれている内容の「補足」か
   - 仕様書には書かれておらず「コードから新たに分かった要件」か
   を区別する。

   **【重要】既存実装パターンを発見した場合の記載ルール：**

   既存実装パターン（例：リセット処理、報酬付与、トランザクション処理など）を発見した場合、
   以下の4点を必ず明記してください：

   a) **実装パターンの概要**
      - 何をどのように実装しているか
      - どのメソッド・クラスで実現されているか

   b) **適用範囲**
      - どのような要件・機能に適用可能か
      - 今回の新機能が適用範囲に該当するかどうか
      - 例：「ユーザーごとの定期リセット処理全般（日次・週次・月次）に適用可能」

   c) **実装方針の背景**（可能であれば）
      - なぜその方式を採用しているか
      - 例：「バッチ処理基盤の保守コスト削減」「リアルタイム性の確保」

   d) **代替案が必要になる条件**（可能であれば）
      - どのような場合に異なる実装が必要か
      - 今回の新機能がその条件に該当するかどうか
      - 例：「リセット対象が全ユーザー（数百万人）の場合」

   これにより、Stage 3のレビュー時に「既存パターンで解決できる事項」を正しく識別できます。

5. 出力結果を Markdown でまとめ、以下のファイルに保存する：
   - **`docs/sdd/features/{FEATURE_NAME}/02_サーバー要件_コード調査追記.md`**
   - **注意: ファイル名には番号プレフィックス "02_" を必ず含めてください**

=================
【出力フォーマット】

出力は、次の形式で Markdown としてまとめてください。

## サーバー要件（コード調査による追加・補足）

### 要件C-1
- 種別: コードから判明した追加要件 / 仕様書要件の補足
- 関連機能: （例）{FEATURE_NAME} / 通常スタミナ消費 など
- 関連ファイル:
  - `app/.../SomeService.php` の `someMethod`
  - `app/.../Controllers/...Controller.php` の `actionX`
- 内容の要約:
  - （サーバー側で前提となっている挙動・制約を一文で）
- 詳細:
  - （どういう条件で何をしているのか、コードをもとに自然文で整理）
- 元になったコードの抜粋（必要に応じて短く）:
  ```php
  // 必要な部分だけ（数行以内）
  ```
- 備考:
  - （仕様書との関係：仕様書に記載がない / 曖昧 / 補足になっている 等）

### 要件C-2
- （同様に続ける）

※ 要件番号は C-1, C-2, ... のように「Code」の C を頭につけてください。

---

**【既存実装パターンを記載する場合の追加フォーマット】**

既存実装パターンを発見した場合、上記の基本フォーマットに加えて、以下の項目を追加してください：

### 要件C-X: （例）ユーザーデータのリセット処理
- 種別: コードから判明した追加要件
- 関連機能: リセット処理全般
- 関連ファイル:
  - `api/app/Domain/Shop/Services/ShopService.php` の `resetUsrShopItem`, `tradeShopItem`
  - `api/app/Domain/Common/Entities/Clock.php` の `isFirstToday`, `isFirstWeek`, `isFirstMonth`
- 内容の要約:
  - 日次・週次・月次のリセット処理は、Clock機能を使ったアクセス時判定で実装されている
- 詳細:
  - 既存のShop機能では、リセットタイミングの判定に`Clock`クラスの`isFirstToday()`などのメソッドを使用
  - リセット処理は、APIリクエスト処理時（`tradeShopItem()`メソッド内）で実行される
- **実装パターンの適用範囲**:
  - **ユーザーごとの定期リセット処理全般（日次・週次・月次）に適用可能**
  - **今回の{FEATURE_NAME}のリセット処理もこの適用範囲に該当する**
- **実装方針の背景**:
  - バッチ処理基盤（cron、AWS EventBridge等）の保守コストを削減
  - リアルタイム性の確保（04:00にバッチが動かなくても、次回アクセス時に確実にリセット）
- **代替案が必要になる条件**:
  - リセット対象が全ユーザー（数百万人）かつ一斉処理が必要な場合
  - アクセス時のレスポンスタイムが厳しく制約される場合
  - **今回の{FEATURE_NAME}機能はこれらの条件に該当しない**
- 元になったコードの抜粋:
  ```php
  // ShopService.php - tradeShopItem()
  public function tradeShopItem(...) {
      // リセットの必要があれば実行（アクセス時判定）
      $this->resetUsrShopItem($usrShopItem, $mstShopItem, $now);
      ...
  }
  ```
- 備考:
  - 仕様書には「毎月初日04:00にリセット」という結果のみ記載されており、実装方法は未記載

=================
【表現ポリシー】

「〜という動きになっているため、この挙動を前提としたサーバー要件として整理する」
のように、事実ベース＋要件整理のスタンスで記載してください。

「新しい API を追加するべき」「この設計は良くないので変更するべき」のような
設計判断・評価・提案は、このファイルでは行いません。
あくまで「現状コードから読み取れる前提・制約・要件」を整理することに専念してください。

=================

以上を踏まえ、コードベースを調査し、以下のファイル名でサーバー要件をまとめてください：

**`docs/sdd/features/{FEATURE_NAME}/02_サーバー要件_コード調査追記.md`**

**重要: ファイル名には必ず番号プレフィックス "02_" を含めてください。**
