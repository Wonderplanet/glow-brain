# 外部決済機能 - サーバー要件コード調査追記

## 概要

本ドキュメントは、「01_サーバー要件抽出.md」で抽出した要件に対して、既存コードベースを調査して判明した追加要件・実装パターン・暗黙の前提を記載したものです。

---

## 調査結果サマリー

### 既存の課金システムとの関係性

- **既存のアプリ内課金システム**: Apple/Google課金基盤が実装済み
- **共通データモデル**: `usr_store_infos`, `usr_store_products`, `usr_store_product_histories`テーブルが存在
- **バンダイナムコID連携**: `usr_users.bn_user_id`カラムと`log_bnid_links`テーブルが存在
- **課金基盤ライブラリ**: WonderPlanet社製の`laravel-wp-framework`を使用

---

## 追加要件一覧

### 追加要件1: 既存テーブルの拡張

**発見箇所:**
- `api/database/migrations/*store*.php`
- `usr_store_product_histories`, `usr_store_infos`テーブル構造

**コード内容:**
```php
// usr_store_product_histories テーブル
- receipt_unique_id: varchar(255) NOT NULL
- os_platform: varchar(16) NOT NULL
- usr_user_id: varchar(255) NOT NULL
- age: int(11) NOT NULL
- product_sub_id: varchar(255) NOT NULL
- platform_product_id: varchar(255) NOT NULL
- mst_store_product_id: varchar(255) NOT NULL
- currency_code: varchar(16) NOT NULL
- purchase_price: decimal(20,6) NOT NULL
- is_sandbox: tinyint(4) NOT NULL
- billing_platform: varchar(16) NOT NULL
```

**追加要件:**
- 外部決済でも既存の`usr_store_product_histories`テーブルを使用する可能性が高い
- `billing_platform`に新しい値（例: "webstore", "xsolla"）を追加する必要がある
- 外部決済固有の情報（Xsollaのorder.id, order.invoice_id等）を保存するカラムの追加が必要
- `receipt_unique_id`を外部決済のトランザクションIDと対応付ける設計が必要

---

### 追加要件2: 年齢制限の実装パターン

**発見箇所:**
- `api/app/Domain/Shop/Services/AppShopService.php` (L42-58)

**コード内容:**
```php
/** @var int  この年齢以下は、限度額が最少 */
private const MIN_PURCHASE_LIMIT_AGE = 15;

/** @var int  この年齢以下は、限度額が2番目に少ない */
private const MIDDLE_PURCHASE_LIMIT_AGE = 17;

/** @var int  この年齢以上は、限度額なし */
private const PURCHASE_LIMIT_NONE_AGE = 18;

private const PURCHASE_LIMIT_MAX_MONTHLY_PAID_AMOUNT = [
    self::MIN_PURCHASE_LIMIT_AGE => 5000,
    self::MIDDLE_PURCHASE_LIMIT_AGE => 20000,
];
```

**追加要件:**
- 日本向けの年齢制限（18歳未満は無料アイテムのみ）は、既存の年齢制限ロジックを拡張する必要がある
- 海外向けの年齢制限（13歳以下ログイン不可、14歳以上の子供アカウントは無料アイテムのみ）は新規実装が必要
- `usr_store_infos.age`カラムを使用して年齢情報を管理
- 月次の課金額リセット処理（`renotify_at`）が既に実装されているが、外部決済でも同様の処理が必要かどうか検討が必要

---

### 追加要件3: 購入回数制限の管理

**発見箇所:**
- `api/app/Domain/Shop/Models/UsrStoreProduct.php`
- `usr_store_products`テーブル

**コード内容:**
```php
// usr_store_products テーブル
- usr_user_id: varchar(255) NOT NULL (PRI)
- product_sub_id: varchar(255) NOT NULL (PRI)
- purchase_count: int(10) unsigned NOT NULL
- purchase_total_count: int(10) unsigned NOT NULL DEFAULT 0
- last_reset_at: timestamp NOT NULL
```

**追加要件:**
- 外部決済でも商品の購入回数制限を管理する必要がある
- `purchase_count`は期間内の購入回数、`purchase_total_count`は累計購入回数
- `last_reset_at`はリセット日時を管理
- 外部決済とアプリ内課金で購入回数を共有するのか、別管理するのか要検討

---

### 追加要件4: サンドボックスモードの管理

**発見箇所:**
- `api/database/migrations/2023_11_02_030404_wp_currency_add_is_sandbox.php`
- `usr_store_product_histories.is_sandbox`カラム

**コード内容:**
```php
$table->tinyInteger('is_sandbox')
    ->comment('サンドボックス・テスト課金から購入したら1, 本番購入なら0')
    ->after('price_per_amount');
```

**追加要件:**
- Xsollaの`transaction.dry_run`（支払いウェブフック）と`order.mode`（注文支払い成功ウェブフック）を`is_sandbox`カラムに記録する必要がある
- テスト決済のデータは、本番データと明確に区別して記録する
- `usr_store_product_histories`と`log_stores`の両方に`is_sandbox`カラムが存在し、両方に記録が必要

---

### 追加要件5: 購入許可情報（Allowance）の管理

**発見箇所:**
- `api/app/Domain/Shop/UseCases/AllowanceUseCase.php`
- `usr_store_allowances`テーブル

**コード内容:**
```php
// usr_store_allowances テーブル
- usr_user_id: varchar(255) NOT NULL (PRI)
- product_id: varchar(255) NOT NULL (PRI)
- mst_store_product_id: varchar(255) NOT NULL
- product_sub_id: varchar(255) NOT NULL
- os_platform: varchar(16) NOT NULL
- billing_platform: varchar(16) NOT NULL (PRI)
- device_id: varchar(255)
```

**追加要件:**
- アプリ内課金では、購入前に`usr_store_allowances`レコードを作成して購入権を管理している
- 外部決済でも「決済事前確認」時に同様のAllowance管理が必要かどうか検討が必要
- 外部決済の場合、WebStore側が購入権を管理するため、サーバー側では別の仕組み（トランザクションID管理等）が適切かもしれない

---

### 追加要件6: レシート検証と重複防止

**発見箇所:**
- `api/app/Domain/Shop/UseCases/ShopPurchaseUseCase.php` (L119-126)

**コード内容:**
```php
try {
    $storeReceipt = $this->billingDelegator->verifyReceipt(
        $billingPlatform,
        $productId,
        $receipt
    );
} catch (WpBillingDuplicateReceiptException $e) {
    throw new GameException(
        ErrorCode::BILLING_VERIFY_RECEIPT_DUPLICATE_RECEIPT,
        $e->getMessage(),
        $e
    );
}
```

**追加要件:**
- 外部決済でも`order.id`をキーとして重複購入を検証する仕組みが必要
- 既存のアプリ内課金は課金基盤ライブラリ（`BillingDelegator`）でレシート検証と重複チェックを実施
- 外部決済の場合、Xsollaの署名検証とorder.idの重複チェックを独自実装する必要がある
- べき等性を保証するため、同一`order.id`で2回目以降のリクエストが来た場合は、1回目の処理結果を返す実装が必要

---

### 追加要件7: トランザクション強制終了処理

**発見箇所:**
- `api/app/Domain/Shop/UseCases/ShopPurchaseUseCase.php` (L164-230)

**コード内容:**
```php
try {
    // 購入可能かチェック
    $this->shopBillingService->validatePurchase($usrUserId, $now, $oprProduct);
    // 購入金額による年齢確認
    $this->appShopService->updateAndValidateUsrStoreInfoForPurchase(...);
} catch (GameException $e) {
    // 購入回数上限を超えていて購入できないはずなので、
    // トランザクションを強制終了する
    if ($e->getCode() === ErrorCode::SHOP_TRADE_COUNT_LIMIT) {
        $this->transaction(function () use (...) {
            $this->billingDelegator->forceClosePurchase(...);
        });
        throw new GameException(
            ErrorCode::BILLING_TRANSACTION_END_PURCHASE_LIMIT,
            ...
        );
    }
}
```

**追加要件:**
- 決済が完了しているが、何らかの理由（購入回数上限、年齢制限等）で購入できない場合の処理が必要
- アプリ内課金では`forceClosePurchase`でトランザクションを強制終了し、ログに記録
- 外部決済でも同様に、決済完了後にエラーが発生した場合の処理フロー（返金要求等）が必要
- 仕様書には「永続エラーの場合は返金が必要」と記載されているが、具体的な返金処理の実装が必要

---

### 追加要件8: 報酬送付システムとの連携

**発見箇所:**
- `api/app/Domain/Reward/Delegators/RewardDelegator.php`
- `api/app/Domain/Resource/Entities/RewardSendPolicy.php`

**コード内容:**
```php
public function sendRewards(
    string $usrUserId,
    int $platform,
    CarbonImmutable $now,
    ?RewardSendPolicy $policy = null,
): void {
    $this->rewardSendService->sendRewards($usrUserId, $platform, $now, $policy);
}
```

**追加要件:**
- アイテム付与処理には既存の`RewardDelegator`と`RewardSendService`を使用する
- `RewardSendPolicy`でリソース上限超過時の挙動を制御できる
  - `SEND_TO_MESSAGE`: メッセージボックスに送る
  - `THROW_ERROR_WHEN_RESOURCE_LIMIT_REACHED`: エラーを投げる
  - `NONE`: 直接付与
- 外部決済でアイテム付与失敗した場合の挙動（メッセージ送付、エラー返却、リトライ等）を定義する必要がある
- アイテム付与エラー時の対応方針
  - リソース上限超過の場合: メッセージボックスに送るか、エラーを返してXsollaにリトライさせるか
  - データ不整合の場合: エラーログを記録し、手動対応が必要

---

### 追加要件9: Bank連携のデータ構造

**発見箇所:**
- `api/app/Domain/Resource/Log/Services/LogBankService.php`
- `log_banks`テーブル

**コード内容:**
```php
// log_banks テーブル
- usr_user_id: varchar(255) NOT NULL
- event_id: enum('100','200','300') NOT NULL
- platform_user_id: varchar(50) NOT NULL
- user_first_created_at: timestamp NOT NULL
- user_agent: text NOT NULL
- os_platform: int(11) NOT NULL
- os_version: varchar(255) NOT NULL
- country_code: varchar(255) NOT NULL
- ad_id: varchar(64)
```

**追加要件:**
- 外部決済の購入データもBankシステムに送信する必要がある
- `country_code`はリクエストヘッダー`X-Country-Code`から取得している
- 外部決済の場合、WebStoreから取得した国情報を`country_code`に記録するのか、アプリのヘッダー情報を使うのか要検討
- Bankへの送信タイミング：アイテム付与成功後か、ウェブフック受信時か

---

### 追加要件10: Adjust連携

**発見箇所:**
- 仕様書に記載されているが、コードベースには明示的なAdjust連携実装が見つからなかった
- `log_banks`テーブルに`ad_id`カラムが存在

**追加要件:**
- AdjustへのクライアントIP送信機能を実装する必要がある
- カスタムパラメータ`user_ip`をXsollaから受け取り、Adjustに転送する実装が必要
- 既存のアプリ内課金でAdjust連携がどのように実装されているか追加調査が必要

---

### 追加要件11: 国コード・通貨コードの管理

**発見箇所:**
- `api/app/Domain/Shop/Services/ShopPurchaseHistoryService.php`
- `usr_store_product_histories.currency_code`カラム

**コード内容:**
```php
// 既存のアプリ内課金では、レシートから通貨コードを取得
$currencyCode = $request->input('currency_code');
```

**追加要件:**
- 仕様書では「ユーザー情報取得APIで国コード・通貨コードを返す」とあるが、これらの情報をどこに保存するか要検討
- 候補1: `usr_users`テーブルに`country_code`, `currency_code`カラムを追加
- 候補2: `usr_os_platforms`テーブルを拡張
- 候補3: 新規テーブル`usr_webstore_infos`を作成
- 仕様書の「一度登録した国及び通貨情報は更新しない」という要件を実装に反映する必要がある
- デバッグ用の国コード・通貨コード上書き機能の実装が必要

---

### 追加要件12: ウェブフック署名検証とIP制限

**発見箇所:**
- 仕様書に記載されているが、既存コードベースには類似実装が見つからなかった

**追加要件:**
- Xsollaからのウェブフックリクエストの署名を検証する実装が必要
- 許可IPアドレスからのアクセスのみを受け付けるミドルウェアまたはファイアウォール設定が必要
- Laravel Middlewareで実装するか、インフラレベル（ALB/NLB）で制御するか要検討

---

### 追加要件13: エラーハンドリングとステータスコード

**発見箇所:**
- `api/app/Domain/Common/Constants/ErrorCode.php`（推測）
- `api/app/Exceptions/Handler.php`

**追加要件:**
- 外部決済用の新しいエラーコードを定義する必要がある
  - ユーザー未登録（400）
  - 購入権限なし（400: 年齢制限等）
  - トランザクションID重複（400）
  - メンテナンス中（503）
  - 内部エラー（500）
- ウェブフックのレスポンスで適切なHTTPステータスコードを返す実装が必要
  - 200: 成功
  - 400: 永続エラー（返金が必要）
  - 500: 一時エラー（リトライ可能）
  - 503: メンテナンス中（リトライ可能）

---

### 追加要件14: デッドロック対策

**発見箇所:**
- 仕様書「同時購入の処理について」セクション
- 既存コードでは明示的なロック機構は見つからなかったが、トランザクション処理は実装されている

**追加要件:**
- アプリ内課金とWeb課金が同時発生した場合のデッドロック回避が必要
- データベーステーブルへのアクセス順序を統一する（例: 常に`usr_users` → `usr_store_infos` → `usr_items`の順）
- 楽観的ロックまたは悲観的ロックの導入を検討
- `usr_store_product_histories.receipt_unique_id`にユニークインデックスを設定し、重複挿入をDB制約で防ぐ

---

### 追加要件15: トランザクションIDの発行と管理

**発見箇所:**
- 仕様書「決済事前確認」セクション
- 既存のAllowance処理

**追加要件:**
- 決済事前確認時にトランザクションIDを発行する実装が必要
- トランザクションIDは一意である必要がある（UUID等）
- トランザクションIDと最終的な`order.id`を紐付けて管理する仕組みが必要
- トランザクションIDの有効期限を設定するか検討（例: 発行から24時間以内に決済完了が必要）

---

### 追加要件16: カスタムパラメータの処理

**発見箇所:**
- 仕様書「カスタムパラメータ」セクション

**追加要件:**
- 以下のカスタムパラメータを受け取り、適切に処理・記録する実装が必要
  - `internal_id`: アプリのユーザーID（`usr_user_id`）
  - `transaction_id`: 決済事前確認で発行したトランザクションID
  - `user_ip`: クライアントのIPアドレス（Adjust連携用）
  - `store_code`: ストアコード（日本/海外の識別等）
  - `country_from_ip`: IPアドレスから判定した国コード
  - `is_country_mismatch`: 国コード不一致フラグ
- これらの情報を`usr_store_product_histories`または専用テーブルに保存する

---

### 追加要件17: items配列のフィルタリング（type=virtual_good）

**発見箇所:**
- 仕様書「itemsの中身が複数件になる場合の処理について」セクション

**追加要件:**
- 決済事前確認および注文支払い成功時に、`items`配列から`type=virtual_good`のみをフィルタする実装が必要
- 他のタイプ（例: クーポン、無料アイテム等）は無視する
- `items`配列が複数件の場合でも、`type=virtual_good`のSKUのみを処理する

---

### 追加要件18: 無料アイテム・クーポンの特殊処理

**発見箇所:**
- 仕様書「無料アイテムおよびクーポンとアイテムを交換した場合について」セクション

**追加要件:**
- 無料アイテムやクーポン交換の場合、以下の挙動に対応する必要がある
  - `order.invoice_id`がNULL
  - `order.currency`がNULL
  - 「ユーザーの検証」「支払い」ウェブフックが発生しない
- NULL値を適切に処理できるコードを実装する（NULL許容カラム、NULL チェック等）
- 無料アイテムの場合でも、年齢制限のチェックは必要（18歳未満は無料アイテムOK）

---

### 追加要件19: キャンセルウェブフックの処理

**発見箇所:**
- 仕様書「キャンセルについて」セクション

**追加要件:**
- Xsollaからキャンセル通知が来た場合は、500エラーを返す実装が必要
- 「システム的なキャンセルの連携は行わない」という方針を実装に反映
- キャンセル通知が来た場合のログ記録は必要かどうか検討

---

### 追加要件20: ウェブフックの死活監視

**発見箇所:**
- 仕様書「ウェブフックの死活監視について」セクション

**追加要件:**
- ウェブフックエンドポイントの正常性を監視する仕組みが必要
- 監視方法の候補
  - ヘルスチェックエンドポイントの実装
  - CloudWatch Alarms等でエラー率を監視
  - 定期的なテストリクエストの送信
- 異常検知時のアラート通知（Slack、メール等）の実装

---

### 追加要件21: ログ記録とトレーサビリティ

**発見箇所:**
- `log_close_store_transactions`テーブル
- `log_stores`テーブル

**コード内容:**
```php
// log_close_store_transactions テーブル
- usr_user_id: varchar(255) NOT NULL
- platform_product_id: varchar(255) NOT NULL
- mst_store_product_id: varchar(255) NOT NULL
- raw_receipt: mediumtext NOT NULL
- currency_code: varchar(16) NOT NULL
- receipt_unique_id: varchar(255) NOT NULL
- is_sandbox: tinyint(4) NOT NULL
- trigger_type: varchar(255) NOT NULL
- trigger_name: varchar(255) NOT NULL
- trigger_detail: text
- request_id: varchar(255) NOT NULL
- nginx_request_id: varchar(255) NOT NULL
```

**追加要件:**
- 外部決済でも以下のログを記録する必要がある
  - ウェブフック受信ログ（リクエストボディ全体）
  - 処理結果ログ（成功/失敗、エラー内容）
  - トランザクション完了/強制終了ログ
  - 国コード不一致ログ（不正購入検知用）
- `raw_receipt`にXsollaのウェブフックボディ全体（JSON）を保存する
- `trigger_type`, `trigger_name`で外部決済を識別できるようにする（例: "webstore_purchase"）

---

### 追加要件22: 誕生日情報の管理

**発見箇所:**
- 仕様書「アプリ側の誕生日を使った年齢認証について」セクション
- `usr_store_infos.age`カラム

**追加要件:**
- ユーザー情報取得APIで`birthday`と`birthday_month`を返す必要がある
- 誕生日情報がない場合は空文字で返すと、ログインできないという制約がある
- 既存の`usr_store_infos.age`から誕生日を逆算するのは不可能なため、以下のいずれかが必要
  - ユーザーに誕生日入力を求める画面を追加
  - バンダイナムコIDに登録されている誕生日情報を取得できる場合は、それを使用
  - WebStoreに事前申請して、アプリ側で誕生日を保持しない運用にする

---

### 追加要件23: メンテナンス中の処理

**発見箇所:**
- 仕様書「ユーザ情報の取得 > Responses」セクション
- 既存コードでメンテナンス機能があるか不明

**追加要件:**
- メンテナンス中の判定処理が必要
- メンテナンス中はウェブフックに対して503エラーを返す実装が必要
- メンテナンス状態を管理する仕組み（DB、設定ファイル、環境変数等）の検討

---

### 追加要件24: 居住国の照合処理

**発見箇所:**
- 仕様書「国の制御（海外版のみ）」セクション

**追加要件:**
- 「アプリのダウンロード国/通貨情報」と「バンダイナムコIDの居住国」を照合する実装が必要
- バンダイナムコIDの居住国情報を取得するAPI呼び出しが必要（仕様書に詳細があるか確認）
- 不一致の場合の挙動
  - ダウンロード国と居住国が異なる場合: ログインできない（エラー返却）
  - アクセス国と居住国が異なる場合: ログインは可能だが、ログを記録

---

### 追加要件25: ウェブフックリトライ処理への対応

**発見箇所:**
- 仕様書のシーケンス図「支払い通知リトライ(最大12回)」「決済完了通知リトライ(最大19回)」

**追加要件:**
- Xsolla側が自動的にリトライを行うため、サーバー側はべき等性を保証する必要がある
- 同じ`order.id`で複数回リクエストが来た場合、1回目の処理結果を返す実装が必要
- リトライ回数の上限（最大12回または19回）を超えた場合の対応フローを検討

---

### 追加要件26: 環境変数の追加

**発見箇所:**
- `api/.env.example` (L181-184)

**コード内容:**
```ini
BNID_ACCESS_TOKEN_URL=
X_BNID_REMOTE_ADDRESS=
X_BNID_CLIENT_ID=
X_BNID_CLIENT_SECRET=
```

**追加要件:**
- 外部決済用の環境変数を追加する必要がある
  - `XSOLLA_WEBHOOK_SECRET`: 署名検証用のシークレットキー
  - `XSOLLA_ALLOWED_IPS`: 許可するIPアドレスのリスト
  - `WEBSTORE_API_URL`: WebStore APIのURL（必要に応じて）
  - `ADJUST_API_KEY`: Adjust連携用のAPIキー（必要に応じて）

---

### 追加要件27: 既存の課金基盤ライブラリとの関係

**発見箇所:**
- `api/app/Domain/Shop/UseCases/ShopPurchaseUseCase.php`
- `WonderPlanet\Domain\Billing\Delegators\BillingDelegator`

**追加要件:**
- 既存のアプリ内課金は`laravel-wp-framework`の`BillingDelegator`を使用している
- 外部決済は課金基盤ライブラリを使用せず、独自実装する必要がある
- ただし、以下の共通処理は既存のサービスを再利用できる可能性がある
  - 年齢制限チェック（`AppShopService::updateAndValidateUsrStoreInfoForPurchase`）
  - 購入回数制限チェック（`ShopBillingService::validatePurchase`）
  - 報酬送付処理（`RewardDelegator::sendRewards`）
  - ストア情報管理（`usr_store_infos`テーブル操作）

---

## 実装パターンの推奨事項

### 1. ドメイン層の構成

既存のShopドメインを参考に、以下の構成を推奨：

```
api/app/Domain/WebStore/
├── Controllers/
│   ├── WebStoreWebhookController.php          # ウェブフック受信
├── UseCases/
│   ├── GetUserInfoUseCase.php                  # W1: ユーザ情報の取得
│   ├── ValidatePaymentUseCase.php              # W2: 決済事前確認
│   ├── ValidateUserUseCase.php                 # W3: ユーザー検証
│   ├── ProcessPaymentUseCase.php               # W4: 支払い
│   └── ProcessOrderSuccessUseCase.php          # W5: 注文支払い成功
├── Services/
│   ├── WebStoreAuthService.php                 # 署名検証、IP制限
│   ├── WebStoreTransactionService.php          # トランザクションID管理
│   ├── WebStoreUserService.php                 # ユーザー情報取得
│   ├── WebStorePurchaseService.php             # 購入処理
│   └── WebStoreRewardService.php               # アイテム付与
├── Repositories/
│   ├── UsrWebStoreInfoRepository.php           # 国コード・通貨コード管理
│   └── LogWebStoreTransactionRepository.php    # トランザクションログ
├── Models/
│   ├── UsrWebStoreInfo.php
│   └── LogWebStoreTransaction.php
├── Entities/
│   ├── WebStoreUserInfoEntity.php
│   ├── WebStoreTransactionEntity.php
│   └── WebStoreOrderEntity.php
├── Enums/
│   ├── WebStoreEventType.php                   # W1-W5のイベント種別
│   └── WebStoreErrorCode.php                   # 外部決済用エラーコード
└── Delegators/
    └── WebStoreDelegator.php                   # 外部から呼び出すインターフェース
```

### 2. トランザクション管理

- **べき等性の保証**: `order.id`をキーとして処理済みチェック
- **ロック戦略**: `usr_store_product_histories.receipt_unique_id`にユニークインデックス
- **エラーハンドリング**: 永続エラー（400）と一時エラー（500）を明確に区別

### 3. ログ設計

- **ウェブフック受信ログ**: すべてのウェブフックリクエストを`log_webstore_webhooks`テーブルに記録
- **処理結果ログ**: 成功/失敗、エラー内容を`log_webstore_transactions`テーブルに記録
- **不正購入検知ログ**: 国コード不一致、年齢制限違反等を記録

---

## 参照ファイル

### 調査したファイル一覧

**ドメイン層:**
- `api/app/Domain/Shop/UseCases/ShopPurchaseUseCase.php`
- `api/app/Domain/Shop/UseCases/AllowanceUseCase.php`
- `api/app/Domain/Shop/Services/AppShopService.php`
- `api/app/Domain/Shop/Services/ShopBillingService.php`
- `api/app/Domain/User/Services/UserAccountLinkService.php`
- `api/app/Domain/Reward/Delegators/RewardDelegator.php`
- `api/app/Domain/Resource/Entities/RewardSendPolicy.php`
- `api/app/Domain/Resource/Log/Services/LogBankService.php`

**データベース:**
- `usr_store_infos`テーブル
- `usr_store_products`テーブル
- `usr_store_product_histories`テーブル
- `usr_store_allowances`テーブル
- `usr_users`テーブル（`bn_user_id`カラム）
- `usr_os_platforms`テーブル
- `log_bnid_links`テーブル
- `log_banks`テーブル
- `log_close_store_transactions`テーブル
- `mst_store_products`テーブル

**マイグレーション:**
- `api/database/migrations/2023_11_02_030404_wp_currency_add_is_sandbox.php`
- `api/database/migrations/2024_10_29_064448_add_bnid_link_coumuns_to_usr_users.php`
- `api/database/migrations/2025_04_14_000000_create_log_bnid_links_table.php`

**設定:**
- `api/.env.example` (BNID関連の環境変数)

---

## 次のステップ

1. **要件の優先順位付け**: 追加要件の中で、MVPに必須のものと、後回しにできるものを仕分ける
2. **データモデルの設計**: 既存テーブルの拡張 vs 新規テーブル作成の判断
3. **API設計**: 5つのウェブフックエンドポイントの詳細設計
4. **エラーハンドリング設計**: エラーコード体系、リトライ戦略、返金フローの詳細化
5. **テスト戦略**: sandboxモードでの動作確認、E2Eテストシナリオの作成

---

## 備考

- 既存のアプリ内課金システムとの共通点が多いため、コードの再利用を積極的に検討すべき
- ただし、外部決済特有の要件（署名検証、カスタムパラメータ、無料アイテム処理等）もあるため、適切に分離して実装する必要がある
- バンダイナムコID連携の実装が既にあるため、ユーザー認証周りは比較的スムーズに実装できると予想される
