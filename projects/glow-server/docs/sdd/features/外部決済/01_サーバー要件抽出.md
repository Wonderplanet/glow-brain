# 外部決済機能 - サーバー要件抽出

## 概要

本ドキュメントは、外部決済機能(WEB STORE)のゲーム体験仕様書PDFから、サーバー側で考慮すべき要件を抽出したものです。

---

## サーバー要件一覧

### 要件1: ユーザー認証とアプリ連携
- **元ページ:** Page 1, 「概要 > ユーザ認証&アプリ連携」セクション
- **抜粋:**
  > WebStoreはバンダイナムコIDでログインを行う。
  > 対象アプリでバンダイナムコIDを紐づけてもらうことでユーザーを一意に認識する。
- **サーバー観点での補足:**
  - バンダイナムコIDとアプリ内ユーザーIDの紐付け情報をサーバー側で管理・検証する必要がある

### 要件2: 年齢による制御（日本）
- **元ページ:** Page 1, 「概要 > 年齢による制御」セクション
- **抜粋:**
  > アソビストア&Bandai Namco Entertainment WebStore（日本）
  > 全年齢でログイン可能
  > 18歳未満は無料アイテムとプロモーションコードのみ利用可能
- **サーバー観点での補足:**
  - ユーザーの年齢情報を管理し、年齢に応じた購入権限の制御を行う必要がある

### 要件3: 年齢による制御（海外）
- **元ページ:** Page 1, 「概要 > 年齢による制御」セクション
- **抜粋:**
  > Bandai Namco Entertainment WebStore（海外）
  > 13歳以下はログイン不可
  > 14歳以上のこどもアカウントは無料アイテムとプロモーションコードのみ利用可能
- **サーバー観点での補足:**
  - 海外向けの年齢制限ルールをサーバー側で実装・検証する必要がある

### 要件4: 国の制御（海外版のみ）
- **元ページ:** Page 1, 「概要 > 国の制御（海外版のみ）」セクション
- **抜粋:**
  > アプリ側の「ダウンロード国もしくは通貨情報」と「バンダイナムコIDの居住国」が違う場合はログインできない
  > 上記により為替を利用した不正購入を防止する
- **サーバー観点での補足:**
  - アプリのダウンロード国/通貨情報とバンダイナムコID居住国の照合処理が必要

### 要件5: 不正防止チェック用ログ取得
- **元ページ:** Page 2, 「概要 > 国の制御（海外版のみ）」セクション
- **抜粋:**
  > 「アクセスしている国情報」と「バンダイナムコIDの居住国」が異なってもログインは可能。
  > ただし、不正防止チェック用にログを取得し検知を行う
- **サーバー観点での補足:**
  - 国情報の不一致を記録し、不正購入の検知・分析を行う仕組みが必要

### 要件6: アイテム反映のポップアップ通知
- **元ページ:** Page 2, 「アプリ側のアイテム反映イメージ」セクション
- **抜粋:**
  > ゲーム再起動時、もしくはショップ画面に遷移した際に、ユーザーにアイテムの反映をポップアップで通知する。（推奨仕様）
- **サーバー観点での補足:**
  - 外部決済で付与されたアイテムの通知状態を管理し、クライアントに通知情報を提供する必要がある

### 要件7: ウェブフック - ユーザ情報の取得
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.W1
- **抜粋:**
  > W1 ウェブフック ユーザ情報の取得 ログイン時にアプリの情報を返却
- **サーバー観点での補足:**
  - WebStore側からのユーザー情報取得リクエストに対して、アプリのユーザー情報を返却するエンドポイントが必要

### 要件8: ウェブフック - 決済事前確認
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.W2
- **抜粋:**
  > W2 ウェブフック 決済事前確認 対象ユーザがアイテムの購入権利がある
- **サーバー観点での補足:**
  - 購入前にユーザーの購入権限を検証し、トランザクションIDを発行する処理が必要

### 要件9: ウェブフック - ユーザー検証
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.W3
- **抜粋:**
  > W3 ウェブフック ユーザー検証 購入直前に対象ユーザが存在するか確認
- **サーバー観点での補足:**
  - Xsollaからの購入直前のユーザー存在確認リクエストに応答する必要がある

### 要件10: ウェブフック - 支払い
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.W4
- **抜粋:**
  > W4 ウェブフック 支払い 購入実行時に対象ユーザがアイテムの購
- **サーバー観点での補足:**
  - 決済実行時の支払い通知を受け取り、適切に応答する処理が必要

### 要件11: ウェブフック - 注文支払い成功（アイテム付与）
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.W5
- **抜粋:**
  > W5 ウェブフック 注文支払い成功 ユーザにアイテムを付与する
- **サーバー観点での補足:**
  - 決済完了後にユーザーへアイテムを付与する処理が必要（非同期処理）

### 要件12: AdjustへのクライアントIP送信
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.A2
- **抜粋:**
  > A2 アプリ AdjustにクライアントIPを送信 アイテム付与時にAdjustにクライアント
- **サーバー観点での補足:**
  - アイテム付与時にAdjustへクライアントIPアドレスを含む情報を送信する必要がある

### 要件13: Bankへの購入データ送信
- **元ページ:** Page 3, 「アプリ側開発項目」表、No.B1
- **抜粋:**
  > B1 Bank 購入データの送信 BankにWEB STOREの購入データを送信
- **サーバー観点での補足:**
  - 外部決済の購入データをBank（内部システム）に送信・記録する必要がある

### 要件14: ウェブフックの署名検証
- **元ページ:** Page 9, 「ウェブフック > 概要」セクション
- **抜粋:**
  > 下記のウェブフックをアプリ側で実装する。シーケンス図に記載の通り基本的に通信の方式としては下記2通りのウェブフックが存在し、WEB STORE側から通知するウェブフックもXsollaの仕様に準拠する。
- **サーバー観点での補足:**
  - ウェブフックリクエストの署名を検証し、正当性を確認する処理が必要

### 要件15: ウェブフック通知元IPアドレスの制限
- **元ページ:** Page 9-10, 「ウェブフック > 通知元のIPアドレス」セクション
- **抜粋:**
  > ウェブフックは下記のIPアドレスから通知されます。
  > 下記IP以外からの通信は対象のIPアドレス以外の通知を許可しないようにしてください。
- **サーバー観点での補足:**
  - ウェブフックエンドポイントへのアクセスを特定のIPアドレスに制限する必要がある

### 要件16: カスタムパラメータの処理
- **元ページ:** Page 11, 「ウェブフック > カスタムパラメータ」セクション
- **抜粋:**
  > XsollaのウェブフックにWebストアのウェブフックで取得したデータを下記の形で送信する。
  > user_ipにはユーザのIPアドレスを付与して送信する。（Adjustに利用する）
- **サーバー観点での補足:**
  - カスタムパラメータ（internal_id、transaction_id、user_ip、store_code、country_from_ip、is_country_mismatch）を適切に処理・記録する必要がある

### 要件17: ユーザー情報取得APIの実装
- **元ページ:** Page 11-14, 「ユーザ情報の取得」セクション
- **抜粋:**
  > アプリのユーザ情報を取得する
  > REQUEST BODY SCHEMA: notification_type, user, custom_parameters
  > RESPONSE SCHEMA: user (id, internal_id, name, level, birthday, birthday_month, country, currency)
- **サーバー観点での補足:**
  - バンダイナムコIDの情報からアプリのユーザー情報（ID、名前、レベル、誕生日、ダウンロード国、通貨コード）を返却するAPIが必要

### 要件18: ユーザー情報取得の400/503エラー処理
- **元ページ:** Page 12-14, 「ユーザ情報の取得 > Responses」セクション
- **抜粋:**
  > 400 エラー RESPONSE SCHEMA: error (code, message)
  > 503 メンテナンス RESPONSE SCHEMA: error (message)
- **サーバー観点での補足:**
  - ユーザーが未登録の場合やメンテナンス中の場合のエラーハンドリングが必要

### 要件19: 決済事前確認APIの実装
- **元ページ:** Page 15-17, 「決済事前確認」セクション
- **抜粋:**
  > 決済を行う前に事前確認をする
  > REQUEST BODY SCHEMA: notification_type, user, custom_parameters, purchase
  > RESPONSE SCHEMA: transaction_id
- **サーバー観点での補足:**
  - アイテムとユーザー情報から購入権利を確認し、トランザクションIDを発行するAPIが必要

### 要件20: 決済事前確認の年齢判定
- **元ページ:** Page 17, 「決済事前確認 > Request samples」セクション
- **抜粋:**
  > "birthday": "20050408"
- **サーバー観点での補足:**
  - 決済事前確認時にユーザーの年齢（未成年かどうか）をチェックし、購入可否を判定する必要がある

### 要件21: itemsの複数件対応（type=virtual_good）
- **元ページ:** Page 18, 「実装における注意点 > itemsの中身が複数件になる場合の処理について」セクション
- **抜粋:**
  > 販売方法によっては下記のWebhookにおいて「items」に「type=virtual_good」以外のものが含まれることがあり、その場合「items」の中身が複数件になります。
  > その場合でも、「type=virtual_good」のskuのみ付与処理を行うようにしてください。
- **サーバー観点での補足:**
  - 決済事前確認および注文支払い成功時に、items配列から「type=virtual_good」のみをフィルタして処理する必要がある

### 要件22: アイテムの購入金額と通貨コードの管理
- **元ページ:** Page 18, 「実装における注意点 > アイテムの購入金額と通貨コードについて」セクション
- **抜粋:**
  > アイテムの購入金額と通貨コードは「注文支払い成功」の下記の値を参照してください。
  > 通貨：order.currency
  > 金額：order.amount
  > ※ BankやAdjustに送信するデータも上記の値を利用してください。
- **サーバー観点での補足:**
  - 注文支払い成功時に受け取るorder.currencyとorder.amountを記録し、Bank/Adjustへの送信に利用する必要がある

### 要件23: Xsolla連携データの保存
- **元ページ:** Page 18, 「実装における注意点 > アプリ側で保持するデータについて」セクション
- **抜粋:**
  > Xsollaから取得される下記のデータはXsolla側との突き合わせに必要になるため、必ずDBに保存してください。
  > 「注文支払い成功」ウェブフックの「order.id」と「order.invoice_id」を保存してください。
- **サーバー観点での補足:**
  - 注文支払い成功時のorder.idとorder.invoice_idをデータベースに保存する必要がある

### 要件24: sandboxモードのチェック
- **元ページ:** Page 19, 「実装における注意点 > 不正購入防止について > sandboxモードのチェック」セクション
- **抜粋:**
  > 「支払い」ウェブフックの「transaction.dry_run」が1の場合はテスト決済になります。
  > 「注文支払い成功」ウェブフックの「order.mode」が「sandbox」の場合はテスト決済になります。
- **サーバー観点での補足:**
  - テスト決済と本番決済を区別し、テスト決済の場合は適切に処理（または除外）する必要がある

### 要件25: 同一注文IDの重複処理防止
- **元ページ:** Page 19, 「実装における注意点 > 不正購入防止について > 同一注文IDで重複してユーザにアイテムを付与しない」セクション
- **抜粋:**
  > 通信エラーなどでウェブフックのリトライが発生します。「注文支払い成功」ウェブフックの「order.id」は一意の値のため、アプリ側ですでに処理済みの「order.id」だった場合は、付与処理などは行わなず、前回の付与結果を応答するように実装してください。
- **サーバー観点での補足:**
  - order.idをキーとして処理済みかどうかを判定し、重複付与を防止する仕組みが必要（べき等性の保証）

### 要件26: 同時購入のデッドロック対策
- **元ページ:** Page 19, 「実装における注意点 > 同時購入の処理について」セクション
- **抜粋:**
  > Webストアとアプリ側で同時購入を行った場合に、デッドロック等のエラーが発生しないか処理を確認してください。
- **サーバー観点での補足:**
  - アプリ内課金とWeb課金が同時に発生した場合のデッドロックやロック競合を回避する設計が必要

### 要件27: 誕生日情報の管理
- **元ページ:** Page 19, 「実装における注意点 > アプリ側の誕生日を使った年齢認証について」セクション
- **抜粋:**
  > アプリ側で誕生日を保持していない場合は、事前にWEB STORE側に申請が必要です。
  > birthday及びbirthday_monthを空で返した場合はログインが行えません。
- **サーバー観点での補足:**
  - アプリ側で誕生日情報を保持している場合とそうでない場合で、ユーザー情報取得APIのレスポンスを適切に変更する必要がある

### 要件28: 無料アイテム・クーポンの特殊処理
- **元ページ:** Page 19, 「実装における注意点 > 無料アイテムおよびクーポンとアイテムを交換した場合について」セクション
- **抜粋:**
  > 無料アイテムやクーポンとアイテムを交換する場合は決済を行わないため通常の購入フローと下記の点が異なります。
  > 「ユーザーの検証 user_validation」「支払い payment」のウェブフックが発生しません。
  > 「order.invoice_id」「order.currency」がNULLになります。
- **サーバー観点での補足:**
  - 無料アイテムやクーポン交換の場合、決済関連の情報がNULLになることを考慮した処理が必要

### 要件29: キャンセルウェブフックの処理
- **元ページ:** Page 19-20, 「実装における注意点 > キャンセルについて」セクション
- **抜粋:**
  > システム的なキャンセルの連携は行いません。
  > ※Xsollaからキャンセルウェブフックが通知されてもエラーで応答してください。
- **サーバー観点での補足:**
  - Xsollaからキャンセル通知が来た場合は500エラーを返す実装が必要

### 要件30: ウェブフックの死活監視
- **元ページ:** Page 20, 「実装における注意点 > ウェブフックの死活監視について」セクション
- **抜粋:**
  > アプリのメンテナンス後にWEB STOREで購入が行えないなどの問題を避けるため、正常にウェブフックが動作しているか監視および検知の仕組みをご検討ください。
- **サーバー観点での補足:**
  - ウェブフックエンドポイントの正常性を監視し、異常を検知する仕組みの構築が推奨される

### 要件31: 国コード及び通貨コードの取得と管理
- **元ページ:** Page 20-21, 「国及び通貨コードの取得」セクション
- **抜粋:**
  > ユーザ情報取得で返却する際の国及び通貨コードの取得方法
  > 国コードを優先的に送信する。
  > 起動時にアプリサーバー側で国及び通貨情報を保持していない場合はアプリサーバーに登録する。
  > 一度登録した国及び通貨情報は更新しない。
- **サーバー観点での補足:**
  - ユーザーのダウンロード国（または通貨コード）をアプリ起動時に取得し、サーバー側で永続化する必要がある（一度登録したら更新しない）

### 要件32: 国コード及び通貨コードのデバッグ対応
- **元ページ:** Page 21, 「国及び通貨コードの取得 > 国コード及び通貨コードのデバッグについて」セクション
- **抜粋:**
  > 海外版のデバッグの円滑化のため、特定の「バンダイナムコID」もしくは「アプリID」に、任意の「国コード」及び「通貨コード」を返却できるように実装する。
- **サーバー観点での補足:**
  - デバッグ目的で特定のユーザーに対して国コード・通貨コードを上書きできる機能が必要

### 要件33: ウェブフックリトライの処理
- **元ページ:** Page 5-6, シーケンス図内
- **抜粋:**
  > 500を応答（メンテナンスの場合503）
  > 支払い通知リトライ(最大12回)
  > 支払いは完了しない
- **サーバー観点での補足:**
  - ウェブフック処理でエラーが発生した場合、Xsolla側がリトライを行うため、500/503エラーを適切に返す必要がある

### 要件34: 注文支払い成功の永続エラー処理
- **元ページ:** Page 6, シーケンス図内
- **抜粋:**
  > [永続エラー]
  > 400を応答
  > 支払いは完了しているので返金が必要
  > 500を応答
  > 決済完了通知リトライ(最大19回)
  > 最後まで失敗したら返金が必要
- **サーバー観点での補足:**
  - 注文支払い成功時に永続的なエラーが発生した場合、400または500を返し、必要に応じて返金処理が必要

---

## 補足

### サーバー側実装の主要ポイント

1. **5つのウェブフックエンドポイント**
   - W1: ユーザ情報の取得
   - W2: 決済事前確認
   - W3: ユーザー検証（Xsolla）
   - W4: 支払い（Xsolla）
   - W5: 注文支払い成功（Xsolla）

2. **年齢・国による制御**
   - 日本：18歳未満は無料アイテムのみ
   - 海外：13歳以下ログイン不可、14歳以上の子供アカウントは無料アイテムのみ
   - 国コード不一致の検出とログ記録

3. **不正購入防止**
   - 署名検証
   - IP制限
   - 重複処理防止（べき等性）
   - sandboxモード判定

4. **外部連携**
   - Bank（内部システム）への購入データ送信
   - AdjustへのクライアントIP送信

5. **データ管理**
   - order.id、order.invoice_idの保存
   - 国コード・通貨コードの永続化
   - トランザクションIDの発行と管理

---

## 参照元

- ゲーム体験仕様書PDF: `docs/sdd/features/外部決済/ゲーム体験仕様書.pdf`
- WEB STORE開発ドキュメント (2025.05.01)
