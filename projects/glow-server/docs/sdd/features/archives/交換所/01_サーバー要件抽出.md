# サーバー要件抽出 - 交換所機能

**機能名**: 交換所の実装
**バージョン**: v.1.4.0
**抽出日**: 2025-11-26

---

## サーバー要件一覧

### 要件1: 交換所の基本概念とリソース管理
- **元ページ:** Page 2, 「概要」セクション
- **抜粋:**
  > ゲーム内で獲得した特定のアイテム、リソース、専用通貨（以下、「交換リソース」）を使用して、別のアイテムやキャラクター（またはそのピース）など（以下、「交換アイテム」）と交換できる機能。
- **サーバー観点での補足:**
  - プレイヤーが所持する交換リソース（アイテム、専用通貨等）の残高管理とトランザクション処理が必要

---

### 要件2: 交換ラインナップの更新サイクル管理
- **元ページ:** Page 2, 「機能目的」セクション
- **抜粋:**
  > 継続プレイの促進：交換ラインナップに期限や更新（日次、月次）を設けることで、定期的なアクセスとプレイを促す。
- **サーバー観点での補足:**
  - 交換ラインナップの期限管理（日次・月次リセット）と定期的な更新処理が必要

---

### 要件3: 交換所の種別管理
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」セクション
- **抜粋:**
  > 交換所のカテゴリーとしては、以下になります。
  > ・通常交換所
  > 恒常の交換所で開催期間は無期限になります。アイテムの交換期間は1ヶ月毎で自動リセットになります。毎月初日の04:00にリセットされます。
  > ・キャラのかけらBOX交換所
  > 現状アイテムBOX内にあるキャラのかけらをかけらBOXに交換する交換所になりますが、それをそのままここに持ってきたものになります。
  > ・イベント交換所
  > イベント（いいジャン祭）の開催期間に合わせた期間で開いている交換所になります。
- **サーバー観点での補足:**
  - 各交換所カテゴリーに応じた開催期間の管理と自動リセット処理（通常交換所は毎月初日04:00）が必要

---

### 要件4: 交換所バナー表示制御
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」セクション
- **抜粋:**
  > 交換所一覧画面に表示される交換所バナーは、交換所そのもののIDが設定されていなかったり、開催期間設定箇所が空白や不整合数値設定の場合は表示されません。
  > 開催期間はバナー上に表示をします。
  > 無期限の場合は、「🕐マーク+期限なし」
  > 期限ありの場合は、「🕐マーク+残りdd日tt時間」
  > とそれぞれ表示します。
- **サーバー観点での補足:**
  - 交換所IDと開催期間の検証、有効な交換所のフィルタリング、残り時間計算が必要

---

### 要件5: 復刻時の交換所ID管理
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」セクション
- **抜粋:**
  > ・復刻時
  > 復刻時は交換所IDを新規で切り直して、設定を行います。
- **サーバー観点での補足:**
  - 復刻イベント時に新規交換所IDを発行し、過去の交換履歴と区別して管理する必要がある

---

### 要件6: ラインナップアイテムの詳細設定管理
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」セクション
- **抜粋:**
  > それぞれ個々に設定できるものは以下になります。
  > ・交換アイテムラインナップID設定
  > ・1回の交換で獲得できるアイテムIDとアイテム数
  > ・交換期間（start_dateとend_date）
  > 交換が開始日になっていないラインナップはラインナップ画面自体に表示されません。
  > ・交換上限数
  > ・1回交換するのに必要なリソースID（アイテム、コインのいずれか）とリソース数
- **サーバー観点での補足:**
  - ラインナップごとにアイテムID、数量、期間、上限数、必要リソースの設定管理とバリデーションが必要

---

### 要件7: 交換期間の表示制御
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」セクション
- **抜粋:**
  > 交換が開始されたラインナップは「残り dd日tt時間」と表示します。
  > 交換期限は、end_dateの設定内容を表示します。
- **サーバー観点での補足:**
  - 現在時刻とend_dateを比較して残り時間を計算し、適切なフォーマットで返却する必要がある

---

### 要件8: NULL設定時の無期限・無制限制御
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」セクション
- **抜粋:**
  > 期限や上限数に整数ではなくNULLの設定をする、または設定値が存在しない場合は無期限、無制限の設定となります。
- **サーバー観点での補足:**
  - 期限・上限数がNULLまたは未設定の場合に無期限・無制限として扱うロジックが必要

---

### 要件9: まとめて交換機能
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」セクション
- **抜粋:**
  > 交換可能上限数まで交換に必要なリソースを所持している場合は、まとめて交換できるようにします。
  > 交換数は±1、±10、最大、最小で変更できます。
- **サーバー観点での補足:**
  - 複数個の一括交換処理とリソース消費の一括計算、トランザクション処理が必要

---

### 要件10: 交換リソース不足時の表示制御
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」セクション
- **抜粋:**
  > 交換に必要なリソース数が交換数に応じて足りている場合は黒数字ですが不足している場合は赤数字で表示されるようにします。
  > 例)コイン1000枚を交換するのにAアイテムが100必要だが90時箇所していない場合は、-10と赤字で表示します。
- **サーバー観点での補足:**
  - 必要リソース数とプレイヤーの所持数を比較し、不足量を計算して返却する必要がある

---

### 要件11: ユーザーごとの交換上限数管理
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」セクション
- **抜粋:**
  > 交換上限数は、ユーザーごとで可変式で交換した数が反映されるようにする。交換上限数が残っていない場合は、交換可能の吹き出しは消え、ボタンが「交換済み」という表示になりタップできなくなります。
- **サーバー観点での補足:**
  - ユーザーごとの交換履歴を管理し、残り交換可能回数を計算・提供する必要がある

---

### 要件12: 原画交換時の特別処理
- **元ページ:** Page 8, 「交換所基本仕様_原画を交換時の挙動」セクション
- **抜粋:**
  > 原画を交換所でラインナップに設定する場合は、原画のかけら単位での設定はできません。
  > 交換すると、既存の原画のかけら演出がかけら16ピース分再生されます。
- **サーバー観点での補足:**
  - 原画アイテムの交換時に16ピース分の完成状態として付与する処理が必要

---

### 要件13: アイテムBOXのタブ分類とアイテム種別管理
- **元ページ:** Page 9, 「アイテムBOXの整理（第一希望案）」セクション
- **抜粋:**
  > タブは、以下の3種とします。
  > 消費：所持しているガシャチケットのようなガシャを引けるアイテム、かけらBOXのような特定のアイテムに交換できるアイテムなど消費することで新たに報酬（リソース）が獲得できるものがここに表示されます。
  > 強化：所持している各種カラーメモリー、各種メモリーフラグメントなど強化関連のアイテムがここに表示されます。
  > かけら：所持しているキャラのかけらがここに表示されます。
- **サーバー観点での補足:**
  - アイテムをタブ種別（消費・強化・かけら）ごとに分類して返却する必要がある

---

### 要件14: キャラのかけら表示順序のカスタマイズ
- **元ページ:** Page 9, 「アイテムBOXの整理（第一希望案）」セクション
- **抜粋:**
  > また、表示順をキャラ一覧のデフォルトの表示順に合わせて表示する内容に変更します。（できたら）
- **サーバー観点での補足:**
  - キャラのかけらの表示順序をキャラ一覧のデフォルトソート順に準拠させる処理が必要

---

### 要件15: 売却機能における法務的制約
- **元ページ:** Page 14, 「アイテムBOXの整理」セクション
- **抜粋:**
  > 消費タブに売却機能がないのは、直接販売するアイテムやおまけ扱いになっているアイテムであり、また、消費することで別のリソース（主にキャラやキャラのかけらなど）を獲得できてしまい、複数役務を持った二次通貨扱いとなり、法務NGとなってしまう懸念が理由です。
- **サーバー観点での補足:**
  - 消費タブのアイテムに対しては売却機能を提供せず、強化・かけらタブのみ売却可能とする制御が必要

---

### 要件16: リソース不足時の表示統一化
- **元ページ:** Page 13, 「これ別件で実機見てたら直したいのあったので相談」セクション
- **抜粋:**
  > ±ボタンで交換個数などを選択した時に、交換元のリソースが不足していたら赤字の-nnnみたいな表記になったり、足りていてもnnnになったり画面毎で違うので、統一したいです。
- **サーバー観点での補足:**
  - リソース不足時の表示形式を全画面で統一するための一貫した計算ロジックとレスポンスフォーマットが必要

---

## サーバー要件の観点別整理

### API一覧とその責務
- 交換所一覧取得API: 開催中の交換所リストと残り時間を返却
- 交換所ラインナップ取得API: 特定交換所の交換可能アイテム一覧と残り交換回数を返却
- 交換実行API: リソース消費と報酬付与をトランザクション処理
- アイテムBOX取得API: タブ種別ごとに分類されたアイテム一覧を返却
- 売却/変換実行API: アイテム売却・かけら変換処理

### データベース要件
- 交換所マスタ: 交換所ID、カテゴリ、開催期間（start_date, end_date）
- 交換ラインナップマスタ: ラインナップID、交換所ID、報酬アイテムID/数量、必要リソースID/数量、交換期間、交換上限数
- ユーザー交換履歴: ユーザーID、ラインナップID、交換回数、最終交換日時
- ユーザー所持アイテム: ユーザーID、アイテムID、所持数

### マスターデータ要件
- 交換所の種別（通常、イベント、キャラのかけらBOX）
- アイテムのタブ分類（消費、強化、かけら）
- 原画アイテムの特別フラグ
- 売却可否フラグ

### バリデーション要件
- 交換所IDの存在チェックと開催期間の有効性検証
- ラインナップの交換期間内チェック
- プレイヤーの所持リソース数の検証
- 交換上限回数の残数チェック
- 交換数の最小値・最大値チェック

### エラーハンドリング要件
- 交換所が存在しない、または開催期間外の場合のエラー
- リソース不足時のエラー
- 交換上限到達時のエラー
- 不正な交換数指定時のエラー

### 非機能要件
- **定期処理**: 毎月初日04:00の通常交換所リセット処理
- **トランザクション整合性**: 交換時のリソース消費と報酬付与の原子性保証
- **同時実行制御**: 同一ユーザーの重複交換リクエスト制御
- **パフォーマンス**: ラインナップ一覧取得時の残り時間計算の効率化

---

## 備考
- 本ドキュメントはゲーム体験仕様書v.1.4.0から抽出したサーバー要件のみを記載しています
- 実装方針（API設計、テーブル設計等）の詳細は別途検討が必要です
- UI仕様、アニメーション、演出等のクライアント専用要件は除外しています
