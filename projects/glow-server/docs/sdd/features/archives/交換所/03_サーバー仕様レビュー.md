# サーバー実装観点の仕様レビュー（自動分析レポート） - 交換所機能

**機能名**: 交換所の実装
**バージョン**: v.1.4.0
**レビュー日**: 2025-11-26

---

## 1. 要約

### 現時点での仕様の明瞭さ/不明瞭さの総評

**明瞭な点:**
- 交換所の基本コンセプト（3種類の交換所カテゴリー、開催期間、リセット方式）は明確
- 既存のShop機能との実装パターンが類似しており、コード調査により技術的実現方法が明らか
- 既存基盤（RewardDelegator、UsrItemService、Clock等）を活用できる設計

**不明瞭な点:**
- **交換コストの種別**: 仕様書では「アイテム、リソース、専用通貨」とあるが、既存のShopItemCostTypeにItem消費の直接サポートがなく、実装方法が不明
- **原画アイテムの実装**: 16ピース完成状態の付与方法が既存コードに実装例がなく、具体的な処理方法が未定義
- **アイテムBOXのタブ分類**: 仕様書の3タブ（消費・強化・かけら）と既存のItemGroupType（2種類）の整合性が不明
- **複数リソース消費**: 「複数リソース消費が必要なら+3人日」と記載があるが、仕様書には複数リソースの明示的な記載がない
- **通算交換回数の管理**: trade_total_countの用途（ログ分析のみか、ゲーム仕様として使用するか）が不明

### 大きなリスク・不確定要素の概要

1. **アイテムをコストとする交換の実装方式**: 既存ShopItemCostTypeとの統合方法、またはItemService経由での別実装が必要
2. **原画の特別処理**: 16ピース分の演出と付与ロジックの実装方法が未確定
3. **法務的制約の遵守**: 消費タブのアイテム売却禁止の徹底
4. **複数リソース消費の対応**: 仕様として必要かどうかの確認が必要
5. **リセット処理の詳細**: 毎月初日04:00リセットの実行方式（バッチ処理 or アクセス時判定）が未定義

---

## 2. 仕様の詳細化（サーバー観点）

### 2.1 交換所の種別と開催期間管理

#### 2.1.1 交換所の種別
サーバーは以下の3種類の交換所カテゴリーを管理する:

| 交換所種別 | 開催期間 | リセット方式 | 備考 |
|----------|---------|------------|------|
| 通常交換所 | 無期限 | 毎月初日04:00に交換回数リセット | 恒常的に開催 |
| イベント交換所 | イベント開催期間に準拠 | イベント終了後は非表示 | 復刻時は新規交換所IDを発行 |
| キャラのかけらBOX交換所 | 無期限 | リセットなし | 既存のアイテムBOX内機能を移設 |

#### 2.1.2 開催期間のバリデーション
- 交換所マスタには`start_date`と`end_date`が設定される
- NULL設定時は無期限として扱う
- 現在時刻が範囲外の場合、交換所一覧に表示しない（サーバー側でフィルタリング）
- 残り時間の計算: `end_date - 現在時刻` を「dd日tt時間」形式で返却

### 2.2 交換ラインナップの詳細設定

#### 2.2.1 ラインナップごとの設定項目
各ラインナップには以下の設定が必要:

| 設定項目 | データ型 | NULL許容 | 備考 |
|---------|---------|---------|------|
| ラインナップID | INT | NOT NULL | 主キー |
| 交換所ID | INT | NOT NULL | 外部キー |
| 報酬リソースタイプ | ENUM | NOT NULL | Item, Unit, Coin, Emblem, Prism等 |
| 報酬リソースID | INT | NOT NULL | アイテムID、キャラID等 |
| 報酬数量 | INT | NOT NULL | 1回の交換で付与される数 |
| 必要リソースタイプ | ENUM | NOT NULL | Item, Coin, Diamond等 |
| 必要リソースID | INT | NULL | アイテムIDなど（Coinの場合はNULL） |
| 必要リソース数 | INT | NOT NULL | 1回の交換に必要な数 |
| 交換上限数 | INT | NULL | NULL時は無制限 |
| 交換期間開始日時 | DATETIME | NULL | NULL時は無期限 |
| 交換期間終了日時 | DATETIME | NULL | NULL時は無期限 |

#### 2.2.2 開始日前のラインナップの扱い
- `start_date`が未到来のラインナップは、サーバー側で除外してクライアントに返却しない
- `end_date`が過去のラインナップも同様に除外

### 2.3 ユーザー交換履歴管理

#### 2.3.1 交換回数の二重管理
既存のShop機能と同様に、以下の2つのカウンタを管理:

| カラム名 | 用途 | リセット対象 |
|---------|------|------------|
| trade_count | 現在の交換期間内の交換回数 | リセット対象（月次等） |
| trade_total_count | 通算交換回数 | リセット対象外（永続） |

- 交換実行時、両カウンタを同時にインクリメント
- リセット時、`trade_count`のみを0にリセット
- 交換上限チェックは`trade_count`を使用

#### 2.3.2 リセットタイミングの判定
- Clock機能の`isFirstMonth(last_reset_at)`メソッドを使用
- 通常交換所: Monthlyリセット（毎月初日04:00基準）
- イベント交換所: リセットなし（イベント終了後は新規交換所として再作成）
- キャラのかけらBOX交換所: リセットなし

### 2.4 交換処理の詳細フロー

#### 2.4.1 事前チェック（バリデーション）
以下の順序でバリデーションを実施:

1. **交換所の存在チェック**: 交換所IDが存在し、開催期間内か
2. **ラインナップの存在チェック**: ラインナップIDが存在し、交換期間内か
3. **交換回数のリセット判定**: リセットが必要な場合、`trade_count`を0にリセット
4. **交換上限チェック**: `trade_count < tradable_count` または `tradable_count IS NULL`
5. **リソース所持数チェック**: 必要リソースを十分に所持しているか
6. **交換個数の妥当性チェック**: `交換個数 >= 1` かつ `交換個数 <= 残り交換可能回数` かつ `所持リソース / 必要リソース >= 交換個数`

#### 2.4.2 トランザクション処理
`UseCaseTrait::applyUserTransactionChanges()`内で以下を実行:

1. **リソース消費**:
   - コストタイプがCoinの場合: `UserDelegator::consumeCoin()`
   - コストタイプがItemの場合: `UsrItemService::consumeItem()`
   - コストタイプがDiamondの場合: `AppCurrencyDelegator::consumeDiamond()`
2. **報酬付与**:
   - `RewardDelegator::addReward()`で報酬を登録
   - `RewardDelegator::sendRewards()`で一括配布
   - 報酬タイプに応じた各SendService（ItemSendService, UnitSendService等）が自動的に呼び出される
3. **交換回数のインクリメント**:
   - `UsrShopItem::incrementTradeCount()`（trade_countとtrade_total_countを両方+1）
4. **交換ログの保存**:
   - `LogTradeShopItemRepository::create()`で交換履歴を記録
   - 記録内容: ユーザーID、ラインナップID、交換回数、コストタイプ、コスト数、実際に受け取った報酬（JSON）

#### 2.4.3 エラーハンドリング
以下のエラーコードをスロー:

| エラーコード | タイミング | メッセージ |
|-----------|----------|----------|
| MST_NOT_FOUND | 交換所・ラインナップが見つからない | マスタが存在しないか期間外 |
| SHOP_TRADE_COUNT_LIMIT | 交換上限到達 | 交換上限に達している |
| LACK_OF_RESOURCES | リソース不足 | 必要リソースが不足している |
| INVALID_PARAMETER | 交換個数が不正 | 交換個数が1未満または上限超過 |

### 2.5 原画アイテムの特別処理

#### 2.5.1 原画交換時の要件
仕様書の記載:
- 原画は「かけら単位での設定はできない」
- 交換すると「16ピース分の演出が再生される」
- 「16ピース分の完成状態」として付与される

#### 2.5.2 サーバー側の処理（推測）
以下のいずれかの実装方式が考えられる:

**方式A: resource_amountで16個として設定**
- ラインナップのresource_amountを16に設定
- RewardDelegatorで16個のアイテムとして付与
- クライアント側で16ピース演出を実行

**方式B: 原画専用フラグを設定**
- マスタに`is_original_art`フラグを追加
- 交換時にフラグをチェックし、16個として扱うロジックを実装
- RewardSendServiceで特別処理

**不明点**: 既存コードに原画の実装例がないため、どちらの方式を採用するか不明

### 2.6 アイテムBOXのタブ分類

#### 2.6.1 タブ分類の定義
仕様書では以下の3タブが定義されている:

| タブ種別 | 対象アイテム | 売却可否 |
|---------|------------|---------|
| 消費 | ガシャチケット、かけらBOX等の消費アイテム | 不可（法務的制約） |
| 強化 | カラーメモリー、メモリーフラグメント等 | 可 |
| かけら | キャラのかけら | 可（変換機能） |

#### 2.6.2 既存ItemGroupTypeとの整合性
既存のglow-schema/Item.ymlでは、ItemGroupTypeに以下の2種類のみが定義されている:
- `Consumable`: 消費アイテム
- `Etc`: その他

**不明点**: 仕様書の3タブ分類を実現するため、以下のいずれかの対応が必要:
1. ItemGroupTypeに`Enhancement`を追加し、3種類に拡張
2. ItemTypeとItemGroupTypeの組み合わせで判定
3. 新たなenum（ItemTabType）を定義

### 2.7 まとめて交換機能

#### 2.7.1 交換可能個数の計算
まとめて交換時の最大交換個数は、以下の3つの条件のうち最小値:

1. **交換上限の残数**: `tradable_count - trade_count` （tradable_countがNULLの場合は無制限）
2. **所持リソースから計算可能な交換回数**: `所持リソース数 / 必要リソース数`（小数点以下切り捨て）
3. **最小値**: 1個

#### 2.7.2 ±ボタンでの個数変更
クライアントは±1、±10、最大、最小ボタンで交換個数を変更可能。
サーバーは以下を返却:
- 現在の交換個数に対する必要リソース数
- 所持リソース数
- 不足量（所持数 - 必要数が負の場合）

**不明点**: リソース不足時の表示形式が画面ごとに異なる問題があり、統一が必要（Page 13の記載）

### 2.8 売却機能の法務的制約

#### 2.8.1 売却可能なタブ
- **強化タブ**: 売却可能
- **かけらタブ**: 売却可能（かけら変換機能も提供）
- **消費タブ**: 売却不可（法務的制約）

#### 2.8.2 法務的制約の理由
仕様書の記載:
> 消費タブに売却機能がないのは、直接販売するアイテムやおまけ扱いになっているアイテムであり、また、消費することで別のリソース（主にキャラやキャラのかけらなど）を獲得できてしまい、複数役務を持った二次通貨扱いとなり、法務NGとなってしまう懸念が理由です。

**サーバー側の対応**:
- アイテムのタブ種別を判定し、消費タブのアイテムに対する売却APIリクエストを拒否
- エラーコード: `ITEM_CANNOT_BE_SOLD`（新規定義が必要）

---

## 3. 不明点・曖昧点・判断が必要な項目

### A. 仕様書に記載がなく判断不能な項目

#### A-1: 複数リソース消費の対応
- **該当箇所**: Page 11 工数見積もり「交換所基本実装 サーバー5人日 ※複数リソース消費が必要なら+3」
- **何が曖昧なのか**:
  - 仕様書には「1回交換するのに必要なリソースID（アイテム、コインのいずれか）」と記載されており、単一リソースのみの記載
  - 工数見積もりには「複数リソース消費」の追加工数があるが、ゲーム体験仕様書には複数リソース消費の明示的な記載がない
- **サーバーとして明確化が必要な理由**:
  - 複数リソース消費が必要な場合、テーブル設計（交換コストテーブルの正規化）、バリデーションロジック、UIレスポンスフォーマットが大きく変わる
  - 後から追加すると大幅な設計変更が必要になる

#### A-2: 通算交換回数（trade_total_count）の用途
- **該当箇所**: コード調査追記.md 要件C-1「trade_total_countは通算交換回数でリセット対象外」
- **何が曖昧なのか**:
  - trade_total_countがログ分析専用なのか、ゲーム仕様（例: 通算100回交換でバッジ獲得等）として使用するのかが不明
  - ミッション連携の有無が不明
- **サーバーとして明確化が必要な理由**:
  - ゲーム仕様として使用する場合、クライアントへの返却項目に含める必要がある
  - ミッション連携が必要な場合、トリガー送信処理を実装する必要がある

#### A-3: リセット処理の実行方式
- **該当箇所**: Page 6「毎月初日の04:00にリセットされます」
- **何が曖昧なのか**:
  - バッチ処理で一括リセットするのか、ユーザーのアクセス時に判定してリセットするのかが不明
  - 既存のShop機能はアクセス時判定だが、交換所でも同様の方式で良いのかが不明
- **サーバーとして明確化が必要な理由**:
  - バッチ処理の場合、定期実行基盤（cron、AWS EventBridge等）の整備が必要
  - アクセス時判定の場合、初回アクセス時のレスポンスタイムが増加する可能性がある

#### A-4: 原画アイテムの16ピース処理の詳細
- **該当箇所**: Page 8「交換すると、既存の原画のかけら演出がかけら16ピース分再生されます」
- **何が曖昧なのか**:
  - サーバー側で16個のアイテムとして付与するのか、1個のアイテムを付与してクライアント側で16ピース演出するのかが不明
  - 原画アイテムの識別方法（専用フラグ、アイテムタイプ等）が不明
- **サーバーとして明確化が必要な理由**:
  - 付与方式によってRewardDelegatorの実装方法が変わる
  - 既存コードに実装例がないため、新規実装が必要

#### A-5: アイテムBOXのタブ分類実装方法
- **該当箇所**: Page 9, 10, 14「消費・強化・かけらの3タブ」
- **何が曖昧なのか**:
  - 仕様書では3タブだが、既存のItemGroupTypeは2種類（Consumable, Etc）のみ
  - どの項目（ItemType, ItemGroupType, 新enum）でタブ分類を判定するのかが不明
- **サーバーとして明確化が必要な理由**:
  - タブ分類の判定ロジックがないと、クライアントへの返却時にタブ種別を付与できない
  - 売却可否の判定にも影響する

### B. 仕様書とコードの不一致

#### B-1: 交換コストのタイプ定義
- **該当ファイル**:
  - 仕様書: Page 7「1回交換するのに必要なリソースID（アイテム、コインのいずれか）」
  - コード: `api/app/Domain/Shop/Enums/ShopItemCostType.php`
- **どのように矛盾しているか**:
  - 仕様書では「アイテム、リソース、専用通貨」が交換コストと記載されている
  - 既存のShopItemCostTypeには`COIN`, `DIAMOND`, `PAID_DIAMOND`, `AD`, `FREE`はあるが、`ITEM`タイプの実装例がない
  - glow-schemaのShop.ymlには`Item`タイプの定義はあるが、実際の消費処理が未実装
- **影響**:
  - アイテムをコストとする交換を実装する場合、以下のいずれかの対応が必要:
    1. ShopItemCostTypeに`ITEM`を追加し、ShopService::consumeCostでItemタイプの分岐を実装
    2. UsrItemService::consumeItem()を直接呼び出す別実装を採用
  - 実装方式の選択により、コードの一貫性やメンテナンス性が変わる

#### B-2: 初回無料フラグの有無
- **該当ファイル**:
  - 仕様書: 初回無料に関する記載なし
  - コード: `api/app/Domain/Shop/Services/ShopService.php` の`is_first_time_free`フラグ
- **どのように矛盾しているか**:
  - 既存のShop機能には初回無料フラグ（`is_first_time_free`）があり、trade_count=1の場合にコスト消費をスキップする
  - 交換所機能でも同様のフラグを実装するかが不明
- **影響**:
  - 初回無料フラグを実装しない場合、マスタテーブルから該当カラムを除外可能
  - 後から追加する場合、マイグレーションとロジック追加が必要

### C. サーバー側で仕様確定が必要な項目

#### C-1: まとめて交換時の交換個数のデフォルト値
- **決める必要がある点**:
  - 交換確認ダイアログを開いた際の初期交換個数（1個 or 最大個数 or 前回値）
  - ±10ボタンで個数を減らした際の最小値（0個 or 1個）
- **プランナーへの確認ポイント**:
  - 初期交換個数は1個で良いか？
  - 交換個数の最小値は1個（0個にはならない）で良いか？

#### C-2: リソース不足時の表示形式の統一
- **決める必要がある点**:
  - リソース不足時の表示: 「-10」（不足量を赤字） or 「90/100」（所持数/必要数を赤字） or その他
  - 複数画面で表示形式が異なる問題（Page 13記載）の統一方針
- **プランナーへの確認ポイント**:
  - 全画面で統一する表示形式はどれか？
  - サーバーが返却するデータ形式（不足量、所持数、必要数、全て）

#### C-3: キャラのかけらの表示順序
- **決める必要がある点**:
  - 「キャラ一覧のデフォルトの表示順に合わせる（できたら）」（Page 9記載）の優先度
  - ソート順の基準（レアリティ順、キャラID順、所持数順等）
- **プランナーへの確認ポイント**:
  - この要件は必須か、Nice to Haveか？
  - ソート順の具体的な基準は何か？

#### C-4: 復刻時の交換履歴の扱い
- **決める必要がある点**:
  - 復刻イベントの交換所IDは新規発行（Page 6記載）だが、ユーザーの過去の交換履歴を引き継ぐか？
  - 例: 初回開催時に交換上限10回のうち5回交換済みの場合、復刻時も残り5回か、リセットして10回か
- **プランナーへの確認ポイント**:
  - 復刻時の交換履歴は新規（リセット）で良いか？
  - 過去の交換履歴を参照する必要はあるか？

#### C-5: 売却機能の実装範囲
- **決める必要がある点**:
  - 売却機能は交換所機能と同時に実装するのか、別タイミングか
  - 売却時のコイン換算レートの定義方法（マスタに売却価格カラムを追加？）
- **プランナーへの確認ポイント**:
  - 売却機能の実装優先度は？（交換所と同時リリース必須か）
  - 売却価格の設定方法は？（アイテムごとに個別設定 or レアリティごとの一律価格）

### D. ゲーム体験的に不自然な可能性がある項目

#### D-1: 原画の交換コストが不明
- **問題点**:
  - 仕様書では原画の交換演出（16ピース分）は詳細に記載されているが、原画を交換するために必要なコスト（リソース）の記載がない
  - 原画は高価値アイテムと推測されるが、交換に必要なリソース量の設定が不明
- **想定される影響**:
  - ゲームバランスへの影響が大きい
  - プランナーが原画のコスト設定を忘れている可能性

#### D-2: イベント交換所の期限切れ後の扱い
- **問題点**:
  - イベント交換所は「イベント開催期間に合わせた期間」（Page 6記載）だが、イベント終了後に交換所が即座に消えるのか、猶予期間があるのかが不明
  - イベント報酬を受け取り損ねたユーザーへの配慮が不明
- **想定される影響**:
  - イベント終了直後にサーバーメンテナンスがあった場合、交換所にアクセスできずにユーザーが損をする可能性
  - カスタマーサポート問い合わせの増加

#### D-3: 交換上限到達後のUI挙動
- **問題点**:
  - 仕様書では「交換上限数が残っていない場合は、ボタンが『交換済み』という表示になりタップできなくなります」（Page 7記載）
  - しかし、リセット後に再び交換可能になる場合、ユーザーが「交換済み」表示を見て「もう二度と交換できない」と誤解する可能性
- **想定される影響**:
  - ユーザー体験の低下
  - 「あとNN回交換可能」の表示と「交換済み」表示の統一感が不明

---

## 4. プランナーへ確認が必要な項目まとめ（最重要）

### 4.1 仕様の明確化

#### Q1: 複数リソース消費の対応
**質問**: 1つのラインナップで複数種類のリソース（例: コイン1000 + アイテムA×10）を同時に消費する仕様は必要ですか？
- 必要な場合、どのようなケースを想定していますか？
- 工数見積もりに「複数リソース消費が必要なら+3人日」とありますが、これは実装対象ですか？

#### Q2: 通算交換回数の用途
**質問**: `trade_total_count`（通算交換回数）は、ログ分析専用ですか？それともゲーム仕様として使用しますか？
- ゲーム仕様として使用する場合、どのような場面で使用しますか？（例: 「通算100回交換でバッジ獲得」等）
- ミッションシステムと連携する必要はありますか？

#### Q3: リセット処理の実行方式
**質問**: 通常交換所の「毎月初日04:00リセット」は、バッチ処理で一括リセットしますか？それともユーザーのアクセス時に判定してリセットしますか？
- 既存のShop機能はアクセス時判定ですが、交換所も同様で良いですか？
- 大量のユーザーが同時にアクセスした際のパフォーマンスは考慮する必要がありますか？

#### Q4: 原画アイテムの実装方法
**質問**: 原画を交換した際の「16ピース分の演出」は、サーバー側で16個のアイテムとして付与しますか？それとも1個のアイテムを付与してクライアント側で16ピース演出しますか？
- 原画アイテムを識別するための専用フラグやタイプは定義されていますか？
- 原画の交換に必要なコスト（リソース）の設定はどのようにしますか？

#### Q5: アイテムBOXのタブ分類方法
**質問**: アイテムBOXの3タブ（消費・強化・かけら）の分類は、既存のItemGroupTypeを拡張しますか？それとも新しいenum（ItemTabType等）を定義しますか？
- 既存のItemGroupTypeは2種類（Consumable, Etc）のみですが、3タブ分類とどのように対応させますか？
- 各アイテムのタブ分類は、マスタデータでどのように管理しますか？

### 4.2 境界条件の明確化

#### Q6: まとめて交換時の初期個数とデフォルト値
**質問**: 交換確認ダイアログを開いた際の初期交換個数は何個ですか？
- 1個固定、最大個数、前回値のいずれですか？
- ±ボタンで個数を減らした際の最小値は1個（0個にはならない）で良いですか？

#### Q7: リソース不足時の表示形式
**質問**: リソース不足時の表示形式を全画面で統一したい（Page 13記載）ですが、どの形式に統一しますか？
- 「-10」（不足量を赤字で表示）
- 「90/100」（所持数/必要数を赤字で表示）
- その他の形式
- サーバーが返却するデータ形式は？（不足量、所持数、必要数、全て）

#### Q8: 復刻イベント時の交換履歴の扱い
**質問**: イベント交換所を復刻する際、ユーザーの過去の交換履歴は引き継ぎますか？それともリセット（新規）しますか？
- 例: 初回開催時に交換上限10回のうち5回交換済みの場合、復刻時は残り5回か、リセットして10回か？
- 復刻時は「交換所IDを新規で切り直す」（Page 6記載）とありますが、交換履歴は完全に別管理で良いですか?

### 4.3 UI/UX関連の確認

#### Q9: 交換上限到達後の表示
**質問**: 交換上限到達後のボタン表示は「交換済み」（Page 7記載）ですが、リセット後に再び交換可能になる場合、ユーザーが誤解しませんか？
- 「今月は交換済み」「残り0回」等の表示の方が分かりやすいのでは？
- リセット日時の表示は必要ですか？（例: 「次回リセット: 12/1 04:00」）

#### Q10: イベント交換所の期限切れ後の猶予期間
**質問**: イベント交換所は、イベント終了後すぐに非表示になりますか？それとも猶予期間（例: 1日）がありますか？
- イベント報酬を交換し損ねたユーザーへの配慮として、猶予期間を設ける必要はありますか？
- イベント終了とメンテナンス開始が重なった場合の対応は？

### 4.4 実装優先度の確認

#### Q11: 売却機能の実装タイミング
**質問**: アイテムBOXの売却機能は、交換所機能と同時に実装しますか？それとも別タイミングですか？
- 同時実装の場合、売却価格の設定方法は？（アイテムごとに個別設定 or レアリティごとの一律価格）
- 売却時のコイン換算レートはどのように管理しますか？

#### Q12: キャラのかけら表示順序のカスタマイズ
**質問**: 「表示順をキャラ一覧のデフォルトの表示順に合わせて表示する（できたら）」（Page 9記載）の優先度はどのくらいですか？
- 必須要件か、Nice to Haveか？
- 実装しない場合のデフォルト表示順（キャラID順、レアリティ順等）はどうしますか？

#### Q13: 初回無料フラグの実装有無
**質問**: 交換所機能で「初回無料」の仕組みを実装する予定はありますか？
- 既存のShop機能には`is_first_time_free`フラグがありますが、交換所でも同様のフラグを実装しますか？
- 実装する場合、どのようなラインナップで使用する想定ですか？

---

## 5. サーバー開発への影響まとめ

### 5.1 実装前に必ず詰めるべき論点

#### 優先度: 高（実装方針に直接影響）
1. **アイテムをコストとする交換の実装方式** (Q1関連)
   - ShopItemCostTypeの拡張 or ItemService経由の別実装
   - テーブル設計、バリデーションロジック、APIレスポンス形式に影響
2. **原画アイテムの実装方法** (Q4関連)
   - 付与方式（16個 or 1個）、識別フラグの有無
   - RewardDelegator、SendServiceの実装に影響
3. **アイテムBOXのタブ分類方法** (Q5関連)
   - ItemGroupTypeの拡張 or 新enum定義
   - マスタデータ設計、タブ分類ロジックに影響

#### 優先度: 中（仕様の明確化が必要）
4. **複数リソース消費の対応** (Q1関連)
   - 必要な場合、テーブル正規化が必要（交換コストテーブルの1:N化）
5. **リセット処理の実行方式** (Q3関連)
   - バッチ処理の場合、定期実行基盤の整備が必要
6. **復刻時の交換履歴の扱い** (Q8関連)
   - 引き継ぐ場合、交換所IDと交換履歴の紐付け方式を再検討

#### 優先度: 低（UI/UX改善、後から対応可能）
7. **リソース不足時の表示形式統一** (Q7関連)
   - レスポンスデータ形式の統一
8. **キャラのかけら表示順序** (Q12関連)
   - ソート処理の実装

### 5.2 不明点が残る場合のリスク

#### 技術的リスク
- **アイテムコスト消費の実装方式が未定**:
  - コード設計の一貫性が失われる
  - 後から変更すると既存機能（Shop）への影響が大きい
- **原画の16ピース処理が未定**:
  - RewardSendServiceの実装が進められない
  - クライアント側との連携仕様が確定しない
- **アイテムタブ分類が未定**:
  - マスタデータの登録ができない
  - 売却可否の判定ロジックが実装できない

#### スケジュールリスク
- **仕様確定待ちによる実装開始の遅延**:
  - 不明点の解消に時間がかかると、実装開始が遅れる
  - 特に「複数リソース消費」の対応有無は、テーブル設計に直接影響するため早期確定が必要
- **後からの仕様変更による手戻り**:
  - 仮実装で進めた場合、後から仕様が確定した際に大幅な修正が必要になる可能性
  - 特にテーブル設計、API仕様の変更は影響範囲が大きい

#### 品質リスク
- **ゲーム体験の不整合**:
  - 原画の交換コストが未定義の場合、ゲームバランスが崩れる可能性
  - イベント交換所の期限切れ後の扱いが不明確な場合、ユーザー体験が低下する
- **法務的リスクの顕在化**:
  - 消費タブのアイテム売却を誤って実装してしまうと、法務NGとなる
  - 売却可否の判定ロジックが不明確な場合、実装ミスが発生しやすい

### 5.3 スケジュール・品質への影響

#### 影響度: 大
- **仕様確定の遅延**: 実装開始時期が2週間以上遅れる可能性
- **手戻りによる工数増**: 仮実装後の仕様変更で、見積もり工数の+30%〜50%の追加工数が発生する可能性

#### 影響度: 中
- **テスト期間の延長**: 仕様が不明確なまま実装した場合、テスト時の仕様確認・修正で追加の1〜2週間が必要
- **クライアント側との連携遅延**: API仕様が確定しないと、クライアント側の実装も遅延する

#### 推奨対応
1. **優先度: 高の論点を最優先で確定**（Q1, Q4, Q5）: 実装開始前（1週間以内）に確定
2. **優先度: 中の論点を早期確定**（Q1複数リソース, Q3, Q8）: 実装開始後2週間以内に確定
3. **優先度: 低の論点は仮決めで進行**（Q7, Q12）: 後からの変更が容易なため、仮決めで実装開始し、後で調整可能

---

## 付録: 既存実装との対応表

以下は、交換所機能を既存のShop機能・Item機能の実装パターンにマッピングした表です。

| 交換所の概念 | 既存機能での対応 | 実装ファイル | 備考 |
|------------|----------------|------------|------|
| 交換所 | Shop | ShopService, MstShopItem | ShopTypeで種別管理（Daily, Weekly, Coin） |
| 交換所ラインナップ | MstShopItem | MstShopItem | 1つのShopItemが1つのラインナップに相当 |
| ユーザー交換履歴 | UsrShopItem | UsrShopItem, UsrShopItemRepository | trade_count, trade_total_count, last_reset_at |
| 交換ログ | LogTradeShopItem | LogTradeShopItem, LogTradeShopItemRepository | 交換実行時の詳細ログ |
| 交換コスト消費 | ShopService::consumeCost() | ShopService | CostTypeに応じてUserDelegator等を呼び出し |
| 交換報酬付与 | RewardDelegator | RewardDelegator, RewardSendService | 報酬タイプごとに各SendServiceが呼び出される |
| 交換上限チェック | ShopService::validateTradeCount() | ShopService | tradable_countとtrade_countを比較 |
| リセット判定 | ShopService::resetUsrShopItem() | ShopService | Clock::isFirstMonth()等を使用 |
| アイテム交換 | ItemService::apply() | ItemService, UsrItemService | キャラのかけら→かけらBOXの交換 |
| アイテム消費 | UsrItemService::consumeItem() | UsrItemService | 所持数チェック、ログ出力を自動実行 |

**適用可能な既存パターン**:
- トランザクション処理: `UseCaseTrait::applyUserTransactionChanges()`
- リセット判定: `Clock::isFirstToday()`, `isFirstWeek()`, `isFirstMonth()`
- 報酬付与: `RewardDelegator::addReward()`, `sendRewards()`
- エラーハンドリング: `ErrorCode::LACK_OF_RESOURCES`, `SHOP_TRADE_COUNT_LIMIT`

**新規実装が必要なパターン**:
- 原画アイテムの16ピース処理（既存に実装例なし）
- アイテムをコストとする交換（ShopItemCostTypeのItem分岐が未実装）
- アイテムBOXの3タブ分類（ItemGroupTypeは2種類のみ）

---

**レビュー完了日**: 2025-11-26
**次のステップ**: プランナーへの確認事項（Q1〜Q13）を整理し、仕様確定後にAPI設計・テーブル設計に進む
