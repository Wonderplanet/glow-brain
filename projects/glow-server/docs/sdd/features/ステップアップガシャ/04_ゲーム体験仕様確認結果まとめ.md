# ゲーム体験仕様確認結果まとめ

## 1. 確認実施概要
- 確認日時: 2025年12月4日
- 確認方法: ドキュメント（プランナー確認結果）
- 確認者: ゲーム企画担当者

## 2. 確認結果サマリー
- 確認項目総数: 20 項目
- 完全に解決: 20 項目
- 部分的に解決: 0 項目
- 未解決: 0 項目

## 3. 各不明点の確認結果

### 3.1 仕様書に記載がなく判断不能だった項目

#### 項目 A-1: ステップ実行の基本単位
- **元の不明点:**
  - 1ステップの実行＝何連のガシャなのかが不明
  - 仕様書には「通常より少ない回数」と記載があるが、具体的な回数が不明
  - 各ステップで排出回数が異なるのか、固定なのか
- **ゲーム体験仕様確認結果:**
  - Q1: ステップ毎にDBで設定する
  - Q2: ステップ毎にDBで設定する（各ステップで排出されるアイテム数は異なる可能性がある）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 1ステップの実行回数（何連ガシャか）はステップごとにマスタデータで設定可能
  - 各ステップで排出されるアイテム数もステップごとに設定可能
  - 企画側が自由に設定できる柔軟な仕様
- **備考:**
  - マスタテーブルには各ステップの排出回数を保持するカラムが必要
  - 1連、10連など任意の回数を設定できる設計が必要

#### 項目 A-2: 周回時のステップリセット挙動
- **元の不明点:**
  - 最大10ステップを完了した後の挙動が不明
  - ステップ1に戻るのか、ステップ10を繰り返すのか、実行不可になるのか
  - 周回回数のカウント方法（ステップ10完了で1周？全ステップ実行で1周？）
- **ゲーム体験仕様確認結果:**
  - Q4: A. 自動的にステップ1に戻り、再度実行可能
  - Q5: 上限はDBで設定する
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 最大ステップ（10ステップ）完了後は自動的にステップ1に戻る
  - 周回回数の上限はマスタデータで設定可能（NULL可能：無限周回も可）
  - 周回回数上限に達した場合のみ実行不可となる
- **備考:**
  - ユーザーデータには現在の周回数を保持するカラムが必要
  - 最大周回数に達した場合の挙動（エラーメッセージ等）の検討が必要

#### 項目 A-3: ステップのリセット条件
- **元の不明点:**
  - 日次リセットの有無（毎日04:00にステップ1に戻るのか）
  - ガシャ期間終了時、次回開催時のステップ状態
  - ステップ途中でガシャ期間が終了した場合の扱い
- **ゲーム体験仕様確認結果:**
  - Q7: リセットされない（日次リセットなし）
  - Q8: B. 次回開催時はステップ1から再開
  - Q9: 返却されない（消費したプリズムは戻らない）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 日次リセット機能は不要（ステップ進行状況は日を跨いでも保持される）
  - ガシャ期間が終了した場合、次回開催時はステップ1から再開（進行状況は引き継がれない）
  - ステップ途中で期間終了した場合、消費したプリズムは返却されない（通常のガシャと同じ扱い）
- **備考:**
  - 日次リセット処理の実装は不要
  - ガシャ期間終了時、該当ガシャのユーザーデータをクリーンアップする処理が必要
  - 次回開催時は新しいガシャIDとして扱われる想定

#### 項目 A-4: 「アイテムも設定可能」の意味
- **元の不明点:**
  - アイテムがコストとして消費されるのか（既存のCostType::ITEMと同じ）
  - アイテムがボーナス報酬として付与されるのか
  - アイテムがガシャラインナップに追加されるのか
- **ゲーム体験仕様確認結果:**
  - Q14: C. ガシャのラインナップにアイテムを追加できる
- **解決状況:** 完全に解決
- **確定した仕様:**
  - アイテムはガシャの排出物（ラインナップ）として追加可能
  - キャラクターと同様に、アイテムも抽選対象として設定できる
  - コストとしての消費ではなく、報酬としての排出
- **備考:**
  - 既存のガシャラインナップテーブルで、アイテムIDも格納できる設計が必要
  - アイテム排出時の報酬配布処理は既存のItemRewardと同じロジックを使用可能

#### 項目 A-5: 確定枠「〇〇以上からN体」の抽選仕様
- **元の不明点:**
  - 「〇〇以上」のレアリティ条件の指定方法
  - N体の確定枠と残りの通常枠の排出順序
  - N体が同時に排出されるのか、N回の抽選で順次排出されるのか
  - 確定枠の重複排出（同じアイテムがN体全て同じになる可能性）
- **ゲーム体験仕様確認結果:**
  - Q10: DBで設定する（レアリティ条件はマスタデータで指定）
  - Q11: はい、可能性がある（同じアイテムが重複して排出される）
  - Q12: A. 10連の場合、最後のN回が確定枠、残りが通常枠
- **解決状況:** 完全に解決
- **確定した仕様:**
  - レアリティ条件（SR以上、SSR以上等）はステップごとにマスタデータで設定可能
  - 確定枠N体は同じアイテムが重複排出される可能性がある（重複排除なし）
  - 排出順序は、10連の場合「最初の(10-N)回が通常枠、最後のN回が確定枠」
  - 確定枠は指定レアリティ以上のアイテムから重み付き抽選で選択
- **備考:**
  - 既存の「10連の最後1回確定」と同じパターンを拡張する形で実装可能
  - 確定枠の抽選は通常枠とは独立した抽選処理として実装

#### 項目 A-6: ステップごとのガシャラインナップ
- **元の不明点:**
  - 全ステップで共通のラインナップを使用するのか
  - ステップごとに異なるラインナップを設定できるのか
  - 確定枠の対象はラインナップ全体なのか、サブセットなのか
- **ゲーム体験仕様確認結果:**
  - A-1の確認結果から、ステップごとに設定可能であることが判明
  - Q10, Q12の確認結果から、ラインナップから条件に合うアイテムを抽選することが判明
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ステップごとにラインナップグループを設定可能（共通でも個別でも可）
  - 確定枠の対象は、設定されたラインナップ全体の中から指定レアリティ条件を満たすアイテム
  - 通常枠は全ラインナップから抽選、確定枠は条件付きラインナップから抽選
- **備考:**
  - マスタデータでステップとラインナップグループIDの紐づけが必要
  - 柔軟性を持たせるため、ステップごとに異なるラインナップを設定できる設計を推奨

#### 項目 A-7: 無料ステップの実装範囲
- **元の不明点:**
  - 無料は初回のみなのか、周回時も無料なのか
  - 無料ステップの実行条件（広告視聴等の前提条件はあるか）
  - 無料ステップも周回数にカウントするのか
- **ゲーム体験仕様確認結果:**
  - Q6: DBで設定する（周回時に再度無料になるかはマスタデータで制御）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 無料ステップが周回時も無料になるかはマスタデータで設定可能
  - 「初回のみ無料」「毎周回無料」のいずれも実装可能な柔軟な設計が必要
  - 無料ステップも通常のステップとして周回数にカウントされる
- **備考:**
  - マスタデータに「初回のみ無料フラグ」を持つか、周回ごとのコスト設定を持つか要検討
  - 収益性の観点から、企画側が柔軟に設定できる仕組みが望ましい
  - 広告視聴等の特殊条件については今回の仕様には含まれない（通常のコスト設定のみ）

#### 項目 A-8: 複数のステップアップガシャの同時開催
- **元の不明点:**
  - 複数のステップアップガシャが同時に開催される可能性
  - ガシャごとに独立したステップ進行状況を管理するのか
  - 周回数上限はガシャごとに独立しているのか
- **ゲーム体験仕様確認結果:**
  - Q18: あります（複数のステップアップガシャが同時に開催される）
  - Q19: 引き継がれない（再開催時はステップ1から）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 複数のステップアップガシャが同時に開催される可能性がある
  - 各ガシャは独立したステップ進行状況を持つ（ガシャIDごとに管理）
  - 周回数上限もガシャごとに独立して設定される
  - 同じステップアップガシャが再開催される場合、前回のステップ進行状況は引き継がれない
- **備考:**
  - ユーザーデータテーブルは (usr_user_id, mst_gacha_id) の複合キーで管理
  - ガシャ一覧APIでは複数のステップアップガシャを返却可能な設計が必要

### 3.2 仕様書とコードの不一致

#### 項目 B-1: GachaType enumの未定義
- **元の不明点:**
  - マイグレーションファイルには'Stepup'が含まれているが、GachaType enumには未定義
  - 既存コードでStepupガシャを想定した実装が存在しない
- **ゲーム体験仕様確認結果:**
  - 全体の確認結果から、ステップアップガシャは新規機能として実装が確定
- **解決状況:** 完全に解決
- **確定した仕様:**
  - GachaType enumに「STEPUP = 'Stepup'」を追加する必要がある
  - 既存のガシャタイプ判定ロジックにStepup用の処理分岐を追加
  - GachaConstants::PERMISSION_GACHA_COST にStepup用の設定を追加
- **備考:**
  - マイグレーションファイルで既に'Stepup'が定義されているため、enum追加のみで対応可能
  - 既存のガシャ処理でStepupが想定されていない箇所の洗い出しが必要

#### 項目 B-2: ステップ管理テーブルの不在
- **元の不明点:**
  - 仕様書では「ステップ進行状況の管理」が必要だが、該当するテーブルが存在しない
  - usr_gacha_uppersは天井カウント用であり、ステップ管理には適さない
  - usr_gachasにはステップ番号を保存するカラムがない
- **ゲーム体験仕様確認結果:**
  - A-2, A-3の確認結果から、ステップ番号と周回数の管理が必要であることが確定
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ステップ進行状況を管理する新しいテーブル（usr_gacha_stepup等）を作成する
  - 管理する情報：
    - ユーザーID (usr_user_id)
    - ガシャID (mst_gacha_id)
    - 現在のステップ番号 (current_step_number)
    - 現在の周回数 (loop_count)
    - 最終実行日時 (last_executed_at)
    - 作成日時 (created_at)
    - 更新日時 (updated_at)
- **備考:**
  - 複合主キーは (usr_user_id, mst_gacha_id)
  - ガシャ期間終了時のデータクリーンアップ処理の実装が必要
  - 日次リセットは不要のため、リセット関連のカラムは不要

### 3.3 サーバー側で仕様確定が必要だった項目

#### 項目 C-1: ステップ実行時のレスポンス内容
- **元の不明点:**
  - ステップ実行後のレスポンスに含める情報
  - 次のステップ情報（必要コスト、確定枠条件等）の返却要否
  - 周回数、残りステップ数の返却要否
- **ゲーム体験仕様確認結果:**
  - Q20: クライアント側対応なのでサーバー側で考慮は不要
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ステップアップガシャの進行状況表示はクライアント側で制御される
  - サーバー側は必要最小限の情報（現在のステップ番号、周回数、抽選結果）を返却
  - 次のステップ情報等の詳細はクライアント側でマスタデータから取得して表示
- **備考:**
  - レスポンスには以下を含める：
    - 抽選結果（獲得したアイテム/キャラクター）
    - 現在のステップ番号
    - 現在の周回数
    - ガシャID
  - UI表示に必要な詳細情報（次ステップのコスト等）はクライアント側がマスタデータから取得

#### 項目 C-2: ステップスキップの可否
- **元の不明点:**
  - ステップは必ず順番に実行する必要があるのか
  - 例：ステップ1を飛ばしてステップ2から開始できるか
  - 特定のステップのみを繰り返し実行できるか
- **ゲーム体験仕様確認結果:**
  - Q3: 必ず順番に実行する必要がある
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ステップは必ず順番に実行する必要がある（スキップ不可）
  - ユーザーは現在のステップ番号のステップのみ実行可能
  - ステップ1→ステップ2→ステップ3...と順次進行する
  - 特定のステップを繰り返し実行することは不可（周回で全ステップ完了後にステップ1に戻るのみ）
- **備考:**
  - サーバー側でステップ番号の整合性チェックが必要（リクエストのステップ番号と保存されている現在ステップの一致確認）
  - ステップスキップを試みた場合はエラーを返却

#### 項目 C-3: ステップ中断時の扱い
- **元の不明点:**
  - ステップ途中（例：ステップ3まで実行）で期間終了した場合の挙動
  - 次回開催時にステップ3から継続できるのか、ステップ1からやり直しか
  - ステップ進行状況の保存期間
- **ゲーム体験仕様確認結果:**
  - Q8: B. 次回開催時はステップ1から再開
  - Q9: 返却されない（消費したプリズムは戻らない）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ステップ途中でガシャ期間が終了した場合、進行状況は次回に引き継がれない
  - 次回開催時は新しいガシャID（または同じガシャIDでも新規扱い）でステップ1から開始
  - 消費したプリズムは返却されない（通常のガシャと同じ扱い）
  - ステップ進行状況の保存期間はガシャの開催期間と同じ
- **備考:**
  - ガシャ期間終了時、該当ガシャのステップ進行状況データを削除またはアーカイブ
  - 同じステップアップガシャが再開催される場合でも、ユーザーは新規として扱われる
  - Q19の確認結果とも整合性がある

### 3.4 ゲーム体験的に不自然な可能性があった項目

#### 項目 D-1: 確定枠10体の設定
- **元の不明点:**
  - 仕様書には「確定枠は最大10体まで設定可能」とあるが、10連ガシャで確定10体なら全て確定になる
  - 通常枠との組み合わせが不自然（確定枠10体＋通常枠？）
- **ゲーム体験仕様確認結果:**
  - Q13: 極端なケースですが、意図した仕様です。それも可能ですよという意味合い
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 確定枠10体（排出全てが確定枠）という設定は意図した仕様として許容される
  - これは企画側が特別なイベントやキャンペーンで使用する可能性がある
  - 「最大10体まで設定可能」は上限値であり、通常は1〜3体程度を想定
  - 10連で確定10体の場合、通常枠は0となり、全ての排出が確定枠として抽選される
- **備考:**
  - システムとしては0〜10体の範囲で設定可能にする
  - 確定枠数が排出数を超える場合のバリデーションは不要（企画側の設定ミスは管理画面側で防止）
  - 極端な設定でも正しく動作することを確認するテストケースを追加

#### 項目 D-2: 無料ステップと周回の関係
- **元の不明点:**
  - ステップ1が無料の場合、周回するたびに無料で引けることになる
  - 無料ステップが周回時も適用されると収益性に問題
  - 無料ステップが初回のみの場合、周回時のステップ1のコスト設定が不明
- **ゲーム体験仕様確認結果:**
  - Q6: DBで設定する（周回時に再度無料になるかはマスタデータで制御）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 無料ステップが周回時も無料になるかは企画側がマスタデータで設定可能
  - 「初回のみ無料」「毎周回無料」のいずれも実装可能な柔軟な設計
  - 収益性への影響は企画側が判断してマスタデータで制御
  - 周回時のコスト設定も含めて、全てマスタデータで管理される
- **備考:**
  - A-7の確認結果と一致
  - マスタデータ設計時に、周回ごとにコストを変更できる仕組みを検討（例：1周目のステップ1は無料、2周目以降は有償等）
  - または、「初回無料フラグ」を持たせてシンプルに実装する選択肢もある

#### 項目 D-3: 最終ステップの割引の意図
- **元の不明点:**
  - 仕様書には「第1・第2ステップを割引」とあるが、最終ステップの扱いが不明
  - 通常は最終ステップが最も高コスト・高リターンだが、仕様書では言及なし
  - 割引設定により、初期ステップのハードルを下げる意図は明確
- **ゲーム体験仕様確認結果:**
  - Q15: 企画側で自由に設定する
  - Q16: DBで設定する（割引率や金額は企画側が決定）
  - Q17: DBで設定する（最終ステップのコストも企画側が決定）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 各ステップのコスト設定（プリズム個数）は企画側が完全に自由に設定
  - 「大幅な割引」の具体的な割引率や金額もマスタデータで設定
  - 最終ステップのコスト設定方針（高額・同額・割引等）も企画側が決定
  - システムは推奨値を提示せず、企画側の設定値をそのまま使用
- **備考:**
  - サーバー側ではコストの妥当性検証は不要（企画側の責任範囲）
  - 各ステップのコストはマスタデータで柔軟に設定できる設計を優先
  - 「通常より少ない」「大幅な割引」等の表現はゲーム体験仕様書の説明文であり、システムで考慮不要

## 4. 残存する不明点・追加確認が必要な項目

### 4.1 まだ不明な点
- なし（全ての不明点が解決済み）

### 4.2 新たに発生した疑問点
- なし（ゲーム体験仕様確認結果により、全ての仕様が明確化された）

## 5. サーバー実装への影響評価

### 5.1 仕様確定度の評価
- 全体的な仕様確定度: 100%
- サーバー実装に必要な仕様が全て揃っているか: Yes
- 揃っていない場合、何が足りないか: （該当なし）

### 5.2 実装への影響

#### 新たに追加実装が必要になった箇所
1. **マスタデータテーブル**
   - ステップアップガシャ用のマスタテーブル作成
   - 各ステップの設定（ステップ番号、コスト、排出回数、確定枠設定、ラインナップ）
   - 周回設定（最大周回数、周回時の無料ステップ設定）

2. **ユーザーデータテーブル**
   - ステップ進行状況管理テーブル（usr_gacha_stepup等）
   - 現在のステップ番号、周回数、最終実行日時を保持

3. **Enum定義**
   - GachaType::STEPUP の追加

4. **抽選ロジック**
   - レアリティ条件付き確定枠抽選ロジック
   - 最後のN回が確定枠となる排出順序制御

5. **ステップ進行ロジック**
   - ステップ番号のインクリメント処理
   - 最終ステップ完了時の周回処理（ステップ1に戻る）
   - 周回数上限チェック

6. **バリデーション**
   - ステップ順序チェック（現在のステップと一致しているか）
   - 周回数上限チェック
   - ガシャ期間の有効性チェック

7. **データクリーンアップ**
   - ガシャ期間終了時のステップ進行状況データ削除処理

#### ゲーム体験仕様確認によって変更が必要になった箇所
- なし（既存のガシャ機能への影響はなく、新規追加のみ）

#### 実装不要になった箇所
- 日次リセット処理（Q7の確認結果により不要と確定）
- プリズム返却処理（Q9の確認結果により不要と確定）
- ステップ進行状況の引き継ぎ処理（Q8, Q19の確認結果により不要と確定）

### 5.3 スケジュール・リスクへの影響

#### ゲーム体験仕様確認前の想定からの変更点
- 日次リセット処理が不要になったことで、実装範囲が縮小
- 全てのステップ設定がDB管理となり、柔軟性が向上する一方、マスタデータのテーブル設計が重要に
- 周回時の無料ステップ設定もDB管理となり、柔軟性が向上

#### スケジュールへの影響
- 日次リセット処理の削減により、実装工数が約10%削減される見込み
- マスタデータテーブル設計の重要度が高まるため、設計フェーズに十分な時間を確保すべき
- 全体としては、不明点が全て解消されたことで、手戻りリスクが大幅に低減
- 実装フェーズへの移行が可能

#### 残存リスク
- **低リスク:** マスタデータの設計が複雑になる可能性（ステップごとの設定項目が多い）
  - 対策：既存のガシャマスタテーブル設計を参考に、正規化を適切に行う
- **低リスク:** 確定枠抽選ロジックの実装難易度
  - 対策：既存の「10連の最後1回確定」ロジックを拡張する形で実装すれば、実装難易度は低い
- **低リスク:** 企画側のマスタデータ設定ミスによる不具合
  - 対策：管理画面側でバリデーションを実装（確定枠数 > 排出数の警告等）

## 6. 次のアクションアイテム
- [x] プランナーへの確認完了（全20項目）
- [x] 仕様の明確化完了
- [ ] マスタデータテーブル設計の開始
  - mst_stepup_gachas（ステップアップガシャ基本情報）
  - mst_stepup_gacha_steps（各ステップの詳細設定）
- [ ] ユーザーデータテーブル設計の開始
  - usr_gacha_stepup（ステップ進行状況管理）
- [ ] マイグレーションファイルの作成
- [ ] GachaType::STEPUP の追加
- [ ] ステップアップガシャ用のモデル・リポジトリの実装
- [ ] ステップ進行ロジックの実装
- [ ] 確定枠抽選ロジックの実装
- [ ] ガシャ実行API（UseCase, Controller）の実装
- [ ] テストケースの作成
- [ ] 管理画面側のマスタデータ登録機能の実装（別チケット）

---

**実装開始判断: 可能**

全ての不明点が解消され、サーバー実装に必要な仕様が完全に確定しました。マスタデータテーブル設計から実装フェーズに進むことができます。
