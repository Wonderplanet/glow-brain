# ステップアップガシャ - サーバー要件（コード調査による追加・補足）

## サーバー要件（コード調査による追加・補足）

### 要件C-1: ガシャ実装の既存アーキテクチャ構造
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / ガシャ全般
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php`
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php`
  - `api/app/Domain/Gacha/Models/UsrGacha.php`
  - `api/app/Domain/Gacha/Models/UsrGachaUpper.php`
- **内容の要約:**
  - 既存のガシャシステムは、マスタデータ（opr_gacha系）とユーザーデータ（usr_gacha系）の2層構造で管理されている
- **詳細:**
  - マスタデータテーブル：opr_gachas, opr_gacha_use_resources, opr_gacha_prizes, opr_gacha_uppers等
  - ユーザーデータテーブル：usr_gachas（ガシャ実行状況）, usr_gacha_uppers（天井カウント）
  - GachaServiceでマスタデータの取得・検証、ガシャ実行処理を管理
  - UseCaseレイヤーでトランザクション制御とビジネスロジックのオーケストレーション
- **実装パターンの適用範囲:**
  - **全種類のガシャ（Normal, Premium, Pickup, Free, Ticket, Festival, PaidOnly, Medal, Tutorial）に適用可能**
  - **ステップアップガシャも同様の構造で実装可能と考えられる**
- **備考:**
  - ステップアップガシャ用の新しいGachaType追加と、ステップ管理用のテーブル設計が必要となる点

### 要件C-2: 既存のガシャタイプ定義
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / ガシャタイプ管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/Enums/GachaType.php`
  - `api/database/migrations/mst/2024_05_22_045515_create_gacha_table.php`
- **内容の要約:**
  - 現在のGachaType Enumには「Stepup」型が存在しないため、ステップアップガシャ用の新しいタイプ追加が必要となる
- **詳細:**
  - 既存のGachaType: NORMAL, PREMIUM, PICKUP, FREE, TICKET, FESTIVAL, PAID_ONLY, MEDAL, TUTORIAL
  - マイグレーションファイルには「Stepup」が含まれているが、Enumには未定義
  - ステップアップガシャを実装するには、GachaType enumへの追加とマスタテーブルのenum制約更新が考慮ポイント
- **元になったコードの抜粋:**
  ```php
  // GachaType.php
  enum GachaType: string
  {
      case NORMAL = 'Normal';
      case PREMIUM = 'Premium';
      case PICKUP = 'Pickup';
      case FREE = 'Free';
      case TICKET = 'Ticket';
      case FESTIVAL = 'Festival';
      case PAID_ONLY = 'PaidOnly';
      case MEDAL = 'Medal';
      case TUTORIAL = 'Tutorial';
      // Stepup は未定義
  }
  ```
- **備考:**
  - マイグレーションとEnum定義の不一致が確認された。ステップアップガシャ実装時に整合性を取る必要がある

### 要件C-3: トランザクション管理の実装パターン
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / トランザクション処理
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャ抽選処理では、コスト消費・報酬配布・カウント更新等の全DB更新処理をトランザクションで囲む必要がある
- **詳細:**
  - UseCaseTraitの`applyUserTransactionChanges`メソッドを使用してトランザクション管理
  - トランザクション内で、リソース消費→報酬配布→ガシャ履歴保存の順序で実行
  - 処理途中でエラー発生時は自動ロールバックされ、データ整合性を保証
- **実装パターンの適用範囲:**
  - **全種類のガシャおよびリソース消費を伴う処理全般に適用可能**
  - **ステップアップガシャのステップ進行処理もこのパターンで実装すべき**
- **元になったコードの抜粋:**
  ```php
  // GachaDrawUseCase.php
  $this->applyUserTransactionChanges(function () use (...) {
      // 1. リソース消費
      $this->gachaService->execConsumeResource($logGachaAction);
      // 2. 報酬配布
      $this->rewardDelegator->sendRewards($usr->getUsrUserId(), $platform, $now);
      // 3. ガシャ履歴保存
      $this->gachaService->addGachaHistory(...);
  });
  ```
- **備考:**
  - 仕様書には明記されていないが、データ整合性保証のため必須のパターン

### 要件C-4: 日次リセット処理の実装パターン（アクセス時判定方式）
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 日次カウントリセット
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `resetUsrGachaDailyCount` メソッド
  - `api/app/Domain/Common/Entities/Clock.php` の `isFirstToday` メソッド
  - `api/app/Domain/Gacha/Models/UsrGacha.php` の `resetDailyCount`, `resetAdDailyCount` メソッド
- **内容の要約:**
  - 日次リセット処理は、バッチではなくアクセス時にClock機能で日跨ぎ判定を行い、必要に応じてリセットする方式で実装されている
- **詳細:**
  - `Clock::isFirstToday()`で最終プレイ日時と現在のゲーム内日付開始時刻（04:00 JST）を比較
  - 日跨ぎしていればdaily_countとad_daily_countをリセット
  - リセット処理はガシャ実行前の`getUsrGacha`メソッド内で自動的に実行される
- **実装パターンの適用範囲:**
  - **ユーザーごとの定期リセット処理全般（日次・週次・月次）に適用可能**
  - **ステップアップガシャで日次ステップ制限がある場合もこのパターンで実装すべき**
- **実装方針の背景:**
  - バッチ処理基盤（cron、AWS EventBridge等）の保守コストを削減
  - リアルタイム性の確保（04:00にバッチが動かなくても、次回アクセス時に確実にリセット）
  - 大量ユーザーへのバッチ実行負荷を分散
- **代替案が必要になる条件:**
  - リセット対象が全ユーザー（数百万人）かつ一斉処理が必要な場合
  - アクセス時のレスポンスタイムが厳しく制約される場合
  - **ステップアップガシャの仕様ではこれらの条件に該当しないと想定される**
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - resetUsrGachaDailyCount()
  if (!is_null($usrGacha->getPlayedAt()) && $this->clock->isFirstToday($usrGacha->getPlayedAt())) {
      $usrGacha->resetDailyCount();
  }
  if (!is_null($usrGacha->getAdPlayedAt()) && $this->clock->isFirstToday($usrGacha->getAdPlayedAt())) {
      $usrGacha->resetAdDailyCount();
  }
  ```
- **備考:**
  - 仕様書には「毎日04:00にリセット」という結果のみ記載されており、実装方法は未記載

### 要件C-5: コスト消費管理の実装パターン
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 通貨・アイテム消費
- **関連ファイル:**
  - `api/app/Domain/Gacha/Manager/CostConsumptionManager.php`
  - `api/app/Domain/Gacha/Manager/Consumers/DiamondConsumer.php`
  - `api/app/Domain/Gacha/Manager/Consumers/PaidDiamondConsumer.php`
  - `api/app/Domain/Gacha/Manager/Consumers/ItemConsumer.php`
  - `api/app/Domain/Gacha/Manager/Consumers/FreeConsumer.php`
  - `api/app/Domain/Gacha/Manager/Consumers/AdConsumer.php`
- **内容の要約:**
  - コスト消費はCostType（Diamond, PaidDiamond, Item, Ad, Free等）ごとに専用Consumerクラスで処理するStrategy パターンで実装されている
- **詳細:**
  - CostConsumptionManagerがCostTypeに応じて適切なConsumerを選択
  - 各ConsumerがCostConsumerInterfaceを実装し、setConsumeResource/execConsumeResourceメソッドを提供
  - opr_gacha_use_resourcesテーブルでガシャごとのコスト設定を管理
- **実装パターンの適用範囲:**
  - **全種類のガシャおよびコスト消費を伴う処理全般に適用可能**
  - **ステップアップガシャの各ステップの異なるコスト設定もこのパターンで実装可能**
- **元になったコードの抜粋:**
  ```php
  // CostConsumptionManager.php
  switch ($costType->value) {
      case CostType::ITEM->value:
          $this->costConsumer = app()->make(ItemConsumer::class);
          break;
      case CostType::DIAMOND->value:
          $this->costConsumer = app()->make(DiamondConsumer::class);
          break;
      case CostType::PAID_DIAMOND->value:
          $this->costConsumer = app()->make(PaidDiamondConsumer::class);
          break;
      // ...
  }
  ```
- **備考:**
  - ステップアップガシャでは、ステップごとに異なるCostTypeやコスト数を設定する必要があるため、このパターンの拡張が必要

### 要件C-6: 天井（Upper）システムの実装パターン
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 天井カウント管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/Models/UsrGachaUpper.php`
  - `api/app/Domain/Gacha/Enums/UpperType.php`
  - `api/app/Domain/Gacha/Services/GachaService.php` の `getUsrGachaUppers`, `increaseUpperCount`, `resetUsrUpperCount`
  - `api/database/migrations/2024_06_21_055830_create_usr_gacha_table.php`
- **内容の要約:**
  - 天井システムは、upper_group（天井グループID）とupper_type（MaxRarity/Pickup）の組み合わせでカウント管理されている
- **詳細:**
  - usr_gacha_uppersテーブル：usr_user_id, upper_group, upper_type, count でユニーク制約
  - 既存のUpperType: MAX_RARITY（最高レアリティ確定）, PICKUP（ピックアップ確定）
  - ガシャ実行時に天井カウントをインクリメントし、到達時に確定排出してリセット
  - upper_groupで複数ガシャ間での天井共有が可能
- **実装パターンの適用範囲:**
  - **天井機能を持つ全種類のガシャに適用可能**
  - **ステップアップガシャのステップ管理には別の仕組みが必要と考えられる**（天井とステップは概念が異なる）
- **代替案が必要になる条件:**
  - ステップアップガシャは「N回目に確定」というステップ概念であり、既存の「累計X回で天井」とは異なる
  - **ステップ進行状況の管理には、usr_gacha_uppers とは別にステップ専用のテーブルまたはカラムが必要になる可能性**
- **元になったコードの抜粋:**
  ```php
  // UsrGachaUpper.php
  public function init(string $usrUserId, string $upperGroup, string $upperType): void
  {
      $this->id = $this->newUniqueId();
      $this->usr_user_id = $usrUserId;
      $this->upper_group = $upperGroup;
      $this->upper_type = $upperType;
      $this->count = 0;
  }
  
  // GachaService.php
  protected function increaseUpperCount(...) {
      foreach ($usrGachaUppers as $usrGachaUpper) {
          $usrGachaUpper->addCount();
      }
  }
  ```
- **備考:**
  - ステップアップガシャの仕様では「最大10ステップ」「ステップごとに確定枠設定」とあり、既存の天井システムとは管理方法が異なる

### 要件C-7: ガシャ実行回数制限の検証パターン
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 実行回数制限
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `validatePlayCount`, `validateAd` メソッド
  - `api/app/Domain/Resource/Mst/Entities/OprGachaEntity.php`
- **内容の要約:**
  - ガシャ実行前に、日次上限（daily_play_limit_count）と累計上限（total_play_limit_count）の検証が行われる
- **詳細:**
  - OprGachaEntityに daily_play_limit_count, total_play_limit_count, daily_ad_limit_count, total_ad_limit_count を設定
  - UsrGachaに count（累計実行回数）, daily_count（日次実行回数）を記録
  - validatePlayCountメソッドで上限超過をチェックし、超過時はGameExceptionをthrow
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用可能**
  - **ステップアップガシャでも周回数制限を実装する場合、同様のパターンで実装可能**
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - validatePlayCount()
  if (
      !is_null($oprGacha->getTotalPlayLimitCount()) &&
      $usrGacha->getCount() > $oprGacha->getTotalPlayLimitCount()
  ) {
      throw new GameException(ErrorCode::GACHA_PLAY_LIMIT, 'gacha cannot draw total count');
  }
  ```
- **備考:**
  - ステップアップガシャの仕様に「周回数の設定も可能」とあるため、この検証パターンが活用できる

### 要件C-8: ガシャ抽選ロジックの優先順位制御
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 抽選処理
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `draw` メソッド
  - `api/app/Domain/Gacha/Entities/GachaLotteryBox.php`
- **内容の要約:**
  - ガシャ抽選時の優先順位は「1. ピックアップ天井 → 2. 最高レアリティ天井 → 3. 確定枠 → 4. 通常抽選」で制御されている
- **詳細:**
  - 1回の抽選ごとに天井到達判定を行い、到達していれば該当Boxから抽選
  - 10連の場合、通常枠と確定枠を組み合わせて抽選（例：9回通常 + 1回確定）
  - LotteryFactoryで重み付き抽選を実行
- **実装パターンの適用範囲:**
  - **確定枠機能を持つガシャ全般に適用可能**
  - **ステップアップガシャの確定枠設定もこのロジックの拡張で実装可能**
- **代替案が必要になる条件:**
  - ステップアップガシャでは「ステップN回目は〇〇レアリティ以上からN体確定」という仕様があり、既存の確定枠ロジックの拡張が必要
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - draw()
  if ($this->isReachUpper($usrGachaUpperPickup, $oprGachaUpperPickup)) {
      // PickUp確定
      $box = $this->generatePickupBox($gachaLotteryBoxData->getRegularLotteryBox());
  } elseif ($this->isReachUpper($usrGachaUpperMaxRarity, $oprGachaUpperMaxRarity)) {
      // 最高レアリティから抽選
      $box = $this->generateMaxRarityBox($gachaLotteryBoxData->getRegularLotteryBox());
  } else {
      // 通常抽選 or 確定枠抽選
  }
  $prize = $this->lottery($box);
  ```
- **備考:**
  - ステップアップガシャでは「レアリティ〇〇以上から」という条件付き抽選が必要なため、既存の抽選ロジックを拡張する必要がある

### 要件C-9: ガシャ履歴管理とキャッシュ保存
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / ガシャ履歴表示
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `addGachaHistory` メソッド
  - `api/app/Domain/Gacha/Services/GachaCacheService.php`
  - `api/app/Domain/Gacha/Repositories/LogGachaRepository.php`
- **内容の要約:**
  - ガシャ実行結果はキャッシュに保存され、ユーザーが「ガシャ履歴」画面で過去の結果を確認できるようになっている
- **詳細:**
  - ガシャID、コストタイプ、引いた回数、獲得した報酬などの情報をキャッシュに保存
  - log_gachasテーブルにも永続化され、長期的な履歴管理が可能
  - GachaCacheServiceでキャッシュの読み書き管理
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用可能**
  - **ステップアップガシャの履歴もこのパターンで実装すべき**（ステップ情報も含めて保存）
- **備考:**
  - 仕様書には履歴表示機能の記載がないが、ユーザー体験として必須の機能

### 要件C-10: ミッションシステムとの連携
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / ミッション進捗更新
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaMissionTriggerService.php`
  - `api/app/Domain/Mission/Entities/Criteria/GachaDrawCountCriterion.php`
  - `api/app/Domain/Mission/Entities/Criteria/SpecificGachaDrawCountCriterion.php`
- **内容の要約:**
  - ガシャ実行時、ミッションシステムへトリガーを送信し、「〇〇回ガシャを引く」などのミッション進捗を更新する必要がある
- **詳細:**
  - GachaMissionTriggerServiceがガシャID、引いた回数などの情報をミッションシステムに通知
  - ミッションシステム側でGachaDrawCountCriterion（全ガシャ）やSpecificGachaDrawCountCriterion（特定ガシャ）の達成判定
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用可能**
  - **ステップアップガシャもミッションシステムと連携する必要がある**
- **備考:**
  - 仕様書には記載がないが、ミッション機能との整合性のため必須

### 要件C-11: ガシャ有効期限（expires_at）管理
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 有効期限管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `validateExpiration` メソッド
  - `api/app/Domain/Gacha/Models/UsrGacha.php` の `expires_at` カラム
  - `api/database/migrations/2025_03_13_052343_add_expires_at_to_usr_gachas.php`
- **内容の要約:**
  - UsrGachaに有効期限（expires_at）を設定でき、期限切れのガシャは実行不可となる検証が存在する
- **詳細:**
  - usr_gachasテーブルのexpires_atカラムに有効期限を保存
  - ガシャ実行前にvalidateExpirationメソッドで期限チェック
  - 期限切れの場合はGAME_EXCEPTION（GACHA_EXPIRED）をthrow
- **実装パターンの適用範囲:**
  - **期限付きガシャ全般に適用可能**
  - **ステップアップガシャでも「初回購入から48時間限定」などの仕様に対応可能**
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - validateExpiration()
  public function validateExpiration(UsrGachaInterface $usrGacha, CarbonImmutable $now): void
  {
      $expiresAt = $usrGacha->getExpiresAt();
      if (!is_null($expiresAt) && $usrGacha->getExpiresAt() < $now) {
          throw new GameException(ErrorCode::GACHA_EXPIRED, 'gacha expired');
      }
  }
  ```
- **備考:**
  - 仕様書には有効期限の記載がないが、ステップアップガシャで期限付き提供する場合に活用可能

### 要件C-12: N連ガシャ（multi_draw_count）の実装パターン
- **種別:** コードから判明した追加要件（仕様書要件11の補足）
- **関連機能:** ステップアップガシャ / 連続実行 / ステップごとの抽選回数設定管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `validatePlayNum` メソッド
  - `api/app/Domain/Resource/Mst/Entities/OprGachaEntity.php` の `multi_draw_count`
- **内容の要約:**
  - ガシャは1回引きだけでなく、N連（10連など）で引ける機能があり、multi_draw_countで最大連数を設定できる
- **詳細:**
  - OprGachaEntityのmulti_draw_countで最大連数（例：10）を設定
  - リクエストのplayNumがmulti_draw_count以下かを検証
  - N連の場合、確定枠の処理が入る（例：10連の最後1回は高レア確定）
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用可能**
  - **ステップアップガシャでも「ステップNは10連」などの設定に活用可能**
- **ステップアップガシャへの適用方法:**
  - **各ステップごとにmulti_draw_count相当の設定を持つ必要がある**
  - 例：STEP1の抽選回数=5、STEP2の抽選回数=10、STEP3の抽選回数=1
  - マスタテーブル設計時に「ステップごとの抽選回数」カラムが必要
  - ゲーム体験仕様書では「STEP1:5連、STEP2:10連...」のような可変設定が記載されている
  - 既存の単一ガシャのmulti_draw_countとは異なり、ステップごとに異なる回数を管理する拡張が必要
- **実装上の考慮点:**
  - ステップごとに異なる抽選回数を設定できるため、マスタデータ設計が重要
  - リクエスト時のplayNum検証は、現在のステップの抽選回数設定と照合する
  - ステップ実行時、そのステップの抽選回数分だけ抽選処理を実行
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - validatePlayNum()
  public function validatePlayNum(int $playNum, int $oprGachaMultiDrawCount): void
  {
      if ($playNum <= 0 || $playNum > $oprGachaMultiDrawCount) {
          throw new GameException(ErrorCode::GACHA_NOT_EXPECTED_PLAY_NUM, 'gacha play_num not expected');
      }
  }
  ```
- **備考:**
  - 仕様書要件11「ステップごとの抽選回数設定管理」に対応
  - ステップアップガシャでは「ステップ1は5連、ステップ2は無料10連、ステップ5は1連」のように、ステップごとに異なる実行回数を設定する必要がある
  - この柔軟性により、企画側は多様なステップアップ体験を提供可能

### 要件C-13: ガシャログ（log_gacha_actions）の記録
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / ログ・監査
- **関連ファイル:**
  - `api/app/Domain/Gacha/Repositories/LogGachaActionRepository.php`
  - `api/app/Domain/Gacha/Models/LogGachaAction.php`
  - `api/database/migrations/2024_09_25_030203_create_log_gacha_actions_table.php`
- **内容の要約:**
  - ガシャ実行時、log_gacha_actionsテーブルにアクション履歴を記録する必要がある
- **詳細:**
  - ガシャID、ユーザーID、コストタイプ、実行回数などをlog_gacha_actionsに保存
  - コスト消費前にログを作成し、トランザクション内で整合性を保証
  - 監査・不正検知・運営分析に使用される
- **実装パターンの適用範囲:**
  - **全種類のガシャおよび重要アクション全般に適用可能**
  - **ステップアップガシャのステップ実行履歴も同様に記録すべき**
- **備考:**
  - 仕様書には記載がないが、運営管理・不正対策のため必須

### 要件C-14: コスト検証の厳密性（costIdとcostNumの整合性チェック）
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / コスト検証
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `setConsumeResource` メソッド
- **内容の要約:**
  - クライアントから送信されたcostIdとcostNumが、マスタデータと一致するかを厳密に検証する必要がある
- **詳細:**
  - opr_gacha_use_resourcesから該当のコスト設定を取得
  - リクエストのcostId, costNumとマスタの値を比較し、不一致の場合はGAME_EXCEPTION（GACHA_UNJUST_COSTS）をthrow
  - チート対策として重要な検証処理
- **実装パターンの適用範囲:**
  - **全種類のガシャおよびコスト消費を伴う処理全般に適用すべき**
  - **ステップアップガシャの各ステップでも同様の検証が必要**
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - setConsumeResource()
  $costIdIsValid = ($requestCostIdIsEmpty && $resourceCostIdIsEmpty) ||
                  (!$requestCostIdIsEmpty && $resourceCostId === $costId);
  
  if (!$costIdIsValid) {
      throw new GameException(ErrorCode::GACHA_UNJUST_COSTS, ...);
  }
  ```
- **備考:**
  - 仕様書には記載がないが、セキュリティ・不正対策のため必須

### 要件C-15: 既存ガシャとの差異（ステップ進行管理の必要性）
- **種別:** 仕様書要件の補足
- **関連機能:** ステップアップガシャ / ステップ状態管理
- **関連ファイル:**
  - （既存実装なし）
- **内容の要約:**
  - ステップアップガシャは既存ガシャと異なり、「現在何ステップ目か」「ステップをリセットするか周回するか」の状態管理が新たに必要となる
- **詳細:**
  - 既存のusr_gachasテーブルにはステップ情報を保存するカラムが存在しない
  - 既存のusr_gacha_uppersは天井カウント用であり、ステップ進行状況の管理には適さない
  - ステップアップガシャ専用のステップ進行状況を管理する仕組みが必要
  - 管理すべき情報：現在のステップ番号、現在の周回数、周回リセット条件、ステップリセット条件
- **備考:**
  - 仕様書には「周回数の設定も可能」とあるが、周回時のステップリセット仕様が不明確
  - 「最大10ステップ」を完了した後、1ステップ目に戻るのか、10ステップ目を繰り返すのかが未確定

### 要件C-16: BOXガシャとの類似性と差異
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 実装参考
- **関連ファイル:**
  - `docs/sdd/features/BOXガシャ/02_サーバー要件_コード調査追記.md`
- **内容の要約:**
  - BOXガシャの実装パターンがステップアップガシャの参考になるが、抽選方式と状態管理に根本的な違いがある
- **詳細:**
  - 類似点：マスタ・ユーザーデータの2層構造、コスト消費、報酬配布、トランザクション管理
  - 相違点：
    - BOXガシャ：排出済みアイテムを除外していく「消化型」抽選
    - ステップアップガシャ：ステップ進行に応じて確定枠が変わる「段階型」抽選
  - BOXガシャの状態管理パターン（残りアイテム管理）はステップアップガシャには適用できない
- **備考:**
  - BOXガシャの実装ドキュメントを参考にしつつ、ステップ管理の独自実装が必要

### 要件C-17: 抽選テーブル管理の実装パターン（特許対策との関係）
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 抽選テーブルID管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/Entities/GachaLotteryBox.php`
  - `api/app/Domain/Gacha/Services/GachaService.php` の `convertToGachaLotteryBox`, `draw` メソッド
- **内容の要約:**
  - ガシャの抽選は固定された確率テーブル（LotteryBox）を参照する方式で実装されており、ユーザーの履歴に基づく動的確率変動は行っていない
- **詳細:**
  - opr_gacha_prizesテーブルから抽選対象と確率（weight）を読み込み、GachaLotteryBoxとして構築
  - 抽選時は構築済みのLotteryBoxからランダム選択するのみで、ユーザーの過去の結果に応じた確率変動処理は存在しない
  - この実装方式は、ゲーム体験仕様書Page 3「特許侵害リスクについて」で示された「固定テーブル切り替え方式」に該当する
  - ステップアップガシャでも、各ステップは独立した固定の抽選テーブルIDを参照する設計が求められる
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用されている**
  - **ステップアップガシャの各ステップも同様に固定テーブル方式で実装すべき**
- **実装方針の背景:**
  - 特許侵害リスク回避（「ハズレが続いたから確率を上げる」等の動的確率変動の特許を回避）
  - 景品表示法コンプライアンス（提示した確率と実際の確率の一致を保証）
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - convertToGachaLotteryBox()
  public function convertToGachaLotteryBox(
      Collection $regularLotteryBox,
      ?Collection $fixedLotteryBox
  ): GachaLotteryBox {
      // 排出対象のマスターデータを検証
      // レアリティを付与したGachaPrizeに変換
      $regularBox = $regularLotteryBox->map(function (OprGachaPrizeEntity $prize) {
          return new GachaPrize(..., $prize->getWeight(), ...);
      });
      return new GachaLotteryBox($regularBox, $fixedBox);
  }
  
  // GachaService.php - draw()
  $prize = $this->lottery($box); // 固定テーブルからのランダム抽選のみ
  ```
- **備考:**
  - ゲーム体験仕様書では「全てのSTEPで同一の確率とする」とあるが、確定枠の有無によってテーブルが切り替わる点に注意が必要

### 要件C-18: ガシャ開催期間管理の実装パターン
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 開催期間とリセット
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `validateActivePeriod` メソッド
  - `api/app/Domain/Resource/Mst/Entities/OprGachaEntity.php` の `start_at`, `end_at`
- **内容の要約:**
  - ガシャの開催期間はマスタデータ（opr_gachas.start_at, end_at）で管理され、期間外の実行は不可となる検証が存在する
- **詳細:**
  - OprGachaEntityにstart_at（開始日時）とend_at（終了日時）を設定
  - validateActivePeriodメソッドで現在時刻が開催期間内かをチェック
  - 期間外の場合はGAME_EXCEPTION（GACHA_NOT_ACTIVE_PERIOD）をthrow
  - ゲーム体験仕様書Page 5では「ガシャ開催期間終了とともにステップ状況はリセットされる」とあり、この期間管理が前提となる
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用されている**
  - **ステップアップガシャも同様に開催期間を管理し、期間終了時にステップ進行状況をリセットする必要がある**
- **実装方針の背景:**
  - イベントガシャや期間限定ガシャの運用を可能にする
  - 期間外の不正アクセスを防止
- **代替案が必要になる条件:**
  - ステップアップガシャの進行状況リセットをバッチ処理で行う場合（現状の日次リセットパターンとは異なる）
  - ガシャ期間と独立してステップ進行状況を管理する場合
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - validateActivePeriod()
  public function validateActivePeriod(OprGachaInterface $oprGacha, CarbonImmutable $now): void
  {
      if ($now < $oprGacha->getStartAt() || $oprGacha->getEndAt() < $now) {
          throw new GameException(ErrorCode::GACHA_NOT_ACTIVE_PERIOD, 'gacha not active');
      }
  }
  ```
- **備考:**
  - ゲーム体験仕様書では期間終了時のリセット処理の実装方法は未記載

### 要件C-19: 報酬付与システムとの連携パターン
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / 報酬・おまけの付与
- **関連ファイル:**
  - `api/app/Domain/Reward/RewardDelegator.php`
  - `api/app/Domain/Gacha/Services/GachaService.php` の `convertOprGachaPrizesToRewards` メソッド
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャで獲得した報酬は、RewardDelegatorを経由して統一的に付与される仕組みが実装されている
- **詳細:**
  - ガシャの抽選結果（OprGachaPrize）をReward形式に変換
  - RewardDelegatorがリワードタイプ（キャラ、アイテム、通貨など）に応じて適切なサービスに委譲して付与処理を実行
  - トランザクション内で報酬付与が行われ、整合性を保証
  - ゲーム体験仕様書Page 5, 6では「報酬・おまけ」として各種アイテム（コイン、無償プリズム、原画、キャラアイコン、エンブレム、スタミナ回復アイテム）の付与が記載されている
- **実装パターンの適用範囲:**
  - **ガシャだけでなく、ミッション報酬、ショップ購入特典など、報酬付与全般に適用されている**
  - **ステップアップガシャの「おまけ」もこのRewardDelegatorを使用して付与すべき**
- **実装方針の背景:**
  - 報酬付与ロジックの一元管理（重複実装の排除）
  - 各種リワードタイプへの拡張性確保
- **元になったコードの抜粋:**
  ```php
  // GachaDrawUseCase.php - exec()
  $rewards = $this->gachaService->convertOprGachaPrizesToRewards($prizes);
  $this->rewardDelegator->setRewards($rewards);
  
  $this->applyUserTransactionChanges(function () use (...) {
      // ...
      $this->rewardDelegator->sendRewards($usr->getUsrUserId(), $platform, $now);
  });
  ```
- **備考:**
  - ゲーム体験仕様書Page 6では「ガシャを引いた時点でおまけは付与され」とあり、タイミング制御が重要となる

### 要件C-20: 確定枠の100%排出実装パターン
- **種別:** コードから判明した追加要件（仕様書要件15の補足）
- **関連機能:** ステップアップガシャ / 確定枠実装方式
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php` の `getGachaLotteryBox`, `draw` メソッド
  - `api/app/Domain/Gacha/Entities/GachaLotteryBox.php`
  - `api/database/migrations/mst/2024_07_20_065356_alter_gacha_tables_for_fix_lottery.php`
- **内容の要約:**
  - 確定枠は `fixed_prize_group_id` に紐づく専用の抽選グループから排出する方式で実装されており、100%排出を保証している
- **詳細:**
  - `opr_gachas` テーブルには2種類の抽選グループIDが存在：
    - `prize_group_id`: 通常抽選用のグループID（regularLotteryBox）
    - `fixed_prize_group_id`: 確定枠用のグループID（fixedLotteryBox）
  - N連ガシャの場合、通常枠は `prize_group_id` から抽選し、確定枠（例：10連の最後1回）は `fixed_prize_group_id` から抽選する
  - 「UR1体確定」の場合、`fixed_prize_group_id` に紐づく `opr_gacha_prizes` グループにUR1体だけを設定すれば、そこから100%排出される
  - ゲーム体験仕様書Page 5では「『確定』と謳う場合は、必ずそのレアリティが100%排出されるテーブルを使用する」と記載されている
- **実装パターンの適用範囲:**
  - **確定枠機能を持つガシャ全般に適用されている**
  - **ステップアップガシャの「N枠目がUR確定」も同じパターンで実装可能**
  - ステップごとに異なる確定枠を設定する場合、各ステップに対応する `fixed_prize_group_id` を用意する
- **実装方針の背景:**
  - 景品表示法コンプライアンス（優良誤認防止）
  - 「50%の確率でUR」を「UR確定」と表記する誤解を防ぐ
  - 抽選グループを分離することで、確定枠と通常枠の管理を明確化
- **元になったコードの抜粋:**
  ```php
  // GachaService.php - getGachaLotteryBox()
  $regularLotteryBox = $this->oprGachaPrizeRepository->getByGroupIdWithError(
      $oprGacha->getPrizeGroupId()
  );
  
  $fixedLotteryBox = null;
  if ($oprGacha->hasMultiFixedPrize()) {
      // N連の確定枠がある場合
      $fixedLotteryBox = $this->oprGachaPrizeRepository->getByGroupIdWithError(
          $oprGacha->getFixedPrizeGroupId()
      );
  }
  
  // GachaService.php - draw()
  if ($count <= $regularDrawCount) {
      // 通常枠
      $box = $regularLotteryBox;
  } else {
      // 確定枠
      $box = $gachaLotteryBoxData->getFixedLotteryBox();
  }
  $prize = $this->lottery($box);
  ```
- **備考:**
  - ゲーム体験仕様書では「〇〇以上からN体」という条件付き確定も記載されており、その場合は `fixed_prize_group_id` に該当レアリティ以上の全てのキャラを登録する必要がある
  - **ユーザーの想定通り、`fixed_prize_group_id` に紐づくグループに確定させたいキャラ/アイテムを設定すればよい**

### 要件C-21: 法務・コンプライアンス検証の実装状況
- **種別:** コードから判明した追加要件（仕様書要件17の補足）
- **関連機能:** ステップアップガシャ / 法務コンプライアンス
- **関連ファイル:**
  - `api/app/Domain/Gacha/Services/GachaService.php`の各種validateメソッド
  - `api/app/Domain/Gacha/Repositories/LogGachaActionRepository.php`
  - ガシャ関連の全てのエラーハンドリング
- **内容の要約:**
  - 既存のガシャシステムには、法務・コンプライアンス対応のための検証機能とログ記録機能が実装されている
- **詳細:**
  - **確率操作の禁止**: 既存実装は固定テーブル方式であり、動的確率変動は行っていない（C-17で確認済み）
  - **表記と実装の一致**: validateメソッド群で、マスタデータと実際の処理の整合性を検証
  - **確定枠の定義明確化**: generateMaxRarityBox等で100%排出を保証（C-20で確認済み）
  - **ログ記録**: log_gacha_actions, log_gachasでガシャ実行履歴を全て記録（C-13で確認済み）
  - ゲーム体験仕様書Page 7の法務確認項目に対応する実装が既に存在
- **実装パターンの適用範囲:**
  - **全種類のガシャに適用されている**
  - **ステップアップガシャも同様の検証とログ記録を行う必要がある**
- **実装方針の背景:**
  - 景品表示法、資金決済法、消費者契約法等への対応
  - 不正検知・監査対応
  - ユーザートラブル時の調査対応
- **追加で必要となる検証項目:**
  - **コンプガチャ規制**: ステップアップの「おまけ」が複数集めて合成する仕組みになっていないかの確認
  - **ステップ進行の不正防止**: ステップをスキップしたり、巻き戻したりする不正操作の防止
- **備考:**
  - ゲーム体験仕様書では「コンプガチャにならないように」との記載があり、おまけ設計時の注意が必要

### 要件C-22: レアリティ管理とフィルタリング機能
- **種別:** コードから判明した追加要件
- **関連機能:** ステップアップガシャ / レアリティ条件付き抽選
- **関連ファイル:**
  - `api/app/Domain/Gacha/Enums/Rarity.php`
  - `api/app/Domain/Gacha/Entities/GachaLotteryBox.php` の `getMaxRarity`, `getPrizes` メソッド
  - `api/app/Domain/Resource/Mst/Entities/OprGachaPrizeEntity.php` の `rarity`
- **内容の要約:**
  - ガシャの報酬にはRarity（N, R, SR, SSR, UR）が設定されており、レアリティによるフィルタリング機能が実装されている
- **詳細:**
  - Rarity enum: N, R, SR, SSR, UR の5段階
  - GachaLotteryBoxから特定レアリティのみを抽出する機能が存在（generateMaxRarityBox等）
  - ゲーム体験仕様書Page 2, 5では「〇〇以上からN体」という条件付き確定枠の記載があり、レアリティ範囲指定の実装が必要
- **実装パターンの適用範囲:**
  - **確定枠機能を持つガシャ全般に適用可能**
  - **ステップアップガシャの「SR以上から2体確定」などの実装に活用できる**
- **代替案が必要になる条件:**
  - 「SR以上」のような範囲指定は既存のgenerateMaxRarityBoxでは対応できないため、新しいフィルタメソッドの実装が必要
- **元になったコードの抜粋:**
  ```php
  // Rarity.php
  enum Rarity: int
  {
      case N = 1;
      case R = 2;
      case SR = 3;
      case SSR = 4;
      case UR = 5;
  }
  
  // GachaLotteryBox.php
  public function getMaxRarity(): ?int
  {
      $rarities = array_map(fn($prize) => $prize->getRarity(), $this->prizes);
      return !empty($rarities) ? max($rarities) : null;
  }
  ```
- **備考:**
  - ステップアップガシャで「〇〇以上」の条件を実装する場合、Rarity値の大小比較による範囲フィルタが必要
