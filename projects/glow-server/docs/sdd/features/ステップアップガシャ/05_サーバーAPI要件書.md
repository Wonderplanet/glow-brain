# サーバーAPI要件書

## 1. ドキュメント情報
- 対象機能: ステップアップガシャ
- 作成日: 2025-12-16
- 最終更新日: 2026-01-07
- 参照ドキュメント:
  - 01_サーバー要件抽出.md
  - 02_サーバー要件_コード調査追記.md
  - 03_サーバー仕様レビュー.md
  - 04_ゲーム体験仕様確認結果まとめ.md
  - 実装方針補足.txt
  - ゲーム体験仕様書.pdf（最新版）

## 更新履歴
- 2025-12-16: 初版作成
- 2026-01-07: おまけ報酬機能の追加
  - 要件 MD-3（ステップごとのおまけ報酬管理）を追加
  - 要件 GE-5（おまけ報酬の付与処理）を追加
  - 要件 MD-4 以降の要件IDを繰り下げ
  - opr_stepup_gacha_step_rewardsテーブルの追加
  - loop_count_target（対象周回数）の追加：NULL許容で全周回対応
  - レスポンス構造の拡張（gachaResultsとstepRewardsの区別）
  - データ要件、要件間の依存関係、実装設計タスクの更新
- 2026-02-16: 補填チケット対応（opr_gacha_use_resources フォールバック）
  - 要件 VL-3（コストの整合性検証）の拡張: opr_gacha_use_resources テーブルを使用したフォールバック検証を追加
  - 要件 VL-5（コストタイプの許可チェック）を追加: validateCostTypeの呼び出し追加
  - ステップ定義と異なるコストタイプ（補填チケット等）でのガシャ実行を許可

## 2. 機能概要

### 2.1 ユーザーへのゲーム体験
ステップアップガシャは、段階的に特典が向上していく仕組みのガシャ機能です。最大10ステップまで設定でき、各ステップで異なるコスト・排出回数・確定枠条件・おまけ報酬を設定できます。全ステップ完了後は自動的にステップ1に戻り、周回数の上限設定も可能です。初期ステップに無料や割引を設定することで、無課金・微課金ユーザーも手軽に始められ、最終ステップに強力な特典を配置することで課金を促進します。各ステップではガシャ抽選結果に加えて「おまけ報酬」（追加報酬）を付与することも可能で、ユーザーの満足度をさらに高めます。

### 2.2 サーバーAPIの役割
サーバーAPIは以下の役割を担います：
- ステップアップガシャのマスタデータ管理（ステップごとのコスト、排出回数、確定枠設定、おまけ報酬）
- ユーザーのステップ進行状況管理（現在のステップ番号、周回数）
- ステップごとの異なる条件でのガシャ抽選処理（レアリティ条件付き確定枠抽選）
- おまけ報酬の付与処理（ガシャ抽選とは別の追加報酬）
- ステップ進行処理（ステップ番号のインクリメント、周回処理）
- 既存ガシャシステムとの統合（既存のAPIエンドポイントを使用し、新規APIは追加しない）

### 2.3 実装方針の概要
既存の `/api/gacha/draw/*` APIを拡張し、新規APIエンドポイントは追加しません。レスポンスの `usrGacha` にステップアップガシャ用のパラメータを追加します（ステップアップガシャ以外の場合は空）。新しいDomainは追加せず、既存のGachaドメインを拡張します。

## 3. API要件一覧

### 3.1 マスタデータ管理

#### 要件 MD-1: ステップアップガシャの基本情報管理
- **要件ID:** REQ-MD-1
- **概要:**
  - ステップアップガシャ全体の基本情報をマスタデータで管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「ステップアップは最大10回まで設定可能」
    - 「周回数の設定も可能」
  - APIで実現すべき内容:
    - `opr_gachas` テーブルに `gacha_type = 'StepUp'` のレコードを登録
    - `opr_stepup_gachas` テーブルで以下の情報を管理:
      - `opr_gacha_id`: 親ガシャID（`opr_gachas` への外部キー）
      - `max_step_number`: 最大ステップ数（1〜10）
      - `max_loop_count`: 最大周回数（NULLの場合は無限周回）
  - 条件・制約:
    - `max_step_number` は 1〜10 の範囲
    - `max_loop_count` はNULL可（NULL = 無限周回）
  - データ管理要件:
    - マスタデータとして永続化
    - ガシャ開催期間は `opr_gachas` の `start_at`, `end_at` で管理
  - 検証・チェック要件:
    - `max_step_number` が1以上10以下であること
- **既存実装との関連:**
  - `opr_gachas` テーブルを活用
  - `GachaType` enumに `STEPUP = 'StepUp'` を追加する必要がある
- **備考:**
  - 実装方針補足.txtに基づき、新テーブル `opr_stepup_gachas` を追加

#### 要件 MD-2: ステップごとの詳細設定管理
- **要件ID:** REQ-MD-2
- **概要:**
  - 各ステップの詳細設定（コスト、排出回数、確定枠条件等）をマスタデータで管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「ステップアップ毎に必要なプリズム（無償 or 有償の設定可能）個数と確定枠を設定可能」
    - 「確定枠はガシャラインナップの中のレアリティから最大10体まで設定可能」
    - 「〇〇以上からN体の設定も可能」
    - 「ステップN回目は無料、アイテムも設定可能」
  - APIで実現すべき内容:
    - `opr_stepup_gacha_steps` テーブルで以下の情報を管理:
      - `opr_stepup_gacha_id`: ステップアップガシャID
      - `step_number`: ステップ番号（1〜10）
      - `cost_type`: コストの種類（Diamond, PaidDiamond, Item, Free等）
      - `cost_id`: コストのID（Itemの場合にアイテムID）
      - `cost_num`: コストの数
      - `draw_count`: 排出回数（何連ガシャか：1, 10等）
      - `fixed_prize_count`: 確定枠数（0〜10）
      - `fixed_prize_rarity_threshold_type`: 確定枠レアリティ条件（SR以上、SSR以上等）
      - `prize_group_id`: 賞品グループID（NULLの場合は `opr_gachas.prize_group_id` を参照）
      - `fixed_prize_group_id`: 確定枠賞品グループID（NULLの場合は `opr_gachas.fixed_prize_group_id` を参照）
      - `is_first_free`: 初回のみ無料フラグ（周回時のコスト制御）
  - 条件・制約:
    - `step_number` は 1〜10 の範囲で、`max_step_number` 以下
    - `draw_count` は 1以上（1連、10連等）
    - `fixed_prize_count` は 0〜10 の範囲で、`draw_count` 以下を推奨
    - `cost_type = 'Free'` の場合、`cost_num = 0`
  - データ管理要件:
    - ステップごとに異なる設定が可能
    - ステップ共通の賞品グループIDは `opr_gachas` で管理し、ステップ個別の設定は `opr_stepup_gacha_steps` で管理
  - 検証・チェック要件:
    - 全ステップ（1〜`max_step_number`）の設定が存在すること
    - `prize_group_id` または親の `opr_gachas.prize_group_id` が設定されていること
- **既存実装との関連:**
  - `CostType` enumを活用
  - `opr_gacha_prizes` テーブルを活用（賞品管理）
- **備考:**
  - 実装方針補足.txtに基づき、ステップ共通とステップ個別の賞品グループIDを使い分ける

#### 要件 MD-3: ステップごとのおまけ報酬管理
- **要件ID:** REQ-MD-3
- **概要:**
  - 各ステップで付与されるおまけ報酬（ガシャ抽選とは別の追加報酬）をマスタデータで管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「報酬・おまけ: ガシャ実行後に付与される報酬（アイテム、コイン、無償プリズム、原画、キャラ、エンブレム、スタミナ回復アイテムは設定可能とする）」
    - 「内部的には、ガシャを引いた時点で、おまけは付与され、STEPは進んでいる」
  - APIで実現すべき内容:
    - `opr_stepup_gacha_step_rewards` テーブルで以下の情報を管理:
      - `opr_stepup_gacha_id`: ステップアップガシャID
      - `step_number`: ステップ番号（1〜10）
      - `loop_count_target`: 対象周回数（NULLの場合は全周回で付与、0=初回、1=2周目...）
      - `resource_type`: 報酬タイプ（Item, Coin, FreeDiamond, Artwork, Unit, Emblem, Stamina等）
      - `resource_id`: 報酬ID（Itemの場合にアイテムID、Unitの場合にキャラID等）
      - `resource_amount`: 報酬数量
    - 1つのステップに複数のおまけ報酬を設定可能（例：STEP2でアイテムA×10 + コイン×1000）
    - 何周回目の指定も可能（例：初回のみアイテムA、2周目のみアイテムB）
    - `loop_count_target = NULL` の場合は全周回で同じおまけを付与
  - 条件・制約:
    - おまけ報酬はステップごとに独立して設定（コンプガチャ規制対策）
    - 「A, B, C, Dを集めるとEがもらえる」という仕組みは禁止
    - `step_number` は `opr_stepup_gacha_steps` に存在するステップ番号であること
    - `loop_count_target` はNULL可（NULL = 全周回で付与）
  - データ管理要件:
    - マスタデータとして永続化
    - おまけなしのステップも設定可能（レコードが存在しない場合はおまけなし）
  - 検証・チェック要件:
    - `resource_type` に対応する `resource_id` が正しく設定されていること
    - 同一ステップ・同一周回に同じリソースが重複登録されていないことを推奨（管理画面側で制御）
- **既存実装との関連:**
  - 既存の報酬系テーブル（`mst_stage_clear_time_rewards`, `mst_box_gacha_prizes` 等）の構造を参考
  - `ResourceType` enumを活用
  - `RewardDelegator` を使用して報酬付与処理を実装
- **備考:**
  - ゲーム体験仕様確認結果まとめ（項目 D-4）に基づく
  - おまけ報酬はガシャ抽選結果とは別に付与されるが、同一トランザクション内で処理
  - おまけ報酬の有無はステップごとに柔軟に設定可能

#### 要件 MD-4: ガシャラインナップとレアリティ情報の管理
- **要件ID:** REQ-MD-4
- **概要:**
  - ガシャの排出対象アイテム（キャラクター、アイテム）とレアリティ情報を管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「ガシャラインナップの中のレアリティから選ぶことも可能」
    - 「アイテムも設定可能」
  - APIで実現すべき内容:
    - `opr_gacha_prizes` テーブルでラインナップを管理（既存テーブルを活用）
    - `prize_group_id` でステップごとまたはガシャ全体のラインナップをグループ化
    - レアリティ情報は各賞品（キャラクター、アイテム）のマスタデータから取得
  - 条件・制約:
    - キャラクターとアイテムの両方を賞品として設定可能
  - データ管理要件:
    - 既存のガシャ賞品管理と同じテーブル構造を使用
  - 検証・チェック要件:
    - 設定された `prize_group_id` に対応する賞品が1件以上存在すること
    - 確定枠レアリティ条件を満たす賞品が存在すること
- **既存実装との関連:**
  - `opr_gacha_prizes` テーブルを活用
  - キャラクター、アイテムの各マスタテーブルからレアリティ情報を取得
- **備考:**
  - 確認結果 A-4: アイテムはガシャのラインナップに追加できる（排出物として）

### 3.2 ユーザーデータ管理

#### 要件 UD-1: ステップ進行状況の管理
- **要件ID:** REQ-UD-1
- **概要:**
  - ユーザーごとのステップアップガシャの進行状況を管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - ステップは順番に実行される
    - 最大ステップ完了後は自動的にステップ1に戻る
    - 周回数の上限管理
  - APIで実現すべき内容:
    - `usr_gachas` テーブルに以下のカラムを追加して情報を管理:
      - `current_step_number`: 現在のステップ番号（1〜10、ステップアップガシャのみ使用、NULL可）
      - `loop_count`: 現在の周回数（0以上、0=初回、ステップアップガシャのみ使用、NULL可）
    - 既存のカラム（`usr_user_id`, `opr_gacha_id`, `count`, `played_at`等）も同時に使用
  - 条件・制約:
    - 既存の主キー構造を維持
    - `current_step_number` と `loop_count` はステップアップガシャ以外ではNULL
    - `current_step_number` は常に次に実行するステップ番号を保持
  - データ管理要件:
    - ガシャ初回実行時に `current_step_number = 1`, `loop_count = 0` を設定
    - ステップ実行ごとに `current_step_number` をインクリメント
    - 最終ステップ完了時に `current_step_number = 1`, `loop_count++` に更新
    - ガシャ期間終了時にデータ削除またはアーカイブ（既存の処理と同様）
  - 検証・チェック要件:
    - `loop_count` が `max_loop_count` 未満であること（周回上限チェック）
- **既存実装との関連:**
  - `usr_gachas` テーブルを拡張（カラム追加）
  - `UsrGacha` モデルを拡張
- **備考:**
  - 実装方針補足.txtに基づき、既存テーブルにカラムを追加する方式を採用
  - 日次リセットは不要（確認結果 A-3）
  - 次回開催時はステップ1から再開（確認結果 A-3）

#### 要件 UD-2: 通常ガシャ情報の管理
- **要件ID:** REQ-UD-2
- **概要:**
  - ステップアップガシャも通常のガシャと同様に `usr_gachas` テーブルで基本情報を管理する
- **詳細仕様:**
  - APIで実現すべき内容:
    - `usr_gachas` テーブルに以下の情報を記録:
      - ガシャID、ユーザーID
      - 累計実行回数（`count`）
      - 最終実行日時（`played_at`）
    - ステップアップガシャ専用の情報は `usr_gachas` にカラム追加して管理する
      - `current_step_number` 
      - `loop_count`
  - 条件・制約:
    - ステップアップガシャでも `usr_gachas` にレコード作成
  - データ管理要件:
    - 既存のガシャと同じ管理方法
  - 検証・チェック要件:
    - 既存のガシャと同様の検証（期限チェック等）
- **既存実装との関連:**
  - `usr_gachas` テーブルを活用
  - `UsrGacha` モデルを使用
- **備考:**
  - 実装方針補足.txtに基づく

### 3.3 ガシャ実行処理

#### 要件 GE-1: ステップアップガシャの実行
- **要件ID:** REQ-GE-1
- **概要:**
  - ユーザーが現在のステップのガシャを実行する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - ステップは必ず順番に実行する必要がある
    - ステップごとに異なるコスト・排出回数・確定枠で抽選
  - APIで実現すべき内容:
    - 既存のガシャ実行API（`/api/gacha/draw/diamond`, `/api/gacha/draw/paid_diamond`, `/api/gacha/draw/item`, `/api/gacha/draw/free`）を使用
    - リクエストパラメータ:
      - `gacha_id`: ガシャID
      - `cost_type`: コストタイプ（現在のステップのコストタイプと一致）
      - `cost_id`: コストID（該当する場合）
      - `cost_num`: コスト数（現在のステップのコスト数と一致）
      - `play_num`: 実行回数（現在のステップの `draw_count` と一致）
    - 処理フロー:
      1. ステップアップガシャの判定（`gacha_type = 'StepUp'`）
      2. ステップ進行状況の取得（`usr_gachas` から `current_step_number`, `loop_count` を取得）
      3. 現在ステップの設定取得（`opr_stepup_gacha_steps`）
      4. コスト検証（コストタイプ、コスト数の一致確認）
      5. 周回数上限チェック
      6. コスト消費（既存のCostConsumptionManager使用）
      7. 抽選処理（通常枠 + 確定枠）
      8. 報酬配布（ガシャ抽選結果）
      9. おまけ報酬付与（REQ-GE-5参照）
      10. ステップ進行（`usr_gachas` の `current_step_number` インクリメント）
      11. ガシャ履歴保存（`log_gacha_actions` に `step_number`, `loop_count` を含めて記録）
      12. ミッショントリガー送信
  - 条件・制約:
    - ステップアップガシャ以外のガシャとは処理フローが異なる
    - トランザクション内で全処理を実行
  - データ管理要件:
    - `usr_gachas` の更新（累計回数、`current_step_number`, `loop_count`）
    - `log_gacha_actions` への記録（`step_number`, `loop_count` を含む）
  - 検証・チェック要件:
    - ガシャ有効期限チェック
    - コストの整合性チェック（不正防止）
    - 周回数上限チェック
- **既存実装との関連:**
  - `GachaDrawUseCase` を拡張
  - 既存のトランザクション管理パターンを活用
  - 既存のコスト消費パターンを活用
- **備考:**
  - 実装方針補足.txtで「リクエスト時のステップ数の整合性チェックをしない」とあるが、不正防止の観点から内部的には実施を推奨

#### 要件 GE-2: ステップ進行処理
- **要件ID:** REQ-GE-2
- **概要:**
  - ガシャ実行後、ステップ番号を進める処理
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 最大ステップ完了後は自動的にステップ1に戻る
  - APIで実現すべき内容:
    - ステップ実行後、`current_step_number` をインクリメント
    - `current_step_number` が `max_step_number` を超えた場合:
      - `current_step_number = 1` に戻す
      - `loop_count` をインクリメント
    - 周回数上限（`max_loop_count`）に達した場合は完了状態にする
  - 条件・制約:
    - トランザクション内で実行（報酬配布と同時にコミット）
  - データ管理要件:
    - `usr_gachas` の `current_step_number`, `loop_count` を更新
  - 検証・チェック要件:
    - 周回数上限チェックは実行前に行う
- **既存実装との関連:**
  - ガシャ実行処理の一部として実装
- **備考:**
  - 確認結果 A-2: 自動的にステップ1に戻る仕様

#### 要件 GE-3: 確定枠抽選処理
- **要件ID:** REQ-GE-3
- **概要:**
  - レアリティ条件付き確定枠の抽選処理
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「〇〇以上からN体の設定も可能」
    - 「10連の場合、最後のN回が確定枠、残りが通常枠」（確認結果 A-5）
  - APIで実現すべき内容:
    - 排出回数（`draw_count`）と確定枠数（`fixed_prize_count`）に基づき抽選
    - 例：10連で確定枠3体の場合:
      - 最初の7回: 通常抽選（全ラインナップから）
      - 最後の3回: 確定枠抽選（レアリティ条件を満たすアイテムから）
    - 確定枠抽選:
      - `fixed_prize_group_id` または `prize_group_id` から賞品リストを取得
      - `fixed_prize_rarity_threshold_type` でレアリティフィルタリング
      - フィルタリング後のアイテムから重み付き抽選
      - 同じアイテムの重複排出は許可（確認結果 A-5）
  - 条件・制約:
    - 確定枠は必ず条件を満たすアイテムから排出
    - 通常枠は全ラインナップから排出
  - データ管理要件:
    - 排出結果を報酬として配布
  - 検証・チェック要件:
    - 確定枠の対象アイテムが1件以上存在すること（マスタ設定時に確認）
- **既存実装との関連:**
  - 既存の確定枠ロジック（10連の最後1回確定）を拡張
  - `GachaService::draw` メソッドを拡張
- **備考:**
  - 確認結果 A-5: 最後のN回が確定枠、重複排出あり

#### 要件 GE-4: 無料ステップの処理
- **要件ID:** REQ-GE-4
- **概要:**
  - 無料ステップのコスト消費処理
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「ステップN回目は無料」
    - 周回時に再度無料になるかはマスタデータで設定（確認結果 A-7）
  - APIで実現すべき内容:
    - `cost_type = 'Free'` の場合、コスト消費をスキップ
    - `is_first_free = true` の場合:
      - 初回（`loop_count = 0`）のみ無料
      - 周回時（`loop_count > 0`）は通常コストに変更
    - `is_first_free = false` の場合:
      - 毎周回無料
  - 条件・制約:
    - 無料ステップでもコスト検証は実施（`cost_type`, `cost_num` の一致確認）
  - データ管理要件:
    - 通常のガシャと同様
  - 検証・チェック要件:
    - 無料条件の検証
- **既存実装との関連:**
  - 既存の `FreeConsumer` を活用
  - 既存の広告ガシャの無料処理と同様
- **備考:**
  - 確認結果 A-7: 初回のみ無料とするか、毎周回無料とするかをマスタデータで設定可能

#### 要件 GE-5: おまけ報酬の付与処理
- **要件ID:** REQ-GE-5
- **概要:**
  - ステップ実行時におまけ報酬を付与する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「報酬・おまけ: ガシャ実行後に付与される報酬」
    - 「内部的には、ガシャを引いた時点で、おまけは付与され、STEPは進んでいる」
  - APIで実現すべき内容:
    - ガシャ実行時、現在のステップと周回数に対応するおまけ報酬を取得
    - `opr_stepup_gacha_step_rewards` から以下の条件でおまけ報酬を取得:
      - `opr_stepup_gacha_id` = 実行中のガシャID
      - `step_number` = 現在のステップ番号
      - `loop_count_target` = 現在の周回数 OR `loop_count_target IS NULL`
    - 取得したおまけ報酬を `RewardDelegator` を使用して付与
    - ガシャ抽選結果とは別に、おまけ報酬も同一トランザクション内で付与
    - おまけ報酬は複数設定可能（例：アイテム×10 + コイン×1000）
  - 条件・制約:
    - おまけ報酬はガシャ抽選結果とは独立している（コンプガチャ規制対策）
    - おまけがないステップも許容（`opr_stepup_gacha_step_rewards` にレコードがない場合）
    - `loop_count_target = NULL` の場合は全周回で同じおまけを付与
    - `loop_count_target` が指定されている場合は、その周回数でのみ付与
  - データ管理要件:
    - 付与したおまけ報酬もログに記録（`log_gacha_actions` または別途ログテーブル）
  - 検証・チェック要件:
    - おまけ報酬のリソースタイプとリソースIDの整合性確認
- **既存実装との関連:**
  - `RewardDelegator` を使用して報酬付与（既存の報酬付与パターンと統一）
  - `GachaService` または `GachaDrawUseCase` でおまけ報酬付与処理を追加
- **備考:**
  - ゲーム体験仕様確認結果まとめ（項目 D-4）に基づく
  - おまけ報酬の有無はステップごとに柔軟に設定可能
  - 周回数に応じた報酬変更も可能（例：初回のみ特別報酬、2周目以降は通常報酬）

### 3.4 レスポンス管理

#### 要件 RS-1: ガシャ実行APIのレスポンス拡張
- **要件ID:** REQ-RS-1
- **概要:**
  - ガシャ実行APIのレスポンスにステップアップガシャ用の情報を追加
- **詳細仕様:**
  - APIで実現すべき内容:
    - 既存のレスポンス構造（`usrGacha`）にステップアップガシャ用のフィールドを追加
    - ステップアップガシャの場合のみ以下の情報を含める:
      - `currentStepNumber`: 実行後の現在ステップ番号
      - `loopCount`: 実行後の周回数
    - おまけ報酬はガシャ抽選結果とは別に明確に区別して返却:
      - `gachaResults`: ガシャ抽選結果（通常枠 + 確定枠）
      - `stepRewards`: おまけ報酬（ステップ報酬）
    - ステップアップガシャ以外の場合、`currentStepNumber`, `loopCount`, `stepRewards` は `null` または空配列
  - 条件・制約:
    - 既存のレスポンス構造を変更せず、追加のみ
  - データ管理要件:
    - N/A
  - 検証・チェック要件:
    - N/A
- **既存実装との関連:**
  - 既存のガシャ実行APIレスポンスを拡張
  - `glow-schema/Schema/Gacha.yml` を参照
- **備考:**
  - 実装方針補足.txtに基づき、`usrGacha` に直接フィールドを追加

#### 要件 RS-2: update_and_fetchレスポンスの拡張
- **要件ID:** REQ-RS-2
- **概要:**
  - `/api/game/update_and_fetch` APIのレスポンスにステップアップガシャ情報を追加
- **詳細仕様:**
  - APIで実現すべき内容:
    - `usrGacha` 配列の各要素にステップアップガシャ情報を追加（REQ-RS-1と同じ構造）
    - ユーザーが実行中のステップアップガシャの進行状況を返却
  - 条件・制約:
    - 既存のレスポンス構造を変更せず、追加のみ
  - データ管理要件:
    - N/A
  - 検証・チェック要件:
    - N/A
- **既存実装との関連:**
  - `/api/game/update_and_fetch` APIを拡張
  - `glow-schema/Schema/Gacha.yml` を参照
- **備考:**
  - 実装方針補足.txtに基づく

### 3.5 ガシャ履歴・賞品情報

#### 要件 HI-1: ガシャ履歴の管理
- **要件ID:** REQ-HI-1
- **概要:**
  - ステップアップガシャの実行履歴を管理する
- **詳細仕様:**
  - APIで実現すべき内容:
    - `/api/gacha/history` APIでステップアップガシャの履歴も返却
    - 履歴情報に実行したステップ番号と周回数を含める
    - `log_gacha_actions` テーブルに以下のカラムを追加して情報を記録:
      - `step_number`: 実行したステップ番号（ステップアップガシャのみ使用、NULL可）
      - `loop_count`: 実行時の周回数（ステップアップガシャのみ使用、NULL可）
    - 既存のカラム（ユーザーID、ガシャID、実行日時等）も同時に使用
  - 条件・制約:
    - 既存のガシャ履歴と同じ形式で返却
    - `step_number` と `loop_count` はステップアップガシャ以外ではNULL
  - データ管理要件:
    - `log_gacha_actions` に全てのガシャ履歴を記録（ステップアップガシャの場合は `step_number`, `loop_count` も含む）
  - 検証・チェック要件:
    - N/A
- **既存実装との関連:**
  - `/api/gacha/history` APIを拡張
  - `GachaCacheService` を活用
  - `LogGachaRepository` を拡張（追加カラムの読み書き対応）
- **備考:**
  - 実装方針補足.txtに基づき、既存テーブルにカラムを追加する方式を採用

#### 要件 HI-2: ガシャ賞品情報の取得
- **要件ID:** REQ-HI-2
- **概要:**
  - ステップアップガシャの賞品情報を提供する
- **詳細仕様:**
  - APIで実現すべき内容:
    - `/api/gacha/prize` APIでステップアップガシャの賞品情報を返却
    - ステップごとの賞品情報を返却できるようにする
    - 各ステップの確定枠条件も含める
  - 条件・制約:
    - 既存の賞品情報APIと同じ形式
  - データ管理要件:
    - N/A
  - 検証・チェック要件:
    - N/A
- **既存実装との関連:**
  - `/api/gacha/prize` APIを拡張
- **備考:**
  - 実装方針補足.txtに基づき、既存APIを拡張

### 3.6 検証・不正防止

#### 要件 VL-1: ステップ順序の検証
- **要件ID:** REQ-VL-1
- **概要:**
  - ステップを順番に実行することを保証する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - ステップは必ず順番に実行する必要がある（確認結果 C-2）
  - APIで実現すべき内容:
    - （実装方針補足.txtで「リクエスト時のステップ数の整合性チェックをしない」とあるが、内部的には実施推奨）
    - サーバー側で現在のステップ番号を管理し、それ以外のステップ実行を拒否
    - クライアントからのリクエストパラメータに依存せず、サーバー側の状態で判断
  - 条件・制約:
    - 不正防止のため、サーバー側の状態を信頼する
  - データ管理要件:
    - `usr_gachas` の `current_step_number` を使用
  - 検証・チェック要件:
    - ステップ実行前に現在ステップを確認
- **既存実装との関連:**
  - 新規実装
- **備考:**
  - 実装方針補足.txtと矛盾するが、セキュリティ観点から実施を推奨

#### 要件 VL-2: 周回数上限の検証
- **要件ID:** REQ-VL-2
- **概要:**
  - 周回数上限を超えた実行を防止する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 周回回数の上限はマスタデータで設定（確認結果 A-2）
  - APIで実現すべき内容:
    - ステップ実行前に `loop_count` が `max_loop_count` 未満であることを確認
    - `max_loop_count = NULL` の場合は上限なし（無限周回）
    - 上限到達時はエラーを返却（`ErrorCode::GACHA_PLAY_LIMIT` 等）
  - 条件・制約:
    - 最終ステップ完了時に周回数をインクリメント
  - データ管理要件:
    - `usr_gachas` の `loop_count` を使用
  - 検証・チェック要件:
    - ガシャ実行前に検証
- **既存実装との関連:**
  - 既存の実行回数制限検証パターンを活用
  - `GachaService::validatePlayCount` を参考
- **備考:**
  - 確認結果 A-2: 上限はマスタデータで設定

#### 要件 VL-3: コストの整合性検証
- **要件ID:** REQ-VL-3
- **概要:**
  - クライアントから送信されたコスト情報とマスタデータの整合性を検証する
- **詳細仕様:**
  - APIで実現すべき内容:
    - 現在ステップの `cost_type`, `cost_id`, `cost_num` とリクエストの値を比較
    - ステップ定義のコストタイプと一致する場合はステップ定義のコストで検証
    - **ステップ定義と異なるコストタイプの場合、`opr_gacha_use_resources` テーブルからフォールバック検索を行う**
      - 補填チケット等の代替コストでの実行を許可する
      - `opr_gacha_use_resources` に `opr_gacha_id` + `cost_type` + `draw_count` で一致するレコードがあれば、そのコスト情報で検証する
      - `CostType::ITEM` の場合、N回分のレコードがなければ1回分のレコードを取得して回数分乗算する（通常ガシャと同様のロジック）
    - `opr_gacha_use_resources` にもレコードが存在しない場合はエラー（`ErrorCode::GACHA_UNJUST_COSTS`）
    - チート対策として重要
  - 条件・制約:
    - 無料ステップでも検証を実施
    - 初回無料（`is_first_free` + `loop_count=0`）の場合はフォールバックを行わず `CostType::FREE` のみ許可
    - `CostType::FREE` ステップでもフォールバックは行わない（無料ステップでは必ず無料で実行）
  - データ管理要件:
    - `opr_gacha_use_resources` テーブルに補填チケット等の代替コストレコードを登録することで、ステップアップガシャでも補填チケットで引けるようになる
  - 検証・チェック要件:
    - ガシャ実行前に必ず検証
- **既存実装との関連:**
  - 既存のコスト検証パターンを活用
  - `GachaService::validateBasicCost` の共通処理を使用
  - `OprGachaUseResourceRepository` を使用したフォールバック検索を追加
  - 通常ガシャの `GachaService::validateCost` と同様のロジックをステップアップガシャでも利用
- **備考:**
  - 要件C-14に基づく
  - 2026-02-16: 補填チケット対応のために `opr_gacha_use_resources` フォールバック検証を追加

#### 要件 VL-4: ガシャ期間の検証
- **要件ID:** REQ-VL-4
- **概要:**
  - ガシャ開催期間内であることを検証する
- **詳細仕様:**
  - APIで実現すべき内容:
    - `opr_gachas` の `start_at`, `end_at` で期間チェック
    - 期間外の場合はエラー（`ErrorCode::GACHA_EXPIRED`）
  - 条件・制約:
    - ステップアップガシャも通常ガシャと同じ期間管理
  - データ管理要件:
    - N/A
  - 検証・チェック要件:
    - ガシャ実行前に必ず検証
- **既存実装との関連:**
  - 既存の期限検証パターンを活用
  - `GachaService::validateExpiration`
- **備考:**
  - 既存機能と同様

#### 要件 VL-5: コストタイプの許可チェック
- **要件ID:** REQ-VL-5
- **概要:**
  - ステップアップガシャで許可されたコストタイプかを検証する
- **詳細仕様:**
  - APIで実現すべき内容:
    - `GachaConstants::PERMISSION_GACHA_COST[STEPUP]` に定義されたコストタイプ（Diamond, Item, Free）のみ許可
    - `GachaService::validateCostType` を使用して検証
    - 許可されていないコストタイプの場合はエラー（`ErrorCode::GACHA_TYPE_UNEXPECTED`）
  - 条件・制約:
    - ガシャ実行前に必ず検証（コスト検証の前に実施）
  - データ管理要件:
    - N/A
  - 検証・チェック要件:
    - ガシャ実行前に必ず検証
- **既存実装との関連:**
  - 通常ガシャと同じ `GachaService::validateCostType` を使用
  - `GachaConstants::PERMISSION_GACHA_COST` に `STEPUP` の設定が既に追加済み
- **備考:**
  - 2026-02-16: 補填チケット対応に伴い追加。通常ガシャでは既に実施されていたが、ステップアップガシャでは未実施だったため追加

### 3.7 データクリーンアップ

#### 要件 CL-1: ガシャ期間終了時のデータ削除
- **要件ID:** REQ-CL-1
- **概要:**
  - ガシャ期間終了時、ステップ進行状況データを削除またはクリアする
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 次回開催時はステップ1から再開（確認結果 A-3）
    - ステップ進行状況は引き継がれない（確認結果 A-8）
  - APIで実現すべき内容:
    - ガシャ期間終了後、該当ガシャの `usr_gachas` レコードの `current_step_number`, `loop_count` をNULLにクリア
    - またはusr_gachasレコード自体を削除（既存の運用方針に従う）
    - バッチ処理またはアクセス時に遅延削除
  - 条件・制約:
    - ログデータ（`log_gacha_actions`）は削除しない
  - データ管理要件:
    - `usr_gachas` のステップアップガシャ用カラムのクリアまたはレコード削除
  - 検証・チェック要件:
    - N/A
- **既存実装との関連:**
  - 既存のガシャデータクリーンアップパターンを参考
- **備考:**
  - 確認結果 A-3, A-8に基づく

## 4. 要件間の依存関係

### 4.1 前提となる要件
- REQ-MD-1（ステップアップガシャ基本情報）は全ての要件の前提
- REQ-MD-2（ステップ詳細設定）は REQ-GE-1（ガシャ実行）の前提
- REQ-MD-3（おまけ報酬設定）は REQ-GE-5（おまけ報酬付与）の前提
- REQ-UD-1（ステップ進行状況）は REQ-GE-1（ガシャ実行）の前提

### 4.2 同時に実現すべき要件
- REQ-GE-1（ガシャ実行）と REQ-GE-2（ステップ進行）は同一トランザクション内で実現
- REQ-GE-1（ガシャ実行）と REQ-GE-5（おまけ報酬付与）は同一トランザクション内で実現
- REQ-GE-1（ガシャ実行）と REQ-HI-1（履歴管理）は同一トランザクション内で実現
- REQ-RS-1（レスポンス拡張）と REQ-GE-1（ガシャ実行）は同時に実現

## 5. 非機能要件

### 5.1 パフォーマンス要件
- ガシャ実行APIのレスポンスタイム: 通常ガシャと同等（1秒以内を目標）
- トランザクション処理時間: 最小限（デッドロック防止）
- 抽選処理の最適化: N連ガシャでも高速に抽選完了

### 5.2 セキュリティ要件
- コスト整合性の厳密な検証（REQ-VL-3）
- ステップ順序の検証（REQ-VL-1）
- 周回数上限の検証（REQ-VL-2）
- トランザクション制御によるデータ整合性保証
- ログ記録による監査証跡の確保

### 5.3 可用性要件
- トランザクション内での処理完結（ロールバック対応）
- エラー時の適切なエラーメッセージ返却
- ガシャ期間外アクセス時の適切なエラーハンドリング

### 5.4 その他の非機能要件
- ログ記録: 全ガシャアクションを `log_gacha_actions` に記録（ステップアップガシャの場合は `step_number`, `loop_count` も含む）
- 監視: 既存のガシャ監視と同様の監視を実施
- 運用: 既存のガシャ運用フローに統合

## 6. データ要件

### 6.1 永続化が必要なデータ

#### マスタデータ
- **opr_stepup_gachas:**
  - 内容: ステップアップガシャの基本情報
  - 用途: 最大ステップ数、最大周回数の管理
  - 保持期間: 永久
  - 関連要件: REQ-MD-1

- **opr_stepup_gacha_steps:**
  - 内容: 各ステップの詳細設定
  - 用途: コスト、排出回数、確定枠条件の管理
  - 保持期間: 永久
  - 関連要件: REQ-MD-2

- **opr_stepup_gacha_step_rewards:**
  - 内容: 各ステップのおまけ報酬設定
  - 用途: ステップ実行時に付与されるおまけ報酬（ガシャ抽選とは別）の管理
  - データ項目:
    - opr_stepup_gacha_id: ステップアップガシャID
    - step_number: ステップ番号（1〜10）
    - loop_count_target: 対象周回数（NULL = 全周回で付与、0 = 初回、1 = 2周目...）
    - resource_type: 報酬タイプ（Item, Coin, FreeDiamond等）
    - resource_id: 報酬ID
    - resource_amount: 報酬数量
  - 保持期間: 永久
  - 関連要件: REQ-MD-3, REQ-GE-5

#### ユーザーデータ
- **usr_gachas（拡張）:**
  - 内容: ガシャ実行基本情報 + ステップアップガシャ用情報
  - 追加カラム:
    - `current_step_number`: 現在のステップ番号（ステップアップガシャのみNULL以外）
    - `loop_count`: 現在の周回数（ステップアップガシャのみNULL以外）
  - 用途: 累計回数、最終実行日時、ステップ進行状況の管理
  - 保持期間: 永久（既存の運用ポリシーに従う）
  - 関連要件: REQ-UD-1, REQ-CL-1

#### ログデータ
- **log_gacha_actions（拡張）:**
  - 内容: ガシャ実行履歴 + ステップアップガシャ用情報
  - 追加カラム:
    - `step_number`: 実行したステップ番号（ステップアップガシャのみNULL以外）
    - `loop_count`: 実行時の周回数（ステップアップガシャのみNULL以外）
  - 用途: 監査、分析、不正検知
  - 保持期間: 永久（またはログ保持ポリシーに従う）
  - 関連要件: REQ-HI-1

### 6.2 一時的に管理が必要なデータ
- ガシャ履歴キャッシュ（既存のGachaCacheServiceと同様）

## 7. 外部システム連携要件

### 7.1 クライアント連携
- ガシャ実行リクエスト: 既存のガシャAPIと同じエンドポイント
- レスポンス: ステップアップガシャ情報を含む拡張レスポンス
- UI表示: クライアント側でステップ進行状況を表示（確認結果 C-1）

### 7.2 他API機能との連携
- ミッションシステム: ガシャ実行時にミッショントリガーを送信（要件C-10）
- 報酬システム: ガシャ抽選結果の報酬配布
- リソース管理: コスト消費処理

### 7.3 外部サービス連携
- なし

## 8. 残存する不明点・要確認事項

### 8.1 まだ不明な仕様
なし（全ての不明点が確認結果により解消）

### 8.2 実装時に判断が必要な事項

#### 整合性チェックの実装方針
- **項目名:** リクエストパラメータのステップ番号チェック
- **何が判断事項か:** 実装方針補足.txtでは「リクエスト時のステップ数の整合性チェックをしない」とあるが、不正防止の観点から実施が推奨される
- **実装への影響:** クライアントとサーバーの整合性チェック方式
- **推奨事項:** サーバー側の状態（`usr_gachas.current_step_number`）を信頼し、クライアントのリクエストパラメータは参考程度に扱う

#### データクリーンアップの実装方式
- **項目名:** ガシャ期間終了時のデータ削除方式
- **何が判断事項か:** バッチ削除かアクセス時遅延削除か
- **実装への影響:** 運用コスト、リアルタイム性
- **推奨事項:** 既存のガシャシステムと同じ方式を採用（アクセス時判定を推奨）

## 9. 要件確定度の評価

### 9.1 全体評価
- 要件の確定度: 100%
- API実装に必要な要件情報の充足度: 十分
- 実装開始の可否: 可

全ての不明点がゲーム体験仕様確認により解消され、実装に必要な要件が完全に確定しました。

### 9.2 カテゴリ別評価

#### マスタデータ管理（MD）
- 確定度: 100%
- 課題: なし
- 実装準備状況: テーブル設計から着手可能

#### ユーザーデータ管理（UD）
- 確定度: 100%
- 課題: なし
- 実装準備状況: テーブル設計から着手可能

#### ガシャ実行処理（GE）
- 確定度: 100%
- 課題: 確定枠抽選ロジックの実装難易度（既存ロジック拡張で対応可能）
- 実装準備状況: 実装着手可能

#### レスポンス管理（RS）
- 確定度: 100%
- 課題: なし
- 実装準備状況: 実装着手可能

#### ガシャ履歴・賞品情報（HI）
- 確定度: 100%
- 課題: なし
- 実装準備状況: 実装着手可能

#### 検証・不正防止（VL）
- 確定度: 95%（整合性チェックの実装方針に若干の判断余地あり）
- 課題: 実装方針補足.txtとの整合性
- 実装準備状況: 実装着手可能

#### データクリーンアップ（CL）
- 確定度: 90%（削除方式に判断余地あり）
- 課題: バッチ削除かアクセス時削除かの選択
- 実装準備状況: 実装着手可能

## 10. 次のステップ

### 10.1 要件確定のために必要なアクション
- [x] 全ての不明点の確認完了
- [x] ゲーム体験仕様の確定
- [x] サーバーAPI要件書の作成完了

### 10.2 実装設計へ向けて
- [ ] マスタデータテーブル設計
  - `opr_stepup_gachas` テーブル設計
  - `opr_stepup_gacha_steps` テーブル設計
  - `opr_stepup_gacha_step_rewards` テーブル設計（おまけ報酬）
  - マイグレーションファイル作成
- [ ] ユーザーデータテーブル設計
  - `usr_gachas` テーブルに `current_step_number`, `loop_count` カラム追加
  - `log_gacha_actions` テーブルに `step_number`, `loop_count` カラム追加
  - マイグレーションファイル作成
- [ ] Enum定義追加
  - `GachaType::STEPUP` の追加
- [ ] API設計
  - 既存API（`/api/gacha/draw/*`）の拡張設計
  - レスポンススキーマ定義（`glow-schema/Schema/Gacha.yml`）
  - おまけ報酬のレスポンス構造設計（ガシャ抽選結果と区別）
- [ ] ドメインロジック設計
  - ステップ進行ロジック
  - 確定枠抽選ロジック
  - 周回処理ロジック
  - おまけ報酬付与ロジック（RewardDelegator連携）
- [ ] 実装計画の策定
  - マイルストーンの設定
  - タスク分割
  - 工数見積もり
- [ ] テスト計画の策定
  - テストケースの洗い出し
  - テストデータの準備
- [ ] 管理画面側の要件整理（別チケット）
  - マスタデータ登録機能
  - ステップ設定UI

---

**実装開始判断: 可能**

全ての要件が明確化され、実装に必要な情報が揃っています。マスタデータテーブル設計から実装フェーズへ進むことができます。
