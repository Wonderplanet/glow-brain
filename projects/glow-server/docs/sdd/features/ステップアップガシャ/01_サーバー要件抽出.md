# サーバー要件抽出: ステップアップガシャ

## サーバー要件一覧

### 要件1: ステップアップガシャの最大ステップ数管理
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分
- **抜粋:**
  > ・ステップアップは最大 10 回まで設定可能。
- **サーバー観点での補足:**
  - ステップ数の上限管理と、各ステップの状態・進行状況の記録が必要となる点

### 要件2: ステップごとのプリズム（通貨）設定管理
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分
- **抜粋:**
  > ・ステップアップ毎に必要なプリズム（無償 or 有償の設定可能）個数と確定枠を設定可能。
- **サーバー観点での補足:**
  - 各ステップで消費される通貨（プリズム）の種類（無償/有償）と個数の管理、および通貨残高の検証が考慮ポイントとなる

### 要件3: 確定枠の設定管理
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分、およびPage 5「基本仕様_設定項目」の表内
- **抜粋:**
  > ・確定枠はガシャラインナップの中のレアリティから最大 10 体まで設定可能。
  > 　〇〇以上から N 体の設定も可能。
  > 確定枠設定: N枠目が特定のレア以上N体確定か STEP3,4:10枠目はUR1体確定...
- **サーバー観点での補足:**
  - ステップごとに確定枠として排出されるアイテム数、対象レアリティ、レアリティ条件（〇〇以上）のデータ管理が必要となる点

### 要件4: ガシャラインナップとレアリティの関連付け
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分
- **抜粋:**
  > ・ガシャラインナップの中のレアリティから選ぶことも可能。
- **サーバー観点での補足:**
  - ガシャのラインナップ定義と各アイテムのレアリティ情報の関連付け、およびレアリティによる抽選対象の絞り込みに関するデータ管理が考慮ポイントとなる

### 要件5: 無料ステップの設定
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分、およびPage 5「基本仕様_設定項目」
- **抜粋:**
  > ⇨ステップ N 回目は無料、アイテムも設定可能、確定枠の設定、ステップアップの周回数の設定もできる
  > 消費リソース: 消費する通貨の種類と量（消費する通貨は、有償・無償プリズム、ガシャチケット(アイテム)を設定可能とする）STEP:1,500個（有償のみ）、STEP2: 無料...
- **サーバー観点での補足:**
  - 特定ステップでのコスト免除（無料設定）の管理と、通常の通貨消費処理との条件分岐が考慮ポイントとなる

### 要件6: アイテムの設定
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分、およびPage 5「基本仕様_設定項目」
- **抜粋:**
  > ⇨ステップ N 回目は無料、アイテムも設定可能、確定枠の設定、ステップアップの周回数の設定もできる
  > 報酬・おまけ: ガシャ実行後に付与される報酬（アイテム、コイン、無償プリズム、原画、キャラ(キャラアイコン)、エンブレム、スタミナ回復アイテムは設定可能とする）
- **サーバー観点での補足:**
  - ステップごとに排出可能なアイテムの種類（アイテム、コイン、無償プリズム、原画、キャラアイコン、エンブレム、スタミナ回復アイテム）や個数の設定、およびガシャ実行時のアイテム付与に関するデータ管理が必要となる点

### 要件7: ステップアップの周回数管理
- **元ページ:** Page 2, 「概要」セクション内の仕様要件部分、およびPage 5「基本仕様_設定項目」と「ステップ進行の基本ルール」
- **抜粋:**
  > ⇨ステップ N 回目は無料、アイテムも設定可能、確定枠の設定、ステップアップの周回数の設定もできる
  > 周回数: ガシャを何周回できるか 1周回のみ可能、3周回可能、STEP1〜5を繰り返す
  > ループ設定: 周回可能: 最終ステップ実行後、Step 1に戻る。回数制限: 「お一人様1周限り」や「3周まで」などの制限設定を持てるようにする。
- **サーバー観点での補足:**
  - ユーザーがステップアップガシャを何周できるか（周回上限）の設定と、現在の周回数の記録・検証が必要となる点

### 要件8: 最終ステップの確定報酬
- **元ページ:** Page 2, 「◼ ステップアップガシャの利点と重要性」セクション内「1. 課金誘導と収益の最大化（ビジネス効率）」
- **抜粋:**
  > 最終ステップ（例： 5 ステップ目）に「最高レアリティ確定」などの強力な特典を設定することで、ユーザーに「ここまでは引くべき」という 明確なゴールと費用対効果（コストパフォーマンス）を示します。
- **サーバー観点での補足:**
  - 最終ステップにおける特別な確定報酬（最高レアリティ確定など）の設定と、その報酬の排出処理が考慮ポイントとなる

### 要件9: ステップごとの割引・回数設定
- **元ページ:** Page 2, 「◼ ステップアップガシャの利点と重要性」セクション内「3. 初期接触のハードル引き下げ」
- **抜粋:**
  > 第1 ステップや第 2 ステップを「大幅な割引」や「通常より少ない回数」で設定することで、 無課金・微課金層も試しに引くハードルが下がり 、ガシャへの接触率を高め、その後の継続的な課金への誘導を促します。
- **サーバー観点での補足:**
  - ステップごとに異なる消費コスト（割引適用後の金額）や実行回数の設定、およびそれらの値を用いた検証処理が必要となる点

### 要件10: ユーザーごとのステップ進行状況管理
- **元ページ:** Page 5, 「ステップ進行の基本ルール」、および全体的な仕様から推察
- **抜粋:**
  > ステップ構成: 最大Nステップ（例：Step 1〜Step 5）で構成される。
  > ループ設定: 周回可能: 最終ステップ実行後、Step 1に戻る。
  > リセット: ガシャ開催期間終了とともにステップ状況はリセットされる。
- **サーバー観点での補足:**
  - ユーザーごとに現在どのステップまで進行しているかの状態管理、および周回ごとの進行状況のリセット・継続処理が必要となる点

### 要件11: ステップごとの抽選回数設定管理
- **元ページ:** Page 5, 「基本仕様_設定項目」の表内
- **抜粋:**
  > 抽選回数: 1STEP 毎の抽選回数 STEP1:5連、STEP2:10連...
- **サーバー観点での補足:**
  - ステップごとに異なる抽選回数（5連、10連など）の設定と、その回数分のガシャ実行処理（抽選ロジックの複数回実行）が必要となる点

### 要件12: 抽選テーブルIDの管理（特許対策）
- **元ページ:** Page 5, 「基本仕様_設定項目」の表内、およびPage 3「特許侵害リスクについて」
- **抜粋:**
  > 抽選テーブルID: 参照する確率テーブル 全てのSTEPで同一の確率とする
  > 各ステップは、あらかじめサーバーサイドで定義された「独立したガシャID（抽選テーブル）」を呼び出すだけの仕組みとする。
  > 動的確率変動の回避: 「ユーザーの過去の抽選結果（ハズレ回数など）」に応じて、リアルタイムで確率を計算・変動させる処理は行わない。
- **サーバー観点での補足:**
  - 固定テーブル参照方式による抽選テーブルの管理と、各ステップへの紐づけが必要。動的な確率変動は行わず、あらかじめ定義された固定の抽選テーブルIDを参照することで、特許侵害リスクを回避する設計が求められる点

### 要件13: 報酬・おまけの付与管理とタイミング制御
- **元ページ:** Page 5, 「基本仕様_設定項目」の表内、およびPage 6「おまけ付与とSTEPが進行するタイミング」
- **抜粋:**
  > 報酬・おまけ: ガシャ実行後に付与される報酬（アイテム、コイン、無償プリズム、原画、キャラ(キャラアイコン)、エンブレム、スタミナ回復アイテムは設定可能とする）STEP2: スタミナドリンク×1、STEP5: ピックアップガシャチケット...
  > ガシャ結果画面に遷移し、結果演出が終了したタイミングで、報酬獲得画面を表示し、おまけを付与する。（内部的には、ガシャを引いた時点で、おまけは付与され、STEPは進んでいる）
- **サーバー観点での補足:**
  - ステップごとに設定される各種報酬（アイテム、コイン、無償プリズム、原画、キャラアイコン、エンブレム、スタミナ回復アイテムなど）の種類と個数の管理、およびガシャ実行時のタイミングでの付与処理（トランザクション内で即時付与し、クライアントへの表示タイミングとは独立）が必要となる点

### 要件14: ガシャ開催期間とステップ進行状況のリセット管理
- **元ページ:** Page 5, 「ステップ進行の基本ルール」
- **抜粋:**
  > リセット: ガシャ開催期間終了とともにステップ状況はリセットされる。
  > ループ設定: 周回可能: 最終ステップ実行後、Step 1に戻る。回数制限: 「お一人様1周限り」や「3周まで」などの制限設定を持てるようにする。
- **サーバー観点での補足:**
  - ガシャ開催期間の管理（開始日時・終了日時）と、期間終了時におけるユーザーのステップ進行状況の自動リセット処理、および最終ステップ完了後のStep 1への自動復帰とループ回数制限の管理が必要となる点

### 要件15: 確定枠の実装方式（100%排出テーブル）
- **元ページ:** Page 5, 「確定枠（保証）の仕様」
- **抜粋:**
  > 枠の処理: 「10連中、9回は通常抽選、最後の1回だけUR確定テーブルで抽選」といった処理を行う。
  > 権利リスク対策: 「確定」と謳う場合は、必ずそのレアリティが100%排出されるテーブルを使用する。「50%の確率でUR」のような曖昧な表記で「確定」という言葉を使わない（優良誤認防止）。
- **サーバー観点での補足:**
  - 確定枠における100%排出を保証する専用の抽選テーブルの用意と、N枠目だけ特定のテーブル（確定用）を使用する抽選処理の実装が必要。「確定」と表示する場合は必ず100%排出となるデータ設計が求められる点

### 要件16: トランザクション整合性とエラー復旧
- **元ページ:** Page 7, 「基本仕様_その他」
- **抜粋:**
  > ガシャ結果とステップ進行: 「ガシャは引けたがステップが進まなかった」「ステップだけ進んでガシャが引かれていない」という不整合を防げるようにする。
  > エラー時の挙動: 通信エラー等で中断した場合、再ログイン時に「中断されたステップ」から再開できる状態を担保する。
- **サーバー観点での補足:**
  - ガシャ実行（通貨消費・抽選・報酬付与）とステップ進行（current_step_number更新）の原子性（トランザクション処理）の保証、およびエラー発生時のリトライ・復旧処理（冪等性の担保）が必要となる点

### 要件17: 法務・コンプライアンス対応の検証項目
- **元ページ:** Page 7, 「法務関連で事前確認しておくこと」
- **抜粋:**
  > 確率操作ロジック: 「ハズレが続いたから確率を上げる」等の動的な操作が入っていないか？（単純な固定テーブル切り替えならリスク低）
  > 表記: 「確率2倍」等の表記をする際、比較対象（通常時の確率）が明記されているか？（景品表示法）
  > コンプガチャ: ステップアップのおまけで「A,B,C,Dを集めるとEがもらえる」という仕様になっていないか？（コンプガチャ規制に抵触するためNG）
  > 確定枠の定義: 「ピックアップ確定」と書いてあるのに、ピックアップ以外の最高レアが出る仕様になっていないか？
- **サーバー観点での補足:**
  - 確率操作の禁止（固定テーブル方式の徹底）、コンプガチャ規制への非抵触確認、確定枠の定義の正確性、表記と実装の一致などの検証とログ記録が必要となる点
