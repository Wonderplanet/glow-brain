# サーバー実装観点の仕様レビュー（自動分析レポート）

## 1. 要約

### 仕様の明瞭さ評価

現時点でのステップアップガシャ仕様には、以下の特徴が見られる。

**明瞭な部分：**
- 最大10ステップまで設定可能という上限が明確
- ステップごとにプリズム（無償/有償）の個数を設定できる
- 確定枠として最大10体まで設定可能
- 周回数の設定が可能

**不明瞭な部分：**
- ステップ進行の基本動作（1ステップ実行＝何連ガシャなのか）
- 周回時の動作（全ステップ完了後、どのステップに戻るのか）
- ステップリセット条件（日次リセットの有無、期間終了時の挙動）
- 「アイテムも設定可能」の意味（ガシャコストとしてアイテムを使用？ボーナス報酬？）
- 確定枠の詳細仕様（「〇〇以上からN体」の具体的な抽選ロジック）
- 無料ステップと通常ステップの違い（通貨消費以外の差異）

### 大きなリスク・不確定要素

1. **ステップ進行管理の設計が未確定**
   - 既存のusr_gacha_uppersテーブルは天井管理用であり、ステップ進行には適用不可
   - ステップ状態を管理する新しいテーブル設計が必要
   - 周回・リセット仕様が不明確なため、テーブル設計が確定できない

2. **既存ガシャシステムとの統合方法**
   - GachaType enumに「Stepup」が未定義
   - 既存の抽選ロジック（通常枠/確定枠/天井）とステップ確定枠の関係が不明
   - N連ガシャの仕組みとステップの関係が不明

3. **ステップごとの排出仕様の詳細不足**
   - 「レアリティ〇〇以上からN体確定」の抽選アルゴリズムが不明確
   - 確定枠と通常枠の組み合わせ方が不明
   - ステップごとに異なるラインナップを持つのか、共通ラインナップから確定条件だけ変わるのか

4. **ユーザー体験に関わる仕様の欠落**
   - ステップ途中でガシャ期間が終了した場合の挙動
   - ステップ進行状況の表示方法（UI連携）
   - 複数のステップアップガシャが同時開催される場合の扱い

## 2. 仕様の詳細化（サーバー観点）

### 2.1 ステップアップガシャの基本構造

**マスタデータ構造（推定）：**
- ガシャID：ステップアップガシャ全体を識別するID
- ガシャタイプ：「Stepup」（新規追加必要）
- ステップ定義：
  - ステップ番号（1〜10）
  - 必要プリズム種別（無償/有償/Free）
  - 必要プリズム個数
  - 排出回数（1連、10連等）
  - 確定枠設定（レアリティ条件、確定数）
  - ラインナップグループID
- 周回設定：
  - 最大周回数（nullable）
  - 周回時のステップリセット挙動

**ユーザーデータ構造（推定）：**
- ユーザーID
- ガシャID
- 現在のステップ番号
- 現在の周回数
- 最終実行日時
- ステップ進行状況（各ステップの実行済み/未実行フラグ）

### 2.2 ステップ実行の基本フロー

1. ユーザーがステップNを実行
2. 現在のステップ番号がNであることを検証
3. ステップNのコスト設定を取得
4. コスト消費（プリズム/無料）
5. ステップNの排出設定に従って抽選実行
   - 通常枠：ラインナップから通常抽選
   - 確定枠：レアリティ条件を満たすアイテムから抽選
6. 報酬配布
7. ステップ番号をインクリメント（N → N+1）
8. 最終ステップ完了時の処理
   - 周回設定に応じてステップ1に戻る、または完了状態にする

### 2.3 周回機能の詳細（仕様確定が必要）

**周回パターンA：無限周回**
- 最終ステップ完了後、自動的にステップ1に戻る
- 周回回数制限なし

**周回パターンB：回数制限周回**
- 最終ステップ完了後、周回カウントをインクリメント
- 最大周回数に達したら完了状態（実行不可）
- 最大周回数未満ならステップ1に戻る

**周回パターンC：最終ステップ繰り返し**
- ステップ1〜9は1回のみ実行可能
- ステップ10のみ繰り返し実行可能（周回上限あり）

**リセット条件（仕様確定が必要）：**
- 日次リセット：毎日04:00にステップ1に戻る
- 期間リセット：ガシャ終了後、次回開催時にステップ1から
- リセットなし：一度完了したら二度と実行できない

### 2.4 確定枠の抽選ロジック（詳細化が必要）

**「〇〇レアリティ以上からN体確定」の解釈：**

**解釈パターンA：**
- ラインナップから〇〇以上のレアリティのアイテムのみを抽出
- 抽出したアイテムからN体を重み付き抽選
- 通常枠は別途抽選（確定枠と合わせて排出）

**解釈パターンB：**
- 排出アイテム全体の中で、最低N体は〇〇以上のレアリティを保証
- 残りは通常抽選
- N体の保証は排出後の事後チェックで実現

**解釈パターンC：**
- N回の抽選のうち、指定された回数は〇〇以上確定の抽選を行う
- 例：10連の場合、最後のN回は確定枠抽選、残りは通常抽選

### 2.5 既存ガシャシステムとの統合方針

**活用できる既存パターン：**
- トランザクション管理（UseCaseTraitのapplyUserTransactionChanges）
- コスト消費管理（CostConsumptionManager + Consumer各種）
- 日次リセット処理（Clock::isFirstToday によるアクセス時判定）
- ガシャ履歴管理（GachaCacheService + LogGachaRepository）
- ミッショントリガー送信（GachaMissionTriggerService）
- 実行回数制限検証（validatePlayCount）
- N連抽選（multi_draw_count）

**新規実装が必要な要素：**
- GachaType::STEPUP の追加
- ステップ進行状況管理テーブル
- ステップごとの確定枠設定テーブル
- ステップ進行ロジック（ステップ番号のインクリメント/周回処理）
- レアリティ条件付き確定枠抽選ロジック

## 3. 不明点・曖昧点・判断が必要な項目

### A. 仕様書に記載がなく判断不能な項目

#### A-1: ステップ実行の基本単位
- **該当箇所:** ゲーム体験仕様書 Page 1
- **何が曖昧なのか:** 
  - 1ステップの実行＝何連のガシャなのかが不明
  - 仕様書には「通常より少ない回数」と記載があるが、具体的な回数が不明
  - 各ステップで排出回数が異なるのか、固定なのか
- **サーバーとして明確化が必要な理由:**
  - 抽選ロジックの設計に直結
  - 確定枠の数との整合性（10連で確定10体なら全て確定？）
  - コスト設定の妥当性検証

#### A-2: 周回時のステップリセット挙動
- **該当箇所:** ゲーム体験仕様書 Page 1「周回数の設定も可能」
- **何が曖昧なのか:**
  - 最大10ステップを完了した後の挙動が不明
  - ステップ1に戻るのか、ステップ10を繰り返すのか、実行不可になるのか
  - 周回回数のカウント方法（ステップ10完了で1周？全ステップ実行で1周？）
- **サーバーとして明確化が必要な理由:**
  - ユーザーデータのステップ番号管理ロジックが確定できない
  - 周回数上限のチェックタイミングが不明
  - ステップ進行状況のUI表示に影響

#### A-3: ステップのリセット条件
- **該当箇所:** 仕様書に記載なし
- **何が曖昧なのか:**
  - 日次リセットの有無（毎日04:00にステップ1に戻るのか）
  - ガシャ期間終了時、次回開催時のステップ状態
  - ステップ途中でガシャ期間が終了した場合の扱い
- **サーバーとして明確化が必要な理由:**
  - 日次リセット実装の要否判断
  - ユーザーデータの保持期間設計
  - 期間終了時のデータクリーンアップ処理

#### A-4: 「アイテムも設定可能」の意味
- **該当箇所:** ゲーム体験仕様書 Page 1「ステップN回目は無料、アイテムも設定可能」
- **何が曖昧なのか:**
  - アイテムがコストとして消費されるのか（既存のCostType::ITEMと同じ）
  - アイテムがボーナス報酬として付与されるのか
  - アイテムがガシャラインナップに追加されるのか
- **サーバーとして明確化が必要な理由:**
  - コスト消費ロジックと報酬配布ロジックの設計分岐
  - マスタデータのテーブル設計（どこにアイテム情報を持つか）

#### A-5: 確定枠「〇〇以上からN体」の抽選仕様
- **該当箇所:** ゲーム体験仕様書 Page 1「〇〇以上からN体の設定も可能」
- **何が曖昧なのか:**
  - 「〇〇以上」のレアリティ条件の指定方法
  - N体の確定枠と残りの通常枠の排出順序
  - N体が同時に排出されるのか、N回の抽選で順次排出されるのか
  - 確定枠の重複排出（同じアイテムがN体全て同じになる可能性）
- **サーバーとして明確化が必要な理由:**
  - 抽選アルゴリズムの実装方針
  - ユーザー体験（確定枠が最後に排出される等）への影響
  - 既存の確定枠ロジック（10連の最後1回確定）との統合方法

#### A-6: ステップごとのガシャラインナップ
- **該当箇所:** ゲーム体験仕様書 Page 1「ガシャラインナップの中のレアリティから選ぶ」
- **何が曖昧なのか:**
  - 全ステップで共通のラインナップを使用するのか
  - ステップごとに異なるラインナップを設定できるのか
  - 確定枠の対象はラインナップ全体なのか、サブセットなのか
- **サーバーとして明確化が必要な理由:**
  - マスタデータのテーブル設計（ラインナップとステップの関連付け）
  - 抽選処理の複雑度

#### A-7: 無料ステップの実装範囲
- **該当箇所:** ゲーム体験仕様書 Page 1「ステップN回目は無料」
- **何が曖昧なのか:**
  - 無料は初回のみなのか、周回時も無料なのか
  - 無料ステップの実行条件（広告視聴等の前提条件はあるか）
  - 無料ステップも周回数にカウントするのか
- **サーバーとして明確化が必要な理由:**
  - コスト検証ロジックの実装
  - 周回数カウントロジック
  - 無料ステップの悪用防止策

#### A-8: 複数のステップアップガシャの同時開催
- **該当箇所:** 仕様書に記載なし
- **何が曖昧なのか:**
  - 複数のステップアップガシャが同時に開催される可能性
  - ガシャごとに独立したステップ進行状況を管理するのか
  - 周回数上限はガシャごとに独立しているのか
- **サーバーとして明確化が必要な理由:**
  - ユーザーデータのテーブル設計（ガシャIDとステップの関連付け）
  - UI側での表示制御

### B. 仕様書とコードの不一致

#### B-1: GachaType enumの未定義
- **該当ファイル:** 
  - `api/app/Domain/Gacha/Enums/GachaType.php`
  - `api/database/migrations/mst/2024_05_22_045515_create_gacha_table.php`
- **どのように矛盾しているか:**
  - マイグレーションファイルには'Stepup'が含まれているが、GachaType enumには未定義
  - 既存コードでStepupガシャを想定した実装が存在しない
- **影響:**
  - GachaType::STEPUP の追加が必要
  - 既存のガシャタイプ判定ロジックへの影響確認が必要
  - GachaConstants::PERMISSION_GACHA_COST にStepup用の設定追加が必要

#### B-2: ステップ管理テーブルの不在
- **該当ファイル:** 
  - `api/app/Domain/Gacha/Models/UsrGacha.php`
  - `api/app/Domain/Gacha/Models/UsrGachaUpper.php`
- **どのように矛盾しているか:**
  - 仕様書では「ステップ進行状況の管理」が必要だが、該当するテーブルが存在しない
  - usr_gacha_uppersは天井カウント用であり、ステップ管理には適さない
  - usr_gachasにはステップ番号を保存するカラムがない
- **影響:**
  - ステップ進行状況を管理する新しいテーブル（usr_gacha_steps等）の作成が必要
  - または、usr_gachasテーブルにcurrent_step_number, loop_count等のカラム追加が必要

### C. サーバー側で仕様確定が必要な項目

#### C-1: ステップ実行時のレスポンス内容
- **決める必要がある点:**
  - ステップ実行後のレスポンスに含める情報
  - 次のステップ情報（必要コスト、確定枠条件等）の返却要否
  - 周回数、残りステップ数の返却要否
- **プランナーへの確認ポイント:**
  - UI側でどのような情報表示が必要か
  - ステップ進行状況の表示方法（プログレスバー、ステップ一覧等）

#### C-2: ステップスキップの可否
- **決める必要がある点:**
  - ステップは必ず順番に実行する必要があるのか
  - 例：ステップ1を飛ばしてステップ2から開始できるか
  - 特定のステップのみを繰り返し実行できるか
- **プランナーへの確認ポイント:**
  - ユーザーがステップを選択して実行できるUIなのか
  - 現在のステップのみ実行可能なのか

#### C-3: ステップ中断時の扱い
- **決める必要がある点:**
  - ステップ途中（例：ステップ3まで実行）で期間終了した場合の挙動
  - 次回開催時にステップ3から継続できるのか、ステップ1からやり直しか
  - ステップ進行状況の保存期間
- **プランナーへの確認ポイント:**
  - ステップアップガシャは都度開催なのか、常設なのか
  - 同じガシャIDで再開催される場合の進行状況の扱い

### D. ゲーム体験的に不自然な可能性がある項目

#### D-1: 確定枠10体の設定
- **問題点:**
  - 仕様書には「確定枠は最大10体まで設定可能」とあるが、10連ガシャで確定10体なら全て確定になる
  - 通常枠との組み合わせが不自然（確定枠10体＋通常枠？）
- **想定される影響:**
  - 抽選ロジックが意図した動作にならない可能性
  - ユーザーが期待する「確定枠」の概念との乖離

#### D-2: 無料ステップと周回の関係
- **問題点:**
  - ステップ1が無料の場合、周回するたびに無料で引けることになる
  - 無料ステップが周回時も適用されると収益性に問題
  - 無料ステップが初回のみの場合、周回時のステップ1のコスト設定が不明
- **想定される影響:**
  - 収益への影響
  - ユーザーの不正利用（無料周回の繰り返し）

#### D-3: 最終ステップの割引の意図
- **問題点:**
  - 仕様書には「第1・第2ステップを割引」とあるが、最終ステップの扱いが不明
  - 通常は最終ステップが最も高コスト・高リターンだが、仕様書では言及なし
  - 割引設定により、初期ステップのハードルを下げる意図は明確
- **想定される影響:**
  - 収益モデルの設計
  - ユーザーの課金動線

## 4. プランナーへ確認が必要な項目まとめ（最重要）

### ステップ実行の基本仕様について

- **Q1:** 1ステップの実行は何連のガシャに相当しますか？（1連、10連、ステップごとに異なる？）
  
- **Q2:** 各ステップで排出されるアイテム数は固定ですか、それともステップごとに異なりますか？

- **Q3:** ステップは必ず順番に実行する必要がありますか、それともユーザーが好きなステップを選択して実行できますか？

### 周回機能について

- **Q4:** 最大10ステップを完了した後、どのような挙動を想定していますか？
  - A. 自動的にステップ1に戻り、再度実行可能
  - B. ステップ10のみ繰り返し実行可能
  - C. 完了状態となり、それ以上実行不可

- **Q5:** 周回回数の上限は設定しますか？設定する場合、何周まで可能ですか？

- **Q6:** 周回時、無料ステップは再度無料になりますか、それとも初回のみ無料ですか？

### リセット条件について

- **Q7:** ステップ進行状況は日次でリセットされますか？（毎日04:00にステップ1に戻る）

- **Q8:** ガシャ期間が終了した場合、ステップ進行状況はどうなりますか？
  - A. 次回開催時に前回の続きから実行可能
  - B. 次回開催時はステップ1から再開
  - C. ガシャIDが変わるため、新しいガシャとして扱う

- **Q9:** ステップ途中（例：ステップ3まで実行）でガシャ期間が終了した場合、消費したプリズムはどうなりますか？

### 確定枠の仕様について

- **Q10:** 「〇〇以上からN体確定」の「〇〇」は具体的にどのレアリティを指しますか？（SR以上、SSR以上等）

- **Q11:** 確定枠N体は、同じアイテムが重複して排出される可能性がありますか？

- **Q12:** 確定枠N体と通常枠はどのように組み合わせて排出されますか？
  - A. 10連の場合、最後のN回が確定枠、残りが通常枠
  - B. 10連の内容をランダムに配置し、事後的にN体以上が確定条件を満たすよう調整
  - C. 確定枠N体のみが排出され、通常枠は別途存在しない

- **Q13:** 確定枠の「最大10体」という設定は、実際に使用を想定していますか？10連ガシャで確定10体は実質全て確定になりますが、これは意図した仕様ですか？

### アイテム設定について

- **Q14:** 「アイテムも設定可能」とは、以下のどの意味ですか？
  - A. ガシャを引くコストとしてアイテムを消費できる
  - B. ガシャ実行時にボーナスとしてアイテムが付与される
  - C. ガシャのラインナップにアイテムを追加できる

### コスト設定について

- **Q15:** ステップごとのプリズム個数は、企画側で自由に設定しますか？それともシステムで推奨値を提示しますか？

- **Q16:** 「大幅な割引」の具体的な割引率や金額の目安はありますか？

- **Q17:** 最終ステップのコスト設定方針はどのようになっていますか？（初期ステップより高額？同額？）

### 複数開催について

- **Q18:** 複数のステップアップガシャが同時に開催されることはありますか？

- **Q19:** 同じステップアップガシャが定期的に再開催される場合、ステップ進行状況は引き継がれますか？

### ユーザー体験について

- **Q20:** ステップアップガシャの進行状況は、ガシャ一覧画面やガシャ詳細画面でどのように表示されますか？（プログレスバー、ステップ番号表示等）

## 5. サーバー開発への影響まとめ

### 実装前に必ず詰めるべき論点

1. **ステップ進行管理の設計**
   - 周回・リセット仕様が確定しないと、テーブル設計が完了できない
   - 特にリセット条件（日次、期間終了時）は実装方針に大きく影響

2. **確定枠抽選ロジックの詳細**
   - 「〇〇以上からN体確定」の具体的な抽選アルゴリズム
   - 既存の確定枠ロジックとの統合方法
   - 通常枠との組み合わせ方

3. **ステップとN連の関係**
   - 1ステップ＝何連なのかで、実装する抽選回数が変わる
   - 既存のmulti_draw_countとの関係

4. **周回時の無料ステップの扱い**
   - 収益性への影響が大きいため、仕様確定が必須
   - 不正利用防止策の検討

### 不明点が残る場合のリスク

1. **実装後の大幅な手戻り**
   - 周回仕様が変更された場合、ステップ管理テーブルの再設計が必要
   - リセット条件の変更は、日次バッチの追加/削除を伴う

2. **ユーザー体験の不整合**
   - ステップ進行の挙動がユーザーの期待と異なる可能性
   - 確定枠の排出が意図した動作にならない

3. **収益への影響**
   - 無料ステップの周回可否で収益が大きく変わる
   - コスト設定の妥当性検証ができない

4. **UI実装との齟齬**
   - ステップ進行状況の表示方法がサーバー実装と合わない
   - レスポンスに必要な情報が不足

### スケジュール・品質への影響

**仕様確定が遅れた場合の影響：**
- テーブル設計の遅延（マイグレーション作成不可）
- 抽選ロジック実装の着手遅延
- テストケース設計の遅延（仕様が不明確なためテストできない）

**推奨される対応：**
1. プランナー確認項目（Q1〜Q20）の早期回答取得
2. 確定した仕様から順次実装着手（段階的実装）
3. 不明点が多い場合は、プロトタイプ実装でプランナーと認識合わせ

**実装期間の見積もりへの影響：**
- 仕様確定済み：標準的な実装期間
- 一部不明点あり：実装期間+20〜30%のバッファ必要
- 多数の不明点：実装着手不可、仕様確定を優先

**品質への影響：**
- 仕様が曖昧なまま実装すると、推測による実装が発生
- プランナーの意図と実装が乖離するリスク
- リリース後の不具合・仕様変更要望の増加
