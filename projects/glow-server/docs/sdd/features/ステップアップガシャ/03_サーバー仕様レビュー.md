# サーバー実装観点の仕様レビュー（自動分析レポート）

> **更新履歴**
> - 初版: 仕様書とコード調査に基づく分析
> - 更新: プランナー確認結果を反映（@03_サーバー仕様レビュー_プランナー仕様確認結果.md）
> - 最終更新: ゲーム体験仕様確認結果まとめを反映（@04_ゲーム体験仕様確認結果まとめ.md）
> - 更新: テンプレート方針（プランナー確認項目の判断基準）を反映（2026年1月7日）

> **【重要】プランナー確認項目の判断基準**
> 
> 以下は**サーバーチームで決定可能**なため、プランナー確認項目に含めていません：
> 
> 1. **既存実装パターンで解決できる技術的な選択肢**
>    - 例：リセット処理の実装方法（バッチ処理 vs アクセス時判定）
>    - コード調査で「適用範囲に該当する」と記載されている場合、既存パターンに倣う
> 
> 2. **実装方法の詳細で、ゲーム体験に影響しないもの**
>    - 例：トランザクション処理の方式、ログ出力の形式
> 
> 3. **既存の技術基盤・アーキテクチャに関する判断**
>    - 例：RewardDelegatorの使用、Clock機能の利用
> 
> プランナー確認が**必要**なのは：
> 
> 1. **ゲーム体験に影響する仕様の不明点**
>    - 例：交換上限到達後のUI表示、リソース不足時の表示形式
> 
> 2. **複数の実装方法でユーザー体験が変わる場合の選択**
>    - 例：初回無料機能の有無、売却機能の実装範囲
> 
> 3. **既存実装パターンでは実現不可能な要件**
>    - 例：新しいリソースタイプの追加、既存にない特殊な処理

## 1. 要約

### 仕様の明瞭さ評価

**現在の状況: 仕様確定済み（実装開始可能）**

プランナー確認により、当初不明瞭だった全ての項目が解決されました。

**確定した主要仕様：**
- ステップ実行回数と排出数はステップごとにDB設定可能（柔軟な設計）
- 最大10ステップ完了後は自動的にステップ1に戻る（周回可能）
- 周回回数上限はDB設定可能（無限周回も可）
- 日次リセットは**不要**（ステップ進行状況は日を跨いでも保持）
- ガシャ期間終了時、進行状況はリセット（次回開催時はステップ1から）
- 確定枠は10連の最後のN回が確定枠、残りが通常枠
- レアリティ条件（〇〇以上）と確定数はステップごとにDB設定可能
- 無料ステップが周回時も無料になるかはDB設定で制御可能
- 「アイテムも設定可能」はガシャラインナップへのアイテム追加を意味する
- 複数のステップアップガシャが同時開催される可能性あり

### 大きなリスク・不確定要素

**仕様確定により、以下のリスクは解消されました：**

1. ~~**ステップ進行管理の設計が未確定**~~ → **解決済み**
   - 新規テーブル（usr_gacha_stepup等）で管理することが確定
   - 管理する情報: ユーザーID、ガシャID、現在ステップ番号、周回数、最終実行日時
   - 日次リセット不要のため、実装範囲が縮小

2. ~~**既存ガシャシステムとの統合方法**~~ → **解決済み**
   - GachaType::STEPUP は既に定義済み（そのまま使用可能）
   - 既存のN連ガシャ機能（multi_draw_count）と確定枠ロジックを拡張して使用
   - ステップごとに異なる設定を持つ柔軟な設計が確定

3. ~~**ステップごとの排出仕様の詳細不足**~~ → **解決済み**
   - 確定枠は「10連の最後のN回」として実装
   - レアリティ条件に合致するアイテムから重み付き抽選
   - 既存のfixed_prize_group_id方式を拡張して実装可能

4. ~~**ユーザー体験に関わる仕様の欠落**~~ → **解決済み**
   - ステップ途中で期間終了した場合、消費したプリズムは返却されない
   - ステップ進行状況表示はクライアント側で制御（サーバーは最小限の情報を返却）
   - 複数開催可能（ガシャIDごとに独立管理）

### 残存する実装上の注意点

以下は仕様確定済みですが、実装時に注意が必要な項目です：

1. **マスタデータ設計の複雑性**
   - ステップごとに多様な設定項目（コスト、排出数、確定枠条件、おまけ報酬等）を管理
   - 正規化と柔軟性のバランスが重要
   - 対策: 既存ガシャマスタテーブル設計を参考に段階的に設計

2. **企画側のマスタデータ設定ミス防止**
   - 確定枠数 > 排出数などの不正な設定の可能性
   - 対策: 管理画面側でバリデーション実装（別チケット）

3. **レアリティ範囲指定の抽選ロジック**
   - 「〇〇以上」の範囲指定は既存の抽選ロジックの拡張が必要
   - 対策: 既存のgenerateMaxRarityBoxパターンを参考に実装

4. **コンプガチャ規制への対応**
   - おまけで「A, B, C, Dを集めるとEがもらえる」という仕組みは禁止
   - 各ステップのおまけは独立して付与される設計が必須
   - 対策: マスタデータ設計時にコンプガチャに該当する設定ができない構造にする

**総合評価: 実装開始可能。手戻りリスクは低い。**

## 2. 仕様の詳細化（サーバー観点）

### 2.1 ステップアップガシャの基本構造

**マスタデータ構造（確定仕様に基づく）：**
- ガシャID：ステップアップガシャ全体を識別するID
- ガシャタイプ：「Stepup」（既に定義済み）
- ステップ定義（**ステップごとに異なる設定が可能**）：
  - ステップ番号（1〜10）
  - 必要プリズム種別（無償/有償/Free）
  - 必要プリズム個数（ステップごとに自由に設定可能。例：STEP1は500個、STEP2は無料、STEP3は1500個）
  - **排出回数（ステップごとに異なる回数を設定可能。例：STEP1は5連、STEP2は10連、STEP3は1連）**
  - 確定枠設定（レアリティ条件、確定数。例：STEP3は「SR以上1体確定」、STEP5は「SSR以上2体確定」）
  - ラインナップグループID（ステップごとに共通または異なるラインナップを設定可能）
  - おまけ報酬設定（ステップごとに付与される追加報酬）
- 周回設定：
  - 最大周回数（nullable。NULLの場合は無限周回可能）
  - 周回時の無料ステップ設定（初回のみ無料/毎周回無料をステップごとに制御可能）

**ユーザーデータ構造（確定仕様に基づく）：**
- ユーザーID (usr_user_id)
- ガシャID (mst_gacha_id)
- 現在のステップ番号 (current_step_number)
- 現在の周回数 (loop_count)
- 最終実行日時 (last_executed_at)
- 作成日時 (created_at)
- 更新日時 (updated_at)

### 2.2 ステップ実行の基本フロー（確定仕様）

1. ユーザーがステップNを実行（リクエスト）
2. 現在のステップ番号がNであることを検証（スキップ不可）
3. ステップNのコスト設定を取得（プリズム種別・個数、または無料）
4. コスト消費（プリズム/無料）
5. **ステップNの排出回数に応じて抽選実行**
   - 例：ステップNが5連の場合は5回抽選、10連の場合は10回抽選
   - 通常枠：ラインナップから通常抽選
   - 確定枠：レアリティ条件を満たすアイテムから抽選（10連の最後のN回等）
6. ガシャ報酬配布（キャラクター、アイテム等）
7. おまけ報酬配布（ステップNに設定されたおまけがあれば付与）
8. ステップ番号をインクリメント（N → N+1）
9. 最終ステップ完了時の処理
   - 周回設定を確認
   - 周回上限に達していなければ、周回数をインクリメントしてステップ1に戻る
   - 周回上限に達していれば、完了状態にする（実行不可）

**重要な設計原則：**
- 各ステップは独立した設定を持つ（排出回数、コスト、確定枠、おまけが全てステップごとに異なる可能性）
- 既存のmulti_draw_count機能を活用して、ステップごとの排出回数を実現
- トランザクション内で全ての処理（コスト消費、報酬付与、ステップ進行）を完了

### 2.3 周回機能の詳細（仕様確定が必要）

**周回パターンA：無限周回**
- 最終ステップ完了後、自動的にステップ1に戻る
- 周回回数制限なし

**周回パターンB：回数制限周回**
- 最終ステップ完了後、周回カウントをインクリメント
- 最大周回数に達したら完了状態（実行不可）
- 最大周回数未満ならステップ1に戻る

**周回パターンC：最終ステップ繰り返し**
- ステップ1〜9は1回のみ実行可能
- ステップ10のみ繰り返し実行可能（周回上限あり）

**リセット条件（仕様確定が必要）：**
- 日次リセット：毎日04:00にステップ1に戻る
- 期間リセット：ガシャ終了後、次回開催時にステップ1から
- リセットなし：一度完了したら二度と実行できない

### 2.4 確定枠の抽選ロジック（詳細化が必要）

**「〇〇レアリティ以上からN体確定」の解釈：**

**解釈パターンA：**
- ラインナップから〇〇以上のレアリティのアイテムのみを抽出
- 抽出したアイテムからN体を重み付き抽選
- 通常枠は別途抽選（確定枠と合わせて排出）

**解釈パターンB：**
- 排出アイテム全体の中で、最低N体は〇〇以上のレアリティを保証
- 残りは通常抽選
- N体の保証は排出後の事後チェックで実現

**解釈パターンC：**
- N回の抽選のうち、指定された回数は〇〇以上確定の抽選を行う
- 例：10連の場合、最後のN回は確定枠抽選、残りは通常抽選

### 2.5 おまけ（ステップごとの追加報酬）の仕様

**おまけの定義：**
- ステップアップガシャの各ステップでは、ガシャの排出物とは別に「おまけ」として追加報酬を付与可能
- おまけとして設定可能なアイテム：
  - アイテム
  - コイン
  - 無償プリズム
  - 原画
  - キャラ（キャラアイコン）
  - エンブレム
  - スタミナ回復アイテム
  - ガシャチケット（例：ピックアップガシャチケット）

**付与タイミング：**
- サーバー側：ガシャ実行時（トランザクション内）に即座に付与
- クライアント側：ガシャ結果演出終了後、報酬獲得画面で表示
- 重要：内部的にはガシャを引いた時点でおまけが付与され、ステップも進行している

**実装方式：**
- 既存のRewardDelegatorシステムを使用
- ステップごとにおまけの報酬リストを定義（マスタデータ）
- トランザクション内でガシャ排出物とおまけを同時に付与
- 整合性保証：どちらか一方のみ付与される事態を防ぐ

**コンプガチャ規制への対応：**
- おまけで「A, B, C, Dを集めるとEがもらえる」という仕組みは禁止（コンプガチャ規制）
- ステップごとに独立したおまけ付与のみ実装可能

### 2.6 既存ガシャシステムとの統合方針

**活用できる既存パターン：**
- トランザクション管理（UseCaseTraitのapplyUserTransactionChanges）
- コスト消費管理（CostConsumptionManager + Consumer各種）
- 日次リセット処理（Clock::isFirstToday によるアクセス時判定）
- ガシャ履歴管理（GachaCacheService + LogGachaRepository）
- ミッショントリガー送信（GachaMissionTriggerService）
- 実行回数制限検証（validatePlayCount）
- N連抽選（multi_draw_count）
- **報酬付与システム（RewardDelegator）**

**新規実装が必要な要素：**
- GachaType::STEPUP の追加
- ステップ進行状況管理テーブル
- ステップごとの確定枠設定テーブル
- ステップごとのおまけ報酬設定テーブル
- ステップ進行ロジック（ステップ番号のインクリメント/周回処理）
- レアリティ条件付き確定枠抽選ロジック

## 3. 不明点・曖昧点・判断が必要な項目

> **注記**: 以下の項目は当初の分析時点では不明点でしたが、プランナー確認により**全て解決済み**です。
> 詳細な確認結果は @03_サーバー仕様レビュー_プランナー仕様確認結果.md および @04_ゲーム体験仕様確認結果まとめ.md を参照してください。

### A. 仕様書に記載がなく判断不能だった項目（**全て解決済み**）

#### A-1: ステップ実行の基本単位 ✅ **解決済み**
- **該当箇所:** ゲーム体験仕様書 Page 1
- **当初の不明点:** 
  - 1ステップの実行＝何連のガシャなのかが不明
  - 仕様書には「通常より少ない回数」と記載があるが、具体的な回数が不明
  - 各ステップで排出回数が異なるのか、固定なのか
- **プランナー確認結果（Q1, Q2）:**
  - ステップ毎にDBで設定する
  - 各ステップで排出されるアイテム数もステップごとに設定可能
- **確定した仕様:**
  - 1ステップの実行回数（何連ガシャか）はステップごとにマスタデータで設定可能
  - 1連、10連など任意の回数を設定できる柔軟な設計
- **実装への影響:**
  - マスタテーブルには各ステップの排出回数を保持するカラムが必要
  - 既存のmulti_draw_count機能を活用可能

#### A-2: 周回時のステップリセット挙動 ✅ **解決済み**
- **該当箇所:** ゲーム体験仕様書 Page 1「周回数の設定も可能」
- **当初の不明点:**
  - 最大10ステップを完了した後の挙動が不明
  - ステップ1に戻るのか、ステップ10を繰り返すのか、実行不可になるのか
  - 周回回数のカウント方法（ステップ10完了で1周？全ステップ実行で1周？）
- **プランナー確認結果（Q4, Q5）:**
  - A. 自動的にステップ1に戻り、再度実行可能
  - 周回回数の上限はDBで設定する
- **確定した仕様:**
  - 最大ステップ（10ステップ）完了後は自動的にステップ1に戻る
  - 周回回数の上限はマスタデータで設定可能（NULL可能：無限周回も可）
  - 周回回数上限に達した場合のみ実行不可となる
- **実装への影響:**
  - ユーザーデータには現在の周回数を保持するカラムが必要
  - 最大周回数に達した場合のバリデーション実装が必要

#### A-3: ステップのリセット条件 ✅ **解決済み**
- **該当箇所:** 仕様書に記載なし
- **当初の不明点:**
  - 日次リセットの有無（毎日04:00にステップ1に戻るのか）
  - ガシャ期間終了時、次回開催時のステップ状態
  - ステップ途中でガシャ期間が終了した場合の扱い
- **プランナー確認結果（Q7, Q8, Q9）:**
  - Q7: リセットされない（日次リセットなし）
  - Q8: B. 次回開催時はステップ1から再開
  - Q9: 返却されない（消費したプリズムは戻らない）
- **確定した仕様:**
  - 日次リセット機能は**不要**（ステップ進行状況は日を跨いでも保持される）
  - ガシャ期間が終了した場合、次回開催時はステップ1から再開（進行状況は引き継がれない）
  - ステップ途中で期間終了した場合、消費したプリズムは返却されない（通常のガシャと同じ扱い）
- **実装への影響:**
  - 日次リセット処理の実装は**不要**（実装範囲縮小）
  - ガシャ期間終了時、該当ガシャのユーザーデータをクリーンアップする処理が必要

#### A-4: 「アイテムも設定可能」の意味 ✅ **解決済み**
- **該当箇所:** ゲーム体験仕様書 Page 1「ステップN回目は無料、アイテムも設定可能」
- **当初の不明点:**
  - アイテムがコストとして消費されるのか（既存のCostType::ITEMと同じ）
  - アイテムがボーナス報酬として付与されるのか
  - アイテムがガシャラインナップに追加されるのか
- **プランナー確認結果（Q14）:**
  - C. ガシャのラインナップにアイテムを追加できる
- **確定した仕様:**
  - アイテムはガシャの排出物（ラインナップ）として追加可能
  - キャラクターと同様に、アイテムも抽選対象として設定できる
  - コストとしての消費ではなく、報酬としての排出
- **実装への影響:**
  - 既存のガシャラインナップテーブルで、アイテムIDも格納できる設計が必要
  - アイテム排出時の報酬配布処理は既存のItemRewardと同じロジックを使用可能

#### A-5: 確定枠「〇〇以上からN体」の抽選仕様 ✅ **解決済み**
- **該当箇所:** ゲーム体験仕様書 Page 1「〇〇以上からN体の設定も可能」
- **当初の不明点:**
  - 「〇〇以上」のレアリティ条件の指定方法
  - N体の確定枠と残りの通常枠の排出順序
  - N体が同時に排出されるのか、N回の抽選で順次排出されるのか
  - 確定枠の重複排出（同じアイテムがN体全て同じになる可能性）
- **プランナー確認結果（Q10, Q11, Q12）:**
  - Q10: DBで設定する（レアリティ条件はマスタデータで指定）
  - Q11: はい、可能性がある（同じアイテムが重複して排出される）
  - Q12: A. 10連の場合、最後のN回が確定枠、残りが通常枠
- **確定した仕様:**
  - レアリティ条件（SR以上、SSR以上等）はステップごとにマスタデータで設定可能
  - 確定枠N体は同じアイテムが重複排出される可能性がある（重複排除なし）
  - 排出順序は、10連の場合「最初の(10-N)回が通常枠、最後のN回が確定枠」
  - 確定枠は指定レアリティ以上のアイテムから重み付き抽選で選択
- **実装への影響:**
  - 既存の「10連の最後1回確定」と同じパターンを拡張する形で実装可能
  - 確定枠の抽選は通常枠とは独立した抽選処理として実装
  - レアリティ範囲フィルタリング機能の追加が必要

#### A-6: ステップごとのガシャラインナップ ✅ **解決済み**
- **該当箇所:** ゲーム体験仕様書 Page 1「ガシャラインナップの中のレアリティから選ぶ」
- **当初の不明点:**
  - 全ステップで共通のラインナップを使用するのか
  - ステップごとに異なるラインナップを設定できるのか
  - 確定枠の対象はラインナップ全体なのか、サブセットなのか
- **プランナー確認結果:**
  - A-1の確認結果から、ステップごとに設定可能であることが判明
  - Q10, Q12の確認結果から、ラインナップから条件に合うアイテムを抽選することが判明
- **確定した仕様:**
  - ステップごとにラインナップグループを設定可能（共通でも個別でも可）
  - 確定枠の対象は、設定されたラインナップ全体の中から指定レアリティ条件を満たすアイテム
  - 通常枠は全ラインナップから抽選、確定枠は条件付きラインナップから抽選
- **実装への影響:**
  - マスタデータでステップとラインナップグループIDの紐づけが必要
  - 柔軟性を持たせるため、ステップごとに異なるラインナップを設定できる設計を推奨

#### A-7: 無料ステップの実装範囲 ✅ **解決済み**
- **該当箇所:** ゲーム体験仕様書 Page 1「ステップN回目は無料」
- **当初の不明点:**
  - 無料は初回のみなのか、周回時も無料なのか
  - 無料ステップの実行条件（広告視聴等の前提条件はあるか）
  - 無料ステップも周回数にカウントするのか
- **プランナー確認結果（Q6）:**
  - DBで設定する（周回時に再度無料になるかはマスタデータで制御）
- **確定した仕様:**
  - 無料ステップが周回時も無料になるかはマスタデータで設定可能
  - 「初回のみ無料」「毎周回無料」のいずれも実装可能な柔軟な設計が必要
  - 無料ステップも通常のステップとして周回数にカウントされる
- **実装への影響:**
  - マスタデータに「初回のみ無料フラグ」を持つか、周回ごとのコスト設定を持つか要検討
  - 収益性の観点から、企画側が柔軟に設定できる仕組みが望ましい

#### A-8: 複数のステップアップガシャの同時開催 ✅ **解決済み**
- **該当箇所:** 仕様書に記載なし
- **当初の不明点:**
  - 複数のステップアップガシャが同時に開催される可能性
  - ガシャごとに独立したステップ進行状況を管理するのか
  - 周回数上限はガシャごとに独立しているのか
- **プランナー確認結果（Q18, Q19）:**
  - Q18: あります（複数のステップアップガシャが同時に開催される）
  - Q19: 引き継がれない（再開催時はステップ1から）
- **確定した仕様:**
  - 複数のステップアップガシャが同時に開催される可能性がある
  - 各ガシャは独立したステップ進行状況を持つ（ガシャIDごとに管理）
  - 周回数上限もガシャごとに独立して設定される
  - 同じステップアップガシャが再開催される場合、前回のステップ進行状況は引き継がれない
- **実装への影響:**
  - ユーザーデータテーブルは (usr_user_id, mst_gacha_id) の複合キーで管理
  - ガシャ一覧APIでは複数のステップアップガシャを返却可能な設計が必要

### B. 仕様書とコードの不一致（**全て解決済み**）

#### B-1: GachaType enumの定義状況 ✅ **確認済み**
- **該当ファイル:** 
  - `api/app/Domain/Gacha/Enums/GachaType.php`
  - `api/database/migrations/mst/2024_05_22_045515_create_gacha_table.php`
- **確認結果:**
  - GachaType enumに「STEPUP = 'StepUp'」は**既に定義済み**
  - マイグレーションファイルにも'Stepup'が含まれている
  - enum定義とマイグレーション定義は整合している
- **実装への影響:**
  - GachaType::STEPUP は既に使用可能
  - 既存のガシャ処理でStepup用の処理分岐を追加する必要がある
  - GachaConstants::PERMISSION_GACHA_COST にStepup用の設定を追加する必要がある

#### B-2: ステップ管理テーブルの不在 ✅ **解決済み**
- **該当ファイル:** 
  - `api/app/Domain/Gacha/Models/UsrGacha.php`
  - `api/app/Domain/Gacha/Models/UsrGachaUpper.php`
- **当初の不一致:**
  - 仕様書では「ステップ進行状況の管理」が必要だが、該当するテーブルが存在しない
  - usr_gacha_uppersは天井カウント用であり、ステップ管理には適さない
  - usr_gachasにはステップ番号を保存するカラムがない
- **プランナー確認結果:**
  - A-2, A-3の確認結果から、ステップ番号と周回数の管理が必要であることが確定
- **確定した仕様:**
  - ステップ進行状況を管理する新しいテーブル（usr_gacha_stepup等）を作成する
  - 管理する情報：
    - ユーザーID (usr_user_id)
    - ガシャID (mst_gacha_id)
    - 現在のステップ番号 (current_step_number)
    - 現在の周回数 (loop_count)
    - 最終実行日時 (last_executed_at)
    - 作成日時 (created_at)
    - 更新日時 (updated_at)
- **実装への影響:**
  - 複合主キーは (usr_user_id, mst_gacha_id)
  - ガシャ期間終了時のデータクリーンアップ処理の実装が必要
  - 日次リセットは不要のため、リセット関連のカラムは不要

### C. サーバー側で仕様確定が必要だった項目（**全て解決済み**）

#### C-1: ステップ実行時のレスポンス内容 ✅ **解決済み**
- **当初の不明点:**
  - ステップ実行後のレスポンスに含める情報
  - 次のステップ情報（必要コスト、確定枠条件等）の返却要否
  - 周回数、残りステップ数の返却要否
- **プランナー確認結果（Q20）:**
  - クライアント側対応なのでサーバー側で考慮は不要
- **確定した仕様:**
  - ステップアップガシャの進行状況表示はクライアント側で制御される
  - サーバー側は必要最小限の情報（現在のステップ番号、周回数、抽選結果）を返却
  - 次のステップ情報等の詳細はクライアント側でマスタデータから取得して表示
- **実装への影響:**
  - レスポンスには以下を含める：
    - 抽選結果（獲得したアイテム/キャラクター）
    - 現在のステップ番号
    - 現在の周回数
    - ガシャID

#### C-2: ステップスキップの可否 ✅ **解決済み**
- **当初の不明点:**
  - ステップは必ず順番に実行する必要があるのか
  - 例：ステップ1を飛ばしてステップ2から開始できるか
  - 特定のステップのみを繰り返し実行できるか
- **プランナー確認結果（Q3）:**
  - 必ず順番に実行する必要がある
- **確定した仕様:**
  - ステップは必ず順番に実行する必要がある（スキップ不可）
  - ユーザーは現在のステップ番号のステップのみ実行可能
  - ステップ1→ステップ2→ステップ3...と順次進行する
  - 特定のステップを繰り返し実行することは不可（周回で全ステップ完了後にステップ1に戻るのみ）
- **実装への影響:**
  - サーバー側でステップ番号の整合性チェックが必要（リクエストのステップ番号と保存されている現在ステップの一致確認）
  - ステップスキップを試みた場合はエラーを返却

#### C-3: ステップ中断時の扱い ✅ **解決済み**
- **当初の不明点:**
  - ステップ途中（例：ステップ3まで実行）で期間終了した場合の挙動
  - 次回開催時にステップ3から継続できるのか、ステップ1からやり直しか
  - ステップ進行状況の保存期間
- **プランナー確認結果（Q8, Q9）:**
  - Q8: B. 次回開催時はステップ1から再開
  - Q9: 返却されない（消費したプリズムは戻らない）
- **確定した仕様:**
  - ステップ途中でガシャ期間が終了した場合、進行状況は次回に引き継がれない
  - 次回開催時は新しいガシャID（または同じガシャIDでも新規扱い）でステップ1から開始
  - 消費したプリズムは返却されない（通常のガシャと同じ扱い）
  - ステップ進行状況の保存期間はガシャの開催期間と同じ
- **実装への影響:**
  - ガシャ期間終了時、該当ガシャのステップ進行状況データを削除またはアーカイブ
  - 同じステップアップガシャが再開催される場合でも、ユーザーは新規として扱われる

### D. ゲーム体験的に不自然な可能性があった項目（**全て解決済み**）

#### D-1: 確定枠10体の設定 ✅ **解決済み**
- **当初の懸念:**
  - 仕様書には「確定枠は最大10体まで設定可能」とあるが、10連ガシャで確定10体なら全て確定になる
  - 通常枠との組み合わせが不自然（確定枠10体＋通常枠？）
- **プランナー確認結果（Q13）:**
  - 極端なケースですが、意図した仕様です。それも可能ですよという意味合い
- **確定した仕様:**
  - 確定枠10体（排出全てが確定枠）という設定は意図した仕様として許容される
  - これは企画側が特別なイベントやキャンペーンで使用する可能性がある
  - 「最大10体まで設定可能」は上限値であり、通常は1〜3体程度を想定
  - 10連で確定10体の場合、通常枠は0となり、全ての排出が確定枠として抽選される
- **実装への影響:**
  - システムとしては0〜10体の範囲で設定可能にする
  - 確定枠数が排出数を超える場合のバリデーションは不要（企画側の設定ミスは管理画面側で防止）
  - 極端な設定でも正しく動作することを確認するテストケースを追加

#### D-2: 無料ステップと周回の関係 ✅ **解決済み**
- **当初の懸念:**
  - ステップ1が無料の場合、周回するたびに無料で引けることになる
  - 無料ステップが周回時も適用されると収益性に問題
  - 無料ステップが初回のみの場合、周回時のステップ1のコスト設定が不明
- **プランナー確認結果（Q6）:**
  - DBで設定する（周回時に再度無料になるかはマスタデータで制御）
- **確定した仕様:**
  - 無料ステップが周回時も無料になるかは企画側がマスタデータで設定可能
  - 「初回のみ無料」「毎周回無料」のいずれも実装可能な柔軟な設計
  - 収益性への影響は企画側が判断してマスタデータで制御
  - 周回時のコスト設定も含めて、全てマスタデータで管理される
- **実装への影響:**
  - A-7の確認結果と一致
  - マスタデータ設計時に、周回ごとにコストを変更できる仕組みを検討

#### D-3: 最終ステップの割引の意図 ✅ **解決済み**
- **当初の懸念:**
  - 仕様書には「第1・第2ステップを割引」とあるが、最終ステップの扱いが不明
  - 通常は最終ステップが最も高コスト・高リターンだが、仕様書では言及なし
- **プランナー確認結果（Q15, Q16, Q17）:**
  - Q15: 企画側で自由に設定する
  - Q16: DBで設定する（割引率や金額は企画側が決定）
  - Q17: DBで設定する（最終ステップのコストも企画側が決定）
- **確定した仕様:**
  - 各ステップのコスト設定（プリズム個数）は企画側が完全に自由に設定
  - 「大幅な割引」の具体的な割引率や金額もマスタデータで設定
  - 最終ステップのコスト設定方針（高額・同額・割引等）も企画側が決定
  - システムは推奨値を提示せず、企画側の設定値をそのまま使用
- **実装への影響:**
  - サーバー側ではコストの妥当性検証は不要（企画側の責任範囲）
  - 各ステップのコストはマスタデータで柔軟に設定できる設計を優先
- **該当箇所:** ゲーム体験仕様書 Page 1「ガシャラインナップの中のレアリティから選ぶ」
- **何が曖昧なのか:**
  - 全ステップで共通のラインナップを使用するのか
  - ステップごとに異なるラインナップを設定できるのか
  - 確定枠の対象はラインナップ全体なのか、サブセットなのか
- **サーバーとして明確化が必要な理由:**
  - マスタデータのテーブル設計（ラインナップとステップの関連付け）
  - 抽選処理の複雑度

#### A-7: 無料ステップの実装範囲
- **該当箇所:** ゲーム体験仕様書 Page 1「ステップN回目は無料」
- **何が曖昧なのか:**
  - 無料は初回のみなのか、周回時も無料なのか
  - 無料ステップの実行条件（広告視聴等の前提条件はあるか）
  - 無料ステップも周回数にカウントするのか
- **サーバーとして明確化が必要な理由:**
  - コスト検証ロジックの実装
  - 周回数カウントロジック
  - 無料ステップの悪用防止策

#### A-8: 複数のステップアップガシャの同時開催
- **該当箇所:** 仕様書に記載なし
- **何が曖昧なのか:**
  - 複数のステップアップガシャが同時に開催される可能性
  - ガシャごとに独立したステップ進行状況を管理するのか
  - 周回数上限はガシャごとに独立しているのか
- **サーバーとして明確化が必要な理由:**
  - ユーザーデータのテーブル設計（ガシャIDとステップの関連付け）
  - UI側での表示制御

### B. 仕様書とコードの不一致

#### B-1: GachaType enumの未定義
- **該当ファイル:** 
  - `api/app/Domain/Gacha/Enums/GachaType.php`
  - `api/database/migrations/mst/2024_05_22_045515_create_gacha_table.php`
- **どのように矛盾しているか:**
  - マイグレーションファイルには'Stepup'が含まれているが、GachaType enumには未定義
  - 既存コードでStepupガシャを想定した実装が存在しない
- **影響:**
  - GachaType::STEPUP の追加が必要
  - 既存のガシャタイプ判定ロジックへの影響確認が必要
  - GachaConstants::PERMISSION_GACHA_COST にStepup用の設定追加が必要

#### B-2: ステップ管理テーブルの不在
- **該当ファイル:** 
  - `api/app/Domain/Gacha/Models/UsrGacha.php`
  - `api/app/Domain/Gacha/Models/UsrGachaUpper.php`
- **どのように矛盾しているか:**
  - 仕様書では「ステップ進行状況の管理」が必要だが、該当するテーブルが存在しない
  - usr_gacha_uppersは天井カウント用であり、ステップ管理には適さない
  - usr_gachasにはステップ番号を保存するカラムがない
- **影響:**
  - ステップ進行状況を管理する新しいテーブル（usr_gacha_steps等）の作成が必要
  - または、usr_gachasテーブルにcurrent_step_number, loop_count等のカラム追加が必要

### C. サーバー側で仕様確定が必要な項目

#### C-1: ステップ実行時のレスポンス内容
- **決める必要がある点:**
  - ステップ実行後のレスポンスに含める情報
  - 次のステップ情報（必要コスト、確定枠条件等）の返却要否
  - 周回数、残りステップ数の返却要否
- **プランナーへの確認ポイント:**
  - UI側でどのような情報表示が必要か
  - ステップ進行状況の表示方法（プログレスバー、ステップ一覧等）

#### C-2: ステップスキップの可否
- **決める必要がある点:**
  - ステップは必ず順番に実行する必要があるのか
  - 例：ステップ1を飛ばしてステップ2から開始できるか
  - 特定のステップのみを繰り返し実行できるか
- **プランナーへの確認ポイント:**
  - ユーザーがステップを選択して実行できるUIなのか
  - 現在のステップのみ実行可能なのか

#### C-3: ステップ中断時の扱い
- **決める必要がある点:**
  - ステップ途中（例：ステップ3まで実行）で期間終了した場合の挙動
  - 次回開催時にステップ3から継続できるのか、ステップ1からやり直しか
  - ステップ進行状況の保存期間
- **プランナーへの確認ポイント:**
  - ステップアップガシャは都度開催なのか、常設なのか
  - 同じガシャIDで再開催される場合の進行状況の扱い

### D. ゲーム体験的に不自然な可能性がある項目

#### D-1: 確定枠10体の設定
- **問題点:**
  - 仕様書には「確定枠は最大10体まで設定可能」とあるが、10連ガシャで確定10体なら全て確定になる
  - 通常枠との組み合わせが不自然（確定枠10体＋通常枠？）
- **想定される影響:**
  - 抽選ロジックが意図した動作にならない可能性
  - ユーザーが期待する「確定枠」の概念との乖離

#### D-2: 無料ステップと周回の関係
- **問題点:**
  - ステップ1が無料の場合、周回するたびに無料で引けることになる
  - 無料ステップが周回時も適用されると収益性に問題
  - 無料ステップが初回のみの場合、周回時のステップ1のコスト設定が不明
- **想定される影響:**
  - 収益への影響
  - ユーザーの不正利用（無料周回の繰り返し）

#### D-3: 最終ステップの割引の意図
- **問題点:**
  - 仕様書には「第1・第2ステップを割引」とあるが、最終ステップの扱いが不明
  - 通常は最終ステップが最も高コスト・高リターンだが、仕様書では言及なし
  - 割引設定により、初期ステップのハードルを下げる意図は明確
- **想定される影響:**
  - 収益モデルの設計
  - ユーザーの課金動線

## 4. プランナーへ確認が必要な項目まとめ（**全て回答済み**）

> **注記**: 以下の質問は全てプランナーに確認済みで、回答を得ています。
> 詳細な確認結果は @03_サーバー仕様レビュー_プランナー仕様確認結果.md を参照してください。

### ステップ実行の基本仕様について（**回答済み**）

- **Q1:** 1ステップの実行は何連のガシャに相当しますか？（1連、10連、ステップごとに異なる？）
  - **回答:** ステップ毎にDBで設定します。
  
- **Q2:** 各ステップで排出されるアイテム数は固定ですか、それともステップごとに異なりますか？
  - **回答:** ステップ毎にDBで設定します。

- **Q3:** ステップは必ず順番に実行する必要がありますか、それともユーザーが好きなステップを選択して実行できますか？
  - **回答:** 必ず順番に実行する必要があります。

### 周回機能について（**回答済み**）

- **Q4:** 最大10ステップを完了した後、どのような挙動を想定していますか？
  - **回答:** A. 自動的にステップ1に戻り、再度実行可能

- **Q5:** 周回回数の上限は設定しますか？設定する場合、何周まで可能ですか？
  - **回答:** 上限はDBで設定します。

- **Q6:** 周回時、無料ステップは再度無料になりますか、それとも初回のみ無料ですか？
  - **回答:** DBで設定します。

### リセット条件について（**回答済み**）

- **Q7:** ステップ進行状況は日次でリセットされますか？（毎日04:00にステップ1に戻る）
  - **回答:** リセットされません。

- **Q8:** ガシャ期間が終了した場合、ステップ進行状況はどうなりますか？
  - **回答:** B. 次回開催時はステップ1から再開

- **Q9:** ステップ途中（例：ステップ3まで実行）でガシャ期間が終了した場合、消費したプリズムはどうなりますか？
  - **回答:** 返却されません。

### 確定枠の仕様について（**回答済み**）

- **Q10:** 「〇〇以上からN体確定」の「〇〇」は具体的にどのレアリティを指しますか？（SR以上、SSR以上等）
  - **回答:** DBで設定します。 

- **Q11:** 確定枠N体は、同じアイテムが重複して排出される可能性がありますか？
  - **回答:** はい、可能性があります。

- **Q12:** 確定枠N体と通常枠はどのように組み合わせて排出されますか？
  - **回答:** A. 10連の場合、最後のN回が確定枠、残りが通常枠

- **Q13:** 確定枠の「最大10体」という設定は、実際に使用を想定していますか？10連ガシャで確定10体は実質全て確定になりますが、これは意図した仕様ですか？
  - **回答:** 極端なケースですが、意図した仕様です。それも可能ですよという意味合いです。

### アイテム設定について（**回答済み**）

- **Q14:** 「アイテムも設定可能」とは、以下のどの意味ですか？
  - **回答:** C. ガシャのラインナップにアイテムを追加できる

### コスト設定について（**回答済み**）

- **Q15:** ステップごとのプリズム個数は、企画側で自由に設定しますか？それともシステムで推奨値を提示しますか？
  - **回答:** 企画側で自由に設定します。

- **Q16:** 「大幅な割引」の具体的な割引率や金額の目安はありますか？
  - **回答:** DBで設定します。

- **Q17:** 最終ステップのコスト設定方針はどのようになっていますか？（初期ステップより高額？同額？）
  - **回答:** DBで設定します。

### 複数開催について（**回答済み**）

- **Q18:** 複数のステップアップガシャが同時に開催されることはありますか？
  - **回答:** あります。

- **Q19:** 同じステップアップガシャが定期的に再開催される場合、ステップ進行状況は引き継がれますか？
  - **回答:** 引き継がれません。

### ユーザー体験について（**回答済み**）

- **Q20:** ステップアップガシャの進行状況は、ガシャ一覧画面やガシャ詳細画面でどのように表示されますか？（プログレスバー、ステップ番号表示等）
  - **回答:** クライアント側対応なのでサーバー側で考慮は不要です。

## 5. サーバー開発への影響まとめ

> **更新**: プランナー確認により全ての不明点が解決されたため、実装開始可能な状態となりました。

### 仕様確定により明確になった実装範囲

1. **ステップ進行管理の設計** ✅ **確定**
   - 新規テーブル（usr_gacha_stepup等）で管理
   - 管理項目: ユーザーID、ガシャID、現在ステップ番号、周回数、最終実行日時
   - 日次リセット処理は**不要**（実装範囲縮小）
   - ガシャ期間終了時のデータクリーンアップ処理が必要

2. **確定枠抽選ロジックの詳細** ✅ **確定**
   - 10連の最後のN回が確定枠、残りが通常枠
   - レアリティ条件（〇〇以上）はマスタデータで設定可能
   - 既存のfixed_prize_group_id方式を拡張して実装
   - レアリティ範囲フィルタリング機能の追加が必要

3. **ステップとN連の関係** ✅ **確定**
   - 1ステップの実行回数はステップごとにマスタデータで設定
   - 既存のmulti_draw_count機能を活用可能
   - 1連、5連、10連など任意の回数を設定できる柔軟な設計
   - **具体例：**
     - STEP1: 5連（5回抽選）、コスト500プリズム
     - STEP2: 10連（10回抽選）、コスト無料
     - STEP3: 1連（1回抽選）、コスト1500プリズム
     - STEP4: 10連（10回抽選、最後3回はSSR以上確定）、コスト2000プリズム
   - ステップごとに排出回数が異なることで、ユーザーに多様な体験を提供

4. **周回時の無料ステップの扱い** ✅ **確定**
   - 周回時に無料になるかはマスタデータで制御可能
   - 「初回のみ無料」「毎周回無料」のいずれも実装可能な柔軟な設計
   - 企画側が収益性を考慮して設定

### 実装前に必ず行うべきこと

1. **マスタデータテーブル設計**
   - ステップアップガシャ用のマスタテーブル作成
   - 各ステップの設定（ステップ番号、コスト、排出回数、確定枠設定、ラインナップ、おまけ報酬）
   - 周回設定（最大周回数、周回時の無料ステップ設定）
   - 既存のガシャマスタテーブル設計を参考に段階的に設計

2. **ユーザーデータテーブル設計**
   - ステップ進行状況管理テーブル（usr_gacha_stepup等）
   - 複合主キー: (usr_user_id, mst_gacha_id)
   - 必要カラム: current_step_number, loop_count, last_executed_at

3. **GachaType::STEPUP の活用**
   - GachaType::STEPUP は既に定義済み（そのまま使用可能）
   - 既存のガシャ処理でStepup用の処理分岐を追加する箇所の洗い出し

4. **既存ガシャロジックの拡張方針確認**
   - 既存のN連ガシャ機能（multi_draw_count）との統合
   - 既存の確定枠ロジック（fixed_prize_group_id）の拡張
   - レアリティ範囲指定の抽選ロジック実装
   - 既存のRewardDelegatorを使用したおまけ報酬付与実装

### 解消されたリスク

以下のリスクはプランナー確認により解消されました：

1. ~~**実装後の大幅な手戻り**~~ → **解消**
   - 周回仕様が確定（自動的にステップ1に戻る）
   - リセット条件が確定（日次リセット不要）

2. ~~**ユーザー体験の不整合**~~ → **解消**
   - ステップ進行の挙動が明確化（順番に実行、スキップ不可）
   - 確定枠の排出方法が明確化（最後のN回）

3. ~~**収益への影響**~~ → **解消**
   - 無料ステップの周回時の扱いはマスタデータで制御（企画側が判断）
   - コスト設定は企画側が自由に設定

4. ~~**UI実装との齟齬**~~ → **解消**
   - ステップ進行状況表示はクライアント側で制御
   - サーバーは最小限の情報（現在ステップ、周回数、抽選結果）を返却

### スケジュール・品質への影響

**現在の状況: 仕様確定済み、実装開始可能**

- テーブル設計を開始可能
- 抽選ロジック実装の着手可能
- テストケース設計を開始可能
- **実装期間: 標準的な実装期間で見積もり可能**（バッファ不要）

**品質への影響:**
- 仕様が明確なため、推測による実装は不要
- プランナーの意図と実装の乖離リスクは低い
- リリース後の不具合・仕様変更要望の発生リスクは低い

### 残存する実装上の注意点

以下は仕様確定済みですが、実装時に注意が必要な項目です：

1. **マスタデータ設計の複雑性**
   - ステップごとに多様な設定項目を管理（正規化と柔軟性のバランス）
   - 対策: 既存ガシャマスタテーブル設計を参考に段階的に設計

2. **企画側のマスタデータ設定ミス防止**
   - 確定枠数 > 排出数などの不正な設定の可能性
   - 対策: 管理画面側でバリデーション実装（別チケット）

3. **レアリティ範囲指定の抽選ロジック**
   - 「〇〇以上」の範囲指定は既存の抽選ロジックの拡張が必要
   - 対策: 既存のgenerateMaxRarityBoxパターンを参考に実装

**総合評価: 実装開始可能。手戻りリスクは低い。標準的な実装期間で見積もり可能。**
