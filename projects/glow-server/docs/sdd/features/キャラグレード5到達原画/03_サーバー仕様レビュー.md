# サーバー実装観点の仕様レビュー（自動分析レポート）- キャラグレード5到達原画

## 1. 要約

### 仕様の明瞭さ評価

**明瞭な部分（実装可能）：**
- 基本機能のフロー（グレード5到達時の原画獲得）は明確
- 既存の技術基盤（RewardDelegator、トランザクション管理、ミッション連携）が利用可能
- コード調査により、実装パターンが既存システムに適合することを確認済み

**不明瞭な部分（要確認）：**
- キャラIDと原画IDのマッピング定義方法（どのマスタデータで管理するか）
- 既に原画を獲得済みの場合の挙動（演出表示、コイン変換の有無）
- 既存ユーザーへの原画付与タイミングと演出表示制御
- グレードアップ確認ダイアログでの原画情報表示の実装責任範囲（サーバー/クライアント）

### 大きなリスク・不確定要素

1. **既存ユーザー対応の演出制御**
   - 仕様書に「キャラ詳細画面に遷移した際に演出表示」とあるが、演出表示フラグの管理方法が未定義
   - 一度演出を表示した後、次回アクセス時にも表示するかどうかが不明

2. **重複原画の扱い**
   - 既存システムでは重複原画は自動的にコインに変換されるが、今回の機能でこの挙動が適切かどうか仕様書に記載なし
   - グレード5到達時の原画は「報酬」ではなく「達成報酬」の性質があるため、重複時の扱いを明確化する必要がある

3. **マスタデータ設計の選択肢**
   - 新規テーブル作成 vs 既存テーブル拡張の判断基準が不明
   - 将来的な拡張性（グレード5以外での原画獲得）を考慮すべきかどうか

## 2. 仕様の詳細化（サーバー観点）

### 2.1 基本機能フロー

#### グレードアップ時の原画獲得処理
1. **トリガー条件**
   - ユーザーがキャラのグレードアップAPIを実行（`POST /unit/grade_up`）
   - グレードアップ先が「原画獲得対象グレード」（リリース時はグレード5）である
   - 対象キャラに原画が紐付けられている（マスタデータで定義）
   - 対象キャラのレアリティがUR（リリース時の設定）

2. **実行処理**
   - 既存のグレードアップ処理を実行（アイテム消費、グレードレベル更新、ログ記録）
   - グレードアップ成功後、原画付与処理を実行
     - 原画未獲得の場合：原画と全かけらを付与
     - 原画獲得済みの場合：（要確認）コイン変換 or 何もしない
   - ミッショントリガー送信（グレードアップ、原画完成）
   - レスポンスに原画獲得情報を含める

3. **トランザクション管理**
   - 全ての処理は既存のUseCaseTraitのトランザクション内で実行
   - エラー発生時は全体をロールバック

#### 既存ユーザーへの原画付与

1. **対象ユーザー**
   - 機能リリース時点で、グレード5到達済みのキャラを所持しているユーザー
   - 該当キャラの原画を未獲得

2. **付与タイミング**
   - （推測）キャラ詳細画面へのアクセス時に判定・付与
   - 既存のShop機能などで採用されているアクセス時判定パターンを適用

3. **演出制御**
   - （要確認）初回表示後の演出フラグ管理方法
   - （要確認）複数キャラが対象の場合の演出表示順序・制御

### 2.2 データ管理構造

#### マスタデータ
**キャラと原画のマッピング（新規）**
- テーブル名: （要確定）`mst_unit_artworks` または `mst_unit_grade_ups` への追加
- 必要なカラム:
  - `mst_unit_id`: キャラID
  - `mst_artwork_id`: 原画ID
  - `grade_level`: 原画獲得可能グレード（リリース時は5固定）
  - `release_key`: リリース制御

#### ユーザーデータ
**原画獲得状態**
- テーブル: `usr_artworks`（既存）
- 原画獲得済みの判定: レコードの存在確認

**原画のかけら所持状態**
- テーブル: `usr_artwork_fragments`（既存）
- 原画獲得時に全かけらも同時付与

**演出表示フラグ（要確認）**
- （推測）新規カラムまたは別テーブルでの管理が必要
- 用途: 既存ユーザーへの初回演出表示済みフラグ

### 2.3 API仕様

#### グレードアップAPI（既存）
**エンドポイント:** `POST /unit/grade_up`

**リクエスト:**
```json
{
  "usrUnitId": "string"
}
```

**レスポンス追加項目:**
```json
{
  "usrUnit": { /* 既存 */ },
  "changedUsrItems": { /* 既存 */ },
  "acquiredArtworks": [ /* 新規追加 */
    {
      "mstArtworkId": "string",
      "isFirstAcquisition": true
    }
  ]
}
```

#### キャラ詳細情報API（既存・変更の可能性）
**用途:** 原画獲得可否情報の提供、既存ユーザーへの原画付与判定

**レスポンス追加項目（推測）:**
```json
{
  "unit": { /* 既存 */ },
  "artworkInfo": { /* 新規追加 */
    "mstArtworkId": "string",
    "isAcquired": true,
    "requiredGradeLevel": 5,
    "shouldShowAcquisitionEffect": false
  }
}
```

### 2.4 ミッション連携

#### グレードアップミッション（既存）
- トリガータイプ: `SPECIFIC_UNIT_GRADE_UP_COUNT`
- 既存の仕組みで自動送信

#### 原画完成ミッション（既存の仕組みを利用）
- トリガータイプ: 
  - `ARTWORK_COMPLETED_COUNT`（原画をYつ完成させよう）
  - `SPECIFIC_ARTWORK_COMPLETED_COUNT`（指定原画をYつ完成させよう）
  - `SPECIFIC_SERIES_ARTWORK_COMPLETED_COUNT`（指定作品の原画をYつ完成させよう）
- 実装: `EncyclopediaMissionTriggerService::sendFirstArtworkCompleteTrigger` を使用

### 2.5 ログ管理

#### グレードアップログ（既存）
- テーブル: `log_unit_grade_ups`
- 内容: グレードアップの記録（変更前後のグレードレベル）

#### 原画獲得ログ（既存システムを利用）
- 報酬付与システムのログ機能で自動記録
- アイテム消費ログとの紐付け

## 3. 不明点・曖昧点・判断が必要な項目

### A. 仕様書に記載がなく判断不能な項目

#### A-1: キャラIDと原画IDのマッピング定義方法
- **該当箇所:** 要件1（キャラIDと原画IDのマッピングデータの管理）
- **何が曖昧なのか:**
  - マッピングデータをどのマスタテーブルで管理するか明記されていない
  - 選択肢1: 新規テーブル `mst_unit_artworks` を作成
  - 選択肢2: 既存の `mst_unit_grade_ups` テーブルに `mst_artwork_id` カラムを追加
  - 選択肢3: `mst_units` テーブルに関連カラムを追加
- **サーバーとして明確化が必要な理由:**
  - マスタデータの設計方針により、実装工数と将来的な拡張性が大きく変わる
  - リリース時は「グレード5 + URキャラのみ」だが、将来的に他グレード・他レアリティへの拡張可能性があるかどうかで最適な設計が異なる

#### A-2: 既に原画を獲得済みの場合の挙動
- **該当箇所:** 要件4（グレードアップ時の原画獲得フラグの記録）
- **何が曖昧なのか:**
  - 既に原画を所持しているキャラをグレード5にアップした場合の挙動が未定義
  - 既存システムでは重複原画は自動的にコインに変換されるが、この機能で同様の処理を行うべきかどうか不明
  - 通常の報酬付与と異なり「達成報酬」の性質があるため、重複時は何も付与しない選択肢もある
- **サーバーとして明確化が必要な理由:**
  - 重複判定とコイン変換処理の実装有無に影響
  - ユーザー体験（何度もコインを獲得できる vs 初回のみ）に関わる

#### A-3: 既存ユーザーへの演出表示フラグ管理
- **該当箇所:** 要件5（既存ユーザーのグレード5到達済みキャラへの対応）
- **何が曖昧なのか:**
  - 「キャラ詳細画面に遷移した際に演出表示」とあるが、以下が不明:
    - 一度演出を表示した後、次回アクセス時にも表示するのか
    - 複数キャラが対象の場合、それぞれ個別に演出表示するのか
    - 演出表示済みフラグをどこで管理するのか（キャラごと、ユーザーごと）
- **サーバーとして明確化が必要な理由:**
  - 演出表示フラグのデータ管理構造の設計に影響
  - フラグが不要な場合は実装が簡略化できる

#### A-4: グレードアップ確認ダイアログでの原画情報表示
- **該当箇所:** 要件7（グレードアップ実行前の事前チェック）
- **何が曖昧なのか:**
  - 「グレードアップ確認ダイアログ」で原画獲得情報を表示する際、サーバーがどこまで情報を提供すべきか
  - グレードアップ実行前に原画獲得可否を判定するAPIが必要かどうか
  - または、マスタデータとクライアント側の計算で判定可能かどうか
- **サーバーとして明確化が必要な理由:**
  - 新規APIの追加要否に影響
  - レスポンスデータの設計に影響

#### A-5: 原画獲得時の演出表示タイミング
- **該当箇所:** 要件4（演出トリガー情報の管理）
- **何が曖昧なのか:**
  - 仕様書には「グレードアップ演出画面のタップで閉じるを押した後に表示」とあるが、サーバーが演出表示のタイミング制御に関与するかどうか
  - クライアント側で完結する処理か、サーバーから演出トリガー情報を返す必要があるか
- **サーバーとして明確化が必要な理由:**
  - レスポンスデータに演出トリガー情報を含める必要があるかどうかに影響

### B. 仕様書とコードの不一致

（該当なし）

コード調査により、仕様書の要件は既存のコードベースで実現可能であることを確認済み。不一致や矛盾は検出されませんでした。

### C. サーバー側で仕様確定が必要な項目

#### C-1: マスタデータの設計方針
- **決める必要がある点:**
  - キャラと原画のマッピングをどのテーブルで管理するか
  - 将来的な拡張性（グレード5以外、UR以外への拡張）をどの程度考慮するか
- **プランナーへの確認ポイント:**
  - 将来的に、グレード5以外でも原画を獲得できる仕様を追加する予定はあるか
  - 将来的に、UR以外のレアリティでも原画を獲得できる仕様を追加する予定はあるか

#### C-2: 重複原画の扱い
- **決める必要がある点:**
  - 既に獲得済みの原画に紐づくキャラをグレード5にした場合の挙動
  - コイン変換を行うか、何も付与しないか
- **プランナーへの確認ポイント:**
  - 既に原画を所持しているキャラをグレード5にアップした場合、どのような挙動を期待していますか？
    - A. 既存の報酬システムと同様、重複した原画はコインに変換される
    - B. 原画は初回のみ獲得でき、2回目以降は何も獲得できない
    - C. その他

#### C-3: 既存ユーザーへの演出表示制御
- **決める必要がある点:**
  - 演出を一度表示した後、次回アクセス時の挙動
  - 演出表示済みフラグの管理要否
- **プランナーへの確認ポイント:**
  - 既存ユーザーに対する原画獲得演出は、何度でも表示されますか？それとも初回のみですか？
  - 複数のキャラが対象の場合、キャラ詳細画面を開くたびに演出が表示されますか？

### D. ゲーム体験的に不自然な可能性がある項目

#### D-1: 既存ユーザーへの演出表示タイミング
- **問題点:**
  - 仕様書には「キャラ詳細画面に遷移した際に演出表示」とあるが、以下のケースで不自然な体験になる可能性:
    - ユーザーが複数のグレード5キャラを所持している場合、キャラ詳細画面を開くたびに演出が発生する
    - 機能リリース直後、ユーザーが意図せず演出を見てしまう（準備ができていない状態での表示）
- **想定される影響:**
  - ユーザーが演出をうっとうしく感じる可能性
  - 演出のタイミングをユーザーが制御できないことによる不満
- **推奨される確認事項:**
  - 演出表示のトリガーを「キャラ詳細画面への遷移」以外に変更する余地があるか
  - 例: ホーム画面でのポップアップ通知、専用のお知らせ画面など

#### D-2: URキャラのみの制限による不公平感
- **問題点:**
  - リリース時はURキャラのみが対象のため、URキャラを所持していないユーザーには恩恵がない
  - SSR以下のキャラを愛用しているユーザーにとって不公平感を感じる可能性
- **想定される影響:**
  - ユーザー間の格差拡大
  - ガチャへの課金圧力の増加
- **推奨される確認事項:**
  - 段階的に他レアリティへの拡張を予定しているか
  - 代替的な原画獲得方法を用意する予定はあるか

## 4. プランナーへ確認が必要な項目まとめ（最重要）

### Q1: マスタデータ設計の方針（将来の拡張性）
将来的に、以下の仕様拡張を予定していますか？
- A. グレード5以外（例: グレード7、グレード10など）でも原画を獲得できるようにする
- B. UR以外のレアリティ（SSR、SRなど）でも原画を獲得できるようにする
- C. 両方の拡張を予定している
- D. 当面は拡張予定なし

**この回答により、マスタデータの設計方針（新規テーブル作成 vs 既存テーブル拡張）を決定します。**

### Q2: 重複原画の扱い
既に原画を所持しているキャラをグレード5にアップした場合、どのような挙動を期待していますか？
- A. 既存の報酬システムと同様、重複した原画はコインに自動変換される
- B. 原画は初回のみ獲得でき、2回目以降は何も獲得できない（メッセージ表示なし）
- C. 2回目以降もコインが獲得できることを明示的にユーザーに通知する
- D. その他（具体的に：＿＿＿＿＿＿）

**この回答により、重複判定処理とコイン変換処理の実装要否を決定します。**

### Q3: 既存ユーザーへの原画獲得演出の表示制御
機能リリース時に既にグレード5のキャラを所持しているユーザーに対して、原画獲得演出を表示する際の挙動について：

**Q3-1:** 演出は何度でも表示されますか？それとも初回のみですか？
- A. 該当キャラの詳細画面を開くたびに毎回表示される
- B. 初回のみ表示され、2回目以降は表示されない
- C. その他（具体的に：＿＿＿＿＿＿）

**Q3-2:** 複数のグレード5キャラを所持している場合の演出表示順序は？
- A. それぞれのキャラの詳細画面を開いた際に個別に表示される
- B. 最初にアクセスしたキャラ詳細画面で、全ての対象キャラの演出をまとめて表示する
- C. ホーム画面などで一括表示した後、個別の詳細画面では表示しない
- D. その他（具体的に：＿＿＿＿＿＿）

**この回答により、演出表示フラグの管理構造とAPIレスポンスの設計を決定します。**

### Q4: グレードアップ確認ダイアログでの原画情報表示
グレードアップ確認ダイアログで「『キャラ名』の原画獲得」という文言を表示する際、以下のどちらの実装方針を想定していますか？
- A. サーバーから取得したマスタデータとユーザーの現在グレードを元に、クライアント側で判定・表示する
- B. グレードアップ実行前に、サーバーAPIを呼び出して原画獲得可否を確認してから表示する
- C. その他（具体的に：＿＿＿＿＿＿）

**この回答により、新規API追加の要否を決定します。**

### Q5: 必殺ワザ詳細画面での原画情報表示
「必殺ワザ詳細画面の★（グレード表示）の項目毎に獲得できる効果の箇所に原画獲得できる場合は、『「キャラ名」の原画獲得』の文言を表示する」について：

**Q5-1:** この情報はどのAPIレスポンスで提供すべきですか？
- A. キャラ詳細情報取得APIのレスポンスに含める
- B. マスタデータに含め、クライアント側で表示判定する
- C. 新規のAPI（必殺ワザ詳細取得API）を作成する
- D. その他（具体的に：＿＿＿＿＿＿）

**Q5-2:** 表示条件は以下のどれですか？
- A. そのキャラに原画が設定されていれば常に表示（獲得済みかどうかに関わらず）
- B. 原画未獲得の場合のみ表示
- C. その他（具体的に：＿＿＿＿＿＿）

**この回答により、APIレスポンスの設計とクライアント側の実装責任範囲を決定します。**

### Q6: 既存ユーザーへの原画付与タイミング
機能リリース時に既にグレード5のキャラを所持しているユーザーへの原画付与について：

**Q6-1:** 原画付与のタイミングはいつですか？
- A. 機能リリース時にバッチ処理で一括付与（全ユーザー対象）
- B. キャラ詳細画面へのアクセス時に付与（アクセスしたユーザーのみ）
- C. ホーム画面表示時など、ゲーム起動後の初回アクセス時に一括判定・付与
- D. その他（具体的に：＿＿＿＿＿＿）

**Q6-2:** 付与と演出表示は同時ですか？
- A. 同時（付与と同時に演出を表示）
- B. 別々（付与は自動、演出は特定の画面表示時）

**この回答により、既存ユーザー対応の実装方針を決定します。**

## 5. サーバー開発への影響まとめ

### 実装前に必ず詰めるべき論点

1. **マスタデータ設計（最優先）**
   - キャラと原画のマッピング定義方法
   - 将来の拡張性を考慮したテーブル設計
   - 決定しないと実装に着手できない

2. **重複原画の扱い（高優先度）**
   - コイン変換の有無
   - ユーザー体験に直結する仕様

3. **既存ユーザー対応（高優先度）**
   - 原画付与タイミング
   - 演出表示制御
   - 機能リリース時の初期データ移行方針

4. **APIレスポンス設計（中優先度）**
   - グレードアップ確認時の原画情報提供方法
   - 必殺ワザ詳細画面での情報提供方法
   - クライアントとの責任範囲分担

### 不明点が残る場合のリスク

1. **マスタデータ設計が未確定の場合**
   - リスク: 実装開始不可、手戻りが発生する可能性
   - 影響範囲: マイグレーション、リポジトリ、サービス層
   - 推定工数影響: 中〜大（設計変更時）

2. **重複原画の扱いが未確定の場合**
   - リスク: ユーザー体験が意図したものにならない、クレーム発生の可能性
   - 影響範囲: 報酬付与ロジック、レスポンス生成
   - 推定工数影響: 小〜中

3. **既存ユーザー対応が未確定の場合**
   - リスク: 機能リリース時にユーザー体験が不自然になる、演出が正しく表示されない
   - 影響範囲: 初期データ移行、API実装、演出制御
   - 推定工数影響: 中

4. **APIレスポンス設計が未確定の場合**
   - リスク: クライアント側の実装待ちが発生、手戻りによる再実装
   - 影響範囲: API仕様書、レスポンスファクトリー
   - 推定工数影響: 小〜中

### スケジュール・品質への影響

**前提条件:**
- 上記の不明点が全て解決されることを前提に、サーバー実装は既存の技術基盤を活用して実現可能
- 既存のグレードアップAPI、報酬付与システム、ミッション連携が流用できるため、新規実装範囲は限定的

**推定工数（不明点解決後）:**
- マスタデータ設計・マイグレーション: 0.5〜1日
- サービス層実装（グレードアップ時の原画付与処理）: 1〜2日
- 既存ユーザー対応実装: 0.5〜1日
- APIレスポンス修正: 0.5日
- ユニットテスト・統合テスト: 1〜2日
- **合計: 3.5〜6.5日**

**リスク:**
- Q1〜Q6の回答によっては、追加実装が必要になる可能性あり
- 特に、新規API追加が必要な場合は +1〜2日
- クライアント側との連携確認・調整時間は別途必要

**品質への影響:**
- 既存の技術基盤を活用するため、品質リスクは低い
- ただし、演出表示制御など、クライアント側との連携が複雑になる場合は結合テストの工数増加が想定される

**推奨事項:**
1. Q1〜Q6の質問事項をプランナーに確認し、仕様を確定させる
2. 仕様確定後、詳細設計書を作成してクライアントチームとレビュー
3. APIレスポンス仕様をクライアントチームと合意してから実装開始
4. 既存ユーザー対応のデータ移行計画を事前に策定し、リリース前に十分なテストを実施

## 補足: 技術的に解決済みの事項

以下の項目は、コード調査により既存の技術基盤で実現可能であることが確認されているため、プランナーへの確認は不要です：

1. **報酬付与の実装方式**
   - 既存のRewardDelegatorパターンを使用（要件C-5で確認済み）

2. **トランザクション管理**
   - 既存のUseCaseTraitの仕組みを使用（要件C-8で確認済み）

3. **ミッション連携**
   - 既存のミッショントリガー送信の仕組みを使用（要件C-3、C-12で確認済み）

4. **重複原画のコイン変換処理**
   - 技術的には既存の仕組みで実現可能（要件C-7で確認済み）
   - ただし、この機能で使用するかどうかは仕様確認が必要（Q2参照）

5. **ユーザーデータの変更差分管理**
   - 既存のUsrModelDiffGetServiceで自動対応（要件C-9で確認済み）

6. **ログ記録**
   - 既存の報酬付与システムとグレードアップログの仕組みで対応可能（要件C-4で確認済み）
