# サーバーAPI要件書 - キャラグレード5到達原画

## 1. ドキュメント情報
- **対象機能:** キャラグレード5到達原画
- **作成日:** 2026-01-21
- **参照ドキュメント:**
  - 01_サーバー要件抽出.md
  - 02_サーバー要件_コード調査追記.md
  - 03_サーバー仕様レビュー回答.md
  - 04_ゲーム体験仕様確認結果まとめ.md

## 2. 機能概要

### 2.1 ユーザー体験の概要
この機能は、ユーザーがキャラをグレード5まで強化した際に、そのキャラに紐づく原画を獲得できるようにする機能です。原画獲得時には専用の演出が表示され、ユーザーにキャラ育成の達成感を提供します。

**主な体験フロー:**
1. ユーザーがURキャラをグレード5まで強化する
2. グレードアップ成功時に原画が自動付与される
3. グレードアップ演出の後、原画完成演出が表示される
4. キャラ詳細画面やコレクション画面で獲得した原画を閲覧可能になる

**機能リリース時の既存ユーザー対応:**
- 既にグレード5に到達済みのキャラを所持しているユーザーに対しても原画を獲得可能にする
- 該当キャラの詳細画面にアクセスした際に原画付与と演出表示を行う

### 2.2 サーバーAPIの役割
サーバーAPIは、以下の責務を果たします:

1. **マスタデータ管理:** キャラIDと原画IDのマッピング情報を管理し、クライアントに提供
2. **原画付与処理:** グレードアップ時に条件を満たす場合、原画を付与
3. **既存ユーザー対応:** 機能リリース時に既にグレード5のキャラを所持しているユーザーへの原画付与
4. **演出制御:** 原画獲得演出の表示要否を判定し、クライアントに通知
5. **データ整合性:** グレードアップ、原画付与、ログ記録を一貫したトランザクション内で管理
6. **ミッション連携:** 原画完成時のミッショントリガー送信
7. **重複処理:** 既に獲得済みの原画の重複時のコイン変換処理

## 3. API要件一覧

### 3.1 マスタデータ管理

#### 要件 REQ-MST-1: キャラと原画のマッピング情報管理
- **要件ID:** REQ-MST-1
- **概要:**
  - キャラID、グレードレベル、原画IDの紐付け情報を管理し、クライアントがマスタデータとして参照できるようにする
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「キャラをグレード5まで強化した際に、原画が獲得できるように設定を追加する」（基本仕様）
    - 「リリース時はURキャラのみに設定する」（基本仕様）
    - Q1回答: 将来的にグレード5以外およびUR以外のレアリティでも原画を獲得できるようにする予定
  - APIで実現すべき内容:
    - 新規マスタテーブル `mst_unit_grade_up_rewards` を作成し、以下の情報を管理:
      - `mst_unit_id`: キャラID
      - `mst_artwork_id`: 獲得できる原画ID
      - `grade_level`: 原画獲得可能グレードレベル（リリース時は5、将来的に7、10なども可能）
      - `release_key`: リリース制御用キー
    - UNIQUE KEY: `(mst_unit_id, grade_level)` で同じキャラの同じグレードに複数の原画が設定されないよう制約
    - クライアントはこのマスタデータをダウンロードし、グレードアップ確認ダイアログや必殺ワザ詳細画面での表示判定に使用
  - 条件・制約:
    - リリース時はURキャラのみ設定（レアリティによるフィルタリングはマスタデータ設定で管理）
    - 同一キャラ・同一グレードに複数の原画は設定不可
    - 将来の拡張性を考慮した設計（グレード5以外、UR以外への拡張が容易）
  - データ管理要件:
    - マスタデータとして永続的に管理
    - release_keyによるリリース制御対応
  - 検証・チェック要件:
    - `mst_unit_id` の存在チェック（`mst_units` テーブル参照）
    - `mst_artwork_id` の存在チェック（`mst_artworks` テーブル参照）
    - `grade_level` の妥当性チェック（対象キャラのunit_labelで到達可能なグレードか）
- **既存実装との関連:**
  - `mst_unit_grade_ups` テーブル: グレードアップの基本設定
  - `mst_artworks` テーブル: 原画の基本情報
  - `mst_units` テーブル: キャラの基本情報
- **備考:**
  - `mst_unit_grade_ups` への追加ではなく新規テーブルとすることで、原画設定の有無による既存テーブルの複雑化を回避
  - 将来的な拡張要件が明確なため、適切なデータ設計が可能

### 3.2 グレードアップ時の原画付与

#### 要件 REQ-GRADEUP-1: グレードアップ時の原画付与処理
- **要件ID:** REQ-GRADEUP-1
- **概要:**
  - キャラがグレード5に到達した際、そのキャラに紐づく原画を自動的に付与する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「該当のグレード（リリース時はグレード5）強化時にそのキャラの原画が獲得できる」（演出セクション）
  - APIで実現すべき内容:
    - 既存のグレードアップAPI（`POST /unit/grade_up`）処理内で原画付与を実装
    - グレードアップ成功時、以下の判定を実行:
      1. 到達したグレードレベルが原画獲得対象か（`mst_unit_grade_up_rewards` テーブルを参照）
      2. 該当キャラに原画が設定されているか
    - 判定を満たす場合、RewardDelegatorパターンを使用して原画(ARTWORK)を報酬として付与
    - 原画付与の具体的な流れ:
      - RewardDelegatorに原画報酬を追加
      - ArtworkSendServiceが呼び出される
      - EncyclopediaDelegator::grantArtworksWithFragmentsにより、原画の全フラグメントが付与され、原画が完成
    - 付与後、`usr_unit.last_reward_grade_level = 現在のグレードレベル` に設定
    - `log_unit_grade_up_rewards` テーブルに報酬付与ログを記録
  - 条件・制約:
    - グレードアップが成功していること（アイテム消費、グレードレベル更新が完了）
    - `mst_unit_grade_up_rewards` に該当するマッピング設定が存在すること
    - 既存のグレードアップ処理のトランザクション内で実行
  - データ管理要件:
    - `usr_artworks`: 原画獲得状態を記録
    - `usr_artwork_fragments`: 原画の全フラグメントを記録
    - `usr_unit.last_reward_grade_level`: 最後に報酬を受け取ったグレードレベルを記録
    - `log_unit_grade_up_rewards`: 報酬付与履歴を記録
  - 検証・チェック要件:
    - グレードアップ前提条件のチェック（既存処理）
    - マスタデータの存在チェック
    - トランザクション整合性の確保
- **既存実装との関連:**
  - `UnitGradeUpUseCase::exec`: グレードアップのエントリーポイント
  - `UnitGradeUpService::gradeUp`: グレードアップのビジネスロジック
  - `RewardDelegator`: 報酬付与の統一インターフェース
  - `ArtworkSendService`: 原画付与の実装
  - `EncyclopediaDelegator::grantArtworksWithFragments`: 原画とフラグメントの付与処理
- **備考:**
  - 既存のRewardDelegatorパターンを使用することで、コードの一貫性を保ち、ログ記録やトランザクション管理を統一的に実現

#### 要件 REQ-GRADEUP-2: グレードアップ時の報酬未受け取りフラグ設定
- **要件ID:** REQ-GRADEUP-2
- **概要:**
  - グレードアップ成功時に、報酬未受け取りフラグを設定する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - グレードアップ時に報酬受け取り前の状態を示すフラグが必要（演出表示制御のため）
  - APIで実現すべき内容:
    - グレードアップ成功時、`usr_unit.last_reward_grade_level < grade_level` に設定
    - その後、原画付与処理が実行されたら `true` に設定
    - これにより、グレード5、7、10など各グレードで個別に演出が表示される
  - 条件・制約:
    - グレードアップが成功していること
    - 原画設定の有無に関わらず、全てのグレードアップでフラグを更新
  - データ管理要件:
    - `usr_unit.last_reward_grade_level`: int型(NOT NULL)、default: 0
  - 検証・チェック要件:
    - トランザクション内での更新
- **既存実装との関連:**
  - `UnitGradeUpService::gradeUp`: グレードレベル更新処理
  - `UsrUnitRepository`: ユニット情報の更新
- **備考:**
  - このフラグにより、マルチグレード対応（将来的にグレード5以外でも原画付与）が容易になる

#### 要件 REQ-GRADEUP-3: グレードアップ時の重複原画のコイン変換
- **要件ID:** REQ-GRADEUP-3
- **概要:**
  - 既に獲得済みの原画を報酬として付与する際、自動的にコインに変換する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Q2回答: 既存の報酬システムと同様、重複した原画はコインに自動変換される
  - APIで実現すべき内容:
    - 原画付与時、`usr_artworks` テーブルで既に獲得済みかチェック
    - 既に獲得済みの場合、`ArtworkConvertService::convertDuplicatedArtworkToCoin` を呼び出し
    - 変換レートは `EncyclopediaConstant::DUPLICATE_ARTWORK_CONVERT_COIN` で定義
    - 変換後のコイン情報をレスポンスに含める
  - 条件・制約:
    - 既存の報酬システムと同じ変換ロジックを使用
    - 変換処理も同一トランザクション内で実行
  - データ管理要件:
    - コイン増加をユーザーサマリーに反映
    - 変換ログを記録
  - 検証・チェック要件:
    - 重複判定の正確性
    - 変換レートの妥当性
- **既存実装との関連:**
  - `ArtworkConvertService::convertDuplicatedArtworkToCoin`: 重複原画のコイン変換処理
  - `EncyclopediaConstant::DUPLICATE_ARTWORK_CONVERT_COIN`: 変換レート定義
- **備考:**
  - 既存システムとの一貫性を保つことで、ユーザー体験の統一性が確保される

#### 要件 REQ-GRADEUP-4: グレードアップAPIレスポンスの拡張
- **要件ID:** REQ-GRADEUP-4
- **概要:**
  - グレードアップAPIのレスポンスに原画獲得情報を含める
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「原画完成演出（画面）をグレードアップ演出画面のタップで閉じるを押した後に表示」（演出セクション）
  - APIで実現すべき内容:
    - グレードアップAPIのレスポンスに `acquiredArtworks` フィールドを含める
    - 既存の `UsrModelDiffGetService` により、変更されたユーザーデータ（原画、フラグメント）が自動的にレスポンスに含まれる
    - クライアントはこの情報を元に原画完成演出を表示
  - 条件・制約:
    - 原画を獲得した場合のみレスポンスに含まれる
    - 重複時はコイン情報がレスポンスに含まれる
  - データ管理要件:
    - レスポンスはリクエストごとに動的に生成
  - 検証・チェック要件:
    - レスポンスの形式が既存の報酬付与レスポンスと一貫していること
- **既存実装との関連:**
  - `UsrModelDiffGetService::getChangedUsrItems`: 変更差分の自動収集
  - `UnitResponseFactory::createUnitGradeUpResponse`: レスポンス生成
- **備考:**
  - クライアントは演出のタイミング制御を行う（サーバーは情報提供のみ）

#### 要件 REQ-GRADEUP-5: ミッショントリガーの送信
- **要件ID:** REQ-GRADEUP-5
- **概要:**
  - 原画獲得時に、原画完成系のミッショントリガーを送信する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （ミッション連携に関する明示的な記載はないが、既存実装との整合性が必要）
  - APIで実現すべき内容:
    - 原画付与成功時、`EncyclopediaMissionTriggerService::sendFirstArtworkCompleteTrigger` を呼び出す
    - 以下のミッションタイプが対象:
      - `ArtworkCompletedCountCriterion`: 原画をYつ完成させよう
      - `SpecificArtworkCompletedCountCriterion`: 指定原画XをYつ完成させよう
      - `SpecificSeriesArtworkCompletedCountCriterion`: 指定作品Xの原画をYつ完成させよう
    - トリガーには初完成した原画のIDのみを含める（重複なしでカウント）
  - 条件・制約:
    - 原画が初完成の場合のみトリガー送信（重複時は送信不要）
    - 同一トランザクション内で実行
  - データ管理要件:
    - ミッション進行状況の更新
  - 検証・チェック要件:
    - トリガー送信の正確性
    - ミッション進行の整合性
- **既存実装との関連:**
  - `EncyclopediaMissionTriggerService::sendFirstArtworkCompleteTrigger`: ミッショントリガー送信
  - `UnitMissionTriggerService::sendGradeUpTrigger`: グレードアップミッショントリガー送信（既存）
- **備考:**
  - グレードアップミッションと原画完成ミッションの両方のトリガーが送信される

### 3.3 既存ユーザーへの原画付与

#### 要件 REQ-EXISTING-1: 既存ユーザーへの原画付与判定
- **要件ID:** REQ-EXISTING-1
- **概要:**
  - 機能リリース時に既にグレード5のキャラを所持しているユーザーに対して、原画を付与する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「機能リリース時に既にグレード5に強化完了している場合は、そのキャラのキャラ詳細画面に遷移した際に、原画完成演出（画面）を表示する」（演出セクション）
    - Q6-1回答: キャラ詳細画面へのアクセス時に付与
    - Q6-2回答: 付与と演出表示は同時
  - APIで実現すべき内容:
    - キャラ詳細画面API（例: `GET /unit/{usrUnitId}/detail`）で以下の判定を実行:
      1. 該当ユニットがグレード5以上か
      2. 該当ユニットの `last_reward_grade_level < grade_level` か
      3. 該当ユニットに原画が設定されているか（`mst_unit_grade_up_rewards` を参照）
      4. 該当原画を未獲得か（`usr_artworks` を確認）
    - 上記全てを満たす場合、原画を付与し、`last_reward_grade_level = 現在のグレードレベル` に更新
    - `log_unit_grade_up_rewards` にログを記録
    - レスポンスに演出表示フラグ（`shouldShowArtworkEffect: true`）を含める
  - 条件・制約:
    - キャラ詳細画面へのアクセス時に判定（バッチ処理ではない）
    - 判定と付与は同一トランザクション内で実行
    - アクセスしないユーザーには付与されない（アクセス時判定のため）
  - データ管理要件:
    - `usr_artworks`: 原画獲得状態を記録
    - `usr_artwork_fragments`: 原画の全フラグメントを記録
    - `usr_unit.last_reward_grade_level`: 報酬を受け取ったグレードレベルに更新
    - `log_unit_grade_up_rewards`: 報酬付与履歴を記録
  - 検証・チェック要件:
    - 同一ユーザー・同一キャラで複数回付与されないこと（冪等性）
    - トランザクション整合性の確保
- **既存実装との関連:**
  - キャラ詳細画面API: 既存のエンドポイント
  - `UsrUnitRepository::getById`: ユニット情報取得
  - `UsrArtworkRepository::getByMstArtworkId`: 原画獲得状態確認
  - `EncyclopediaDelegator::grantArtworksWithFragments`: 原画付与処理
- **備考:**
  - アクセス時判定により、サーバー負荷を分散
  - ユーザーが自分のペースで原画獲得を体験できる
  - 既存のShop機能などで採用されているパターンと一貫性がある

#### 要件 REQ-EXISTING-2: 既存ユーザーへの演出表示制御
- **要件ID:** REQ-EXISTING-2
- **概要:**
  - 既存ユーザーへの原画付与時、演出表示要否を判定してクライアントに通知する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Q3-1回答: 初回のみ表示され、2回目以降は表示されない
    - Q3-2回答: それぞれのキャラの詳細画面を開いた際に個別に表示される
  - APIで実現すべき内容:
    - キャラ詳細画面APIのレスポンスに `shouldShowArtworkEffect` フィールドを含める
    - 原画を付与した場合: `shouldShowArtworkEffect: true`
    - 既に付与済み（`last_reward_grade_level = 現在のグレードレベル`）の場合: `shouldShowArtworkEffect: false`
    - クライアントはこのフラグを確認し、trueの場合のみ演出を表示
  - 条件・制約:
    - 演出表示は初回のみ（`last_reward_grade_level` 値で管理）
    - 各キャラごとに個別に管理
  - データ管理要件:
    - `usr_unit.last_reward_grade_level`: 最後に報酬を受け取ったグレードレベルを記録
  - 検証・チェック要件:
    - フラグの正確性
    - クライアント側との連携確認
- **既存実装との関連:**
  - キャラ詳細画面APIのレスポンス生成処理
- **備考:**
  - シンプルなフラグ管理により、複雑な演出表示制御テーブルが不要
  - マルチグレード対応が容易

### 3.4 クライアント連携

#### 要件 REQ-CLIENT-1: グレードアップ確認ダイアログ用の情報提供
- **要件ID:** REQ-CLIENT-1
- **概要:**
  - グレードアップ確認ダイアログで「『キャラ名』の原画獲得」の文言を表示するための情報をマスタデータで提供する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「該当のグレードアップで原画を獲得できる場合は、グレードアップ確認ダイアログの必殺ワザ文言の下に『「キャラ名」の原画獲得』の文言を表示する」（原画獲得に関する表示について）
    - Q4回答: クライアント側があらかじめマスタデータを持っており、ユニットの現在グレード情報と照合して表示判定を行う
  - APIで実現すべき内容:
    - マスタデータ `mst_unit_grade_up_rewards` を配信
    - クライアントはマスタデータをダウンロードして保持
    - グレードアップ確認ダイアログ表示時、クライアント側で以下の判定を行う:
      - 現在のグレード + 1 が原画獲得対象グレードか
      - 該当キャラに原画が設定されているか
      - 上記両方を満たす場合、文言を表示
  - 条件・制約:
    - 新規API不要（マスタデータ配信のみ）
    - クライアント側で判定ロジックを実装
  - データ管理要件:
    - マスタデータの定期的な配信
  - 検証・チェック要件:
    - マスタデータの正確性
    - クライアント側の判定ロジックとの整合性確認
- **既存実装との関連:**
  - マスタデータ配信システム
- **備考:**
  - サーバー側の実装負荷が軽減される
  - マスタデータのダウンロードは既存の仕組みを利用

#### 要件 REQ-CLIENT-2: 必殺ワザ詳細画面用の情報提供
- **要件ID:** REQ-CLIENT-2
- **概要:**
  - 必殺ワザ詳細画面で「『キャラ名』の原画獲得」の文言を表示するための情報をマスタデータで提供する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「必殺ワザ詳細画面の★（グレード表示）の項目毎に獲得できる効果の箇所に原画獲得できる場合は、『「キャラ名」の原画獲得』の文言を表示する」（原画獲得に関する表示について）
    - Q5-1回答: マスタデータに含め、クライアント側で表示判定する
    - Q5-2回答: そのキャラに原画が設定されていれば常に表示（獲得済みかどうかに関わらず）
  - APIで実現すべき内容:
    - マスタデータ `mst_unit_grade_up_rewards` を配信
    - クライアント側でマスタデータを参照し、該当グレードに原画設定があるかチェック
    - 設定がある場合、「『キャラ名』の原画獲得」を表示
  - 条件・制約:
    - 新規API不要（マスタデータ配信のみ）
    - 獲得済みかどうかに関わらず表示
  - データ管理要件:
    - マスタデータの定期的な配信
  - 検証・チェック要件:
    - マスタデータの正確性
- **既存実装との関連:**
  - マスタデータ配信システム
- **備考:**
  - サーバー側は新規API不要
  - マスタデータのみで対応可能

### 3.5 ログ管理

#### 要件 REQ-LOG-1: グレードアップ報酬付与ログの記録
- **要件ID:** REQ-LOG-1
- **概要:**
  - グレードアップ時の原画付与履歴を記録する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （ログ管理に関する明示的な記載はないが、監査・トラブルシューティングのために必要）
  - APIで実現すべき内容:
    - 新規ログテーブル `log_unit_grade_up_rewards` を作成:
      - `id`: プライマリキー
      - `usr_user_id`: ユーザーID
      - `mst_unit_id`: キャラID
      - `mst_unit_grade_up_reward_id`: 付与した報酬のマスタID（`mst_unit_grade_up_rewards.id`）
      - `created_at`: 付与日時
    - グレードアップ時の原画付与および既存ユーザーへの原画付与時に記録
  - 条件・制約:
    - 原画付与成功時のみ記録
    - 同一トランザクション内で記録
  - データ管理要件:
    - 永続的に保持（削除なし）
    - 監査証跡として使用
  - 検証・チェック要件:
    - ログの完全性
    - タイムスタンプの正確性
- **既存実装との関連:**
  - `LogUnitGradeUpRepository::create`: グレードアップログ記録（既存）
  - ログ記録の統一的なパターン
- **備考:**
  - グレードアップログ（`log_unit_grade_ups`）とは別テーブルで管理
  - 正規化されたログ構造（`mst_unit_grade_up_reward_id` を参照）

## 4. 要件間の依存関係

### 4.1 前提となる要件
- **REQ-MST-1（マスタデータ管理）** は全ての他の要件の前提となる
  - マスタデータが存在しないと、原画付与判定ができない
- **REQ-GRADEUP-2（フラグ設定）** は **REQ-GRADEUP-1（原画付与）** の前提となる
  - フラグが正しく設定されないと、演出制御が機能しない
- **REQ-EXISTING-1（既存ユーザー判定）** は **REQ-MST-1** を前提とする
  - マスタデータで原画設定を確認する必要がある

### 4.2 同時に実現すべき要件
- **REQ-GRADEUP-1** と **REQ-GRADEUP-2** は同一トランザクション内で実現される必要がある
  - 原画付与とフラグ設定の整合性を保証
- **REQ-GRADEUP-1** と **REQ-GRADEUP-5** は同時に実行される必要がある
  - 原画付与とミッショントリガー送信の整合性を保証
- **REQ-GRADEUP-1** と **REQ-LOG-1** は同時に実行される必要がある
  - 原画付与とログ記録の整合性を保証

### 4.3 順序依存の要件
- **REQ-GRADEUP-2（フラグ設定 false）** → **REQ-GRADEUP-1（原画付与）** → **REQ-GRADEUP-2（フラグ設定 true）**
  - グレードアップ成功時にフラグをfalseに設定
  - 原画付与処理を実行
  - 付与成功後にフラグをtrueに設定

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **グレードアップAPIのレスポンスタイム:**
  - 原画付与処理を追加しても、既存のグレードアップAPIのレスポンスタイムを大幅に増加させない
  - 目標: 既存処理 + 50ms以内
- **キャラ詳細画面APIのレスポンスタイム:**
  - 既存ユーザーへの原画付与判定を追加しても、レスポンスタイムを大幅に増加させない
  - 目標: 既存処理 + 50ms以内
- **同時接続数:**
  - 機能リリース直後のアクセス集中に対応
  - アクセス時判定により負荷を分散

### 5.2 セキュリティ要件
- **不正なグレードアップの防止:**
  - 既存のグレードアップバリデーションを継続
  - マスタデータの存在チェックによる不正防止
- **重複付与の防止:**
  - `usr_unit.last_reward_grade_level` フラグによる冪等性保証
  - トランザクション管理による一貫性保証
- **データ改ざん防止:**
  - ログ記録による監査証跡
  - UNIQUE制約による整合性保証

### 5.3 可用性要件
- **トランザクション整合性:**
  - グレードアップ、原画付与、ログ記録を同一トランザクション内で実行
  - エラー発生時の自動ロールバック
- **エラーハンドリング:**
  - マスタデータ不整合時の適切なエラーメッセージ
  - 原画付与失敗時のロールバック処理
  - クライアントへの明確なエラー通知

### 5.4 その他の非機能要件
- **ログ記録:**
  - 原画付与履歴の完全な記録
  - トラブルシューティング用のログ出力
- **監視:**
  - 原画付与成功率の監視
  - エラー発生率の監視
  - レスポンスタイムの監視
- **運用:**
  - マスタデータの更新・検証手順
  - リリース後の動作確認項目

## 6. データ要件

### 6.1 永続化が必要なデータ

#### マスタデータ
- **mst_unit_grade_up_rewards:**
  - 内容: キャラID、グレードレベル、原画IDのマッピング
  - 用途: 原画付与判定、クライアント表示判定
  - 保持期間: 永久
  - 関連要件: REQ-MST-1

#### ユーザーデータ
- **usr_artworks:**
  - 内容: ユーザーが獲得した原画
  - 用途: 原画獲得状態の管理、重複判定
  - 保持期間: 永久
  - 関連要件: REQ-GRADEUP-1, REQ-EXISTING-1

- **usr_artwork_fragments:**
  - 内容: ユーザーが獲得した原画のフラグメント
  - 用途: 原画完成状態の管理
  - 保持期間: 永久
  - 関連要件: REQ-GRADEUP-1, REQ-EXISTING-1

- **usr_unit.last_reward_grade_level:**
  - 内容: グレードアップ報酬の受け取り済みフラグ
  - 用途: 演出表示制御、重複付与防止
  - 保持期間: 永久
  - 関連要件: REQ-GRADEUP-2, REQ-EXISTING-2

#### ログデータ
- **log_unit_grade_up_rewards:**
  - 内容: グレードアップ報酬の付与履歴
  - 用途: 監査証跡、トラブルシューティング
  - 保持期間: 永久（削除なし）
  - 関連要件: REQ-LOG-1

### 6.2 一時的に管理が必要なデータ
- **RewardManager内の報酬キュー:**
  - 内容: 付与予定の報酬リスト
  - 用途: トランザクション内での報酬管理
  - 保持期間: リクエスト処理中のみ
  - 関連要件: REQ-GRADEUP-1

- **UsrModelDiff内の変更差分:**
  - 内容: APIリクエスト処理中に変更されたユーザーデータ
  - 用途: レスポンス生成
  - 保持期間: リクエスト処理中のみ
  - 関連要件: REQ-GRADEUP-4

## 7. 外部システム連携要件

### 7.1 クライアント連携
- **マスタデータ配信:**
  - 内容: `mst_unit_grade_up_rewards` をクライアントに配信
  - タイミング: ゲーム起動時、マスタデータ更新時
  - 関連要件: REQ-CLIENT-1, REQ-CLIENT-2

- **グレードアップAPIレスポンス:**
  - 内容: 原画獲得情報、変更されたユーザーデータ
  - タイミング: グレードアップリクエスト時
  - 関連要件: REQ-GRADEUP-4

- **キャラ詳細画面APIレスポンス:**
  - 内容: 演出表示フラグ、原画獲得情報
  - タイミング: キャラ詳細画面表示時
  - 関連要件: REQ-EXISTING-2

### 7.2 他API機能との連携
- **ミッションシステム:**
  - 内容: 原画完成ミッショントリガー送信
  - タイミング: 原画付与成功時
  - 関連要件: REQ-GRADEUP-5

- **グレードアップシステム:**
  - 内容: 既存のグレードアップ処理との統合
  - タイミング: グレードアップリクエスト時
  - 関連要件: REQ-GRADEUP-1, REQ-GRADEUP-2

- **報酬システム:**
  - 内容: RewardDelegatorを介した報酬付与
  - タイミング: 原画付与時
  - 関連要件: REQ-GRADEUP-1, REQ-EXISTING-1

### 7.3 外部サービス連携
- 該当なし（この機能では外部サービス連携は不要）

## 8. 残存する不明点・要確認事項

### 8.1 まだ不明な仕様
**該当なし**

全ての不明点が04_ゲーム体験仕様確認結果まとめ.mdで解決され、API実装に必要な仕様が確定しています。

### 8.2 実装時に判断が必要な事項

#### 項目 1: マスタデータのリリース管理方式
- **何が不明か:**
  - `release_key` をどのように運用するか（値の形式、制御ロジック）
- **実装への影響:**
  - リリース制御の実装方式に影響
- **確認すべき相手:**
  - プロジェクト全体のリリース管理方針と整合させる必要がある

#### 項目 2: エラーメッセージの詳細度
- **何が不明か:**
  - マスタデータ不整合などのエラー時、クライアントにどこまで詳細な情報を返すか
- **実装への影響:**
  - エラーハンドリングの実装方針に影響
- **確認すべき相手:**
  - プロジェクト全体のエラーハンドリング方針と整合させる必要がある

#### 項目 3: ログレベルとログ出力内容
- **何が不明か:**
  - デバッグ用のログをどこまで出力するか
- **実装への影響:**
  - ログ実装の詳細度に影響
- **確認すべき相手:**
  - 運用チームと調整

## 9. 要件確定度の評価

### 9.1 全体評価
- **要件の確定度:** 100%
- **API実装に必要な要件情報の充足度:** 十分
- **実装開始の可否:** 可

**評価根拠:**
- 04_ゲーム体験仕様確認結果まとめ.mdで全ての不明点が解決
- マスタデータ設計、原画付与ロジック、演出制御、既存ユーザー対応の全てが確定
- 既存実装との統合方針が明確
- 実装に必要な全ての情報が揃っている

### 9.2 カテゴリ別評価

#### マスタデータ管理（REQ-MST-1）
- **確定度:** 100%
- **課題:** なし
- **実装準備状況:** テーブル定義、UNIQUE制約、カラム構成が全て確定。実装可能。

#### グレードアップ時の原画付与（REQ-GRADEUP-1〜5）
- **確定度:** 100%
- **課題:** なし
- **実装準備状況:** 既存のRewardDelegatorパターンを使用する方針が確定。トランザクション管理、ミッション連携、重複処理の全てが明確。実装可能。

#### 既存ユーザーへの原画付与（REQ-EXISTING-1〜2）
- **確定度:** 100%
- **課題:** なし
- **実装準備状況:** アクセス時判定パターンが確定。演出表示制御の実装方針が明確。実装可能。

#### クライアント連携（REQ-CLIENT-1〜2）
- **確定度:** 100%
- **課題:** なし
- **実装準備状況:** マスタデータ配信のみで対応可能。新規API不要。実装可能。

#### ログ管理（REQ-LOG-1）
- **確定度:** 100%
- **課題:** なし
- **実装準備状況:** テーブル定義、ログ記録タイミングが確定。実装可能。

## 10. 次のステップ

### 10.1 要件確定のために必要なアクション
- [x] 全ての不明点が解決済み
- [x] ゲーム体験仕様の確認完了
- [x] サーバーAPI要件書の作成完了

### 10.2 実装設計へ向けて

#### 優先度: 高（即座に着手可能）
- [ ] **データベース設計**
  - `mst_unit_grade_up_rewards` テーブルのDDL作成
  - `log_unit_grade_up_rewards` テーブルのDDL作成
  - `usr_unit` テーブルへの `last_reward_grade_level` カラム追加のマイグレーション作成

- [ ] **APIエンドポイント設計**
  - グレードアップAPI（既存）への機能追加設計
  - キャラ詳細画面API（既存）への機能追加設計
  - レスポンス形式の詳細設計

- [ ] **サービス層設計**
  - `UnitGradeUpService` への原画付与ロジック追加設計
  - キャラ詳細画面サービスへの既存ユーザー対応ロジック追加設計
  - RewardDelegatorとの連携詳細設計

#### 優先度: 中（設計と並行可能）
- [ ] **テストケース設計**
  - 正常系テストケース
  - 異常系テストケース（マスタデータ不整合、重複付与など）
  - 境界値テストケース

- [ ] **クライアントチームとの仕様レビュー**
  - マスタデータの参照方法の確認
  - 演出表示タイミングの詳細確認
  - エラーハンドリングの確認

#### 優先度: 低（実装フェーズで対応）
- [ ] **監視・運用設計**
  - 原画付与成功率の監視方法
  - エラー発生時のアラート設計
  - リリース後の動作確認項目リスト

- [ ] **マスタデータ投入計画**
  - URキャラと原画のマッピングデータ作成
  - release_keyの設定方針確認
  - データ検証手順の策定

### 10.3 推定工数（再掲）
- マスタデータ設計・マイグレーション: 0.5〜1日
- サービス層実装（グレードアップ時の処理拡張）: 0.5〜1日
- サービス層実装（原画付与処理）: 1〜1.5日
- キャラ詳細画面API拡張（既存ユーザー対応）: 1〜1.5日
- APIレスポンス修正: 0.5日
- ユニットテスト・統合テスト: 1〜2日
- **合計: 4.5〜7.5日**

## 11. まとめ

本API要件書は、これまでの4つのドキュメント（サーバー要件抽出、コード調査追記、サーバー仕様レビュー回答、ゲーム体験仕様確認結果まとめ）を統合し、サーバーAPIで実現すべき要件を完全な形でまとめたものです。

**主な成果:**
1. 全ての不明点が解決され、実装に必要な仕様が100%確定
2. 既存実装との統合方針が明確（RewardDelegatorパターン、トランザクション管理など）
3. マスタデータ設計、原画付与ロジック、演出制御、既存ユーザー対応の全てが確定
4. クライアント連携方針が明確（マスタデータ配信、レスポンス形式）
5. データ要件、非機能要件、ログ管理、依存関係が明確

**実装準備状況:**
- 詳細設計に進むための全ての情報が揃っている
- 既存の技術基盤（RewardDelegator、トランザクション管理、ミッション連携）を活用できることが確認済み
- 推定工数: 4.5〜7.5日

**次のステップ:**
データベース設計、APIエンドポイント設計、サービス層設計に着手可能です。
