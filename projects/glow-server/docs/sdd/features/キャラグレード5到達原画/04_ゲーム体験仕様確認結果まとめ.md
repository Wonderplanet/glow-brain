# ゲーム体験仕様確認結果まとめ - キャラグレード5到達原画

## 1. 確認実施概要
- 確認日時: 2026年1月21日
- 確認方法: ドキュメント（03_サーバー仕様レビュー回答.md）
- 確認者: ゲーム企画担当者

## 2. 確認結果サマリー
- 確認項目総数: 11 項目（Q1〜Q6 + サブ質問）
- 完全に解決: 11 項目
- 部分的に解決: 0 項目
- 未解決: 0 項目

**総合評価: サーバー実装に必要な仕様が全て確定しました。実装に進むことが可能です。**

## 3. 各不明点の確認結果

### 3.1 仕様書に記載がなく判断不能だった項目

#### 項目 A-1: キャラIDと原画IDのマッピング定義方法
- **元の不明点:**
  - マッピングデータをどのマスタテーブルで管理するか明記されていない
  - 選択肢1: 新規テーブル `mst_unit_grade_up_rewards` を作成
  - 選択肢2: 既存の `mst_unit_grade_ups` テーブルに `mst_artwork_id` カラムを追加
  - 選択肢3: `mst_units` テーブルに関連カラムを追加
  - リリース時は「グレード5 + URキャラのみ」だが、将来的に他グレード・他レアリティへの拡張可能性があるかどうかで最適な設計が異なる
  
- **ゲーム体験仕様確認結果:**
  - Q1への回答: C（両方の拡張を予定している）
  - 将来的にグレード5以外（例: グレード7、グレード10など）でも原画を獲得できるようにする
  - 将来的にUR以外のレアリティ（SSR、SRなど）でも原画を獲得できるようにする
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 将来の拡張性を考慮し、**新規テーブル `mst_unit_grade_up_rewards` を作成する**
  - テーブル構成:
    - `id`: プライマリキー
    - `mst_unit_id`: キャラID
    - `mst_artwork_id`: 原画ID（この原画IDに紐づく全フラグメントが付与され、原画が完成する）
    - `grade_level`: 原画獲得可能グレード（リリース時は5、将来的に7、10などを追加可能）
    - `release_key`: リリース制御用キー
  - UNIQUE KEY: `(mst_unit_id, grade_level)` で同じキャラの同じグレードに複数の原画が設定されないよう制約
  - この設計により、将来的に以下の拡張が容易に実現可能:
    - 同じキャラの異なるグレードで異なる原画を設定
    - どのレアリティのキャラでも原画を設定可能
    
- **備考:**
  - `mst_unit_grade_ups` への追加ではなく新規テーブルとすることで、原画設定の有無による `mst_unit_grade_ups` の複雑化を回避
  - 将来的な拡張要件が明確になったことで、適切なデータ設計が可能になった

#### 項目 A-2: 既に原画を獲得済みの場合の挙動
- **元の不明点:**
  - 既に原画を所持しているキャラをグレード5にアップした場合の挙動が未定義
  - 既存システムでは重複原画は自動的にコインに変換されるが、この機能で同様の処理を行うべきかどうか不明
  - 通常の報酬付与と異なり「達成報酬」の性質があるため、重複時は何も付与しない選択肢もある
  
- **ゲーム体験仕様確認結果:**
  - Q2への回答: A（既存の報酬システムと同様、重複した原画はコインに自動変換される）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 既に原画を獲得済みのキャラをグレード5にアップした場合、**重複した原画は自動的にコインに変換される**
  - 変換処理は既存の `ArtworkConvertService::convertDuplicatedArtworkToCoin` を使用
  - 変換レートは `EncyclopediaConstant::DUPLICATE_ARTWORK_CONVERT_COIN` で定義
  - ユーザーへの通知は既存の報酬付与システムのレスポンスに含まれる
  - 実装上の対応:
    - グレードアップ時、報酬として原画(ARTWORK)を付与
    - 報酬システムは `ArtworkSendService::send` → `EncyclopediaDelegator::grantArtworksWithFragments` を呼び出し、原画に紐づく全フラグメントを付与して原画を完成させる
    - 既に原画を所持している場合は、`ArtworkConvertService::convertDuplicatedArtworkToCoin` が自動的に呼び出され、コインに変換される
    - 変換後のコイン情報をレスポンスに含める
    
- **備考:**
  - 既存システムとの一貫性を保つことで、ユーザー体験の統一性が確保される
  - コイン変換により、重複時もユーザーに何らかの報酬が与えられる

#### 項目 A-3: 既存ユーザーへの演出表示フラグ管理
- **元の不明点:**
  - 「キャラ詳細画面に遷移した際に演出表示」とあるが、以下が不明:
    - 一度演出を表示した後、次回アクセス時にも表示するのか
    - 複数キャラが対象の場合、それぞれ個別に演出表示するのか
    - 演出表示済みフラグをどこで管理するのか（キャラごと、ユーザーごと）
  
- **ゲーム体験仕様確認結果:**
  - Q3-1への回答: B（初回のみ表示され、2回目以降は表示されない）
  - Q3-2への回答: A（それぞれのキャラの詳細画面を開いた際に個別に表示される）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 演出表示制御の仕様:
    - 各キャラごとに演出表示済みフラグを管理
    - キャラ詳細画面に遷移した際、該当キャラの原画が「未獲得→獲得済み」かつ「演出未表示」の場合に演出を表示
    - 一度演出を表示したら、そのキャラについては2回目以降は演出を表示しない
    - 複数のグレード5キャラを所持している場合、各キャラの詳細画面で個別に演出が表示される
  - 実装上の対応:
    - `usr_unit` テーブルに `last_reward_grade_level` カラムを追加（int(NOT NULL), default: 0）
      - グレードアップ時に達成したグレードレベルを記録
      - 原画を受け取った後、そのグレードレベルを設定
    - 新規ログテーブル `log_unit_grade_up_rewards` を作成:
      - `id`: プライマリキー
      - `usr_user_id`: ユーザーID
      - `mst_unit_id`: キャラID
      - `mst_unit_grade_up_reward_id`: 付与した報酬のマスタID
      - `created_at`: 付与日時
    - キャラ詳細画面のAPIレスポンスに演出表示要否を含める:
      - `shouldShowArtworkEffect`: true/false
    
- **備考:**
  - `last_reward_grade_level` で最後に報酬を受け取ったグレードレベルを管理
  - グレード5、7、10など各グレードで個別に演出が表示される（`last_reward_grade_level < grade_level` で判定）
  - ログテーブルで履歴管理が可能

#### 項目 A-4: グレードアップ確認ダイアログでの原画情報表示
- **元の不明点:**
  - 「グレードアップ確認ダイアログ」で原画獲得情報を表示する際、サーバーがどこまで情報を提供すべきか
  - グレードアップ実行前に原画獲得可否を判定するAPIが必要かどうか
  - または、マスタデータとクライアント側の計算で判定可能かどうか
  
- **ゲーム体験仕様確認結果:**
  - Q4への回答: C（その他）
  - 具体的には、クライアント側があらかじめマスタデータを持っており、ユニットの現在グレード情報と照合して表示判定を行う形を考えている
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 原画情報表示は**クライアント側で判定・表示する**
  - サーバー側は新規APIを追加する必要はなし
  - 実装上の対応:
    - マスタデータ `mst_unit_grade_up_rewards` にキャラと原画のマッピング情報を含める
    - クライアントはマスタデータをダウンロードして保持
    - グレードアップ確認ダイアログ表示時、クライアント側で以下の判定を行う:
      - 現在のグレード + 1 が原画獲得対象グレードか（例: グレード4 → グレード5）
      - 該当キャラに原画が設定されているか（`mst_unit_grade_up_rewards` を参照）
      - 上記両方を満たす場合、「『キャラ名』の原画獲得」の文言を表示
    
- **備考:**
  - サーバー側の実装負荷が軽減される
  - マスタデータのダウンロードは既存の仕組みを利用

#### 項目 A-5: 原画獲得時の演出表示タイミング
- **元の不明点:**
  - 仕様書には「グレードアップ演出画面のタップで閉じるを押した後に表示」とあるが、サーバーが演出表示のタイミング制御に関与するかどうか
  - クライアント側で完結する処理か、サーバーから演出トリガー情報を返す必要があるか
  
- **ゲーム体験仕様確認結果:**
  - 仕様書の記載から、クライアント側で演出のタイミング制御を行うと解釈できる
  - グレードアップAPIのレスポンスに原画獲得情報が含まれていれば、クライアント側で演出制御可能
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 演出表示のタイミング制御は**クライアント側で実装**
  - サーバー側の役割:
    - グレードアップAPIのレスポンスに原画獲得情報を含める
    - 具体的には、`acquiredArtworks` フィールドに新規獲得した原画情報を含める
  - クライアント側の役割:
    - グレードアップAPIのレスポンスを受け取る
    - グレードアップ演出を表示
    - ユーザーが「閉じる」をタップした後、原画獲得情報があれば原画完成演出を表示
    
- **備考:**
  - サーバーは演出のタイミング制御には関与せず、データ提供のみを行う
  - 演出の順序制御はクライアント側の責務

### 3.2 仕様書とコードの不一致

（該当項目なし）

### 3.3 サーバー側で仕様確定が必要だった項目

#### 項目 C-1: マスタデータの設計方針
- **元の不明点:**
  - キャラと原画のマッピングをどのテーブルで管理するか
  - 将来的な拡張性（グレード5以外、UR以外への拡張）をどの程度考慮するか
  
- **ゲーム体験仕様確認結果:**
  - Q1への回答: C（両方の拡張を予定している）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 項目 A-1 で詳述済み
  - 新規テーブル `mst_unit_grade_up_rewards` を作成し、将来の拡張性を確保
  
- **備考:**
  - 将来の拡張要件が明確になったことで、適切なデータ設計が可能

#### 項目 C-2: 重複原画の扱い
- **元の不明点:**
  - 既に獲得済みの原画に紐づくキャラをグレード5にした場合の挙動
  - コイン変換を行うか、何も付与しないか
  
- **ゲーム体験仕様確認結果:**
  - Q2への回答: A（既存の報酬システムと同様、重複した原画はコインに自動変換される）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 項目 A-2 で詳述済み
  - 既存の `ArtworkConvertService` を使用してコイン変換を実装
  
- **備考:**
  - 既存システムとの一貫性を保つ

#### 項目 C-3: 既存ユーザーへの演出表示制御
- **元の不明点:**
  - 演出を一度表示した後、次回アクセス時の挙動
  - 演出表示済みフラグの管理要否
  
- **ゲーム体験仕様確認結果:**
  - Q3-1への回答: B（初回のみ表示され、2回目以降は表示されない）
  - Q3-2への回答: A（それぞれのキャラの詳細画面を開いた際に個別に表示される）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 項目 A-3 で詳述済み
  - `usr_unit` テーブルの `last_reward_grade_level` 値で演出表示済み状態を管理
  - `log_unit_grade_up_rewards` テーブルで報酬付与履歴を記録
  
- **備考:**
  - キャラごとに演出表示フラグを管理する設計
  - シンプルで拡張性のある実装

### 3.4 ゲーム体験的に不自然な可能性があった項目

#### 項目 D-1: 既存ユーザーへの演出表示タイミング
- **元の不明点:**
  - 仕様書には「キャラ詳細画面に遷移した際に演出表示」とあるが、以下のケースで不自然な体験になる可能性:
    - ユーザーが複数のグレード5キャラを所持している場合、キャラ詳細画面を開くたびに演出が発生する
    - 機能リリース直後、ユーザーが意図せず演出を見てしまう（準備ができていない状態での表示）
  
- **ゲーム体験仕様確認結果:**
  - Q3-2への回答: A（それぞれのキャラの詳細画面を開いた際に個別に表示される）
  - Q6-1への回答: B（キャラ詳細画面へのアクセス時に付与）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ユーザーが各キャラの詳細画面にアクセスした際に、個別に原画付与と演出表示を行う
  - これにより、ユーザーが自分のペースで原画獲得を体験できる
  - 演出表示は初回のみ（項目 A-3 で確定）
  - 実装上の対応:
    - キャラ詳細画面APIで、グレード5到達済みかつ `last_reward_grade_level < grade_level` のキャラを判定
    - 該当する場合、原画を付与し、`last_reward_grade_level` に現在のグレードレベルを設定
    - `log_unit_grade_up_rewards` にログを記録
    - レスポンスに演出表示フラグを含める
    - クライアントは演出表示フラグを確認し、trueの場合は演出を表示
    
- **備考:**
  - 当初の懸念事項（意図せず演出が発生）は、ユーザーが自発的にキャラ詳細画面にアクセスする仕様により解消
  - ユーザー体験として自然な形になる

#### 項目 D-2: URキャラのみの制限による不公平感
- **元の不明点:**
  - リリース時はURキャラのみが対象のため、URキャラを所持していないユーザーには恩恵がない
  - SSR以下のキャラを愛用しているユーザーにとって不公平感を感じる可能性
  
- **ゲーム体験仕様確認結果:**
  - Q1への回答: C（両方の拡張を予定している）
  - 将来的にUR以外のレアリティでも原画を獲得できるようにする予定
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - リリース時はURキャラのみが対象だが、将来的に他レアリティへの拡張を予定
  - マスタデータ設計（`mst_unit_grade_up_rewards`）により、どのレアリティのキャラにも原画を設定可能
  - 段階的に対象を拡大することで、不公平感を軽減
  
- **備考:**
  - 将来の拡張計画が明確になったことで、懸念が解消
  - リリース時はURキャラのみという制限は、段階的リリースの方針として妥当

### 3.5 その他の確認項目

#### 項目 Q4: グレードアップ確認ダイアログでの原画情報表示
- **元の不明点:**
  - サーバー/クライアントのどちらで判定するか
  
- **ゲーム体験仕様確認結果:**
  - Q4への回答: C（クライアント側で判定・表示）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 項目 A-4 で詳述済み
  
- **備考:**
  - サーバー側の実装負荷が軽減

#### 項目 Q5: 必殺ワザ詳細画面での原画情報表示
- **元の不明点:**
  - どのAPIレスポンスで提供すべきか
  - 表示条件は何か
  
- **ゲーム体験仕様確認結果:**
  - Q5-1への回答: B（マスタデータに含め、クライアント側で表示判定する）
  - Q5-2への回答: A（そのキャラに原画が設定されていれば常に表示）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 原画情報はマスタデータ（`mst_unit_grade_up_rewards`）に含める
  - クライアント側でマスタデータを参照し、原画が設定されているキャラのグレード表示に「『キャラ名』の原画獲得」を表示
  - 表示条件: 該当キャラに原画が設定されていれば常に表示（獲得済みかどうかに関わらず）
  - 実装上の対応:
    - マスタデータ配信に `mst_unit_grade_up_rewards` を含める
    - クライアント側で必殺ワザ詳細画面表示時に、該当グレードに原画設定があるかチェック
    - 設定がある場合、「『キャラ名』の原画獲得」を表示
    
- **備考:**
  - サーバー側は新規API不要
  - マスタデータのみで対応可能

#### 項目 Q6: 既存ユーザーへの原画付与タイミング
- **元の不明点:**
  - 原画付与のタイミングはいつか
  - 付与と演出表示は同時か
  
- **ゲーム体験仕様確認結果:**
  - Q6-1への回答: B（キャラ詳細画面へのアクセス時に付与）
  - Q6-2への回答: A（同時）
  
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 機能リリース時に既にグレード5のキャラを所持しているユーザーへの原画付与は、**キャラ詳細画面へのアクセス時に実行**
  - 付与と演出表示は同時に行う
  - 実装上の対応:
    - キャラ詳細画面API（例: `GET /unit/{usrUnitId}/detail`）で以下の判定を実行:
      1. 該当ユニットがグレード5以上か
      2. 該当ユニットの `last_reward_grade_level < grade_level` か
      3. 該当ユニットに原画が設定されているか（`mst_unit_grade_up_rewards` を参照）
      4. 該当原画を未獲得か（`usr_artworks` を確認）
    - 上記全てを満たす場合、原画を付与し、`last_reward_grade_level = 現在のグレードレベル` に更新
    - `log_unit_grade_up_rewards` にログを記録
    - レスポンスに演出表示フラグを含める
    - 既存のコード調査で確認されたアクセス時判定パターンを適用
  - バッチ処理による一括付与は不要
  
- **備考:**
  - アクセス時判定により、サーバー負荷を分散
  - ユーザーが自分のペースで原画獲得を体験できる
  - 既存のShop機能などで採用されているパターンと一貫性がある

## 4. 残存する不明点・追加確認が必要な項目

### 4.1 まだ不明な点
**該当なし**

全ての不明点が解決され、サーバー実装に必要な仕様が確定しました。

### 4.2 新たに発生した疑問点
**該当なし**

ゲーム体験仕様の確認結果を受けて、新たな疑問点は発生していません。

## 5. サーバー実装への影響評価

### 5.1 仕様確定度の評価
- **全体的な仕様確定度: 100%**
- **サーバー実装に必要な仕様が全て揃っているか: Yes**
- 揃っていない場合、何が足りないか: N/A

### 5.2 実装への影響

#### ゲーム体験仕様確認によって変更が必要になった箇所
**該当なし**

当初の想定と大きな差異はなく、コード調査で確認された既存実装パターンを活用できることが確認されました。

#### 新たに追加実装が必要になった箇所
1. **マスタテーブル `mst_unit_grade_up_rewards` の作成**
   - キャラと原画のマッピング情報を管理
   - 将来の拡張性を考慮した設計

2. **`usr_unit` テーブルへのカラム追加**
   - `last_reward_grade_level` カラムを追加（int(NOT NULL), default: 0）
   - グレードアップで原画を受け取った後、そのグレードレベルを記録

3. **ログテーブル `log_unit_grade_up_rewards` の作成**
   - グレードアップ報酬の付与履歴を記録
   - `usr_user_id`, `mst_unit_id`, `mst_unit_grade_up_reward_id` を記録

4. **グレードアップ処理の拡張**
   - 原画付与後に `usr_unit.last_reward_grade_level` に達成したグレードレベルを設定

5. **キャラ詳細画面APIの拡張**
   - グレード5到達済みかつ `last_reward_grade_level < grade_level` のキャラの原画付与判定
   - 原画付与処理の実行
   - `last_reward_grade_level` に現在のグレードレベルを設定
   - `log_unit_grade_up_rewards` への記録
   - 演出表示フラグのレスポンス追加

6. **グレードアップAPIのレスポンス拡張**
   - 原画獲得情報の追加（`acquiredArtworks` フィールド）
   - 既存の報酬システムのレスポンスに原画情報が含まれる

7. **グレードアップ時の原画付与ロジック**
   - グレード5到達判定
   - 原画設定有無の確認（`mst_unit_grade_up_rewards` テーブルを参照）
   - RewardDelegatorを使って原画(ARTWORK)報酬を付与
   - `ArtworkSendService`が`grantArtworksWithFragments`を呼び出し、原画に紐づく全フラグメントを付与
   - 全フラグメントが揃うことで原画が完成
   - 重複時は`ArtworkConvertService`により自動的にコイン変換
   - ミッショントリガー送信（原画完成時）

#### 実装不要になった箇所
1. **グレードアップ確認ダイアログ用の新規API**
   - クライアント側で判定するため不要

2. **必殺ワザ詳細画面用の新規API**
   - マスタデータのみで対応可能なため不要

3. **既存ユーザーへのバッチ処理**
   - アクセス時判定で対応するため不要

4. **演出表示完了通知API**
   - `usr_unit.last_reward_grade_level` で管理するため不要

### 5.3 スケジュール・リスクへの影響

#### ゲーム体験仕様確認前の想定からの変更点
1. **演出表示フラグ管理の追加**
   - `usr_unit` テーブルへのカラム追加（`last_reward_grade_level`）
   - `log_unit_grade_up_rewards` テーブルの追加
   - 工数影響: +0.5日（シンプルな設計のため影響軽微）

2. **クライアント側での判定実装が増加**
   - サーバー側の実装は軽減されるが、クライアント側との連携確認が必要
   - 工数影響: サーバー側は軽減、クライアント側との調整時間は必要

3. **キャラ詳細画面APIの拡張**
   - 既存API（キャラ詳細画面）への機能追加が必要
   - 工数影響: +0.5〜1日

#### スケジュールへの影響
**修正後の推定工数:**
- マスタデータ設計・マイグレーション: 0.5〜1日（`mst_unit_grade_up_rewards` + `log_unit_grade_up_rewards` + `usr_unit`カラム追加）
- サービス層実装（グレードアップ時の処理拡張）: 0.5〜1日
- サービス層実装（原画付与処理）: 1〜1.5日
- キャラ詳細画面API拡張（既存ユーザー対応）: 1〜1.5日
- APIレスポンス修正: 0.5日
- ユニットテスト・統合テスト: 1〜2日
- **合計: 4.5〜7.5日**

**変更前の推定工数（03_サーバー仕様レビュー.md）: 3.5〜6.5日**

**工数増加: +1〜1日**

増加要因:
- 最後に報酬を受け取ったグレードレベル管理の追加（シンプルな設計で影響軽微）
- キャラ詳細画面APIへの機能追加

#### 残存リスク
1. **クライアント側との連携確認**
   - リスク内容: マスタデータの参照方法、演出表示タイミングの制御など、クライアント側との仕様合わせが必要
   - 対策: 詳細設計レビューをクライアントチームと実施
   - 影響度: 中

2. **既存ユーザー対応の初回動作**
   - リスク内容: 機能リリース直後、大量の既存ユーザーがキャラ詳細画面にアクセスした場合の負荷
   - 対策: アクセス時判定により負荷が分散されるため、影響は限定的
   - 影響度: 小

## 6. 次のアクションアイテム

- [x] ゲーム体験仕様の確認完了
- [ ] **サーバー側詳細設計書の作成**
  - マスタデータ定義（`mst_unit_grade_up_rewards`）
  - ログテーブル定義（`log_unit_grade_up_rewards`）
  - ユーザーデータ定義（`usr_unit` の `last_reward_grade_level` カラム追加）
  - API仕様書（キャラ詳細画面API、グレードアップAPI）
  - シーケンス図（グレードアップ時、既存ユーザー対応時）
- [ ] **クライアントチームとの仕様レビュー**
  - マスタデータの参照方法
  - 演出表示タイミングの制御
  - エラーハンドリング
- [ ] **マイグレーションスクリプトの作成**
  - `mst_unit_grade_up_rewards` テーブル作成
  - `log_unit_grade_up_rewards` テーブル作成
  - `usr_unit` テーブルへのカラム追加
- [ ] **実装開始**
  - サービス層の実装
  - APIの実装
  - ユニットテスト
  - 統合テスト
- [ ] **リリース計画の策定**
  - 機能リリースのタイミング
  - マスタデータの投入スケジュール
  - リリース後の監視項目

## 7. 結論

ゲーム体験仕様の確認により、サーバー実装に必要な全ての仕様が確定しました。

**主な成果:**
1. マスタデータ設計方針の確定（新規テーブル `mst_unit_grade_up_rewards` の作成）
2. 重複原画の扱いの明確化（コイン変換）
3. 演出表示制御の詳細化（`usr_unit.last_reward_grade_level` による最後に報酬を受け取ったグレードレベル管理）
4. ログテーブルによる履歴管理（`log_unit_grade_up_rewards`）
5. クライアント側の責任範囲の明確化（マスタデータによる判定）
6. 既存ユーザー対応の実装方針の確定（アクセス時判定）

**実装準備状況:**
- 全ての不明点が解決され、詳細設計に進むことが可能
- 既存の技術基盤（RewardDelegator、トランザクション管理、ミッション連携）を活用できることが確認済み
- シンプルで拡張性のある設計が確定
- 工数の見積もりが可能（4.5〜7.5日）

**次のステップ:**
詳細設計書の作成とクライアントチームとの仕様レビューを実施し、実装に着手します。
