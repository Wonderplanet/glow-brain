# サーバーAPI要件書

## 1. ドキュメント情報
- **対象機能**: スタミナ回復アイテム
- **作成日**: 2025-11-27
- **参照ドキュメント**:
  - 01_サーバー要件抽出.md
  - 02_サーバー要件_コード調査追記.md
  - 03_サーバー仕様レビュー.md
  - 04_ゲーム体験仕様確認結果まとめ.md
  - 03_2_サーバー仕様レビュー_プランナー仕様確認結果.md

## 2. 機能概要

### 2.1 ユーザーへ提供するゲーム体験
スタミナ回復アイテムは、プレイヤーがクエスト等のゲームコンテンツをプレイするために必要なスタミナを、アイテムを使用することで回復できる機能です。

- プレイヤーは、ログインボーナス・ミッション報酬・イベント報酬などでスタミナ回復アイテムを獲得する
- 獲得したアイテムは任意のタイミングで使用し、スタミナを回復することができる
- 1個の使用でスタミナ上限値の半分を回復する
- 既存のプリズム消費（全回復）・広告視聴（50%回復）に加えて、柔軟なスタミナ管理の選択肢を提供する

### 2.2 サーバーAPIが果たす役割
- スタミナ回復アイテムの付与・管理を行う
- アイテム使用時のスタミナ回復処理を実行する
- スタミナ上限値を超えないよう制御する
- アイテム消費とスタミナ回復のログを記録する
- 各種報酬配布経路（ログインボーナス、ミッション、イベント等）でアイテムを配布する

---

## 3. API要件一覧

### 3.1 アイテム管理要件

#### 要件 ITEM-1: スタミナ回復アイテムの種別定義
- **要件ID:** REQ-ITEM-1
- **概要:**
  - スタミナ回復アイテムを既存のアイテム管理システムで扱えるよう、新しいアイテム種別を定義する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - スタミナ回復アイテムは「スタミナ上限値の半分を回復する」機能を持つ
  - APIで実現すべき内容:
    - 新規ItemType `StaminaRecoveryPercent` を定義し、パーセンテージ指定のスタミナ回復アイテムを識別可能にする
    - このアイテム種別は、使用時にスタミナ回復処理を実行する種別として扱われる
    - 回復率はマスタデータの `effect_value` で指定する（例: "50" = 50%回復）
  - 条件・制約:
    - 既存のItemType定義と重複しない
    - glow-schemaのItem.ymlに定義を追加する
  - データ管理要件:
    - アイテム種別情報はマスタデータとして管理される
    - ユーザーごとの所持数はusrテーブルで管理される
    - `mst_items.effect_value` に回復パーセンテージを設定する
- **既存実装との関連:**
  - glow-schema/Schema/Item.yml の ItemType Enum
  - api/app/Domain/Item/Enums/ItemType.php
  - 既存のアイテム種別（CharacterFragment, RandomFragmentBox等）と同様の管理方式
- **備考:**
  - サーバーチームの技術的判断により、新規ItemType追加を採用（既存Etc種別の使用は非推奨）
  - **段階的実装の方針:**
    - **Phase 1（今回のリリース）:** `StaminaRecoveryPercent` のみ実装。effect_valueでパーセンテージを指定可能（現状50%固定→マスタで設定可能に）
    - **Phase 2（将来必要時）:** `StaminaRecoveryFixed`（固定量回復）を追加予定。effect_valueで固定回復量を指定

#### 要件 ITEM-2: アイテム所持数管理
- **要件ID:** REQ-ITEM-2
- **概要:**
  - ユーザーごとのスタミナ回復アイテム所持数を管理する
- **詳細仕様:**
  - APIで実現すべき内容:
    - ユーザーがスタミナ回復アイテムを獲得した際、所持数を加算する
    - ユーザーがアイテムを使用した際、所持数を減算する
    - 所持数が0の場合、アイテム使用は不可とする
  - 条件・制約:
    - 所持数の上限は `USER_ITEM_MAX_AMOUNT` で定義された値（既存の仕組みを踏襲）
    - 上限を超えるアイテム付与は廃棄される（UnreceivedRewardReason::RESOURCE_OVERFLOW_DISCARDED）
  - データ管理要件:
    - usrデータベースで所持数を永続化
    - 所持数の増減履歴をログとして記録
- **既存実装との関連:**
  - api/app/Domain/Item/Services/UsrItemService.php の addItemByRewards, consumeItems
  - usr テーブルのアイテム所持数管理の仕組み

#### 要件 ITEM-3: アイテム消費処理
- **要件ID:** REQ-ITEM-3
- **概要:**
  - ユーザーがスタミナ回復アイテムを使用した際、指定された個数を消費する
- **詳細仕様:**
  - APIで実現すべき内容:
    - クライアントから指定されたアイテムIDと使用個数を受け取る
    - 所持数が使用個数以上であることを確認する
    - 所持数から使用個数を減算する
    - アイテム消費のログを記録する
  - 条件・制約:
    - 所持数が不足している場合はエラー（ErrorCode::ITEM_NOT_OWNED）
    - 使用個数は1以上の整数
  - データ管理要件:
    - 消費前の所持数と消費後の所持数をログに記録
    - トリガー情報に「スタミナ回復アイテム使用」を記録
- **既存実装との関連:**
  - api/app/Domain/Item/Services/UsrItemService.php の consumeItem, consumeItems
  - api/app/Domain/Item/Repositories/LogItemRepository.php

### 3.2 スタミナ回復要件

#### 要件 STA-1: スタミナ回復量の計算
- **要件ID:** REQ-STA-1
- **概要:**
  - スタミナ回復アイテム1個あたりのスタミナ回復量を計算する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「スタミナ上限値の半分回復ができるアイテムのみがあれば良い」（Page 1）
  - APIで実現すべき内容:
    - ユーザーのスタミナ上限値を取得する
      - レベル別スタミナ上限（mst_user_levels.stamina）
      - ショップパス効果による追加上限
    - マスタデータの `effect_value` から回復パーセンテージを取得する
    - スタミナ上限値に対するパーセンテージを計算する
      - 計算式: `floor(スタミナ上限値 × effect_value / 100)`
    - 使用個数が複数の場合、回復量を個数倍する
  - 条件・制約:
    - 回復率は `mst_items.effect_value` で指定（例: "50" = 50%回復）
    - 小数点以下は切り捨て（floor関数）
    - ショップパス効果がある場合、効果を含めた上限値を基準とする
- **既存実装との関連:**
  - api/app/Domain/User/Services/UserBuyStaminaService.php の calcAddStamina
  - 広告視聴スタミナ購入と同じ計算ロジック（BUY_STAMINA_AD_PERCENTAGE_OF_MAX_STAMINA = 50）を参考に実装

#### 要件 STA-2: 自然回復の適用
- **要件ID:** REQ-STA-2
- **概要:**
  - アイテム使用時のスタミナ回復処理を行う前に、自然回復分を先に適用する
- **詳細仕様:**
  - APIで実現すべき内容:
    - アイテム使用APIが呼ばれた際、まず自然回復処理を実行する
    - 自然回復分を反映した最新のスタミナ値を取得する
    - その後、アイテムによる回復量を加算する
  - 条件・制約:
    - 自然回復は3分で1回復（RECOVERY_STAMINA_MINUTE = 3）
    - 自然回復はスタミナ上限値で打ち切り
    - 最終更新時刻からの経過時間を元に回復量を算出
- **既存実装との関連:**
  - api/app/Domain/User/Services/UserService.php の recoveryStamina, getRecoveredStamina
  - スタミナ関連処理の標準パターン

#### 要件 STA-3: スタミナ満タン時の使用制限
- **要件ID:** REQ-STA-3
- **概要:**
  - スタミナが上限値に達している状態（満タン）の時、スタミナ回復アイテムは使用不可とする
- **詳細仕様:**
  - ゲーム体験仕様確認結果:
    - Q1の回答: 満タン時は使用不可（既存のスタミナ購入と同じ挙動）
  - APIで実現すべき内容:
    - 自然回復適用後の現在スタミナを取得する
    - スタミナ上限値を取得する
    - 現在スタミナが上限値以上の場合、エラーを返す
  - 条件・制約:
    - 判定条件: `スタミナ上限値 <= 現在スタミナ`
    - 上限値とイコールの場合も使用不可
    - エラーコード: ErrorCode::USER_STAMINA_FULL
    - エラー発生時、アイテムは消費されない
- **既存実装との関連:**
  - api/app/Domain/User/Services/UserBuyStaminaService.php の calcAddStamina
  - 既存のスタミナ購入機能と同じエラーハンドリング
- **備考:**
  - クライアント側で満タン時はアイテム使用ボタンをグレーアウトする実装が推奨される

#### 要件 STA-4: システム上限値制御
- **要件ID:** REQ-STA-4
- **概要:**
  - 使用可否の判定と、回復後のスタミナ値を制御する
- **詳細仕様:**
  - ゲーム体験仕様確認結果:
    - Q2の回答: UI側で現在スタミナがスタミナ上限を超えない範囲で個数選択可能にする
    - **Q6追加確認（2025-12-02）:**
      - 既存のプリズム・広告視聴のUIとは異なり、**個数選択をできるようにする**
      - 「現在スタミナ」が「スタミナ上限」を超えない限り、**1度に2つ以上消費して回復可能**
      - **回復後のスタミナがスタミナ上限を超えることは許可**（システム上限999まで）
      - 例：スタミナが50/180の場合（アイテム1個で+90回復）
        - 1個目使用: 50+90=140（< 180なので、まだ2個目も使用可能）
        - 2個目使用: 140+90=230（> 180だが、**230まで回復OK**）
        - 2個目使用後は「現在スタミナ230」>「スタミナ上限180」なので、3個目は使用不可
  - APIで実現すべき内容:
    - **使用可否の判定**: 現在スタミナ < スタミナ上限 の場合のみ使用可能
    - アイテム使用個数 × 1個あたりの回復量を計算する
    - 現在スタミナ + 回復量の合計を算出する（システム上限999まで許可）
  - 条件・制約:
    - **使用可否判定**: 現在スタミナ < スタミナ上限（レベル別 + ショップパス効果）
    - **回復量制限**: システム絶対上限999まで（スタミナ上限180での打ち切りはしない）
    - クライアント側で「使用後に現在スタミナが上限を超えた場合」は追加選択不可とする（UI側制御）
    - サーバー側はシステム上限999でmin関数による制限を実施
  - データ管理要件:
    - 回復後のスタミナ値を保存する
    - 廃棄処理は発生しない（UI側で事前に制御されるため）
- **既存実装との関連:**
  - api/app/Domain/User/Constants/UserConstant.php の MAX_STAMINA
  - api/app/Domain/User/Services/UserBuyStaminaService.php の上限チェック
- **備考:**
  - クライアント側で使用可否を判定するロジックが必要（使用後スタミナ >= 上限 なら追加使用不可）
  - サーバー側のシステム上限チェックは安全弁としての役割
  - **複数個同時使用が可能**であることをクライアント・サーバー双方で認識
  - **回復後のスタミナがスタミナ上限を超えることは正常動作**

#### 要件 STA-5: スタミナ加算処理
- **要件ID:** REQ-STA-5
- **概要:**
  - 計算された回復量をユーザーの現在スタミナに加算する
- **詳細仕様:**
  - APIで実現すべき内容:
    - 現在スタミナ + 回復量を計算する
    - システム上限値（999）でmin処理を行う
    - 新しいスタミナ値をusrテーブルに保存する
    - スタミナ更新時刻を記録する
  - 条件・制約:
    - 加算後の値は必ず999以下
  - データ管理要件:
    - usrデータベースでスタミナ値を永続化
    - 更新時刻（stamina_updated_at）を記録
- **既存実装との関連:**
  - api/app/Domain/User/Models/UsrUserParameter.php の addStamina, setStamina
  - api/app/Domain/User/Services/UserService.php の addStamina

### 3.3 報酬配布要件

#### 要件 REWARD-1: ログインボーナスでの配布
- **要件ID:** REQ-REWARD-1
- **概要:**
  - ログインボーナスとしてスタミナ回復アイテムを配布する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「ログインボーナスやミッション報酬として配布することで、毎日ログインする動機を安価に作れます」（Page 1）
  - APIで実現すべき内容:
    - ログインボーナス処理でスタミナ回復アイテムを報酬として付与する
    - 報酬配布システム（RewardDelegator）経由で配布する
  - 条件・制約:
    - ログインボーナスのマスタデータで配布設定が可能
    - 所持数上限を超える場合は廃棄される
- **既存実装との関連:**
  - api/app/Domain/Reward/Delegators/RewardDelegator.php
  - api/app/Domain/Reward/Services/ItemSendService.php
  - ログインボーナス機能の既存実装

#### 要件 REWARD-2: ミッション報酬での配布
- **要件ID:** REQ-REWARD-2
- **概要:**
  - ミッション達成報酬としてスタミナ回復アイテムを配布する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「ログインボーナスやミッション報酬として配布することで、毎日ログインする動機を安価に作れます」（Page 1）
  - APIで実現すべき内容:
    - ミッション報酬としてスタミナ回復アイテムを付与する
    - 報酬配布システム（RewardDelegator）経由で配布する
  - 条件・制約:
    - ミッションのマスタデータで報酬設定が可能
    - 所持数上限を超える場合は廃棄される
- **既存実装との関連:**
  - api/app/Domain/Reward/Delegators/RewardDelegator.php
  - api/app/Domain/Reward/Services/ItemSendService.php
  - ミッション機能の既存実装

#### 要件 REWARD-3: イベント報酬での配布
- **要件ID:** REQ-REWARD-3
- **概要:**
  - イベント報酬としてスタミナ回復アイテムを配布する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「イベント報酬などにするのは良さそうです」（Page 1）
  - APIで実現すべき内容:
    - イベント報酬としてスタミナ回復アイテムを付与する
    - 報酬配布システム（RewardDelegator）経由で配布する
  - 条件・制約:
    - イベントのマスタデータで報酬設定が可能
    - 所持数上限を超える場合は廃棄される
- **既存実装との関連:**
  - api/app/Domain/Reward/Delegators/RewardDelegator.php
  - api/app/Domain/Reward/Services/ItemSendService.php
  - イベント機能の既存実装

#### 要件 REWARD-4: お詫び配布
- **要件ID:** REQ-REWARD-4
- **概要:**
  - 不具合時のお詫びとしてスタミナ回復アイテムを配布する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「不具合時のお詫びとして、課金通貨ではなくスタミナ剤を配布することで、売上への直接的なダメージを抑えつつ、ユーザーの不満を解消できます」（Page 1）
  - APIで実現すべき内容:
    - お詫び配布処理でスタミナ回復アイテムを付与する
    - 報酬配布システム（RewardDelegator）経由で配布する
  - 条件・制約:
    - 運営側が配布対象ユーザーと個数を指定可能
    - 所持数上限を超える場合は廃棄される
- **既存実装との関連:**
  - api/app/Domain/Reward/Delegators/RewardDelegator.php
  - api/app/Domain/Reward/Services/ItemSendService.php
  - 既存のお詫び配布の仕組み

#### 要件 REWARD-5: 報酬配布時の上限処理
- **要件ID:** REQ-REWARD-5
- **概要:**
  - 報酬配布時、アイテム所持数上限を超える分は廃棄する
- **詳細仕様:**
  - APIで実現すべき内容:
    - 報酬配布時に現在の所持数を確認する
    - 配布後の所持数が上限を超える場合、上限で打ち切る
    - 超過分は廃棄し、UnreceivedRewardReason::RESOURCE_OVERFLOW_DISCARDED を設定する
  - 条件・制約:
    - 所持数上限: USER_ITEM_MAX_AMOUNT
  - データ管理要件:
    - 廃棄された報酬の記録を保持する
- **既存実装との関連:**
  - api/app/Domain/Item/Services/UsrItemService.php の addItemByRewards
  - api/app/Domain/Resource/Enums/UnreceivedRewardReason.php

### 3.4 API実行要件

#### 要件 API-1: アイテム使用API
- **要件ID:** REQ-API-1
- **概要:**
  - スタミナ回復アイテムを使用するためのAPIエンドポイントを提供する
- **詳細仕様:**
  - APIで実現すべき内容:
    - 既存の `/api/item/consume` APIを拡張する
    - クライアントからアイテムIDと使用個数を受け取る
    - アイテム種別がStaminaRecoveryの場合、スタミナ回復処理を実行する
    - 処理結果（使用後のアイテム一覧、スタミナ値）をレスポンスとして返す
  - 条件・制約:
    - リクエストパラメータ:
      - mstItemId: string (アイテムID)
      - amount: int (使用個数)
    - レスポンス:
      - usrItems: 使用後のアイテム一覧
      - usrParameter: 使用後のユーザーパラメータ（スタミナ値含む）
      - itemRewards: 獲得報酬（スタミナ回復の場合は空）
      - usrItemTrade: アイテム交換情報（スタミナ回復の場合は不要）
- **既存実装との関連:**
  - glow-schema/Schema/Item.yml の /api/item/consume
  - api/app/Domain/Item/Services/ItemService.php の apply
- **備考:**
  - 新規API作成は不要、既存APIの拡張で対応

#### 要件 API-2: アイテム種別別処理の実装
- **要件ID:** REQ-API-2
- **概要:**
  - ItemService::apply() メソッドに、StaminaRecoveryPercent種別の処理を追加する
- **詳細仕様:**
  - APIで実現すべき内容:
    - ItemService::apply() メソッド内で、ItemType::STAMINA_RECOVERY_PERCENT の case 分岐を追加する
    - スタミナ回復処理の専用メソッドを呼び出す
    - マスタデータの `effect_value` から回復パーセンテージを取得して計算に使用する
  - 処理フロー:
    1. 自然回復を適用（REQ-STA-2）
    2. スタミナ満タンチェック（REQ-STA-3）
    3. effect_valueから回復パーセンテージを取得
    4. スタミナ回復量を計算（REQ-STA-1）
    5. システム上限チェック（REQ-STA-4）
    6. スタミナ加算（REQ-STA-5）
    7. アイテム消費（REQ-ITEM-3）
    8. ログ記録（REQ-LOG-1, REQ-LOG-2）
- **既存実装との関連:**
  - api/app/Domain/Item/Services/ItemService.php

### 3.5 ログ記録要件

#### 要件 LOG-1: アイテム消費ログ
- **要件ID:** REQ-LOG-1
- **概要:**
  - スタミナ回復アイテム使用時のアイテム消費ログを記録する
- **詳細仕様:**
  - APIで実現すべき内容:
    - アイテム使用時に log_items テーブルにログを記録する
    - 記録内容:
      - アクション種別: LogResourceActionType::USE
      - 消費前の所持数
      - 消費後の所持数
      - アイテムID
      - トリガー情報（JSONで詳細を保存）
  - データ管理要件:
    - ログは永続的に保持
    - トリガー情報に「スタミナ回復アイテム使用」を記録
- **既存実装との関連:**
  - api/app/Domain/Item/Repositories/LogItemRepository.php
  - api/app/Domain/Item/Services/UsrItemService.php の consumeItems

#### 要件 LOG-2: スタミナ増加ログ
- **要件ID:** REQ-LOG-2
- **概要:**
  - スタミナ回復アイテム使用時のスタミナ増加ログを記録する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - 「イベント開催期間中のアイテム使用状況を記録・分析できるようにする必要がある」（Page 1、要件7）
  - APIで実現すべき内容:
    - スタミナ回復時に log_staminas テーブルにログを記録する
    - 記録内容:
      - アクション種別: LogResourceActionType::ADD
      - 回復前のスタミナ値
      - 回復後のスタミナ値
      - トリガー情報（JSONで詳細を保存）
  - データ管理要件:
    - ログは永続的に保持
    - トリガー情報に「スタミナ回復アイテム使用」「アイテムID」を記録
    - イベント期間との突合分析が可能な形式で記録
- **既存実装との関連:**
  - api/app/Domain/User/Repositories/LogStaminaRepository.php
  - api/app/Domain/User/Services/UserService.php

### 3.6 ミッション連携要件

#### 要件 MISSION-1: アイテム獲得時のミッショントリガー
- **要件ID:** REQ-MISSION-1
- **概要:**
  - スタミナ回復アイテム獲得時にミッショントリガーを送信する
- **詳細仕様:**
  - APIで実現すべき内容:
    - アイテム獲得時に ItemMissionTriggerService::sendItemCollectTrigger を呼び出す
    - 「特定のアイテムを獲得する」ミッションに対応する
  - 条件・制約:
    - 既存のアイテム獲得処理で自動的に実行される
- **既存実装との関連:**
  - api/app/Domain/Item/Services/UsrItemService.php の addItemByRewards
  - api/app/Domain/Item/Services/ItemMissionTriggerService.php
- **備考:**
  - 新規実装不要、既存の仕組みで自動対応

#### 要件 MISSION-2: アイテム使用時のミッショントリガー（実装不要）
- **要件ID:** REQ-MISSION-2
- **概要:**
  - スタミナ回復アイテム使用時のミッショントリガーは実装不要
- **詳細仕様:**
  - ゲーム体験仕様確認結果:
    - Q4の回答: アイテム使用ミッションはなし
  - APIで実現すべき内容:
    - なし（実装不要）
- **備考:**
  - 「スタミナ回復アイテムを使用する」ミッションは存在しないため、トリガー送信は不要

---

## 4. 要件間の依存関係

### 4.1 前提となる要件
- **REQ-STA-1（回復量計算）** は **REQ-STA-2（自然回復適用）** が実行された後に実施する必要がある
  - 理由: 最新のスタミナ値を元に上限値を参照し、回復量を計算するため
- **REQ-STA-3（満タンチェック）** は **REQ-STA-2（自然回復適用）** が実行された後に実施する必要がある
  - 理由: 自然回復後の最新スタミナ値で満タン判定を行うため
- **REQ-STA-5（スタミナ加算）** は **REQ-STA-1（回復量計算）** と **REQ-STA-4（上限制御）** が実行された後に実施する必要がある
  - 理由: 確定した回復量を加算するため

### 4.2 同時に実現すべき要件
- **REQ-ITEM-3（アイテム消費）** と **REQ-STA-5（スタミナ加算）** は同一トランザクション内で実行される必要がある
  - 理由: アイテムを消費したが、スタミナが回復しない（またはその逆）という不整合を防ぐため
- **REQ-LOG-1（アイテム消費ログ）** と **REQ-LOG-2（スタミナ増加ログ）** は同一トランザクション内で記録される必要がある
  - 理由: アイテム消費とスタミナ回復の両方が完了した時点でログを記録するため

### 4.3 処理順序
アイテム使用APIの処理順序は以下の通り:

1. 自然回復適用（REQ-STA-2）
2. スタミナ満タンチェック（REQ-STA-3）
3. アイテム所持数チェック（REQ-ITEM-3の一部）
4. スタミナ回復量計算（REQ-STA-1）
5. システム上限チェック（REQ-STA-4）
6. アイテム消費（REQ-ITEM-3）
7. スタミナ加算（REQ-STA-5）
8. ログ記録（REQ-LOG-1, REQ-LOG-2）

---

## 5. 非機能要件

### 5.1 パフォーマンス要件
- アイテム使用APIのレスポンスタイムは、既存のアイテム使用API（RandomFragmentBox等）と同等とする
- 複数個使用時も、1回のAPIリクエストで処理を完了する
- データベースアクセスは必要最小限に抑える（N+1クエリの回避）

### 5.2 セキュリティ要件
- **不正防止**:
  - クライアントから送信される使用個数が、実際の所持数を超えていないことをサーバー側で検証する
  - スタミナ上限値の計算は全てサーバー側で行い、クライアントから送信された値は使用しない
- **データ保護**:
  - アイテム消費とスタミナ加算は同一トランザクション内で実行し、中途半端な状態を残さない
  - ログ記録により、不正利用の追跡が可能な状態を保つ

### 5.3 可用性要件
- **エラーハンドリング**:
  - スタミナ満タン時のエラー（ErrorCode::USER_STAMINA_FULL）
  - アイテム所持数不足時のエラー（ErrorCode::ITEM_NOT_OWNED）
  - システム上限超過時のエラー（ErrorCode::USER_STAMINA_EXCEEDS_LIMIT）※UI側制御により通常は発生しない
- **トランザクション管理**:
  - アイテム消費とスタミナ加算が同時に成功または同時に失敗することを保証する
  - ログ記録が失敗した場合も、トランザクションをロールバックする

### 5.4 その他の非機能要件
- **ログ記録**:
  - アイテム消費ログ（log_items）を記録する
  - スタミナ増加ログ（log_staminas）を記録する
  - イベント期間との突合分析が可能な形式で記録する
- **監視**:
  - アイテム使用APIのエラー率を監視する
  - スタミナ満タンエラーの発生頻度を監視する（UI側の実装品質の指標）
- **運用**:
  - イベント期間中のアイテム使用状況を集計・分析できるようにする

---

## 6. データ要件

### 6.1 永続化が必要なデータ

#### データ項目 D-1: スタミナ回復アイテムの所持数
- **内容**: ユーザーごとのスタミナ回復アイテム所持数
- **用途**: アイテム使用可否の判定、アイテム消費処理
- **保持期間**: 永久（ユーザーデータの一部として保持）
- **関連要件**: REQ-ITEM-2

#### データ項目 D-2: スタミナ値
- **内容**: ユーザーの現在スタミナ値
- **用途**: スタミナ回復処理、満タンチェック、上限チェック
- **保持期間**: 永久（ユーザーデータの一部として保持）
- **関連要件**: REQ-STA-2, REQ-STA-3, REQ-STA-4, REQ-STA-5

#### データ項目 D-3: スタミナ更新時刻
- **内容**: スタミナが最後に更新された時刻
- **用途**: 自然回復の計算
- **保持期間**: 永久（ユーザーデータの一部として保持）
- **関連要件**: REQ-STA-2

#### データ項目 D-4: アイテム消費ログ
- **内容**: アイテム使用時の消費前後の所持数、トリガー情報
- **用途**: 運用分析、不正利用検知
- **保持期間**: 永久（ログデータ）
- **関連要件**: REQ-LOG-1

#### データ項目 D-5: スタミナ増加ログ
- **内容**: スタミナ回復時の回復前後の値、トリガー情報
- **用途**: 運用分析、イベント時の使用状況分析
- **保持期間**: 永久（ログデータ）
- **関連要件**: REQ-LOG-2

### 6.2 一時的に管理が必要なデータ

特になし。全てのデータは永続化される。

### 6.3 参照が必要なマスタデータ

#### マスタデータ M-1: スタミナ回復アイテムのアイテムマスタ
- **内容**: スタミナ回復アイテムの基本情報（アイテムID、名前、種別、アイコン等）
- **用途**: アイテム種別の判定、クライアントへの表示情報提供
- **関連要件**: REQ-ITEM-1

#### マスタデータ M-2: レベル別スタミナ上限
- **内容**: ユーザーレベルごとのスタミナ上限値（mst_user_levels.stamina）
- **用途**: スタミナ回復量の計算
- **関連要件**: REQ-STA-1

#### マスタデータ M-3: システム設定（スタミナ上限）
- **内容**: システム絶対上限値（UserConstant::MAX_STAMINA = 999）
- **用途**: スタミナ上限チェック
- **関連要件**: REQ-STA-4

#### マスタデータ M-4: システム設定（自然回復レート）
- **内容**: スタミナ自然回復の速度（RECOVERY_STAMINA_MINUTE = 3）
- **用途**: 自然回復量の計算
- **関連要件**: REQ-STA-2

---

## 7. 外部システム連携要件

### 7.1 クライアント連携

#### 連携 C-1: アイテム使用UI
- **連携内容**:
  - クライアントは、スタミナ回復アイテムの使用UI画面を提供する
  - **個数選択機能を実装**（既存のプリズム・広告視聴UIとは異なる）
  - ユーザーが選択した使用個数を `/api/item/consume` APIに送信する
- **クライアント側の実装要件**:
  - スタミナ満タン時は、アイテム使用ボタンをグレーアウトする
  - スタミナ上限を超える個数は選択不可とする
    - **使用可能個数計算式**: `floor((スタミナ上限 - 現在スタミナ) / 1個あたりの回復量)`
    - 使用可能個数を超える選択はUIで制限する
  - **1度に複数個（2個以上）の使用が可能**であることを考慮したUI設計
    - 例：スタミナが50/180の場合、最大2個まで選択可能（1個で+90→140、2個で+180→180）
- **データ同期**:
  - APIレスポンスに含まれる最新のスタミナ値と所持アイテム数をクライアント側で反映する

#### 連携 C-2: アイテム所持数表示
- **連携内容**:
  - クライアントは、スタミナ回復アイテムの所持数を表示する
  - アイテム使用後、APIレスポンスの所持数を反映する

### 7.2 他API機能との連携

#### 連携 API-1: スタミナ管理機能
- **連携内容**:
  - 既存のスタミナ管理機能（自然回復、プリズム購入、広告視聴）と連携する
  - スタミナ上限値の計算ロジックを共通化する
  - スタミナ満タンチェックのロジックを共通化する
- **関連要件**: REQ-STA-1, REQ-STA-2, REQ-STA-3, REQ-STA-4

#### 連携 API-2: アイテム管理機能
- **連携内容**:
  - 既存のアイテム管理機能（所持数管理、消費処理）と連携する
  - アイテム種別別の処理分岐に、スタミナ回復アイテムを追加する
- **関連要件**: REQ-ITEM-1, REQ-ITEM-2, REQ-ITEM-3

#### 連携 API-3: 報酬配布機能
- **連携内容**:
  - 既存の報酬配布機能（RewardDelegator）と連携する
  - ログインボーナス、ミッション、イベントなど、各配布経路で利用可能にする
- **関連要件**: REQ-REWARD-1, REQ-REWARD-2, REQ-REWARD-3, REQ-REWARD-4

#### 連携 API-4: ミッション機能
- **連携内容**:
  - 既存のミッション機能と連携する
  - アイテム獲得時のミッショントリガーを送信する
- **関連要件**: REQ-MISSION-1

#### 連携 API-5: ショップパス機能
- **連携内容**:
  - ショップパス効果によるスタミナ上限増加を考慮する
  - スタミナ上限値の計算時に、ショップパス効果を含める
- **関連要件**: REQ-STA-1

### 7.3 外部サービス連携

特になし。外部APIやサービスとの連携は不要。

---

## 8. 残存する不明点・要確認事項

### 8.1 まだ不明な仕様

**なし**

全ての不明点がゲーム体験仕様確認結果により明確になりました。

### 8.2 実装時に判断が必要な事項

#### 判断事項 J-1: アイテムマスタの具体的な設定値
- **何が未確定か**:
  - スタミナ回復アイテムのアイテムID（mst_item_id）
  - アイテム名、アイコン画像パス
  - アイテムの希少度（Rarity）
  - 所持数上限値
- **実装への影響**:
  - 実装時にマスタデータの設定値を決定する必要がある
  - クライアント側のアセット準備（アイコン画像等）と連携が必要
- **確認すべき相手**:
  - ゲーム企画担当者（アイテムID、名前、希少度）
  - デザイン担当者（アイコン画像）

#### 判断事項 J-2: 報酬配布での配布量設定
- **何が未確定か**:
  - ログインボーナス、ミッション報酬、イベント報酬での配布個数
  - 配布頻度、配布タイミング
- **実装への影響**:
  - マスタデータの設定値として管理する
  - 実装には影響しない（マスタデータで調整可能）
- **確認すべき相手**:
  - ゲーム企画担当者

---

## 9. 要件確定度の評価

### 9.1 全体評価
- **要件の確定度**: 100%
- **API実装に必要な要件情報の充足度**: 十分
- **実装開始の可否**: 可

### 9.2 評価の根拠
- ゲーム体験仕様確認結果により、全ての不明点（Q1-Q4）が明確になった
- サーバーチームの技術的判断により、実装方針（ItemType定義、API設計）が確定した
- 既存実装との連携方法が明確になった
- エラーハンドリング、トランザクション管理、ログ記録など、非機能要件も定義された

### 9.3 カテゴリ別評価

#### カテゴリ: アイテム管理要件
- **確定度**: 100%
- **課題**: なし
- **実装準備状況**: 実装可能

#### カテゴリ: スタミナ回復要件
- **確定度**: 100%
- **課題**: なし
- **実装準備状況**: 実装可能

#### カテゴリ: 報酬配布要件
- **確定度**: 100%
- **課題**: なし
- **実装準備状況**: 実装可能（既存の報酬配布システムを利用）

#### カテゴリ: API実行要件
- **確定度**: 100%
- **課題**: なし
- **実装準備状況**: 実装可能

#### カテゴリ: ログ記録要件
- **確定度**: 100%
- **課題**: なし
- **実装準備状況**: 実装可能

#### カテゴリ: ミッション連携要件
- **確定度**: 100%
- **課題**: なし
- **実装準備状況**: 実装可能（アイテム使用ミッションは実装不要と確定）

---

## 10. 次のステップ

### 10.1 要件確定のために必要なアクション

- [x] プランナー確認完了（Q1-Q4の回答取得済み）
- [x] サーバー側の技術的判断完了（ItemType、API設計）
- [x] 全ての不明点が解決
- [x] 実装仕様が100%確定

### 10.2 実装設計へ向けて

- [ ] **Stage 6: API設計書の作成**
  - APIエンドポイント仕様（既存 `/api/item/consume` の拡張）
  - リクエスト/レスポンス詳細仕様
  - エラーレスポンス仕様

- [ ] **DB設計**
  - glow-schema変更（ItemType追加）
  - マスタデータ設計（スタミナ回復アイテムのアイテムマスタ）

- [ ] **クライアント側との仕様共有**
  - API仕様書の共有
  - UI側での上限制御仕様の共有（Q2の回答を反映）
  - 満タン時のUI挙動の共有（Q1の回答を反映）

- [ ] **実装・テスト**
  - ItemType定義追加（0.5日）
  - ItemService::applyStaminaRecovery() 実装（1.0日）
  - バリデーション実装（0.5日）
  - テスト実装（Unit/Feature）（1.0日）
  - 動作確認・結合テスト（0.5日）
  - **合計見積もり**: 約3.5日

---

## 11. 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025-11-27 | 初版作成（全ドキュメントの統合） | Stage 5 Agent |

---

## 12. 参照情報

### 12.1 参照ドキュメント
- 01_サーバー要件抽出.md: 初期要件の洗い出し
- 02_サーバー要件_コード調査追記.md: 既存実装との関連情報
- 03_サーバー仕様レビュー.md: 専門家レビューによる不明点の指摘
- 04_ゲーム体験仕様確認結果まとめ.md: プランナー確認による仕様確定
- 03_2_サーバー仕様レビュー_プランナー仕様確認結果.md: Q1-Q4の回答

### 12.2 主要な設計判断
1. **ItemType定義**: 新規ItemType `StaminaRecoveryPercent` を追加（既存Etc種別は使用しない）
2. **API設計**: 既存 `/api/item/consume` APIを拡張（新規API作成は不要）
3. **満タン時の挙動**: 使用不可（既存のスタミナ購入と同じ挙動）
4. **上限超過時の挙動**: UI側で上限を超えない個数のみ選択可能
5. **自動選択機能**: 実装しない
6. **使用回数制限**: 実装しない
7. **アイテム使用ミッション**: 実装しない
8. **回復率の指定方式**: `mst_items.effect_value` でパーセンテージを指定（例: "50" = 50%回復）
9. **段階的実装**: Phase 1で `StaminaRecoveryPercent`（パーセンテージ回復）のみ実装、将来必要時に `StaminaRecoveryFixed`（固定量回復）を追加

### 12.3 既存実装との統合ポイント
- スタミナ回復計算ロジックは UserBuyStaminaService::calcAddStamina() を参考に実装
- 回復パーセンテージは `mst_items.effect_value` から取得
- 報酬配布は RewardDelegator → ItemSendService の既存フローを利用
- アイテム使用は ItemService::apply() への分岐追加で対応
- ログ記録は LogStaminaRepository, LogItemRepository の既存実装を利用
