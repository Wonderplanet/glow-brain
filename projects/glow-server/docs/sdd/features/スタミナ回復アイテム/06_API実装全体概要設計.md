# API実装全体概要設計

## 1. ドキュメント情報
- 対象機能: スタミナ回復アイテム
- 作成日: 2025-11-27
- 参照ドキュメント: 05_サーバーAPI要件書.md

## 2. API実装全体像

### 2.1 関連するAPIエンドポイント一覧

| エンドポイント | 種別 | 関連要件ID | 概要 |
|-------------|------|-----------|------|
| POST /api/item/consume | 既存改修 | REQ-API-1, REQ-API-2 | アイテム使用（スタミナ回復処理を追加） |

**備考:**
- スタミナ回復アイテム機能の実現には、新規APIエンドポイントの作成は不要
- 既存の `/api/item/consume` APIを拡張することで、全要件を実現可能
- 報酬配布（ログインボーナス、ミッション、イベント等）は、既存の報酬配布システム（RewardDelegator）を利用

### 2.2 新規作成APIエンドポイント

**なし**

すべての要件は既存APIの改修で実現可能。

### 2.3 既存API改修エンドポイント

#### POST /api/item/consume
- **関連要件:** REQ-API-1, REQ-API-2, REQ-ITEM-3, REQ-STA-1〜5, REQ-LOG-1〜2
- **現在の機能:** アイテム使用（ランダムかけらBOX、キャラかけらの交換処理）
- **改修内容:**
  1. **ItemService::apply() への分岐追加**
     - ItemType::STAMINA_RECOVERY_PERCENT の case 分岐を追加
     - スタミナ回復処理の専用メソッドを呼び出す
  2. **スタミナ回復処理の実装**
     - 自然回復適用（REQ-STA-2）
     - スタミナ満タンチェック（REQ-STA-3）
     - マスタデータの `effect_value` から回復パーセンテージを取得
     - 回復量計算（REQ-STA-1）: `floor(スタミナ上限値 × effect_value / 100)`
     - システム上限チェック（REQ-STA-4）
     - スタミナ加算（REQ-STA-5）
     - アイテム消費（REQ-ITEM-3）
     - ログ記録（REQ-LOG-1, REQ-LOG-2）
  3. **レスポンスへのスタミナ値反映**
     - 使用後のユーザーパラメータ（スタミナ値を含む）をレスポンスに含める
- **改修理由:**
  - スタミナ回復アイテムは、既存のアイテム管理システム（ItemType定義、所持数管理、消費処理）の枠組みで管理できる
  - ItemService::apply() のアイテム種別別処理パターンに、スタミナ回復処理を追加することで対応可能
  - 新規API作成は不要であり、既存の設計パターンを踏襲することで一貫性を保つ

## 3. 要件とAPIの対応関係

### 3.1 要件 REQ-ITEM-1: スタミナ回復アイテムの種別定義
- **実現に必要なAPI:** なし（glow-schema変更のみ）
- **実装概要:**
  - glow-schema/Schema/Item.yml に ItemType::STAMINA_RECOVERY_PERCENT を追加
  - api/app/Domain/Item/Enums/ItemType.php に自動生成される
  - `mst_items.effect_value` に回復パーセンテージを設定（例: "50" = 50%回復）
- **備考:**
  - API実装には影響しない（マスタデータ定義のみ）
  - **段階的実装:** 将来的に `StaminaRecoveryFixed`（固定量回復）を追加する際は、別のItemTypeとして定義する

### 3.2 要件 REQ-ITEM-2: アイテム所持数管理
- **実現に必要なAPI:** なし（既存実装で対応可能）
- **実装概要:**
  - UsrItemService::addItemByRewards() で所持数加算（報酬配布時）
  - UsrItemService::consumeItems() で所持数減算（アイテム使用時）
- **備考:** 既存のアイテム管理機能をそのまま利用

### 3.3 要件 REQ-ITEM-3: アイテム消費処理
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - ItemService::apply() からスタミナ回復処理を呼び出す際、UsrItemService::consumeItems() でアイテムを消費
  - 消費前の所持数チェックを実施（所持数不足時はエラー）
- **備考:** 既存のアイテム消費ロジックを利用

### 3.4 要件 REQ-STA-1: スタミナ回復量の計算
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - マスタデータの `effect_value` から回復パーセンテージを取得
  - スタミナ回復処理内で、UserBuyStaminaService::calcAddStamina() と同様のロジックで回復量を計算
  - 計算式: `floor(スタミナ上限値 × effect_value / 100) × 使用個数`
  - ショップパス効果を含めた上限値を基準とする
- **備考:** 既存の広告視聴スタミナ購入と同様の計算ロジックを参考に実装。effect_valueでパーセンテージを可変にすることで、異なる回復率のアイテムを追加可能

### 3.5 要件 REQ-STA-2: 自然回復の適用
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - スタミナ回復処理の最初に、UserService::recoveryStamina() を呼び出して自然回復を適用
  - 最新のスタミナ値を取得してから、アイテムによる回復量を加算
- **備考:** 既存のスタミナ関連処理の標準パターンを踏襲

### 3.6 要件 REQ-STA-3: スタミナ満タン時の使用制限
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - 自然回復適用後、現在スタミナがスタミナ上限値以上の場合、ErrorCode::USER_STAMINA_FULL を返す
  - エラー時はアイテムを消費しない
- **備考:** 既存のスタミナ購入機能と同じエラーハンドリング

### 3.7 要件 REQ-STA-4: システム上限値制御
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - 現在スタミナ + 回復量の合計が UserConstant::MAX_STAMINA（999）を超える場合、999で打ち切る
  - `min(現在スタミナ + 回復量, 999)` で制限
- **備考:** UI側で上限を超えない個数のみ選択可能だが、サーバー側でも二重チェックを実施

### 3.8 要件 REQ-STA-5: スタミナ加算処理
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - UserService::addStamina() またはUsrUserParameter::setStamina() でスタミナ値を更新
  - スタミナ更新時刻（stamina_updated_at）を記録
- **備考:** 既存のスタミナ更新ロジックを利用

### 3.9 要件 REQ-REWARD-1〜4: 報酬配布（ログインボーナス、ミッション、イベント、お詫び）
- **実現に必要なAPI:** なし（既存実装で対応可能）
- **実装概要:**
  - RewardDelegator → ItemSendService の既存フローを利用
  - スタミナ回復アイテムを ItemReward として配布
  - 各配布経路（ログインボーナス、ミッション、イベント等）で利用可能
- **備考:** API改修は不要、マスタデータ設定のみで対応可能

### 3.10 要件 REQ-REWARD-5: 報酬配布時の上限処理
- **実現に必要なAPI:** なし（既存実装で対応可能）
- **実装概要:**
  - UsrItemService::addItemByRewards() で所持数上限チェックを実施
  - 上限超過分は廃棄され、UnreceivedRewardReason::RESOURCE_OVERFLOW_DISCARDED が設定される
- **備考:** 既存のアイテム配布上限処理を利用

### 3.11 要件 REQ-LOG-1: アイテム消費ログ
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - UsrItemService::consumeItems() 内で LogItemRepository::log() を呼び出す
  - LogResourceActionType::USE として記録
  - トリガー情報に「スタミナ回復アイテム使用」を記録
- **備考:** 既存のアイテム消費ログ記録を利用

### 3.12 要件 REQ-LOG-2: スタミナ増加ログ
- **実現に必要なAPI:** POST /api/item/consume（既存改修）
- **実装概要:**
  - スタミナ回復処理内で LogStaminaRepository::log() を呼び出す
  - LogResourceActionType::ADD として記録
  - トリガー情報に「スタミナ回復アイテム使用」「アイテムID」を記録
- **備考:** 既存のスタミナログ記録を利用

### 3.13 要件 REQ-MISSION-1: アイテム獲得時のミッショントリガー
- **実現に必要なAPI:** なし（既存実装で対応可能）
- **実装概要:**
  - UsrItemService::addItemByRewards() 内で ItemMissionTriggerService::sendItemCollectTrigger() が自動的に呼ばれる
  - 「特定のアイテムを獲得する」ミッションに対応
- **備考:** 新規実装不要、既存の仕組みで自動対応

### 3.14 要件 REQ-MISSION-2: アイテム使用時のミッショントリガー（実装不要）
- **実現に必要なAPI:** なし
- **実装概要:** なし（実装不要）
- **備考:** プランナー確認により、アイテム使用ミッションは実装しないことが確定

## 4. 既存APIだけでは実現困難な項目

**なし**

すべての要件は既存APIの改修で実現可能。

### 4.1 既存APIの改修で対応可能な理由

#### 4.1.1 ItemService::apply() の拡張性
- 既存のItemService::apply() メソッドは、アイテム種別別の処理分岐を持つ設計
- ItemType に応じて switch 文で処理を振り分ける構造
- STAMINA_RECOVERY の case 分岐を追加することで、スタミナ回復処理を自然に組み込める

#### 4.1.2 既存のスタミナ管理機能との統合
- UserService::recoveryStamina()（自然回復）
- UserBuyStaminaService::calcAddStamina()（回復量計算）
- UserService::addStamina()（スタミナ加算）
- これらの既存実装を組み合わせることで、スタミナ回復処理を実現できる

#### 4.1.3 報酬配布システムの汎用性
- RewardDelegator は、アイテム種別に依存しない汎用的な報酬配布システム
- スタミナ回復アイテムも ItemReward として扱うことで、既存の配布経路（ログインボーナス、ミッション、イベント等）で自動的に配布可能

#### 4.1.4 ログ記録の統一性
- LogItemRepository、LogStaminaRepository の既存実装を利用
- アイテム消費とスタミナ増加のログを統一的に記録できる

## 5. 実装優先順位

### 5.1 優先度：高（基盤となる実装）
1. **glow-schema変更** - ItemType::STAMINA_RECOVERY_PERCENT の定義追加（最優先）
2. **ItemService::apply() 改修** - スタミナ回復処理の実装（中核機能）

### 5.2 優先度：中（連動機能の確認）
1. **報酬配布の動作確認** - 既存の報酬配布システムでスタミナ回復アイテムが配布できることを確認
2. **ログ記録の動作確認** - アイテム消費ログとスタミナ増加ログが正しく記録されることを確認

### 5.3 実装順序の推奨

#### Phase 1: 基盤構築（1日目）
1. glow-schema変更（ItemType::STAMINA_RECOVERY_PERCENT 追加）
2. マスタデータ設計（スタミナ回復アイテムのアイテムマスタ、effect_value設定）
3. ItemService::apply() へのスタミナ回復処理追加

#### Phase 2: 詳細実装（2日目）
1. effect_valueからの回復パーセンテージ取得ロジック実装
2. スタミナ回復量計算ロジック実装
3. スタミナ満タンチェック実装
4. システム上限チェック実装
5. ログ記録処理実装

#### Phase 3: テスト・動作確認（3日目）
1. Unit/Featureテスト実装
2. 報酬配布の動作確認
3. 結合テスト

#### Phase 4: リリース準備（0.5日目）
1. マスタデータ設定
2. クライアント側との仕様共有
3. 最終確認

**合計見積もり:** 約3.5日

---

## 6. API実装の全体方針

### 6.1 設計方針
- **既存実装の活用を最優先**
  - 新規APIエンドポイントは作成しない
  - 既存のアイテム管理システムの枠組みを活用
  - 既存のスタミナ管理機能を再利用

- **一貫性の維持**
  - ItemService::apply() のアイテム種別別処理パターンを踏襲
  - 既存のエラーハンドリング、ログ記録パターンを踏襲
  - 既存の報酬配布システムとの統合

- **拡張性の確保**
  - `effect_value` でパーセンテージを可変にすることで、異なる回復率のアイテムを追加可能
  - **段階的実装の方針:**
    - Phase 1: `StaminaRecoveryPercent`（パーセンテージ回復）のみ実装
    - Phase 2: 将来必要時に `StaminaRecoveryFixed`（固定量回復）を別のItemTypeとして追加
  - ItemType定義による種別管理で、柔軟な拡張が可能

### 6.2 リスクと対応策

#### リスク1: 既存のアイテム消費処理への影響
- **リスク内容:** ItemService::apply() の改修が既存のアイテム消費処理に影響を与える可能性
- **対応策:**
  - スタミナ回復処理は独立した case 分岐として実装
  - 既存のアイテム種別（RANDOM_FRAGMENT_BOX, CHARACTER_FRAGMENT等）の処理には一切変更を加えない
  - 既存のテストケースが全て通ることを確認

#### リスク2: スタミナ満タンエラーの頻発
- **リスク内容:** UI側の実装が不十分な場合、スタミナ満タンエラーが頻発する可能性
- **対応策:**
  - クライアント側に満タン時のUI制御仕様を明確に共有
  - サーバー側でエラーログを監視し、UI側の実装品質を確認

#### リスク3: システム上限超過の廃棄処理
- **リスク内容:** UI側の個数制御が不十分な場合、回復量が999を超えて廃棄される可能性
- **対応策:**
  - クライアント側に使用可能個数計算ロジックを明確に共有
  - サーバー側では min 関数で999に制限（廃棄処理は発生しない設計）

### 6.3 実装上の注意点

#### 注意点1: トランザクション管理
- アイテム消費とスタミナ加算は同一トランザクション内で実行
- ログ記録もトランザクション内で完了させる
- 中途半端な状態を残さないことを保証

#### 注意点2: 自然回復の適用タイミング
- スタミナ回復処理の最初に必ず自然回復を適用
- 最新のスタミナ値で満タンチェックを実施
- 自然回復の適用忘れによる不整合を防ぐ

#### 注意点3: ショップパス効果の考慮
- スタミナ上限値の計算時、ショップパス効果を含める
- UserBuyStaminaService::calcAddStamina() の実装を参考にする

---

## 7. まとめ

### 7.1 API実装全体の特徴
- **新規APIエンドポイントは不要**: 既存の `/api/item/consume` の拡張で全要件を実現
- **既存実装の活用**: 報酬配布、スタミナ管理、ログ記録など、既存の仕組みを最大限活用
- **一貫性の維持**: 既存のアイテム種別別処理パターンを踏襲し、設計の一貫性を保つ
- **低リスク**: 既存のAPIに影響を与えない独立した実装が可能
- **拡張性**: `effect_value` でパーセンテージを可変にし、将来的に異なる回復率のアイテムを追加可能

### 7.2 実装の中心となるポイント
- **ItemService::apply() の拡張**: STAMINA_RECOVERY_PERCENT の case 分岐追加
- **effect_value の活用**: マスタデータから回復パーセンテージを取得して計算に使用
- **スタミナ回復処理の実装**: 自然回復、満タンチェック、回復量計算、上限チェック、スタミナ加算、ログ記録

### 7.3 段階的実装の方針
- **Phase 1（今回のリリース）:**
  - `ItemType::STAMINA_RECOVERY_PERCENT` を追加
  - `effect_value` でパーセンテージを指定（現状は50%で設定）
  - マスタデータで異なるパーセンテージのアイテムも追加可能
- **Phase 2（将来必要時）:**
  - `ItemType::STAMINA_RECOVERY_FIXED` を追加
  - 固定量回復アイテムに対応
  - effect_value で固定回復量を指定

### 7.4 次のステップ
- **Stage 7: サーバーAPI機能要件実装設計**
  - ItemService::apply() の詳細設計
  - effect_value からの回復パーセンテージ取得ロジック
  - スタミナ回復処理の詳細フロー設計
  - DB設計（マイグレーション）
  - テスト設計
