# スタミナ回復アイテム 実装計画書

## 1. 概要

本ドキュメントは、スタミナ回復アイテム機能の実装計画を記載します。
07_サーバーAPI設計書.md と 08_サーバーAPI機能要件実装設計.md に基づいて実装を進めます。

## 2. 現状分析

### 2.1 glow-schema 状況

- `glow-schema/Schema/Item.yml` に `StaminaRecoveryPercent` が **既に追加済み**
- glow-schemaの変更は不要

### 2.2 glow-server 状況

| ファイル | 現状 | 必要な対応 |
|---------|------|-----------|
| `api/app/Domain/Item/Enums/ItemType.php` | `StaminaRecoveryPercent` 未定義 | case追加が必要 |
| `api/app/Domain/Item/Services/ItemService.php` | `STAMINA_RECOVERY_PERCENT` 分岐なし | apply()へのcase追加、applyStaminaRecoveryPercent()メソッド追加 |
| `api/app/Domain/Resource/Log/Enums/LogResourceTriggerSource.php` | `ITEM_STAMINA_RECOVERY` 未定義 | case追加が必要 |
| LogTriggerクラス | 未作成 | 新規作成が必要 |

### 2.3 参照実装

- `api/app/Domain/User/Services/UserBuyStaminaService.php`
  - `calcAddStamina()` メソッドのスタミナ回復量計算ロジックを参考にする
  - スタミナ満タンチェック、システム上限チェックのパターンを踏襲

---

## 3. 実装タスク一覧

### Phase 1: 基盤実装

| No | タスク | ファイル | 作業内容 | 依存 |
|----|-------|---------|---------|------|
| 1-1 | ItemType Enum追加 | `api/app/Domain/Item/Enums/ItemType.php` | `STAMINA_RECOVERY_PERCENT` caseと`label()`を追加 | なし |
| 1-2 | LogResourceTriggerSource追加 | `api/app/Domain/Resource/Log/Enums/LogResourceTriggerSource.php` | `ITEM_STAMINA_RECOVERY` caseを追加 | なし |
| 1-3 | LogTriggerクラス作成 | `api/app/Domain/Resource/Entities/LogTriggers/ItemStaminaRecoveryLogTrigger.php` | 新規クラス作成 | 1-2 |

### Phase 2: コア機能実装

| No | タスク | ファイル | 作業内容 | 依存 |
|----|-------|---------|---------|------|
| 2-1 | ItemService依存性追加 | `api/app/Domain/Item/Services/ItemService.php` | コンストラクタにUserService, MstUserLevelRepository, ShopPassEffectDelegator, LogStaminaRepositoryを追加 | 1-1~1-3 |
| 2-2 | ItemService::apply()拡張 | `api/app/Domain/Item/Services/ItemService.php` | switch文に`STAMINA_RECOVERY_PERCENT` caseを追加 | 2-1 |
| 2-3 | applyStaminaRecoveryPercent()実装 | `api/app/Domain/Item/Services/ItemService.php` | スタミナ回復処理の実装 | 2-2 |
| 2-4 | calculateMaxStamina()実装 | `api/app/Domain/Item/Services/ItemService.php` | スタミナ上限計算のプライベートメソッド | 2-3 |
| 2-5 | ItemServiceProvider更新 | `api/app/Providers/Domain/ItemServiceProvider.php` | DIコンテナへの依存関係追加 | 2-1 |

### Phase 3: テスト実装

| No | タスク | ファイル | 作業内容 | 依存 |
|----|-------|---------|---------|------|
| 3-1 | ユニットテスト作成 | `api/tests/Unit/Domain/Item/Services/ItemServiceTest.php` | applyStaminaRecoveryPercent()のテスト | Phase 2完了 |
| 3-2 | 機能テスト作成 | `api/tests/Feature/Domain/Item/Services/ItemServiceTest.php` | スタミナ回復アイテム使用の機能テスト | Phase 2完了 |
| 3-3 | シナリオテスト作成 | `api/tests/Feature/Http/Controllers/Api/V1/Game/Item/ItemControllerTest.php` | /api/item/consume エンドポイントテスト | Phase 2完了 |

### Phase 4: 品質チェック・動作確認

| No | タスク | コマンド | 作業内容 | 依存 |
|----|-------|---------|---------|------|
| 4-1 | コード品質チェック | `sail check` | phpcs, phpstan, deptrac, phpunit | Phase 3完了 |
| 4-2 | エラー修正 | - | sail checkで検出されたエラーの修正 | 4-1 |
| 4-3 | 動作確認 | - | ローカル環境でのAPI実行確認 | 4-2 |

---

## 4. 詳細実装ガイド

### 4.1 Phase 1-1: ItemType Enum追加

**ファイル:** `api/app/Domain/Item/Enums/ItemType.php`

```php
// ETC の前に追加
// スタミナ回復アイテム（パーセンテージ指定）
case STAMINA_RECOVERY_PERCENT = 'StaminaRecoveryPercent';

// label() メソッドに追加
self::STAMINA_RECOVERY_PERCENT => 'スタミナ回復アイテム（%指定）',
```

### 4.2 Phase 1-2: LogResourceTriggerSource追加

**ファイル:** `api/app/Domain/Resource/Log/Enums/LogResourceTriggerSource.php`

```php
// アイテム系の末尾に追加
// スタミナ回復アイテム使用
case ITEM_STAMINA_RECOVERY = 'ItemStaminaRecovery';
```

### 4.3 Phase 1-3: LogTriggerクラス作成

**ファイル:** `api/app/Domain/Resource/Entities/LogTriggers/ItemStaminaRecoveryLogTrigger.php`

```php
<?php

declare(strict_types=1);

namespace App\Domain\Resource\Entities\LogTriggers;

use App\Domain\Resource\Log\Enums\LogResourceTriggerSource;

class ItemStaminaRecoveryLogTrigger extends LogTrigger
{
    public function __construct(
        private string $mstItemId,
        private int $consumeAmount,
        private int $addStamina,
    ) {
        parent::__construct(LogResourceTriggerSource::ITEM_STAMINA_RECOVERY);
    }

    public function getLogTriggerData(): array
    {
        return [
            'trigger_source' => $this->triggerSource->value,
            'mst_item_id' => $this->mstItemId,
            'consume_amount' => $this->consumeAmount,
            'add_stamina' => $this->addStamina,
        ];
    }
}
```

### 4.4 Phase 2-1~2-4: ItemService改修

**コンストラクタ追加:**

```php
use App\Domain\User\Services\UserService;
use App\Domain\User\Constants\UserConstant;
use App\Domain\Shop\Delegators\ShopPassEffectDelegator;
use App\Domain\Resource\Log\Repositories\LogStaminaRepository;

public function __construct(
    // ... 既存の引数 ...
    // 以下を追加
    private UserService $userService,
    private ShopPassEffectDelegator $shopPassEffectDelegator,
    private LogStaminaRepository $logStaminaRepository,
) {
}
```

**apply()メソッドへのcase追加:**

```php
case ItemType::STAMINA_RECOVERY_PERCENT->value:
    // スタミナ回復アイテム処理（パーセンテージ指定）
    $this->applyStaminaRecoveryPercent(
        $userId,
        $mstItem,
        $amount,
        $now
    );
    break;
```

**applyStaminaRecoveryPercent()メソッド:**
- 08_サーバーAPI機能要件実装設計.md のセクション3.1.5の実装例を参照

---

## 5. 実装順序とチェックポイント

### 5.1 Phase 1 完了チェック

- [ ] `ItemType::STAMINA_RECOVERY_PERCENT` が追加された
- [ ] `ItemType::label()` に対応するラベルが追加された
- [ ] `LogResourceTriggerSource::ITEM_STAMINA_RECOVERY` が追加された
- [ ] `ItemStaminaRecoveryLogTrigger` クラスが作成された

### 5.2 Phase 2 完了チェック

- [ ] ItemServiceのコンストラクタに依存関係が追加された
- [ ] ItemServiceProvider.phpが更新された
- [ ] `ItemService::apply()` に `STAMINA_RECOVERY_PERCENT` のcase分岐が追加された
- [ ] `applyStaminaRecoveryPercent()` メソッドが実装された
- [ ] `calculateMaxStamina()` メソッドが実装された
- [ ] 以下の処理が正しく実装されている:
  - 自然回復の適用
  - スタミナ満タンチェック（USER_STAMINA_FULL）
  - スタミナ回復量計算（effect_valueからパーセンテージ取得）
  - システム上限チェック（999で打ち切り）
  - アイテム消費
  - スタミナ加算
  - ログ記録

### 5.3 Phase 3 完了チェック

- [ ] ユニットテストが作成された
  - 正常系: effect_value=50で50%回復
  - 正常系: amount=3で3個消費、3倍の回復量
  - 異常系: スタミナ満タン時のエラー
  - 異常系: 所持数不足時のエラー
  - 異常系: システム上限で打ち切り
- [ ] 機能テストが作成された
- [ ] シナリオテストが作成された

### 5.4 Phase 4 完了チェック

- [ ] `sail check` が全てパスする
  - [ ] phpcs: エラーなし
  - [ ] phpcbf: 自動修正完了
  - [ ] phpstan: エラーなし
  - [ ] deptrac: アーキテクチャ違反なし
  - [ ] phpunit: 全テストパス
- [ ] ローカル環境での動作確認完了

---

## 6. 実装上の注意事項

### 6.1 重要な仕様ポイント

1. **スタミナ満タンチェックは自然回復後に行う**
   - UserService::recoveryStamina()を先に呼び出す
   - 自然回復後のスタミナ値でチェック

2. **回復量計算はeffect_valueから取得**
   - mst_items.effect_valueに回復パーセンテージが設定されている
   - 計算式: `floor(スタミナ上限 × effect_value / 100) × amount`

3. **システム上限超過時は999で打ち切り、エラーにしない**
   - 07設計書の方針に従う
   - min関数で999以下に制限

### 6.2 既存コードとの整合性

- `UserBuyStaminaService::calcAddStamina()` のロジックを参考にする
- 同様のエラーコード（USER_STAMINA_FULL）を使用
- トランザクション制御はUseCase層（ItemConsumeUseCase）で行われる

### 6.3 コーディング規約

- DB接頭辞付き変数命名（`$mstItem`, `$usrUserParameter`等）
- return arrayは禁止、EntityまたはValue Objectを返却
- privateメソッドのPHPDocは簡潔に

---

## 7. スキル・サブエージェント活用

実装時に以下のスキル/サブエージェントを活用する:

| フェーズ | スキル/サブエージェント | 用途 |
|---------|----------------------|------|
| Phase 1-2 | `domain-layer` スキル | ドメインレイヤーの実装パターン参照 |
| Phase 3 | `api-test-implementation` スキル | テストコード実装 |
| Phase 3 | `api-test-runner` サブエージェント | テスト実行と自動修正 |
| Phase 4 | `sail-check-fixer` スキル | 品質チェックとエラー修正 |
| Phase 4 | `api-phpstan-fixer` サブエージェント | 静的解析エラー修正 |
| Phase 4 | `api-phpcs-phpcbf-fixer` サブエージェント | コーディング規約違反修正 |
| Phase 4 | `api-deptrac-fixer` サブエージェント | アーキテクチャ違反修正 |

---

## 8. 見積もり

| フェーズ | 作業内容 | 見積もり |
|---------|---------|---------|
| Phase 1 | 基盤実装（Enum追加、LogTrigger作成） | 0.5日 |
| Phase 2 | コア機能実装（ItemService改修） | 1日 |
| Phase 3 | テスト実装 | 1日 |
| Phase 4 | 品質チェック・動作確認 | 0.5日 |
| **合計** | | **3日** |

---

## 9. リスクと対策

| リスク | 影響 | 対策 |
|-------|------|------|
| ItemServiceの依存関係追加による影響 | 既存テストが失敗する可能性 | ItemServiceProviderの更新を忘れずに行う |
| スタミナログ記録の実装漏れ | ログが記録されない | UserService::addStamina()がログを記録しない場合、applyStaminaRecoveryPercent()内で明示的に記録 |
| deptracアーキテクチャ違反 | ItemドメインからUserドメインへの依存が違反となる可能性 | 既存のItemService依存関係を確認し、必要に応じてDelegator経由にする |

---

## 10. 次のアクション

1. **Phase 1を開始**: ItemType Enum追加から着手
2. 各フェーズ完了後に上記チェックリストを確認
3. `sail check` で問題が検出された場合は専用スキル/サブエージェントで修正
4. 全てのチェックがパスしたらPR作成
