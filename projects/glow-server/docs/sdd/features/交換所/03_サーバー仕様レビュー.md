# サーバー実装観点の仕様レビュー（自動分析レポート）：交換所

## 1. 要約

### 現時点での仕様の明瞭さ/不明瞭さの総評

**明瞭な部分:**
- 交換所の基本的なUI構造（一覧画面、ラインナップ画面、交換確認ダイアログ）は明確に定義されている
- 交換所のカテゴリー（通常交換所、イベント交換所、キャラのかけらBOX交換所）は明示されている
- 交換ラインナップごとの設定項目（交換アイテム、必要リソース、期間、上限数）は概ね明確

**不明瞭な部分:**
- 複数の交換所を統括する「交換所システム」全体の構造が不明瞭（交換所マスタ、ラインナップマスタの階層関係）
- 月次リセット（毎月初日04:00）の実装方式（バッチ vs リクエスト時判定）が未定義
- 複数リソース消費の仕様が「可能性」として言及されているが確定していない
- キャラのかけらBOX交換所を「そのまま持ってくる」と記載されているが、交換所の枠組み内での統合方法が不明
- アイテムBOXの整理（タブ分類）と交換所機能の実装優先度・依存関係が不明

### 大きなリスク・不確定要素の概要

1. **マスタデータ構造の未確定**: 交換所マスタとラインナップマスタの関係性、復刻時のIDの切り直し方法が不明確
2. **月次リセットの実装方式**: バッチ処理か、リクエスト時判定かが決まっていない（運用・パフォーマンスに影響）
3. **既存機能との統合範囲**: キャラのかけらBOX交換所を新しい交換所システムにどこまで統合するか不明
4. **複数リソース消費の実装有無**: 「複数リソース消費が必要なら +3人日」と記載されているが、実装するか否かが未決定
5. **アイテムBOX整理との関係**: アイテムBOX整理（第一希望案 or 第二希望案）の採用可否と実装順序が不明

## 2. 仕様の詳細化（サーバー観点）

### 2.1. 交換所の基本構造

#### 交換所マスタ（想定）
- **交換所ID** (mst_exchange_id): 各交換所を一意に識別するID
- **交換所名** (name): 交換所の表示名（例: 「通常交換所」「ダンダダンいいジャン祭交換所」）
- **交換所カテゴリー** (category): NORMAL（通常）, EVENT（イベント）, FRAGMENT_BOX（キャラのかけらBOX）
- **開催期間** (start_at, end_at): 交換所自体の表示期間（NULLの場合は無期限）
- **バナー画像URL** (banner_url): 交換所一覧画面に表示するバナー画像のパス
- **表示順** (sort_order): 交換所一覧画面での表示順序
- **有効フラグ** (is_active): 無効化された交換所は一覧に表示しない

#### 交換所ラインナップマスタ（想定）
- **ラインナップID** (mst_exchange_lineup_id): 各ラインナップを一意に識別するID
- **所属交換所ID** (mst_exchange_id): どの交換所に属するか
- **交換アイテム種別** (reward_type): ITEM, UNIT, ART, EMBLEM, PRISM, COIN
- **交換アイテムID** (reward_id): 交換対象のリソースID（アイテムIDやユニットID）
- **交換アイテム個数** (reward_amount): 1回の交換で得られる個数
- **必要リソース種別** (cost_type): ITEM, COIN
- **必要リソースID** (cost_id): 消費するリソースのID
- **必要リソース個数** (cost_amount): 1回の交換で消費する個数
- **交換期間** (start_at, end_at): ラインナップごとの交換可能期間（NULLの場合は無期限）
- **交換上限数** (limit_count): ユーザーごとの交換可能回数（NULLの場合は無制限）
- **リセット周期** (reset_type): NONE（リセットなし）, DAILY, WEEKLY, MONTHLY
- **表示順** (sort_order): ラインナップ画面での表示順序

#### ユーザー交換履歴（想定）
- **ユーザーID** (usr_user_id)
- **ラインナップID** (mst_exchange_lineup_id)
- **現在期間内の交換回数** (exchange_count): リセット周期に応じてリセットされる
- **累計交換回数** (exchange_total_count): リセットされない累計値
- **最終リセット日時** (last_reset_at): 最後にリセットされた日時
- **プライマリキー**: (usr_user_id, mst_exchange_lineup_id)

### 2.2. 交換処理のフロー

1. **交換所一覧取得**
   - 現在時刻で有効な交換所マスタを全件取得
   - 開催期間が未設定またはNULLの場合は無期限として扱う
   - 開催期間外またはis_active=falseの交換所は非表示

2. **交換所ラインナップ取得**
   - 指定された交換所IDに属するラインナップを全件取得
   - 各ラインナップの交換期間（start_at/end_at）をチェック
   - 期間外のラインナップは非表示
   - ユーザーの交換履歴と突合し、残り交換可能回数を算出

3. **交換実行**
   1. ラインナップマスタ取得（有効期間チェック）
   2. ユーザー交換履歴取得 or 新規作成
   3. リセット周期に応じた自動リセット判定・実行
   4. 交換上限チェック（limit_count != NULL の場合）
   5. 必要リソースの所持数チェック
   6. トランザクション開始
      - 必要リソースの消費
      - 交換アイテムの付与（RewardDelegator経由）
      - 交換回数のインクリメント
      - 交換ログの記録
   7. トランザクションコミット
   8. レスポンス返却（交換後の所持数、残り回数）

### 2.3. 月次リセット処理

**仕様書の記載:**
> 通常交換所：アイテムの交換期間は1ヶ月毎で自動リセットになります。毎月初日の04:00にリセットされます。

**サーバー観点での詳細化:**
- リセット方式: リクエスト時判定方式（既存のショップアイテムと同様）
  - 交換実行時に`last_reset_at`を確認
  - 最終リセット日時が前月以前の場合、`exchange_count`を0にリセット
  - `last_reset_at`を現在時刻で更新
- バッチ処理は不要（リクエスト時に自動判定されるため）
- リセット判定ロジック: `Clock::isFirstMonth($last_reset_at)`のような判定メソッドを使用

### 2.4. 原画交換時の特殊処理

**仕様書の記載:**
> 原画を交換所でラインナップに設定する場合は、原画のかけら単位での設定はできません。
> 交換すると、既存の原画のかけら演出がかけら16ピース分再生されます。

**サーバー観点での詳細化:**
- 原画アイテムは`reward_type=ART`として設定
- `reward_amount`は常に1（原画完成品として付与）
- クライアント側で16ピース演出を再生するため、サーバーからは演出フラグを返却
- 原画のかけらを経由せず、直接完成品を付与する

### 2.5. キャラのかけらBOX交換所の統合

**仕様書の記載:**
> 現状アイテムBOX内にあるキャラのかけらをかけらBOXに交換する交換所になりますが、それをそのままここに持ってきたものになります。

**サーバー観点での詳細化（推測を含む）:**
- 既存の`ItemExchangeSelectItemUseCase`の機能を交換所システムに統合
- 選択型交換の実装:
  - 消費アイテム: かけらBOX（固定）
  - 交換対象: ユーザーが選択したキャラのかけら
  - 選択肢: 全キャラのかけらから選択可能（レアリティごとに異なるBOXが必要？）
- ラインナップマスタでの表現方法が不明（要確認）

## 3. 不明点・曖昧点・判断が必要な項目

### A. 仕様書に記載がなく判断不能な項目

#### A-1: 交換所マスタとラインナップマスタの階層構造
- **該当箇所:** 仕様書全体
- **何が曖昧なのか:**
  - 交換所自体を管理するマスタテーブルが必要かどうか不明
  - ラインナップを交換所にグループ化する方法が不明（交換所IDをラインナップマスタに持たせるのか、別の紐付けテーブルを作るのか）
- **サーバーとして明確化が必要な理由:**
  - マスタデータの構造が決まらないと、DB設計・マイグレーション・マスタ登録画面の実装が進められない

#### A-2: 複数リソース消費の実装有無
- **該当箇所:** Page 11の工数見積もり「※ 複数リソース消費が必要なら + 3」
- **何が曖昧なのか:**
  - 実際に複数リソース消費を実装するか否かが未決定
  - 実装する場合、どのように設定するか（複数のcost_type/cost_id/cost_amountのセットをどう持つか）
- **サーバーとして明確化が必要な理由:**
  - 実装する場合、マスタデータの構造が大きく変わる（JSON配列 or 別テーブル）
  - 実装しない場合、その旨をマスタ設計に反映する必要がある

#### A-3: 復刻時のID切り直しの具体的な方法
- **該当箇所:** Page 6「復刻時は交換所IDを新規で切り直して、設定を行います」
- **何が曖昧なのか:**
  - 復刻時に新しい交換所IDを発番するのか、ラインナップIDを発番するのか
  - 旧交換所のデータを複製して新規IDを割り当てるのか、管理ツールで手動設定するのか
- **サーバーとして明確化が必要な理由:**
  - ユーザー交換履歴の管理方法に影響する（新しいIDなら履歴もリセットされる）
  - 管理ツールの実装方針が決まる

#### A-4: キャラのかけらBOX交換所の選択肢の範囲
- **該当箇所:** Page 6「キャラのかけらBOX交換所」、Page 4の画面遷移図
- **何が曖昧なのか:**
  - かけらBOXを消費して交換できるかけらの選択肢はどの範囲か（全キャラ？ 特定レアリティのみ？）
  - レアリティごとに異なるかけらBOXが存在するのか（URかけらBOX、SSRかけらBOX等）
- **サーバーとして明確化が必要な理由:**
  - ラインナップマスタの設計に影響する
  - 選択肢を動的に生成する必要があるため、マスタからの取得方法を決める必要がある

#### A-5: お知らせ・IGNからの誘導の詳細
- **該当箇所:** Page 11「お知らせ・IGNからの交換所TOP画面への誘導設定を可能にする」
- **何が曖昧なのか:**
  - 特定の交換所に直接遷移させるのか、交換所一覧画面に遷移させるのか
  - 特定の交換所に遷移させる場合、どのようなパラメータを渡すのか（交換所ID？ ディープリンク？）
- **サーバーとして明確化が必要な理由:**
  - お知らせやIGNのリンク形式を決める必要がある
  - クライアント側の遷移処理とサーバー側のパラメータ検証が必要

### B. 仕様書とコードの不一致

#### B-1: リセット周期の種類
- **該当ファイル:** 仕様書 Page 6 vs コード `ShopService.php`
- **どのように矛盾しているか:**
  - 仕様書では「1ヶ月毎で自動リセット」「毎月初日の04:00にリセット」と記載
  - 既存コードではDAILY, WEEKLYのリセットタイプが存在するが、MONTHLYは未実装
- **影響:**
  - 月次リセットのロジックを新規実装する必要がある
  - 既存のClock serviceに`isFirstMonth`メソッドが存在するか確認が必要

#### B-2: アイテムBOXの整理方針
- **該当ファイル:** 仕様書 Page 9（第一希望案）、Page 10（第二希望案）
- **どのように矛盾しているか:**
  - 仕様書では2つの案が提示されているが、どちらを採用するかが未決定
  - 第一希望案（タブ切り替え）はUI工数が多い
  - 第二希望案（帯名称変更）は既存実装の流用が可能
- **影響:**
  - 採用する案によって、アイテムBOX取得APIの実装方針が変わる
  - 交換所実装との優先度・依存関係が不明

### C. サーバー側で仕様確定が必要な項目

#### C-1: 交換上限のリセット周期と開催期間の関係
- **決める必要がある点:**
  - 交換上限がNULLの場合は無制限だが、リセット周期も設定可能か
  - イベント交換所の場合、開催期間終了後に交換履歴をどう扱うか（削除？ 保持？）
- **プランナーへの確認ポイント:**
  - 「イベント交換所の交換上限は、イベント期間全体で何回まで、という設定ですか？ それとも日次/週次リセットも併用しますか？」
  - 「イベント終了後、次回の復刻時には交換履歴をリセットして良いですか？」

#### C-2: 初回無料や広告視聴による交換の実装有無
- **決める必要がある点:**
  - ショップアイテムのように、初回無料や広告視聴で交換可能なラインナップを用意するか
- **プランナーへの確認ポイント:**
  - 「交換所でも、初回無料や広告視聴で交換できるラインナップを用意する予定はありますか？」

#### C-3: 交換時のミッション・クエストトリガー
- **決める必要がある点:**
  - 「交換所でアイテムを交換する」というミッション条件を設定するか
  - 設定する場合、交換所の種類ごとに別条件とするか（通常交換所での交換、イベント交換所での交換など）
- **プランナーへの確認ポイント:**
  - 「交換所でのアイテム交換をミッション条件に設定する予定はありますか？」

#### C-4: 売却機能の実装優先度
- **決める必要がある点:**
  - アイテムBOXの整理に伴う売却機能を、交換所と同じタイミングで実装するか
  - 売却機能の実装を後回しにする場合、交換所のみ先行実装するか
- **プランナーへの確認ポイント:**
  - 「交換所と売却機能の実装優先度はどうしますか？ 同時実装が必要ですか？」

### D. ゲーム体験的に不自然な可能性がある項目

#### D-1: 月次リセットの実行タイミング
- **問題点:**
  - 仕様書では「毎月初日の04:00にリセット」と記載されているが、リクエスト時判定方式の場合、ユーザーが04:00以降に初めてアクセスした時点でリセットされる
  - 04:00ちょうどにバッチでリセットする場合、ユーザーが04:00前に交換上限に達した後、04:00以降に再度交換できることになる
- **想定される影響:**
  - ユーザーがリセットタイミングを狙って交換を繰り返す可能性がある
  - リセット直後の負荷集中の可能性がある

#### D-2: まとめて交換時の所持数不足
- **問題点:**
  - 仕様書では「交換数は±1、±10、最大、最小で変更できます」と記載
  - 「最大」を選択した際、所持リソース数が不足している場合の挙動が不明
- **想定される影響:**
  - ユーザーが「最大」を選択したが、所持数不足でエラーになる
  - 事前にクライアント側で所持数チェックを行い、「最大」の上限を計算する必要がある

#### D-3: 交換済みラインナップの表示
- **問題点:**
  - 仕様書では「交換上限数が残っていない場合は、ボタンが『交換済み』という表示になりタップできなくなります」と記載
  - 交換済みのラインナップを画面に表示し続けるか、非表示にするかが不明
- **想定される影響:**
  - 表示し続ける場合、画面が交換済みアイテムで埋まる可能性がある
  - 非表示にする場合、ユーザーが「何を交換したか」を確認できない

## 4. プランナーへ確認が必要な項目まとめ（最重要）

### Q1: 交換所の階層構造について
- **質問:** 交換所機能では、「交換所」という大きな括りの下に複数の「ラインナップ」が存在する構造ですが、交換所自体をマスタデータとして管理する必要がありますか？ それともラインナップマスタのみで、交換所はUI上のグループ化だけですか？

### Q2: 複数リソース消費の実装について
- **質問:** 1回の交換で複数種類のリソース（例: コイン1000 + アイテムA 10個）を同時に消費するラインナップを用意する予定はありますか？ 工数見積もりに「複数リソース消費が必要なら +3人日」と記載されていますが、実装の要否を確定させてください。

### Q3: 月次リセットの実行タイミングについて
- **質問:** 通常交換所の月次リセット（毎月初日04:00）は、バッチ処理で一斉にリセットする方式ですか？ それとも、ユーザーが交換実行時に自動判定してリセットする方式ですか？ （後者の場合、04:00以降の初回アクセス時にリセットされます）

### Q4: 復刻時のID切り直しと交換履歴について
- **質問:** イベント交換所を復刻する際、「交換所IDを新規で切り直す」とのことですが、これにより交換履歴もリセットされますか？ それとも、旧交換所の履歴を引き継ぎますか？

### Q5: キャラのかけらBOX交換所の選択肢について
- **質問:** キャラのかけらBOX交換所では、どのキャラのかけらでも選択できますか？ それとも、レアリティごとに異なるBOX（URかけらBOX、SSRかけらBOX等）を用意し、選択肢を制限しますか？

### Q6: アイテムBOX整理案の採用可否
- **質問:** アイテムBOXの整理について、第一希望案（タブ切り替え）と第二希望案（帯名称変更）のどちらを採用しますか？ また、交換所機能の実装と同時に行う必要がありますか？

### Q7: 初回無料や広告視聴による交換
- **質問:** 交換所でも、ショップアイテムと同様に初回無料や広告視聴で交換できるラインナップを用意する予定はありますか？

### Q8: 交換済みラインナップの表示
- **質問:** 交換上限に達したラインナップは、「交換済み」として画面に表示し続けますか？ それとも、非表示にしますか？

### Q9: まとめて交換時の「最大」の挙動
- **質問:** まとめて交換で「最大」を選択した際、交換上限と所持リソースのうち、どちらに合わせて最大値を計算しますか？ （例: 上限10回、所持リソースで5回分しか交換できない場合、「最大」は5回になりますか？）

### Q10: お知らせ・IGNからの誘導先
- **質問:** お知らせやIGNから交換所に誘導する際、特定の交換所に直接遷移させますか？ それとも、交換所一覧画面に遷移させますか？ 特定の交換所に遷移させる場合、どのようなパラメータを使用しますか？

### Q11: イベント交換所の交換上限リセット周期
- **質問:** イベント交換所の交換上限は、イベント期間全体で何回までという設定ですか？ それとも、日次/週次でリセットされる設定も可能にしますか？

### Q12: 交換時のミッション・クエストトリガー
- **質問:** 「交換所でアイテムを交換する」というミッション条件を設定する予定はありますか？ 設定する場合、交換所の種類（通常/イベント）ごとに別条件としますか？

## 5. サーバー開発への影響まとめ

### 実装前に必ず詰めるべき論点

1. **マスタデータ構造の確定**（最優先）
   - 交換所マスタとラインナップマスタの階層関係
   - 複数リソース消費の実装有無
   - キャラのかけらBOX交換所の選択肢の範囲
   - これらが確定しないと、DB設計・マイグレーション・管理ツールの実装が進められない

2. **月次リセットの実装方式**
   - バッチ処理 or リクエスト時判定
   - リセットタイミングに関するユーザー体験への影響

3. **既存機能との統合範囲**
   - キャラのかけらBOX交換所の統合方法
   - アイテムBOX整理の実装タイミング

### 不明点が残る場合のリスク

1. **手戻りリスク**
   - マスタ構造が確定しないままDB設計を進めると、後から大幅な変更が必要になる
   - 複数リソース消費の実装有無が決まらないと、マスタ設計が変わる可能性がある

2. **工数増加リスク**
   - アイテムBOX整理（第一希望案 vs 第二希望案）の選択によって工数が大きく変わる
   - 復刻時のID切り直し方法が不明確だと、管理ツールの実装が複雑化する

3. **ゲーム体験への影響**
   - 月次リセットのタイミングが不明確だと、ユーザーの期待と実際の挙動がズレる
   - 交換済みラインナップの表示/非表示が決まらないと、UI設計が確定しない

### スケジュール・品質への影響

- **マスタ構造の確定遅延**: DB設計・マイグレーション・管理ツール実装が後ろ倒しになる
- **仕様の曖昧さ**: 実装後のテスト段階で仕様確認が発生し、手戻りが生じる
- **既存機能との統合**: キャラのかけらBOX交換所の統合方法が不明確だと、既存コードの修正範囲が見積もれない

**推奨アクション:**
- プランナーへの確認項目（Q1〜Q12）を最優先で解決する
- 特にQ1（交換所の階層構造）、Q2（複数リソース消費）、Q6（アイテムBOX整理案）は即座に確定させる
- 確定後、マスタデータ構造の詳細設計とDB設計を開始する
