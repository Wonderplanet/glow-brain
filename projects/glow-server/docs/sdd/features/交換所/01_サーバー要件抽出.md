# サーバー要件抽出：交換所

## サーバー要件一覧

### 要件1: 交換所一覧の管理
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」
- **抜粋:**
  > 交換所は、交換所一覧画面で複数の独立した交換所を専用バナーで切り替えれる構造とします。
  > 交換所一覧画面に表示可能な交換所バナー数は、無制限になります。
  > 交換所のカテゴリーとしては、以下になります。
  > ・通常交換所：恒常の交換所で開催期間は無期限になります。アイテムの交換期間は1ヶ月毎で自動リセットになります。毎月初日の04:00にリセットされます。
  > ・キャラのかけらBOX交換所
  > ・イベント交換所：イベント（いいジャン祭）の開催期間に合わせた期間で開いている交換所になります。
- **サーバー観点での補足:**
  - 複数の交換所を管理するマスタデータと、各交換所の開催期間・カテゴリー管理が必要
  - 通常交換所の月次自動リセット（毎月初日04:00）のバッチ処理が必要

### 要件2: 交換所の表示制御
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」
- **抜粋:**
  > 交換所一覧画面に表示される交換所バナーは、交換所そのもののIDが設定されていなかったり、開催期間設定箇所が空白や不整合数値設定の場合は表示されません。
  > 開催期間はバナー上に表示をします。
  > 無期限の場合は、「マーク+期限なし」
  > 期限ありの場合は、「マーク+残りdd日tt時間」
- **サーバー観点での補足:**
  - 交換所の表示可否判定ロジックの実装が必要（ID設定、開催期間の妥当性検証）
  - 開催期間の計算とクライアントへの残り時間情報の提供が必要

### 要件3: 復刻時の交換所ID管理
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」の「・復刻時」
- **抜粋:**
  > 復刻時は交換所IDを新規で切り直して、設定を行います。
- **サーバー観点での補足:**
  - 復刻イベント用の交換所データを新規IDで管理する必要がある

### 要件4: 交換所ラインナップの個別設定管理
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」
- **抜粋:**
  > それぞれ個々に設定できるものは以下になります。
  > ・交換アイテムラインナップID設定
  > ・1回の交換で獲得できるアイテムIDとアイテム数
  > ・交換期間（start_dateとend_date）
  > ・交換上限数
  > ・1回交換するのに必要なリソースID（アイテム、コインのいずれか）とリソース数
  > 1ラインナップにつき上記の設定を必ず行う必要があります。
- **サーバー観点での補足:**
  - 各ラインナップの詳細設定を保持するマスタデータ管理が必要
  - 交換アイテム、必要リソース、期間、上限数などの多様な条件管理が必要

### 要件5: 交換期間による表示制御
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」
- **抜粋:**
  > 交換期限は、end_dateの設定内容を表示します。
  > 交換が開始日になっていないラインナップはラインナップ画面自体に表示されません。
- **サーバー観点での補足:**
  - 現在時刻と交換期間（start_date/end_date）を比較し、表示可否を判定する必要がある

### 要件6: 期限・上限のNULL設定対応
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」
- **抜粋:**
  > 期限や上限数に整数ではなくNULLの設定をする、または設定値が存在しない場合は無期限、無制限の設定となります。
- **サーバー観点での補足:**
  - NULL値を無期限・無制限として扱うロジックが必要

### 要件7: 交換数の可変設定と上限管理
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」の「▼交換確認ダイアログ」
- **抜粋:**
  > 交換可能上限数まで交換に必要なリソースを所持している場合は、まとめて交換できるようにします。
  > 交換数は±1、±10、最大、最小で変更できます。
  > 交換上限数は、ユーザーごとで可変式で交換した数が反映されるようにする。交換上限数が残っていない場合は、交換可能の吹き出しは消え、ボタンが「交換済み」という表示になりタップできなくなります。
- **サーバー観点での補足:**
  - ユーザーごとの交換済み回数の記録と管理が必要
  - 交換上限チェックと残り回数の計算が必要
  - まとめて交換する際のリソース所持数チェックが必要

### 要件8: 交換に必要なリソースの所持数検証
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」の「▼交換確認ダイアログ」
- **抜粋:**
  > 交換に必要なリソース数が交換数に応じて足りている場合は黒数字ですが不足している場合は赤数字で表示されるようにします。
  > 例)コイン1000枚を交換するのにAアイテムが100必要だが90時箇所していない場合は、-10と赤字で表示します。
- **サーバー観点での補足:**
  - 交換実行前にユーザーの所持リソースと必要リソースを比較検証する必要がある
  - 不足分の計算と情報提供が必要

### 要件9: 原画交換時の特殊処理
- **元ページ:** Page 8, 「交換所基本仕様_原画を交換時の挙動」
- **抜粋:**
  > 原画を交換所でラインナップに設定する場合は、原画のかけら単位での設定はできません。
  > 交換すると、既存の原画のかけら演出がかけら16ピース分再生されます。
- **サーバー観点での補足:**
  - 原画アイテムの交換処理では、かけら単位ではなく完成品として扱う必要がある
  - 原画交換時の演出情報（16ピース分）を管理する必要がある

### 要件10: 複数種類のアイテムをラインナップに設定可能
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」の「▼ラインナップ一覧画面」
- **抜粋:**
  > アイテム、キャラ、原画、エンブレム、プリズム、コインをラインナップに設定することができます。
- **サーバー観点での補足:**
  - 多様なアイテムタイプ（アイテム、キャラ、原画、エンブレム、プリズム、コイン）を交換アイテムとして扱う必要がある

### 要件11: アイテムBOXからキャラのかけらBOX交換所への移行
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」
- **抜粋:**
  > ・キャラのかけらBOX交換所
  > 現状アイテムBOX内にあるキャラのかけらをかけらBOXに交換する交換所になりますが、それをそのままここに持ってきたものになります。
- **サーバー観点での補足:**
  - 既存のアイテムBOXのキャラのかけら交換機能を交換所機能に統合する必要がある

### 要件12: アイテムBOXのタブ分類管理
- **元ページ:** Page 9, 「アイテムBOXの整理（第一希望案）」
- **抜粋:**
  > タブは、以下の3種とします。
  > 消費：所持しているガシャチケットのようなガシャを引けるアイテム、かけらBOXのような特定のアイテムに交換できるアイテムなど消費することで新たに報酬（リソース）が獲得できるものがここに表示されます。
  > 強化：所持している各種カラーメモリー、各種メモリーフラグメントなど強化関連のアイテムがここに表示されます。
  > かけら：所持しているキャラのかけらがここに表示されます。
- **サーバー観点での補足:**
  - アイテムをカテゴリー（消費・強化・かけら）別に分類して管理する必要がある
  - アイテムBOX取得APIでカテゴリー別にフィルタリングした情報を提供する必要がある

### 要件13: かけらの表示順序のカスタマイズ
- **元ページ:** Page 9, 「アイテムBOXの整理（第一希望案）」
- **抜粋:**
  > また、表示順をキャラ一覧のデフォルトの表示順に合わせて表示する内容に変更します。（できたら）
- **サーバー観点での補足:**
  - キャラのかけらの表示順序をキャラ一覧のデフォルト順序に合わせて返却する必要がある

### 要件14: 売却機能（強化アイテム、キャラのかけら）
- **元ページ:** Page 14, 「アイテムBOXの整理」
- **抜粋:**
  > 強化、かけらタブには売却機能が存在します。
  > 消費タブに売却機能がないのは、直接販売するアイテムやおまけ扱いになっているアイテムであり、また、消費することで別のリソース（主にキャラやキャラのかけらなど）を獲得できてしまい、複数役務を持った二次通貨扱いとなり、法務NGとなってしまう懸念が理由です。
- **サーバー観点での補足:**
  - 強化アイテムとキャラのかけらの売却処理が必要
  - 消費アイテムは法務上の理由で売却不可として制御する必要がある

### 要件15: 交換リソースの種類管理
- **元ページ:** Page 2, 「概要」の「■機能概要」
- **抜粋:**
  > ゲーム内で獲得した特定のアイテム、リソース、専用通貨（以下、「交換リソース」）を使用して、別のアイテムやキャラクター（またはそのピース）など（以下、「交換アイテム」）と交換できる機能。
- **サーバー観点での補足:**
  - 交換リソース（消費するもの）と交換アイテム（獲得するもの）を明確に区別して管理する必要がある

### 要件16: お知らせ・IGNからの交換所誘導
- **元ページ:** Page 11, 「工数(人日)など」の表内
- **抜粋:**
  > お知らせ・IGNからの交換所TOP画面への誘導設定を可能にする
- **サーバー観点での補足:**
  - お知らせやIGN（インゲームノーティフィケーション）から特定の交換所への直接遷移を可能にする仕組みが必要

### 要件17: 複数リソース消費への対応可能性
- **元ページ:** Page 11, 「工数(人日)など」の表内
- **抜粋:**
  > 交換所基本実装のサーバー工数：※ 複数リソース消費が必要なら + 3
- **サーバー観点での補足:**
  - 1回の交換で複数種類のリソースを消費する可能性がある（仕様未確定だが考慮が必要）

### 要件18: 交換実行時のトランザクション処理
- **元ページ:** Page 7, 「交換所基本仕様_交換所ラインナップ画面における交換挙動」全体
- **抜粋:**
  > （交換確認ダイアログの一連の流れ）
- **サーバー観点での補足:**
  - 交換実行時に、リソースの消費と交換アイテムの付与を原子性を保って処理する必要がある
  - 交換上限のチェックと更新を同時に行う必要がある
  - エラー時のロールバック処理が必要

### 要件19: 管理ツールでの交換所設定
- **元ページ:** Page 11, 「工数(人日)など」の表内
- **抜粋:**
  > 管理ツールに交換所の項目追加
- **サーバー観点での補足:**
  - 管理ツールから交換所の設定（ラインナップ、期間、上限数等）を登録・編集できる機能が必要

### 要件20: 交換所の期間管理と自動切り替え
- **元ページ:** Page 6, 「交換所基本仕様_交換所一覧画面」
- **抜粋:**
  > イベント交換所：イベント（いいジャン祭）の開催期間に合わせた期間で開いている交換所になります。
- **サーバー観点での補足:**
  - イベント開催期間と連動して交換所の表示・非表示を制御する必要がある
