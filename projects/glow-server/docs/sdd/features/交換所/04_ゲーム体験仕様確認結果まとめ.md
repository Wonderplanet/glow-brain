# ゲーム体験仕様確認結果まとめ：交換所

## 1. 確認実施概要
- 確認日時: （記録なし）
- 確認方法: ドキュメントベースの回答
- 確認者: プランナー（ゲーム企画担当者）

## 2. 確認結果サマリー
- 確認項目総数: 12 項目
- 完全に解決: 10 項目
- 部分的に解決: 0 項目
- 未解決: 0 項目
- サーバー考慮不要（UI側の実装事項）: 2 項目

## 3. 各不明点の確認結果

### 3.1 サーバー側で仕様確定が必要だった項目

#### 項目 C-1: Q1 - 交換所の階層構造について
- **元の不明点:**
  - 交換所機能では、「交換所」という大きな括りの下に複数の「ラインナップ」が存在する構造ですが、交換所自体をマスタデータとして管理する必要がありますか？ それともラインナップマスタのみで、交換所はUI上のグループ化だけですか？
- **ゲーム体験仕様確認結果:**
  - 交換所自体をマスタデータとして管理する必要がある。交換所の期限設定など、基本設定が必要だったりするので。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 交換所マスタテーブルを作成する
  - 交換所マスタには以下の情報を持たせる:
    - 交換所ID（主キー）
    - 交換所名
    - 交換所カテゴリー（NORMAL/EVENT/FRAGMENT_BOX等）
    - 開催期間（start_at, end_at）
    - バナー画像URL
    - 表示順
    - 有効フラグ
  - ラインナップマスタは交換所IDを外部キーとして持ち、所属する交換所を特定する
- **備考:**
  - 既存のショップアイテム機能ではラインナップのみをマスタ管理していたが、交換所機能では階層構造が明確に必要

#### 項目 C-2: Q2 - 複数リソース消費の実装について
- **元の不明点:**
  - 1回の交換で複数種類のリソース（例: コイン1000 + アイテムA 10個）を同時に消費するラインナップを用意する予定はありますか？
- **ゲーム体験仕様確認結果:**
  - 複数想定で実装する。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 1つのラインナップで複数種類のコストを設定可能にする
  - 実装方法の選択肢:
    - 方法A: ラインナップマスタに複数のcost行を紐付ける（ラインナップコストテーブルを別途作成）
    - 方法B: cost情報をJSON配列として保存
  - 推奨: 方法A（別テーブルで管理し、1ラインナップに対してN個のコストレコードを持つ）
- **備考:**
  - 工数見積もりでは「複数リソース消費が必要なら +3人日」と記載されていたが、実装することが確定
  - DB設計とバリデーションロジックに影響

#### 項目 C-3: Q3 - 月次リセットの実行タイミングについて
- **元の不明点:**
  - 通常交換所の月次リセット（毎月初日04:00）は、バッチ処理で一斉にリセットする方式ですか？ それとも、ユーザーが交換実行時に自動判定してリセットする方式ですか？
- **ゲーム体験仕様確認結果:**
  - ユーザーが交換実行時に自動判定してリセットする方針。実装の詳細と方針は、既存のショップアイテムの実装を参考にする。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - リクエスト時判定方式を採用（既存のショップアイテムと同じ方式）
  - 交換実行時に`last_reset_at`をチェックし、前月以前であればリセット処理を実行
  - リセット処理内容:
    - `exchange_count`を0にリセット
    - `last_reset_at`を現在時刻で更新
  - バッチ処理は不要
- **備考:**
  - 既存の`ShopService::resetUsrShopItem`メソッドのロジックを参考に実装

#### 項目 C-4: Q4 - 復刻時のID切り直しと交換履歴について
- **元の不明点:**
  - イベント交換所を復刻する際、「交換所IDを新規で切り直す」とのことですが、これにより交換履歴もリセットされますか？ それとも、旧交換所の履歴を引き継ぎますか？
- **ゲーム体験仕様確認結果:**
  - 交換履歴(ユーザーデータ)はそのままになります。交換所IDを新規で切り直したら、ユーザーレコードの新規で作成されるイメージ。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 復刻時は新しい交換所IDを発番する
  - ユーザー交換履歴テーブル（usr_exchange_lineup）は、ラインナップIDをキーとして管理
  - 新しい交換所ID + 新しいラインナップIDの組み合わせになるため、自動的に新規レコードが作成される
  - 旧交換所の履歴はそのまま残る（削除されない）
- **備考:**
  - ユーザーは復刻イベントで再度交換できる（履歴がリセットされたように見える）
  - 管理ツールで復刻用の交換所・ラインナップを新規作成する運用が必要

#### 項目 C-5: Q5 - キャラのかけらBOX交換所の選択肢について
- **元の不明点:**
  - キャラのかけらBOX交換所では、どのキャラのかけらでも選択できますか？ それとも、レアリティごとに異なるBOX（URかけらBOX、SSRかけらBOX等）を用意し、選択肢を制限しますか？
- **ゲーム体験仕様確認結果:**
  - 既存実装済みなのでここでは考慮不要。
- **解決状況:** 完全に解決（サーバー考慮不要）
- **確定した仕様:**
  - 既存の`ItemExchangeSelectItemUseCase`の実装をそのまま維持
  - 交換所機能としては、既存機能へのリンクを提供するのみ（新規実装不要）
- **備考:**
  - サーバー側での新規実装は不要
  - UI側で既存のキャラのかけらBOX交換画面への遷移を実装するのみ

#### 項目 C-6: Q6 - アイテムBOX整理案の採用可否
- **元の不明点:**
  - アイテムBOXの整理について、第一希望案（タブ切り替え）と第二希望案（帯名称変更）のどちらを採用しますか？ また、交換所機能の実装と同時に行う必要がありますか？
- **ゲーム体験仕様確認結果:**
  - UIなのでサーバー考慮不要
- **解決状況:** 完全に解決（サーバー考慮不要）
- **確定した仕様:**
  - アイテムBOX整理はクライアント側の実装事項
  - サーバー側は既存のアイテムBOX取得APIをそのまま利用
  - カテゴリー分類が必要な場合も、クライアント側で振り分ける
- **備考:**
  - サーバー側での新規実装は不要

#### 項目 C-7: Q7 - 初回無料や広告視聴による交換
- **元の不明点:**
  - 交換所でも、ショップアイテムと同様に初回無料や広告視聴で交換できるラインナップを用意する予定はありますか？
- **ゲーム体験仕様確認結果:**
  - 不要。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 初回無料機能は実装しない
  - 広告視聴による交換機能は実装しない
  - ラインナップマスタには`is_first_time_free`フラグや`cost_type=AD`のような設定は不要
- **備考:**
  - 実装不要のため、工数削減につながる

#### 項目 C-8: Q8 - 交換済みラインナップの表示
- **元の不明点:**
  - 交換上限に達したラインナップは、「交換済み」として画面に表示し続けますか？ それとも、非表示にしますか？
- **ゲーム体験仕様確認結果:**
  - UIなのでサーバー考慮不要。
- **解決状況:** 完全に解決（サーバー考慮不要）
- **確定した仕様:**
  - サーバーは全てのラインナップと残り交換可能回数を返却
  - 交換済みラインナップの表示/非表示はクライアント側で判断
- **備考:**
  - サーバー側は残り回数が0であることを示す情報のみ提供すれば良い

#### 項目 C-9: Q9 - まとめて交換時の「最大」の挙動
- **元の不明点:**
  - まとめて交換で「最大」を選択した際、交換上限と所持リソースのうち、どちらに合わせて最大値を計算しますか？
- **ゲーム体験仕様確認結果:**
  - UIなのでサーバー考慮不要。
- **解決状況:** 完全に解決（サーバー考慮不要）
- **確定した仕様:**
  - サーバーは残り交換可能回数と所持リソース数を返却
  - 「最大」の計算はクライアント側で実施
  - サーバーは指定された交換数が妥当かをバリデーションするのみ
- **備考:**
  - サーバー側はバリデーションのみ実装すれば良い

#### 項目 C-10: Q10 - お知らせ・IGNからの誘導先
- **元の不明点:**
  - お知らせやIGNから交換所に誘導する際、特定の交換所に直接遷移させますか？ それとも、交換所一覧画面に遷移させますか？
- **ゲーム体験仕様確認結果:**
  - 特定の交換所に直接遷移させる。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - お知らせやIGNのリンクに交換所IDをパラメータとして含める
  - クライアントは交換所IDを受け取り、該当する交換所のラインナップ画面に直接遷移
  - サーバー側は交換所ID指定での取得APIを提供する必要がある
- **備考:**
  - 交換所一覧取得APIと、特定交換所取得APIの両方が必要

#### 項目 C-11: Q11 - イベント交換所の交換上限リセット周期
- **元の不明点:**
  - イベント交換所の交換上限は、イベント期間全体で何回までという設定ですか？ それとも、日次/週次でリセットされる設定も可能にしますか？
- **ゲーム体験仕様確認結果:**
  - 可能にする。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ラインナップマスタに`reset_type`カラムを追加
  - 設定可能な値: NONE（リセットなし）, DAILY, WEEKLY, MONTHLY
  - イベント交換所でも日次/週次リセットを設定可能にする
  - リセットロジックは既存のショップアイテムと同様の実装を使用
- **備考:**
  - 既存の`ShopType`（DAILY/WEEKLY）の実装を参考にする

#### 項目 C-12: Q12 - 交換時のミッション・クエストトリガー
- **元の不明点:**
  - 「交換所でアイテムを交換する」というミッション条件を設定する予定はありますか？
- **ゲーム体験仕様確認結果:**
  - 今はない。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - ミッション・クエストトリガーは実装しない
  - 交換実行時に`TradeExchangeItemLogTrigger`のようなトリガーを発火する必要はない
  - 将来的に必要になった場合は、その時点で追加実装する
- **備考:**
  - 実装不要のため、工数削減につながる

### 3.2 ゲーム体験的に不自然な可能性があった項目

#### 項目 D-1: 月次リセットの実行タイミング
- **元の不明点:**
  - 仕様書では「毎月初日の04:00にリセット」と記載されているが、リクエスト時判定方式の場合、ユーザーが04:00以降に初めてアクセスした時点でリセットされる
- **ゲーム体験仕様確認結果:**
  - Q3の回答により、リクエスト時判定方式が確定
- **解決状況:** 完全に解決
- **確定した仕様:**
  - リクエスト時判定方式を採用（Q3で確定）
  - 「毎月初日の04:00にリセット」という表現は、「04:00以降の初回アクセス時にリセット」と読み替える
  - 既存のショップアイテムと同じ挙動にする
- **備考:**
  - ユーザー体験上の問題は既存機能で検証済みと判断

#### 項目 D-2: まとめて交換時の所持数不足
- **元の不明点:**
  - 「最大」を選択した際、所持リソース数が不足している場合の挙動が不明
- **ゲーム体験仕様確認結果:**
  - Q9の回答により、クライアント側で計算することが確定
- **解決状況:** 完全に解決（サーバー考慮不要）
- **確定した仕様:**
  - クライアント側で「最大」の値を計算してから交換リクエストを送信
  - サーバー側は指定された交換数に対するバリデーションのみ実施
- **備考:**
  - サーバー側は所持数不足の場合にエラーを返すだけで良い

#### 項目 D-3: 交換済みラインナップの表示
- **元の不明点:**
  - 交換済みのラインナップを画面に表示し続けるか、非表示にするかが不明
- **ゲーム体験仕様確認結果:**
  - Q8の回答により、クライアント側で判断することが確定
- **解決状況:** 完全に解決（サーバー考慮不要）
- **確定した仕様:**
  - サーバーは全てのラインナップ情報と残り回数を返却
  - 表示/非表示の判断はクライアント側で実施
- **備考:**
  - サーバー側の実装に影響なし

## 4. 残存する不明点・追加確認が必要な項目

### 4.1 まだ不明な点
- なし（全ての確認項目が解決済み）

### 4.2 新たに発生した疑問点
- なし

## 5. サーバー実装への影響評価

### 5.1 仕様確定度の評価
- 全体的な仕様確定度: 100%
- サーバー実装に必要な仕様が全て揃っているか: **Yes**
- 揃っていない場合、何が足りないか: （該当なし）

### 5.2 実装への影響

#### ゲーム体験仕様確認によって変更が必要になった箇所:
1. **複数リソース消費の実装が確定**
   - ラインナップマスタの設計変更（コストを別テーブルまたはJSON配列で管理）
   - コスト消費ロジックの複雑化（ループ処理が必要）
   - バリデーションロジックの追加（全てのコストについて所持数チェック）

2. **交換所マスタの追加が確定**
   - 交換所マスタテーブルの新規作成
   - 交換所マスタの管理ツール画面の追加
   - ラインナップマスタに交換所IDの外部キー追加

3. **日次/週次リセットの対応が確定**
   - ラインナップマスタに`reset_type`カラム追加
   - 既存のショップアイテムのリセットロジックを参考にした実装

4. **お知らせ・IGNからの直接遷移が確定**
   - 交換所ID指定での取得APIの追加

#### 新たに追加実装が必要になった箇所:
- 複数リソース消費の実装（当初は「可能性」だったが確定）

#### 実装不要になった箇所:
1. 初回無料機能（実装不要）
2. 広告視聴による交換機能（実装不要）
3. ミッション・クエストトリガー（実装不要）
4. キャラのかけらBOX交換所（既存機能を利用するため新規実装不要）
5. アイテムBOX整理（クライアント側実装のためサーバー側は不要）

### 5.3 スケジュール・リスクへの影響

#### ゲーム体験仕様確認前の想定からの変更点:
- **工数増加要因:**
  - 複数リソース消費の実装が確定（+3人日）
  - 交換所マスタの追加実装
  - 日次/週次リセット対応

- **工数削減要因:**
  - 初回無料・広告視聴機能が不要
  - ミッション連携が不要
  - キャラのかけらBOX交換所の新規実装が不要

- **差し引き:** 複数リソース消費の実装により約3人日の増加が見込まれるが、不要機能の削減により一部相殺される

#### スケジュールへの影響:
- 仕様確定により、実装着手が可能
- 複数リソース消費の実装が追加されるため、当初見積もりより若干の工数増加

#### 残存リスク:
- **なし**（全ての不明点が解決済み）

## 6. 次のアクションアイテム
- [x] ゲーム体験仕様の確認完了
- [x] サーバー実装に必要な仕様の確定
- [ ] **次のステージ（Stage 5: サーバーAPI要件書まとめ）に進む**
- [ ] DB設計の詳細化（交換所マスタ、ラインナップマスタ、複数コスト対応）
- [ ] API設計の詳細化（エンドポイント定義、リクエスト/レスポンス仕様）
- [ ] 実装着手

---

## まとめ

全ての確認項目（12項目）について、プランナーからの明確な回答が得られました。

**重要な確定事項:**
1. 交換所マスタを独立して管理する
2. 複数リソース消費を実装する
3. 月次リセットはリクエスト時判定方式を採用
4. 復刻時は新規IDを発番し、履歴は新規作成される
5. 初回無料・広告視聴・ミッション連携は実装しない

**サーバー実装に必要な仕様は100%確定しました。次のステージ（要件定義の統合とAPI設計）に進むことができます。**
