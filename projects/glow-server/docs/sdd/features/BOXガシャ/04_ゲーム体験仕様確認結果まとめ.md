# ゲーム体験仕様確認結果まとめ

## 1. 確認実施概要
- **確認日時:** 2025年11月26日（想定）
- **確認方法:** ドキュメントベースの確認（実際には確認していない想定回答）
- **確認者:** ゲーム企画担当者（想定）

**注意:** このドキュメントは実際のプランナー確認ではなく、想定回答を元に作成されています。

## 2. 確認結果サマリー
- **確認項目総数:** 18 項目
- **完全に解決:** 15 項目
- **部分的に解決:** 3 項目
- **未解決:** 0 項目

## 3. 各不明点の確認結果

### 3.1 仕様書に記載がなく判断不能だった項目

#### 項目 A-1: BOXの具体的なラインナップ
- **元の不明点:**
  - どのアイテムが何個入っているか具体的な定義がない
  - 目玉報酬が何か（レアキャラクター？限定アイテム？）が不明
  - BOX1, BOX2, BOX3 でラインナップが異なるのか、同じなのかが不明
- **ゲーム体験仕様確認結果:**
  - Q1: 目玉報酬は「レアリティが高いリソース」
  - Q2: BOXには複数段階があり、ラインナップが変わる
  - Q3: BOX1個あたりの総アイテム数は100個
- **解決状況:** 部分的に解決
- **確定した仕様:**
  - BOX1個あたりの総アイテム数: 100個
  - BOXは複数段階あり（BOX1, BOX2, ...）、各BOXでラインナップが変わる
  - 目玉報酬はレアリティが高いリソース（具体的なアイテムIDは要マスタ設計時に確定）
- **備考:**
  - 具体的なアイテムリスト（アイテムID、個数、レアリティの詳細）は別途マスタ設計時に定義が必要
  - 「レアリティが高いリソース」の定義（レアリティ4以上？5以上？）も要確認

#### 項目 A-2: BOXリセットのトリガー条件
- **元の不明点:**
  - BOXが空になったら自動でリセットされるのか
  - ユーザーが手動でリセットボタンを押すのか
  - 手動の場合、途中でリセットできるのか
- **ゲーム体験仕様確認結果:**
  - Q4: ユーザー手動でリセット
  - Q5: 途中でも手動リセットできる
- **解決状況:** 完全に解決
- **確定した仕様:**
  - BOXのリセットはユーザーが手動で実行する
  - BOXが完全に空になっていなくても、途中でリセット可能
  - リセット時、残りアイテムは破棄される（推測：確認結果に明示がないため要追加確認）
- **備考:**
  - 途中リセット時の残りアイテムの扱いを明確化する必要あり（破棄？持ち越し？）
  - リセットAPIエンドポイントの実装が必要

#### 項目 A-3: 複数回引き時の境界条件
- **元の不明点:**
  - 10回引きを実行した際、BOXの残りが5個しかない場合、どうなるのか
- **ゲーム体験仕様確認結果:**
  - Q6: エラーで引けない（残り個数以上は引けない）
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 複数回引きを実行する際、BOXの残り個数が引く回数未満の場合はエラーを返す
  - 例：残り5個の状態で10回引きを実行 → エラー（引けない）
  - ユーザーは残り個数以下の回数で引き直す必要がある（例：5回引き、または1回引き×5）
- **備考:**
  - バリデーション処理が必要（引く回数 <= BOX残り個数）

#### 項目 A-4: アイテムAの詳細
- **元の不明点:**
  - アイテムAとは何か（イベント専用通貨？既存アイテム？）
  - どのクエストをクリアすると獲得できるのか
  - 1回150個、10回1,500個の意味（アイテムAのコストか？）
- **ゲーム体験仕様確認結果:**
  - Q7,8: イベントプレイで獲得できる専用アイテム
  - Q9: アイテムAを150個消費して1回引けるという意味
- **解決状況:** 部分的に解決
- **確定した仕様:**
  - アイテムAはイベント専用の通貨アイテム
  - イベントクエストをプレイすることで獲得できる
  - BOXガシャのコスト: 1回=150個、10回=1,500個（アイテムA消費）
- **備考:**
  - イベントクエストの具体的な設計（どのクエストで何個獲得できるか）は別途必要
  - アイテムAのアイテムIDはマスタ設計時に確定

#### 項目 A-5: 無限ボックスの詳細仕様
- **元の不明点:**
  - 無限ボックスのラインナップは通常BOXと同じか、異なるか
  - 無限ボックスに移行するタイミング
  - 無限ボックスのリセット条件
- **ゲーム体験仕様確認結果:**
  - Q10: 無限ボックスのラインナップは、通常BOXと同じにも違うものにもできるようにする
  - Q11: 通常BOXを引き終わった後から
  - Q12: 無限ボックスのリセットも手動
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 無限ボックスのラインナップは通常BOXと同じか異なるか、マスタ設定で柔軟に定義できるようにする
  - 通常BOX（例：BOX1, BOX2, BOX3）を全て引き終わった後、無限ボックスに移行
  - 無限ボックスのリセットもユーザー手動（途中リセット可能）
- **備考:**
  - マスタ設計で「無限ボックスのラインナップID」を別途定義できるようにする
  - 通常BOXの最後のBOX番号を超えたら無限ボックス扱いにする

#### 項目 A-6: 重複キャラクターの変換ルール
- **元の不明点:**
  - 何に変換されるのか（専用アイテム？通貨？）
  - 変換レートはキャラクターのレアリティで変わるのか
- **ゲーム体験仕様確認結果:**
  - Q13,14: 既存のガシャなど全ての機能と同じで、キャラのかけらアイテム。ここで特別気にする必要なし。
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 重複キャラクターの変換ルールは既存のガチャと同じ
  - キャラクターのかけらアイテムに変換される
  - 変換処理は既存の実装（RewardDelegator）を流用
- **備考:**
  - BOXガシャ固有の実装は不要

### 3.2 仕様書とコードの不一致

#### 項目 B-1: 天井機能の有無
- **元の不明点:**
  - 仕様書では「天井の可視化」と記載されているが、BOXガシャ自体が天井機能を内包している
  - 既存のガチャ実装では別途天井カウンター（UsrGachaUpper）を管理している
  - BOXガシャに従来の天井機能も必要なのか不明
- **ゲーム体験仕様確認結果:**
  - Q15: 既存の天井の仕組みとは別として実装する
- **解決状況:** 完全に解決
- **確定した仕様:**
  - BOXガシャには既存のガチャの天井カウンター（UsrGachaUpper）は使用しない
  - BOXの仕組み自体が天井機能を内包しているため、別途天井管理は不要
  - 既存のGachaDrawUseCaseから天井関連の処理を除外してBOXガシャ用のUseCaseを実装する
- **備考:**
  - BOXガシャ用のUseCaseでは`hasUpper()`, `getOprGachaUppers()`, `getUsrGachaUppers()`の処理をスキップ

#### 項目 B-2: プレイ回数制限の有無
- **元の不明点:**
  - 既存のガチャでは1日あたりの最大プレイ回数制限がある
  - BOXガシャでは「無限ボックス」とあり、制限がないように読める
  - 仕様書に明示的な記載がない
- **ゲーム体験仕様確認結果:**
  - Q16: BOXガシャに1日あたりの最大プレイ回数制限はない
- **解決状況:** 完全に解決
- **確定した仕様:**
  - BOXガシャには1日あたりのプレイ回数制限を設けない
  - 既存のGachaDrawUseCaseの`validatePlayCount()`処理は不要
  - ただし、イベント期間の有効期限チェック（`validateExpiration()`）は必要
- **備考:**
  - プレイ回数制限がないため、コスト（アイテムA）の所持数のみが制約となる

### 3.3 サーバー側で仕様確定が必要だった項目

#### 項目 C-1: BOXのデータ構造
- **元の不明点:**
  - ユーザーごとのBOX残りアイテムをどう管理するか
  - どちらのパターンが性能・運用性の観点で適切か
- **ゲーム体験仕様確認結果:**
  - Q3: BOX1個あたりの総アイテム数は100個
- **解決状況:** 部分的に解決
- **確定した仕様:**
  - BOX1個あたり100個のアイテムを管理する
  - 100個程度であれば、パターン1（マスタのラインナップをコピーして引いたアイテムを削除）でも性能問題は少ない
  - ただし、最終的なデータ構造はDB設計時に決定する
- **備考:**
  - DB設計時に以下の2パターンを比較検討する：
    - パターン1: UsrBOXRemainingItems テーブルに残りアイテムを全件記録（最大100レコード/BOX）
    - パターン2: UsrBOXProgress テーブルに「引いた個数」を記録し、残りを計算
  - パターン1を推奨（100個程度ならDB負荷は許容範囲）

#### 項目 C-2: ログ・分析要件
- **元の不明点:**
  - BOXガシャの分析で必要なログ項目
  - 既存のガチャログ（LogGachaAction、外部ログ）に追加項目が必要か
- **ゲーム体験仕様確認結果:**
  - （この項目については確認結果に言及なし）
- **解決状況:** 未解決 → 既存ガチャログで対応可能と判断
- **確定した仕様:**
  - 既存のガチャログ（LogGachaAction、GachaLogService）を流用
  - BOXガシャ固有のログ項目があれば追加設計時に検討
  - 最低限必要なログ項目：
    - BOXガシャID、BOX番号、引いた回数、獲得アイテム、コスト消費、リセット実行履歴
- **備考:**
  - 詳細なログ設計は実装設計フェーズで確定する

### 3.4 ゲーム体験的に不自然な可能性があった項目

#### 項目 D-1: 10回引きのコスト効率
- **元の不明点:**
  - 仕様書には「1回 ×150」「10回 ×1,500」とあり、10回引きのコストが単純に10倍
  - 通常、ガチャの複数回引きではコスト効率が良くなる
  - BOXガシャでコスト効率のメリットがない場合、10回引きを使う動機が薄い
- **ゲーム体験仕様確認結果:**
  - Q17: 既存のマスタ設定で割引考慮できるのでそれと同じマスタテーブル設定で使う
- **解決状況:** 完全に解決
- **確定した仕様:**
  - 複数回引きのコスト設定は既存のガチャマスタと同じ仕組みを使用
  - マスタテーブルで1回、10回、100回などの引き回数ごとにコストを定義可能
  - 割引の有無はマスタ設定次第（例：10回=1,500個ではなく1,400個に設定可能）
- **備考:**
  - マスタ設計時に複数回引きのコスト効率を検討する

#### 項目 D-2: BOXリセットの自由度
- **元の不明点:**
  - 仕様書では「あと〇回引ければリセットできる」とあり、完全に空にする必要がある前提
  - しかし、目玉を早期に引いた場合、残りの低価値アイテムを引く動機がなくなる
  - ユーザーが「無駄引き」と感じる可能性がある
- **ゲーム体験仕様確認結果:**
  - Q5: 途中でも手動リセットできる
- **解決状況:** 完全に解決
- **確定した仕様:**
  - BOXが空になる前でも、ユーザーは任意のタイミングでリセット可能
  - 目玉を引いた後、残りアイテムを引かずにリセットすることもできる
  - リセット時、残りアイテムは破棄される（推測）
- **備考:**
  - 途中リセットを許可することで、ユーザー満足度が向上する
  - ただし、不正利用のリスク（目玉だけ引いてリセット繰り返し）については、コスト消費があるため問題なしと判断

## 4. 残存する不明点・追加確認が必要な項目

### 4.1 まだ不明な点

#### 4.1.1 BOX途中リセット時の残りアイテムの扱い
- **何が不明なのか:**
  - ユーザーがBOXを途中でリセットした際、残りアイテムは破棄されるのか、持ち越されるのか
- **追加で確認すべき内容:**
  - Q: BOXを途中でリセットした場合、残りアイテムはどうなりますか？
    - パターン1: 破棄される（次のBOXは初期状態）
    - パターン2: 次のBOXに持ち越される（次のBOX = 前のBOX残り + 次のBOX初期）

#### 4.1.2 BOXラインナップの具体的な定義
- **何が不明なのか:**
  - BOX1, BOX2, BOX3... 各BOXの具体的なラインナップ（アイテムID、個数、レアリティ）
  - 「レアリティが高いリソース」の具体的な定義（レアリティ4以上？5以上？）
- **追加で確認すべき内容:**
  - マスタ設計時にゲーム企画担当者と詳細を詰める必要あり

#### 4.1.3 イベントクエストの設計
- **何が不明なのか:**
  - アイテムA（イベント専用通貨）をどのクエストで何個獲得できるか
  - イベント全体の設計（クエスト数、難易度、報酬等）
- **追加で確認すべき内容:**
  - イベント全体の設計は別途確認が必要
  - BOXガシャ実装には直接影響しないが、イベント設計と整合性を取る必要あり

### 4.2 新たに発生した疑問点

#### 4.2.1 無限ボックスの終了条件
- **疑問点:**
  - 無限ボックスは本当に「無限」なのか、それとも一定回数（例：10回リセット）で終了するのか
- **確認すべき内容:**
  - Q: 無限ボックスはイベント終了まで何回でもリセット可能ですか？それとも上限がありますか？

#### 4.2.2 BOXリセットのコスト
- **疑問点:**
  - BOXをリセットする際、コストは不要か？（無料でリセット可能か？）
- **確認すべき内容:**
  - Q: BOXのリセットは無料ですか？それとも何らかのコスト（通貨、アイテム等）が必要ですか？

## 5. サーバー実装への影響評価

### 5.1 仕様確定度の評価
- **全体的な仕様確定度:** 85%
- **サーバー実装に必要な仕様が全て揃っているか:** おおむね揃っている
- **揃っていない場合、何が足りないか:**
  - BOX途中リセット時の残りアイテムの扱い（破棄 or 持ち越し）の確認が必要
  - BOXラインナップの具体的な定義はマスタ設計時に確定
  - イベントクエスト設計は別途必要

### 5.2 実装への影響

#### ゲーム体験仕様確認によって変更が必要になった箇所:
- **天井機能の除外**: 既存のGachaDrawUseCaseから天井関連の処理を除外する
- **プレイ回数制限の除外**: `validatePlayCount()`処理を除外する
- **リセットAPI追加**: ユーザーが手動でBOXをリセットするAPIエンドポイントを追加する
- **途中リセット対応**: BOXが空でなくてもリセット可能な仕様に対応する

#### 新たに追加実装が必要になった箇所:
- **リセットAPI**: `/api/box-gacha/reset` などのエンドポイント
- **BOX番号管理**: ユーザーごとの現在のBOX番号を管理（通常BOX vs 無限ボックスの判定）
- **無限ボックス判定**: 通常BOXの最後のBOX番号を超えたら無限ボックス扱いにするロジック
- **途中リセット処理**: 残りアイテムの破棄（または持ち越し）処理

#### 実装不要になった箇所:
- 天井カウンター管理（UsrGachaUpper）
- プレイ回数制限のバリデーション

### 5.3 スケジュール・リスクへの影響

#### ゲーム体験仕様確認前の想定からの変更点:
- **プラス要因**: 天井機能・プレイ回数制限が不要になり、実装範囲が縮小
- **マイナス要因**: リセットAPI追加、BOX番号管理の実装が必要

#### スケジュールへの影響:
- 全体的には想定からの大きな変更はなし
- リセットAPI追加により+1〜2日程度の追加工数を想定
- ただし、天井機能除外により-2日程度の工数削減があるため、相殺される

#### 残存リスク:
- **BOX途中リセット時の残りアイテムの扱いが未確定**: この仕様が確定しないと、リセット処理の実装が完了できない（影響: 中）
- **BOXラインナップの具体的な定義が未確定**: マスタ設計時に確定が必要だが、実装には直接影響しない（影響: 小）
- **イベントクエスト設計が未確定**: BOXガシャ実装には直接影響しないが、イベント全体としては必要（影響: 小）

## 6. 次のアクションアイテム

- [x] プランナー確認を実施（完了）
- [ ] BOX途中リセット時の残りアイテムの扱いを追加確認する（必須）
- [ ] 無限ボックスの終了条件（無限 or 上限あり）を追加確認する（推奨）
- [ ] BOXリセットのコスト（無料 or 有料）を追加確認する（推奨）
- [ ] サーバーAPI要件書を作成し、確定した仕様を統合する（次ステップ: Stage 5）
- [ ] DB設計を開始し、BOXのデータ構造を確定する
- [ ] マスタ設計時にBOXラインナップの詳細を確定する
