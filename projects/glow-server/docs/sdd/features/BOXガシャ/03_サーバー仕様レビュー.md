# サーバー実装観点の仕様レビュー（自動分析レポート）

## 1. 要約

### 現時点での仕様の明瞭さ/不明瞭さの総評

**明瞭な点：**
- BOXガシャの基本コンセプト（運要素を排除、天井の可視化、育成素材の配布）は明確
- ユーザー体験の目的（周回誘導、プレイ時間の最大化）は理解できる
- 既存のガチャ実装パターンを参考にできるため、技術的な実現性は高い

**不明瞭な点：**
- BOXの具体的なラインナップ（アイテム種類・個数）が未定義
- BOXリセットのトリガー条件・タイミングが曖昧
- 複数回引き時の境界条件（BOXが途中で空になる場合）の処理が不明
- アイテム獲得からガシャ実行までのフロー全体が未定義
- コスト消費の詳細（アイテムA の種類・獲得方法）が不明
- 無限ボックスの詳細仕様が曖昧

### 大きなリスク・不確定要素の概要

1. **BOXの状態管理の複雑性**: ユーザーごとに異なるBOX残り状態を管理する必要があり、設計を誤ると不整合やパフォーマンス問題が発生するリスクがある

2. **複数回引きの境界条件処理**: 10回引きを実行した際、BOXの残りが5個しかない場合の挙動が未定義で、実装ミスによるバグや不正利用のリスクがある

3. **無限ボックスの設計**: 「無限」の実現方法（自動リセット、内容変更の有無等）が不明確で、実装方針が定まらない

4. **イベントクエストとの連携**: アイテムAの獲得方法が不明で、イベント全体の設計に影響する

## 2. 仕様の詳細化（サーバー観点）

### BOXガシャの基本構造

BOXガシャは、以下の要素で構成される：

1. **OprBOXガシャマスタ**: イベントごとのBOXガシャ定義（開始・終了日時、コスト等）
2. **OprBOXラインナップマスタ**: BOX内のアイテムリスト（アイテムID、個数、レアリティ等）
3. **UsrBOXガシャ進捗**: ユーザーごとのBOX引き状態（現在のBOX番号、引いた回数、残りアイテム等）
4. **UsrBOX残りアイテム**: ユーザーごとの現在BOXに残っているアイテムリスト

### BOXガシャ実行フロー

1. **BOX情報取得**
   - ユーザーの現在のBOX番号を特定
   - BOX内の残りアイテムを取得

2. **バリデーション**
   - イベント期間内かチェック
   - コスト（アイテムA）の所持数をチェック
   - 引く回数が残りアイテム数以下かチェック（後述の境界条件による）

3. **抽選実行**
   - BOX内の残りアイテムからランダムに指定回数分を抽選
   - 抽選されたアイテムをBOXから除外

4. **報酬配布**
   - 抽選結果のアイテムをユーザーに配布
   - 重複キャラクターがあれば変換処理

5. **BOX状態更新**
   - 残りアイテムを更新
   - BOXが空になった場合、リセット処理またはBOX番号インクリメント

6. **ログ記録・ミッショントリガー送信**
   - ガチャアクションログ記録
   - ミッション進捗トリガー送信

### BOXリセットと無限ボックス

- **通常BOX**: 定義された個数のBOX（例：BOX1, BOX2, BOX3）を順番に消化
- **無限ボックス**: 最終BOXを引き切った後、同じ内容で繰り返しリセット可能

## 3. 不明点・曖昧点・判断が必要な項目

### A. 仕様書に記載がなく判断不能な項目

#### A-1: BOXの具体的なラインナップ
- **該当箇所**: ゲーム体験仕様書 Page 18「BOX内には目玉報酬だけでなく、大量の『育成素材』や『通貨』が含まれる」
- **何が曖昧なのか**:
  - どのアイテムが何個入っているか具体的な定義がない
  - 目玉報酬が何か（レアキャラクター？限定アイテム？）が不明
  - BOX1, BOX2, BOX3 でラインナップが異なるのか、同じなのかが不明
- **サーバーとして明確化が必要な理由**:
  - マスタデータ設計に直結する
  - BOX総数の定義がないと抽選処理が実装できない

#### A-2: BOXリセットのトリガー条件
- **該当箇所**: ゲーム体験仕様書 Page 18「『あと〇回引ければリセットできる』」
- **何が曖昧なのか**:
  - BOXが空になったら自動でリセットされるのか
  - ユーザーが手動でリセットボタンを押すのか
  - 手動の場合、途中でリセットできるのか（例：BOXの残りが50個あるが、目玉を引いたのでリセットしたい）
- **サーバーとして明確化が必要な理由**:
  - リセットAPIの要否を判断する必要がある
  - 手動リセットの場合、不正利用（目玉だけ引いてリセット繰り返し）の対策が必要

#### A-3: 複数回引き時の境界条件
- **該当箇所**: ゲーム体験仕様書 Page 19「1回 ×150」「10回 ×1,500」
- **何が曖昧なのか**:
  - 10回引きを実行した際、BOXの残りが5個しかない場合、どうなるのか
    - パターン1: エラーで引けない
    - パターン2: 5個だけ引いて、残りの5回分はキャンセル（コストは5回分だけ消費）
    - パターン3: 5個引いた後、自動でBOXをリセットして残り5回を引く
- **サーバーとして明確化が必要な理由**:
  - パターンによって実装が大きく異なる
  - コスト消費の扱いも変わる

#### A-4: アイテムAの詳細
- **該当箇所**: ゲーム体験仕様書 Page 19「アイテムAを集めてBOXガシャを引こう」
- **何が曖昧なのか**:
  - アイテムAとは何か（イベント専用通貨？既存アイテム？）
  - どのクエストをクリアすると獲得できるのか
  - 1回150個、10回1,500個の意味（アイテムAのコストか？）
- **サーバーとして明確化が必要な理由**:
  - イベント全体の設計（クエスト→アイテム獲得→ガシャ実行）に影響する
  - アイテムマスタ設計に必要

#### A-5: 無限ボックスの詳細仕様
- **該当箇所**: ゲーム体験仕様書 Page 18「無限ボックス（エクストラ箱）」
- **何が曖昧なのか**:
  - 無限ボックスのラインナップは通常BOXと同じか、異なるか
  - 無限ボックスに移行するタイミング（通常BOXを何個引き切った後か）
  - 無限ボックスのリセット条件（毎回自動リセット？手動？）
- **サーバーとして明確化が必要な理由**:
  - 状態管理の設計が変わる
  - 無限ボックスの場合、リセットのたびにマスタからラインナップをコピーする処理が必要

#### A-6: 重複キャラクターの変換ルール
- **該当箇所**: ゲーム体験仕様書 Page 19「獲得済みのキャラはきちんとあけらたに自動変換されました」
- **何が曖昧なのか**:
  - 何に変換されるのか（専用アイテム？通貨？）
  - 変換レートはキャラクターのレアリティで変わるのか
- **サーバーとして明確化が必要な理由**:
  - 既存のガチャでは重複キャラ変換の実装があるが、BOXガシャでも同じルールを適用するか確認が必要

### B. 仕様書とコードの不一致

#### B-1: 天井機能の有無
- **該当ファイル**:
  - 仕様書: ゲーム体験仕様書 Page 18「天井の可視化」
  - コード: `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の天井カウンター処理
- **どのように矛盾しているか**:
  - 仕様書では「中身の総数が決まっているため、どれだけ運が悪くても引き続ければ必ず目玉報酬が手に入る」と記載されており、BOXガシャ自体が天井機能を内包している
  - 一方、既存のガチャ実装では別途天井カウンター（UsrGachaUpper）を管理している
  - BOXガシャに従来の天井機能も必要なのか、BOXの仕組み自体が天井なのか不明
- **影響**:
  - 天井機能が必要な場合、追加のテーブル・ロジックが必要
  - 不要な場合、既存のガチャ実装から天井関連の処理を除外する必要がある

#### B-2: プレイ回数制限の有無
- **該当ファイル**:
  - 仕様書: 記載なし
  - コード: `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `validatePlayCount`
- **どのように矛盾しているか**:
  - 既存のガチャでは1日あたりの最大プレイ回数制限がある
  - BOXガシャでは「報酬を取り切った後も継続できる『無限ボックス』」とあり、制限がないように読める
  - 仕様書に明示的な記載がない
- **影響**:
  - プレイ回数制限の有無で、DB設計とバリデーション処理が変わる

### C. サーバー側で仕様確定が必要な項目

#### C-1: BOXのデータ構造
- **決める必要がある点**:
  - ユーザーごとのBOX残りアイテムをどう管理するか
    - パターン1: マスタのラインナップを毎回コピーして、引いたアイテムを削除
    - パターン2: マスタのラインナップIDと「引いた個数」を記録し、残りを計算
  - どちらのパターンが性能・運用性の観点で適切か
- **プランナーへの確認ポイント**:
  - BOXの総アイテム数（例：100個、500個、1000個等）の想定
  - 総数が多い場合、パターン1ではDBレコード数が膨大になる可能性がある

#### C-2: ログ・分析要件
- **決める必要がある点**:
  - BOXガシャの分析で必要なログ項目
    - BOX番号、残りアイテム数、引いた回数、獲得アイテム等
  - 既存のガチャログ（LogGachaAction、外部ログ）に追加項目が必要か
- **プランナーへの確認ポイント**:
  - 運営側でBOXガシャの分析に必要なデータ（BOX完走率、途中リセット率等）

### D. ゲーム体験的に不自然な可能性がある項目

#### D-1: 10回引きのコスト効率
- **問題点**:
  - 仕様書には「1回 ×150」「10回 ×1,500」とあり、10回引きのコストが単純に10倍
  - 通常、ガチャの複数回引きではコスト効率が良くなる（例：1回100個、10回900個）
  - BOXガシャでコスト効率のメリットがない場合、10回引きを使う動機が薄い
- **想定される影響**:
  - ユーザーが1回ずつ引く傾向が強くなり、操作回数が増える（UI/UX的にストレスになる可能性）

#### D-2: BOXリセットの自由度
- **問題点**:
  - 仕様書では「あと〇回引ければリセットできる」とあり、完全に空にする必要がある前提
  - しかし、目玉を早期に引いた場合、残りの低価値アイテムを引く動機がなくなる
  - ユーザーが「無駄引き」と感じる可能性がある
- **想定される影響**:
  - 手動リセットを許可しない場合、ユーザー満足度が下がる可能性
  - 手動リセットを許可する場合、不正利用のリスクがある

## 4. プランナーへ確認が必要な項目まとめ（最重要）

### BOXラインナップ関連
- **Q1**: BOXのラインナップ（アイテム種類・個数）の具体的な定義を教えてください。目玉報酬とは何を指しますか？
- **Q2**: BOXは複数段階（例：BOX1, BOX2, BOX3）がありますか？ある場合、各BOXのラインナップは同じですか、異なりますか？
- **Q3**: BOX1個あたりの総アイテム数は何個を想定していますか？（100個？500個？1000個？）

### BOXリセット関連
- **Q4**: BOXのリセットは自動ですか、手動ですか？
  - 自動の場合: BOXが空になったら自動で次のBOXに移行する
  - 手動の場合: ユーザーが「リセット」ボタンを押す
- **Q5**: 手動リセットの場合、途中でリセットできますか？（例：BOXの残りが50個あるが、目玉を引いたのでリセットしたい）
  - 許可する場合: 残りアイテムはどうなりますか？（破棄？持ち越し？）
  - 許可しない場合: BOXが空になるまで引く必要がありますか？

### 複数回引きの境界条件
- **Q6**: 10回引きを実行した際、BOXの残りが5個しかない場合、どの挙動を想定していますか？
  - パターン1: エラーで引けない（残り個数以上は引けない）
  - パターン2: 5個だけ引いて、残りの5回分はキャンセル（コストは5回分だけ消費）
  - パターン3: 5個引いた後、自動でBOXをリセットして残り5回を引く

### アイテムA（コスト）関連
- **Q7**: 「アイテムA」とは具体的に何ですか？（イベント専用通貨？既存アイテム？）
- **Q8**: アイテムAはどのクエストで獲得できますか？（イベントクエスト？デイリークエスト？）
- **Q9**: 「1回 ×150」「10回 ×1,500」の意味を教えてください。アイテムAを150個消費して1回引けるという意味ですか？

### 無限ボックス関連
- **Q10**: 無限ボックスのラインナップは通常BOXと同じですか、異なりますか？
- **Q11**: 無限ボックスに移行するタイミングはいつですか？（通常BOXを何個引き切った後ですか？）
- **Q12**: 無限ボックスのリセットは毎回自動ですか、手動ですか？

### 重複キャラクター関連
- **Q13**: 重複キャラクターは何に変換されますか？（専用アイテム？通貨？）
- **Q14**: 変換レートはキャラクターのレアリティで変わりますか？

### 天井・回数制限関連
- **Q15**: BOXガシャに従来のガチャのような天井カウンター（UsrGachaUpper）は必要ですか？それともBOXの仕組み自体が天井ですか？
- **Q16**: BOXガシャに1日あたりの最大プレイ回数制限はありますか？

### コスト効率関連
- **Q17**: 10回引きのコストは1回引きの10倍（150×10=1,500）で確定ですか？割引はありませんか？

### イベント期間関連
- **Q18**: BOXガシャイベントの期間はどのくらいを想定していますか？（1週間？2週間？1ヶ月？）

## 5. サーバー開発への影響まとめ

### 実装前に必ず詰めるべき論点

1. **BOXラインナップの定義**: マスタデータ設計の前提となるため、最優先で確定が必要
2. **複数回引きの境界条件**: 実装ロジックが大きく変わるため、早期確定が必要
3. **BOXリセットのトリガー条件**: APIエンドポイントの設計に影響するため、確定が必要
4. **アイテムAの詳細**: イベント全体の設計に影響するため、確定が必要

### 不明点が残る場合のリスク

1. **実装の手戻り**: 仕様が後から変更された場合、DB設計・API設計の大幅な変更が必要になる可能性
2. **バグ・不整合**: 境界条件が曖昧なまま実装すると、想定外の挙動やデータ不整合が発生するリスク
3. **不正利用**: BOXリセットのルールが曖昧な場合、不正利用（目玉だけ引いてリセット繰り返し）のリスク
4. **性能問題**: BOX総数が多い場合、データ構造の選択を誤ると性能問題が発生するリスク

### スケジュール・品質への影響

- **影響度: 高**
  - 上記の不明点を詰めるプランナー確認に1〜2週間程度かかる可能性
  - 仕様確定後、DB設計・マスタ設計に1週間、API実装に2〜3週間を想定
  - 不明点が残ったまま実装を開始すると、手戻りリスクが高く、スケジュール遅延の可能性が高い

- **推奨アプローチ**:
  - まず「4. プランナーへ確認が必要な項目まとめ」の質問をプランナーに投げる
  - 回答を受けて、サーバー仕様を確定させる
  - 仕様確定後、DB設計・マスタ設計を行い、レビューを経てから実装を開始する
