# サーバーAPI要件書

## 1. ドキュメント情報
- **対象機能:** BOXガシャ
- **作成日:** 2025-11-26
- **参照ドキュメント:**
  - 01_サーバー要件抽出.md
  - 02_サーバー要件_コード調査追記.md
  - 03_サーバー仕様レビュー.md
  - 04_ゲーム体験仕様確認結果まとめ.md

## 2. 機能概要

### ユーザーに提供するゲーム体験
BOXガシャは、運要素を排除した「確実な報酬」を提供するイベント型ガチャ機能です。BOX内のアイテム総数が決まっており、引き続ければ必ず目玉報酬が手に入る「天井の可視化」により、ユーザーは安心して周回プレイを続けられます。イベントを遊ぶだけでキャラクター育成に必要な素材が自然と集まり、初心者・中級者の育成支援としても機能します。

### サーバーAPIが果たす役割
- BOXの状態（残りアイテム、BOX番号）をユーザーごとに管理
- BOX内の残りアイテムからランダムに抽選し、引いたアイテムを除外
- BOXが空になった際、またはユーザー操作によりBOXをリセット
- イベント専用アイテムを消費してガシャを実行
- 報酬配布、重複キャラクター変換、ログ記録、ミッショントリガー送信などの連携処理

## 3. API要件一覧

### 3.1 BOXラインナップ管理

#### 要件 REQ-BOX-001: BOXマスタデータの参照
- **要件ID:** REQ-BOX-001
- **概要:**
  - BOXガシャイベントごとのラインナップ情報をマスタデータから取得する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 18「BOX内には目玉報酬だけでなく、大量の『育成素材』や『通貨』が含まれる」
    - Page 18「中身の総数が決まっている」
  - APIで実現すべき内容:
    - BOXマスタから、指定されたBOXガシャイベントIDに対応するラインナップを取得
    - BOX1, BOX2, BOX3... 各BOXのアイテムリスト（アイテムID、個数、レアリティ）を取得
    - 無限ボックスのラインナップも取得可能（通常BOXと同じ、または異なるラインナップ）
  - 条件・制約:
    - BOX1個あたりの総アイテム数: 100個
    - BOXは複数段階あり、各BOXでラインナップが変わる
    - 目玉報酬は「レアリティが高いリソース」
  - データ管理要件:
    - BOXマスタデータはAPI側で参照のみ（編集はadminで実施）
  - 検証・チェック要件:
    - BOXマスタデータの整合性チェック（総個数が100個であることなど）
- **既存実装との関連:**
  - 既存のガチャ機能（OprGacha）と同様のマスタ参照パターンを流用
- **備考:**
  - 具体的なアイテムリストはマスタ設計時に確定

#### 要件 REQ-BOX-002: ユーザーごとのBOX残りアイテム管理
- **要件ID:** REQ-BOX-002
- **概要:**
  - ユーザーごとにBOXの残りアイテムを管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 18「ユーザーは明確なゴール（BOXの空）に向かってモチベーション高く周回を続けることができます」
  - APIで実現すべき内容:
    - BOX初回アクセス時、マスタのラインナップをコピーしてユーザー固有の残りアイテムリストを作成
    - ガシャ実行時、引いたアイテムを残りアイテムリストから除外
    - BOXリセット時、残りアイテムリストを初期状態に戻す（または次のBOXのラインナップで再初期化）
  - 条件・制約:
    - ユーザーごと、BOX番号ごとに残りアイテムを管理
    - BOXが空（残りアイテム0個）になったかを判定可能にする
  - データ管理要件:
    - ユーザーごとの残りアイテムリストを永続化
    - BOX1個あたり最大100レコード
  - 検証・チェック要件:
    - 残りアイテム数の整合性チェック（引いた回数と一致するか）
- **既存実装との関連:**
  - 新規実装（既存のガチャには残りアイテム管理の概念がない）
- **備考:**
  - データ構造は実装設計時に決定（全件記録 vs 引いた個数のみ記録）

### 3.2 BOX進捗管理

#### 要件 REQ-PROG-001: ユーザーごとのBOX番号管理
- **要件ID:** REQ-PROG-001
- **概要:**
  - ユーザーごとに現在のBOX番号を管理する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （確認結果）BOXは複数段階あり、各BOXでラインナップが変わる
  - APIで実現すべき内容:
    - ユーザーが現在引いているBOX番号（BOX1, BOX2, BOX3, ...）を記録
    - BOXリセット時、次のBOX番号にインクリメント（または手動リセットの場合は同じBOX番号）
    - 通常BOXの最後のBOX番号を超えたら、無限ボックスに移行
  - 条件・制約:
    - 通常BOX（例：BOX1, BOX2, BOX3）を全て引き終わった後、無限ボックスに移行
    - 無限ボックスは繰り返しリセット可能
  - データ管理要件:
    - ユーザーごとの現在BOX番号を永続化
  - 検証・チェック要件:
    - BOX番号の範囲チェック（1以上）
- **既存実装との関連:**
  - 新規実装
- **備考:**
  - 無限ボックスのBOX番号は特定の値（例：999）または通常BOX最大値+1で表現

#### 要件 REQ-PROG-002: BOX引き回数の記録
- **要件ID:** REQ-PROG-002
- **概要:**
  - ユーザーがBOXガシャを何回引いたかを記録する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （コード調査）既存のガチャでは引いた回数を記録している
  - APIで実現すべき内容:
    - 累計引き回数を記録
    - 現在のBOXで何回引いたかを記録
    - BOXリセット時、現在のBOXの引き回数をリセット
  - 条件・制約:
    - なし
  - データ管理要件:
    - ユーザーごとの累計引き回数、現在BOXの引き回数を永続化
  - 検証・チェック要件:
    - クライアントから送信された引いた回数とサーバー側の記録にズレがないかチェック
- **既存実装との関連:**
  - 既存のガチャ（UsrGacha）と同様の引き回数管理
- **備考:**
  - ズレチェック（validateDrewCount）は不正防止のため重要

### 3.3 BOXガシャ抽選

#### 要件 REQ-DRAW-001: BOXガシャ抽選処理
- **要件ID:** REQ-DRAW-001
- **概要:**
  - BOX内の残りアイテムからランダムに抽選し、アイテムを取得する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 18「BOX内の残りアイテムから抽選を行い、引いたアイテムを除外する仕組みが必要（天井保証の実装）」
  - APIで実現すべき内容:
    - BOXの残りアイテムリストからランダムに指定回数分を抽選
    - 抽選されたアイテムをBOXの残りアイテムリストから除外
    - 抽選結果を報酬として配布
  - 条件・制約:
    - 抽選はBOXの残りアイテムの中からのみ行う（重複抽選なし）
    - 複数回引きの場合、引く回数分だけ抽選を繰り返す
  - データ管理要件:
    - 抽選結果（獲得アイテムリスト）を記録
  - 検証・チェック要件:
    - 引く回数が残りアイテム数以下であることをチェック
- **既存実装との関連:**
  - 既存のガチャ（GachaService::draw）の抽選ロジックを参考にするが、BOXガシャは残りアイテムからの抽選という点で異なる
- **備考:**
  - 天井保証はBOXの仕組み自体に内包されている（既存の天井カウンターは使用しない）

#### 要件 REQ-DRAW-002: 単発引きと複数回引き
- **要件ID:** REQ-DRAW-002
- **概要:**
  - 1回引き、および複数回まとめて引く機能を提供する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 19「1回 ×150」「10回 ×1,500」
  - APIで実現すべき内容:
    - 1回引き、10回引きなど、マスタで定義された回数で引けるようにする
    - 各回数に応じたコスト（アイテムA消費数）を設定
  - 条件・制約:
    - 引く回数が残りアイテム数を超える場合はエラー（引けない）
    - マスタで定義されていない回数での引きはエラー
  - データ管理要件:
    - 引いた回数を記録
  - 検証・チェック要件:
    - 引く回数のバリデーション（マスタで許可されている回数か）
    - 残りアイテム数のチェック（引く回数 <= 残りアイテム数）
- **既存実装との関連:**
  - 既存のガチャ（GachaService::validatePlayNum）と同様のN連数チェック
- **備考:**
  - 複数回引きのコスト効率（割引）はマスタ設定で柔軟に定義可能

### 3.4 BOXリセット

#### 要件 REQ-RESET-001: 手動BOXリセット
- **要件ID:** REQ-RESET-001
- **概要:**
  - ユーザーが手動でBOXをリセットする
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （確認結果）Q4: ユーザー手動でリセット
    - （確認結果）Q5: 途中でも手動リセットできる
  - APIで実現すべき内容:
    - ユーザーからのリセット要求を受け付ける
    - BOXが空でなくても、途中でリセット可能
    - リセット時、残りアイテムを破棄（または持ち越し、要確認）
    - 次のBOX番号にインクリメント、または無限ボックスの場合は同じBOX番号で再初期化
  - 条件・制約:
    - リセット可能なタイミング: いつでも（BOXが空でなくても可）
    - リセット後は新しいBOXのラインナップで初期化される
  - データ管理要件:
    - リセット履歴を記録（ログ）
  - 検証・チェック要件:
    - リセット権限チェック（イベント期間内か）
- **既存実装との関連:**
  - 新規実装（既存のガチャにはリセット機能がない）
- **備考:**
  - **残存する不明点**: BOX途中リセット時の残りアイテムの扱い（破棄 or 持ち越し）を要確認

#### 要件 REQ-RESET-002: 無限ボックスのリセット
- **要件ID:** REQ-RESET-002
- **概要:**
  - 通常BOXを全て引き終わった後、無限ボックスに移行し、繰り返しリセット可能にする
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 18「無限ボックス（エクストラ箱）」
    - （確認結果）Q11: 通常BOXを引き終わった後から
    - （確認結果）Q12: 無限ボックスのリセットも手動
  - APIで実現すべき内容:
    - 通常BOXの最後のBOX番号を引き終わったら、無限ボックスに移行
    - 無限ボックスは手動リセットで何回でも繰り返し可能
    - 無限ボックスのラインナップは、マスタ設定で通常BOXと同じにも違うものにもできる
  - 条件・制約:
    - 無限ボックスはイベント終了まで継続可能
    - リセット回数に上限はない（要確認）
  - データ管理要件:
    - 無限ボックスのリセット回数を記録
  - 検証・チェック要件:
    - 通常BOXを全て引き終わっているかチェック
- **既存実装との関連:**
  - 新規実装
- **備考:**
  - 無限ボックスの終了条件（無限 or 上限あり）を要確認

### 3.5 コスト管理

#### 要件 REQ-COST-001: イベント専用アイテム（アイテムA）の消費
- **要件ID:** REQ-COST-001
- **概要:**
  - BOXガシャを引く際、イベント専用アイテム（アイテムA）を消費する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 19「アイテムAを集めてBOXガシャを引こう」
    - （確認結果）Q7,8: イベントプレイで獲得できる専用アイテム
    - （確認結果）Q9: アイテムAを150個消費して1回引ける
  - APIで実現すべき内容:
    - ガシャ実行前に、ユーザーのアイテムA所持数をチェック
    - 引く回数に応じたアイテムAを消費（例：1回=150個、10回=1,500個）
    - コスト不足の場合はエラー
  - 条件・制約:
    - コストはマスタで定義（1回、10回などの回数ごとに設定可能）
    - 割引設定も可能
  - データ管理要件:
    - アイテムA消費履歴を記録
  - 検証・チェック要件:
    - アイテムA所持数チェック
    - コストタイプのバリデーション（BOXガシャで許可されているコストタイプか）
- **既存実装との関連:**
  - 既存のガチャ（GachaService::setConsumeResource, execConsumeResource）と同様のコスト消費パターン
- **備考:**
  - アイテムAの具体的なアイテムIDはマスタ設計時に確定

### 3.6 報酬配布

#### 要件 REQ-REWARD-001: ガシャ結果の報酬配布
- **要件ID:** REQ-REWARD-001
- **概要:**
  - ガシャ抽選結果として獲得したアイテムをユーザーに配布する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 18「育成素材や通貨が含まれる」
  - APIで実現すべき内容:
    - 抽選結果のアイテムリストを報酬として配布
    - RewardDelegatorを使用して報酬配布処理を実行
    - トランザクション内でコスト消費→報酬配布の順序を厳守
  - 条件・制約:
    - コスト消費が成功した後に報酬配布を実行
  - データ管理要件:
    - 配布された報酬を記録
  - 検証・チェック要件:
    - 報酬配布の成功/失敗を確認
- **既存実装との関連:**
  - 既存のガチャ（RewardDelegator::sendRewards）と同じ報酬配布パターン
- **備考:**
  - トランザクション処理で整合性を保証

#### 要件 REQ-REWARD-002: 重複キャラクターの自動変換
- **要件ID:** REQ-REWARD-002
- **概要:**
  - 獲得したキャラクターが重複している場合、自動で別アイテムに変換する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 19「獲得済みのキャラはきちんとあけらたに自動変換されました」
    - （確認結果）Q13,14: 既存のガシャと同じでキャラのかけらアイテム
  - APIで実現すべき内容:
    - 報酬配布時、重複キャラクターを検出
    - 既存の変換ルール（キャラのかけらアイテムに変換）を適用
  - 条件・制約:
    - 既存のガチャと同じ変換ルール
  - データ管理要件:
    - 変換履歴を記録
  - 検証・チェック要件:
    - なし（既存実装を流用）
- **既存実装との関連:**
  - 既存のガチャと同じ重複キャラ変換処理を流用
- **備考:**
  - BOXガシャ固有の実装は不要

### 3.7 イベント管理

#### 要件 REQ-EVENT-001: イベント期間の管理
- **要件ID:** REQ-EVENT-001
- **概要:**
  - BOXガシャイベントの開始・終了時刻を管理し、期間外のアクセスを制限する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 18「イベント終了までゲームを遊ばせる」
    - （確認結果）Q18: 2週間とか1ヶ月とか。その時のイベントによる
  - APIで実現すべき内容:
    - BOXガシャマスタから開始・終了日時を取得
    - ガシャ実行前に、現在時刻が期間内かチェック
    - 期間外の場合はエラー
  - 条件・制約:
    - イベント期間はマスタで定義
  - データ管理要件:
    - イベント期間をマスタデータとして管理
  - 検証・チェック要件:
    - 期限チェック（validateExpiration）
- **既存実装との関連:**
  - 既存のガチャ（GachaService::validateExpiration）と同じ期限チェック
- **備考:**
  - 期間は2週間〜1ヶ月程度を想定

#### 要件 REQ-EVENT-002: プレイ回数制限なし
- **要件ID:** REQ-EVENT-002
- **概要:**
  - BOXガシャには1日あたりの最大プレイ回数制限を設けない
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （確認結果）Q16: BOXガシャに1日あたりの最大プレイ回数制限はない
  - APIで実現すべき内容:
    - プレイ回数制限のバリデーションを実施しない
  - 条件・制約:
    - コスト（アイテムA）の所持数のみが制約
  - データ管理要件:
    - なし
  - 検証・チェック要件:
    - validatePlayCount処理は不要
- **既存実装との関連:**
  - 既存のガチャとは異なる（既存はプレイ回数制限あり）
- **備考:**
  - プレイ回数制限がないため、既存のGachaDrawUseCaseからvalidatePlayCountを除外する

### 3.8 ログ・分析

#### 要件 REQ-LOG-001: ガチャアクションログの記録
- **要件ID:** REQ-LOG-001
- **概要:**
  - ガシャ実行時、ガチャアクションログを記録する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （コード調査）既存のガチャではLogGachaActionを記録している
  - APIで実現すべき内容:
    - ガシャID、コストタイプ、引いた回数などの基本情報を記録
    - BOXガシャ固有の情報（BOX番号、残りアイテム数など）も記録
  - 条件・制約:
    - ログはDB（log DB）に永続化
  - データ管理要件:
    - LogGachaActionテーブルに記録
  - 検証・チェック要件:
    - なし
- **既存実装との関連:**
  - 既存のガチャ（LogGachaActionRepository）と同じログ記録パターン
- **備考:**
  - BOXガシャ固有のログ項目があれば追加設計時に検討

#### 要件 REQ-LOG-002: ガチャログの外部送信
- **要件ID:** REQ-LOG-002
- **概要:**
  - ガチャ結果の詳細を外部ログシステムに送信する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （コード調査）既存のガチャではGachaLogServiceで外部ログを送信している
  - APIで実現すべき内容:
    - ガチャ結果の詳細（獲得アイテム、コスト等）を外部ログシステムに送信
  - 条件・制約:
    - なし
  - データ管理要件:
    - 外部ログシステムで管理
  - 検証・チェック要件:
    - なし
- **既存実装との関連:**
  - 既存のガチャ（GachaLogService::sendGachaLog）と同じ外部ログ送信パターン
- **備考:**
  - 既存実装を流用

#### 要件 REQ-LOG-003: ガチャ履歴のキャッシュ保存
- **要件ID:** REQ-LOG-003
- **概要:**
  - ガチャ結果をキャッシュに保存し、ユーザーが履歴を確認できるようにする
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （コード調査）既存のガチャではガチャ履歴をキャッシュに保存している
  - APIで実現すべき内容:
    - ガシャ実行後、獲得アイテムリストをキャッシュに保存
    - ユーザーが「ガチャ履歴」画面で過去の結果を確認できるようにする
  - 条件・制約:
    - キャッシュの保存期間はシステム設定に従う
  - データ管理要件:
    - Redisなどのキャッシュストアに保存
  - 検証・チェック要件:
    - なし
- **既存実装との関連:**
  - 既存のガチャ（GachaService::addGachaHistory）と同じ履歴保存パターン
- **備考:**
  - 既存実装を流用

### 3.9 ミッション連携

#### 要件 REQ-MISSION-001: ミッショントリガーの送信
- **要件ID:** REQ-MISSION-001
- **概要:**
  - ガシャ実行時、ミッションシステムへトリガーを送信する
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - （コード調査）既存のガチャではGachaMissionTriggerServiceを使用している
  - APIで実現すべき内容:
    - ガシャ実行時、ミッション進捗を更新するためのトリガーを送信
    - トリガーにはガシャID、引いた回数などの情報を含む
  - 条件・制約:
    - なし
  - データ管理要件:
    - ミッションシステム側で管理
  - 検証・チェック要件:
    - なし
- **既存実装との関連:**
  - 既存のガチャ（GachaMissionTriggerService::sendDrawTrigger）と同じトリガー送信パターン
- **備考:**
  - 既存実装を流用

### 3.10 レスポンスデータ

#### 要件 REQ-RESPONSE-001: ガシャ実行結果のレスポンス
- **要件ID:** REQ-RESPONSE-001
- **概要:**
  - ガシャ実行後、獲得アイテム、ユーザー状態などをレスポンスとして返す
- **詳細仕様:**
  - ゲーム体験仕様書の記載:
    - Page 19「ガシャ結果」画面
  - APIで実現すべき内容:
    - 獲得したアイテムリスト（GachaReward）
    - ユニット・アイテムの変更差分（UsrUnit, UsrItem）
    - ユーザーパラメータ（所持通貨、レベル等）
    - BOX進捗情報（現在のBOX番号、残りアイテム数）
  - 条件・制約:
    - レスポンスにはガシャ実行後の最新状態を含める
  - データ管理要件:
    - なし
  - 検証・チェック要件:
    - なし
- **既存実装との関連:**
  - 既存のガチャ（GachaDrawResultData）と同様のレスポンスデータ構造
- **備考:**
  - BOX進捗情報（BOX番号、残りアイテム数）を追加で返す必要あり

## 4. 要件間の依存関係

### 4.1 前提となる要件
- **REQ-DRAW-001（BOXガシャ抽選処理）** は **REQ-BOX-002（BOX残りアイテム管理）** が実現されていることを前提とする
- **REQ-RESET-001（手動BOXリセット）** は **REQ-PROG-001（BOX番号管理）** が実現されていることを前提とする
- **REQ-REWARD-001（報酬配布）** は **REQ-COST-001（コスト消費）** が成功していることを前提とする

### 4.2 同時に実現すべき要件
- **REQ-DRAW-001（BOXガシャ抽選処理）** と **REQ-COST-001（コスト消費）** は同時に実現される必要がある（トランザクション内で実行）
- **REQ-LOG-001（ガチャアクションログ）** と **REQ-LOG-002（外部ログ送信）** と **REQ-LOG-003（履歴キャッシュ）** は同時に実現される必要がある

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **レスポンスタイム:** ガシャ実行APIのレスポンスタイムは3秒以内を目標とする
- **同時接続数:** イベント開始直後のピーク時に500同時接続を想定
- **データベース負荷:** BOX1個あたり最大100レコードの管理を想定し、ユーザー数×100レコードに耐えられる設計が必要

### 5.2 セキュリティ要件
- **不正防止:**
  - 引いた回数のズレチェック（validateDrewCount）により、クライアント改ざんを検出
  - コストタイプのバリデーションにより、不正なリクエストを拒否
  - 残りアイテム数チェックにより、存在しないアイテムの取得を防止
- **データ保護:**
  - ユーザーごとのBOX状態はユーザーIDで隔離
  - トランザクション処理によりデータ整合性を保証

### 5.3 可用性要件
- **サービス継続性:** イベント期間中は24時間365日稼働
- **エラーハンドリング:**
  - コスト不足、残りアイテム不足などの予測可能なエラーは適切なエラーメッセージを返す
  - 予期しないエラーが発生した場合、トランザクションロールバックによりデータ不整合を防止

### 5.4 その他の非機能要件
- **ログ記録:** 全てのガシャ実行をログに記録し、運営分析・デバッグに活用
- **監視:** ガシャ実行回数、エラー発生率などをモニタリング
- **運用:** イベント期間終了後、ユーザーデータのアーカイブまたは削除

## 6. データ要件

### 6.1 永続化が必要なデータ

#### データ項目1: BOXマスタデータ
- **内容:** BOXガシャイベントごとのラインナップ情報（アイテムID、個数、レアリティ）
- **用途:** BOX初期化時にラインナップを取得
- **保持期間:** 永久（マスタデータ）
- **関連要件:** REQ-BOX-001

#### データ項目2: ユーザーBOX進捗
- **内容:** ユーザーごとの現在BOX番号、累計引き回数、現在BOXの引き回数、最終実行日時
- **用途:** BOX状態の管理
- **保持期間:** イベント終了後一定期間（例：1ヶ月）
- **関連要件:** REQ-PROG-001, REQ-PROG-002

#### データ項目3: ユーザーBOX残りアイテム
- **内容:** ユーザーごとのBOX残りアイテムリスト（アイテムID、残り個数）
- **用途:** ガシャ抽選時に使用
- **保持期間:** イベント終了後一定期間（例：1ヶ月）
- **関連要件:** REQ-BOX-002

#### データ項目4: ガチャアクションログ
- **内容:** ガシャ実行履歴（ガシャID、ユーザーID、コストタイプ、引いた回数、BOX番号等）
- **用途:** 運営分析、デバッグ
- **保持期間:** 永久（ログデータ）
- **関連要件:** REQ-LOG-001

### 6.2 一時的に管理が必要なデータ

#### データ項目1: ガチャ履歴キャッシュ
- **内容:** ユーザーごとのガシャ実行結果（獲得アイテムリスト）
- **用途:** ガチャ履歴画面での表示
- **保持期間:** 7日間（キャッシュ）
- **関連要件:** REQ-LOG-003

## 7. 外部システム連携要件

### 7.1 クライアント連携
- **データ送受信:**
  - クライアント→サーバー: ガシャ実行リクエスト（ガシャID、引く回数、引いた累計回数）
  - サーバー→クライアント: ガシャ実行結果（獲得アイテム、BOX進捗、ユーザー状態）
- **同期要件:**
  - 引いた累計回数の同期（クライアント側とサーバー側でズレがないかチェック）

### 7.2 他API機能との連携
- **報酬配布システム（RewardDelegator）:** ガシャ結果の報酬を配布
- **ミッションシステム（GachaMissionTriggerService）:** ガシャ実行時にトリガーを送信
- **ユーザー管理（UserDelegator）:** ユーザーパラメータの取得・更新
- **リソース管理（UsrModelDiffGetService）:** ユニット・アイテムの変更差分を取得

### 7.3 外部サービス連携
- **外部ログシステム（GachaLogService）:** ガシャ結果の詳細を送信

## 8. 残存する不明点・要確認事項

### 8.1 まだ不明な仕様

#### 8.1.1 BOX途中リセット時の残りアイテムの扱い
- **何が不明か:** ユーザーがBOXを途中でリセットした際、残りアイテムは破棄されるのか、持ち越されるのか
- **実装への影響:** リセット処理のロジックが変わる（破棄の場合は単純に初期化、持ち越しの場合は残りアイテムを次のBOXに追加）
- **確認すべき相手:** ゲーム企画担当者

#### 8.1.2 無限ボックスの終了条件
- **何が不明か:** 無限ボックスは本当に「無限」なのか、それとも一定回数（例：10回リセット）で終了するのか
- **実装への影響:** リセット回数の上限管理が必要かどうか
- **確認すべき相手:** ゲーム企画担当者

#### 8.1.3 BOXリセットのコスト
- **何が不明か:** BOXをリセットする際、コストは不要か？（無料でリセット可能か？）
- **実装への影響:** リセットAPIでコスト消費処理が必要かどうか
- **確認すべき相手:** ゲーム企画担当者

#### 8.1.4 BOXラインナップの具体的な定義
- **何が不明か:** BOX1, BOX2, BOX3... 各BOXの具体的なラインナップ（アイテムID、個数、レアリティ）
- **実装への影響:** マスタデータ設計に必要
- **確認すべき相手:** ゲーム企画担当者（マスタ設計時に確定）

### 8.2 実装時に判断が必要な事項

#### 8.2.1 BOXのデータ構造
- **内容:** ユーザーごとのBOX残りアイテムをどう管理するか
  - パターン1: UsrBOXRemainingItems テーブルに残りアイテムを全件記録（最大100レコード/BOX）
  - パターン2: UsrBOXProgress テーブルに「引いた個数」を記録し、残りを計算
- **判断基準:** パフォーマンス、運用性、実装コスト
- **推奨:** パターン1（100個程度ならDB負荷は許容範囲）

## 9. 要件確定度の評価

### 9.1 全体評価
- **要件の確定度:** 85%
- **API実装に必要な要件情報の充足度:** やや不足（BOX途中リセット時の残りアイテムの扱いなど、一部不明点あり）
- **実装開始の可否:** 条件付き可（残存する不明点を確認しながら進める）

### 9.2 カテゴリ別評価
- **BOXラインナップ管理:** 確定度 80%、課題：具体的なアイテムリストはマスタ設計時に確定、実装準備状況：OK
- **BOX進捗管理:** 確定度 90%、課題：なし、実装準備状況：OK
- **BOXガシャ抽選:** 確定度 90%、課題：なし、実装準備状況：OK
- **BOXリセット:** 確定度 70%、課題：途中リセット時の残りアイテムの扱いが不明、実装準備状況：要確認
- **コスト管理:** 確定度 85%、課題：アイテムAの具体的なアイテムIDはマスタ設計時に確定、実装準備状況：OK
- **報酬配布:** 確定度 95%、課題：なし、実装準備状況：OK
- **イベント管理:** 確定度 90%、課題：なし、実装準備状況：OK
- **ログ・分析:** 確定度 90%、課題：なし、実装準備状況：OK
- **ミッション連携:** 確定度 95%、課題：なし、実装準備状況：OK
- **レスポンスデータ:** 確定度 90%、課題：なし、実装準備状況：OK

## 10. 次のステップ

### 10.1 要件確定のために必要なアクション
- [ ] **最優先**: BOX途中リセット時の残りアイテムの扱いを確認（破棄 or 持ち越し）
- [ ] **推奨**: 無限ボックスの終了条件を確認（無限 or 上限あり）
- [ ] **推奨**: BOXリセットのコストを確認（無料 or 有料）
- [ ] マスタ設計時にBOXラインナップの詳細を確定

### 10.2 実装設計へ向けて
- [ ] **次段階**: API実装全体概要設計（Stage 6）- どのAPIエンドポイントが必要かを整理
- [ ] **次段階**: サーバーAPI設計書作成（Stage 7）- 各APIの詳細仕様（リクエスト・レスポンス・エラー）を設計
- [ ] **次段階**: サーバーAPI機能要件実装設計（Stage 8）- DB設計、ドメイン設計、クリーンアーキテクチャでの実装設計
- [ ] DB設計（テーブル定義、インデックス設計）
- [ ] マスタデータ設計（BOXマスタ、アイテムマスタ）
- [ ] API実装（BOXガシャ抽選UseCase、BOXリセットUseCase等）
- [ ] テスト設計（ユニットテスト、統合テスト、シナリオテスト）
