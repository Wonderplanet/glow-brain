# BOXガシャ - サーバー要件（コード調査による追加・補足）

## サーバー要件（コード調査による追加・補足）

### 要件C-1
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ガチャ抽選処理
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャ抽選処理では、全てのDB更新処理をトランザクションで囲む必要がある
- **詳細:**
  - 既存のガチャ実装では、リソース消費と報酬配布をトランザクション内で実行している
  - トランザクション処理により、処理の途中でエラーが発生した場合にロールバックし、データの整合性を保証する
- **元になったコードの抜粋:**
  ```php
  // トランザクションで囲んでDB更新処理を実行する
  $this->applyUserTransactionChanges(function () use (...) {
      // リソース消費を実行
      $this->gachaService->execConsumeResource($logGachaAction);

      // 報酬配布実行
      $this->rewardDelegator->sendRewards($usr->getUsrUserId(), $platform, $now);

      // ガチャ履歴のキャッシュ保存
      $this->gachaService->addGachaHistory(...);
  });
  ```
- **備考:**
  - 仕様書には記載がないが、データ整合性を保つために必須の要件

### 要件C-2
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / 処理順序
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャ実行時、リソース消費→報酬配布の順序を厳守する必要がある
- **詳細:**
  - トランザクション内で、まずコスト（通貨・アイテム等）を消費し、その後報酬を配布する順序で処理を行う
  - この順序により、リソース不足時に報酬が配布されることを防ぐ
- **元になったコードの抜粋:**
  ```php
  $this->applyUserTransactionChanges(function () use (...) {
      // 1. リソース消費を実行
      $this->gachaService->execConsumeResource($logGachaAction);

      // 2. 報酬配布実行
      $this->rewardDelegator->sendRewards($usr->getUsrUserId(), $platform, $now);
  });
  ```
- **備考:**
  - 仕様書には記載がないが、既存のガチャ実装で確立されたパターン

### 要件C-3
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ミッションシステム連携
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
  - `api/app/Domain/Gacha/Services/GachaMissionTriggerService.php`
- **内容の要約:**
  - ガシャ実行時、ミッションシステムへトリガーを送信する必要がある
- **詳細:**
  - ガチャを引いた際、ミッション進捗を更新するためのトリガーを送信する
  - トリガーにはガチャID、引いた回数などの情報を含む
- **元になったコードの抜粋:**
  ```php
  // ミッショントリガー送信
  $this->gachaMissionTriggerService->sendDrawTrigger($oprGacha->getId(), $playNum);
  ```
- **備考:**
  - 仕様書には記載がないが、ミッション「〇〇回ガシャを引く」などの条件達成判定に必要

### 要件C-4
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ガチャ履歴管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガチャ結果をキャッシュに保存し、後で参照できるようにする必要がある
- **詳細:**
  - ガチャ実行後、ガチャID、コストタイプ、引いた回数、獲得した報酬などの情報をキャッシュに保存する
  - この履歴は、ユーザーが「ガチャ履歴」画面で過去の結果を確認する際に使用される
- **元になったコードの抜粋:**
  ```php
  // ガチャ履歴のキャッシュ保存
  $gachaRewards = $this->rewardDelegator->getSentRewards(GachaReward::class);
  $this->gachaService->addGachaHistory(
      $usr->getUsrUserId(),
      $oprGachaId,
      $costType->value,
      $costId,
      $costNum,
      $playNum,
      $now,
      $gachaRewards
  );
  ```
- **備考:**
  - 仕様書には記載がないが、ユーザー体験として履歴表示が必要

### 要件C-5
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / 広告視聴による無料ガシャ
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
  - `api/app/Domain/Common/Services/AdPlayService.php`
- **内容の要約:**
  - 広告視聴でガシャを引く機能がある場合、広告視聴ログとミッショントリガーを送信する必要がある
- **詳細:**
  - コストタイプが広告（CostType::AD）の場合、広告視聴回数をカウントし、上限チェックを行う
  - 広告視聴ログを記録し、ミッショントリガーを送信する
- **元になったコードの抜粋:**
  ```php
  if ($costType === CostType::AD) {
      // 広告で引く場合
      $usrGacha->incrementAdPlayCount($playNum);
      $this->gachaService->validateAd($oprGacha, $usrGacha);
      $usrGacha->setAdPlayedAt($now->toDateTimeString());
      $checkedAd = true;

      // 広告視聴ログ・ミッショントリガー送信
      $this->adPlayService->adPlay(
          $usr->getUsrUserId(),
          ContentType::GACHA->value,
          $oprGacha->getId(),
          $now
      );
  }
  ```
- **備考:**
  - 仕様書には記載がないが、BOXガシャでも広告視聴による無料引きを提供する可能性がある

### 要件C-6
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / プレイ回数制限
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャの最大プレイ回数制限がある場合、バリデーションを行う必要がある
- **詳細:**
  - ガシャ実行前にプレイ回数をインクリメントし、最大回数を超えていないかチェックする
  - 超えている場合はエラーを返す
- **元になったコードの抜粋:**
  ```php
  // ガシャ回数カウントとチェック
  $usrGacha->incrementPlayCount($playNum);
  $this->gachaService->validatePlayCount($oprGacha, $usrGacha);
  $usrGacha->setPlayedAt($now->toDateTimeString());
  ```
- **備考:**
  - 仕様書には記載がないが、イベント期間中の引き放題防止などで必要になる可能性がある

### 要件C-7
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / 有効期限チェック
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャの有効期限をチェックし、期限外の場合はエラーを返す必要がある
- **詳細:**
  - ガシャ実行前に、現在時刻がガシャの有効期間内かチェックする
  - 期間外の場合はエラーを返す
- **元になったコードの抜粋:**
  ```php
  $now = $this->clock->now();
  $this->gachaService->validateExpiration($usrGacha, $now);
  ```
- **備考:**
  - 仕様書の「要件10: イベント期間管理」の補足

### 要件C-8
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / 天井カウンター管理
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャに天井機能がある場合、天井カウンターを管理する必要がある
- **詳細:**
  - ガシャ実行時、天井情報（OprGachaUpper、UsrGachaUpper）を取得し、カウンターを更新する
  - 天井到達時、特定の報酬を確定で配布する
- **元になったコードの抜粋:**
  ```php
  // ガシャ天井情報取得
  $oprGachaUppers = collect();
  $usrGachaUppers = collect();
  if ($oprGacha->hasUpper()) {
      $oprGachaUppers = $this->gachaService->getOprGachaUppers($oprGacha->getUpperGroup());
      $usrGachaUppers = $this->gachaService->getUsrGachaUppers(
          $usr->getUsrUserId(),
          $oprGacha->getUpperGroup(),
          $oprGachaUppers->map(fn($upper) => $upper->getUpperType()->value),
      );
  }
  ```
- **備考:**
  - 仕様書の「要件2: 目玉報酬の確実な提供」と関連するが、天井機能は別の仕組みである可能性がある

### 要件C-9
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / 引いた回数のズレチェック
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - クライアントから送信された引いた回数とサーバー側の記録にズレがないかチェックする必要がある
- **詳細:**
  - クライアントは、ガシャを引いた総回数（drewCount）をリクエストに含めて送信する
  - サーバー側は、この値とDB上の記録を比較し、ズレがある場合はエラーを返す
  - これにより、クライアント側の状態とサーバー側の状態の不整合を検出できる
- **元になったコードの抜粋:**
  ```php
  // 既に引いている数にズレがないかチェック
  $this->gachaService->validateDrewCount($drewCount, $usrGacha->getCount());
  ```
- **備考:**
  - 仕様書には記載がないが、不正防止や同期ずれ検出のために重要

### 要件C-10
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / コストタイプの検証
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャタイプに対するコスト種類（通貨、アイテム、広告等）が適切かチェックする必要がある
- **詳細:**
  - ガシャ設定で許可されているコストタイプ以外のリクエストはエラーとして拒否する
  - 例：無料ガシャで有料通貨を要求するリクエスト、有料ガシャで広告視聴を要求するリクエストなど
- **元になったコードの抜粋:**
  ```php
  // ガシャタイプに対するコスト種類が適切かチェック
  $this->gachaService->validateCostType($oprGacha, $costType);
  ```
- **備考:**
  - 仕様書には記載がないが、不正リクエスト防止のために必須

### 要件C-11
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / 複数回引きのバリデーション
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - 一度に引く回数（N連）が、ガシャ設定で許可されている値かチェックする必要がある
- **詳細:**
  - ガシャ設定に定義されている複数回引きの回数（例：1, 10, 100）以外の値はエラーとして拒否する
  - 仕様書では「1回 ×150」「10回 ×1,500」という記載があるが、実際には任意の回数を許可するのではなく、設定された回数のみ許可する
- **元になったコードの抜粋:**
  ```php
  // N連数のチェック
  $this->gachaService->validatePlayNum($playNum, $oprGacha->getMultiDrawCount());
  ```
- **備考:**
  - 仕様書の「要件8: 単発引きと複数回引き」の補足

### 要件C-12
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ガチャログ記録
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
  - `api/app/Domain/Gacha/Repositories/LogGachaActionRepository.php`
  - `api/app/Domain/Gacha/Services/GachaLogService.php`
- **内容の要約:**
  - ガチャ実行時、複数のログを記録する必要がある
- **詳細:**
  - ガチャアクションログ（LogGachaAction）: ガチャID、コストタイプ、引いた回数、天井カウンター等を記録
  - ガチャログ（外部システム）: ガチャ結果の詳細を外部ログシステムに送信
- **元になったコードの抜粋:**
  ```php
  // ログ
  $logGachaAction = $this->logGachaActionRepository->create(
      $usr->getUsrUserId(),
      $oprGacha->getId(),
      $costType->value,
      $playNum,
      $upperCounts->get(UpperType::MAX_RARITY->value, 0),
      $upperCounts->get(UpperType::PICKUP->value, 0),
  );

  // ログ送信
  $this->gachaLogService->sendGachaLog(
      $usr->getUsrUserId(),
      $oprGachaId,
      $gachaResultData,
      $costType->value,
      $playNum
  );
  ```
- **備考:**
  - 仕様書には記載がないが、運営分析やデバッグのために必須

### 要件C-13
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ユニット・アイテムの差分取得
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
  - `api/app/Domain/Resource/Usr/Services/UsrModelDiffGetService.php`
- **内容の要約:**
  - ガシャ実行前後でのユニット・アイテムの変更差分を取得し、レスポンスに含める必要がある
- **詳細:**
  - ガシャで獲得したユニット・アイテムだけでなく、重複キャラの変換などで変更されたユニット・アイテムの差分もレスポンスに含める
  - これにより、クライアント側で適切にUIを更新できる
- **元になったコードの抜粋:**
  ```php
  return new GachaDrawResultData(
      $gachaRewards,
      $this->usrModelDiffGetService->getChangedUsrUnits(),
      $this->usrModelDiffGetService->getChangedUsrItems(),
      $this->makeUsrParameterData(...),
      $usrGacha,
      $usrGachaUppers
  );
  ```
- **備考:**
  - 仕様書の「要件9: ガシャ結果の表示」の補足

### 要件C-14
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ユーザーデータの保存
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャ実行後、ユーザーのガシャ引き状態（引いた回数、最終実行日時等）を保存する必要がある
- **詳細:**
  - UsrGacha、UsrGachaUpperなどのユーザー固有のガシャ状態をDBに保存する
  - これにより、次回ガシャ実行時に状態を復元できる
- **元になったコードの抜粋:**
  ```php
  // ユーザデータの保存
  $this->gachaService->saveUsr($usrGacha, $usrGachaUppers);
  ```
- **備考:**
  - 仕様書の「要件11: BOXの残数・進捗状態の管理」の補足

### 要件C-15
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ガチャ抽選BOX取得
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャ抽選時、抽選BOXデータを取得する必要がある
- **詳細:**
  - ガシャ抽選BOX（GachaLotteryBoxData）には、抽選可能なアイテムリスト、各アイテムの重み、排出率などの情報が含まれる
  - BOXガシャの場合、この抽選BOXがユーザーごとに異なる（既に引いたアイテムを除外）可能性がある
- **元になったコードの抜粋:**
  ```php
  // ガチャ抽選BOX取得
  $gachaLotteryBoxData = $this->gachaService->getGachaLotteryBox($oprGacha);
  ```
- **備考:**
  - 仕様書の「要件1: BOX内アイテムの総数管理」および「要件2: 目玉報酬の確実な提供」と密接に関連

### 要件C-16
- **種別:** コードから判明した追加要件
- **関連機能:** BOXガシャ / ユーザーパラメータの返却
- **関連ファイル:**
  - `api/app/Domain/Gacha/UseCases/GachaDrawUseCase.php` の `exec` メソッド
- **内容の要約:**
  - ガシャ実行後、ユーザーパラメータ（所持通貨、レベル等）をレスポンスに含める必要がある
- **詳細:**
  - ガシャ実行後の最新のユーザーパラメータ（UsrUserParameter）をレスポンスに含めることで、クライアント側でUI更新が容易になる
  - コスト消費により通貨が減少した場合、その最新値がレスポンスに含まれる
- **元になったコードの抜粋:**
  ```php
  return new GachaDrawResultData(
      $gachaRewards,
      $this->usrModelDiffGetService->getChangedUsrUnits(),
      $this->usrModelDiffGetService->getChangedUsrItems(),
      $this->makeUsrParameterData(
          $this->userDelegator->getUsrUserParameterByUsrUserId($usr->getUsrUserId())
      ),
      $usrGacha,
      $usrGachaUppers
  );
  ```
- **備考:**
  - 仕様書には記載がないが、クライアント側での状態管理のために有用
