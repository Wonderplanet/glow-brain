# ディレクトリ構造

## API アプリケーション構造

```
api/
└── app/
    ├── Console/                    # Artisanコマンド
    │
    ├── Domain/                     # ドメインレイヤー（※詳細後述）
    │
    ├── Http/                       # HTTPレイヤー
    │   ├── Controllers/            # コントローラー
    │   ├── Middleware/             # ミドルウェア
    │   ├── Requests/               # リクエストバリデーション
    │   │   ├── Api/                # API用リクエスト
    │   │   └── Traits/             # リクエスト用トレイト
    │   ├── Resources/              # マスタデータリソース変換
    │   │   └── Api/
    │   │       ├── Masterdata/
    │   │       ├── Masteri18ndata/
    │   │       ├── Operationdata/
    │   │       └── Operationi18ndata/
    │   ├── ResponseFactories/      # レスポンス生成ファクトリー
    │   ├── Responses/              # レスポンスデータ構造
    │   │   ├── Data/               # yml定義のDataクラス
    │   │   └── ResultData/         # yml定義のResultDataクラス
    │   └── Lib/                    # HTTP共通ライブラリ
    │       └── Requests/
    │
    ├── Infrastructure/             # インフラストラクチャレイヤー
    │   ├── DynamoDB/               # DynamoDBクライアント
    │   ├── UsrModelManager.php     # ユーザーモデルキャッシュ管理
    │   ├── LogModelManager.php     # ログモデル管理
    │   ├── MasterRepository.php    # マスタデータリポジトリ
    │   └── MngCacheRepository.php  # 運営データキャッシュ
    │
    └── Providers/                  # サービスプロバイダー
```

## Domainディレクトリ詳細

### ドメインモジュール構造

各ドメインは以下の構造に従います：

```
Domain/
├── [DomainName]/                   # 例: Stage, Item, User等
│   ├── Delegators/                 # 他ドメインへの公開窓口
│   │   └── [DomainName]Delegator.php
│   ├── UseCases/                   # ユースケース（API単位）
│   │   └── [Action]UseCase.php
│   ├── Services/                   # ドメインサービス
│   │   └── [Name]Service.php
│   ├── Repositories/               # リポジトリ
│   │   ├── [Table]Repository.php
│   │   └── Contracts/              # リポジトリインターフェース
│   ├── Models/                     # Eloquentモデル
│   │   ├── [Table].php
│   │   └── Contracts/              # モデルインターフェース
│   ├── Entities/                   # ドメインエンティティ
│   ├── Enums/                      # 列挙型
│   ├── Constants/                  # 定数
│   └── Factories/                  # ファクトリー（必要な場合）
```

### 共通・共有モジュール

```
Domain/
├── Common/                         # 全ドメイン共通
│   ├── Constants/                  # システム定数、エラーコード
│   ├── Entities/                   # 共通エンティティ (Clock, Lottery等)
│   ├── Enums/                      # 共通Enum
│   ├── Exceptions/                 # GameException等
│   ├── Facades/                    # ファサード
│   ├── Factories/                  # 共通ファクトリー
│   ├── Managers/                   # マネージャー
│   │   └── Cache/                  # キャッシュ管理
│   ├── Models/                     # 共通モデル
│   ├── Notifications/              # 通知
│   ├── Repositories/               # 共通リポジトリ
│   ├── Services/                   # 共通サービス
│   ├── Traits/                     # UseCaseTrait等
│   └── Utils/                      # ユーティリティ
│       ├── ArrayUtil.php
│       ├── CacheUtil.php
│       ├── LogUtil.php
│       ├── MathUtil.php
│       └── StringUtil.php
│
├── Resource/                       # 全ドメイン共有リソース
│   ├── Constants/                  # 共有定数
│   ├── Dtos/                       # 共有DTO
│   ├── Enums/                      # 共有Enum
│   ├── Entities/                   # 複数ドメイン共有エンティティ
│   │   ├── Rewards/                # 報酬関連エンティティ
│   │   ├── CurrencyTriggers/       # 通貨トリガー
│   │   └── LogTriggers/            # ログトリガー
│   ├── Traits/                     # 共有トレイト
│   │
│   ├── Mst/                        # マスタデータ（全ドメイン共有）
│   │   ├── Entities/               # マスタエンティティ
│   │   │   └── Contracts/          # マスタエンティティインターフェース
│   │   ├── Models/                 # マスタモデル
│   │   │   └── Contracts/          # マスタモデルインターフェース
│   │   ├── Repositories/           # マスタリポジトリ
│   │   │   └── Contracts/
│   │   ├── Services/               # マスタサービス
│   │   └── Traits/                 # マスタ用トレイト
│   │
│   ├── Usr/                        # ユーザーデータ（共有リソース）
│   │   ├── Entities/               # ユーザーモデルエンティティ
│   │   ├── Models/                 # 共有ユーザーモデル
│   │   │   └── Contracts/
│   │   ├── Repositories/           # 共有ユーザーリポジトリ
│   │   │   └── Contracts/
│   │   └── Services/               # UsrModelDiffGetService等
│   │
│   ├── Log/                        # ログデータ
│   │   ├── Entities/
│   │   ├── Enums/
│   │   ├── Models/
│   │   │   └── Contracts/
│   │   ├── Repositories/
│   │   │   └── Contracts/
│   │   └── Services/
│   │
│   ├── Mng/                        # 運営データ
│   │   ├── Entities/
│   │   ├── Models/
│   │   ├── Repositories/
│   │   └── Services/
│   │
│   ├── Sys/                        # システムデータ
│   │   ├── Entities/
│   │   └── Models/
│   │
│   └── Dyn/                        # DynamoDBエンティティ
│       └── Entities/
│
└── Constants/                      # グローバル定数
```

## レスポンスデータの配置

### Data / ResultData

```
Http/Responses/
├── Data/                           # yml定義のDataクラス
│   ├── UsrParameterData.php
│   ├── UserLevelUpData.php
│   └── ...
└── ResultData/                     # yml定義のResultDataクラス
    ├── StageEndResultData.php
    ├── GachaDrawResultData.php
    └── ...
```

### クラス名の分類

| クラス名 | 説明 | 例 |
|----------|------|-----|
| **ResultData** | API 1つ当たり1つ定義。対象APIのレスポンスデータをまとめる役割。 | `StageEndResultData`, `GachaDrawResultData` |
| **Data** | ymlのdataに定義された、Mst/Opr/ResultData以外のデータ構造。 | `UsrParameterData`, `UserLevelUpData` |

## データベース別テーブル配置

### 接頭辞によるDB識別

| 接頭辞 | データベース | 説明 | 配置場所 |
|--------|-------------|------|----------|
| `mst_` | mst (Aurora) | マスタデータ | `Resource/Mst/` |
| `opr_` | mst (Aurora) | 運営マスタデータ | `Resource/Mst/` |
| `mng_` | mng (Aurora) | 運営管理データ | `Resource/Mng/` |
| `usr_` | usr (TiDB) | ユーザーデータ | 各ドメイン or `Resource/Usr/` |
| `log_` | log (TiDB) | ログデータ（7日でローテート） | `Resource/Log/` |
| `hist_` | log (TiDB) | 履歴データ（ゲーム内参照あり） | `Resource/Log/` |
| `sys_` | sys (TiDB) | システムデータ | `Resource/Sys/` |

## テストディレクトリ構造

```
api/tests/
├── Feature/                        # 結合テスト
│   └── [Domain]/                   # ドメイン別
│       └── [Action]Test.php
├── Scenario/                       # シナリオテスト
│   └── [Feature]/
│       └── [Scenario]Test.php
└── Unit/                           # 単体テスト
    └── [Domain]/                   # ドメイン別
        ├── Services/
        ├── Repositories/
        └── Models/
```

## 命名規則

### クラス命名

| 種別 | 命名パターン | 例 |
|------|-------------|-----|
| Controller | `[Domain]Controller` | `StageController` |
| UseCase | `[Action]UseCase` | `StageEndUseCase` |
| Service | `[Name]Service` | `StageLogService` |
| Repository | `[Table]Repository` | `UsrStageRepository` |
| Model | `[Table]` | `UsrStage` |
| Delegator | `[Domain]Delegator` | `StageDelegator` |
| Entity | `[Name]Entity` | `UsrStageEntity` |
| Request | `[Action]Request` | `StageEndRequest` |
| ResponseFactory | `[Domain]ResponseFactory` | `StageResponseFactory` |
| ResultData | `[Action]ResultData` | `StageEndResultData` |

### ファイル配置の原則

1. **ドメイン固有のコードはドメインディレクトリ内に配置**
2. **複数ドメインで使用するコードはResource配下に配置**
3. **全ドメインで使用するコードはCommon配下に配置**
4. **レスポンス用データはHttp/Responses配下に配置**
