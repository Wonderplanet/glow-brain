# 共通基盤

## 概要

glow-serverには、全ドメインで共通して使用する基盤機能が用意されています。
本ドキュメントでは、主要な共通機構について説明します。

## トランザクション管理

### 基本方針

- **UseCaseでトランザクション制御**
- `DB::transaction()`を使用（自動ロールバック/コミット）
- `DB::beginTransaction()`, `DB::rollBack()`, `DB::commit()`は**使わない**

### UseCaseTrait

```php
trait UseCaseTrait
{
    /**
     * ユーザーデータ更新のトランザクション処理
     */
    protected function applyUserTransactionChanges(callable $callback): mixed
    {
        return DB::transaction(function () use ($callback) {
            $result = $callback();
            app(UsrModelManager::class)->saveAll();
            return $result;
        });
    }
}
```

### 使用例

```php
class StageEndUseCase
{
    use UseCaseTrait;

    public function exec(...): StageEndResultData
    {
        // トランザクション外の処理
        $beforeData = $this->fetchData();

        // トランザクション内の処理
        $result = $this->applyUserTransactionChanges(function () use (...) {
            $this->rewardDelegator->sendRewards($usrUserId, $platform, $now);
            // ... 他のDB更新処理
            return $result;
        });

        // トランザクション後の処理
        return new StageEndResultData(...);
    }
}
```

### 制約

- トランザクション制御が必要なDBコネクションは**一つにまとめる**
  - TiDB以外のデータストアへの更新操作はなるべく行わない
  - 水平分割（シャーディング）は行わない
  - ユーザーDBとログDBは論理的に同一のDBとする

## UsrModelManager

### 概要

ユーザーデータモデルのキャッシュを管理するクラスです。
リクエストスコープのシングルトンとして生成され、1リクエスト中のみ有効です。

### 主要機能

| 機能 | 説明 |
|------|------|
| キャッシュ | 同一リクエスト内でのDBアクセスを最小化 |
| 変更追跡 | isDirtyなモデルを追跡 |
| 一括保存 | トランザクション内で変更モデルを一括更新 |
| 変更差分取得 | レスポンス用に変更があったモデルのみ取得 |

### 動作フロー

```
1. リクエスト開始時にUsrModelManagerが生成される
2. Repository経由でモデル取得時、キャッシュを確認
   - キャッシュにあれば返却（DBアクセスなし）
   - なければDBから取得してキャッシュに保存
3. モデル更新時、自動的にisDirty=trueになる
4. applyUserTransactionChanges()内でsaveAll()が呼ばれる
   - isDirty=trueのモデルのみDB更新
   - 更新後、isDirty=falseに変更
5. getChangedModels()で変更があったモデルを取得（レスポンス用）
```

### 使用方法

```php
// Repositoryでの使用
class UsrStageRepository implements UsrModelCacheRepositoryInterface
{
    public function __construct(
        private UsrModelManager $usrModelManager,
    ) {}

    public function findByUsrUserId(string $usrUserId): ?UsrStage
    {
        // キャッシュ確認
        $cached = $this->getCachedModel($usrUserId);
        if ($cached !== null) {
            return $cached;
        }

        // DBから取得
        $model = UsrStage::query()
            ->where('usr_user_id', $usrUserId)
            ->first();

        // キャッシュに保存
        if ($model !== null) {
            $this->usrModelManager->syncModels(static::class, [$model]);
        }

        return $model;
    }
}
```

## UsrModelDiffGetService

### 概要

APIリクエスト中に変更があったユーザーデータのみを取得するサービスです。
レスポンスで変更差分のみを返す際に使用します。

### 使用方法

```php
class StageEndUseCase
{
    public function __construct(
        private UsrModelDiffGetService $usrModelDiffGetService,
    ) {}

    public function exec(...): StageEndResultData
    {
        // ... ビジネスロジック実行

        return new StageEndResultData(
            // ... 他のデータ
            $this->usrModelDiffGetService->getChangedUsrArtworks(),
            $this->usrModelDiffGetService->getChangedUsrItems(),
            $this->usrModelDiffGetService->getChangedUsrUnits(),
        );
    }
}
```

## エラーハンドリング

### GameException

ゲーム固有のエラーを表す例外クラスです。

```php
namespace App\Domain\Common\Exceptions;

class GameException extends Exception
{
    public function __construct(
        int $errorCode,
        ?string $message = null,
    ) {
        // ...
    }
}
```

### エラーコード

`App\Domain\Common\Constants\ErrorCode`クラスに定数定義されています。

```php
class ErrorCode
{
    public const INVALID_REQUEST = 10001;
    public const USER_NOT_FOUND = 10002;
    public const INSUFFICIENT_CURRENCY = 20001;
    // ...
}
```

### 使用方法

```php
// エラー発生時
throw new GameException(ErrorCode::INVALID_REQUEST);

// メッセージ付き（開発用）
throw new GameException(ErrorCode::INVALID_REQUEST, 'Stage not found');
```

### Exception Handler

`App\Exceptions\Handler`で一括処理されます。

| 例外 | HTTPステータス | 処理 |
|------|---------------|------|
| GameException | 299 | エラーコードをレスポンス |
| RetryableException | 503 | リトライ可能エラー |
| WpBillingException | 設定による | 課金システムエラー |
| WpCurrencyException | 設定による | 通貨システムエラー |
| ValidationException | 422 | バリデーションエラー |

### 重要な方針

- アプリケーション上での例外catchは、**フレームワーク/ライブラリの例外のみ**
- システム固有の例外（GameException）はcatchせず、Handlerに任せる

## Clock / CurrentUser

### Clock

時間操作を抽象化するクラスです。テスト時に時間を固定できます。

```php
namespace App\Domain\Common\Entities;

class Clock
{
    public function now(): CarbonImmutable
    {
        return CarbonImmutable::now();
    }
}
```

### CurrentUser

認証済みユーザー情報を保持するクラスです。

```php
namespace App\Domain\Common\Entities;

class CurrentUser
{
    public function getUsrUserId(): string;
    public function getPlatform(): int;
    public function getLanguage(): string;
    // ...
}
```

### 使用方法

```php
class StageEndUseCase
{
    public function __construct(
        private Clock $clock,
    ) {}

    public function exec(CurrentUser $user, ...): StageEndResultData
    {
        $usrUserId = $user->getUsrUserId();
        $now = $this->clock->now();

        // ...
    }
}
```

## Lottery（抽選）

確率に基づく抽選処理を行うクラスです。

```php
namespace App\Domain\Common\Entities;

class Lottery
{
    /**
     * 確率に基づいて抽選を行う
     *
     * @param array<int, float> $probabilities [ID => 確率]
     * @return int 当選したID
     */
    public function draw(array $probabilities): int;

    /**
     * 複数回抽選を行う
     */
    public function drawMultiple(array $probabilities, int $count): array;
}
```

## 共通ユーティリティ

### ArrayUtil

配列操作のユーティリティ。

```php
class ArrayUtil
{
    public static function groupBy(array $array, string $key): array;
    public static function keyBy(array $array, string $key): array;
    public static function pluck(array $array, string $key): array;
}
```

### StringUtil

文字列操作のユーティリティ。

```php
class StringUtil
{
    /**
     * 日時をISO8601形式に変換
     */
    public static function convertToISO8601(CarbonImmutable $dateTime): string;

    public static function generateUuid(): string;
}
```

### MathUtil

数学計算のユーティリティ。

```php
class MathUtil
{
    /**
     * 確率計算（小数点以下の精度を保証）
     */
    public static function calculateProbability(int $numerator, int $denominator): float;
}
```

### CacheUtil

キャッシュ操作のユーティリティ。

```php
class CacheUtil
{
    public static function remember(string $key, int $ttl, callable $callback): mixed;
    public static function forget(string $key): void;
}
```

## バリデーション

### Request層でのバリデーション

glow-schemaで自動生成されるRequestクラスでバリデーションを行います。

```php
// 自動生成されるRequestクラスの例
class StageEndRequest extends BaseApiRequest
{
    public function rules(): array
    {
        return [
            'mst_stage_id' => ['required', 'string'],
            'in_game_battle_log' => ['nullable', 'array'],
        ];
    }

    public function getMstStageId(): string
    {
        return $this->input('mst_stage_id');
    }
}
```

### バリデーションルール生成

glow-schemaのYAML定義からLaravelのバリデーションルールに自動変換されます。

| YAML型 | Laravelルール |
|--------|--------------|
| string | 'string' |
| integer | 'integer' |
| boolean | 'boolean' |
| array | 'array' |
| required | 'required' |
| nullable | 'nullable' |

## レスポンス生成

### ResponseFactory

各コントローラー専用のレスポンスファクトリーを用意します。

```php
class StageResponseFactory
{
    public function end(StageEndResultData $resultData): JsonResponse
    {
        return response()->json([
            'user_level_up' => $this->formatUserLevelUp($resultData->userLevelUpData),
            'always_clear_rewards' => $this->formatRewards($resultData->alwaysClearRewards),
            // ...
        ]);
    }
}
```

### 日時データの変換

日時データはISO8601形式で返却します。

```php
// StringUtil::convertToISO8601()を使用
$responseData = [
    'created_at' => StringUtil::convertToISO8601($model->getCreatedAt()),
];
```

### ResponseFactoryの依存関係

`ResponseFactory → ユーザーモデルインターフェースの依存は許容`

**理由:**
- Dtoなどへの変換処理は、APIレスポンスタイムを劣化させる
- ユーザーモデルインターフェースで、EloquentModelのsave()を公開する定義はしておらず、DB更新は実行されないため

## DI設定

### AppServiceProviderでの登録

```php
// app/Providers/AppServiceProvider.php

public function register(): void
{
    // シングルトン登録（リクエストスコープ）
    $this->app->singleton(UsrModelManager::class);
    $this->app->singleton(LogModelManager::class);

    // インターフェースとの紐付け
    $this->app->bind(ClockInterface::class, Clock::class);
}
```

### 自動解決

具象クラスのDIは自動解決されるため、明示的な登録は不要です。

```php
// 明示的な登録不要
// $this->app->bind(StageLogService::class);  // 不要

// コンストラクタインジェクションで自動解決
class StageEndUseCase
{
    public function __construct(
        private StageLogService $stageLogService,  // 自動解決
    ) {}
}
```
