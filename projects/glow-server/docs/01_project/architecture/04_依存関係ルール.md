# 依存関係ルール

## 概要

glow-serverでは、**deptrac**ツールを使用してモジュールやレイヤー間の依存関係を検証しています。
CI/CDでも自動チェックが実行され、違反があるとビルドが失敗します。

## 基本原則

### 依存の方向

依存は常に**上位レイヤーから下位レイヤーへ**一方向に流れます。

```
HTTP Layer (Controller, Request, ResponseFactory)
    ↓
Domain Layer (UseCase, Service, Repository, Model)
    ↓
Infrastructure Layer (UsrModelManager, MasterRepository等)
    ↓
External (Database, Cache, External APIs)
```

### レイヤー間の依存関係

| From / To | Controller | UseCase | Service | Repository | Model Interface | Model |
|-----------|:----------:|:-------:|:-------:|:----------:|:---------------:|:-----:|
| **Controller** | - | ✓ | - | - | - | - |
| **UseCase** | - | - | ✓ | ✓ | ✓ | - |
| **Service** | - | - | ✓ | ✓ | ✓ | - |
| **Repository** | - | - | - | ✓ | ✓ | ✓ |
| **Model** | - | - | - | - | ✓ | ✓ |

## ドメイン間の依存ルール

### 禁止: 直接的な依存

```php
// NG: StageドメインからItemServiceを直接使用
namespace App\Domain\Stage\UseCases;

use App\Domain\Item\Services\ItemService;  // 禁止

class StageEndUseCase
{
    public function __construct(
        private ItemService $itemService,  // 直接依存は禁止
    ) {}
}
```

### 許可: Delegator経由の依存

```php
// OK: Delegator経由でアクセス
namespace App\Domain\Stage\UseCases;

use App\Domain\Item\Delegators\ItemDelegator;  // OK

class StageEndUseCase
{
    public function __construct(
        private ItemDelegator $itemDelegator,  // Delegator経由
    ) {}
}
```

## 特例ルール

### 1. マスタデータ（Resource/Mst）

**全ドメインから直接アクセス可能**

```php
// OK: マスタデータは直接DI
use App\Domain\Resource\Mst\Repositories\MstStageRepository;
use App\Domain\Resource\Mst\Repositories\OprCampaignRepository;

class StageEndUseCase
{
    public function __construct(
        private MstStageRepository $mstStageRepository,  // OK
        private OprCampaignRepository $oprCampaignRepository,  // OK
    ) {}
}
```

### 2. 共有リソース（Resource/Usr, Resource/Log等）

**全ドメインから直接アクセス可能**

```php
// OK: 共有リソースは直接DI
use App\Domain\Resource\Usr\Services\UsrModelDiffGetService;
use App\Domain\Resource\Log\Repositories\LogActionRepository;

class SomeUseCase
{
    public function __construct(
        private UsrModelDiffGetService $usrModelDiffGetService,  // OK
    ) {}
}
```

### 3. Common

**全ドメインから直接アクセス可能**

```php
// OK: Common配下は全ドメインで利用可能
use App\Domain\Common\Entities\Clock;
use App\Domain\Common\Entities\CurrentUser;
use App\Domain\Common\Exceptions\GameException;
use App\Domain\Common\Utils\StringUtil;
```

### 4. Gameドメイン

**他ドメインのService/Repositoryに直接アクセス可能**（課金基盤を除く）

```php
// OK: GameドメインからのアクセスはDelegator不要
namespace App\Domain\Game\Services;

use App\Domain\Stage\Services\StageService;  // GameドメインからはOK

class GameService
{
    public function __construct(
        private StageService $stageService,  // 直接DIが許可される
    ) {}
}
```

## 依存関係図

```
                    ┌─────────────────────────────────────┐
                    │              Common                  │
                    │  (全ドメインから参照可能)             │
                    └─────────────────────────────────────┘
                                     ▲
                                     │
┌────────────────────────────────────┼────────────────────────────────────┐
│                                    │                                     │
│    ┌─────────────────────────────────────────────────────────────┐      │
│    │                       Resource                               │      │
│    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐│      │
│    │  │   Mst   │  │   Usr   │  │   Log   │  │    Entities     ││      │
│    │  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘│      │
│    │                (全ドメインから参照可能)                      │      │
│    └─────────────────────────────────────────────────────────────┘      │
│                                    ▲                                     │
│                                    │                                     │
│    ┌───────────────────────────────┼───────────────────────────────┐    │
│    │                               │                                │    │
│    │  ┌─────────┐   Delegator   ┌─────────┐   Delegator   ┌─────────┐│   │
│    │  │  Stage  │◀─────────────▶│  Item   │◀─────────────▶│  User   ││   │
│    │  └─────────┘                └─────────┘                └─────────┘│   │
│    │       │                          │                          │     │    │
│    │       └──────────────────────────┼──────────────────────────┘     │    │
│    │                                  │                                 │    │
│    │                           ┌──────▼──────┐                         │    │
│    │                           │    Game     │                         │    │
│    │                           │ (特例: 直接) │                         │    │
│    │                           └─────────────┘                         │    │
│    │                   ビジネスドメイン                                  │    │
│    └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│                              Domain Layer                                    │
└──────────────────────────────────────────────────────────────────────────────┘
```

## DI（依存性注入）のルール

### 基本方針

- DIを利用して依存オブジェクトを外部から渡す
- **staticメソッドは基本的に使わない**（テスト容易性のため）
- LaravelのサービスコンテナをDIコンテナとして利用
- **コンストラクターインジェクション**を優先

### Constructor Property Promotion

PHP8.0の機能を活用し、コンストラクタで直接プロパティを定義します。

```php
// 推奨: Constructor property promotion
class StageEndUseCase
{
    public function __construct(
        private Clock $clock,
        private StageLogService $stageLogService,
        private UsrModelDiffGetService $usrModelDiffGetService,
    ) {}
}

// 非推奨: 従来の書き方
class StageEndUseCase
{
    private Clock $clock;
    private StageLogService $stageLogService;

    public function __construct(
        Clock $clock,
        StageLogService $stageLogService
    ) {
        $this->clock = $clock;
        $this->stageLogService = $stageLogService;
    }
}
```

### DIコンテナ登録の原則

- 更新可能なプロパティを持たないオブジェクトのみ登録
  - **OK**: Repository, Request, Service等
  - **NG**: Model（状態を持つ）
- 具象クラスのDIは自動解決（明示的登録不要）
- シングルトンで問題ない場合は`app()->singleton()`を優先

### 不要なDIの削減

```php
// NG: 不要なDIが多い
class SomeUseCase
{
    public function __construct(
        private ServiceA $serviceA,
        private ServiceB $serviceB,  // このメソッドでは使わない
        private ServiceC $serviceC,  // このメソッドでは使わない
    ) {}

    public function exec(): void
    {
        $this->serviceA->doSomething();  // serviceAのみ使用
    }
}
```

**問題点:**
- 不要な依存解決処理 → 処理時間が増える
- 不要なクラスのインスタンス生成 → メモリ量を無駄に使用

## 循環依存の禁止

循環依存は依存解決時にエラーが発生します。

```php
// NG: 循環依存
// StageServiceがItemServiceに依存し、ItemServiceがStageServiceに依存
class StageService
{
    public function __construct(private ItemDelegator $itemDelegator) {}
}

class ItemService
{
    public function __construct(private StageDelegator $stageDelegator) {}  // 循環！
}
```

**解決方法:**
- 共通処理をResource配下に抽出
- 処理の責務を見直し、一方向の依存に整理

## deptracによる検証

### 実行コマンド

```bash
./tools/bin/sail-wp deptrac
```

### 設定ファイル

`deptrac.yaml`でレイヤーとルールを定義しています。

### CI/CDでの検証

プルリクエスト時に自動的にdeptracが実行され、違反があるとマージがブロックされます。
