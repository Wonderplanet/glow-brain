# glow-server API アーキテクチャ概要

## はじめに

glow-server は、ドメイン駆動設計(DDD)に基づいて構築された**モジュラーモノリス型**のゲームサーバーです。
本ドキュメントでは、アーキテクチャの全体像と基本思想を説明します。

## 技術スタック

### サーバー関連

| 項目 | 技術 |
|------|------|
| 言語 | PHP 8.3 |
| フレームワーク | Laravel 11 |
| DB | TiDB (usr, log, sys), Aurora MySQL (mst, mng) |
| キャッシュ | Redis |
| アプリケーションサーバー | php-fpm |
| Webサーバー | nginx |
| 管理ツール | Filament |

### 開発ツール

| 項目 | 技術 |
|------|------|
| コンテナ開発環境 | Docker Desktop |
| テスト | PHPUnit |
| コーディング規約チェック | PHP_CodeSniffer (slevomat/coding-standard) |
| 静的解析 | PHPStan (Larastan) レベル6 |
| アーキテクチャ検証 | deptrac |
| デバッグ | Xdebug |
| スキーマ定義 | glow-schema (YAML) |

## アーキテクチャの基本思想

### 設計方針

**「従来のレイヤードアーキテクチャをベースにモジュール化を強く意識」**

この方針に基づき、以下の2つの品質特性を最も重視しています：

1. **変更容易性** - モジュール内で変更が完結する
2. **テスト容易性** - モジュール単位でテスト可能

### モジュラーモノリスの採用

マイクロサービスほどの複雑さを持ち込まず、かつモノリスの問題点を回避するため、**モジュラーモノリス**アーキテクチャを採用しています。

**特徴:**
- 単一のコードベース、単一のデプロイユニット
- 内部はドメイン（機能）ごとにモジュール分割
- モジュール間は疎結合を維持（Delegator経由でのアクセス）
- 将来的なマイクロサービス化への移行も視野に入れた設計

### トランザクションスクリプトの防止

DB操作を含む全ての処理を一箇所で実行する「トランザクションスクリプト」パターンは禁止しています。

**代わりに:**
- データごとにモジュール（クラス）を作成
- 各レイヤーに責務を分散
- ドメインモデルパターンを採用し、データと振る舞いを集約

## 全体アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                          HTTP Layer                              │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────────────┐ │
│  │  Controller │  │   Request   │  │    ResponseFactory       │ │
│  └──────┬──────┘  └─────────────┘  └──────────────────────────┘ │
└─────────┼───────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Domain Layer                              │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                        UseCase                              │ │
│  │  - トランザクション制御                                      │ │
│  │  - 処理の組み立て                                           │ │
│  └──────┬─────────────────────────────────────────────────────┘ │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Service    │  │  Repository  │  │     Delegator        │  │
│  │  (ロジック)  │  │ (DB操作)     │  │ (他ドメインへの窓口) │  │
│  └──────┬───────┘  └──────┬───────┘  └──────────────────────┘  │
│         │                 │                                      │
│         ▼                 ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                         Model                             │   │
│  │  - Eloquent Model                                        │   │
│  │  - レコード単位の操作                                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    共有リソース (Resource)                   ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ ││
│  │  │   Mst   │  │   Usr   │  │   Log   │  │    Entities     │ ││
│  │  │ (マスタ)│  │(ユーザー)│  │ (ログ) │  │ (共有エンティティ)│ ││
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                       Common                                  ││
│  │  - 全ドメイン共通のユーティリティ、例外、定数等              ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Infrastructure Layer                        │
│  ┌─────────────────┐  ┌────────────────────┐                    │
│  │ UsrModelManager │  │   MasterRepository │                    │
│  └─────────────────┘  └────────────────────┘                    │
│  ┌─────────────────┐  ┌────────────────────┐                    │
│  │ LogModelManager │  │  MngCacheRepository│                    │
│  └─────────────────┘  └────────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Database                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌───────┐ │
│  │   mst   │  │   mng   │  │   usr   │  │   log   │  │  sys  │ │
│  │ (Aurora)│  │ (Aurora)│  │ (TiDB)  │  │ (TiDB)  │  │(TiDB) │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └───────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## ドメイン一覧

現在のglow-serverには以下のドメインが存在します：

| ドメイン | 説明 |
|---------|------|
| Auth | デバイスベース認証、JWT発行 |
| User | ユーザーアカウント管理 |
| Currency | ゲーム内通貨管理（監査証跡付き） |
| Gacha | ガチャ・報酬システム（確率計算） |
| Stage | ステージ進行 |
| AdventBattle | 降臨バトル |
| PvP | プレイヤー対戦・ランキング |
| Mission | クエスト・実績システム |
| Shop | アプリ内購入 |
| Item | アイテム管理 |
| Unit | ユニット管理 |
| Party | パーティ編成 |
| Message | メッセージ・通知 |
| Tutorial | チュートリアル |
| Reward | 報酬配布 |
| Game | ゲーム全体のデータ取得 |
| その他 | Emblem, Encyclopedia, Outpost, DailyBonus, Campaign, IdleIncentive, InGame, Debug, Cheat 等 |

## 関連ドキュメント

- [01_レイヤードアーキテクチャ.md](./01_レイヤードアーキテクチャ.md) - 各レイヤーの責務
- [02_モジュラーモノリス.md](./02_モジュラーモノリス.md) - ドメイン分割とDelegator
- [03_ディレクトリ構造.md](./03_ディレクトリ構造.md) - 詳細なディレクトリ構成
- [04_依存関係ルール.md](./04_依存関係ルール.md) - 依存関係の制約
- [05_データフロー.md](./05_データフロー.md) - リクエストからレスポンスまでの流れ
- [06_共通基盤.md](./06_共通基盤.md) - 共通機構の説明
- [07_テスト戦略.md](./07_テスト戦略.md) - テストの方針
- [マスタデータ配信機構.md](./マスタデータ配信機構.md) - マスタデータの管理
