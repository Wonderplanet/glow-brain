# テスト戦略

## 基本方針

### テスト作成の全体方針

- 単体テスト or 結合テストを作成
- テスト対象以外のモジュールの挙動は厳密にチェックしない
- 設計段階でテスト項目の優先度を決定
- 優先度が高くない項目のテスト作成は状況次第で諦める

### 参考書籍

- 『単体テストの考え方/使い方』（Vladimir Khorikov著）

## テスト分類

### テスト対象の分類

| 分類 | テスト種別 | 特徴 |
|------|-----------|------|
| ドメインモデル/アルゴリズム | 単体テスト | 複雑さが高い、協力者オブジェクトが少ない |
| コントローラ | 結合テスト | 複雑さは低い、複数コンポーネントを連携 |
| 過度に複雑なコード | テスト対象外 | リファクタリング優先 |
| 取るに足らないコード | テスト対象外 | ゲッター/セッターなど |

## レイヤーごとのテスト方針

### 概要表

| レイヤー | テスト種別 | テスト量 | 優先度 | モック使用 |
|---------|----------|---------|-------|----------|
| **Controller** | 結合テスト | 少 | 低 | UseCaseのみ |
| **UseCase** | 結合テスト | 少 | 中 | 他ドメインのDelegator |
| **Service** | 単体テスト | 多 | 高 | 基本しない |
| **Repository** | 単体テスト | 多 | 高 | 基本しない |
| **Model** | 単体テスト | 多 | 高 | 基本しない |

### Controller テスト

**方針:**
- 正常系の通過を検証（スモークテスト）
- 簡易的な検証のみ（厳密な動作確認はしない）

**理由:**
- 複雑・重要なロジックは存在しない
- データ構造・ロジック変更の影響を受けやすくテストが壊れやすい

**実装例:**
```php
class StageControllerTest extends TestCase
{
    public function test_end_正常系(): void
    {
        // モックセットアップ
        $this->mock(StageEndUseCase::class)
            ->shouldReceive('exec')
            ->once()
            ->andReturn($this->createMockResultData());

        // リクエスト実行
        $response = $this->postJson('/api/stage/end', [
            'mst_stage_id' => 'stage_001',
        ]);

        // ステータスコードのみ確認
        $response->assertStatus(200);
    }
}
```

### UseCase テスト

**基本方針:**
- 正常系の通過を検証
- 簡易的な検証のみ
- **他モジュールのクラスは全てモック**

**調整方針:**

| 機能の重要度 | 複雑さ | テスト方針 |
|------------|--------|-----------|
| 重要 | かなり複雑 | 同じモジュールでもモックする |
| 重要 | 複雑ではない | 他モジュールをモックせず使用 |
| 重要ではない | かなり複雑 | テストを作成しない |
| 重要ではない | 複雑ではない | 基本方針通り |

**実装例:**
```php
class StageEndUseCaseTest extends TestCase
{
    public function test_exec_正常系(): void
    {
        // 他ドメインのDelegatorをモック
        $this->mock(RewardDelegator::class)
            ->shouldReceive('sendRewards')
            ->once();

        $this->mock(UserDelegator::class)
            ->shouldReceive('getUsrUserParameterByUsrUserId')
            ->andReturn($this->createMockUserParameter());

        // UseCase実行
        $useCase = app(StageEndUseCase::class);
        $result = $useCase->exec(
            $this->createCurrentUser(),
            1,
            'stage_001',
        );

        // 結果検証
        $this->assertInstanceOf(StageEndResultData::class, $result);
    }
}
```

### Service / Repository / Model テスト

**方針:**
- 異常系を含む細かい挙動まで検証
- モックは使用しない
- 機能の複雑さ・重要度によってはモック使用も可

**実装例:**
```php
class UsrItemServiceTest extends TestCase
{
    public function test_consumeItem_正常系(): void
    {
        // テストデータ準備
        $usrItem = UsrItem::factory()->create([
            'usr_user_id' => 'test_user',
            'mst_item_id' => 'item_001',
            'quantity' => 10,
        ]);

        // サービス実行
        $service = app(UsrItemService::class);
        $service->consumeItem('test_user', 'item_001', 3, $logTrigger);

        // DB確認
        $this->assertDatabaseHas('usr_items', [
            'usr_user_id' => 'test_user',
            'mst_item_id' => 'item_001',
            'quantity' => 7,
        ]);
    }

    public function test_consumeItem_数量不足でエラー(): void
    {
        // テストデータ準備
        UsrItem::factory()->create([
            'usr_user_id' => 'test_user',
            'mst_item_id' => 'item_001',
            'quantity' => 2,
        ]);

        // エラー発生を検証
        $this->expectException(GameException::class);

        $service = app(UsrItemService::class);
        $service->consumeItem('test_user', 'item_001', 5, $logTrigger);
    }
}
```

## テスト実装の基盤

### BaseTestCase

複数DB接続対応の包括的テスト基盤です。

```php
abstract class BaseTestCase extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();
        $this->setupDatabases();
    }

    /**
     * テストユーザー作成
     */
    protected function createDummyUser(): CurrentUser
    {
        // ユーザー作成処理
    }

    /**
     * 時間固定
     */
    protected function fixTime(?string $dateTime = null): void
    {
        Carbon::setTestNow($dateTime ?? '2024-01-01 00:00:00');
    }
}
```

### ファクトリーパターン

モデルファクトリーによるテストデータ生成。

```php
// ファクトリー定義
class UsrItemFactory extends Factory
{
    protected $model = UsrItem::class;

    public function definition(): array
    {
        return [
            'usr_user_id' => $this->faker->uuid(),
            'mst_item_id' => 'item_' . $this->faker->numberBetween(1, 100),
            'quantity' => $this->faker->numberBetween(1, 100),
        ];
    }
}

// 使用例
$usrItem = UsrItem::factory()->create([
    'quantity' => 10,
]);
```

### モック活用

Mockeryを使用したモック化。

```php
// Delegatorのモック
$this->mock(ItemDelegator::class)
    ->shouldReceive('addItemByRewards')
    ->once()
    ->with(
        'test_user',
        Mockery::type(Collection::class),
        Mockery::type(CarbonImmutable::class)
    );

// 部分モック
$this->partialMock(StageService::class)
    ->shouldReceive('someMethod')
    ->andReturn('mocked_value');
```

### 時間操作

テスト用の時間固定。

```php
public function test_時間に依存する処理(): void
{
    // 時間を固定
    $this->fixTime('2024-06-01 12:00:00');

    // テスト実行
    $result = $this->someTimeBasedMethod();

    // 検証
    $this->assertEquals('2024-06-01', $result->getDate());
}
```

## テストコマンド

### 実行コマンド

```bash
# 全テスト実行
./tools/bin/sail-wp test

# 特定のテスト実行
./tools/bin/sail-wp test --filter=StageEndUseCaseTest

# 特定のメソッド実行
./tools/bin/sail-wp test --filter=StageEndUseCaseTest::test_exec_正常系

# カバレッジ付きテスト
./tools/bin/sail-wp test --coverage
```

### ディレクトリ構造

```
api/tests/
├── Feature/                        # 結合テスト
│   └── [Domain]/                   # ドメイン別
│       └── [Action]Test.php
├── Scenario/                       # シナリオテスト
│   └── [Feature]/
│       └── [Scenario]Test.php
└── Unit/                           # 単体テスト
    └── [Domain]/
        ├── Services/
        ├── Repositories/
        └── Models/
```

## 管理ツール（Admin）テスト

### 方針

- 重要な機能のみ単体テスト作成
  - アイテム配布
  - 補填
  - お知らせ登録
- **結合テストは作成しない**

### 理由

- Filamentの機能に依存する部分が多い
- UI変更の影響を受けやすい
- コスト対効果が低い

## ベストプラクティス

### テスト命名規則

```php
// 日本語でわかりやすく
public function test_exec_正常系(): void
public function test_exec_数量不足でエラー(): void
public function test_exec_存在しないステージでエラー(): void
```

### AAA パターン

```php
public function test_example(): void
{
    // Arrange（準備）
    $usrItem = UsrItem::factory()->create(['quantity' => 10]);

    // Act（実行）
    $service = app(UsrItemService::class);
    $service->consumeItem('test_user', 'item_001', 3, $logTrigger);

    // Assert（検証）
    $this->assertDatabaseHas('usr_items', ['quantity' => 7]);
}
```

### データプロバイダー活用

```php
/**
 * @dataProvider provideConsumeItemCases
 */
public function test_consumeItem_境界値(int $quantity, int $consume, int $expected): void
{
    $usrItem = UsrItem::factory()->create(['quantity' => $quantity]);

    $service = app(UsrItemService::class);
    $service->consumeItem('test_user', 'item_001', $consume, $logTrigger);

    $this->assertDatabaseHas('usr_items', ['quantity' => $expected]);
}

public static function provideConsumeItemCases(): array
{
    return [
        '全消費' => [10, 10, 0],
        '一部消費' => [10, 3, 7],
        '1個消費' => [10, 1, 9],
    ];
}
```

## CI/CDでのテスト

### 自動実行

プルリクエスト時に以下が自動実行されます：

1. `phpcs` - コーディング規約チェック
2. `phpstan` - 静的解析
3. `deptrac` - 依存関係チェック
4. `phpunit` - テスト実行

### 品質ゲート

全チェックをパスしないとマージがブロックされます。

```bash
# ローカルで全チェック実行
./tools/bin/sail-wp check
```
