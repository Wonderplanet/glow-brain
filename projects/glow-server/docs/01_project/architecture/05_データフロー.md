# データフロー

## APIリクエスト処理の全体フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client                                          │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │ HTTP Request (JSON)
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Middleware                                        │
│  ┌─────────────────┐ ┌────────────────────┐ ┌────────────────────────────┐  │
│  │  auth:api       │→│ user_status_check  │→│ client_version_check       │  │
│  │  (JWT認証)      │ │ (ユーザー状態)     │ │ (クライアントバージョン)   │  │
│  └─────────────────┘ └────────────────────┘ └────────────────────────────┘  │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             Request                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - バリデーション（glow-schemaで自動生成）                           │    │
│  │  - 型キャスト                                                        │    │
│  │  - ヘッダー解析（Platform, Language, Version）                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Controller                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - パラメータ取得                                                    │    │
│  │  - UseCase実行                                                       │    │
│  │  - ResultDataをResponseFactoryへ渡す                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             UseCase                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - ビジネスロジックの組み立て                                        │    │
│  │  - トランザクション制御（applyUserTransactionChanges）               │    │
│  │  - Service / Repository / Delegator呼び出し                          │    │
│  │  - ResultData生成                                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Service / Repository / Delegator                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Service: ドメインロジック実行                                        │   │
│  │  Repository: DBアクセス（UsrModelManager経由のキャッシュ）            │   │
│  │  Delegator: 他ドメインへのアクセス窓口                                │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Model                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - Eloquentモデル                                                    │    │
│  │  - レコード単位の操作                                                │    │
│  │  - UsrModelManagerでキャッシュ管理                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Database                                          │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐          │
│  │   mst   │  │   mng   │  │   usr   │  │   log   │  │   sys   │          │
│  │ (Aurora)│  │ (Aurora)│  │ (TiDB)  │  │ (TiDB)  │  │ (TiDB)  │          │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (結果返却)
┌─────────────────────────────────────────────────────────────────────────────┐
│                       ResponseFactory                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - ResultDataからJSONレスポンス生成                                  │    │
│  │  - レスポンスデータの整形                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client                                          │
│                         HTTP Response (JSON)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

## UsrModelManagerによるキャッシュフロー

ユーザーデータはリクエスト内でキャッシュされ、最後に一括更新されます。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Request Start                                        │
│  UsrModelManager生成（リクエストスコープのシングルトン）                      │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Repository.find()                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  1. UsrModelManagerのキャッシュを確認                                │    │
│  │  2. キャッシュにあれば返却（DBアクセスなし）                         │    │
│  │  3. なければDBから取得してキャッシュに保存                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Model操作（更新）                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - Model更新時、自動的にisDirty=trueになる                          │    │
│  │  - UsrModelManagerが変更を追跡                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│            applyUserTransactionChanges() 内                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  1. DB::transaction() 開始                                          │    │
│  │  2. ビジネスロジック実行                                             │    │
│  │  3. UsrModelManager->saveAll() 呼び出し                             │    │
│  │     - isDirty=trueのモデルのみDB更新                                 │    │
│  │     - 更新後、isDirty=falseに変更                                    │    │
│  │  4. トランザクションコミット                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## モジュール間アクセスフロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Stage ドメイン                                                               │
│                                                                              │
│  ┌─────────────────┐                                                        │
│  │ StageEndUseCase │                                                        │
│  └────────┬────────┘                                                        │
│           │ Delegator経由                                                    │
└───────────┼──────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Item ドメイン                                                                │
│                                                                              │
│  ┌─────────────────┐      ┌─────────────────┐                              │
│  │ ItemDelegator   │─────▶│ UsrItemService  │                              │
│  │ (窓口)          │      └────────┬────────┘                              │
│  └─────────────────┘               │                                        │
│           │                        ▼                                        │
│           │               ┌─────────────────┐                              │
│           │               │UsrItemRepository│                              │
│           │               └────────┬────────┘                              │
│           │                        │                                        │
│           │                        ▼                                        │
│           │               ┌─────────────────┐                              │
│           │               │    UsrItem      │                              │
│           │               │   (Model)       │                              │
│           │               └────────┬────────┘                              │
│           │                        │                                        │
│           │◀───────────────────────┘                                        │
│           │ UsrItemEntityに変換して返却                                      │
│           ▼                                                                  │
│  ┌─────────────────┐                                                        │
│  │ UsrItemEntity   │ ← ドメイン外に返すデータ                               │
│  └─────────────────┘                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## レスポンスデータ生成フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            UseCase                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  - 処理実行                                                          │    │
│  │  - UsrModelDiffGetServiceで変更データ取得                            │    │
│  │  - ResultData生成                                                    │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ResultData (Data Transfer Object)                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  StageEndResultData {                                                │    │
│  │      userLevelUpData: UserLevelUpData,                              │    │
│  │      alwaysClearRewards: Collection<StageAlwaysClearReward>,        │    │
│  │      changedUsrArtworks: Collection<UsrArtwork>,                    │    │
│  │      changedUsrItems: Collection<UsrItem>,                          │    │
│  │      ...                                                             │    │
│  │  }                                                                   │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Controller                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  return $responseFactory->end($resultData);                          │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       ResponseFactory                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  public function end(StageEndResultData $resultData): JsonResponse  │    │
│  │  {                                                                   │    │
│  │      return response()->json([                                       │    │
│  │          'user_level_up' => [...],                                  │    │
│  │          'always_clear_rewards' => [...],                           │    │
│  │          'changed_usr_artworks' => [...],                           │    │
│  │          ...                                                         │    │
│  │      ]);                                                             │    │
│  │  }                                                                   │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           JSON Response                                      │
│  {                                                                           │
│    "user_level_up": { ... },                                                │
│    "always_clear_rewards": [ ... ],                                         │
│    "changed_usr_artworks": [ ... ],                                         │
│    ...                                                                       │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 変更差分取得フロー

`UsrModelDiffGetService`を使用して、APIリクエスト中に変更があったデータのみを取得します。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          UseCase                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  // DIでUsrModelDiffGetServiceを取得                                 │    │
│  │  private UsrModelDiffGetService $usrModelDiffGetService;            │    │
│  │                                                                      │    │
│  │  // レスポンス生成時に変更データを取得                               │    │
│  │  return new StageEndResultData(                                      │    │
│  │      ...                                                             │    │
│  │      $this->usrModelDiffGetService->getChangedUsrArtworks(),        │    │
│  │      $this->usrModelDiffGetService->getChangedUsrItems(),           │    │
│  │      ...                                                             │    │
│  │  );                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     UsrModelDiffGetService                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  // UsrModelManagerから変更があったモデルのみを取得                  │    │
│  │  public function getChangedUsrArtworks(): Collection                 │    │
│  │  {                                                                   │    │
│  │      return $this->usrModelManager->getChangedModels(               │    │
│  │          UsrArtworkRepository::class                                 │    │
│  │      );                                                              │    │
│  │  }                                                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## エラー発生時のフロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ビジネスロジック                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  // エラー発生時はGameExceptionをthrow                               │    │
│  │  throw new GameException(ErrorCode::INVALID_REQUEST);               │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Exception Handler                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  App\Exceptions\Handler で一括処理                                   │    │
│  │  - GameException: HTTPステータス299、エラーコードをレスポンス        │    │
│  │  - RetryableException: HTTPステータス503                            │    │
│  │  - その他: 適切なHTTPステータスで処理                                │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Error Response                                        │
│  {                                                                           │
│    "error_code": 10001,                                                     │
│    "message": "..."                                                         │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```
