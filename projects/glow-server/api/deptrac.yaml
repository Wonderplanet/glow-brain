# レイヤー間の依存関係
deptrac:
  paths:
    - ./app
    - ../local/lib/laravel-wp-billing/src
    - ../local/lib/laravel-wp-currency/src

  layers:
    # Gameレイヤー(app/Domain/Game)は、全ドメインに対して上位レイヤーとする。
    # Gameレイヤーは、他ドメインへDelegateなしで依存可能とする
    - name: Controller
      collectors:
        - type: directory
          value: ./app/Http/Controllers/.*
    - name: UseCase
      collectors:
        - type: bool
          must:
            - type: directory
              regex: ./app/Domain/.*/UseCases/.*
          must_not:
            - type: directory
              regex: ./app/Domain/DebugCommand/.*
    - name: Service
      collectors:
        - type: directory
          value: ./app/Domain/.*/Services/.*
    - name: Delegator
      # ドメイン間の疎結合のために使用する。
      # ドメイン固有のデータをドメイン外へ渡すのは禁止する。
      # UsrModelEntityやResourceEntityに変換すれば、ドメイン外へ渡すのを許可する。
      collectors:
        - type: bool
          must:
            - type: directory
              value: ./app/Domain/.*/Delegators/.*
          must_not:
            - type: directory
              value: ./app/Domain/Currency/Delegators/.*
    # Entity
    - name: DomainEntity
      # ドメイン固有のEntity。Delegatorのreturnで使用禁止。
      # UsrModelInterfaceへの依存は可能で、ユーザデータ操作が可能なため、ドメイン外へ渡さないようにする。
      collectors:
        - type: bool
          must:
            - type: class
              value: App\\Domain\\[^\\]+\\Entities\\[^\\]+
          must_not:
            - type: layer
              value: ResourceEntity
            - type: layer
              value: CommonEntity
    - name: ResourceEntity
      # 複数ドメインで共有可能なEntity。Delegatorのreturnで使用可。
      collectors:
        - type: class
          value: App\\Domain\\Resource\\Entities\\[^\\]+
    - name: CommonEntity
      # 全ドメインで利用可能なEntity。Delegatorのreturnで使用可。
      collectors:
        - type: class
          value: App\\Domain\\Common\\Entities\\[^\\]+
    # Usr
    - name: UsrModel
      collectors:
        - type: bool
          must:
            - type: class
              value: App\\Domain\\[^\\]+\\Models\\Usr[^\\]+
          must_not:
            - type: layer
              value: UsrModelInterface
    - name: UsrModelInterface
      # Delegatorのreturnで使用禁止。ドメイン外へ渡さないようにする。
      collectors:
        - type: interface
          value: App\\Domain\\[^\\]+\\Models\\Usr[^\\]+
    - name: UsrModelRepository
      collectors:
        - type: class
          value: App\\Domain\\[^\\]+\\Repositories\\Usr[^\\]+
    - name: UsrModelEntity
      # Delegatorのreturnで使用可。複数ドメインで共有可能なEntity。
      collectors:
        - type: class
          value: App\\Domain\\Resource\\Usr\\Entities\\[^\\]+
    # Mst
    # マスタデータ関連は全ドメイン共有可
    - name: MstModel
      collectors:
        - type: class
          value: App\\Domain\\Resource\\Mst\\Models\\[^\\]+
    - name: MstModelRepository
      collectors:
        - type: class
          value: App\\Domain\\Resource\\Mst\\Repositories\\[^\\]+
    - name: MstModelEntity
      collectors:
        - type: class
          value: App\\Domain\\Resource\\Mst\\Entities\\[^\\]+

  ruleset:
    Controller:
      - UseCase
    UseCase:
      - DomainEntity
      - ResourceEntity
      - CommonEntity
      - Service
      - MstModelEntity
      - MstModelRepository
      - UsrModelInterface
      - UsrModelEntity
      - UsrModelRepository
      - Delegator
      - Wp Billing Delegator
      - Wp Billing Entity
      - Wp Billing Exception
      - Wp Currency Constant
      - Wp Currency Delegator
      - Wp Currency Entity
      - Wp Iaa Entity
    Service:
      - DomainEntity
      - ResourceEntity
      - CommonEntity
      - MstModelEntity
      - MstModelRepository
      - UsrModelInterface
      - UsrModelEntity
      - UsrModelRepository
      - Delegator
      - Wp Billing Delegator
      - Wp Billing Entity
      - Wp Billing Exception
      - Wp Currency Constant
      - Wp Currency Delegator
      - Wp Currency Entity
      - Wp Currency Exception
      - Wp Currency Util
      - Wp Common Constant
      - Wp Common Entity
      - Wp Common Factory
      - Wp Iaa Entity
      - Wp Master Asset Release Constant
      - Wp Master Asset Release Entity
      - Wp Master Asset Release Util
    Delegator:
      - CommonEntity
      - ResourceEntity
      - MstModelEntity
      - UsrModelEntity
      - UsrModelRepository
      - Service
      - Wp Billing Entity
      - Wp Currency Entity
    UsrModel:
      - UsrModelInterface
      - UsrModelEntity
    UsrModelInterface:
      - UsrModelEntity
    UsrModelRepository:
      - UsrModelInterface
      - UsrModel
      - DomainEntity
    MstModel:
      - MstModelEntity
    MstModelEntity:
      - Wp Currency Constant
    MstModelRepository:
      - MstModel
      - MstModelEntity
      - CommonEntity
      - ResourceEntity
      - Wp Currency Constant
    ResourceEntity:
      - CommonEntity
      - MstModelEntity
      - UsrModelEntity
      - Wp Currency Entity
      - Wp Billing Entity
    CommonEntity:
      - CommonEntity
      - Wp Currency Entity
      - Wp Billing Entity
    DomainEntity:
      - ResourceEntity
      - CommonEntity
      - MstModelEntity
      - UsrModelEntity
      - UsrModelInterface

  skip_violations:
    App\Domain\Gacha\Delegators\GachaDelegator:
      - App\Domain\Gacha\Entities\GachaResultData

  formatters:
    graphviz:
      groups:
        Http:
          - Controller
        Domain:
          - UseCase
          - Service
          - UsrModel
          - UsrModelInterface
          - UsrModelRepository

imports:
  - ../local/lib/laravel-wp-billing/deptrac.yaml
  - ../local/lib/laravel-wp-currency/deptrac.yaml
