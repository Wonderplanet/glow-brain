<?php

namespace Feature\Domain\User;

use App\Domain\Resource\Entities\Rewards\UserLevelUpReward;
use App\Domain\Resource\Enums\RewardType;
use App\Domain\Resource\Mst\Models\MstUserLevelBonus;
use App\Domain\Resource\Mst\Models\MstUserLevelBonusGroup;
use App\Domain\Resource\Mst\Repositories\MstUserLevelBonusRepository;
use Tests\TestCase;

class MstUserLevelBonusRepositoryTest extends TestCase
{
    private MstUserLevelBonusRepository $mstUserLevelBonusRepository;

    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        $this->mstUserLevelBonusRepository = app(MstUserLevelBonusRepository::class);
    }

    public function test_getUserLevelBonuses()
    {
        for ($level = 1; $level <= 4; $level++) {
            MstUserLevelBonus::factory()->create([
                'level' => $level,
                'mst_user_level_bonus_group_id' => $level,
            ]);
            MstUserLevelBonusGroup::factory()->create([
                'mst_user_level_bonus_group_id' => $level,
                'resource_type' => RewardType::COIN->value,
                'resource_id' => null,
                'resource_amount' => $level * 100,
            ]);
            MstUserLevelBonusGroup::factory()->create([
                'mst_user_level_bonus_group_id' => $level,
                'resource_type' => RewardType::FREE_DIAMOND->value,
                'resource_id' => null,
                'resource_amount' => $level * 100,
            ]);
            MstUserLevelBonusGroup::factory()->create([
                'mst_user_level_bonus_group_id' => $level,
                'resource_type' => RewardType::ITEM->value,
                'resource_id' => $level,
                'resource_amount' => $level * 100,
            ]);
            MstUserLevelBonusGroup::factory()->create([
                'mst_user_level_bonus_group_id' => $level,
                'resource_type' => RewardType::STAMINA->value,
                'resource_id' => null,
                'resource_amount' => $level * 100,
            ]);
        }

        $currentLevel = 1;
        $maxLevel = 3;
        $result = $this->mstUserLevelBonusRepository->getBonuses($currentLevel, $maxLevel);

        // 1から3へレベルアップしたので、2,3レベルの報酬が得られる。各レベルごとに4つの報酬がある
        $this->assertCount(4 * 2, $result);

        $result = $result->groupBy(function (UserLevelUpReward $userLevelUpReward) {
            return $userLevelUpReward->getUserLevel();
        });

        foreach ($result as $level => $typeRewards) {
            $rewards = $typeRewards->groupBy(function (UserLevelUpReward $userLevelUpReward) {
                return $userLevelUpReward->getType();
            });

            $reward = $rewards->get(RewardType::COIN->value)->first();
            $this->assertInstanceOf(UserLevelUpReward::class, $reward);
            $this->assertEquals(100 * $level, $reward->getAmount());

            $reward = $rewards->get(RewardType::FREE_DIAMOND->value)->first();
            $this->assertInstanceOf(UserLevelUpReward::class, $reward);
            $this->assertEquals(100 * $level, $reward->getAmount());

            $reward = $rewards->get(RewardType::STAMINA->value)->first();
            $this->assertInstanceOf(UserLevelUpReward::class, $reward);
            $this->assertEquals(100 * $level, $reward->getAmount());

            $reward = $rewards->get(RewardType::ITEM->value)->first();
            $this->assertInstanceOf(UserLevelUpReward::class, $reward);
            $this->assertEquals(100 * $level, $reward->getAmount());
            $this->assertEquals($level, $reward->getResourceId());
        }
    }
}
