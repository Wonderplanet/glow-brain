<?php

namespace Tests\Feature\Http\Controllers;

use App\Domain\Common\Constants\ErrorCode;
use App\Domain\Resource\Mst\Models\MstUserLevel;
use App\Domain\User\Models\UsrUser;
use App\Exceptions\HttpStatusCode;
use Illuminate\Testing\Fluent\AssertableJson;

class AuthControllerTest extends BaseControllerTestCase
{

    private const DUMMY_UUID = '00000000-0000-0000-0000-000000000000';

    private const INVALID_ID_TOKEN = 'hoge';

    private const INVALID_ACCESS_TOKEN = '0000000000000000000000000000000000000000000000000000000000000000';

    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        $this->createMasterRelease();
    }

    /**
     * @test
     */
    public function sign_up_新規アカウントを作成するとIDトークンが返ってくる()
    {
        $mstUserLevel = MstUserLevel::factory()->create(['level' => 1, 'stamina' => 10])->toEntity();

        // Exercise
        $response = $this->postJson('/api/sign_up', ['clientUuid' => self::DUMMY_UUID]);

        // Verify
        $response
            ->assertStatus(HttpStatusCode::SUCCESS)
            ->assertJson(
                fn (AssertableJson $json) =>
                $json
                    ->has('id_token')
                    ->has('currency_summary')
                    ->etc()
            );

        $usrUser = UsrUser::query()->first();
        $this->assertEquals(self::DUMMY_UUID, $usrUser->getClientUuid());
    }

    /**
     * @test
     */
    public function sign_in_正規のIDトークンを渡すとアクセストークンを取得できる()
    {
        $mstUserLevel = MstUserLevel::factory()->create(['level' => 1, 'stamina' => 10])->toEntity();

        $idToken = $this->signUp();
        $nginxRequestId = 'test_nginx_request_id';
        $this->setNginxRequestId($nginxRequestId);

        // Exercise
        $response = $this->postJson('/api/sign_in', ['id_token' => $idToken]);

        // Verify
        $response
            ->assertStatus(HttpStatusCode::SUCCESS)
            ->assertJson(fn (AssertableJson $json) => $json->has('access_token')->etc()
            );
    }

    /**
     * @test
     */
    public function sign_in_不正なIDトークンを渡すと認証エラー()
    {
        // Exercise
        $response = $this->postJson('/api/sign_in', ['id_token' => self::INVALID_ID_TOKEN]);

        // Verify
        $response
            ->assertStatus(HttpStatusCode::ERROR)
            ->assertJson(fn (AssertableJson $json) => $json->where('errorCode', ErrorCode::INVALID_ID_TOKEN)->etc()
            );
    }

    /**
     * @test
     */
    public function sign_in_IDトークンなしでログインするとバリデーションエラー()
    {
        // Exercise
        $response = $this->postJson('/api/sign_in');

        // Verify
        $response
            ->assertStatus(HttpStatusCode::ERROR)
            ->assertJson(fn (AssertableJson $json) => $json->where('errorCode', ErrorCode::VALIDATION_ERROR)->etc()
            );
    }

    // /**
    //  * @test
    //  */
    // public function api_正規のアクセストークンを渡すとAPIにアクセスできる()
    // {
    //     $this->setMstConfigUnitInitialMstUnitIds(['unit_1', 'unit_2', 'unit_3']);
    //     // Setup
    //     $this->withoutMiddleware(ClientVersionCheck::class);
    //     $this->mock(PartyService::class, function ($mock) {
    //         $mock->shouldReceive('registerInitialParties')->once();
    //     });
    //     $mstUserLevel = MstUserLevel::factory()->create(['level' => 1, 'stamina' => 10])->toEntity();

    //     $idToken = $this->signUp();
    //     $accessToken = $this->signIn($idToken);

    //     // Exercise
    //     $response = $this->postJson('/api/user/get', [], [System::HEADER_ACCESS_TOKEN => $accessToken]);

    //     // Verify
    //     $response->assertStatus(HttpStatusCode::SUCCESS);
    // }

    // /**
    //  * @test
    //  */
    // public function api_不正なアクセストークンを渡すと401認証エラー()
    // {
    //     // Exercise
    //     $response = $this->postJson('/api/user/get', [], [System::HEADER_ACCESS_TOKEN => self::INVALID_ACCESS_TOKEN]);

    //     // Verify
    //     $response
    //         ->assertStatus(HttpStatusCode::ERROR)
    //         ->assertJson(fn (AssertableJson $json) => $json->where('errorCode', ErrorCode::INVALID_ACCESS_TOKEN)->etc()
    //         );
    // }

    // /**
    //  * @test
    //  */
    // public function api_アクセストークンなしでAPIにアクセスするとバリデーションエラー()
    // {
    //     // Exercise
    //     $response = $this->postJson('/api/user/get');

    //     // Verify
    //     $response
    //         ->assertStatus(HttpStatusCode::ERROR)
    //         ->assertJson(fn (AssertableJson $json) => $json->where('errorCode', ErrorCode::VALIDATION_ERROR)->etc()
    //         );
    // }

    private function signUp(): string
    {
        $response = $this->postJson('/api/sign_up');
        $response->assertStatus(HttpStatusCode::SUCCESS);
        return $response->getData()->id_token;
    }

    private function signIn(string $idToken): string
    {
        $response = $this->postJson('/api/sign_in', ['id_token' => $idToken]);
        $response->assertStatus(HttpStatusCode::SUCCESS);
        return $response->getData()->access_token;
    }
}
