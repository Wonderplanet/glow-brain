<?php

namespace App\Filament\Pages;

use App\Constants\ImagePath;
use App\Constants\UserSearchTabs;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Usr\UsrUnit;
use App\Tables\Columns\AssetImageColumn;
use App\Tables\Columns\MstIdColumn;
use Filament\Actions\Action as FilamentAction;
use Filament\Forms\Components\TextInput;
use Filament\Tables;
use Filament\Tables\Actions\Action;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Enums\ActionsPosition;
use Filament\Tables\Filters\Filter;
use Illuminate\Database\Eloquent\Builder;

class UserUnit extends UserDataBasePage implements Tables\Contracts\HasTable
{
    use Tables\Concerns\InteractsWithTable;

    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static string $view = 'filament.pages.user-unit';

    public string $currentTab = UserSearchTabs::UNIT->value;

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            self::getUrl(['userId' => $this->userId]) => $this->currentTab,
        ]);
    }

    public function getUnitTable()
    {
        return $this->table($this->getTable());
    }

    private function table(Tables\Table $table)
    {
        $query = UsrUnit::query()
            ->where('usr_user_id', $this->userId)
            ->orderBy('created_at', 'desc')
            ->with([
                'mst_unit',
                'mst_unit.mst_unit_i18n',
            ]);

        return $table
            ->query($query)
            ->searchable(false)
            ->columns([
                MstIdColumn::make('mst_unit_info')
                    ->label('キャラ情報')
                    ->getMstUsing(function (UsrUnit $model) {
                        return $model->mst_unit;
                    })
                    ->getMstDetailPageUrlUsing(function (UsrUnit $model) {
                        return MstUnitDetail::getUrl(['mstUnitId' => $model->mst_unit_id]);
                    }),
                TextColumn::make('level')
                    ->label('レベル'),
                TextColumn::make('rank')
                    ->label('ランク'),
                TextColumn::make('grade_level')
                    ->label('グレード'),
                TextColumn::make('created_at')
                    ->label('獲得日時'),
                TextColumn::make('updated_at')
                    ->label('最終更新日時'),
            ])
            ->filters([
                Filter::make('unit_id')
                    ->label('キャラID')
                    ->form([
                        TextInput::make('unit_id')
                            ->label('キャラID')
                    ])
                    ->query(function (Builder $query, array $data): Builder {
                        if (empty($data['unit_id'])) {
                            return $query;
                        }

                        return $query->where('mst_unit_id', 'like', '%' . $data['unit_id'] . '%');
                    }),
            ], Tables\Enums\FiltersLayout::AboveContent)
            ->deferFilters()
            ->filtersApplyAction(
                fn(Action $action) => $action
                    ->label('検索'),
            )
            ->actions([
                Action::make('edit')
                    ->label('編集')
                    ->button()
                    ->visible(fn () => EditUserUnit::canAccess())
                    ->url(function (UsrUnit $record) {
                        return EditUserUnit::getUrl([
                            'userId' => $this->userId,
                            'unitId' => $record->mst_unit_id,
                        ]);
                    }),
            ], position: ActionsPosition::BeforeColumns);
    }

    protected function getActions(): array
    {
        return [
            FilamentAction::make('send')
                ->label('付与')
                ->visible(fn () => SendUserUnit::canAccess())
                ->url(function () {
                    return SendUserUnit::getUrl([
                        'userId' => $this->userId,
                    ]);
                })
        ];
    }
}
