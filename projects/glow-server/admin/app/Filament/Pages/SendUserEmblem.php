<?php

namespace App\Filament\Pages;

use App\Constants\ImagePath;
use App\Constants\RarityType;
use App\Constants\UserSearchTabs;
use App\Filament\Authorizable;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Mst\MstEmblem;
use App\Models\Usr\UsrEmblem;
use App\Services\AssetService;
use Illuminate\Support\Str;

class SendUserEmblem extends UserDataBasePage
{
    use Authorizable;
    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static string $view = 'filament.pages.send-user-emblem';

    public string $currentTab = UserSearchTabs::EMBLEM->value;

    public array $emblemIds = [];

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            UserEmblem::getUrl(['userId' => $this->userId]) => $this->currentTab,
            self::getUrl(['userId' => $this->userId]) => '付与',
        ]);
    }

    public function getEmblemList()
    {
        // 所持済みのエンブレムを取得
        $userEmblems = UsrEmblem::query()->where('usr_user_id', $this->userId)->get();

        $ownedEmblemIds = $userEmblems->pluck('mst_emblem_id')->toArray();

        // 所持していないエンブレムを取得
        $mstEmblem = MstEmblem::query()
            ->whereNotIn('id', $ownedEmblemIds)
            ->get();

        $mstEmblemData = [];
        foreach ($mstEmblem as $mstEmblem) {
            $mstEmblemData[] = [
                'id' => $mstEmblem?->id,
                'name' => $mstEmblem?->mst_emblem_i18n?->name,
                'assetPath' => $mstEmblem->makeAssetPath(),
                'bgPath' => $mstEmblem->makeBgPath(),
            ];
        }

        return $mstEmblemData;
    }

    public function send()
    {
        $emblems = array_map(function ($emblemId) {
            return [
                'id' => Str::uuid(),
                'usr_user_id' => $this->userId,
                'mst_emblem_id' => $emblemId,
                'created_at' => now(),
                'updated_at' => now(),
            ];
        }, $this->emblemIds);

        UsrEmblem::insert($emblems);

        $this->redirectRoute('filament.admin.pages.send-user-emblem', ['userId' => $this->userId]);
    }
}
