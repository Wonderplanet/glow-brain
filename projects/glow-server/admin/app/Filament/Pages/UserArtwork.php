<?php

namespace App\Filament\Pages;

use App\Constants\ImagePath;
use App\Constants\RarityType;
use App\Constants\UserSearchTabs;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Usr\UsrArtwork;
use App\Tables\Columns\AssetImageColumn;
use App\Tables\Columns\MstIdColumn;
use Filament\Actions\Action as FilamentAction;
use Filament\Forms\Components\TextInput;
use Filament\Tables\Actions\Action;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Concerns\InteractsWithTable;
use Filament\Tables\Contracts\HasTable;
use Filament\Tables\Enums\FiltersLayout;
use Filament\Tables\Filters\Filter;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;

class UserArtwork extends UserDataBasePage implements HasTable
{
    use InteractsWithTable;
    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static string $view = 'filament.pages.user-artwork';
    public string $currentTab = UserSearchTabs::ARTWORK->value;

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            self::getUrl(['userId' => $this->userId]) => $this->currentTab,
        ]);
    }

    public function table(Table $table): Table
    {
        $query = UsrArtwork::query()
            ->where('usr_user_id', $this->userId)
            ->orderBy('created_at', 'desc')
            ->with([
                'mst_artwork',
                'mst_artwork.mst_artwork_i18n',
            ]);

        return $table
            ->query($query)
            ->searchable(false)
            ->hiddenFilterIndicators()
            ->columns([
                TextColumn::make('id')
                    ->label('ID'),
                MstIdColumn::make('mst_artwork_info')
                    ->label('原画情報')
                    ->getMstUsing(function (UsrArtwork $model) {
                        return $model->mst_artwork;
                    })
                    ->getMstDetailPageUrlUsing(function (UsrArtwork $model) {
                        return MstArtworkDetail::getUrl([
                            'mstArtworkId' => $model->mst_artwork_id,
                        ]);
                    }),
                TextColumn::make('mst_artwork.outpost_additional_hp')
                    ->label('完成時にゲートに加算するHP'),
                TextColumn::make('created_at')
                    ->label('獲得日時'),
                TextColumn::make('updated_at')
                    ->label('最終更新日時'),
                ])
                ->filters([
                    Filter::make('id')
                        ->form([
                            TextInput::make('id')
                                ->label('ID')
                        ])
                        ->label('ID')
                        ->query(function (Builder $query, array $data): Builder {
                            if (blank($data['id'])) {
                                return $query;
                            }
                            return $query->where('id', 'like', "%{$data['id']}%");
                        }),
                    Filter::make('mst_artwork_id')
                        ->form([
                            TextInput::make('mst_artwork_id')
                                ->label('原画ID')
                        ])
                        ->label('原画ID')
                        ->query(function (Builder $query, array $data): Builder {
                            if (blank($data['mst_artwork_id'])) {
                                return $query;
                            }
                            return $query->where('mst_artwork_id', 'like', "%{$data['mst_artwork_id']}%");
                        }),
                    Filter::make('name')
                        ->form([
                            TextInput::make('name')
                                ->label('原画名称')
                        ])
                        ->label('原画名称')
                        ->query(function (Builder $query, array $data): Builder {
                            if (blank($data['name'])) {
                                return $query;
                            }
                            return $query->whereHas('mst_artwork.mst_artwork_i18n', function ($query) use ($data) {
                                $query->where('name', 'like', "%{$data['name']}%");
                            });
                        }),
                    Filter::make('outpost_additional_hp_from')
                        ->form([
                            TextInput::make('outpost_additional_hp_from')
                                ->label('完成時にゲートに加算するHP FROM'),
                        ])
                        ->label('完成時にゲートに加算するHP')
                        ->query(function (Builder $query, array $data): Builder {
                            if (blank($data['outpost_additional_hp_from'])) {
                                return $query;
                            }
                            return $query->whereHas('mst_artwork', function ($query) use ($data) {
                                $query->where('outpost_additional_hp', '>=', $data['outpost_additional_hp_from']);
                            });
                        }),
                    Filter::make('outpost_additional_hp_to')
                        ->form([
                            TextInput::make('outpost_additional_hp_to')
                                ->label('完成時にゲートに加算するHP TO'),
                        ])
                        ->label('完成時にゲートに加算するHP')
                        ->query(function (Builder $query, array $data): Builder {
                            if (blank($data['outpost_additional_hp_to'])) {
                                return $query;
                            }
                            return $query->whereHas('mst_artwork', function ($query) use ($data) {
                                $query->where('outpost_additional_hp', '<=', $data['outpost_additional_hp_to']);
                            });
                        }),
                    ], FiltersLayout::AboveContent)
                ->filtersFormColumns(3)
                ->deferFilters()
                ->filtersApplyAction(
                    fn (Action $action) => $action
                        ->label('適用'),
                )
                ->actions([]);
    }

    protected function getActions(): array
    {
        return [
            FilamentAction::make('send')
                ->label('付与')
                ->url(function () {
                    return SendUserArtwork::getUrl([
                        'userId' => $this->userId,
                    ]);
                })
                ->visible(fn () => SendUserArtwork::canAccess())
        ];
    }
}
