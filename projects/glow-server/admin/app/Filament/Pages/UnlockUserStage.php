<?php

namespace App\Filament\Pages;

use App\Constants\UserSearchTabs;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Mst\MstQuest;
use App\Models\Mst\MstStage;
use App\Models\Usr\UsrStage;
use Filament\Forms\Components\TextInput;
use Filament\Tables;
use Filament\Tables\Actions\Action;
use Filament\Tables\Concerns\InteractsWithTable;
use Filament\Tables\Contracts\HasTable;
use Filament\Tables\Enums\ActionsPosition;
use Filament\Tables\Filters\Filter;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Enums\FiltersLayout;
use Filament\Actions\Action as FilamentAction;
use Filament\Notifications\Notification;
use Illuminate\Support\HtmlString;

class UnlockUserStage extends UserDataBasePage implements HasTable
{
    use InteractsWithTable;

    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static string $view = 'filament.pages.unlock-user-stage';

    public string $currentTab = UserSearchTabs::UNLOCK_STAGE->value;

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            self::getUrl(['userId' => $this->userId]) => UserSearchTabs::UNLOCK_STAGE->value,
        ]);
    }

    public function getStageTable(): Table
    {
        return $this->table($this->getTable());
    }

    private function table(Table $table): Table
    {
        $query = MstStage::query()
            ->with([
                'mst_stage_i18n',
                'mst_quests',
                'mst_quests.mst_quest_i18n'
            ]);

        $usrStages = UsrStage::query()
            ->where('usr_user_id', $this->userId)
            ->get()
            ->keyBy('mst_stage_id');

        return $table
            ->query($query)
            ->searchable(false)
            ->columns([
                TextColumn::make('id')
                    ->label('ステージID'),
                TextColumn::make('quest')
                    ->label('クエスト')
                    ->getStateUsing(function ($record) {
                        return '[' . $record->mst_quests?->id . '] ' . $record->mst_quests?->mst_quest_i18n?->name;
                    }),
                TextColumn::make('mst_stage_i18n.name')
                    ->label('ステージ名'),
                TextColumn::make('sort_order')
                    ->label('並び順')
                    ->sortable(),
            ])
            ->actions([
                Action::make('update')
                    ->label(function ($record) use ($usrStages) {
                        if ($usrStages->has($record->id)) {
                            return 'ステージ開放済み';
                        }
                        return 'このステージまで開放';
                    })
                    ->disabled(function ($record) use ($usrStages) {
                        if ($usrStages->has($record->id)) {
                            return true;
                        }
                    })
                    ->button()
                    ->requiresConfirmation()
                    ->action(fn(Model $record) => $this->update($record)),
            ], position: ActionsPosition::BeforeColumns)
            ->filters([
                Filter::make('quest_id')
                    ->label('クエストID')
                    ->form([
                        TextInput::make('quest_id')
                            ->label('クエストID')
                    ])
                    ->query(function (Builder $query, array $data): Builder {
                        if (empty($data['quest_id'])) {
                            return $query;
                        }

                        $quest = MstQuest::query()->with('mst_stages')->where('id', $data['quest_id'])->get();
                        $stageIds = $quest->map(function ($item) {
                            return $item->mst_stages->map(function ($stage) {
                                return $stage->id;
                            });
                        })->flatten()->toArray();
                        if (empty($stageIds)) {
                            return $query;
                        }

                        return $query->whereIn('id', $stageIds);
                    }),
                Filter::make('stage_id')
                    ->label('ステージID')
                    ->form([
                        TextInput::make('stage_id')
                            ->label('ステージID')
                    ])
                    ->query(function (Builder $query, array $data): Builder {
                        if (empty($data['stage_id'])) {
                            return $query;
                        }

                        return $query->where('id', $data['stage_id']);
                    }),
            ], FiltersLayout::AboveContent)
            ->deferFilters()
            ->filtersApplyAction(
                fn(Action $action) => $action
                    ->label('検索'),
            );
    }

    public function update(MstStage $record)
    {
        // sort_order以下のステージまでクリアしたことにする
        $mstStages = MstStage::query()
            ->where('sort_order', '<=', $record->sort_order)
            ->orderBy('sort_order', 'asc')
            ->get();

        $insertData = [];
        $ids = [];
        foreach ($mstStages as $mstStage) {
            $ids[] = $mstStage->id;
            $insertData[] = [
                'id' => Str::uuid(),
                'usr_user_id' => $this->userId,
                'mst_stage_id' => $mstStage->id,
                'clear_count' => 1,
            ];
        }

        UsrStage::upsert(
            $insertData,
            ['usr_user_id', 'mst_stage_id'],
        );

        $firstId = reset($ids);
        $lastId = end($ids);
        Notification::make()
            ->title('ステージID：' . $firstId . '~' . $lastId . 'まで開放しました。')
            ->success()
            ->send();
    }

    protected function getActions(): array
    {
        if (UsrStage::query()->where('usr_user_id', $this->userId)->exists())
        {
            return [
                FilamentAction::make('delete')
                    ->label('開放状態のステージ一斉解除')
                    ->color('danger')
                    ->requiresConfirmation()
                    ->modalHeading('開放状態のステージ一斉解除')
                    ->modalDescription(new HtmlString('開放状態のステージを開放前の状態に戻します。<br />本当に実行しますか？'))
                    ->modalSubmitActionLabel('OK')
                    ->modalCancelActionLabel('キャンセル')
                    ->action(function() {
                        $this->bulkDelete();
                    }),
            ];
        }
        return [];
    }

    public function bulkDelete()
    {

        UsrStage::query()
            ->where('usr_user_id', $this->userId)
            ->delete();

        Notification::make()
            ->title('開放状態のステージの一斉解除が完了しました。')
            ->success()
            ->send();

        $this->redirect(
            UnlockUserStage::getUrl(['userId' => $this->userId]),
        );
    }
}
