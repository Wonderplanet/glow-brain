<?php

namespace App\Filament\Pages;

use App\Constants\ImagePath;
use App\Constants\RarityType;
use App\Constants\UserSearchTabs;
use App\Filament\Authorizable;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Mst\MstArtwork;
use App\Models\Mst\MstArtworkFragment;
use App\Models\Usr\UsrArtwork;
use App\Models\Usr\UsrArtworkFragment;
use App\Services\AssetService;
use Illuminate\Support\Str;

class SendUserArtwork extends UserDataBasePage
{
    use Authorizable;
    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static string $view = 'filament.pages.send-user-artwork';

    public string $currentTab = UserSearchTabs::ARTWORK->value;

    public array $artworkIds = [];

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            UserArtwork::getUrl(['userId' => $this->userId]) => $this->currentTab,
            self::getUrl(['userId' => $this->userId]) => '付与',
        ]);
    }

    public function getArtworkList()
    {
        // 所持済みの原画を取得
        $userArtworks = UsrArtwork::query()->where('usr_user_id', $this->userId)->get();

        $ownedArtworkIds = $userArtworks->pluck('mst_artwork_id')->toArray();

        // 所持していない原画を取得
        $mstArtworks = MstArtwork::query()
            ->whereNotIn('id', $ownedArtworkIds)
            ->get();

        $result = [];
        foreach ($mstArtworks as $mstArtwork) {
            $result[] = [
                'id' => $mstArtwork?->id,
                'name' => $mstArtwork?->mst_artwork_i18n?->name,
                'assetPath' => $mstArtwork->makeAssetPath(),
                'bgPath' => $mstArtwork->makeBgPath(),
            ];
        }

        return $result;
    }

    public function send()
    {
        $artworks = [];
        $artworkFragments = [];
        foreach ($this->artworkIds as $artworkId) {

            $artworks[] = [
                'id' => Str::uuid(),
                'usr_user_id' => $this->userId,
                'mst_artwork_id' => $artworkId,
                'created_at' => now(),
                'updated_at' => now(),
            ];

            $mstArtworkFragments = $this->getArtworkFragmentList($artworkId);

            foreach ($mstArtworkFragments as $mstArtworkFragment) {
                $artworkFragments[] = [
                    'id' => Str::uuid(),
                    'usr_user_id' => $this->userId,
                    'mst_artwork_id' => $artworkId,
                    'mst_artwork_fragment_id' => $mstArtworkFragment->id,
                    'created_at' => now(),
                    'updated_at' => now(),
                ];
            }

        }

        UsrArtwork::insert($artworks);
        UsrArtworkFragment::insert($artworkFragments);

        $this->redirectRoute('filament.admin.pages.send-user-artwork', ['userId' => $this->userId]);
    }

    public function getArtworkFragmentList($artworkId)
    {
        // 所持済みの原画のかけらを取得
        $userArtworkFragments = UsrArtworkFragment::query()
            ->where('mst_artwork_id', $artworkId)
            ->where('usr_user_id', $this->userId)
            ->get();

        $ownedArtworkFragmentIds = $userArtworkFragments->pluck('mst_artwork_fragment_id')->toArray();

        // 所持していない原画のかけらを取得
        return MstArtworkFragment::query()
            ->where('mst_artwork_id', $artworkId)
            ->whereNotIn('id', $ownedArtworkFragmentIds)
            ->get();
    }
}
