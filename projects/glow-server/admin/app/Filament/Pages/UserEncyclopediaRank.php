<?php

namespace App\Filament\Pages;

use App\Constants\RewardType;
use App\Constants\UserSearchTabs;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Mst\MstUnitEncyclopediaReward;
use App\Models\Usr\UsrReceivedUnitEncyclopediaReward;
use App\Models\Usr\UsrUnit;
use App\Services\Reward\RewardInfoGetHandleService;
use App\Tables\Columns\RewardInfoColumn;
use Filament\Infolists\Components\Fieldset;
use Filament\Infolists\Components\TextEntry;
use Filament\Infolists\Infolist;
use Filament\Tables\Actions\Action;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Concerns\InteractsWithTable;
use Filament\Tables\Contracts\HasTable;
use Filament\Tables\Table;
use Illuminate\Support\Collection;

class UserEncyclopediaRank extends UserDataBasePage implements HasTable
{
    use InteractsWithTable;
    protected static ?string $navigationIcon = 'heroicon-o-document-text';

    protected static string $view = 'filament.pages.user-encyclopedia-rank';
    public string $currentTab = UserSearchTabs::ENCYCLOPEDIA_RANK->value;

    private static ?RewardInfoGetHandleService $rewardInfoGetHandleService = null;

    private static Collection $rewardInfos;

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            self::getUrl(['userId' => $this->userId]) => $this->currentTab,
        ]);
    }

    private static function initializeService(): void
    {
        if (is_null(self::$rewardInfoGetHandleService)) {
            self::$rewardInfoGetHandleService = app(RewardInfoGetHandleService::class);
        }
    }

    public function encyclopediaRank(): InfoList
    {

        $gradeLevel  = UsrUnit::query()
            ->where('usr_user_id', $this->userId)
            ->sum('grade_level');

        $state = [
            'grade_level' => $gradeLevel,
        ];

        $fieldset = Fieldset::make('図鑑ランク情報')
            ->schema([
                TextEntry::make('grade_level')->label('図鑑ランク'),
            ]);

        return $this->makeInfolist()
            ->state($state)
            ->schema([$fieldset]);
    }

    private function createRewardInfos(): void
    {
        $this->initializeService();
        $rewardDtoList = MstUnitEncyclopediaReward::query()->get()->map(function (MstUnitEncyclopediaReward $mstUnitEncyclopediaReward) {
            return $mstUnitEncyclopediaReward->reward;
        });
        self::$rewardInfos = self::$rewardInfoGetHandleService->build($rewardDtoList)->getRewardInfos();
    }

    public function table(Table $table): Table
    {
        $query = UsrReceivedUnitEncyclopediaReward::query()
        ->where('usr_user_id', $this->userId)
        ->with([
            'mst_unit_encyclopedia_rewards',
            'mst_unit_encyclopedia_rewards.mst_item',
            'mst_unit_encyclopedia_rewards.mst_item.mst_item_i18n',
            'mst_unit_encyclopedia_rewards.mst_emblem',
            'mst_unit_encyclopedia_rewards.mst_emblem.mst_emblem_i18n',
        ])
        ->orderBy('created_at', 'desc');

        $this->createRewardInfos();

        return $table
            ->heading('獲得済み報酬一覧')
            ->query($query)
            ->searchable(false)
            ->hiddenFilterIndicators()
            ->columns([
                TextColumn::make('mst_unit_encyclopedia_rewards.unit_encyclopedia_rank')
                    ->label('図鑑ランク'),
                TextColumn::make('mst_unit_encyclopedia_rewards.resource_type')
                    ->label('報酬タイプ')
                    ->getStateUsing(
                        function ($record) {
                            $resourceTypeEnum = RewardType::tryFrom($record->mst_unit_encyclopedia_rewards->resource_type);
                            return $resourceTypeEnum->label();
                        }
                    ),
                RewardInfoColumn::make('mst_unit_encyclopedia_rewards.resource_id')
                    ->label('報酬情報')
                    ->getStateUsing(
                        function ($record) {
                            return self::$rewardInfos->get($record->mst_unit_encyclopedia_rewards->id);
                        }
                    ),
                ])
                ->filters([])
                ->deferFilters()
                ->filtersApplyAction(
                    fn (Action $action) => $action
                        ->label('適用'),
                )
                ->actions([]);
    }

}
