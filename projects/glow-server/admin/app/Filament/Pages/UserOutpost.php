<?php

namespace App\Filament\Pages;

use App\Constants\OutpostEnhancementType;
use App\Constants\UserSearchTabs;
use App\Filament\Pages\User\UserDataBasePage;
use App\Models\Mst\MstOutpostEnhancement;
use App\Models\Usr\UsrOutpost;
use Filament\Forms\Components\TextInput;
use Filament\Tables\Actions\Action;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Concerns\InteractsWithTable;
use Filament\Tables\Contracts\HasTable;
use Filament\Tables\Enums\ActionsPosition;
use Filament\Tables\Enums\FiltersLayout;
use Filament\Tables\Filters\Filter;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;

class UserOutpost extends UserDataBasePage implements HasTable
{
    use InteractsWithTable;

    protected static string $view = 'filament.pages.user-outpost';

    public string $currentTab = UserSearchTabs::OUTPOST->value;

    public function mount()
    {
        parent::mount(); // TODO: Change the autogenerated stub
        $this->breadcrumbList = array_merge($this->breadcrumbList, [
            self::getUrl(['userId' => $this->userId]) => $this->currentTab
        ]);
    }

    public function getOutpostTable()
    {
        return $this->table($this->getTable());
    }

    private function table(Table $table)
    {
        $query = UsrOutpost::query()
            ->with([
                'usr_outpost_enhancement' => function ($query) {
                    $query->where('usr_user_id', $this->userId);
                },
            ])
            ->where('usr_user_id', $this->userId)
            ->orderBy('created_at', 'desc');

        $mstOutpostEnhancements = MstOutpostEnhancement::query()
            ->with([
                'mst_outpost_enhancement_level' => function ($query) {
                    $query
                        ->select('mst_outpost_enhancement_id')
                        ->selectRaw('MAX(level) AS max_level')
                        ->groupBy(['mst_outpost_enhancement_id']);
                },
            ])
            ->get();

        $components = [];
        $components[] = TextColumn::make('mst_outpost_id')->label('ゲートID');
        $components[] = TextColumn::make('mst_artwork_id')->label('原画ID');
        $components[] = TextColumn::make('mst_artwork.mst_artwork_i18n.name')->label('原画名');
        $enhancementTypes = OutpostEnhancementType::cases();
        foreach ($enhancementTypes as $enhancementType) {
            $enhancementType = $enhancementType->value;
            $components[] = TextColumn::make($enhancementType)
                ->label(OutpostEnhancementType::tryFrom($enhancementType)?->label() ?? $enhancementType)
                ->getStateUsing(
                    function ($record) use ($enhancementType, $mstOutpostEnhancements) {
                        $mstOutpostEnhancement = $mstOutpostEnhancements
                            ->filter(function ($mstOutpostEnhancement) use ($enhancementType, $record) {
                                return $mstOutpostEnhancement->mst_outpost_id === $record->mst_outpost_id &&
                                    $mstOutpostEnhancement->outpost_enhancement_type === $enhancementType;
                            })
                            ->first();
                        if (is_null($mstOutpostEnhancement)) {
                            // 強化項目のマスターがない場合
                            return '無し';
                        }
                        $currentlevel = $record->usr_outpost_enhancement
                            ->filter(function ($usrOutpostEnhancement) use ($mstOutpostEnhancement) {
                                return $usrOutpostEnhancement->mst_outpost_enhancement_id === $mstOutpostEnhancement->id;
                            })
                            ->first()
                            ?->level ?? 1;
                        $maxLevel = $mstOutpostEnhancement->mst_outpost_enhancement_level?->first()->max_level ?? 0;
                        return sprintf('%d / %d', $currentlevel ?? 1, $maxLevel);// 「現在レベル / 最大レベル」の形式で表示
                    }
                );
        }

        return $table
            ->query($query)
            ->searchable(false)
            ->columns($components)
            ->filters([
                Filter::make('outpost_id')
                    ->form([
                        TextInput::make('outpost_id')->label('ゲートID')
                    ])
                    ->query(function (Builder $query, array $data): Builder {
                        if (empty($data['outpost_id'])) {
                            return $query;
                        }
                        return $query->where('mst_outpost_id', 'like', "%{$data['outpost_id']}%");
                    }),
            ], FiltersLayout::AboveContent)
            ->deferFilters()
            ->filtersApplyAction(
                fn(Action $action) => $action
                    ->label('検索'),
            )
            ->actions([
                Action::make('edit')
                    ->label('編集')
                    ->button()
                    ->url(function (UsrOutpost $record) {
                        return EditUserOutpost::getUrl([
                            'userId' => $this->userId,
                            'mstOutpostId' => $record->mst_outpost_id,
                        ]);
                    })
                    ->visible(fn () => EditUserOutpost::canAccess()),
            ], position: ActionsPosition::BeforeColumns);
    }
}
