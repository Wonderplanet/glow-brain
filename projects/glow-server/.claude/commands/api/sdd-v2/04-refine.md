---
name: sdd-v2:refine
description: API設計書のFB・修正調整を対話的に行う。別案作成、比較評価、ドキュメント一括更新まで対応。
argument-hint: {機能名}
---

# SDD v2 API設計書 FB・修正調整

API設計書の初稿完成後、フィードバックを受けつけて対話的に修正調整を行います。
別案の作成、比較評価、最終決定後のドキュメント一括更新まで対応します。

## 使用方法

```bash
/api:sdd-v2:04-refine {機能名}
```

例: `/api:sdd-v2:04-refine 交換所`

## 引数

$ARGUMENTS

## このコマンドの役割

Stage 3（API設計書作成）完了後に、以下のワークフローをサポートします:

```
【API設計書 初稿完成】
         ↓
    ユーザーからのFB
         ↓
┌────────────────────────────────────┐
│ 対話フェーズ                        │
│ - 設計意図の説明                    │
│ - 改善案の提案                      │
│ - 質問への回答                      │
│ - トレードオフの分析                │
└────────────────────────────────────┘
         ↓
    別案が必要な場合
         ↓
┌────────────────────────────────────┐
│ 別案作成フェーズ                    │
│ - 別案設計書の生成                  │
│ - 複数案がある場合は比較評価        │
└────────────────────────────────────┘
         ↓
    方針確定
         ↓
┌────────────────────────────────────┐
│ 反映フェーズ                        │
│ - ユーザー確認                      │
│ - ドキュメント一括更新              │
└────────────────────────────────────┘
```

## 実行内容

### Phase 1: コンテキスト読み込み

以下のファイルを読み込み、現状を把握します:

```
docs/sdd-v2/features/{機能名}/
├── 01_要件調査.md
├── 02_仕様確認.md
├── 02_2_プランナー確認結果.md
├── 03_API設計書.md          ← 主な対象
└── 03_API設計書_別案_*.md   ← あれば
```

### Phase 2: 対話フェーズ

ユーザーのFBを受けて、以下のいずれかを行います:

1. **設計意図の説明**: なぜこの設計にしたのかを解説
2. **改善提案**: FBを踏まえた改善案を提示
3. **トレードオフ分析**: 各選択肢のメリット・デメリットを整理
4. **質問への回答**: 設計に関する疑問に回答

対話を続けながら、修正方針を固めていきます。

### Phase 3: 別案作成（必要な場合）

大きく異なるアプローチが必要な場合:

1. **別案設計書を作成**: `03_API設計書_別案_{案の名前}.md`
2. **比較評価レポートを作成**: `04_API設計_比較評価レポート.md`

比較評価レポートには以下を含めます:
- 各案の概要
- 実装面での比較
- 設計面での比較
- 運用面での比較
- リスク面での比較
- 推奨判定とその理由

### Phase 4: 方針確定

修正方針が固まったら、ユーザーに確認を取ります:

**確認項目:**
- 採用する案（複数案がある場合）
- 修正内容の最終確認
- 他ドキュメントへの影響範囲

### Phase 5: ドキュメント一括更新

ユーザー承認後、以下を実行:

1. **03_API設計書.md を更新**: 最終決定した設計を反映
2. **01_要件調査.md を調整**（必要な場合）: 新たに判明した要件を追記
3. **02_仕様確認.md を調整**（必要な場合）: 確認事項の追加・更新
4. **バージョン管理**: 大きな変更がある場合は履歴を記録

## 出力ファイル

```
docs/sdd-v2/features/{機能名}/
├── 03_API設計書.md                   # 更新
├── 03_API設計書_別案_*.md            # 必要に応じて作成
├── 04_API設計_比較評価レポート.md     # 複数案ある場合
└── (01_要件調査.md, 02_*.md)         # 必要に応じて更新
```

## 対話の進め方

このコマンドを実行すると、以下の流れで対話を開始します:

1. **現状確認**: 既存ドキュメントを読み込み、設計概要を提示
2. **FB受付**: ユーザーからのフィードバックを待機
3. **分析・回答**: FBに対して分析結果と改善案を提示
4. **方向性確認**: 修正方向について合意形成
5. **確定・反映**: 最終確認後、ドキュメントを更新

## 対話例

### 例1: 設計の妥当性についての質問

```
ユーザー: 新規APIではなく既存APIの拡張ではダメ？

→ 両アプローチのトレードオフを分析して回答
→ 必要に応じて別案を作成
```

### 例2: パフォーマンスに関するFB

```
ユーザー: このクエリ、N+1になりそう

→ 該当箇所を特定し、改善案を提示
→ API設計書の実装上の注意点セクションを更新
```

### 例3: 別アプローチの提案依頼

```
ユーザー: item/consume APIを拡張するパターンも検討したい

→ 別案設計書を作成
→ 比較評価レポートを作成
→ ユーザーが採用案を決定後、ドキュメントを更新
```

## 注意事項

- **対話を重視**: 一方的な修正ではなく、ユーザーとの対話を通じて合意形成
- **変更履歴**: 大きな変更を行う場合は、元の設計意図を失わないよう記録
- **一貫性維持**: ドキュメント間の整合性を保つ
- **段階的更新**: 小さな修正は即座に、大きな変更は確認を取ってから

## 関連コマンド

- `/sdd-v2:api-design {機能名}`: API設計書の初稿作成
- `/sdd-v2:run-full {機能名}`: 全フロー実行

---

## 実行開始

それでは、`{機能名}` の設計ドキュメントを読み込み、FB・修正調整を開始します。

**まず、既存のドキュメントを読み込んで現状を把握します。**

その後、どのようなフィードバックや修正をご希望か教えてください。
