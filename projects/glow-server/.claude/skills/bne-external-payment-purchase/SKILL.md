---
name: bne-external-payment-purchase
description: |
  BNE外部決済（Xsolla）の購入処理、アイテム付与、検証、不正購入防止を実装。Xsollaウェブフックによるアイテム付与、購入金額検証、年齢制限・国コードチェック、同時購入制御、重複購入防止を統合的に処理。以下の場合に使用: (1) 課金購入処理とアイテム付与、(2) 購入金額・通貨コード検証、(3) 年齢制限チェック（ストアコード別）、(4) 国コードチェック（ダウンロード国とBNID居住国の照合）、(5) 同時購入制御・重複購入防止、(6) 購入履歴管理（usr DB）、(7) 無料アイテム・クーポン処理、(8) レシート検証・返金処理
---

# Validating BNE External Payment Purchases

BNE外部決済システムでの購入処理、検証、不正購入防止の実装ガイド。

## Instructions

### 1. 購入処理の概要を理解する

購入フロー、アイテム付与、検証ポイントを理解する。

参照: **[purchase-overview.md](purchase-overview.md)**

### 2. アイテム付与処理を実装する

注文支払い成功ウェブフックでアイテムを付与する処理を実装する。

**アイテム付与パターン**: purchase-overview.mdの「アイテム付与処理」セクションを参照

**重要**: `items` 配列には `type=virtual_good` のアイテムのみを付与

**注文支払い成功ウェブフック実装**: 今後追加予定

### 3. 年齢制限チェックを実装する

ストアコードとユーザーの誕生日に基づいて年齢制限を適用する。

**年齢制限パターン**: purchase-overview.mdの「年齢制限チェック」セクションを参照

**制限ルール**:
- アソビストア・日本版: 18歳未満は無料アイテムとクーポンのみ
- 海外版: 13歳以下ログイン不可、14歳以上のこどもアカウントは無料アイテムとクーポンのみ

### 4. 国コードチェックを実装する

ユーザーのダウンロード国とBNID居住国を照合して不正購入を防止する。

**国コード検証パターン**: purchase-overview.mdの「国コードチェック」セクションを参照

### 5. 購入金額・通貨コードの検証を実装する

クライアントから送信された金額とXsollaから送信された金額を照合する。

**価格検証**: purchase-overview.mdの「購入金額・通貨コード検証」セクションを参照

### 6. 同時購入の制御を実装する

同一ユーザーによる同時購入リクエストを適切に処理する。

**同時購入制御**: purchase-overview.mdの「同時購入制御」セクションを参照

### 7. 購入履歴管理を実装する

購入データをDBに保存し、履歴管理を行う。

**購入履歴管理**: purchase-overview.mdの「購入履歴管理」セクションとDBスキーマを参照

### 8. 無料アイテム・クーポン処理を実装する

無料アイテムとクーポン交換の特殊処理を実装する。

**無料アイテム・クーポンパターン**: purchase-overview.mdの「無料アイテム・クーポン処理」セクションを参照

### 9. キャンセル・返金処理を実装する（将来実装予定）

キャンセルや返金が発生した場合の処理を実装する。

**返金処理**: purchase-overview.mdの「キャンセル・返金処理」セクションを参照（今後追加予定）

## 実装後チェック

- [ ] アイテム付与処理を実装した（type=virtual_goodのみ）
- [ ] 年齢制限チェックを実装した
- [ ] 国コードチェックを実装した
- [ ] 購入金額・通貨コードの検証を実装した
- [ ] 同時購入の制御を実装した
- [ ] 購入履歴のDB保存を実装した
- [ ] 無料アイテム・クーポン処理を実装した
- [ ] テストを実装した

## 関連スキル

- **bne-external-payment-webhook** - ウェブフック受信処理
- **bne-external-payment-platform** - 国コード・通貨コード取得
- **api-reward-send-service** - 報酬送付処理（アイテム付与）
- **migration** - 購入履歴テーブルのマイグレーション
- **api-test-implementation** - テスト実装

## 参照ドキュメント

- **[purchase-overview.md](purchase-overview.md)** - 購入処理概要（アイテム付与、年齢制限、国コード検証、価格検証、同時購入制御、購入履歴管理、無料アイテム・クーポン、返金処理のすべてを含む）
