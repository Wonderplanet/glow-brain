# SDD v2 各段階の詳細

## Stage 1: 要件調査

### 概要

ゲーム体験仕様書（PDF）とコードベースを統合調査し、サーバー側で考慮すべき要件を包括的に抽出します。

### 入力

- `docs/sdd-v2/features/{機能名}/ゲーム体験仕様書.pdf`
- glow-server コードベース

### 出力

- `docs/sdd-v2/features/{機能名}/01_要件調査.md`

### 主要セクション

1. **ドキュメント情報** - 対象機能、作成日、入力ソース
2. **機能概要** - ユーザー体験の概要
3. **PDFからの要件抽出** - P-1, P-2, ... 形式
4. **コード調査からの追加要件** - C-1, C-2, ... 形式
5. **統合要件一覧** - REQ-A-1, REQ-B-1, ... 形式
6. **不明点・曖昧な点** - 次ステップで確認が必要な項目

### 処理時間

約4-5分

### 使用エージェント

`sdd-v2-requirements-investigation`

---

## Stage 2: 仕様確認

### 概要

要件調査で洗い出された不明点・曖昧点をレビューし、プランナーへの確認項目を整理した上で、確認結果を統合します。

### 入力

- `docs/sdd-v2/features/{機能名}/01_要件調査.md`
- プランナー確認結果（Phase B）

### 出力

- `docs/sdd-v2/features/{機能名}/02_仕様確認.md`（Phase A）
- `docs/sdd-v2/features/{機能名}/02_2_プランナー確認結果.md`（Phase B）

### 2段階のフロー

#### Phase A: 確認項目の洗い出し

1. 要件調査結果を分析
2. 8つの観点で問題点・曖昧さを洗い出し
3. プランナー確認が必要/不要な項目を分類
4. 質問形式で確認項目リストを作成

#### Phase B: 確認結果の統合

1. プランナー確認結果を受け取り
2. 各不明点の解決状況を評価
3. 確定した仕様を整理
4. 残存する不明点を明記

### ⚠️ 人間確認ポイント

Phase AとPhase Bの間で、プランナーへの確認が必要です。

```
Phase A 完了
    ↓
⚠️ プランナーへ確認項目を連絡
⚠️ プランナーからの回答を待機
⚠️ 回答を受け取り
    ↓
Phase B 実行
```

### 処理時間

- Phase A: 約3-4分
- Phase B: 約2-3分
- 計: 約5-7分（人間確認時間を除く）

### 使用エージェント

`sdd-v2-spec-confirmation`

---

## Stage 3: API設計書作成

### 概要

仕様確認結果を基に、実装可能な具体的なAPI設計書を作成します。
API概要、詳細設計、DB設計、実装設計を統合した完全な設計書を出力します。

### 入力

- `docs/sdd-v2/features/{機能名}/01_要件調査.md`
- `docs/sdd-v2/features/{機能名}/02_仕様確認.md`
- `docs/sdd-v2/features/{機能名}/02_2_プランナー確認結果.md`
- glow-schema リポジトリ
- glow-server コードベース

### 出力

- `docs/sdd-v2/features/{機能名}/03_API設計書.md`

### 主要セクション

1. **ドキュメント情報** - 対象機能、作成日、参照ドキュメント
2. **機能概要** - 概要、実装上の重要ポイント、確定仕様サマリー
3. **API全体像** - エンドポイント一覧、新規API、既存API改修
4. **DB設計** - mst_*/usr_*/log_*テーブル設計
5. **API詳細仕様** - リクエスト/レスポンス/バリデーション
6. **シーケンス図** - 処理フローの可視化（Mermaid形式）
7. **エラー設計** - エラーコード、発生条件、クライアント挙動
8. **実装ガイド** - ドメイン設計、ファイル構成、既存パターン
9. **テスト観点** - ユニット/機能/シナリオテスト
10. **実装チェックリスト** - 実装前/中/後のチェック項目

### 処理時間

約5-6分

### 使用エージェント

`sdd-v2-api-design`

---

## Stage 3-2: API設計書レビュー

### 概要

API設計書の初稿に対し、チェックリストに基づいた品質レビューを行い、規約違反を検出・修正します。

### 入力

- `docs/sdd-v2/features/{機能名}/03_API設計書.md`
- `docs/sdd-v2/checklists/api-design-checklist.md`

### 出力

- `docs/sdd-v2/features/{機能名}/03_API設計書.md` (レビュー後更新)

### チェック項目

#### カテゴリA: API設計の規約チェック
- A1: パスパラメータを使用していないか
- A2: 一覧取得専用APIを追加していないか
- A3: opr_*テーブルを新規追加していないか

#### カテゴリB: レスポンス構造チェック
- B1: キーがcamelCaseか、glow-schema定義と一致しているか
- B2: 報酬がgetRewardResponseData()形式か
- B3: 日時がISO8601形式で、StringUtil記載があるか
- B4: ResponseDataFactoryの既存メソッドを活用しているか

#### カテゴリC: 実装ガイダンスチェック
- C1: トランザクション制御が明記されているか
- C2: データ出所（mst/usr/log）が明確か

#### カテゴリD: アーキテクチャ方針チェック
- D1: 既存テーブル拡張を検討したか

### 処理時間

約2-3分

### 使用エージェント

`sdd-v2-api-design-review`

---

## 段階間の依存関係

```
Stage 1: 要件調査
    ↓ 01_要件調査.md
Stage 2: 仕様確認
    ↓ 02_仕様確認.md + 02_2_プランナー確認結果.md
Stage 3: API設計書作成
    ↓ 03_API設計書.md
Stage 3-2: API設計書レビュー
    ↓ 03_API設計書.md (レビュー後更新)
```

各段階は前段階の出力を入力として必要とするため、順次実行が必須です。
