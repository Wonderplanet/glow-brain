# SDD v2 オーケストレーションパターン

## 実行フロー

### フルフロー実行

```
/sdd-v2:run-full {機能名}
        │
        ▼
┌───────────────────────────────────┐
│ Stage 1: 要件調査                 │
│ ・PDFからサーバー要件抽出         │
│ ・コードベース調査                │
│ ・要件統合                        │
│ → 01_要件調査.md                  │
└───────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────┐
│ Stage 2 Phase A: 仕様レビュー     │
│ ・曖昧さの評価                    │
│ ・確認項目リスト作成              │
│ → 02_仕様確認.md                  │
└───────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────┐
│ ⚠️ 人間確認ポイント               │
│ ・プランナーへ確認項目を連絡      │
│ ・回答を待機                      │
│ ・回答を受け取り                  │
└───────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────┐
│ Stage 2 Phase B: 確認結果統合     │
│ ・回答の整理                      │
│ ・確定仕様の明確化                │
│ → 02_2_プランナー確認結果.md      │
└───────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────┐
│ Stage 3: API設計書作成            │
│ ・API全体像設計                   │
│ ・DB設計                          │
│ ・詳細仕様設計                    │
│ ・実装ガイド作成                  │
│ → 03_API設計書.md                 │
└───────────────────────────────────┘
        │
        ▼
     完了
```

## 人間確認ポイント

### Stage 2での確認フロー

Stage 2は2つのPhaseに分かれており、その間で人間確認が必要です。

```
Phase A 実行
    │
    ├─→ 02_仕様確認.md 生成
    │
    ├─→ 「5. プランナーへ確認が必要な項目」セクションを抽出
    │
    ▼
⚠️ オーケストレーター停止
    │
    ├─→ ユーザーに確認項目リストを提示
    ├─→ ユーザーがプランナーへ連絡
    ├─→ プランナーからの回答を待機
    ├─→ ユーザーが回答を入力
    │
    ▼
Phase B 実行
    │
    ├─→ 回答を解析
    ├─→ 02_2_プランナー確認結果.md 生成
    │
    ▼
Stage 3 へ進行
```

### 確認項目の形式

確認項目は質問形式で整理されます：

```markdown
### Q1: ステージクリア時の報酬配布タイミング

- **背景**: 仕様書では「クリア時に報酬を付与」とあるが、具体的なタイミングが不明
- **質問内容**: 報酬は「クリア判定直後」と「リザルト画面表示時」のどちらで付与しますか？
- **選択肢**:
  - A案: クリア判定直後（サーバーで即時付与）
  - B案: リザルト画面表示時（クライアントからの明示的リクエスト後）
- **影響範囲**: REQ-A-1, REQ-A-2
```

## 途中再開パターン

### Stage 1 から再開

```bash
/sdd-v2:requirements {機能名}
/sdd-v2:spec-confirm {機能名}
# ⚠️ プランナー確認
/sdd-v2:api-design {機能名}
```

### Stage 2 から再開（要件調査完了後）

前提: `01_要件調査.md` が存在

```bash
/sdd-v2:spec-confirm {機能名}
# ⚠️ プランナー確認
/sdd-v2:api-design {機能名}
```

### Stage 3 から再開（仕様確認完了後）

前提: `01_要件調査.md`, `02_仕様確認.md`, `02_2_プランナー確認結果.md` が存在

```bash
/sdd-v2:api-design {機能名}
```

## エラー時の挙動

### Stage 1 でエラー発生

- エラー内容をログ出力
- ユーザーに報告し、修正後に再実行を促す

### Stage 2 Phase A でエラー発生

- エラー内容をログ出力
- `01_要件調査.md` の内容を確認し、不足があれば Stage 1 を再実行

### Stage 2 Phase B でエラー発生

- エラー内容をログ出力
- プランナー確認結果の入力形式を確認
- 再度 Phase B を実行

### Stage 3 でエラー発生

- エラー内容をログ出力
- 前段階の出力ファイルを確認
- 個別コマンドで Stage 3 を再実行
