# Athenaクエリ対応が必要なケース

## TiDBのTTL設定について

TiDBのログテーブルは、ストレージコスト削減のためTTL（Time To Live）が設定されています。

- **TTL期間**: 31日
- **影響**: 31日以前のログはTiDBから自動削除される
- **対策**: S3に日次でデータレイクにエクスポートし、Athenaでクエリ

## Athena対応が必要なケース

### 1. 新しいログテーブルを管理ツールで表示する場合

```
✅ 対応必要
- log_xxx テーブルを新規作成
- 管理ツールでユーザーのログ履歴を表示したい
```

### 2. 既存のログページに過去データ参照機能を追加する場合

```
✅ 対応必要
- 現在DBのみ参照しているログページがある
- 30日以上前のデータも参照できるようにしたい
```

### 3. ログテーブルのスキーマ変更があった場合

```
✅ 対応必要
- log_xxx テーブルにカラム追加/変更
- Athenaテーブル定義の再生成が必要
```

### 4. usr_* テーブルをAthenaで参照したい場合

```
✅ 対応必要
- DatalakeConstant::WP_DATALAKE_S3_UPLOAD_TARGET_TABLES にあるテーブル
- usr_users など
```

## Athena対応が不要なケース

### 1. マスタテーブル（mst_*）

```
❌ 対応不要
- マスタデータはTTL対象外
- 常にDBから参照可能
```

### 2. 短期間のみ参照するログ

```
❌ 対応不要
- 直近7日程度しか参照しないログ
- リアルタイム性が重要なログ
```

### 3. 管理ツールで表示しないログ

```
❌ 対応不要
- バッチ処理専用のログ
- 管理画面で表示する予定のないログ
```

## 判断フローチャート

```
新しいlog_*テーブルを追加？
    │
    ├─ Yes → 管理ツールで表示する？
    │           │
    │           ├─ Yes → ✅ Athena対応必要
    │           └─ No  → ❌ 対応不要
    │
    └─ No → 既存log_*テーブルの変更？
              │
              ├─ Yes → カラム追加/変更？
              │           │
              │           ├─ Yes → ✅ Athenaテーブル再生成必要
              │           └─ No  → ❌ 対応不要
              │
              └─ No → 既存ページへのAthena機能追加？
                        │
                        ├─ Yes → ✅ Athena対応必要
                        └─ No  → ❌ 対応不要
```

## 自動切り替えの条件

`AthenaQueryTrait`を使用したページでは、以下の条件で自動的にAthenaクエリに切り替わります：

1. **環境**: `develop` または `production`
2. **フィルター**: `created_at_range` で日付範囲が指定されている
3. **日付**: 開始日が現在から **30日以上前**

```php
// AthenaConstant.php
public const ATHENA_FALLBACK_BEFORE_DAYS = 30;
public const ATHENA_ENABLED_ENVIRONMENTS = ['develop', 'production'];
```
