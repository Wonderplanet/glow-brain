# 新規ページ/リソース追加のテスト

新しいFilamentリソースやページを追加した際のテスト手順を説明します。

## 対象となる実装

以下のような実装後にこのテストパターンを使用します：

- 新規Filamentリソースの追加（例: `app/Filament/Resources/ProductResource.php`）
- 新規カスタムページの追加（例: `app/Filament/Pages/Settings.php`）
- 新しいナビゲーションメニュー項目の追加

## テストの目的

新規追加したページが以下を満たすことを確認：

1. ナビゲーションメニューに表示される
2. ページに正常にアクセスできる
3. 初期表示でエラーが発生しない
4. 基本的なUI要素が期待通り表示される

## 事前準備

1. **実装内容の確認**
   - 追加したリソース/ページのクラス名を確認
   - ナビゲーションラベルを確認
   - 期待される表示内容を確認

2. **ログイン**
   - 標準ログイン手順を実行
   - 参照: **[標準ログイン手順](login.md)**

## テスト手順

### ステップ1: ダッシュボードでナビゲーションメニューを確認

ログイン後、スナップショットを取得してナビゲーションメニューを確認します。

```javascript
// スナップショット取得
take_snapshot()
```

**確認項目**:
- 新規追加したページのメニュー項目が表示されている
- メニューラベルが正しい
- アイコンが表示されている（設定した場合）

**スクリーンショット撮影**:
```javascript
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/navigation_menu.png"
})
```

### ステップ2: 新規ページへ遷移

ナビゲーションメニューから対象ページのリンクをクリックします。

```javascript
// 対象ページのリンクをクリック
click({
  uid: "navigation_link_uid"  // スナップショットから取得したuid
})
```

**例**: Productsページへ遷移する場合
```javascript
// "Products"というテキストを含むリンクをクリック
click({
  uid: "products_link_uid"
})
```

### ステップ3: ページ読み込み完了を待機

ページタイトルまたは特徴的な要素が表示されるまで待機します。

```javascript
// ページタイトルが表示されるまで待機
wait_for({
  text: "Products",  // ページタイトル
  timeout: 5000
})
```

### ステップ4: ページの初期表示を確認

スナップショットを取得して、ページが正常に表示されていることを確認します。

```javascript
// ページの現在状態を取得
take_snapshot({ verbose: true })
```

**確認項目**:
- ページタイトルが表示されている
- エラーメッセージが表示されていない
- 基本的なUI要素が表示されている

**期待されるUI要素**:

| ページタイプ | 期待される要素 |
|------------|--------------|
| リソース（一覧ページ） | テーブル、新規作成ボタン、検索/フィルター |
| カスタムページ | ページタイトル、フォームまたはコンテンツ |
| ダッシュボード型ページ | ウィジェット、統計情報 |

### ステップ5: ページ全体のスクリーンショット撮影

ページの初期表示をスクリーンショットで記録します。

```javascript
// フルページスクリーンショット
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/new_page_initial_view.png"
})
```

### ステップ6: コンソールエラーを確認

JavaScriptエラーが発生していないか確認します。

```javascript
// コンソールエラーを取得
list_console_messages({
  types: ["error"],
  pageSize: 50
})
```

**許容されるエラー**:
- 一部のブラウザ拡張機能によるエラー（admin実装とは無関係）

**許容されないエラー**:
- Livewireエラー
- JavaScriptの構文エラー
- 未定義変数エラー
- API呼び出しの失敗（404、500エラー等）

### ステップ7: ネットワークリクエストを確認

APIエラーが発生していないか確認します。

```javascript
// ネットワークリクエストを取得
list_network_requests({
  resourceTypes: ["xhr", "fetch"],
  pageSize: 50
})
```

**確認項目**:
- HTTPステータスコードが200または300番台である
- 400番台、500番台のエラーレスポンスがない

## リソース（一覧ページ）の追加テスト

Filamentリソースを追加した場合の追加確認項目：

### テーブル表示の確認

```javascript
// スナップショット取得
take_snapshot()
```

**確認項目**:
- テーブルが表示されている
- カラムヘッダーが正しい
- データが存在する場合、行が表示されている
- データが存在しない場合、"No records found"等のメッセージが表示される

### アクションボタンの確認

**確認項目**:
- 新規作成ボタンが表示されている
- 各行に編集/削除ボタンが表示されている（設定した場合）
- バルクアクションが表示されている（設定した場合）

### フィルター・検索機能の確認

**確認項目**:
- 検索フィールドが表示されている（設定した場合）
- フィルタードロップダウンが表示されている（設定した場合）

## カスタムページの追加テスト

カスタムページを追加した場合の追加確認項目：

### フォームの確認（フォームページの場合）

```javascript
// スナップショット取得
take_snapshot()
```

**確認項目**:
- フォームフィールドが表示されている
- 送信ボタンが表示されている
- バリデーションルールが設定されている（該当する場合）

### ウィジェットの確認（ダッシュボード型ページの場合）

**確認項目**:
- 各ウィジェットが表示されている
- データが正しく表示されている
- グラフ/チャートが表示されている（該当する場合）

## よくある問題と対処

### 問題1: ナビゲーションメニューに表示されない

**原因**:
- `$navigationLabel`が設定されていない
- `shouldRegisterNavigation()`がfalseを返している
- 権限設定で表示が制限されている

**対処方法**:
```php
// Resourceクラスで確認
protected static ?string $navigationLabel = 'Products';
protected static ?string $navigationIcon = 'heroicon-o-rectangle-stack';

// shouldRegisterNavigationメソッドを確認
public static function shouldRegisterNavigation(): bool
{
    return true;
}
```

### 問題2: ページが表示されない（404エラー）

**原因**:
- ルーティングが正しく登録されていない
- クラス名が正しくない

**対処方法**:
```bash
# Filamentのルートをクリア
./tools/bin/sail-wp admin artisan filament:clear-cache

# キャッシュをクリア
./tools/bin/sail-wp admin artisan cache:clear
```

### 問題3: 500エラーが発生

**原因**:
- クラスの構文エラー
- データベース接続エラー
- 未定義のメソッド呼び出し

**対処方法**:
```bash
# Laravelログを確認
./tools/bin/sail-wp admin artisan tail

# またはログファイルを直接確認
docker compose exec php cat storage/logs/laravel.log
```

### 問題4: テーブルが表示されない

**原因**:
- `table()`メソッドの定義が誤っている
- カラム定義が誤っている
- データベーステーブルが存在しない

**対処方法**:
1. `table()`メソッドの実装を確認
2. データベーステーブルが存在するか確認
3. マイグレーションが実行されているか確認

## テスト結果の記録

テスト完了後、以下の情報を記録します：

```markdown
### テストケース: 新規ページ表示確認

**対象**: [ページ名/リソース名]

**手順**:
1. ダッシュボードからナビゲーションメニューを確認
2. [ページ名]へ遷移
3. ページの初期表示を確認
4. コンソールエラーを確認
5. ネットワークリクエストを確認

**結果**: ✅ 成功 / ❌ 失敗

**確認項目**:
- [✅/❌] ナビゲーションメニューに表示された
- [✅/❌] ページに正常にアクセスできた
- [✅/❌] ページタイトルが表示された
- [✅/❌] 基本的なUI要素が表示された
- [✅/❌] コンソールエラーが発生していない
- [✅/❌] APIエラーが発生していない

**スクリーンショット**:
- `.claude/tmp/navigation_menu.png`
- `.claude/tmp/new_page_initial_view.png`
```

## チェックリスト

- [ ] ログインが完了している
- [ ] ナビゲーションメニューに新規ページが表示されることを確認した
- [ ] 新規ページに遷移できることを確認した
- [ ] ページタイトルが正しく表示されることを確認した
- [ ] 基本的なUI要素が表示されることを確認した
- [ ] コンソールエラーが発生していないことを確認した
- [ ] ネットワークエラーが発生していないことを確認した
- [ ] スクリーンショットを撮影した
- [ ] テスト結果を記録した
