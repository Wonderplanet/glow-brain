# 表示項目変更のテスト

表示項目の追加・変更・削除を行った際のテスト手順を説明します。

## 対象となる実装

以下のような実装後にこのテストパターンを使用します：

- テーブルカラムの追加・削除・並び替え
- フォームフィールドの表示変更
- データフォーマット変更（日時、金額、URL等）
- 条件付き表示の実装
- リレーションデータの表示追加

## テストの目的

表示項目の変更が以下を満たすことを確認：

1. 変更された項目が正しく表示される
2. データフォーマットが適切である
3. レイアウトが崩れていない
4. リレーションデータが正しく表示される
5. 条件付き表示が意図通り機能する

## 事前準備

1. **実装内容の確認**
   - 変更した表示項目を確認
   - 期待される表示フォーマットを確認
   - テストデータの有無を確認

2. **ログインとページ遷移**
   - 標準ログイン手順を実行
   - 対象ページへ遷移
   - 参照: **[標準ログイン手順](login.md)**

## テスト手順

### フェーズ1: テーブル表示の確認

テーブルカラムを追加・変更した場合のテスト手順です。

#### ステップ1.1: 一覧ページへ遷移

```javascript
// 対象リソースの一覧ページへ遷移
click({
  uid: "navigation_link_uid"
})

// ページ読み込み完了を待機
wait_for({
  text: "Products",  // ページタイトル
  timeout: 5000
})
```

#### ステップ1.2: テーブルのスナップショット取得

```javascript
// スナップショット取得
take_snapshot({ verbose: true })
```

#### ステップ1.3: カラムヘッダーの確認

**確認項目**:
- ✅ 追加したカラムが表示されている
- ✅ カラムヘッダーのテキストが正しい
- ✅ カラムの並び順が期待通り
- ✅ 削除したカラムが表示されていない

#### ステップ1.4: データ表示の確認

テーブルの各行のデータを確認します。

**確認項目**:
- ✅ 各カラムにデータが表示されている
- ✅ データが正しいフォーマットで表示されている
- ✅ 空のデータは適切に表示されている（"-"、"N/A"等）

#### ステップ1.5: スクリーンショット撮影

```javascript
// テーブル全体のスクリーンショット
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/table_display.png"
})
```

### フェーズ2: データフォーマットの確認

各データタイプのフォーマットが正しいことを確認します。

#### テストケース2.1: 日時データ

**期待されるフォーマット例**:
- ISO8601形式: `2025-01-30T12:34:56+09:00`
- 日本語形式: `2025年1月30日 12:34`
- 相対時間: `2 hours ago` / `2時間前`

```javascript
// スナップショットで日時カラムの値を確認
take_snapshot()
```

**確認項目**:
- ✅ 日時が期待通りのフォーマットで表示されている
- ✅ タイムゾーンが正しい（日本時間など）
- ✅ nullの場合は適切に表示されている

#### テストケース2.2: 金額データ

**期待されるフォーマット例**:
- `¥1,000`
- `1,000円`
- `$10.00`

```javascript
take_snapshot()
```

**確認項目**:
- ✅ 通貨記号が表示されている
- ✅ 桁区切りカンマが入っている
- ✅ 小数点以下の桁数が正しい

#### テストケース2.3: URLデータ

**期待される表示**:
- リンクとして表示される
- クリック可能である
- 新しいタブで開く（`target="_blank"`）

```javascript
// URLリンクをクリック（検証のため）
click({
  uid: "url_link_uid"
})

// 新しいタブが開くことを確認
// ※ chrome-devtools MCPの制限により、完全な検証は難しい場合がある
```

#### テストケース2.4: 真偽値（Boolean）データ

**期待される表示**:
- アイコン（✓、✗、チェックマーク等）
- テキスト（"Yes"/"No"、"有効"/"無効"等）
- バッジ（色付きラベル）

```javascript
take_snapshot()
```

**確認項目**:
- ✅ trueの場合の表示が正しい
- ✅ falseの場合の表示が正しい
- ✅ 視覚的に区別しやすい

#### テストケース2.5: 列挙型（Enum）データ

**期待される表示**:
- 日本語ラベル
- 色付きバッジ
- アイコン付きラベル

```javascript
take_snapshot()
```

**確認項目**:
- ✅ Enum値が人間が読める形式で表示されている
- ✅ 色分けされている（該当する場合）

### フェーズ3: リレーションデータの確認

外部キーで関連するデータの表示を確認します。

#### ステップ3.1: 一覧ページでのリレーションデータ確認

```javascript
// スナップショット取得
take_snapshot({ verbose: true })
```

**確認項目**:
- ✅ リレーション先のデータが表示されている
- ✅ 外部キーIDではなく、関連データの名前等が表示されている
- ✅ リレーションデータがnullの場合、適切に処理されている

**例**: Productテーブルにcategory_idがある場合
- ❌ 表示: `1`（category_id）
- ✅ 表示: `Electronics`（category.name）

#### ステップ3.2: 詳細ページでのリレーションデータ確認

```javascript
// データの詳細ページへ遷移
click({
  uid: "view_detail_button_uid"
})

// ページ読み込み完了を待機
wait_for({
  text: "Details",  // または "詳細"
  timeout: 5000
})

// スナップショット取得
take_snapshot({ verbose: true })

// スクリーンショット撮影
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/detail_page_relations.png"
})
```

**確認項目**:
- ✅ すべてのリレーションデータが表示されている
- ✅ ネストされたリレーションも正しく表示されている

### フェーズ4: 条件付き表示の確認

特定の条件でのみ表示される項目をテストします。

#### ステップ4.1: 条件を満たすデータで確認

条件を満たすデータの詳細ページまたはフォームを開きます。

```javascript
// 条件を満たすデータを選択
click({
  uid: "data_item_uid"
})

// スナップショット取得
take_snapshot()
```

**確認項目**:
- ✅ 条件を満たす場合、項目が表示されている

#### ステップ4.2: 条件を満たさないデータで確認

条件を満たさないデータの詳細ページまたはフォームを開きます。

```javascript
// 条件を満たさないデータを選択
click({
  uid: "other_data_item_uid"
})

// スナップショット取得
take_snapshot()
```

**確認項目**:
- ✅ 条件を満たさない場合、項目が非表示になっている

### フェーズ5: レイアウト確認

表示項目の変更によってレイアウトが崩れていないことを確認します。

#### ステップ5.1: 全体レイアウトの確認

```javascript
// フルページスクリーンショット
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/layout_full_page.png"
})
```

**確認項目**:
- ✅ テーブルが正しく表示されている
- ✅ カラムが重なっていない
- ✅ テキストが見切れていない
- ✅ スクロールバーが適切に表示されている

#### ステップ5.2: レスポンシブ表示の確認（推奨）

ブラウザウィンドウサイズを変更して、レスポンシブ表示を確認します。

```javascript
// ウィンドウサイズを変更（例: タブレットサイズ）
resize_page({
  width: 768,
  height: 1024
})

// スクリーンショット撮影
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/layout_tablet.png"
})

// ウィンドウサイズを変更（例: モバイルサイズ）
resize_page({
  width: 375,
  height: 667
})

// スクリーンショット撮影
take_screenshot({
  format: "png",
  fullPage: true,
  filePath: ".claude/tmp/layout_mobile.png"
})
```

**確認項目**:
- ✅ タブレット表示で崩れていない
- ✅ モバイル表示で崩れていない
- ✅ スクロールが適切に機能する

### フェーズ6: コンソールエラーとパフォーマンスの確認

#### ステップ6.1: コンソールエラーの確認

```javascript
// コンソールエラーを取得
list_console_messages({
  types: ["error", "warn"],
  pageSize: 50
})
```

**確認項目**:
- ✅ JavaScriptエラーが発生していない
- ✅ 警告が最小限である

#### ステップ6.2: ネットワークリクエストの確認

```javascript
// ネットワークリクエストを取得
list_network_requests({
  resourceTypes: ["xhr", "fetch"],
  pageSize: 50
})
```

**確認項目**:
- ✅ N+1問題が発生していない（リクエスト数が適切）
- ✅ HTTPエラー（400、500番台）が発生していない

## よくある問題と対処

### 問題1: カラムが表示されない

**原因**:
- カラム定義が誤っている
- 権限設定で非表示になっている
- データベースカラムが存在しない

**対処方法**:
```php
// Resourceクラスのtable()メソッドでカラム定義を確認
Tables\Columns\TextColumn::make('name')
    ->label('Name')
    ->sortable()
    ->searchable(),
```

### 問題2: データフォーマットが期待と異なる

**原因**:
- フォーマット指定が誤っている
- ロケール設定が正しくない

**対処方法**:
```php
// 日時フォーマットの例
Tables\Columns\TextColumn::make('created_at')
    ->dateTime('Y-m-d H:i:s')
    ->timezone('Asia/Tokyo'),

// 金額フォーマットの例
Tables\Columns\TextColumn::make('price')
    ->money('JPY'),
```

### 問題3: リレーションデータが表示されない

**原因**:
- リレーション定義が誤っている
- Eager Loadingが設定されていない（N+1問題）

**対処方法**:
```php
// テーブルカラムでリレーション表示
Tables\Columns\TextColumn::make('category.name')
    ->label('Category'),

// Eager Loadingを設定
public static function getEloquentQuery(): Builder
{
    return parent::getEloquentQuery()->with(['category']);
}
```

### 問題4: レイアウトが崩れる

**原因**:
- カラム幅の指定が誤っている
- 長いテキストが折り返されない
- テーブルが横にはみ出している

**対処方法**:
```php
// カラム幅を制限
Tables\Columns\TextColumn::make('description')
    ->limit(50)
    ->tooltip(fn ($record) => $record->description),

// 折り返しを有効化
Tables\Columns\TextColumn::make('long_text')
    ->wrap(),
```

## テスト結果の記録

```markdown
### テストケース: 表示項目変更検証

**対象ページ**: [ページ名]
**変更内容**: [変更した項目の概要]

#### テーブル表示
- **追加カラム**: [カラム名]
- **結果**: ✅ 正しく表示 / ❌ 表示されない
- **スクリーンショット**: `.claude/tmp/table_display.png`

#### データフォーマット
- **日時フォーマット**: [フォーマット形式] - ✅/❌
- **金額フォーマット**: [フォーマット形式] - ✅/❌
- **その他**: [その他のフォーマット] - ✅/❌

#### リレーションデータ
- **表示されるリレーション**: [リレーション名]
- **結果**: ✅ 正しく表示 / ❌ 表示されない
- **スクリーンショット**: `.claude/tmp/detail_page_relations.png`

#### レイアウト
- **デスクトップ**: ✅ 問題なし / ❌ 崩れあり
- **タブレット**: ✅ 問題なし / ❌ 崩れあり
- **モバイル**: ✅ 問題なし / ❌ 崩れあり
- **スクリーンショット**:
  - `.claude/tmp/layout_full_page.png`
  - `.claude/tmp/layout_tablet.png`
  - `.claude/tmp/layout_mobile.png`

**コンソールエラー**: なし / [エラー内容]
**ネットワークエラー**: なし / [エラー内容]

**総合評価**: ✅ 問題なし / ⚠️ 軽微な問題あり / ❌ 重大な問題あり
```

## チェックリスト

- [ ] テーブルカラムが正しく表示される
- [ ] カラムヘッダーが正しい
- [ ] カラムの並び順が期待通り
- [ ] 日時データが適切なフォーマットで表示される
- [ ] 金額データが適切なフォーマットで表示される
- [ ] URLがリンクとして表示される
- [ ] 真偽値が視覚的に区別できる
- [ ] Enum値が人間が読める形式で表示される
- [ ] リレーションデータが正しく表示される
- [ ] 条件付き表示が正しく機能する
- [ ] レイアウトが崩れていない
- [ ] レスポンシブ表示が正しい
- [ ] コンソールエラーが発生していない
- [ ] N+1問題が発生していない
- [ ] すべてのテストでスクリーンショットを撮影した
