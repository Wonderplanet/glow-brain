# 使用例

## 例1: 新機能の完全設計（スタミナブースト）

### コマンド

```bash
/sdd:run-full-flow スタミナブースト
```

### 実行内容

#### 要件定義フェーズ（Stage 1-3）

**Stage 1: サーバー要件抽出（3～5分）**
- ゲーム体験仕様書からスタミナブースト機能のサーバー要件を抽出
- 出力: `docs/sdd/features/スタミナブースト/サーバー要件抽出.md`

**抽出される要件例：**
- スタミナブースト購入APIの実装
- ブースト効果の適用処理
- ブースト効果の有効期限管理
- 複数ブーストアイテムの併用可否
- ブースト効果中のスタミナ消費量調整

**Stage 2: コード調査追記（3～5分）**
- 既存のスタミナ関連実装を調査
- 出力: `docs/sdd/features/スタミナブースト/サーバー要件_コード調査追記.md`

**調査される実装例：**
- `usr_user_stamina` テーブル構造
- `StaminaDelegator` の既存実装
- `StaminaRecoveryService` の処理フロー
- 既存のアイテム使用処理パターン
- スタミナ消費処理の実装箇所

**Stage 3: サーバー仕様レビュー（3～5分）**
- サーバー仕様を詳細化し、曖昧さ・不明点を評価
- プランナー確認項目リストを作成
- 出力: `docs/sdd/features/スタミナブースト/サーバー仕様レビュー.md`

**プランナー確認項目例：**
1. ブースト効果は何倍まで対応するか？（2倍、3倍、10倍など）
2. ブースト効果中にスタミナが0になった場合の挙動は？
3. ブースト効果の有効期限切れのタイミングは？（次回ログイン時、リアルタイム）
4. 複数のブーストアイテムを同時に使用できるか？
5. ブースト効果中にアイテムを再度使用した場合は？（延長、上書き、エラー）

#### 人間確認（Stage 4）

**【一時停止】プランナーへの確認を依頼**

オーケストレーターから以下のような質問がされます：

```
Stage 3が完了しました。プランナー確認項目リストを確認してください：
docs/sdd/features/スタミナブースト/サーバー仕様レビュー.md

プランナーに確認を実施し、結果を提供してください。
確認が完了したら、確認結果を入力してください。
```

**ユーザーの対応：**
1. `サーバー仕様レビュー.md` を確認
2. プランナー確認項目リストをプランナーに送付（メール、チャット、会議など）
3. プランナーから回答を受け取る
4. 確認結果をまとめる

**プランナー確認結果の例：**
```
1. ブースト効果は2倍固定
2. スタミナが0になった場合、ブースト効果は継続（次回スタミナ消費時に適用）
3. 有効期限切れはリアルタイムで判定（クエスト開始時にチェック）
4. 複数ブーストアイテムの同時使用は不可（エラーを返す）
5. ブースト効果中の再使用は、有効期限を延長
```

**Stage 4: ゲーム体験仕様確認結果まとめ（2～3分）**
- プランナー確認結果を整理
- 出力: `docs/sdd/features/スタミナブースト/ゲーム体験仕様確認結果まとめ.md`

**Stage 5: サーバーAPI要件書まとめ（3～5分）**
- 全ての情報を統合し、完全で一貫性のある要件書を作成
- 出力: `docs/sdd/features/スタミナブースト/サーバーAPI要件書.md`

#### 設計フェーズ（Stage 6-8、並列実行）

**Stage 6: API実装全体概要設計（並列実行、約10分）**
- どのAPIエンドポイントが関わるか全体像を把握
- 出力: `docs/sdd/features/スタミナブースト/API実装全体概要設計.md`

**関連するAPIエンドポイント例：**
- `/api/item/use` (既存改修) - スタミナブーストアイテム使用
- `/api/quest/start` (既存改修) - ブースト効果適用確認
- `/api/user/status` (既存改修) - ブースト効果状態取得

**Stage 7: サーバーAPI設計書作成（並列実行、約10分）**
- 各APIの詳細仕様を設計
- 出力: `docs/sdd/features/スタミナブースト/サーバーAPI設計書.md`

**API設計例：**
```
POST /api/item/use

リクエスト:
{
  "item_id": 10001,  // スタミナブーストアイテムID
  "count": 1
}

レスポンス（成功）:
{
  "result": {
    "stamina_boost": {
      "boost_rate": 2.0,
      "expires_at": "2025-11-27T10:00:00Z"
    }
  }
}

エラー:
- ALREADY_BOOSTED: ブースト効果中に再使用不可
- ITEM_NOT_FOUND: アイテムが存在しない
```

**Stage 8: サーバーAPI機能要件実装設計（並列実行、約10分）**
- 実装の詳細設計
- 出力: `docs/sdd/features/スタミナブースト/サーバーAPI機能要件実装設計.md`

**DB設計例：**
```sql
-- usr_user_stamina_boost テーブル追加
CREATE TABLE usr_user_stamina_boost (
    usr_user_id BIGINT NOT NULL,
    boost_rate DECIMAL(5,2) NOT NULL,  -- ブースト倍率（2.00 = 2倍）
    started_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (usr_user_id),
    INDEX idx_expires_at (expires_at)
);
```

**ドメインレイヤー設計例：**
- `StaminaBoostEntity`: ブースト効果Entity
- `StaminaBoostRepository`: ブースト効果Repository
- `StaminaBoostService`: ブースト効果管理Service
- `UseStaminaBoostItemUseCase`: ブーストアイテム使用UseCase

### 所要時間

**合計: 約25～30分**（Stage 4の人間確認時間を除く）

- 要件定義フェーズ: 約12～18分
- 人間確認: （ユーザー依存）
- 設計フェーズ: 約10～12分（並列実行）

---

## 例2: 途中段階からの再実行

### シナリオ

Stage 3のサーバー仕様レビューで不備が見つかり、Stage 2から再実行したい場合

### コマンド

```bash
# Stage 2から再実行
/sdd:investigate-code-requirements スタミナブースト

# Stage 3を再実行
/sdd:review-server-spec スタミナブースト

# Stage 4以降を続行
/sdd:confirm-game-experience-spec スタミナブースト
/sdd:finalize-server-requirements スタミナブースト

# 設計フェーズを再実行（並列）
# 以下の3つを単一メッセージで実行
/sdd:overview-api-design スタミナブースト
/sdd:create-api-design スタミナブースト
/sdd:design-api-implementation スタミナブースト
```

---

## 例3: Stage 4での人間確認の実施

### 実施手順

#### 1. Stage 3完了後、プランナー確認項目リストが生成される

```bash
# ファイル確認
cat docs/sdd/features/スタミナブースト/サーバー仕様レビュー.md
```

#### 2. プランナー確認項目リストを使って確認を実施

**確認方法の例：**

**メールでの確認：**
```
件名: 【確認依頼】スタミナブースト機能のサーバー仕様について

本文:
スタミナブースト機能のサーバー仕様について、以下の点を確認させてください：

1. ブースト効果は何倍まで対応するか？（2倍、3倍、10倍など）
2. ブースト効果中にスタミナが0になった場合の挙動は？
...
```

**チャットでの確認：**
```
@企画担当 スタミナブースト機能について確認したいことがあります。
以下のドキュメントに記載されている確認項目について、回答をお願いできますか？
[サーバー仕様レビュー.md へのリンク]
```

**会議での確認：**
- サーバー仕様レビュー.mdを画面共有
- 確認項目を1つずつ確認
- 議事録に回答を記録

#### 3. 確認結果を準備

**確認結果の例（テキストファイル）：**
```
# スタミナブースト機能 プランナー確認結果

日時: 2025-11-26
確認者: 企画担当 田中様

## 確認結果

### Q1. ブースト効果は何倍まで対応するか？
A1. 2倍固定で実装してください。将来的に3倍以上も追加する可能性がありますが、
    まずは2倍のみで実装をお願いします。

### Q2. ブースト効果中にスタミナが0になった場合の挙動は？
A2. ブースト効果は継続します。次回スタミナが回復してクエストを開始する際に、
    ブースト効果が適用されます。

### Q3. ブースト効果の有効期限切れのタイミングは？
A3. リアルタイムで判定してください。クエスト開始時に有効期限をチェックし、
    期限切れの場合はブースト効果を適用しないでください。

### Q4. 複数のブーストアイテムを同時に使用できるか？
A4. 同時使用は不可とし、エラーを返してください。
    エラーメッセージは「既にブースト効果が適用されています」としてください。

### Q5. ブースト効果中にアイテムを再度使用した場合は？
A5. 有効期限を延長する仕様としてください。
    現在の有効期限 + アイテムの効果時間 = 新しい有効期限

## 追加で明らかになった仕様

- ブースト効果の最大有効期限は7日間とする
- 7日間を超える場合は、7日間でキャップする
```

#### 4. Stage 4を実行し、確認結果を提供

```bash
/sdd:confirm-game-experience-spec スタミナブースト
```

オーケストレーターが確認結果を求めるので、準備した内容を提供します。

---

## 例4: 設計フェーズのみ再実行

### シナリオ

要件定義フェーズ（Stage 1-5）は完了しているが、設計フェーズで不整合が発生したため再実行したい場合

### コマンド

#### パターンA: 並列実行

```bash
# 以下の3つを単一メッセージで実行
/sdd:overview-api-design スタミナブースト
/sdd:create-api-design スタミナブースト
/sdd:design-api-implementation スタミナブースト
```

#### パターンB: 順次実行（デバッグ時）

```bash
# Stage 6を先に実行（全体像把握）
/sdd:overview-api-design スタミナブースト

# Stage 6の結果を確認してから、Stage 7, 8を実行
/sdd:create-api-design スタミナブースト
/sdd:design-api-implementation スタミナブースト
```

---

## 例5: 複雑な機能の設計（ガチャ機能改修）

### シナリオ

既存のガチャ機能に新しい排出確率アップ機能を追加する場合

### 特徴

- 既存APIの改修が必要
- 複数のAPIエンドポイントが関連
- glow-schemaとの整合性確認が重要

### コマンド

```bash
/sdd:run-full-flow ガチャ排出確率アップ
```

### 実行時のポイント

**Stage 2: コード調査追記**
- 既存のガチャ実装を徹底調査
- 確率計算ロジックの把握
- 既存のガチャ関連テーブル確認

**Stage 6: API実装全体概要設計**
- 影響を受けるAPIエンドポイントをリストアップ
  - `/api/gacha/draw` (改修)
  - `/api/gacha/info` (改修)
  - `/api/gacha/history` (新規または改修)

**Stage 7: サーバーAPI設計書作成**
- glow-schemaとの整合性を入念に確認
- 既存のリクエスト/レスポンス形式を踏襲

**Stage 8: サーバーAPI機能要件実装設計**
- 既存のドメインモデルとの整合性確認
- 既存のテーブル構造を活用
- マイグレーションでカラム追加

---

## 例6: ハイブリッド実行パターン

### シナリオ

複雑な機能で、Stage 6で全体像を把握してからStage 7, 8を実行したい場合

### コマンド

```bash
# 要件定義フェーズを実行
/sdd:run-full-flow スタミナブースト
# ↑ これでStage 1-5が完了

# Stage 6のみを先に実行
/sdd:overview-api-design スタミナブースト

# Stage 6の結果を確認
cat docs/sdd/features/スタミナブースト/API実装全体概要設計.md

# Stage 7, 8を並列実行
# 以下の2つを単一メッセージで実行
/sdd:create-api-design スタミナブースト
/sdd:design-api-implementation スタミナブースト
```

### メリット

- Stage 6で全体像を把握してから詳細設計に進める
- 複雑な機能の場合、全体像の理解が重要
- Stage 7, 8の並列実行により時間短縮

---

## 実行結果の確認

### 出力ファイル一覧

```bash
# 全ての出力ファイルを確認
ls -la docs/sdd/features/スタミナブースト/
```

### 出力例

```
docs/sdd/features/スタミナブースト/
├── サーバー要件抽出.md
├── サーバー要件_コード調査追記.md
├── サーバー仕様レビュー.md
├── ゲーム体験仕様確認結果まとめ.md
├── サーバーAPI要件書.md
├── API実装全体概要設計.md
├── サーバーAPI設計書.md
└── サーバーAPI機能要件実装設計.md
```

### 各ファイルの用途

| ファイル | 用途 |
|---------|------|
| `サーバー要件抽出.md` | 初期要件の確認 |
| `サーバー要件_コード調査追記.md` | 既存実装パターンの確認 |
| `サーバー仕様レビュー.md` | プランナー確認項目の確認 |
| `ゲーム体験仕様確認結果まとめ.md` | プランナー確認結果の参照 |
| `サーバーAPI要件書.md` | **最も重要** - 実装の基準 |
| `API実装全体概要設計.md` | 全体像の把握 |
| `サーバーAPI設計書.md` | API仕様の詳細 |
| `サーバーAPI機能要件実装設計.md` | 実装の詳細設計 |

---

## 次のステップ

設計完了後の実装フローについては、各実装スキルを参照してください：

- `migration`: DB設計の実装
- `domain-layer`: ドメインレイヤーの実装
- `api-endpoint-implementation`: APIエンドポイントの実装
- `api-test-implementation`: テストの実装
