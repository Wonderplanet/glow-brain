# Stage詳細仕様

各Stageの責務、入出力、実装の詳細について説明します。

## 要件定義フェーズ（Stage 1-5）

### Stage 1: サーバー要件抽出

**対応コマンド:** `/sdd:extract-server-requirements`

**サブエージェント:** `sdd-extract-server-requirements`

**責務：**
- ゲーム体験仕様書PDFからサーバー関与が必要な項目を抽出
- サーバー側で実装すべき要件を特定

**入力：**
- 機能名
- ゲーム体験仕様書PDF（該当箇所）

**出力：**
- `docs/sdd/features/{機能名}/サーバー要件抽出.md`

**抽出する要件の例：**
- データ永続化が必要な項目
- プレイヤー間のデータ共有
- サーバー時刻に基づく処理
- 不正防止が必要な計算
- ガチャ抽選などのランダム要素

---

### Stage 2: コード調査追記

**対応コマンド:** `/sdd:investigate-code-requirements`

**サブエージェント:** `sdd-investigate-code-requirements`

**責務：**
- 仕様書に書かれていない暗黙の前提・制約を洗い出し
- 既存実装パターンとの整合性確認
- 類似機能の実装方法を調査

**入力：**
- Stage 1の出力ファイル（`サーバー要件抽出.md`）
- 既存コードベース

**出力：**
- `docs/sdd/features/{機能名}/サーバー要件_コード調査追記.md`

**調査内容：**
- 類似機能のテーブル構造
- 既存のドメインモデル・Repository
- 既存のバリデーションルール
- エラーハンドリングパターン
- レスポンスフォーマット

---

### Stage 3: サーバー仕様レビュー

**対応コマンド:** `/sdd:review-server-spec`

**サブエージェント:** `sdd-review-server-spec`

**責務：**
- 統合された仕様を詳細化し、曖昧さ・不明点を評価
- プランナー確認項目リストを作成
- サーバー実装観点での仕様精査

**入力：**
- Stage 1の出力ファイル（`サーバー要件抽出.md`）
- Stage 2の出力ファイル（`サーバー要件_コード調査追記.md`）

**出力：**
- `docs/sdd/features/{機能名}/サーバー仕様レビュー.md`
  - 詳細化された仕様
  - 曖昧な点のリスト
  - **プランナー確認項目リスト**

**レビュー観点：**
- データ整合性の確保方法
- エッジケースの処理
- エラー時の挙動
- リセットタイミング
- 期間限定機能の開始/終了処理

---

### Stage 4: ゲーム体験仕様確認結果まとめ

**対応コマンド:** `/sdd:confirm-game-experience-spec`

**サブエージェント:** `sdd-confirm-game-experience-spec`

⚠️ **重要: このStageでは人間の確認が必要です**

**責務：**
- 人間が実施したプランナー確認結果を整理
- 不明点の解決状況を評価
- 確認結果を要件書に統合可能な形式に整理

**入力：**
- Stage 3の出力ファイル（`サーバー仕様レビュー.md`）
- **人間が実施したプランナー確認結果**（メール、会議メモ、チャットログなど）

**出力：**
- `docs/sdd/features/{機能名}/ゲーム体験仕様確認結果まとめ.md`

**実行フロー:**
1. Stage 3完了後、ユーザーにプランナー確認を依頼
2. ユーザーから確認結果を受け取り
3. Stage 4を実行して確認結果を整理

**確認結果の形式：**
- 質問項目ごとの回答
- 追加で明らかになった仕様
- 変更された仕様
- 未解決の項目（あれば）

---

### Stage 5: サーバーAPI要件書まとめ

**対応コマンド:** `/sdd:finalize-server-requirements`

**サブエージェント:** `sdd-finalize-server-requirements`

**責務：**
- Stage 1～4の全ての情報を統合
- 完全で一貫性のある要件書を作成
- 要件定義フェーズの完了

**入力：**
- Stage 1～4の全出力ファイル

**出力：**
- `docs/sdd/features/{機能名}/サーバーAPI要件書.md`

**要件書の構成：**
1. 機能概要
2. サーバー要件一覧
3. データ要件（DB設計の前提）
4. API要件（必要なエンドポイント）
5. ビジネスロジック要件
6. バリデーション要件
7. エラーハンドリング要件
8. 前提条件・制約事項

---

## 設計フェーズ（Stage 6-8）

### Stage 6: API実装全体概要設計

**対応コマンド:** `/sdd:overview-api-design`

**サブエージェント:** `sdd-overview-api-design`

**責務：**
- どのAPIエンドポイントが関わるか全体像を把握
- 新規実装 vs 既存改修の判別
- API間の依存関係の整理

**入力：**
- Stage 5の出力ファイル（`サーバーAPI要件書.md`）
- glow-schema リポジトリ

**出力：**
- `docs/sdd/features/{機能名}/API実装全体概要設計.md`

**設計内容：**
- 関連するAPIエンドポイント一覧
- 各APIの概要（新規/改修の別）
- API間のデータフロー
- glow-schemaとの対応関係
- 実装の優先順位

---

### Stage 7: サーバーAPI設計書作成

**対応コマンド:** `/sdd:create-api-design`

**サブエージェント:** `sdd-create-api-design`

**責務：**
- 各APIの詳細仕様を設計
- リクエスト・レスポンス・エラーハンドリング
- glow-schemaとの整合性確認

**入力：**
- Stage 5の出力ファイル（`サーバーAPI要件書.md`）

**出力：**
- `docs/sdd/features/{機能名}/サーバーAPI設計書.md`

**各APIの設計項目：**
1. エンドポイント（パス、HTTPメソッド）
2. リクエストパラメータ
   - 必須/任意
   - データ型
   - バリデーションルール
3. レスポンス
   - 成功時のレスポンス
   - データ構造
   - 日時フォーマット（ISO8601）
4. エラーレスポンス
   - エラーコード
   - エラーメッセージ
5. 前提条件・制約

---

### Stage 8: サーバーAPI機能要件実装設計

**対応コマンド:** `/sdd:design-api-implementation`

**サブエージェント:** `sdd-design-api-implementation`

**責務：**
- 実装の詳細設計
- DB設計・ドメイン設計・クリーンアーキテクチャ
- テーブル構造、Entity、Repository、UseCase、Service の設計

**入力：**
- Stage 5の出力ファイル（`サーバーAPI要件書.md`）

**出力：**
- `docs/sdd/features/{機能名}/サーバーAPI機能要件実装設計.md`

**設計内容：**

#### 1. DB設計
- テーブル構造（カラム名、データ型、制約）
- インデックス
- リレーション
- マイグレーション方針

#### 2. ドメインレイヤー設計
- Entity定義
- Model定義
- Repository Interface
- ValueObject（必要に応じて）

#### 3. ユースケース設計
- UseCase一覧
- 各UseCaseの処理フロー
- トランザクション境界

#### 4. サービス設計
- Service一覧
- 各Serviceの責務
- 依存関係

#### 5. Delegator設計
- Delegator一覧
- 各Delegatorの責務
- 返り値の型

#### 6. Controller設計
- リクエストバリデーション
- UseCaseの呼び出し
- レスポンス生成

#### 7. テスト設計
- Unit Test
- Feature Test
- Scenario Test

---

## Stage間の依存関係

```
Stage 1 (要件抽出)
    ↓
Stage 2 (コード調査) ← Stage 1の出力に依存
    ↓
Stage 3 (レビュー) ← Stage 1, 2の出力に依存
    ↓
[人間確認]
    ↓
Stage 4 (確認結果) ← Stage 3の出力 + 人間確認結果
    ↓
Stage 5 (要件書) ← Stage 1～4の全出力に依存
    ↓
    ├→ Stage 6 (全体概要) ← Stage 5のみに依存（並列実行可能）
    ├→ Stage 7 (API設計) ← Stage 5のみに依存（並列実行可能）
    └→ Stage 8 (実装設計) ← Stage 5のみに依存（並列実行可能）
```

**ポイント：**
- Stage 1-5は順次実行必須
- Stage 6-8は並列実行可能（全てStage 5のみに依存）
